<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rts_pstor › rtsx_scsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rtsx_scsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek PCI-Express card reader</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;rtsx.h&quot;</span>
<span class="cp">#include &quot;rtsx_transport.h&quot;</span>
<span class="cp">#include &quot;rtsx_sys.h&quot;</span>
<span class="cp">#include &quot;rtsx_card.h&quot;</span>
<span class="cp">#include &quot;rtsx_chip.h&quot;</span>
<span class="cp">#include &quot;rtsx_scsi.h&quot;</span>
<span class="cp">#include &quot;sd.h&quot;</span>
<span class="cp">#include &quot;ms.h&quot;</span>
<span class="cp">#include &quot;spi.h&quot;</span>

<span class="kt">void</span> <span class="nf">scsi_show_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">what</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">unknown_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;TEST_UNIT_READY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REZERO_UNIT</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;REZERO_UNIT&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;REQUEST_SENSE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FORMAT_UNIT</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;FORMAT_UNIT&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_BLOCK_LIMITS</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_BLOCK_LIMITS&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REASSIGN_BLOCKS</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;REASSIGN_BLOCKS&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_6</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_6&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_6</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_6&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_6</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEEK_6&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_REVERSE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_REVERSE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_FILEMARKS</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_FILEMARKS&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPACE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SPACE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;INQUIRY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RECOVER_BUFFERED_DATA</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;RECOVER_BUFFERED_DATA&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SELECT</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;MODE_SELECT&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESERVE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;RESERVE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RELEASE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;RELEASE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COPY</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;COPY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ERASE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;ERASE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SENSE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;MODE_SENSE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">START_STOP</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;START_STOP&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RECEIVE_DIAGNOSTIC</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;RECEIVE_DIAGNOSTIC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEND_DIAGNOSTIC</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEND_DIAGNOSTIC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;ALLOW_MEDIUM_REMOVAL&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_WINDOW</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SET_WINDOW&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_CAPACITY</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_CAPACITY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_10</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_10&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_10</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_10&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_10</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEEK_10&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_VERIFY</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_VERIFY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VERIFY</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;VERIFY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_HIGH</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEARCH_HIGH&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_EQUAL</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEARCH_EQUAL&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_LOW</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEARCH_LOW&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_LIMITS</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SET_LIMITS&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_POSITION</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_POSITION&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SYNCHRONIZE_CACHE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOCK_UNLOCK_CACHE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;LOCK_UNLOCK_CACHE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_DEFECT_DATA</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_DEFECT_DATA&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIUM_SCAN</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;MEDIUM_SCAN&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMPARE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;COMPARE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COPY_VERIFY</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;COPY_VERIFY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_BUFFER</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_BUFFER&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_BUFFER</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_BUFFER&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UPDATE_BLOCK</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;UPDATE_BLOCK&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_LONG</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_LONG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_LONG</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_LONG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANGE_DEFINITION</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;CHANGE_DEFINITION&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_SAME</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_SAME&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_SUBCHANNEL</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ SUBCHANNEL&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_TOC</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_TOC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_HEADER</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ HEADER&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_PLAY_AUDIO_10</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;PLAY AUDIO (10)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_PLAY_AUDIO_MSF</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;PLAY AUDIO MSF&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_GET_EVENT_STATUS_NOTIFICATION</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;GET EVENT/STATUS NOTIFICATION&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_PAUSE_RESUME</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;PAUSE/RESUME&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOG_SELECT</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;LOG_SELECT&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOG_SENSE</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;LOG_SENSE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_STOP_PLAY_SCAN</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;STOP PLAY/SCAN&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_DISC_INFO</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ DISC INFORMATION&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_TRACK_RZONE_INFO</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ TRACK INFORMATION&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_RESERVE_RZONE_TRACK</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;RESERVE TRACK&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_SEND_OPC</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEND OPC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SELECT_10</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;MODE_SELECT_10&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_REPAIR_RZONE_TRACK</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;REPAIR TRACK&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x59</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ MASTER CUE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;MODE_SENSE_10&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_CLOSE_TRACK</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;CLOSE TRACK/SESSION&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5C</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ BUFFER CAPACITY&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5D</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEND CUE SHEET&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_BLANK</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;BLANK&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_LUNS</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;REPORT LUNS&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOVE_MEDIUM</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;MOVE_MEDIUM or PLAY AUDIO (12)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_12</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_12&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_12</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_12&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_VERIFY_12</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_VERIFY_12&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_HIGH_12</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEARCH_HIGH_12&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_EQUAL_12</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEARCH_EQUAL_12&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_LOW_12</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEARCH_LOW_12&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEND_VOLUME_TAG</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SEND_VOLUME_TAG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_ELEMENT_STATUS</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ_ELEMENT_STATUS&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_CD_MSF</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ CD MSF&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_SCAN</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SCAN&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_SET_SPEED</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;SET CD SPEED&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_MECHANISM_STATUS</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;MECHANISM STATUS&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_CD</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;READ CD&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xE1</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE CONTINUE&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_LONG_2</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;WRITE_LONG_2&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VENDOR_CMND</span>: <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;Realtek&#39;s vendor command&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">what</span> <span class="o">=</span> <span class="s">&quot;(unknown command)&quot;</span><span class="p">;</span> <span class="n">unknown_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Command %s (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unknown_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RTSX_DEBUGPN</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">RTSX_DEBUGPN</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_sense_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sense_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_LBA_OVER_RANGE</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="n">ILGAL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">ASC_INVLD_CDB</span><span class="p">,</span> <span class="n">ASCQ_INVLD_CDB</span><span class="p">,</span> <span class="n">CDB_ILLEGAL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_FORMAT_IN_PROGRESS</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_FORMAT_CMD_FAILED</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_READ_FORBIDDEN</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_NO_SENSE</span>:
	<span class="nl">default:</span>
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_sense_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sense_key</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">asc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ascq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sns_key_info0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sns_key_info1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sense_data_t</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="n">lun</span><span class="p">]);</span>

	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">=</span> <span class="n">sense_key</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>

	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">ad_sense_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sense_data_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">=</span> <span class="n">asc</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">=</span> <span class="n">ascq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sns_key_info0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sns_key_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SKSV</span> <span class="o">|</span> <span class="n">sns_key_info0</span><span class="p">;</span>
		<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sns_key_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sns_key_info1</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sns_key_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sns_key_info1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_unit_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHK_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">))</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_notify</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_notify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_READ_FORBIDDEN</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">formatter_inquiry_str</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="sc">&#39;O&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;K&#39;</span><span class="p">,</span>
<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="cm">/* Byte[47:49] */</span>
<span class="cp">#else</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>  <span class="cm">/* Byte[47:49] */</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="mh">0x0B</span><span class="p">,</span>  <span class="cm">/* Byte[50]: MG, MS, MSPro, MSXC */</span>
<span class="cp">#else</span>
	<span class="mh">0x09</span><span class="p">,</span>  <span class="cm">/* Byte[50]: MS, MSPro, MSXC */</span>
<span class="cp">#endif</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* Byte[51]: Category Specific Commands */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* Byte[52]: Access Control and feature */</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="cm">/* Byte[53:55] */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">inquiry_default</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;Generic-xD/SD/M.S.      1.00 &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">inquiry_sdms</span> <span class="o">=</span>    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;Generic-SD/MemoryStick  1.00 &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">inquiry_sd</span> <span class="o">=</span>      <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;Generic-SD/MMC          1.00 &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">inquiry_ms</span> <span class="o">=</span>      <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;Generic-MemoryStick     1.00 &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">inquiry_string</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sendbytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">inquiry_buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">QULIFIRE</span><span class="o">|</span><span class="n">DRCT_ACCESS_DEV</span><span class="p">,</span>
		<span class="n">RMB_DISC</span><span class="o">|</span><span class="mh">0x0D</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x1f</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">REL_ADR</span><span class="o">|</span><span class="n">WBUS_32</span><span class="o">|</span><span class="n">WBUS_16</span><span class="o">|</span><span class="n">SYNC</span><span class="o">|</span><span class="n">LINKED</span><span class="o">|</span><span class="n">CMD_QUE</span><span class="o">|</span><span class="n">SFT_RE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inquiry_string</span> <span class="o">=</span> <span class="n">inquiry_sd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">inquiry_string</span> <span class="o">=</span> <span class="n">inquiry_ms</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_1LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inquiry_string</span> <span class="o">=</span> <span class="n">inquiry_sdms</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">inquiry_string</span> <span class="o">=</span> <span class="n">inquiry_default</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mspro_formatter_enable</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mspro_formatter_enable</span><span class="p">)</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pro_formatter_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="mi">56</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sendbytes</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">inquiry_buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">inquiry_string</span><span class="p">,</span>	<span class="n">sendbytes</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pro_formatter_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Additional Length */</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">inquiry_buf</span><span class="p">,</span> <span class="n">sendbytes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pro_formatter_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sendbytes</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">36</span><span class="p">,</span> <span class="n">formatter_inquiry_str</span><span class="p">,</span> <span class="n">sendbytes</span> <span class="o">-</span> <span class="mi">36</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_stop_unit</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mh">0x4</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STOP_MEDIUM</span>:
		<span class="cm">/* Media disabled */</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UNLOAD_MEDIUM</span>:
		<span class="cm">/* Media shall be unload */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span>
			<span class="n">eject_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MAKE_MEDIUM_READY</span>:
	<span class="k">case</span> <span class="n">LOAD_MEDIUM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">allow_medium_removal</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prevent</span><span class="p">;</span>

	<span class="n">prevent</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prevent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sense_data_t</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="n">lun</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">==</span> <span class="n">FORMAT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">==</span> <span class="n">FORMAT_IN_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Logical Unit Not Ready Format in Progress */</span>
			<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Format Command Failed */</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_FORMAT_CMD_FAILED</span><span class="p">);</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>

	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Reset Sense Data */</span>
	<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ms_mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sys_info_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_size</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">support_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MODE_SENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sys_info_offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="mh">0x68</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data_size</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x67</span><span class="p">;</span>  <span class="cm">/* Mode Data Length */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sys_info_offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="mh">0x6C</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data_size</span> <span class="o">=</span> <span class="mh">0x6C</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* Mode Data Length (MSB) */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6A</span><span class="p">;</span>  <span class="cm">/* Mode Data Length (LSB) */</span>
	<span class="p">}</span>

	<span class="cm">/* Medium Type Code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">support_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">support_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* WP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* MediaType */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* WP */</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="cm">/* Reserved */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MODE_SENSE_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* Reserved */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* Block descriptor length(MSB) */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* Block descriptor length(LSB) */</span>

		<span class="cm">/* The Following Data is the content of &quot;Page 0x20&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>		<span class="cm">/* Page Code */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x62</span><span class="p">;</span>		<span class="cm">/* Page Length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="cm">/* No Access Control */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">support_format</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>	<span class="cm">/* SF, SGM */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The Following Data is the content of &quot;Page 0x20&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>		<span class="cm">/* Page Code */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x62</span><span class="p">;</span>		<span class="cm">/* Page Length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="cm">/* No Access Control */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">support_format</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>	<span class="cm">/* SF, SGM */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="n">sys_info_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 96 Bytes Attribute Data */</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">-</span> <span class="n">sys_info_offset</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">96</span><span class="p">)</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="mi">96</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">sys_info_offset</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataSize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pro_formatter_flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pageCode</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

<span class="cp">#ifndef SUPPORT_MAGIC_GATE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mspro_formatter_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mspro_formatter_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pageCode</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">pro_formatter_flag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODE_SENSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_mode_sense</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">lun</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_mode_sense</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">lun</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">dataSize</span><span class="p">);</span>
		<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_sec</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sec_cnt</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">get_card_size</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHK_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Accessing to any card is forbidden</span>
<span class="cm">		 * until the erase procedure of SD is completed</span>
<span class="cm">		 */</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD card being erased!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_READ_FORBIDDEN</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD card locked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_READ_FORBIDDEN</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_sec</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_sec</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">VENDOR_CMND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SCSI_APP_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">PP_READ10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">PP_WRITE10</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">start_sec</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* In some test, we will receive a start_sec like 0xFFFFFFFF.</span>
<span class="cm">	 * In this situation, start_sec + sec_cnt will overflow, so we</span>
<span class="cm">	 * need to judge start_sec at first</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">start_sec</span> <span class="o">&gt;</span> <span class="n">get_card_size</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">start_sec</span> <span class="o">+</span> <span class="n">sec_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">get_card_size</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LBA_OVER_RANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_fail_cnt</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;read/write fail three times in succession</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Write protected card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_payload</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">card_rw</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">start_sec</span><span class="p">,</span> <span class="n">sec_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_release</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_fail_cnt</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_fail_cnt</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Exit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_fail_cnt</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">Exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_payload</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_format_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">card_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desc_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mspro_formatter_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x14</span> <span class="o">:</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Capacity List Length */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mspro_formatter_enable</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">card</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">desc_cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">desc_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">desc_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">card_size</span> <span class="o">=</span> <span class="n">get_card_size</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">card_size</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">card_size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">card_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">card_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="n">desc_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">card_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHK_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">card_size</span> <span class="o">=</span> <span class="n">get_card_size</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">card_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">card_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">card_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">card_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_read_eeprom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">511</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_erase_eeprom_chip</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_write_eeprom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFC00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xFC00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_sd_csd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">toggle_gpio_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">gpio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">toggle_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef _MSG_TRACE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">trace_msg_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">clear</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">((</span><span class="mi">2</span> <span class="o">+</span> <span class="n">MSG_FUNC_LEN</span> <span class="o">+</span> <span class="n">MSG_FILE_LEN</span> <span class="o">+</span> <span class="n">TIME_VAL_LEN</span><span class="p">)</span> <span class="o">*</span> <span class="n">TRACE_ITEM_CNT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">trace_msg</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_idx</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg_cnt</span> <span class="o">=</span> <span class="n">TRACE_ITEM_CNT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msg_cnt</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_idx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">msg_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">msg_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">msg_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">msg_cnt</span><span class="p">;</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Trace message count is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_cnt</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">msg_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="n">TRACE_ITEM_CNT</span><span class="p">;</span>

		<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">trace_msg</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">line</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">trace_msg</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">line</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MSG_FUNC_LEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">trace_msg</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">func</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MSG_FILE_LEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">trace_msg</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">file</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">TIME_VAL_LEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">trace_msg</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">timeval_buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TRACE_ITEM_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">trace_msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_host_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Host register (0x%x): 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_host_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_variable</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Variable Clock */</span>
		<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">XD_CARD</span>:
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">xd_clock</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SD_CARD</span>:
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MS_CARD</span>:
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">blink_led</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">blink_led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">turn_off_led</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LED_GPIO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_variable</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">XD_CARD</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">xd_clock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SD_CARD</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MS_CARD</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">blink_led</span><span class="p">;</span>
		<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_access_ring_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Read from device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Write to device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dev_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="n">u8</span> <span class="n">oc_now_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oc_ever_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">);</span>
	<span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mo">05</span><span class="p">;</span>
	<span class="n">status</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="n">status</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">oc_now_mask</span> <span class="o">=</span> <span class="n">MS_OC_NOW</span><span class="p">;</span>
		<span class="n">oc_ever_mask</span> <span class="o">=</span> <span class="n">MS_OC_EVER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">oc_now_mask</span> <span class="o">=</span> <span class="n">SD_OC_NOW</span><span class="p">;</span>
		<span class="n">oc_ever_mask</span> <span class="o">=</span> <span class="n">SD_OC_EVER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="n">oc_now_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="n">oc_ever_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">&gt;</span> <span class="mh">0x4000000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">[</span><span class="mh">0x0E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">[</span><span class="mh">0x0E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_SDR104</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_SDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_52M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_26M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0E</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_HG8BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">[</span><span class="mh">0x0F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span><span class="p">)</span>
			<span class="n">status</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="n">status</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_PWD_EXIST</span><span class="p">)</span>
			<span class="n">status</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;status[0x17] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="mh">0x17</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="n">status</span><span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8A</span><span class="p">;</span>
	<span class="n">status</span><span class="p">[</span><span class="mh">0x1A</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="n">status</span><span class="p">[</span><span class="mh">0x1F</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_chip_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">phy_debug_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_debug_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CDRESUMECTL</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtsx_disable_bus_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CDRESUMECTL</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtsx_enable_bus_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xFFFE</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rw_mem_cmd_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span>  <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INIT_BATCHCMD</span>:
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ADD_BATCHCMD</span>:
		<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SEND_BATCHCMD</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_BATCHRSP</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">suit_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INIT_BATCHCMD</span>:
	<span class="k">case</span> <span class="n">ADD_BATCHCMD</span>:
	<span class="k">case</span> <span class="n">SEND_BATCHCMD</span>:
	<span class="k">case</span> <span class="n">GET_BATCHRSP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">rw_mem_cmd_buf</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">erase_eeprom2</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_erase_eeprom_chip</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_erase_eeprom_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_eeprom2</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_read_eeprom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_eeprom2</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">spi_write_eeprom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_efuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_efuse</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_efuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWR_GATE_CTRL</span><span class="p">,</span> <span class="n">LDO3318_PWR_MASK</span><span class="p">,</span> <span class="n">LDO_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x4C00</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWR_GATE_CTRL</span><span class="p">,</span> <span class="n">LDO3318_PWR_MASK</span><span class="p">,</span> <span class="n">LDO_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SPI_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_efuse</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Exit</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">Exit:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SPI_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWR_GATE_CTRL</span><span class="p">,</span> <span class="n">LDO3318_PWR_MASK</span><span class="p">,</span> <span class="n">LDO_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWR_GATE_CTRL</span><span class="p">,</span> <span class="n">LDO3318_PWR_MASK</span><span class="p">,</span> <span class="n">LDO_ON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_cfg_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func</span><span class="p">,</span> <span class="n">func_max</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: func = %d, addr = 0x%x, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">func_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">func_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&gt;</span> <span class="n">func_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_cfg_seq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_cfg_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func</span><span class="p">,</span> <span class="n">func_max</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: func = %d, addr = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">func_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">func_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&gt;</span> <span class="n">func_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_seq</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">app_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PP_READ10</span>:
	<span class="k">case</span> <span class="n">PP_WRITE10</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_write</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_HOST_REG</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_host_reg</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_HOST_REG</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_host_reg</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_VAR</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_variable</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SET_VAR</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">set_variable</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DMA_READ</span>:
	<span class="k">case</span> <span class="n">DMA_WRITE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">dma_access_ring_buffer</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_PHY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_phy_register</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_PHY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_phy_register</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ERASE_EEPROM2</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">erase_eeprom2</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_EEPROM2</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_eeprom2</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_EEPROM2</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_eeprom2</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_EFUSE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_efuse</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_EFUSE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_efuse</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_CFG</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_cfg_byte</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_CFG</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_cfg_byte</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SET_CHIP_MODE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">set_chip_mode</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUIT_CMD</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">suit_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_DEV_STATUS</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_dev_status</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rtsx_status</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">);</span>

	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">product_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">);</span>

	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">lun</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">);</span>
	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_card_exist</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">SD_CARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">XD_CARD</span> <span class="o">|</span> <span class="n">SD_CARD</span> <span class="o">|</span> <span class="n">MS_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>

		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_52M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_HG8BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_MSXC</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DEFAULT_SINGLE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef SUPPORT_SDIO</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_int</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x83</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_status</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rtsx_status</span><span class="p">));</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">rtsx_status</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_card_bus_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">card</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">card</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">lun</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus_width</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">spi_vendor_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">gpio_dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>

	<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_GPIO_DIR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio_dir</span><span class="p">);</span>
	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_GPIO_DIR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">gpio_dir</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_SPI_GETSTATUS</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_get_status</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_SPI_SETPARAMETER</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_set_parameter</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_SPI_READFALSHID</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_read_flash_id</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_SPI_READFLASH</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_read_flash</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_SPI_WRITEFLASH</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_write_flash</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_SPI_WRITEFLASHSTATUS</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_write_flash_status</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCSI_SPI_ERASEFLASH</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_erase_flash</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_GPIO_DIR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">gpio_dir</span><span class="p">);</span>

		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_GPIO_DIR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">gpio_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vendor_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_STATUS</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_status</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_MEM</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_mem</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_MEM</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_mem</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_EEPROM</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_eeprom</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_EEPROM</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_eeprom</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TOGGLE_GPIO</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">toggle_gpio_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_SD_CSD</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_sd_csd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_BUS_WIDTH</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_card_bus_width</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef _MSG_TRACE</span>
	<span class="k">case</span> <span class="n">TRACE_MSG</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">trace_msg_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">SCSI_APP_CMD</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">app_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SPI_VENDOR_COMMAND</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">spi_vendor_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if !defined(LED_AUTO_BLINK) &amp;&amp; !defined(REGULAR_BLINK)</span>
<span class="kt">void</span> <span class="nf">led_shine</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sec_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_cap</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">GPIO_TOGGLE_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">toggle_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LED_GPIO</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_cap</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_cap</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sec_cnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_format_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">quick_format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x4D</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x47</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x66</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x6D</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x74</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">get_card_size</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quick_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">quick_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mspro_format</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">MS_SHORT_DATA_LEN</span><span class="p">,</span> <span class="n">quick_format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_FORMAT_CMD_FAILED</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ms_information</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">dev_info_id</span><span class="p">,</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xB0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x4D</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x53</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x49</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x44</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_info_id</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">(</span><span class="o">!</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">))</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x3A</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x6A</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*  GET Memory Stick Media Information Response Header */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="cm">/* Data length MSB */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span> 		<span class="cm">/* Data length LSB */</span>
	<span class="cm">/* Device Information Type Code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* SGM bit */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="cm">/* Reserved */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* Number of Device Information */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="cm">/*  Device Information Body */</span>

	<span class="cm">/* Device Information ID Number */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_info_id</span><span class="p">;</span>
	<span class="cm">/* Device Information Length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>		<span class="cm">/* Data length MSB */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span> 		<span class="cm">/* Data length LSB */</span>
	<span class="cm">/* Valid Bit */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* System Information */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">,</span> <span class="mi">96</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Model Name */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_model_name</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span><span class="o">-</span><span class="mh">0x3C</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span><span class="o">-</span><span class="mh">0x6C</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_sp_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">MS_FORMAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_format_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">GET_MS_INFORMATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">get_ms_information</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_CPRM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_extention_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">sd_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SD_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SD_PASS_THRU_MODE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_pass_thru_mode</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_EXECUTE_NO_DATA</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_execute_no_data</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_EXECUTE_READ</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_execute_read_data</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_EXECUTE_WRITE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_execute_write_data</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_GET_RSP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_get_cmd_rsp</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_HW_RST</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_hw_rst</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mg_report_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_format</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="n">KC_MG_R_PRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">key_format</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;key_format = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_format</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KF_GET_LOC_EKB</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x41C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_get_local_EKB</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_RSP_CHG</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_get_rsp_chg</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_GET_ICV</span>:
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_entry_num</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x404</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_get_ICV</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mg_send_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_format</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_exit_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="n">KC_MG_R_PRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">key_format</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;key_format = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_format</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KF_SET_LEAF_ID</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_set_leaf_id</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_CHG_HOST</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_chg</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_RSP_HOST</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_rsp</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_SET_ICV</span>:
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_entry_num</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x404</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_set_ICV</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">rtsx_scsi_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Block all SCSI command except for</span>
<span class="cm">		 * REQUEST_SENSE and rs_ppstatus</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">VENDOR_CMND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SCSI_APP_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">GET_DEV_STATUS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REQUEST_SENSE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Logical Unit Not Ready Format in Progress */</span>
			<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span>
				       <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">==</span> <span class="n">FORMAT_IN_PROGRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INQUIRY</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Logical Unit Not Ready Format in Progress */</span>
			<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">));</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_10</span>:
	<span class="k">case</span> <span class="n">WRITE_10</span>:
	<span class="k">case</span> <span class="n">READ_6</span>:
	<span class="k">case</span> <span class="n">WRITE_6</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_write</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#if !defined(LED_AUTO_BLINK) &amp;&amp; !defined(REGULAR_BLINK)</span>
		<span class="n">led_shine</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">test_unit_ready</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INQUIRY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">inquiry</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_capacity</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">START_STOP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">start_stop_unit</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">allow_medium_removal</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">request_sense</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">mode_sense</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x23</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_format_capacity</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VENDOR_CMND</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">vendor_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MS_SP_CMND</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">ms_sp_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_CPRM</span>
	<span class="k">case</span> <span class="n">SD_PASS_THRU_MODE</span>:
	<span class="k">case</span> <span class="n">SD_EXECUTE_NO_DATA</span>:
	<span class="k">case</span> <span class="n">SD_EXECUTE_READ</span>:
	<span class="k">case</span> <span class="n">SD_EXECUTE_WRITE</span>:
	<span class="k">case</span> <span class="n">SD_GET_RSP</span>:
	<span class="k">case</span> <span class="n">SD_HW_RST</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_extention_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="k">case</span> <span class="n">CMD_MSPRO_MG_RKEY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">mg_report_key</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_MSPRO_MG_SKEY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">mg_send_key</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">FORMAT_UNIT</span>:
	<span class="k">case</span> <span class="n">MODE_SELECT</span>:
	<span class="k">case</span> <span class="n">VERIFY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
