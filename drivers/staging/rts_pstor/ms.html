<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rts_pstor › ms.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ms.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek PCI-Express card reader</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;rtsx.h&quot;</span>
<span class="cp">#include &quot;rtsx_transport.h&quot;</span>
<span class="cp">#include &quot;rtsx_scsi.h&quot;</span>
<span class="cp">#include &quot;rtsx_card.h&quot;</span>
<span class="cp">#include &quot;ms.h&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ms_set_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ms_check_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">==</span> <span class="n">err_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_parse_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_transfer_tpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">trans_mode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tpc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ms_transfer_tpc: tpc = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpc</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TPC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">tpc</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_BYTE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_TRANSFER_START</span> <span class="o">|</span> <span class="n">trans_mode</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tpc</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>		<span class="cm">/* Read Packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="n">MS_CRC16_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CRC16_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/* Write Packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_ERR</span> <span class="o">|</span> <span class="n">MS_INT_CMDNK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="n">MS_RDY_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_transfer_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">trans_mode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tpc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sec_cnt</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">cfg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode_2k</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_sg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="o">!</span><span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trans_mode</span> <span class="o">==</span> <span class="n">MS_TM_AUTO_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="n">MS_FLASH_READ_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trans_mode</span> <span class="o">==</span> <span class="n">MS_TM_AUTO_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TPC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">tpc</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
		     <span class="n">MS_SECTOR_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sec_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_SECTOR_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">sec_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_2k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
			     <span class="n">MS_CFG</span><span class="p">,</span> <span class="n">MS_2K_SECTOR_MODE</span><span class="p">,</span> <span class="n">MS_2K_SECTOR_MODE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="n">MS_2K_SECTOR_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">sec_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
		     <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_TRANSFER_START</span> <span class="o">|</span> <span class="n">trans_mode</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span>
		     <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">);</span>

	<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span>
				    <span class="n">use_sg</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mspro_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_CMDNK</span> <span class="o">|</span> <span class="n">MS_INT_ERR</span> <span class="o">|</span> <span class="n">MS_CRC16_ERR</span> <span class="o">|</span> <span class="n">MS_RDY_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_write_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">tpc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
			     <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TPC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">tpc</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_BYTE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
		     <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_TRANSFER_START</span> <span class="o">|</span> <span class="n">MS_TM_WRITE_BYTES</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span>
		     <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;MS_TRANS_CFG: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tpc</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_CRC16_ERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CRC16_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_ERR</span> <span class="o">|</span> <span class="n">MS_INT_CMDNK</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_RDY_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_read_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tpc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TPC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">tpc</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_BYTE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_TRANSFER_START</span> <span class="o">|</span> <span class="n">MS_TM_READ_BYTES</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">data_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tpc</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_CRC16_ERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CRC16_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_ERR</span> <span class="o">|</span> <span class="n">MS_INT_CMDNK</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_RDY_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_parse_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tpc</span> <span class="o">==</span> <span class="n">PRO_READ_SHORT_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Read format progress:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">RTSX_DUMP</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_set_rw_reg_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">u8</span> <span class="n">read_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">write_start</span><span class="p">,</span> <span class="n">u8</span> <span class="n">write_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_start</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_start</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_RW_REG_ADRS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
					<span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_SET_CMD</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_set_init_para</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_HG8BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_ms_hg_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_ms_hg_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_ms_4bit_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_ms_4bit_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_ms_1bit_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_ms_1bit_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_switch_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_pull_ctl_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D1_PD</span> <span class="o">|</span> <span class="n">MS_D2_PD</span> <span class="o">|</span> <span class="n">MS_CLK_PD</span> <span class="o">|</span> <span class="n">MS_D6_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D3_PD</span> <span class="o">|</span> <span class="n">MS_D0_PD</span> <span class="o">|</span> <span class="n">MS_BS_PD</span> <span class="o">|</span> <span class="n">XD_D4_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D7_PD</span> <span class="o">|</span> <span class="n">XD_CE_PD</span> <span class="o">|</span> <span class="n">XD_CLE_PD</span> <span class="o">|</span> <span class="n">XD_CD_PU</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_RDY_PD</span> <span class="o">|</span> <span class="n">SD_D3_PD</span> <span class="o">|</span> <span class="n">SD_D2_PD</span> <span class="o">|</span> <span class="n">XD_ALE_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PD</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D5_PD</span> <span class="o">|</span> <span class="n">MS_D4_PD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_pull_ctl_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D1_PD</span> <span class="o">|</span> <span class="n">MS_D2_PD</span> <span class="o">|</span> <span class="n">MS_CLK_NP</span> <span class="o">|</span> <span class="n">MS_D6_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D3_PD</span> <span class="o">|</span> <span class="n">MS_D0_PD</span> <span class="o">|</span> <span class="n">MS_BS_NP</span> <span class="o">|</span> <span class="n">XD_D4_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D7_PD</span> <span class="o">|</span> <span class="n">XD_CE_PD</span> <span class="o">|</span> <span class="n">XD_CLE_PD</span> <span class="o">|</span> <span class="n">XD_CD_PU</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_RDY_PD</span> <span class="o">|</span> <span class="n">SD_D3_PD</span> <span class="o">|</span> <span class="n">SD_D2_PD</span> <span class="o">|</span> <span class="n">XD_ALE_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PD</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_D5_PD</span> <span class="o">|</span> <span class="n">MS_D4_PD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
				     <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
				     <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
				     <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
				     <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_prepare_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">oc_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">check_ms_flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">switch_8bit_fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">.</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">enable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_pull_ctl_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="n">FPGA_MS_PULL_CTL_BIT</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">oc_mask</span> <span class="o">=</span> <span class="n">MS_OC_NOW</span> <span class="o">|</span> <span class="n">MS_OC_EVER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">oc_mask</span> <span class="o">=</span> <span class="n">SD_OC_NOW</span> <span class="o">|</span> <span class="n">SD_OC_EVER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="n">oc_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Over current, OCPSTAT is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">MS_OUTPUT_EN</span><span class="p">,</span> <span class="n">MS_OUTPUT_EN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SAMPLE_TIME_RISING</span> <span class="o">|</span> <span class="n">PUSH_TIME_DEFAULT</span> <span class="o">|</span>
			<span class="n">NO_EXTEND_TOGGLE</span> <span class="o">|</span> <span class="n">MS_BUS_WIDTH_1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SAMPLE_TIME_FALLING</span> <span class="o">|</span> <span class="n">PUSH_TIME_DEFAULT</span> <span class="o">|</span>
			<span class="n">NO_EXTEND_TOGGLE</span> <span class="o">|</span> <span class="n">MS_BUS_WIDTH_1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span> <span class="o">|</span> <span class="n">NO_AUTO_READ_INT_REG</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_STOP</span><span class="p">,</span> <span class="n">MS_STOP</span> <span class="o">|</span> <span class="n">MS_CLR_ERR</span><span class="p">,</span> <span class="n">MS_STOP</span> <span class="o">|</span> <span class="n">MS_CLR_ERR</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_identify_media_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">switch_8bit_bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Pro_StatusReg</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_READ_BYTES</span><span class="p">,</span> <span class="n">READ_REG</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Type register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">check_ms_flow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Category register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">check_ms_flow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Class register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WRT_PRTCT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_CARD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">check_ms_flow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">|=</span> <span class="n">TYPE_MSPRO</span><span class="p">;</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;IF Mode register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">switch_8bit_bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">|=</span> <span class="n">MS_HG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_confirm_cpu_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Confirm CPU StartUp */</span>
	<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">k</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MS_CARD</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* --  end confirm CPU startup */</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_switch_parallel_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARALLEL_4BIT_IF</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_switch_8bit_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARALLEL_8BIT_IF</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="n">MS_BUS_WIDTH_8</span> <span class="o">|</span> <span class="n">SAMPLE_TIME_FALLING</span><span class="p">);</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">|=</span> <span class="n">MS_8BIT</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_READ_BYTES</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_pro_reset_flow</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">switch_8bit_bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_prepare_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_identify_media_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">switch_8bit_bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_confirm_cpu_startup</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_parallel_bus</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_CARD</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Switch MS-PRO into Parallel mode */</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">MS_BUS_WIDTH_4</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="n">PUSH_TIME_ODD</span><span class="p">,</span> <span class="n">PUSH_TIME_ODD</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If MSPro HG Card, We shall try to switch to 8-bit bus */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSHG</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">support_ms_8bit</span> <span class="o">&amp;&amp;</span> <span class="n">switch_8bit_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_8bit_bus</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">switch_8bit_fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef XC_POWERCLASS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">msxc_change_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Pro_DataCount1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_WRITE_REG</span> <span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XC_CHG_POWER</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_CMDNK</span> <span class="o">|</span> <span class="n">MS_INT_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_read_attribute_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">class_code</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">sub_class</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">total_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blk_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_MSXC</span>
	<span class="n">u32</span> <span class="n">xc_total_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xc_blk_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u32</span> <span class="n">sys_info_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sys_info_size</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
	<span class="n">u32</span> <span class="n">model_name_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">model_name_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_sys_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">found_model_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Pro_IntReg</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Pro_SystemParm</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS8BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARALLEL_8BIT_IF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARALLEL_4BIT_IF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_WRITE_REG</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_READ_ATRB</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_INT_BREQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_AUTO_READ</span><span class="p">,</span> <span class="n">PRO_READ_LONG_DATA</span><span class="p">,</span>
				<span class="mh">0x40</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_INT_CED</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_INT_BREQ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">PRO_READ_LONG_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xa5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xc3</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Signature code is wrong */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cur_addr_off</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_MSXC</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">))</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="n">sys_info_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
			<span class="n">sys_info_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sys_info_addr = 0x%x, sys_info_size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sys_info_addr</span><span class="p">,</span> <span class="n">sys_info_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sys_info_size</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">)</span>  <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sys_info_addr</span> <span class="o">&lt;</span> <span class="mh">0x1A0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sys_info_size</span> <span class="o">+</span> <span class="n">sys_info_addr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_MSXC</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">|=</span> <span class="n">MS_XC</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
			<span class="n">found_sys_info</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">model_name_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
			<span class="n">model_name_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">cur_addr_off</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;model_name_addr = 0x%x, model_name_size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">model_name_addr</span><span class="p">,</span> <span class="n">model_name_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">model_name_size</span> <span class="o">!=</span> <span class="mi">48</span><span class="p">)</span>  <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">model_name_addr</span> <span class="o">&lt;</span> <span class="mh">0x1A0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">model_name_size</span> <span class="o">+</span> <span class="n">model_name_addr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">found_model_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found_sys_info</span> <span class="o">&amp;&amp;</span> <span class="n">found_model_name</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">class_code</span> <span class="o">=</span>  <span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
	<span class="n">device_type</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">56</span><span class="p">];</span>
	<span class="n">sub_class</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">46</span><span class="p">];</span>
<span class="cp">#ifdef SUPPORT_MSXC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xc_total_blk</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">];</span>
		<span class="n">xc_blk_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">33</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">34</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">35</span><span class="p">];</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xc_total_blk = 0x%x, xc_blk_size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xc_total_blk</span><span class="p">,</span> <span class="n">xc_blk_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">total_blk</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
		<span class="n">blk_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;total_blk = 0x%x, blk_size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_blk</span><span class="p">,</span> <span class="n">blk_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">total_blk</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">];</span>
	<span class="n">blk_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">sys_info_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;total_blk = 0x%x, blk_size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_blk</span><span class="p">,</span> <span class="n">blk_size</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;class_code = 0x%x, device_type = 0x%x, sub_class = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">class_code</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">sub_class</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">sys_info_addr</span><span class="p">,</span> <span class="mi">96</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_model_name</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">model_name_addr</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_MSXC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">device_type</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sub_class</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;class_code: 0x%x, device_type: 0x%x, sub_class: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">class_code</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">sub_class</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_MSXC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">xc_total_blk</span> <span class="o">*</span> <span class="n">xc_blk_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">total_blk</span> <span class="o">*</span> <span class="n">blk_size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">total_blk</span> <span class="o">*</span> <span class="n">blk_size</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mg_set_tpc_para_sub</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mg_entry_num</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_ms_pro</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#ifdef XC_POWERCLASS</span>
	<span class="n">u8</span> <span class="n">change_power_class</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_power_class_en</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">change_power_class</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_power_class_en</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">change_power_class</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change_power_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef XC_POWERCLASS</span>
<span class="nl">Retry:</span>
<span class="cp">#endif</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_pro_reset_flow</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">switch_8bit_fail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_pro_reset_flow</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_attribute_info</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef XC_POWERCLASS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_HG8BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">change_power_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change_power_class</span> <span class="o">&amp;&amp;</span> <span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">power_class_en</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_power_class_en</span><span class="p">;</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;power_class_en = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">power_class_en</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;change_power_class = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">change_power_class</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">change_power_class</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">power_class_en</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">change_power_class</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">power_class_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">power_class_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">power_class_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;power_class_mode = 0x%x&quot;</span><span class="p">,</span> <span class="n">power_class_mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">change_power_class</span> <span class="o">&gt;</span> <span class="n">power_class_mode</span><span class="p">)</span>
				<span class="n">change_power_class</span> <span class="o">=</span> <span class="n">power_class_mode</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">change_power_class</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">msxc_change_power</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">change_power_class</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">change_power_class</span><span class="o">--</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">Retry</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_set_tpc_para_sub</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_HG8BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_read_status_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">StatusReg0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STS_UCDT</span> <span class="o">|</span> <span class="n">STS_UCEX</span> <span class="o">|</span> <span class="n">STS_UCFG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_READ_ERROR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_read_extra_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">block_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Parallel interface */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Serial interface */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">block_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">block_addr</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_num</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_READ</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_status_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">)</span>
			<span class="n">buf_len</span> <span class="o">=</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_write_extra_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">block_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">block_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">block_addr</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_num</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_EXTRA_SIZE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">6</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span> <span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="n">MS_EXTRA_SIZE</span><span class="p">),</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_WRITE</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_read_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">block_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">block_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">block_addr</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_num</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span> <span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_READ</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_BREQ</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>  <span class="n">MS_FLASH_READ_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_status_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>  <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_BREQ</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_BREQ_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">READ_PAGE_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_set_bad_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">extra</span><span class="p">[</span><span class="n">MS_EXTRA_SIZE</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">phy_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">phy_blk</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span> <span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_WRITE</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_erase_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">phy_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">phy_blk</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">ERASE_RTY:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_ERASE</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">ERASE_RTY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
		<span class="n">ms_set_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ms_set_page_status</span><span class="p">(</span><span class="n">u16</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">extra</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extra_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extra</span> <span class="o">||</span> <span class="p">(</span><span class="n">extra_len</span> <span class="o">&lt;</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">setPS_NG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set page status as 1:NG,and block status keep 1:OK */</span>
		<span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xB8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* set page status as 0:Data Error,and block status keep 1:OK */</span>
		<span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x98</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">extra</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">extra</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">log_blk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_init_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">extra</span><span class="p">[</span><span class="n">MS_EXTRA_SIZE</span><span class="p">],</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>

	<span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf8</span><span class="p">;</span>	<span class="cm">/* Block, page OK, data erased */</span>
	<span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">extra</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">extra</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">log_blk</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_copy_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">new_blk</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">rty_cnt</span><span class="p">,</span> <span class="n">uncorrect_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">extra</span><span class="p">[</span><span class="n">MS_EXTRA_SIZE</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Copy page from 0x%x to 0x%x, logical block is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;start_page = %d, end_page = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_status_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BUF_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLEAR_BUF</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ms_read_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">old_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">old_blk</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span> <span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_READ</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_status_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">uncorrect_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Uncorrectable error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">uncorrect_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">READ_PAGE_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">uncorrect_flag</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ms_set_page_status</span><span class="p">(</span><span class="n">log_blk</span><span class="p">,</span> <span class="n">setPS_NG</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xEF</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">ms_write_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
					<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;page %d : extra[0] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
					<span class="n">MS_SET_BAD_BLOCK_FLG</span><span class="p">(</span><span class="n">ms_card</span><span class="p">);</span>

					<span class="n">ms_set_page_status</span><span class="p">(</span><span class="n">log_blk</span><span class="p">,</span> <span class="n">setPS_Error</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
					<span class="n">ms_write_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">rty_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rty_cnt</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">rty_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_NORMAL_WRITE</span><span class="p">,</span>
							<span class="n">WRITE_PAGE_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rty_cnt</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_BREQ</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_BREQ_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span>
				<span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="n">MS_EXTRA_SIZE</span><span class="p">));</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">new_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">new_blk</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">log_blk</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">),</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_WRITE</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">old_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">old_blk</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEF</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_WRITE</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">extra</span><span class="p">[</span><span class="n">MS_EXTRA_SIZE</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="cp">#ifndef SUPPORT_MAGIC_GATE</span>
	<span class="n">u16</span> <span class="n">eblock_cnt</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_prepare_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">|=</span> <span class="n">TYPE_MS</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_RESET</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_status_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">WRT_PRTCT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">RE_SEARCH:</span>
	<span class="cm">/* Search Boot Block */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_DEFECTIVE_BLOCK</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BLOCK_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NOT_BOOT_BLOCK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAX_DEFECTIVE_BLOCK</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No boot block found!&quot;</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ms_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">RE_SEARCH</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Read MS system information as sys_info */</span>
	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">96</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mh">0x1A0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">96</span><span class="p">);</span>

	<span class="cm">/* Read useful block contents */</span>
	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">HEADER_ID0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">HEADER_ID1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">DISABLED_BLOCK0</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;=</span> <span class="n">DISABLED_BLOCK3</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">BLOCK_SIZE_0</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE_1</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">MS_Device_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">MS_4bit_Support</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Boot block data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RTSX_DUMP</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Block ID error</span>
<span class="cm">	 * HEADER_ID0, HEADER_ID1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">RE_SEARCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Page size error</span>
<span class="cm">	 * PAGE_SIZE_0, PAGE_SIZE_1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">RE_SEARCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BLOCK_SIZE_0, BLOCK_SIZE_1 */</span>
	<span class="n">block_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">==</span> <span class="mh">0x0010</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Block size 16KB */</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">block_shift</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">==</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Block size 8KB */</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">block_shift</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BLOCK_COUNT_0, BLOCK_COUNT_1 */</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_block</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">block_shift</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>  <span class="p">{</span> <span class="cm">/* 4MB or 8MB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>  <span class="p">{</span> <span class="cm">/* Effective block for 4MB: 0x1F0 */</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0x1EE0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Effective block for 8MB: 0x3E0 */</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0x3DE0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span> <span class="cm">/* 16MB, 32MB, 64MB or 128MB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>  <span class="p">{</span> <span class="cm">/* Effective block for 16MB: 0x3E0 */</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0x7BC0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0xA</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Effective block for 32MB: 0x7C0 */</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0xF7C0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Effective block for 64MB: 0xF80 */</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0x1EF80</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Effective block for 128MB: 0x1F00 */</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mh">0x3DF00</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="cm">/* EBLOCK_COUNT_0, EBLOCK_COUNT_1 */</span>
	<span class="n">eblock_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">eblock_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">;</span>

	<span class="cm">/* Switch I/F Mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_WRITE_BYTES</span><span class="p">,</span> <span class="n">WRITE_REG</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="mh">0x58</span> <span class="o">|</span> <span class="n">MS_NO_CHECK_INT</span><span class="p">,</span>
				<span class="n">MS_BUS_WIDTH_4</span> <span class="o">|</span> <span class="n">PUSH_TIME_ODD</span> <span class="o">|</span> <span class="n">MS_NO_CHECK_INT</span><span class="p">);</span>

		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">|=</span> <span class="n">MS_4BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_init_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">defect_block</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_block</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ms_card-&gt;segment_cnt = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone_entry</span><span class="p">);</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">INIT_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">PPBUF_BASE2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(((</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_block</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">INIT_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">INIT_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">defect_block</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">val1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">val2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">defect_block</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seg_no</span> <span class="o">=</span> <span class="n">defect_block</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">].</span><span class="n">defect_list</span><span class="p">[</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">].</span><span class="n">disable_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">defect_block</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">build_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">unused_blk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;defective block count of segment %d is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">disable_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="nl">INIT_FAIL:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">);</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">ms_get_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">u16</span> <span class="n">log_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">segment</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">segment</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">];</span>

	<span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ms_set_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">u16</span> <span class="n">log_off</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">segment</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">segment</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_blk</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ms_set_unused_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">segment</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seg_no</span><span class="p">;</span>

	<span class="n">seg_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">phy_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">segment</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>

	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">[</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_blk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">&gt;=</span> <span class="n">MS_FREE_TABLE_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">segment</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">ms_get_unused_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">segment</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_blk</span><span class="p">;</span>

	<span class="n">segment</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">phy_blk</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">[</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">get_index</span><span class="p">];</span>
	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">[</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">get_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">&gt;=</span> <span class="n">MS_FREE_TABLE_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">segment</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">phy_blk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ms_start_idx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">494</span><span class="p">,</span> <span class="mi">990</span><span class="p">,</span> <span class="mi">1486</span><span class="p">,</span> <span class="mi">1982</span><span class="p">,</span> <span class="mi">2478</span><span class="p">,</span> <span class="mi">2974</span><span class="p">,</span> <span class="mi">3470</span><span class="p">,</span>
	<span class="mi">3966</span><span class="p">,</span> <span class="mi">4462</span><span class="p">,</span> <span class="mi">4958</span><span class="p">,</span> <span class="mi">5454</span><span class="p">,</span> <span class="mi">5950</span><span class="p">,</span> <span class="mi">6446</span><span class="p">,</span> <span class="mi">6942</span><span class="p">,</span> <span class="mi">7438</span><span class="p">,</span> <span class="mi">7934</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_arbitrate_l2p</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">log_off</span><span class="p">,</span> <span class="n">u8</span> <span class="n">us1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">us2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">segment</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seg_no</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_blk</span><span class="p">;</span>

	<span class="n">seg_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">phy_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">segment</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>
	<span class="n">tmp_blk</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">us1</span> <span class="o">!=</span> <span class="n">us2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">us1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">);</span>
			<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_blk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">&lt;</span> <span class="n">tmp_blk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">);</span>
			<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_blk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_build_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">segment</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">table_size</span><span class="p">,</span> <span class="n">disable_cnt</span><span class="p">,</span> <span class="n">defect_flag</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">extra</span><span class="p">[</span><span class="n">MS_EXTRA_SIZE</span><span class="p">],</span> <span class="n">us1</span><span class="p">,</span> <span class="n">us2</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ms_build_l2p_tbl: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_init_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">].</span><span class="n">build_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;l2p table of segment %d has been built</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seg_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">table_size</span> <span class="o">=</span> <span class="mi">494</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">table_size</span> <span class="o">=</span> <span class="mi">496</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">segment</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">table_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BUILD_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">table_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">MS_FREE_TABLE_CNT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BUILD_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">MS_FREE_TABLE_CNT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">seg_no</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">seg_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">disable_cnt</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">disable_count</span><span class="p">;</span>

	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">phy_blk</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">phy_blk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disable_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">defect_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">disable_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">==</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">defect_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">defect_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">defect_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">disable_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;read extra data fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ms_set_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">seg_no</span> <span class="o">==</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NOT_TRANSLATION_TABLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="n">extra</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
					<span class="n">extra</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BLOCK_OK</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NOT_BOOT_BLOCK</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PAGE_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PAGE_OK</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">log_blk</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">extra</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">extra</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">log_blk</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">log_blk</span> <span class="o">&lt;</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">])</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">log_blk</span> <span class="o">&gt;=</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]]</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]]</span> <span class="o">=</span> <span class="n">phy_blk</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">us1</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">tmp_blk</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]];</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">us2</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ms_arbitrate_l2p</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="o">-</span><span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">],</span> <span class="n">us1</span><span class="p">,</span> <span class="n">us2</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">build_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;unused block count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="p">);</span>

	<span class="cm">/* Logical Address Confirmation Process */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg_no</span> <span class="o">==</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">log_blk</span> <span class="o">=</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">];</span> <span class="n">log_blk</span> <span class="o">&lt;</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="n">log_blk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_blk</span><span class="o">-</span><span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]]</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_blk</span> <span class="o">=</span> <span class="n">ms_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_init_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BUILD_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_blk</span><span class="o">-</span><span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]]</span> <span class="o">=</span> <span class="n">phy_blk</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seg_no</span> <span class="o">==</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Make boot block be the first normal block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">log_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">log_blk</span> <span class="o">&lt;</span> <span class="mi">494</span><span class="p">;</span> <span class="n">log_blk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_blk</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_blk</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_blk</span> <span class="o">&lt;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">boot_block</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Boot block is not the first normal block.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">phy_blk</span> <span class="o">=</span> <span class="n">ms_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span>
						<span class="n">log_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_blk</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_blk</span><span class="p">;</span>

				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tmp_blk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="nl">BUILD_FAIL:</span>
	<span class="n">segment</span><span class="o">-&gt;</span><span class="n">build_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">);</span>
		<span class="n">segment</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">);</span>
		<span class="n">segment</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">reset_ms_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ms_card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ms_info</span><span class="p">));</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">enable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_ms_pro</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">check_ms_flow</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_ms</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Build table for the last segment,</span>
<span class="cm">		 * to check if L2P talbe block exist,erasing it</span>
<span class="cm">		 */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_build_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_block</span> <span class="o">/</span> <span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ms_card-&gt;ms_type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mspro_set_rw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start_sec</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sec_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sec_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">sec_cnt</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_sec</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_sec</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_sec</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">start_sec</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_EX_SET_CMD</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">mspro_stop_seq_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_sec_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_STOP</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>

		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RBCTL</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ms_auto_tune_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">-=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">==</span> <span class="n">CLK_80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">CLK_60</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">==</span> <span class="n">CLK_60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">ms_clock</span> <span class="o">=</span> <span class="n">CLK_40</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mspro_rw_multi_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sector_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">mode_2k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">trans_mode</span><span class="p">,</span> <span class="n">rw_tpc</span><span class="p">,</span> <span class="n">rw_cmd</span><span class="p">;</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSHG</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_sector</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sector_cnt</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rw_tpc</span> <span class="o">=</span> <span class="n">PRO_READ_LONG_DATA</span><span class="p">;</span>
				<span class="n">rw_cmd</span> <span class="o">=</span> <span class="n">PRO_READ_DATA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rw_tpc</span> <span class="o">=</span> <span class="n">PRO_WRITE_LONG_DATA</span><span class="p">;</span>
				<span class="n">rw_cmd</span> <span class="o">=</span> <span class="n">PRO_WRITE_DATA</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rw_tpc</span> <span class="o">=</span> <span class="n">PRO_READ_QUAD_DATA</span><span class="p">;</span>
				<span class="n">rw_cmd</span> <span class="o">=</span> <span class="n">PRO_READ_2K_DATA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rw_tpc</span> <span class="o">=</span> <span class="n">PRO_WRITE_QUAD_DATA</span><span class="p">;</span>
				<span class="n">rw_cmd</span> <span class="o">=</span> <span class="n">PRO_WRITE_2K_DATA</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mode_2k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rw_tpc</span> <span class="o">=</span> <span class="n">PRO_READ_LONG_DATA</span><span class="p">;</span>
			<span class="n">rw_cmd</span> <span class="o">=</span> <span class="n">PRO_READ_DATA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rw_tpc</span> <span class="o">=</span> <span class="n">PRO_WRITE_LONG_DATA</span><span class="p">;</span>
			<span class="n">rw_cmd</span> <span class="o">=</span> <span class="n">PRO_WRITE_DATA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trans_mode</span> <span class="o">=</span> <span class="n">MS_TM_AUTO_READ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">trans_mode</span> <span class="o">=</span> <span class="n">MS_TM_AUTO_WRITE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pre_dir</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">((</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pre_sec_addr</span> <span class="o">+</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pre_sec_cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">start_sector</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">mode_2k</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">&amp;</span> <span class="n">MODE_512_SEQ</span><span class="p">))</span>
				<span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_2k</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">&amp;</span> <span class="n">MODE_2K_SEQ</span><span class="p">))</span>
				<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_INT_BREQ</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">((</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_sec_cnt</span> <span class="o">+</span> <span class="n">sector_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFE00</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_sec_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_INT_BREQ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_STOP</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RBCTL</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_sec_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sector_cnt</span> <span class="o">&gt;=</span> <span class="n">SEQ_START_CRITERIA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">start_sector</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFE00</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mh">0xFE00</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">start_sector</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">sector_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mode_2k</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">|=</span> <span class="n">MODE_2K_SEQ</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">|=</span> <span class="n">MODE_512_SEQ</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">sector_cnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mspro_set_rw_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">rw_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">trans_mode</span><span class="p">,</span> <span class="n">rw_tpc</span><span class="p">,</span> <span class="n">sector_cnt</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">mode_2k</span><span class="p">,</span>
			<span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No card exist, exit mspro_rw_multi_sector</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_INT_BREQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_STOP</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_CRC16_ERR</span> <span class="o">|</span> <span class="n">MS_RDY_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;MSPro CRC error, tune clock!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ms_auto_tune_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pre_sec_addr</span> <span class="o">=</span> <span class="n">start_sector</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pre_sec_cnt</span> <span class="o">=</span> <span class="n">sector_cnt</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pre_dir</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">total_sec_cnt</span> <span class="o">+=</span> <span class="n">sector_cnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mspro_read_format_progress</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">short_data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total_progress</span><span class="p">,</span> <span class="n">cur_progress</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;mspro_read_format_progress, short_data_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">short_data_len</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MS_INT_BREQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span>  <span class="p">(</span><span class="n">MS_INT_CED</span> <span class="o">|</span> <span class="n">MS_INT_BREQ</span> <span class="o">|</span> <span class="n">MS_INT_CMDNK</span> <span class="o">|</span> <span class="n">MS_INT_ERR</span><span class="p">))</span> <span class="o">==</span> <span class="n">MS_INT_CED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_SUCCESS</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">short_data_len</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">short_data_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="n">MS_NO_CHECK_INT</span><span class="p">,</span> <span class="n">MS_NO_CHECK_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_READ_SHORT_DATA</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">total_progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">cur_progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;total_progress = %d, cur_progress = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">total_progress</span><span class="p">,</span> <span class="n">cur_progress</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_progress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">ulltmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">cur_progress</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">65535</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">ulltmp</span><span class="p">,</span> <span class="n">total_progress</span><span class="p">);</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">ulltmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;progress = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_CED</span> <span class="o">|</span> <span class="n">MS_INT_CMDNK</span> <span class="o">|</span> <span class="n">MS_INT_BREQ</span> <span class="o">|</span> <span class="n">MS_INT_ERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span> <span class="n">MS_NO_CHECK_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_CMDNK</span> <span class="o">|</span> <span class="n">MS_INT_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MS_INT_CED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_SUCCESS</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MS_INT_BREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_IN_PROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_FAIL</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mspro_polling_format_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">65535</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mspro_read_format_progress</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_SHORT_DATA_LEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">!=</span> <span class="n">FORMAT_IN_PROGRESS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mspro_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">short_data_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quick_format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">para</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">Pro_TPCParm</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">short_data_len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">256</span>:
	<span class="nl">default:</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_WRITE_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quick_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">para</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">para</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mspro_set_rw_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">PRO_FORMAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_CMDNK</span> <span class="o">|</span> <span class="n">MS_INT_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_BREQ</span> <span class="o">|</span> <span class="n">MS_INT_CED</span><span class="p">))</span> <span class="o">==</span> <span class="n">MS_INT_BREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_IN_PROGRESS</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MS_INT_CED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">=</span> <span class="n">FORMAT_SUCCESS</span><span class="p">;</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_read_multiple_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">log_blk</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">extra</span><span class="p">[</span><span class="n">MS_EXTRA_SIZE</span><span class="p">],</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trans_cfg</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_READ_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">phy_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">phy_blk</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_READ</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span> <span class="n">page_addr</span> <span class="o">&lt;</span> <span class="n">end_page</span><span class="p">;</span> <span class="n">page_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_BREQ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_status_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">reset_ms</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
						<span class="n">ms_set_page_status</span><span class="p">(</span><span class="n">log_blk</span><span class="p">,</span> <span class="n">setPS_NG</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
						<span class="n">ms_write_extra_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span>
								<span class="n">page_addr</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_READ_ERROR</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_READ_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_BREQ</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_BREQ_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">==</span> <span class="p">(</span><span class="n">end_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_END</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_READ_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">trans_cfg</span> <span class="o">=</span> <span class="n">NO_WAIT_INT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">trans_cfg</span> <span class="o">=</span> <span class="n">WAIT_INT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TPC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">READ_PAGE_DATA</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">trans_cfg</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">RING_BUFFER</span><span class="p">);</span>

		<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="n">MS_TRANSFER_START</span> <span class="o">|</span>  <span class="n">MS_TM_NORMAL_READ</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data_partial</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">),</span>
				<span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
				<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
				<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_CRC16_ERR</span> <span class="o">|</span> <span class="n">MS_RDY_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CRC16_ERROR</span><span class="p">);</span>
				<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_write_multiple_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">new_blk</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">old_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">old_blk</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEF</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_WRITE</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_tpc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_READ_BYTES</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OverwriteFlag</span><span class="p">,</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">SystemParm</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MS4BIT</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">new_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">new_blk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">end_page</span> <span class="o">-</span> <span class="n">start_page</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF8</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">log_blk</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG</span><span class="p">,</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">MS_EXTRA_SIZE</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_WRITE</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span> <span class="n">page_addr</span> <span class="o">&lt;</span> <span class="n">end_page</span><span class="p">;</span> <span class="n">page_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CMDNK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CMD_NK</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_BREQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_BREQ_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TPC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">WRITE_PAGE_DATA</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">RING_BUFFER</span><span class="p">);</span>

		<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="n">MS_TRANSFER_START</span> <span class="o">|</span>  <span class="n">MS_TM_NORMAL_WRITE</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data_partial</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">),</span>
				<span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TO_ERROR</span><span class="p">);</span>
			<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">end_page</span> <span class="o">-</span> <span class="n">start_page</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">==</span> <span class="p">(</span><span class="n">end_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BLOCK_END</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GET_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">page_addr</span> <span class="o">==</span> <span class="p">(</span><span class="n">end_page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">page_addr</span> <span class="o">==</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">INT_REG_CED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_FLASH_WRITE_ERROR</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_finish_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">new_blk</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span>
			<span class="n">page_off</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seg_no</span> <span class="o">=</span> <span class="n">old_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MS_TST_BAD_BLOCK_FLG</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MS_CLR_BAD_BLOCK_FLG</span><span class="p">(</span><span class="n">ms_card</span><span class="p">);</span>
		<span class="n">ms_set_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ms_set_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">],</span> <span class="n">new_blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_prepare_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">new_blk</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">start_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef MS_DELAY_WRITE</span>
<span class="kt">int</span> <span class="nf">ms_delay_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ms_delay_write_tag</span> <span class="o">*</span><span class="n">delay_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_finish_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">,</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">,</span>
				<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span><span class="p">,</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ms_rw_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_rw_multi_sector</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sector_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">old_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">total_sec_cnt</span> <span class="o">=</span> <span class="n">sector_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="cp">#ifdef MS_DELAY_WRITE</span>
	<span class="k">struct</span> <span class="n">ms_delay_write_tag</span> <span class="o">*</span><span class="n">delay_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ms_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_NO_ERROR</span><span class="p">);</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_rw_fail</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">log_blk</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">start_sector</span> <span class="o">&gt;&gt;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">);</span>
	<span class="n">start_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">start_sector</span> <span class="o">&amp;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">seg_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">seg_no</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ms_start_idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">seg_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">log_blk</span> <span class="o">&lt;</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">].</span><span class="n">build_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_build_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef MS_DELAY_WRITE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span> <span class="o">==</span> <span class="n">log_blk</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">start_page</span> <span class="o">&gt;</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">,</span>
				<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span>
				<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">,</span> <span class="n">start_page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">old_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">;</span>
			<span class="n">new_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span> <span class="o">==</span> <span class="n">log_blk</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">start_page</span> <span class="o">==</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">old_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">;</span>
			<span class="n">new_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_delay_write</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">old_blk</span> <span class="o">=</span> <span class="n">ms_get_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>
			<span class="n">new_blk</span>  <span class="o">=</span> <span class="n">ms_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">old_blk</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_prepare_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">start_page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#ifdef MS_DELAY_WRITE</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef MS_DELAY_WRITE</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_delay_write</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">old_blk</span> <span class="o">=</span> <span class="n">ms_get_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_blk</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;seg_no = %d, old_blk = 0x%x, new_blk = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">total_sec_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_page</span> <span class="o">+</span> <span class="n">total_sec_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">end_page</span> <span class="o">=</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">end_page</span> <span class="o">=</span> <span class="n">start_page</span> <span class="o">+</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">total_sec_cnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">page_cnt</span> <span class="o">=</span> <span class="n">end_page</span> <span class="o">-</span> <span class="n">start_page</span><span class="p">;</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;start_page = %d, end_page = %d, page_cnt = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">,</span> <span class="n">page_cnt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_multiple_pages</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">old_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">,</span>
				<span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_multiple_pages</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span>
				<span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">,</span>
				<span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">toggle_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ms_rw_fail</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end_page</span> <span class="o">==</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ms_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ms_set_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">],</span> <span class="n">new_blk</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">total_sec_cnt</span> <span class="o">-=</span> <span class="n">page_cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">page_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total_sec_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">log_blk</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">seg_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">seg_no</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ms_start_idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">seg_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">log_blk</span> <span class="o">&lt;</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">seg_no</span><span class="p">].</span><span class="n">build_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_build_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">old_blk</span> <span class="o">=</span> <span class="n">ms_get_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">log_blk</span> <span class="o">-</span> <span class="n">ms_start_idx</span><span class="p">[</span><span class="n">seg_no</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_blk</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ms_rw_fail</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_blk</span> <span class="o">=</span> <span class="n">ms_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_rw_fail</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;seg_no = %d, old_blk = 0x%x, new_blk = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seg_no</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>

		<span class="n">start_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end_page</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef MS_DELAY_WRITE</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span> <span class="o">=</span> <span class="n">old_blk</span><span class="p">;</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span> <span class="o">=</span> <span class="n">new_blk</span><span class="p">;</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span> <span class="o">=</span> <span class="n">log_blk</span><span class="p">;</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span> <span class="o">=</span> <span class="n">end_page</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_finish_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">end_page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">ms_rw_fail</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ms_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sector_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mspro_rw_multi_sector</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">sector_cnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_rw_multi_sector</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">sector_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ms_free_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span><span class="p">);</span>
				<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span><span class="p">);</span>
				<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">);</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">segment</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>

<span class="cp">#ifdef READ_BYTES_WAIT_INT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_poll_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="n">MS_INT_CED</span><span class="p">,</span> <span class="n">MS_INT_CED</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_INT_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MS_SAMPLE_INT_ERR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_ms_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_TRANSFER_ERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_INT_ERR</span> <span class="o">|</span> <span class="n">MS_INT_CMDNK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_ms_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MS_TRANSFER_ERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mg_send_ex_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">entry_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry_num</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_EX_SET_CMD</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MS_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mg_set_tpc_para_sub</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mg_entry_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Pro_TPCParm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_set_rw_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Pro_DataCount1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mg_entry_num</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_WRITE_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NO_WAIT_INT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mg_set_leaf_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_SET_LID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf1</span><span class="p">[</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_WRITE_SHORT_DATA</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mg_get_local_EKB</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufflen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1540</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1A</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_GET_LEKB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GetEKBFinish</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_AUTO_READ</span><span class="p">,</span> <span class="n">PRO_READ_LONG_DATA</span><span class="p">,</span>
				<span class="mi">3</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1536</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GetEKBFinish</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bufflen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">1052</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

<span class="nl">GetEKBFinish:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mg_chg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufflen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_GET_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_READ_SHORT_DATA</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">magic_gate_id</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

<span class="cp">#ifdef READ_BYTES_WAIT_INT</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_poll_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_SET_RD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bufflen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_WRITE_SHORT_DATA</span><span class="p">,</span>
				<span class="mi">32</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_auth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mg_get_rsp_chg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufflen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_MAKE_RMS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_read_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_READ_SHORT_DATA</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">buf2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">magic_gate_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf2</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">bufflen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

<span class="cp">#ifdef READ_BYTES_WAIT_INT</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_poll_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mg_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufflen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_MAKE_KSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bufflen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_write_bytes</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PRO_WRITE_SHORT_DATA</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_auth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mg_get_ICV</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufflen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1028</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_GET_IBD</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_entry_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GetICVFinish</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_AUTO_READ</span><span class="p">,</span> <span class="n">PRO_READ_LONG_DATA</span><span class="p">,</span>
				<span class="mi">2</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GetICVFinish</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bufflen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">1028</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

<span class="nl">GetICVFinish:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mg_set_ICV</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufflen</span><span class="p">;</span>
<span class="cp">#ifdef MG_SET_ICV_SLOW</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;--%s--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1028</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bufflen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">1028</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_send_ex_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MG_SET_IBD</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_entry_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_auth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SetICVFinish</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef MG_SET_ICV_SLOW</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TPC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">PRO_WRITE_LONG_DATA</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANS_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">RING_BUFFER</span><span class="p">);</span>

		<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="n">MS_TRANSFER_START</span> <span class="o">|</span>  <span class="n">MS_TM_NORMAL_WRITE</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">MS_TRANSFER</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">,</span> <span class="n">MS_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_auth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SetICVFinish</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_TM_AUTO_WRITE</span><span class="p">,</span> <span class="n">PRO_WRITE_LONG_DATA</span><span class="p">,</span>
				<span class="mi">2</span><span class="p">,</span> <span class="n">WAIT_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="n">check_ms_err</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_clear_ms_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_auth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SetICVFinish</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="nl">SetICVFinish:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* SUPPORT_MAGIC_GATE */</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">ms_cleanup_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;MS Pro: stop transmission</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mspro_stop_seq_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSHG</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CFG</span><span class="p">,</span>
				<span class="n">MS_2K_SECTOR_MODE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef MS_DELAY_WRITE</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">.</span><span class="n">delay_write_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;MS: delay write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ms_delay_write</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ms_power_off_card3v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">disable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_pull_ctl_disable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span>
			<span class="n">FPGA_MS_PULL_CTL_BIT</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">FPGA_MS_PULL_CTL_BIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">MS_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">release_ms_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;release_ms_card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef MS_DELAY_WRITE</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">.</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">pro_under_formatting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_CARD</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_CARD</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_CARD</span><span class="p">;</span>

	<span class="n">ms_free_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">96</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_model_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
