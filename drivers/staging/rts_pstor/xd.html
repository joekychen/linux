<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rts_pstor › xd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek PCI-Express card reader</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;rtsx.h&quot;</span>
<span class="cp">#include &quot;rtsx_transport.h&quot;</span>
<span class="cp">#include &quot;rtsx_scsi.h&quot;</span>
<span class="cp">#include &quot;rtsx_card.h&quot;</span>
<span class="cp">#include &quot;xd.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xd_build_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zone_no</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xd_init_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">logoff</span><span class="p">,</span> <span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">xd_set_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>

	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">xd_check_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">==</span> <span class="n">err_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_set_init_para</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">xd_clock</span> <span class="o">=</span> <span class="mi">47</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">xd_clock</span> <span class="o">=</span> <span class="n">CLK_50</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">xd_clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_switch_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">xd_clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_read_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id_cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">id_buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">id_cmd</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_READ_ID</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">XD_ADDRESS1</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id_buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">buf_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">id_buf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_assign_phy_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XD_RW_ADDR</span>:
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_ADDRESS0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_ADDRESS1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_ADDRESS2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_ADDRESS3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">|</span> <span class="n">XD_CALC_ECC</span> <span class="o">|</span> <span class="n">XD_BA_NO_TRANSFORM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">XD_ERASE_ADDR</span>:
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_ADDRESS0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_ADDRESS1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_ADDRESS2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CFG</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">XD_CALC_ECC</span> <span class="o">|</span> <span class="n">XD_BA_NO_TRANSFORM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_read_redundant</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_READ_REDUNDANT</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">XD_PAGE_STATUS</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">XD_RESERVED0</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">XD_PARITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">buf_len</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_read_data_from_ppb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">),</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_read_cis</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CHK_DATA_STATUS</span><span class="p">,</span> <span class="n">XD_AUTO_CHK_DATA_STATUS</span><span class="p">,</span> <span class="n">XD_AUTO_CHK_DATA_STATUS</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_READ_PAGES</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PAGE_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">XD_GPG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">XD_ECC1_ERROR</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">XD_ECC1_UNCORRECTABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_data_from_ppb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">XD_ECC1_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">ecc_bit</span><span class="p">,</span> <span class="n">ecc_byte</span><span class="p">;</span>

			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_ECC_BIT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_bit</span><span class="p">);</span>
			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_ECC_BYTE1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_byte</span><span class="p">);</span>

			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ECC_BIT1 = 0x%x, ECC_BYTE1 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ecc_bit</span><span class="p">,</span> <span class="n">ecc_byte</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ecc_byte</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Before correct: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ecc_byte</span><span class="p">]);</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">ecc_byte</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ecc_bit</span><span class="p">);</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;After correct: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ecc_byte</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">XD_ECC2_ERROR</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">XD_ECC2_UNCORRECTABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_data_from_ppb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">XD_ECC2_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">ecc_bit</span><span class="p">,</span> <span class="n">ecc_byte</span><span class="p">;</span>

			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_ECC_BIT2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_bit</span><span class="p">);</span>
			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_ECC_BYTE2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_byte</span><span class="p">);</span>

			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ECC_BIT2 = 0x%x, ECC_BYTE2 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ecc_bit</span><span class="p">,</span> <span class="n">ecc_byte</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ecc_byte</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Before correct: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ecc_byte</span><span class="p">]);</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">ecc_byte</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ecc_bit</span><span class="p">);</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;After correct: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ecc_byte</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_fill_pull_ctl_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D3_PD</span> <span class="o">|</span> <span class="n">XD_D2_PD</span> <span class="o">|</span> <span class="n">XD_D1_PD</span> <span class="o">|</span> <span class="n">XD_D0_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D7_PD</span> <span class="o">|</span> <span class="n">XD_D6_PD</span> <span class="o">|</span> <span class="n">XD_D5_PD</span> <span class="o">|</span> <span class="n">XD_D4_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_WP_PD</span> <span class="o">|</span> <span class="n">XD_CE_PD</span> <span class="o">|</span> <span class="n">XD_CLE_PD</span> <span class="o">|</span> <span class="n">XD_CD_PU</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_RDY_PD</span> <span class="o">|</span> <span class="n">XD_WE_PD</span> <span class="o">|</span> <span class="n">XD_RE_PD</span> <span class="o">|</span> <span class="n">XD_ALE_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PD</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_D5_PD</span> <span class="o">|</span> <span class="n">MS_D4_PD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_fill_pull_ctl_stage1_barossa</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_fill_pull_ctl_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D3_PD</span> <span class="o">|</span> <span class="n">XD_D2_PD</span> <span class="o">|</span> <span class="n">XD_D1_PD</span> <span class="o">|</span> <span class="n">XD_D0_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D7_PD</span> <span class="o">|</span> <span class="n">XD_D6_PD</span> <span class="o">|</span> <span class="n">XD_D5_PD</span> <span class="o">|</span> <span class="n">XD_D4_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_WP_PD</span> <span class="o">|</span> <span class="n">XD_CE_PU</span> <span class="o">|</span> <span class="n">XD_CLE_PD</span> <span class="o">|</span> <span class="n">XD_CD_PU</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_RDY_PU</span> <span class="o">|</span> <span class="n">XD_WE_PU</span> <span class="o">|</span> <span class="n">XD_RE_PU</span> <span class="o">|</span> <span class="n">XD_ALE_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PD</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_D5_PD</span> <span class="o">|</span> <span class="n">MS_D4_PD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_pull_ctl_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D3_PD</span> <span class="o">|</span> <span class="n">XD_D2_PD</span> <span class="o">|</span> <span class="n">XD_D1_PD</span> <span class="o">|</span> <span class="n">XD_D0_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D7_PD</span> <span class="o">|</span> <span class="n">XD_D6_PD</span> <span class="o">|</span> <span class="n">XD_D5_PD</span> <span class="o">|</span> <span class="n">XD_D4_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_WP_PD</span> <span class="o">|</span> <span class="n">XD_CE_PD</span> <span class="o">|</span> <span class="n">XD_CLE_PD</span> <span class="o">|</span> <span class="n">XD_CD_PU</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_RDY_PD</span> <span class="o">|</span> <span class="n">XD_WE_PD</span> <span class="o">|</span> <span class="n">XD_RE_PD</span> <span class="o">|</span> <span class="n">XD_ALE_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PD</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_D5_PD</span> <span class="o">|</span> <span class="n">MS_D4_PD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_clear_dma_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xD ECC error, dummy write!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_SELECT</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">SD_MOD_SEL</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_CLK_EN</span><span class="p">,</span> <span class="n">SD_CLK_EN</span><span class="p">,</span> <span class="n">SD_CLK_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span>
					<span class="n">FPGA_SD_PULL_CTL_BIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">RING_BUFFER</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_TM_AUTO_WRITE_3</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_STAT1: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STAT2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_STAT2: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_BUS_STAT: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_STOP</span><span class="p">,</span> <span class="n">SD_STOP</span> <span class="o">|</span> <span class="n">SD_CLR_ERR</span><span class="p">,</span> <span class="n">SD_STOP</span> <span class="o">|</span> <span class="n">SD_CLR_ERR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span>
						<span class="n">FPGA_SD_PULL_CTL_BIT</span><span class="p">,</span> <span class="n">FPGA_SD_PULL_CTL_BIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_SELECT</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">XD_MOD_SEL</span><span class="p">);</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_CLK_EN</span><span class="p">,</span> <span class="n">SD_CLK_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_xd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">redunt</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CHK_DATA_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_PGSTS_NOT_FF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span>
			<span class="n">xd_fill_pull_ctl_disable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">xd_fill_pull_ctl_stage1_barossa</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="p">(</span><span class="n">FPGA_XD_PULL_CTL_EN1</span> <span class="o">&amp;</span> <span class="n">FPGA_XD_PULL_CTL_EN3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_INIT</span><span class="p">,</span> <span class="n">XD_NO_AUTO_PWR_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">XD_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xd_fill_pull_ctl_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="p">(</span><span class="n">FPGA_XD_PULL_CTL_EN1</span> <span class="o">&amp;</span> <span class="n">FPGA_XD_PULL_CTL_EN2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_OC_NOW</span> <span class="o">|</span> <span class="n">SD_OC_EVER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Over current, OCPSTAT is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xd_fill_pull_ctl_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="p">(</span><span class="n">FPGA_XD_PULL_CTL_EN1</span> <span class="o">&amp;</span> <span class="n">FPGA_XD_PULL_CTL_EN2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">XD_OUTPUT_EN</span><span class="p">,</span> <span class="n">XD_OUTPUT_EN</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CTL</span><span class="p">,</span> <span class="n">XD_CE_DISEN</span><span class="p">,</span> <span class="n">XD_CE_DISEN</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="cm">/* Read ID to check if the timing setting is right */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_DTCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="n">XD_TIME_SETUP_STEP</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">XD_TIME_RW_STEP</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">XD_TIME_RWN_STEP</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CATCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="n">XD_TIME_SETUP_STEP</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">XD_TIME_RW_STEP</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">XD_TIME_RWN_STEP</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_RESET</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">XD_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;XD_DAT: 0x%x, XD_CTL: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">READY_FLAG</span><span class="p">)</span> <span class="o">!=</span> <span class="n">READY_STATE</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_RDY</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_id</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_ID</span><span class="p">,</span> <span class="n">id_buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;READ_ID: 0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">id_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">device_code</span> <span class="o">=</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="cm">/* Check if the xD card is supported */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">device_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">XD_4M_X8_512_1</span>:
		<span class="k">case</span> <span class="n">XD_4M_X8_512_2</span>:
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
			<span class="n">XD_SET_4MB</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XD_8M_X8_512</span>:
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XD_16M_X8_512</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XD_32M_X8_512</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XD_64M_X8_512</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XD_128M_X8_512</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">256000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XD_256M_X8_512</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">512000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XD_512M_X8</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">1024000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">xD_1G_X8_512</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">2048000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">xD_2G_X8_512</span>:
			<span class="n">XD_PAGE_512</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">4096000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Confirm timing setting */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_id</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_ID</span><span class="p">,</span> <span class="n">id_buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">id_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">device_code</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_id</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_xD_ID</span><span class="p">,</span> <span class="n">id_buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;READ_xD_ID: 0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">id_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">id_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">XD_ID_CODE</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="cm">/* Search CIS block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">page_addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

		<span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_redundant</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">redunt</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_STATUS</span><span class="p">]</span> <span class="o">!=</span> <span class="n">XD_GBLK</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PAGE_STATUS</span><span class="p">]</span> <span class="o">!=</span> <span class="n">XD_GPG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_redundant</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">redunt</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PAGE_STATUS</span><span class="p">]</span> <span class="o">==</span> <span class="n">XD_GPG</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check CIS data */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_STATUS</span><span class="p">]</span> <span class="o">==</span> <span class="n">XD_GBLK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PARITY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_BA1_ALL0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

			<span class="n">page_addr</span> <span class="o">+=</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_cis</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xD9</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xDF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cis_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;CIS block: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cis_block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cis_block</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">XD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_check_data_blank</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">redunt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PAGE_STATUS</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">redunt</span><span class="p">[</span><span class="n">PARITY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XD_ECC1_ALL1</span> <span class="o">|</span> <span class="n">XD_ECC2_ALL1</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">XD_ECC1_ALL1</span> <span class="o">|</span> <span class="n">XD_ECC2_ALL1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">RESERVED0</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">xd_load_log_block_addr</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">redunt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PARITY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_BA1_BA2_EQL</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_ADDR1_H</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_ADDR1_L</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PARITY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_BA1_VALID</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_ADDR1_H</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_ADDR1_L</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PARITY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_BA2_VALID</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_ADDR2_H</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_ADDR2_L</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_init_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xd_init_l2p_tbl: zone_cnt = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone_entry</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Buffer size for l2p table is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">build_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">unused_blk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">free_zone</span><span class="p">(</span><span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">zone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;free_zone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zone</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">build_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_set_unused_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zone_no</span><span class="p">;</span>

	<span class="n">zone_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">phy_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone_no</span> <span class="o">&gt;=</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Set unused block to invalid zone (zone_no = %d, zone_cnt = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">zone_no</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">zone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_build_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">&gt;=</span> <span class="n">XD_FREE_TABLE_CNT</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Set unused block fail, invalid set_index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Set unused block to index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="p">);</span>

	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">[</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">&gt;=</span> <span class="n">XD_FREE_TABLE_CNT</span><span class="p">)</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">xd_get_unused_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zone_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zone_no</span> <span class="o">&gt;=</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Get unused block from invalid zone (zone_no = %d, zone_cnt = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">zone_no</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BLK_NOT_FOUND</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">zone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">==</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Get unused block fail, no unused block available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BLK_NOT_FOUND</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">&gt;=</span> <span class="n">XD_FREE_TABLE_CNT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Get unused block fail, invalid get_index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BLK_NOT_FOUND</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Get unused block from index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span><span class="p">);</span>

	<span class="n">phy_blk</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">[</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span><span class="p">];</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">[</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">&gt;=</span> <span class="n">XD_FREE_TABLE_CNT</span><span class="p">)</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="n">phy_blk</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">zone_no</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">phy_blk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xd_set_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">u16</span> <span class="n">log_off</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phy_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>

	<span class="n">zone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">]);</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">xd_get_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">u16</span> <span class="n">log_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">zone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">phy_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef XD_DELAY_WRITE</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_delay_write</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;In xd_get_l2p_tbl, delay write fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BLK_NOT_FOUND</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No unused block!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BLK_NOT_FOUND</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_blk</span> <span class="o">=</span> <span class="n">xd_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No unused block available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">BLK_NOT_FOUND</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_init_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">log_off</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No good unused block available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BLK_NOT_FOUND</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xd_set_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">log_off</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">phy_blk</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">phy_blk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">log_off</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">zone_no</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">reset_xd_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">xd_card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xd_info</span><span class="p">));</span>

	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">addr_cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cis_block</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">.</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">enable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_xd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_init_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_mark_bad_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">page_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;mark block 0x%x as bad block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_GPG</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_LATER_BBLK</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR1_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR1_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR2_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR2_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_RESERVED0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_RESERVED1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_RESERVED2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_RESERVED3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="n">page_addr</span> <span class="o">=</span> <span class="n">phy_blk</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>

	<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_WRITE_REDUNDANT</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PROGRAM_ERROR</span><span class="p">)</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PRG_ERROR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_TO_ERROR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_init_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">u16</span> <span class="n">logoff</span><span class="p">,</span> <span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">page_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Init block 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_page</span> <span class="o">&gt;</span> <span class="n">end_page</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR1_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">logoff</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR1_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">logoff</span><span class="p">);</span>

	<span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_page</span><span class="p">;</span>

	<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CFG</span><span class="p">,</span> <span class="n">XD_BA_TRANSFORM</span><span class="p">,</span> <span class="n">XD_BA_TRANSFORM</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">end_page</span> <span class="o">-</span> <span class="n">start_page</span><span class="p">));</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_WRITE_REDUNDANT</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PROGRAM_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PRG_ERROR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_TO_ERROR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_copy_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">old_page</span><span class="p">,</span> <span class="n">new_page</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Copy page from block 0x%x to block 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_page</span> <span class="o">&gt;</span> <span class="n">end_page</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">old_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">))</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">old_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_blk</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_page</span><span class="p">;</span>
	<span class="n">new_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_page</span><span class="p">;</span>

	<span class="n">XD_CLR_BAD_NEWBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end_page</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_page</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CHK_DATA_STATUS</span><span class="p">,</span> <span class="n">XD_AUTO_CHK_DATA_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_READ_PAGES</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XD_ECC1_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC2_ERROR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_NO_CARD</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XD_ECC1_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC1_UNCORRECTABLE</span><span class="p">))</span> <span class="o">==</span>
						<span class="p">(</span><span class="n">XD_ECC1_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC1_UNCORRECTABLE</span><span class="p">))</span>
					<span class="o">||</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XD_ECC2_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC2_UNCORRECTABLE</span><span class="p">))</span> <span class="o">==</span>
						<span class="p">(</span><span class="n">XD_ECC2_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC2_UNCORRECTABLE</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PAGE_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_BPG</span><span class="p">);</span>
					<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_BLOCK_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_GBLK</span><span class="p">);</span>
					<span class="n">XD_SET_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
					<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;old block 0x%x ecc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_TO_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">XD_CHK_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">))</span>
			<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_page</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			     <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_WRITE_PAGES</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PROGRAM_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
				<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PRG_ERROR</span><span class="p">);</span>
				<span class="n">XD_SET_BAD_NEWBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_TO_ERROR</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">old_page</span><span class="o">++</span><span class="p">;</span>
		<span class="n">new_page</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_reset_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_RESET</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">XD_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">READY_FLAG</span><span class="p">)</span> <span class="o">==</span> <span class="n">READY_STATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_RDY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_erase_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">page_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">page_addr</span> <span class="o">=</span> <span class="n">phy_blk</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">XD_ERASE_ADDR</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_ERASE</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PROGRAM_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
				<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PRG_ERROR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_ERASE_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_reset_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="n">PROGRAM_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PRG_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
	<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_ERASE_FAIL</span><span class="p">);</span>
	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_build_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zone_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">max_logoff</span><span class="p">,</span> <span class="n">cur_fst_page_logoff</span><span class="p">,</span> <span class="n">cur_lst_page_logoff</span><span class="p">,</span> <span class="n">ent_lst_page_logoff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">redunt</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xd_build_l2p_tbl: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_init_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">].</span><span class="n">build_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;l2p table of zone %d has been built</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">zone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Build_Fail</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">XD_FREE_TABLE_CNT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Build_Fail</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">XD_FREE_TABLE_CNT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zone_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cis_block</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cis_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XD_CHK_4MB</span><span class="p">(</span><span class="n">xd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">end</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
			<span class="n">max_logoff</span> <span class="o">=</span> <span class="mi">499</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">end</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
			<span class="n">max_logoff</span> <span class="o">=</span> <span class="mi">999</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">zone_no</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">zone_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">max_logoff</span> <span class="o">=</span> <span class="mi">999</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;start block 0x%x, end block 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">set_index</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">get_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">page_addr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">phy_block</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_redundant</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">redunt</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">BLOCK_STATUS</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;bad block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xd_check_data_blank</span><span class="p">(</span><span class="n">redunt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;blank block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cur_fst_page_logoff</span> <span class="o">=</span> <span class="n">xd_load_log_block_addr</span><span class="p">(</span><span class="n">redunt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur_fst_page_logoff</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cur_fst_page_logoff</span> <span class="o">&gt;</span> <span class="n">max_logoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">zone_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_fst_page_logoff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">redunt</span><span class="p">[</span><span class="n">PAGE_STATUS</span><span class="p">]</span> <span class="o">!=</span> <span class="n">XD_GPG</span><span class="p">))</span>
			<span class="n">XD_SET_MBR_FAIL</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">cur_fst_page_logoff</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">cur_fst_page_logoff</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">phy_block</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">cur_fst_page_logoff</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">zone_no</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>

		<span class="n">page_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_redundant</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">redunt</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cur_lst_page_logoff</span> <span class="o">=</span> <span class="n">xd_load_log_block_addr</span><span class="p">(</span><span class="n">redunt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_lst_page_logoff</span> <span class="o">==</span> <span class="n">cur_fst_page_logoff</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

			<span class="n">page_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_redundant</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">redunt</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">cur_fst_page_logoff</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_block</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_block</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ent_lst_page_logoff</span> <span class="o">=</span> <span class="n">xd_load_log_block_addr</span><span class="p">(</span><span class="n">redunt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ent_lst_page_logoff</span> <span class="o">!=</span> <span class="n">cur_fst_page_logoff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">cur_fst_page_logoff</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_block</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_block</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XD_CHK_4MB</span><span class="p">(</span><span class="n">xd_card</span><span class="p">))</span>
		<span class="n">end</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">end</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">start</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Block count %d, invalid L2P entry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Total unused block: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">unused_blk_cnt</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>

	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">build_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="nl">Build_Fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span><span class="p">);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span><span class="p">);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">free_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_SET_CMD</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_read_multiple_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_blk</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">log_off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">page_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_page</span> <span class="o">&gt;</span> <span class="n">end_page</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">page_cnt</span> <span class="o">=</span> <span class="n">end_page</span> <span class="o">-</span> <span class="n">start_page</span><span class="p">;</span>
	<span class="n">zone_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">log_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phy_blk</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3FF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_redundant</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_NO_CARD</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_blk</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_page</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CFG</span><span class="p">,</span> <span class="n">XD_PPB_TO_SIE</span><span class="p">,</span> <span class="n">XD_PPB_TO_SIE</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">RING_BUFFER</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">page_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CHK_DATA_STATUS</span><span class="p">,</span>
			<span class="n">XD_AUTO_CHK_DATA_STATUS</span><span class="p">,</span> <span class="n">XD_AUTO_CHK_DATA_STATUS</span><span class="p">);</span>

	<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">page_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_READ_PAGES</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span>
		     <span class="n">XD_TRANSFER_END</span> <span class="o">|</span> <span class="n">XD_PPB_EMPTY</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span> <span class="o">|</span> <span class="n">XD_PPB_EMPTY</span><span class="p">);</span>

	<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data_partial</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">page_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">),</span>
			<span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">xd_clear_dma_buffer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_TO_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Fail</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="nl">Fail:</span>
	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PAGE_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">!=</span>  <span class="n">XD_GPG</span><span class="p">)</span>
		<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PRG_ERROR</span><span class="p">);</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XD_ECC1_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC1_UNCORRECTABLE</span><span class="p">))</span>
				<span class="o">==</span> <span class="p">(</span><span class="n">XD_ECC1_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC1_UNCORRECTABLE</span><span class="p">))</span>
		<span class="o">||</span> <span class="p">((</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XD_ECC2_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC2_UNCORRECTABLE</span><span class="p">))</span>
			<span class="o">==</span> <span class="p">(</span><span class="n">XD_ECC2_ERROR</span> <span class="o">|</span> <span class="n">XD_ECC2_UNCORRECTABLE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_ECC_ERROR</span><span class="p">);</span>

		<span class="n">new_blk</span> <span class="o">=</span> <span class="n">xd_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">==</span> <span class="n">NO_NEW_BLK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XD_CLR_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XD_CHK_BAD_NEWBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">XD_CLR_BAD_NEWBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">XD_CLR_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">xd_set_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">log_off</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">new_blk</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">));</span>
		<span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
		<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">);</span>
		<span class="n">XD_CLR_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_finish_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">log_off</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xd_finish_write, old_blk = 0x%x, new_blk = 0x%x, log_blk = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_off</span> <span class="o">&gt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">zone_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">log_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_init_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_off</span><span class="p">,</span>
				<span class="n">page_off</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span>
				<span class="n">page_off</span><span class="p">,</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XD_CHK_BAD_NEWBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">XD_CLR_BAD_NEWBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">XD_CHK_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
				<span class="n">XD_CLR_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_NO_ERROR</span><span class="p">);</span>
			<span class="n">XD_CLR_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">xd_set_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">log_off</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">new_blk</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_prepare_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s, old_blk = 0x%x, new_blk = 0x%x, log_blk = 0x%x, page_off = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">page_off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">xd_write_multiple_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_blk</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">u8</span> <span class="n">end_page</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">page_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">log_off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">page_cnt</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s, old_blk = 0x%x, new_blk = 0x%x, log_blk = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_page</span> <span class="o">&gt;</span> <span class="n">end_page</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">page_cnt</span> <span class="o">=</span> <span class="n">end_page</span> <span class="o">-</span> <span class="n">start_page</span><span class="p">;</span>
	<span class="n">zone_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">log_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">page_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">&lt;&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_page</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ1_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR1_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">log_off</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_ADDR1_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">log_off</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_BLOCK_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_GBLK</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_STATUS</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_GPG</span><span class="p">);</span>

	<span class="n">xd_assign_phy_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">page_addr</span><span class="p">,</span> <span class="n">XD_RW_ADDR</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_CFG</span><span class="p">,</span> <span class="n">XD_BA_TRANSFORM</span><span class="p">,</span> <span class="n">XD_BA_TRANSFORM</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_PAGE_CNT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">page_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">RING_BUFFER</span><span class="p">);</span>

	<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">page_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">XD_TRANSFER_START</span> <span class="o">|</span> <span class="n">XD_WRITE_PAGES</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">XD_TRANSFER</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">,</span> <span class="n">XD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data_partial</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">page_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">),</span>
			<span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_xd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_TO_ERROR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Fail</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end_page</span> <span class="o">==</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">.</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old_blk</span> <span class="o">!=</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_erase_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">XD_CHK_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
					<span class="n">XD_CLR_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">xd_set_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_NO_ERROR</span><span class="p">);</span>
				<span class="n">XD_CLR_BAD_OLDBLK</span><span class="p">(</span><span class="n">xd_card</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">xd_set_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">log_off</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">new_blk</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="nl">Fail:</span>
	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_DAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">PROGRAM_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_PRG_ERROR</span><span class="p">);</span>
		<span class="n">xd_mark_bad_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef XD_DELAY_WRITE</span>
<span class="kt">int</span> <span class="nf">xd_delay_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xd_delay_write_tag</span> <span class="o">*</span><span class="n">delay_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xd_delay_write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

		<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_finish_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
				<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">,</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">,</span>
				<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span><span class="p">,</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">xd_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sector_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
<span class="cp">#ifdef XD_DELAY_WRITE</span>
	<span class="k">struct</span> <span class="n">xd_delay_write_tag</span> <span class="o">*</span><span class="n">delay_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">old_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">log_off</span><span class="p">,</span> <span class="n">total_sec_cnt</span> <span class="o">=</span> <span class="n">sector_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">xd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_NO_ERROR</span><span class="p">);</span>

	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xd_rw: scsi_sg_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">log_blk</span> <span class="o">=</span> <span class="n">start_sector</span> <span class="o">&gt;&gt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">block_shift</span><span class="p">;</span>
	<span class="n">start_page</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">start_sector</span> <span class="o">&amp;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span><span class="p">;</span>
	<span class="n">zone_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">log_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">].</span><span class="n">build_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_build_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef XD_DELAY_WRITE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span> <span class="o">==</span> <span class="n">log_blk</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">start_page</span> <span class="o">&gt;</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span> <span class="o">!=</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_copy_page</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
					<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">,</span>
					<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">,</span>
					<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">,</span> <span class="n">start_page</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">old_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">;</span>
			<span class="n">new_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span> <span class="o">==</span> <span class="n">log_blk</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">start_page</span> <span class="o">==</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">old_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span><span class="p">;</span>
			<span class="n">new_blk</span> <span class="o">=</span> <span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_delay_write</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">old_blk</span> <span class="o">=</span> <span class="n">xd_get_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">log_off</span><span class="p">);</span>
			<span class="n">new_blk</span>  <span class="o">=</span> <span class="n">xd_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">old_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_prepare_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">start_page</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#ifdef XD_DELAY_WRITE</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef XD_DELAY_WRITE</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_delay_write</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">old_blk</span> <span class="o">=</span> <span class="n">xd_get_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">log_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;old_blk = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">total_sec_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">start_page</span> <span class="o">+</span> <span class="n">total_sec_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">end_page</span> <span class="o">=</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">end_page</span> <span class="o">=</span> <span class="n">start_page</span> <span class="o">+</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">total_sec_cnt</span><span class="p">;</span>

		<span class="n">page_cnt</span> <span class="o">=</span> <span class="n">end_page</span> <span class="o">-</span> <span class="n">start_page</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_read_multiple_pages</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span>
					<span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_write_multiple_pages</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span>
					<span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">total_sec_cnt</span> <span class="o">-=</span> <span class="n">page_cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">page_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total_sec_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">log_blk</span><span class="o">++</span><span class="p">;</span>
		<span class="n">zone_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">log_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">log_blk</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">zone_no</span><span class="p">].</span><span class="n">build_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_build_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">old_blk</span> <span class="o">=</span> <span class="n">xd_get_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">,</span> <span class="n">log_off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_blk</span> <span class="o">=</span> <span class="n">xd_get_unused_block</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">zone_no</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_blk</span> <span class="o">==</span> <span class="n">BLK_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">start_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">end_page</span> <span class="o">!=</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">page_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef XD_DELAY_WRITE</span>
		<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">old_phyblock</span> <span class="o">=</span> <span class="n">old_blk</span><span class="p">;</span>
		<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">new_phyblock</span> <span class="o">=</span> <span class="n">new_blk</span><span class="p">;</span>
		<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">logblock</span> <span class="o">=</span> <span class="n">log_blk</span><span class="p">;</span>
		<span class="n">delay_write</span><span class="o">-&gt;</span><span class="n">pageoff</span> <span class="o">=</span> <span class="n">end_page</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_finish_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">old_blk</span><span class="p">,</span> <span class="n">new_blk</span><span class="p">,</span> <span class="n">log_blk</span><span class="p">,</span> <span class="n">end_page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">xd_free_l2p_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span><span class="p">);</span>
				<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l2p_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span><span class="p">);</span>
				<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">free_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">);</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">zone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">xd_cleanup_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef XD_DELAY_WRITE</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">.</span><span class="n">delay_write_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;xD: delay write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xd_delay_write</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">xd_power_off_card3v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">disable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">XD_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">XD_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_pull_ctl_disable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">release_xd_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;release_xd_card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XD_CARD</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XD_CARD</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XD_CARD</span><span class="p">;</span>

	<span class="n">xd_card</span><span class="o">-&gt;</span><span class="n">delay_write</span><span class="p">.</span><span class="n">delay_write_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xd_free_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">xd_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
