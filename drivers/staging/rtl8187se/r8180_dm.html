<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › r8180_dm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>r8180_dm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;r8180_dm.h&quot;</span>
<span class="cp">#include &quot;r8180_hw.h&quot;</span>
<span class="cp">#include &quot;r8180_93cx6.h&quot;</span>

 <span class="cm">/*	Return TRUE if we shall perform High Power Mechanism, FALSE otherwise. */</span>
<span class="cp">#define RATE_ADAPTIVE_TIMER_PERIOD      300</span>

<span class="n">bool</span> <span class="nf">CheckHighPower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bRegHighPowerMechanism</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED_SCANNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *		Update Tx power level if necessary.</span>
<span class="cm"> *		See also DoRxHighPower() and SetTxPowerLevel8185() for reference.</span>
<span class="cm"> *</span>
<span class="cm"> *	Note:</span>
<span class="cm"> *		The reason why we udpate Tx power level here instead of DoRxHighPower()</span>
<span class="cm"> *		is the number of IO to change Tx power is much more than channel TR switch</span>
<span class="cm"> *		and they are related to OFDM and MAC registers.</span>
<span class="cm"> *		So, we don&#39;t want to update it so frequently in per-Rx packet base.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">DoTxHighPower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>			<span class="n">HiPwrUpperTh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">HiPwrLowerTh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">RSSIHiPwrUpperTh</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">RSSIHiPwrLowerTh</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">u1bTmp</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">OfdmTxPwrIdx</span><span class="p">,</span> <span class="n">CckTxPwrIdx</span><span class="p">;</span>

	<span class="n">HiPwrUpperTh</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegHiPwrUpperTh</span><span class="p">;</span>
	<span class="n">HiPwrLowerTh</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegHiPwrLowerTh</span><span class="p">;</span>

	<span class="n">HiPwrUpperTh</span> <span class="o">=</span> <span class="n">HiPwrUpperTh</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">HiPwrLowerTh</span> <span class="o">=</span> <span class="n">HiPwrLowerTh</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">RSSIHiPwrUpperTh</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegRSSIHiPwrUpperTh</span><span class="p">;</span>
	<span class="n">RSSIHiPwrLowerTh</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegRSSIHiPwrLowerTh</span><span class="p">;</span>

	<span class="cm">/* lzm add 080826 */</span>
	<span class="n">OfdmTxPwrIdx</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">];</span>
	<span class="n">CckTxPwrIdx</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndecoratedSmoothedSS</span> <span class="o">&gt;</span> <span class="n">HiPwrUpperTh</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bCurCCKPkt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurCCKRSSI</span> <span class="o">&gt;</span> <span class="n">RSSIHiPwrUpperTh</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Stevenl suggested that degrade 8dbm in high power sate. 2007-12-04 Isaiah */</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bToUpdateTxPwr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">u1bTmp</span><span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">);</span>

		<span class="cm">/* If it never enter High Power. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CckTxPwrIdx</span> <span class="o">==</span> <span class="n">u1bTmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u1bTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">-</span><span class="mi">16</span><span class="p">)</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* 8dbm */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">,</span> <span class="n">u1bTmp</span><span class="p">);</span>

			<span class="n">u1bTmp</span><span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">);</span>
			<span class="n">u1bTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">-</span><span class="mi">16</span><span class="p">)</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* 8dbm */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="n">u1bTmp</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndecoratedSmoothedSS</span> <span class="o">&lt;</span> <span class="n">HiPwrLowerTh</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bCurCCKPkt</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurCCKRSSI</span> <span class="o">&lt;</span> <span class="n">RSSIHiPwrLowerTh</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bToUpdateTxPwr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bToUpdateTxPwr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="cm">/* SD3 required. */</span>
			<span class="n">u1bTmp</span><span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">&lt;</span> <span class="n">CckTxPwrIdx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">,</span> <span class="n">CckTxPwrIdx</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">u1bTmp</span><span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">&lt;</span> <span class="n">OfdmTxPwrIdx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="n">OfdmTxPwrIdx</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *		Callback function of UpdateTxPowerWorkItem.</span>
<span class="cm"> *		Because of some event happened, e.g. CCX TPC, High Power Mechanism,</span>
<span class="cm"> *		We update Tx power of current channel again.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtl8180_tx_pw_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span><span class="n">tx_pw_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">DoTxHighPower</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	Return TRUE if we shall perform DIG Mechanism, FALSE otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">CheckDig</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDigMechanism</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">)</span> <span class="cm">/* Schedule Dig under all OFDM rates. By Bruce, 2007-06-01. */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	Implementation of DIG for Zebra and Zebra2.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">DIG_Zebra</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span>			<span class="n">CCKFalseAlarm</span><span class="p">,</span> <span class="n">OFDMFalseAlarm</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">OfdmFA1</span><span class="p">,</span> <span class="n">OfdmFA2</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">InitialGainStep</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* The number of initial gain stages. */</span>
	<span class="kt">int</span>			<span class="n">LowestGainStage</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* The capable lowest stage of performing dig workitem. */</span>
	<span class="n">u32</span>			<span class="n">AwakePeriodIn2Sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CCKFalseAlarm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FalseAlarmRegValue</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="n">OFDMFalseAlarm</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FalseAlarmRegValue</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="n">OfdmFA1</span> <span class="o">=</span>  <span class="mh">0x15</span><span class="p">;</span>
	<span class="n">OfdmFA2</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegDigOfdmFaUpTh</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* The number of initial gain steps is different, by Bruce, 2007-04-13. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* autoDIG */</span>
		<span class="cm">/* Advised from SD3 DZ */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* In 87B, m74dBm means State 4 (m82dBm) */</span>
	<span class="p">}</span>
	<span class="cm">/* Advised from SD3 DZ */</span>
	<span class="n">OfdmFA1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

<span class="cp">#if 1 </span><span class="cm">/* lzm reserved 080826 */</span><span class="cp"></span>
	<span class="n">AwakePeriodIn2Sec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2000</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">DozePeriodInPast2Sec</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">-&gt;</span><span class="n">DozePeriodInPast2Sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AwakePeriodIn2Sec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OfdmFA1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">OfdmFA1</span> <span class="o">*</span> <span class="n">AwakePeriodIn2Sec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">OfdmFA2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">OfdmFA2</span> <span class="o">*</span> <span class="n">AwakePeriodIn2Sec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">InitialGainStep</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">LowestGainStage</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegBModeGainStage</span><span class="p">;</span> <span class="cm">/* Lowest gain stage. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OFDMFalseAlarm</span> <span class="o">&gt;</span> <span class="n">OfdmFA1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">OFDMFalseAlarm</span> <span class="o">&gt;</span> <span class="n">OfdmFA2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* serious OFDM  False Alarm, need fallback */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">&lt;</span> <span class="n">InitialGainStep</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGainBackUp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">;</span>

					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">UpdateInitialGain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberUpgradeVote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberUpgradeVote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span><span class="o">--</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberUpgradeVote</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberUpgradeVote</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">&gt;</span> <span class="n">LowestGainStage</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* In 87B, m78dBm means State 4 (m864dBm) */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGainBackUp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">;</span>

				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">UpdateInitialGain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberUpgradeVote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Dispatch DIG implementation according to RF.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">DynamicInitGain</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIG_Zebra</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_hw_dig_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span><span class="n">hw_dig_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Read CCK and OFDM False Alarm. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FalseAlarmRegValue</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_FALSE_ALARM</span><span class="p">);</span>


	<span class="cm">/* Adjust Initial Gain dynamically. */</span>
	<span class="n">DynamicInitGain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">IncludedInSupportedRates</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">TxRate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rate_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate_ex_len</span><span class="p">;</span>
	<span class="n">u8</span>                      <span class="n">RateMask</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">u8</span>                      <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>          <span class="n">Found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>                      <span class="n">NaiveTxRate</span> <span class="o">=</span> <span class="n">TxRate</span><span class="o">&amp;</span><span class="n">RateMask</span><span class="p">;</span>

	<span class="n">rate_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span><span class="p">;</span>
	<span class="n">rate_ex_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex_len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">rate_len</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RateMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">NaiveTxRate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found_rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">rate_ex_len</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RateMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">NaiveTxRate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found_rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">Found</span><span class="p">;</span>
	<span class="nl">found_rate:</span>
	<span class="k">return</span> <span class="n">Found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Get the Tx rate one degree up form the input rate in the supported rates.</span>
<span class="cm"> *	Return the upgrade rate if it is successed, otherwise return the input rate.</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">GetUpgradeTxRate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>                      <span class="n">UpRate</span><span class="p">;</span>

	<span class="cm">/* Upgrade 1 degree. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">108</span>: <span class="cm">/* Up to 54Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">96</span>: <span class="cm">/* Up to 54Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">72</span>: <span class="cm">/* Up to 48Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">48</span>: <span class="cm">/* Up to 36Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">36</span>: <span class="cm">/* Up to 24Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">22</span>: <span class="cm">/* Up to 18Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* Up to 11Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* Up to 5.5Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* Up to 2Mbps. */</span>
		<span class="n">UpRate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetUpgradeTxRate(): Input Tx Rate(%d) is undefined!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check if the rate is valid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IncludedInSupportedRates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">UpRate</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">UpRate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	Get the Tx rate one degree down form the input rate in the supported rates.</span>
<span class="cm"> *	Return the degrade rate if it is successed, otherwise return the input rate.</span>
<span class="cm"> */</span>

<span class="n">u8</span> <span class="nf">GetDegradeTxRate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>                      <span class="n">DownRate</span><span class="p">;</span>

	<span class="cm">/* Upgrade 1 degree. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">108</span>: <span class="cm">/* Down to 48Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">96</span>: <span class="cm">/* Down to 36Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">72</span>: <span class="cm">/* Down to 24Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">48</span>: <span class="cm">/* Down to 18Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">36</span>: <span class="cm">/* Down to 11Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">22</span>: <span class="cm">/* Down to 5.5Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* Down to 2Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* Down to 1Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* Down to 1Mbps. */</span>
		<span class="n">DownRate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetDegradeTxRate(): Input Tx Rate(%d) is undefined!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check if the rate is valid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IncludedInSupportedRates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DownRate</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">DownRate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *      Helper function to determine if specified data rate is</span>
<span class="cm"> *      CCK rate.</span>
<span class="cm"> */</span>

<span class="n">bool</span> <span class="nf">MgntIsCckRate</span><span class="p">(</span><span class="n">u16</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">18</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bReturn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bReturn</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *		Tx Power tracking mechanism routine on 87SE.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">TxPwrTracking87SE</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>	<span class="n">tmpu1Byte</span><span class="p">,</span> <span class="n">CurrentThermal</span><span class="p">,</span> <span class="n">Idx</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">CckTxPwrIdx</span><span class="p">,</span> <span class="n">OfdmTxPwrIdx</span><span class="p">;</span>

	<span class="n">tmpu1Byte</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EN_LPF_CAL</span><span class="p">);</span>
	<span class="n">CurrentThermal</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmpu1Byte</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/*[ 7:4]: thermal meter indication. */</span>
	<span class="n">CurrentThermal</span> <span class="o">=</span> <span class="p">(</span><span class="n">CurrentThermal</span> <span class="o">&gt;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0c</span><span class="o">:</span><span class="n">CurrentThermal</span><span class="p">;</span><span class="cm">/* lzm add 080826 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CurrentThermal</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update Tx Power level on each channel. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">Idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">Idx</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">Idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CckTxPwrIdx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">Idx</span><span class="p">];</span>
			<span class="n">OfdmTxPwrIdx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">Idx</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CurrentThermal</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* higher thermal meter. */</span>
				<span class="n">CckTxPwrIdx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">CurrentThermal</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">OfdmTxPwrIdx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">CurrentThermal</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">CckTxPwrIdx</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span>
					<span class="n">CckTxPwrIdx</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span> <span class="cm">/* Force TxPower to maximal index. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">OfdmTxPwrIdx</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span>
					<span class="n">OfdmTxPwrIdx</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* lower thermal meter. */</span>
				<span class="n">CckTxPwrIdx</span> <span class="o">-=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span> <span class="o">-</span> <span class="n">CurrentThermal</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">OfdmTxPwrIdx</span> <span class="o">-=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span> <span class="o">-</span> <span class="n">CurrentThermal</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">CckTxPwrIdx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">CckTxPwrIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">OfdmTxPwrIdx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">OfdmTxPwrIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Update TxPower level on CCK and OFDM resp. */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">Idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">CckTxPwrIdx</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">Idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">OfdmTxPwrIdx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Update TxPower level immediately. */</span>
		<span class="n">rtl8225z2_SetTXPowerLevel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span> <span class="o">=</span> <span class="n">CurrentThermal</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">StaRateAdaptive87SE</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">CurrTxokCnt</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">CurrRetryCnt</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">CurrRetryRate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">CurrRxokCnt</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">TryUpTh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">TryDownTh</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">TxThroughput</span><span class="p">;</span>
	<span class="kt">long</span>		<span class="n">CurrSignalStrength</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">bUpdateInitialGain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">u1bOfdm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u1bCck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">OfdmTxPwrIdx</span><span class="p">,</span> <span class="n">CckTxPwrIdx</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RateAdaptivePeriod</span> <span class="o">=</span> <span class="n">RATE_ADAPTIVE_TIMER_PERIOD</span><span class="p">;</span>


	<span class="n">CurrRetryCnt</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrRetryCnt</span><span class="p">;</span>
	<span class="n">CurrTxokCnt</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkTotal</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxokCnt</span><span class="p">;</span>
	<span class="n">CurrRxokCnt</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxOkTotal</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxokCnt</span><span class="p">;</span>
	<span class="n">CurrSignalStrength</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_RecvSignalPower</span><span class="p">;</span>
	<span class="n">TxThroughput</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkBytesTotal</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxOKBytes</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxOKBytes</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkBytesTotal</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="cm">/* 2 Compute retry ratio. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CurrTxokCnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CurrRetryRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">CurrRetryCnt</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">CurrTxokCnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* It may be serious retry. To distinguish serious retry or no packets modified by Bruce */</span>
		<span class="n">CurrRetryRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">CurrRetryCnt</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryCnt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrRetryCnt</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxokCnt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkTotal</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxokCnt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxOkTotal</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* 2No Tx packets, return to init_rate or not? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CurrRetryRate</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">CurrTxokCnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * After 9 (30*300ms) seconds in this condition, we try to raise rate.</span>
<span class="cm">		 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCountNoData</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* [TRC Dell Lab] Extend raised period from 4.5sec to 9sec, Isaiah 2008-02-15 18:00 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCountNoData</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCountNoData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">=</span> <span class="n">GetUpgradeTxRate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">);</span>
			<span class="cm">/* Reset Fail Record */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRateSS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">200</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">SetInitialGain</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCountNoData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/*Reset trying up times. */</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * For Netgear case, I comment out the following signal strength estimation,</span>
<span class="cm">	 * which can results in lower rate to transmit when sample is NOT enough (e.g. PING request).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Restructure rate adaptive as the following main stages:</span>
<span class="cm">	 * (1) Add retry threshold in 54M upgrading condition with signal strength.</span>
<span class="cm">	 * (2) Add the mechanism to degrade to CCK rate according to signal strength</span>
<span class="cm">	 *		and retry rate.</span>
<span class="cm">	 * (3) Remove all Initial Gain Updates over OFDM rate. To avoid the complicated</span>
<span class="cm">	 *		situation, Initial Gain Update is upon on DIG mechanism except CCK rate.</span>
<span class="cm">	 * (4) Add the mechanism of trying to upgrade tx rate.</span>
<span class="cm">	 * (5) Record the information of upping tx rate to avoid trying upping tx rate constantly.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm"> 	 *  11Mbps or 36Mbps</span>
<span class="cm">	 * Check more times in these rate(key rates).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">22</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">72</span><span class="p">)</span>
		<span class="n">TryUpTh</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Let these rates down more difficult.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MgntIsCckRate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">)</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">36</span><span class="p">)</span>
		<span class="n">TryDownTh</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* 1 Adjust Rate. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTryuping</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2 For Test Upgrading mechanism</span>
<span class="cm">		 * Note:</span>
<span class="cm">		 *	Sometimes the throughput is upon on the capability between the AP and NIC,</span>
<span class="cm">		 *	thus the low data rate does not improve the performance.</span>
<span class="cm">		 *	We randomly upgrade the data rate and check if the retry rate is improved.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Upgrading rate did not improve the retry rate, fallback to the original rate. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">TxThroughput</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxThroughput</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*Not necessary raising rate, fall back rate. */</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTryuping</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">47</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm"> 		 * 2For High Power</span>
<span class="cm">		 *</span>
<span class="cm">		 * Return to highest data rate, if signal strength is good enough.</span>
<span class="cm">		 * SignalStrength threshold(-50dbm) is for RTL8186.</span>
<span class="cm">		 * Revise SignalStrength threshold to -51dbm.</span>
<span class="cm">		 */</span>
		<span class="cm">/* Also need to check retry rate for safety, by Bruce, 2007-06-05. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">HighestOperaRate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Upgrade Tx Rate directly. */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">+=</span> <span class="n">TryUpTh</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrTxokCnt</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span> <span class="n">CurrTxokCnt</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">CurrRetryRate</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *2 For Serious Retry</span>
<span class="cm">		 *</span>
<span class="cm">		 * Traffic is not busy but our Tx retry is serious.</span>
<span class="cm">		 */</span>
		<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Let Rate Mechanism to degrade tx rate directly. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">108</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 54Mbps */</span>
		<span class="cm">/* Air Link */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Cable Link */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">72</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bTryDown</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">75</span><span class="p">))</span> <span class="cm">/* cable link */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">96</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 48Mbps */</span>
		<span class="cm">/* Air Link */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">47</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">74</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Cable Link */</span>
			<span class="cm">/* Down to rate 36Mbps. */</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">+</span> <span class="mi">50</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* TO DO: need to consider (RSSI) */</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bTryDown</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">75</span><span class="p">)){</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">72</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 36Mbps */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">43</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">41</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Down to rate 24Mbps. */</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">+</span> <span class="mi">50</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* TO DO: need to consider (RSSI) */</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bTryDown</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">80</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">48</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 24Mbps */</span>
		<span class="cm">/* Air Link */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">62</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">33</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">82</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Cable Link */</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">+</span> <span class="mi">50</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* TO DO: need to consider (RSSI) */</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bTryDown</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">82</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">36</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">85</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">86</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">+</span> <span class="mi">50</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">+=</span> <span class="n">TryDownTh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">23</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* TO DO: need to consider (RSSI) */</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">22</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 11Mbps */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">95</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/*TO DO: need to consider (RSSI) */</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 5.5Mbps */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">149</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 2 Mbps */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryDown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2For 1 Mbps */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">CurrRetryRate</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">&lt;</span> <span class="mi">75</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bTryUp</span> <span class="o">&amp;&amp;</span> <span class="n">bTryDown</span><span class="p">)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;StaRateAdaptive87B(): Tx Rate tried upping and downing simultaneously!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* 1 Test Upgrading Tx Rate</span>
<span class="cm">	 * Sometimes the cause of the low throughput (high retry rate) is the compatibility between the AP and NIC.</span>
<span class="cm">	 * To test if the upper rate may cause lower retry rate, this mechanism randomly occurs to test upgrading tx rate.</span>
<span class="cm">	 */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bTryUp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bTryDown</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">HighestOperaRate</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">%</span> <span class="p">(</span><span class="n">CurrRetryRate</span> <span class="o">+</span> <span class="mi">101</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bTryUp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTryuping</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* 1 Rate Mechanism */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bTryUp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check more times if we need to upgrade indeed.</span>
<span class="cm">		 * Because the largest value of pHalData-&gt;TryupingCount is 0xFFFF and</span>
<span class="cm">		 * the largest value of pHalData-&gt;FailTxRateCount is 0x14,</span>
<span class="cm">		 * this condition will be satisfied at most every 2 min.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">TryUpTh</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRateSS</span><span class="p">)</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTryuping</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * When transferring from CCK to OFDM, DIG is an important issue.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">22</span><span class="p">)</span>
				<span class="n">bUpdateInitialGain</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/* </span>
<span class="cm">			 * The difference in throughput between 48Mbps and 36Mbps is 8M.</span>
<span class="cm">			 * So, we must be careful in this rate scale. Isaiah 2008-02-15.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">72</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">48</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">36</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RateAdaptivePeriod</span> <span class="o">=</span> <span class="p">(</span><span class="n">RATE_ADAPTIVE_TIMER_PERIOD</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

			<span class="cm">/* (1)To avoid upgrade frequently to the fail tx rate, add the FailTxRateCount into the threshold. */</span>
			<span class="cm">/* (2)If the signal strength is increased, it may be able to upgrade. */</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">=</span> <span class="n">GetUpgradeTxRate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">36</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bUpdateARFR</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARFR</span><span class="p">,</span> <span class="mh">0x0F8F</span><span class="p">);</span> <span class="cm">/* bypass 12/9/6 */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bUpdateARFR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bUpdateARFR</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARFR</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">);</span> <span class="cm">/* set 1M ~ 54Mbps. */</span>
			<span class="p">}</span>

			<span class="cm">/* Update Fail Tx rate and count. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRate</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRate</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRateSS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">200</span><span class="p">;</span> <span class="cm">/* Set lowest power. */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bTryDown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check if Tx rate can be degraded or Test trying upgrading should fallback. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">&gt;</span> <span class="n">TryDownTh</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTryuping</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTryuping</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="cm">/* Update fail information. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRate</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* Record the Tx fail rate signal strength. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRateSS</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRateSS</span> <span class="o">=</span> <span class="n">CurrSignalStrength</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRate</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRateSS</span> <span class="o">=</span> <span class="n">CurrSignalStrength</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">=</span> <span class="n">GetDegradeTxRate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">);</span>

			<span class="cm">/* Reduce chariot training time at weak signal strength situation. SD3 ED demand. */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">CurrSignalStrength</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">&gt;</span> <span class="mi">72</span> <span class="p">))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">==</span> <span class="mi">36</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bUpdateARFR</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARFR</span><span class="p">,</span> <span class="mh">0x0F8F</span><span class="p">);</span> <span class="cm">/* bypass 12/9/6 */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bUpdateARFR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bUpdateARFR</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARFR</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">);</span> <span class="cm">/* set 1M ~ 54Mbps. */</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * When it is CCK rate, it may need to update initial gain to receive lower power packets.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MgntIsCckRate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bUpdateInitialGain</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* </span>
<span class="cm"> 	 * Keep the Tx fail rate count to equal to 0x15 at most. </span>
<span class="cm">	 * Reduce the fail count at least to 10 sec if tx rate is tending stable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&gt;=</span> <span class="mh">0x15</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="n">bTryUp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bTryDown</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">&gt;</span> <span class="mh">0x6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">OfdmTxPwrIdx</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">];</span>
	<span class="n">CckTxPwrIdx</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">];</span>

	<span class="cm">/* Mac0x9e increase 2 level in 36M~18M situation */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">&lt;</span> <span class="mi">96</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u1bCck</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">);</span>
		<span class="n">u1bOfdm</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">);</span>

		<span class="cm">/* case 1: Never enter High power */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u1bCck</span> <span class="o">==</span> <span class="n">CckTxPwrIdx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u1bOfdm</span> <span class="o">!=</span> <span class="p">(</span><span class="n">OfdmTxPwrIdx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bEnhanceTxPwr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">u1bOfdm</span> <span class="o">=</span> <span class="p">((</span><span class="n">u1bOfdm</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span> <span class="o">?</span> <span class="mi">35</span><span class="o">:</span> <span class="p">(</span><span class="n">u1bOfdm</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="n">u1bOfdm</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u1bCck</span> <span class="o">&lt;</span> <span class="n">CckTxPwrIdx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* case 2: enter high power */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bEnhanceTxPwr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bEnhanceTxPwr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">u1bOfdm</span> <span class="o">=</span> <span class="p">((</span><span class="n">u1bOfdm</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span> <span class="o">?</span> <span class="mi">35</span><span class="o">:</span> <span class="p">(</span><span class="n">u1bOfdm</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="n">u1bOfdm</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bEnhanceTxPwr</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* 54/48/11/5.5/2/1 */</span>
		<span class="n">u1bCck</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">);</span>
		<span class="n">u1bOfdm</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">);</span>

		<span class="cm">/* case 1: Never enter High power */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u1bCck</span> <span class="o">==</span> <span class="n">CckTxPwrIdx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bEnhanceTxPwr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="n">OfdmTxPwrIdx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* case 2: enter high power */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u1bCck</span> <span class="o">&lt;</span> <span class="n">CckTxPwrIdx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bEnhanceTxPwr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">u1bOfdm</span> <span class="o">=</span> <span class="p">((</span><span class="n">u1bOfdm</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">u1bOfdm</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="n">u1bOfdm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need update initial gain when we set tx rate &quot;from OFDM to CCK&quot; or</span>
<span class="cm">	 * &quot;from CCK to OFDM&quot;.</span>
<span class="cm">	 */</span>
<span class="nl">SetInitialGain:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bUpdateInitialGain</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MgntIsCckRate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* CCK */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegBModeGainStage</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGainBackUp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">CurrSignalStrength</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">85</span><span class="p">)</span> <span class="cm">/* Low power, OFDM [0x17] = 26. */</span>
					<span class="cm">/* SD3 SYs suggest that CurrSignalStrength &lt; -65, ofdm 0x17=26. */</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegBModeGainStage</span><span class="p">;</span>

				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegBModeGainStage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="k">else</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="o">--</span><span class="p">;</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;StaRateAdaptive87SE(): update init_gain to index %d for date rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">);</span>
				<span class="n">UpdateInitialGain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* OFDM */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGainBackUp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">;</span>

				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;StaRateAdaptive87SE(): update init_gain to index %d for date rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span><span class="p">);</span>
				<span class="n">UpdateInitialGain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Record the related info */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">=</span> <span class="n">CurrRetryRate</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxThroughput</span> <span class="o">=</span> <span class="n">TxThroughput</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentOperaRate</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_rate_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">rate_adapter_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">StaRateAdaptive87SE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">timer_rate_adaptive</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ForcedDataRate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate_adapter_wq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rateadapter_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RateAdaptivePeriod</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rateadapter_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SwAntennaDiversityRxOk8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">SignalStrength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxOkCnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">SignalStrength</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Initialization case. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">=</span> <span class="n">SignalStrength</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxPktAntenna</span><span class="p">)</span> <span class="cm">/* Main antenna. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMainAntennaRxOkCnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>	 <span class="cm">/* Aux antenna. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdAuxAntennaRxOkCnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
 <span class="cm">/*	Change Antenna Switch. */</span>
<span class="n">bool</span> <span class="nf">SetAntenna8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">u1bAntennaIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">bAntennaSwitched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">u1bAntennaIndex</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Mac register, main antenna */</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="cm">/* base band */</span>
		<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">);</span> <span class="cm">/* Config CCK RX antenna. */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span> <span class="cm">/* Config OFDM RX antenna. */</span>

		<span class="n">bAntennaSwitched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* Mac register, aux antenna */</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="cm">/* base band */</span>
		<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">);</span> <span class="cm">/* Config CCK RX antenna. */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span> <span class="cm">/* Config OFDM RX antenna. */</span>

		<span class="n">bAntennaSwitched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SetAntenna8185: unknown u1bAntennaIndex(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u1bAntennaIndex</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">bAntennaSwitched</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrAntennaIndex</span> <span class="o">=</span> <span class="n">u1bAntennaIndex</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bAntennaSwitched</span><span class="p">;</span>
<span class="p">}</span>
 <span class="cm">/*	Toggle Antenna switch. */</span>
<span class="n">bool</span> <span class="nf">SwitchAntenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bool</span>		<span class="n">bResult</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrAntennaIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bResult</span> <span class="o">=</span> <span class="n">SetAntenna8185</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bResult</span> <span class="o">=</span> <span class="n">SetAntenna8185</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bResult</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Engine of SW Antenna Diversity mechanism.</span>
<span class="cm"> * Since 8187 has no Tx part information,</span>
<span class="cm"> * this implementation is only dependend on Rx part information.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">SwAntennaDiversity</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span>   <span class="n">bSwCheckSS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bSwCheckSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdTickCount</span><span class="o">++</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(1) AdTickCount: %d, AdCheckPeriod: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdTickCount</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(2) AdRxSignalStrength: %ld, AdRxSsThreshold: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Case 1. No Link. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bAdSwitchedChecking</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* I switch antenna here to prevent any one of antenna is broken before link established, 2006.04.18, by rcnjko.. */</span>
		<span class="n">SwitchAntenna</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	  <span class="cm">/* Case 2. Linked but no packet receive.d */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxOkCnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bAdSwitchedChecking</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">SwitchAntenna</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	  <span class="cm">/* Case 3. Evaluate last antenna switch action and undo it if necessary. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bAdSwitchedChecking</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bAdSwitchedChecking</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Adjust Rx signal strength threshold. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsBeforeSwitched</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxRxSsThreshold</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxRxSsThreshold</span><span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsBeforeSwitched</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Rx signal strength is not improved after we swtiched antenna. =&gt; Swich back. */</span>
			<span class="cm">/* Increase Antenna Diversity checking period due to bad decision. */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* Increase Antenna Diversity checking period. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxCheckPeriod</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxCheckPeriod</span><span class="p">;</span>

			<span class="cm">/* Wrong decision =&gt; switch back. */</span>
			<span class="n">SwitchAntenna</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Rx Signal Strength is improved. */</span>

			<span class="cm">/* Reset Antenna Diversity checking period to its min value. */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMinCheckPeriod</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="cm">/* Case 4. Evaluate if we shall switch antenna now. */</span>
	<span class="cm">/* Cause Table Speed is very fast in TRC Dell Lab, we check it every time. */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdTickCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * &lt;Roger_Notes&gt; We evaluate RxOk counts for each antenna first and than</span>
<span class="cm">		 * evaluate signal strength.</span>
<span class="cm">		 * The following operation can overcome the disability of CCA on both two antennas</span>
<span class="cm">		 * When signal strength was extremely low or high.</span>
<span class="cm">		 * 2008.01.30.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Evaluate RxOk count from each antenna if we shall switch default antenna now.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMainAntennaRxOkCnt</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdAuxAntennaRxOkCnt</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrAntennaIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We set Main antenna as default but RxOk count was less than Aux ones. */</span>

			<span class="cm">/* Switch to Aux antenna. */</span>
			<span class="n">SwitchAntenna</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHWAdSwitched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdAuxAntennaRxOkCnt</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMainAntennaRxOkCnt</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrAntennaIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We set Aux antenna as default but RxOk count was less than Main ones. */</span>

			<span class="cm">/* Switch to Main antenna. */</span>
			<span class="n">SwitchAntenna</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHWAdSwitched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Default antenna is better. */</span>

			<span class="cm">/* Still need to check current signal strength. */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHWAdSwitched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * &lt;Roger_Notes&gt; We evaluate Rx signal strength ONLY when default antenna</span>
<span class="cm">		 * didn&#39;t change by HW evaluation.</span>
<span class="cm">		 * 2008.02.27.</span>
<span class="cm">		 *</span>
<span class="cm">		 * [TRC Dell Lab] SignalStrength is inaccuracy. Isaiah 2008-03-05</span>
<span class="cm">		 * For example, Throughput of aux is better than main antenna(about 10M v.s 2M),</span>
<span class="cm">		 * but AdRxSignalStrength is less than main.</span>
<span class="cm">		 * Our guess is that main antenna have lower throughput and get many change</span>
<span class="cm">		 * to receive more CCK packets(ex.Beacon) which have stronger SignalStrength.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHWAdSwitched</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bSwCheckSS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Evaluate Rx signal strength if we shall switch antenna now. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rx signal strength is weak =&gt; Switch Antenna. */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsBeforeSwitched</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bAdSwitchedChecking</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="n">SwitchAntenna</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Rx signal strength is OK. */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bAdSwitchedChecking</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="cm">/* Increase Rx signal strength threshold if necessary. */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="cm">/* Signal is much stronger than current threshold */</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">&lt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxRxSsThreshold</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Current threhold is not yet reach upper limit. */</span>

					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxRxSsThreshold</span><span class="p">)</span> <span class="o">?</span>
								<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxRxSsThreshold</span><span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span><span class="p">;</span><span class="cm">/* +by amy 080312 */</span>
				<span class="p">}</span>

				<span class="cm">/* Reduce Antenna Diversity checking period if possible. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMinCheckPeriod</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Reset antenna diversity Rx related statistics. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxOkCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMainAntennaRxOkCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdAuxAntennaRxOkCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

 <span class="cm">/*	Return TRUE if we shall perform Tx Power Tracking Mechanism, FALSE otherwise. */</span>
<span class="n">bool</span> <span class="nf">CheckTxPwrTracking</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTxPowerTrack</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* if 87SE is in High Power , don&#39;t do Tx Power Tracking. asked by SD3 ED. 2008-08-08 Isaiah */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bToUpdateTxPwr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


 <span class="cm">/*	Timer callback function of SW Antenna Diversity. */</span>
<span class="kt">void</span> <span class="nf">SwAntennaDiversityTimerCallback</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RT_RF_POWER_STATE</span> <span class="n">rtState</span><span class="p">;</span>

	 <span class="cm">/* We do NOT need to switch antenna while RF is off. */</span>
	<span class="n">rtState</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfSleep</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t access BB/RF under Disable PLL situation. */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SwAntennaDiversity</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SwAntennaDiversityTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">ANTENNA_DIVERSITY_TIMER_PERIOD</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SwAntennaDiversityTimer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
