<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › r8185b_init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>r8185b_init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Module Name:</span>
<span class="cm"> *	r8185b_init.c</span>
<span class="cm"> *</span>
<span class="cm"> * Abstract:</span>
<span class="cm"> *	Hardware Initialization and Hardware IO for RTL8185B</span>
<span class="cm"> *</span>
<span class="cm"> * Major Change History:</span>
<span class="cm"> *	When		Who				What</span>
<span class="cm"> *	----------	---------------		-------------------------------</span>
<span class="cm"> *	2006-11-15	Xiong			Created</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	This file is ported from RTL8185B Windows driver.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*--------------------------Include File------------------------------------*/</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &quot;r8180_hw.h&quot;</span>
<span class="cp">#include &quot;r8180.h&quot;</span>
<span class="cp">#include &quot;r8180_rtl8225.h&quot; </span><span class="cm">/* RTL8225 Radio frontend */</span><span class="cp"></span>
<span class="cp">#include &quot;r8180_93cx6.h&quot;   </span><span class="cm">/* Card EEPROM */</span><span class="cp"></span>
<span class="cp">#include &quot;r8180_wx.h&quot;</span>
<span class="cp">#include &quot;ieee80211/dot11d.h&quot;</span>
<span class="cm">/* #define CONFIG_RTL8180_IO_MAP */</span>
<span class="cp">#define TC_3W_POLL_MAX_TRY_CNT 5</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">MAC_REG_TABLE</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>	<span class="p">{</span>
	<span class="cm">/*PAGA 0:	*/</span>
	<span class="cm">/* 0x34(BRSR), 0xBE(RATE_FALLBACK_CTL), 0x1E0(ARFR) would set in HwConfigureRTL8185() */</span>
	<span class="cm">/* 0x272(RFSW_CTRL), 0x1CE(AESMSK_QC) set in InitializeAdapter8185(). */</span>
	<span class="cm">/* 0x1F0~0x1F8  set in MacConfig_85BASIC() */</span>
	<span class="p">{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>

	<span class="cm">/*PAGE 1: */</span>
	<span class="cm">/* For Flextronics system Logo PCIHCT failure: */</span>
	<span class="cm">/* 0x1C4~0x1CD set no-zero value to avoid PCI configuration space 0x45[7]=1 */</span>
	<span class="p">{</span><span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="cm">/* lzm add 080826 */</span>
	<span class="p">{</span><span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">},</span> <span class="cm">/* lzm add 080826 */</span>
	<span class="p">{</span><span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>


	<span class="cm">/* PAGE 2: */</span>
	<span class="p">{</span><span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span> <span class="p">{</span><span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>

	<span class="cm">/* PAGA 0: */</span>
	<span class="p">{</span><span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="p">{</span><span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">}</span>
	<span class="p">};</span>


<span class="k">static</span> <span class="n">u8</span>  <span class="n">ZEBRA_AGC</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span>
	<span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span>
	<span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2F</span>
	<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">ZEBRA_RF_RX_GAIN_TABLE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0096</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x01f6</span><span class="p">,</span> <span class="mh">0x01d6</span><span class="p">,</span> <span class="mh">0x01b6</span><span class="p">,</span>
	<span class="mh">0x0196</span><span class="p">,</span> <span class="mh">0x0176</span><span class="p">,</span> <span class="mh">0x00F7</span><span class="p">,</span> <span class="mh">0x00D7</span><span class="p">,</span> <span class="mh">0x00B7</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">,</span> <span class="mh">0x0077</span><span class="p">,</span> <span class="mh">0x0057</span><span class="p">,</span>
	<span class="mh">0x0037</span><span class="p">,</span> <span class="mh">0x00FB</span><span class="p">,</span> <span class="mh">0x00DB</span><span class="p">,</span> <span class="mh">0x00BB</span><span class="p">,</span> <span class="mh">0x00FF</span><span class="p">,</span> <span class="mh">0x00E3</span><span class="p">,</span> <span class="mh">0x00C3</span><span class="p">,</span> <span class="mh">0x00A3</span><span class="p">,</span>
	<span class="mh">0x0083</span><span class="p">,</span> <span class="mh">0x0063</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x01E3</span><span class="p">,</span> <span class="mh">0x01C3</span><span class="p">,</span> <span class="mh">0x01A3</span><span class="p">,</span>
	<span class="mh">0x0183</span><span class="p">,</span> <span class="mh">0x0163</span><span class="p">,</span> <span class="mh">0x0143</span><span class="p">,</span> <span class="mh">0x0123</span><span class="p">,</span> <span class="mh">0x0103</span>
	<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">OFDM_CONFIG</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* OFDM reg0x06[7:0]=0xFF: Enable power saving mode in RX */</span>
	<span class="cm">/* OFDM reg0x3C[4]=1&#39;b1: Enable RX power saving mode */</span>
	<span class="cm">/* ofdm 0x3a = 0x7b ,(original : 0xfb) For ECS shielding room TP test */</span>
	<span class="cm">/* 0x00	*/</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="cm">/* 0x10	*/</span>
	<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span>
	<span class="cm">/* 0x20	*/</span>
	<span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="cm">/* 0x30	*/</span>
	<span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span>
	<span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span>
	<span class="p">};</span>

	<span class="cm">/*---------------------------------------------------------------</span>
<span class="cm">	 *	Hardware IO</span>
<span class="cm">	 *	the code is ported from Windows source code</span>
<span class="cm">	 *---------------------------------------------------------------</span>
<span class="cm">	 */</span>

<span class="kt">void</span> <span class="nf">PlatformIOWrite1Byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span> <span class="cm">/* To make sure write operation is completed, 2005.11.09, by rcnjko. */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">PlatformIOWrite2Byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span> <span class="cm">/* To make sure write operation is completed, 2005.11.09, by rcnjko. */</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="n">PlatformIORead1Byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">PlatformIOWrite4Byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">PhyAddr</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* For Base Band configuration. */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">cmdByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">dataBytes</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">idx</span><span class="p">;</span>
		<span class="n">u8</span>		<span class="n">u1bTmp</span><span class="p">;</span>

		<span class="n">cmdByte</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>
		<span class="n">dataBytes</span> <span class="o">=</span> <span class="n">data</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 *	071010, rcnjko:</span>
<span class="cm">		 *	The critical section is only BB read/write race condition.</span>
<span class="cm">		 *	Assumption:</span>
<span class="cm">		 *	1. We assume NO one will access BB at DIRQL, otherwise, system will crash for</span>
<span class="cm">		 *	acquiring the spinlock in such context.</span>
<span class="cm">		 *	2. PlatformIOWrite4Byte() MUST NOT be recursive.</span>
<span class="cm">		 */</span>
		<span class="cm">/* NdisAcquireSpinLock( &amp;(pDevice-&gt;IoSpinLock) ); */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure command bit is clear before access it. */</span>
			<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">PlatformIORead1Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PhyAddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u1bTmp</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="n">PlatformIOWrite1Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">idx</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dataBytes</span><span class="p">)[</span><span class="n">idx</span><span class="p">]);</span>

		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">cmdByte</span><span class="p">);</span>

		<span class="cm">/* NdisReleaseSpinLock( &amp;(pDevice-&gt;IoSpinLock) ); */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span> <span class="cm">/* To make sure write operation is completed, 2005.11.09, by rcnjko. */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">PlatformIORead1Byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">PlatformIORead2Byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">PlatformIORead4Byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SetOutputEnableOfRfPins</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">,</span> <span class="mh">0x1bff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">HwHSSIThreeWire</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">pDataBuf</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">nDataBufBitCnt</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">bSI</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">bWrite</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">bResult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">TryCnt</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">u1bTmp</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Check if WE and RE are cleared. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TryCnt</span> <span class="o">&lt;</span> <span class="n">TC_3W_POLL_MAX_TRY_CNT</span><span class="p">;</span> <span class="n">TryCnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_CMD1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u1bTmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SW_3W_CMD1_RE</span><span class="o">|</span><span class="n">SW_3W_CMD1_WE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TryCnt</span> <span class="o">==</span> <span class="n">TC_3W_POLL_MAX_TRY_CNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rtl8187se: HwThreeWire(): CmdReg:&quot;</span>
			       <span class="s">&quot; %#X RE|WE bits are not clear!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">u1bTmp</span><span class="p">);</span>
			<span class="n">dump_stack</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* RTL8187S HSSI Read/Write Function */</span>
		<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_SW_CONFIG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bSI</span><span class="p">)</span>
			<span class="n">u1bTmp</span> <span class="o">|=</span>   <span class="n">RF_SW_CFG_SI</span><span class="p">;</span> <span class="cm">/* reg08[1]=1 Serial Interface(SI) */</span>

		<span class="k">else</span>
			<span class="n">u1bTmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RF_SW_CFG_SI</span><span class="p">;</span> <span class="cm">/* reg08[1]=0 Parallel Interface(PI) */</span>


		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_SW_CONFIG</span><span class="p">,</span> <span class="n">u1bTmp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* jong: HW SI read must set reg84[3]=0. */</span>
			<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">);</span>
			<span class="n">u1bTmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT3</span><span class="p">;</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">,</span> <span class="n">u1bTmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*  Fill up data buffer for write operation. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bWrite</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nDataBufBitCnt</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_DB0</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pDataBuf</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nDataBufBitCnt</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* RTL8187S shouldn&#39;t enter this case */</span>
				<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_DB0</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pDataBuf</span><span class="p">));</span>
				<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_DB1</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">pDataBuf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">ByteCnt</span> <span class="o">=</span> <span class="n">nDataBufBitCnt</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
								<span class="cm">/* printk(&quot;%d\n&quot;,nDataBufBitCnt); */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">nDataBufBitCnt</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rtl8187se: &quot;</span>
					       <span class="s">&quot;HwThreeWire(): nDataBufBitCnt(%d)&quot;</span>
					       <span class="s">&quot; should be multiple of 8!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">nDataBufBitCnt</span><span class="p">);</span>
					<span class="n">dump_stack</span><span class="p">();</span>
					<span class="n">nDataBufBitCnt</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">nDataBufBitCnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
				<span class="p">}</span>

			       <span class="k">if</span> <span class="p">(</span><span class="n">nDataBufBitCnt</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rtl8187se: HwThreeWire():&quot;</span>
					       <span class="s">&quot; nDataBufBitCnt(%d) should &lt;= 64!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">nDataBufBitCnt</span><span class="p">);</span>
					<span class="n">dump_stack</span><span class="p">();</span>
					<span class="n">nDataBufBitCnt</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ByteCnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
					<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">SW_3W_DB0</span><span class="o">+</span><span class="n">idx</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">pDataBuf</span><span class="o">+</span><span class="n">idx</span><span class="p">));</span>

			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* read */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bSI</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* SI - reg274[3:0] : RF register&#39;s Address */</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_DB0</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pDataBuf</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*  PI - reg274[15:12] : RF register&#39;s Address */</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_DB0</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pDataBuf</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Set up command: WE or RE. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bWrite</span><span class="p">)</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_CMD1</span><span class="p">,</span> <span class="n">SW_3W_CMD1_WE</span><span class="p">);</span>

		<span class="k">else</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_CMD1</span><span class="p">,</span> <span class="n">SW_3W_CMD1_RE</span><span class="p">);</span>


		<span class="cm">/* Check if DONE is set. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">TryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TryCnt</span> <span class="o">&lt;</span> <span class="n">TC_3W_POLL_MAX_TRY_CNT</span><span class="p">;</span> <span class="n">TryCnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_CMD1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u1bTmp</span> <span class="o">&amp;</span> <span class="n">SW_3W_CMD1_DONE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SW_3W_CMD1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Read back data for read operation. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bWrite</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bSI</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Serial Interface : reg363_362[11:0] */</span>
				<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pDataBuf</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SI_DATA_READ</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Parallel Interface : reg361_360[11:0] */</span>
				<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pDataBuf</span><span class="p">)</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PI_DATA_READ</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pDataBuf</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="mh">0x0FFF</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bResult</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">RF_WriteReg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data2Write</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Pure HW 3-wire. */</span>
	<span class="n">data2Write</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">HwHSSIThreeWire</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">data2Write</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">RF_ReadReg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data2Write</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dataRead</span><span class="p">;</span>

	<span class="n">data2Write</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="n">wlen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">HwHSSIThreeWire</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">data2Write</span><span class="p">),</span> <span class="n">wlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dataRead</span> <span class="o">=</span> <span class="n">data2Write</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dataRead</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* by Owen on 04/07/14 for writing BB register successfully */</span>
<span class="kt">void</span> <span class="nf">WriteBBPortUchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">Data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* u8	TimeoutCounter; */</span>
	<span class="n">u8</span>	<span class="n">RegisterContent</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">UCharData</span><span class="p">;</span>

	<span class="n">UCharData</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">Data</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">PlatformIOWrite4Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PhyAddr</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
	<span class="cm">/* for(TimeoutCounter = 10; TimeoutCounter &gt; 0; TimeoutCounter--) */</span>
	<span class="p">{</span>
		<span class="n">PlatformIOWrite4Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PhyAddr</span><span class="p">,</span> <span class="n">Data</span> <span class="o">&amp;</span> <span class="mh">0xffffff7f</span><span class="p">);</span>
		<span class="n">RegisterContent</span> <span class="o">=</span> <span class="n">PlatformIORead1Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PhyDataR</span><span class="p">);</span>
		<span class="cm">/*if(UCharData == RegisterContent)	*/</span>
		<span class="cm">/*	break;	*/</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">ReadBBPortUchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*u8	TimeoutCounter; */</span>
	<span class="n">u8</span>	<span class="n">RegisterContent</span><span class="p">;</span>

	<span class="n">PlatformIOWrite4Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PhyAddr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffff7f</span><span class="p">);</span>
	<span class="n">RegisterContent</span> <span class="o">=</span> <span class="n">PlatformIORead1Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PhyDataR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RegisterContent</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *	Perform Antenna settings with antenna diversity on 87SE.</span>
<span class="cm"> *		Created by Roger, 2008.01.25.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">SetAntennaConfig87SE</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">u8</span>   <span class="n">DefaultAnt</span><span class="p">,</span> <span class="cm">/* 0: Main, 1: Aux. */</span>
			  <span class="n">bool</span> <span class="n">bAntDiversity</span><span class="p">)</span> <span class="cm">/* 1:Enable, 0: Disable. */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span>   <span class="n">bAntennaSwitched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* printk(&quot;SetAntennaConfig87SE(): DefaultAnt(%d), bAntDiversity(%d)\n&quot;, DefaultAnt, bAntDiversity); */</span>

	<span class="cm">/* Threshold for antenna diversity. */</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span> <span class="cm">/* Reg0c : 09 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bAntDiversity</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/*	Enable Antenna Diversity. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DefaultAnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* aux antenna */</span>

			<span class="cm">/* Mac register, aux antenna */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

			<span class="cm">/* Config CCK RX antenna. */</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">);</span> <span class="cm">/* Reg11 : bb */</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">);</span> <span class="cm">/* Reg01 : c7 */</span>

			<span class="cm">/* Config OFDM RX antenna. */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>	<span class="cm">/* Reg0d : 54 */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">);</span>	<span class="cm">/* Reg18 : b2 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/*  use main antenna */</span>
			<span class="cm">/* Mac register, main antenna */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="cm">/* base band */</span>
			<span class="cm">/*  Config CCK RX antenna. */</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">);</span> <span class="cm">/* Reg11 : 9b */</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">);</span> <span class="cm">/* Reg01 : c7 */</span>

			<span class="cm">/* Config OFDM RX antenna. */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>  <span class="cm">/* Reg0d : 5c	*/</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">);</span>  <span class="cm">/* Reg18 : b2	*/</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Disable Antenna Diversity. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DefaultAnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* aux Antenna */</span>
			<span class="cm">/* Mac register, aux antenna */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

			<span class="cm">/* Config CCK RX antenna. */</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">);</span> <span class="cm">/* Reg11 : bb */</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">);</span> <span class="cm">/* Reg01 : 47 */</span>

			<span class="cm">/* Config OFDM RX antenna. */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>	<span class="cm">/* Reg0d : 54 */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>	<span class="cm">/* Reg18 : 32 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* main Antenna */</span>
			<span class="cm">/* Mac register, main antenna */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

			<span class="cm">/* Config CCK RX antenna.	*/</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">);</span> <span class="cm">/* Reg11 : 9b */</span>
			<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">);</span> <span class="cm">/* Reg01 : 47 */</span>

			<span class="cm">/* Config OFDM RX antenna. */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span> <span class="cm">/* Reg0d : 5c */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span> <span class="cm">/*Reg18 : 32 */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrAntennaIndex</span> <span class="o">=</span> <span class="n">DefaultAnt</span><span class="p">;</span> <span class="cm">/* Update default settings. */</span>
	<span class="k">return</span>	<span class="n">bAntennaSwitched</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *--------------------------------------------------------------</span>
<span class="cm"> *		Hardware Initialization.</span>
<span class="cm"> *		the code is ported from Windows source code</span>
<span class="cm"> *--------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ZEBRA_Config_85BASIC_HardCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">u4bRegOffset</span><span class="p">,</span> <span class="n">u4bRegValue</span><span class="p">,</span> <span class="n">u4bRF23</span><span class="p">,</span> <span class="n">u4bRF24</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">u1b24E</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">d_cut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> *===========================================================================</span>
<span class="cm"> *	87S_PCIE :: RADIOCFG.TXT</span>
<span class="cm"> *===========================================================================</span>
<span class="cm"> */</span>


	<span class="cm">/* Page1 : reg16-reg30 */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x013f</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* switch to page1 */</span>
	<span class="n">u4bRF23</span> <span class="o">=</span> <span class="n">RF_ReadReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">u4bRF24</span> <span class="o">=</span> <span class="n">RF_ReadReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u4bRF23</span> <span class="o">==</span> <span class="mh">0x818</span> <span class="o">&amp;&amp;</span> <span class="n">u4bRF24</span> <span class="o">==</span> <span class="mh">0x70C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d_cut</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rtl8187se: card type changed from C- to D-cut</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Page0 : reg0-reg15 */</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="cm">/* 1	*/</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x06e0</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="cm">/* 2	*/</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x07f1</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="cm">/* 3	*/</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0975</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0c72</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0ae6</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00ca</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0e1c</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x02f0</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09d0</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x01ba</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0640</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x08df</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0990</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*  Page1 : reg16-reg30 */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x013f</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0806</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03a7</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x059b</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0081</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x01A0</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/* Don&#39;t write RF23/RF24 to make a difference between 87S C cut and D cut. asked by SD3 stevenl. */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0418</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d_cut</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0fbe</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0807</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* RX LO buffer */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0fbe</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0806</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* RX LO buffer */</span>
	<span class="p">}</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0acc</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01d7</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* 6 */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0e00</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0e50</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">36</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">ZEBRA_RF_RX_GAIN_TABLE</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0203</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* 203, 343 */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* 400 */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0137</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* switch to reg16-reg30, and HSSI disable 137 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd */</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Z4 synthesizer loop filter setting, 392 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd */</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* switch to reg0-reg15, and HSSI disable */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd	*/</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0160</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* CBC on, Tx Rx disable, High gain */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd	*/</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Z4 setted channel 1 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd	*/</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x088D</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* LC calibration */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span> <span class="cm">/* Deay 200 ms. */</span>		<span class="cm">/* 0xfd	*/</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd	*/</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd	*/</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0137</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* switch to reg16-reg30 137, and HSSI disable 137 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Deay 10 ms. */</span>		<span class="cm">/* 0xfd	*/</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0180</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0220</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03E0</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* DAC calibration off 20070702	*/</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00c1</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* For crystal calibration, added by Roger, 2007.12.11. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bXtalCalibration</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* reg 30.	*/</span>
	 <span class="cm">/*</span>
<span class="cm"> 	  *  enable crystal calibration.</span>
<span class="cm">	  *		RF Reg[30], (1)Xin:[12:9], Xout:[8:5],  addr[4:0].</span>
<span class="cm">	  *		(2)PA Pwr delay timer[15:14], default: 2.4us, set BIT15=0</span>
<span class="cm">	  *		(3)RF signal on/off when calibration[13], default: on, set BIT13=0.</span>
<span class="cm">	  *		So we should minus 4 BITs offset. </span>
<span class="cm">	  */</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xin</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xout</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT11</span> <span class="o">|</span> <span class="n">BIT9</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ZEBRA_Config_85BASIC_HardCode(): (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xin</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xout</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT11</span> <span class="o">|</span> <span class="n">BIT9</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* using default value. Xin=6, Xout=6.	*/</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0acc</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* switch to reg0-reg15, and HSSI enable */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x08df</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Rx BB start calibration, 00c//+edward */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* temperature meter off */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0975</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Rx mode */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* Deay 10 ms.*/</span>	<span class="cm">/* 0xfe	*/</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* Deay 10 ms.*/</span>	<span class="cm">/* 0xfe	*/</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>	<span class="cm">/* Deay 10 ms.*/</span>	<span class="cm">/* 0xfe	*/</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0197</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Rx mode*/</span>	<span class="cm">/*+edward */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x05ab</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Rx mode*/</span>	<span class="cm">/*+edward */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Rx mode*/</span>	<span class="cm">/*+edward */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Rx mode*/</span>	<span class="cm">/*+edward */</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Rx mode*/</span>	<span class="cm">/*+edward */</span>
	<span class="cm">/* power save parameters. */</span>
	<span class="n">u1b24E</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">,</span> <span class="p">(</span><span class="n">u1b24E</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">BIT5</span><span class="o">|</span><span class="n">BIT6</span><span class="p">))));</span>

	<span class="cm">/*=============================================================================</span>
<span class="cm">	 *</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 * CCKCONF.TXT</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 *</span>
<span class="cm">	 *	[POWER SAVE] Power Saving Parameters by jong. 2007-11-27</span>
<span class="cm">	 *	CCK reg0x00[7]=1&#39;b1 :power saving for TX (default)</span>
<span class="cm">	 *	CCK reg0x00[6]=1&#39;b1: power saving for RX (default)</span>
<span class="cm">	 *	CCK reg0x06[4]=1&#39;b1: turn off channel estimation related circuits if not doing channel estimation.</span>
<span class="cm">	 *	CCK reg0x06[3]=1&#39;b1: turn off unused circuits before cca = 1</span>
<span class="cm">	 *	CCK reg0x06[2]=1&#39;b1: turn off cck&#39;s circuit if macrst =0</span>
<span class="cm">	 */</span>

	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>

	<span class="cm">/* power control */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>



	<span class="cm">/*</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 *	AGC.txt</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 */</span>

	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">ZEBRA_AGC</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x0000008F</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* enable writing AGC table */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">|</span> <span class="mh">0x0000008E</span><span class="p">;</span>

		<span class="n">WriteBBPortUchar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">WriteBBPortUchar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">WriteBBPortUchar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0000008E</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PlatformIOWrite4Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PhyAddr</span><span class="p">,</span> <span class="mh">0x00001080</span><span class="p">);</span>	<span class="cm">/* Annie, 2006-05-05 */</span>

	<span class="cm">/*</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 *</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 * OFDMCONF.TXT</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u4bRegOffset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u4bRegValue</span> <span class="o">=</span> <span class="n">OFDM_CONFIG</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">WriteBBPortUchar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="p">(</span><span class="mh">0x00000080</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">u4bRegOffset</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u4bRegValue</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 * by amy for antenna</span>
<span class="cm">	 *===========================================================================</span>
<span class="cm">	 */</span>
	<span class="cm">/* Config Sw/Hw  Combinational Antenna Diversity. Added by Roger, 2008.02.26.	*/</span>
	<span class="n">SetAntennaConfig87SE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDefaultAntenna1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwAntennaDiverity</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">UpdateInitialGain</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* lzm add 080826 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">!=</span> <span class="n">eRfOn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*	Don&#39;t access BB/RF under disable PLL situation.</span>
<span class="cm">		 *	RT_TRACE(COMP_DIG, DBG_LOUD, (&quot;UpdateInitialGain - pHalData-&gt;eRFPowerState!=eRfOn\n&quot;));</span>
<span class="cm">		 *	Back to the original state</span>
<span class="cm">		 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGainBackUp</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* m861dBm */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* m862dBm */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* m863dBm */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* m864dBm */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* m82dBm */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* m78dBm */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* m74dBm */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="cm">/* MP */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">);</span>	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *		Tx Power tracking mechanism routine on 87SE.</span>
<span class="cm"> *	Created by Roger, 2007.12.11.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">InitTxPwrTracking87SE</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">u4bRfReg</span><span class="p">;</span>

	<span class="n">u4bRfReg</span> <span class="o">=</span> <span class="n">RF_ReadReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="cm">/* Enable Thermal meter indication.	*/</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">u4bRfReg</span><span class="o">|</span><span class="n">PWR_METER_EN</span><span class="p">);</span>			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">PhyConfig8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span><span class="p">);</span>
	   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFProgType</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="cm">/*  RF config */</span>
	<span class="n">ZEBRA_Config_85BASIC_HardCode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Set default initial gain state to 4, approved by SD3 DZ, by Bruce, 2007-06-06. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDigMechanism</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Enable thermal meter indication to implement TxPower tracking on 87SE.</span>
<span class="cm">	 *	We initialize thermal meter here to avoid unsuccessful configuration.</span>
<span class="cm">	 *	Added by Roger, 2007.12.11.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTxPowerTrack</span><span class="p">)</span>
		<span class="n">InitTxPwrTracking87SE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGainBackUp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span><span class="p">;</span>
	<span class="n">UpdateInitialGain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HwConfigureRTL8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* RTL8185_TODO: Determine Retrylimit, TxAGC, AutoRateFallback control. */</span>
	<span class="n">u8</span> <span class="n">bUNIVERSAL_CONTROL_RL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bUNIVERSAL_CONTROL_AGC</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bUNIVERSAL_CONTROL_ANT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bAUTO_RATE_FALLBACK_CTL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val8</span><span class="p">;</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRSR</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">);</span>
	<span class="cm">/* Retry limit */</span>
	<span class="n">val8</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CW_CONF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bUNIVERSAL_CONTROL_RL</span><span class="p">)</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">val8</span> <span class="o">&amp;</span> <span class="mh">0xfd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">val8</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CW_CONF</span><span class="p">,</span> <span class="n">val8</span><span class="p">);</span>

	<span class="cm">/* Tx AGC */</span>
	<span class="n">val8</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TXAGC_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bUNIVERSAL_CONTROL_AGC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">val8</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">val8</span> <span class="o">|</span> <span class="mh">0x01</span> <span class="p">;</span>
	<span class="p">}</span>


	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TXAGC_CTL</span><span class="p">,</span> <span class="n">val8</span><span class="p">);</span>

	<span class="cm">/* Tx Antenna including Feedback control */</span>
	<span class="n">val8</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TXAGC_CTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bUNIVERSAL_CONTROL_ANT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANTSEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">val8</span> <span class="o">&amp;</span> <span class="mh">0xfd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">val8</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">val8</span><span class="o">|</span><span class="mh">0x02</span><span class="p">);</span> <span class="cm">/* xiong-2006-11-15 */</span>
	<span class="p">}</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TXAGC_CTL</span><span class="p">,</span> <span class="n">val8</span><span class="p">);</span>

	<span class="cm">/* Auto Rate fallback control	*/</span>
	<span class="n">val8</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RATE_FALLBACK</span><span class="p">);</span>
	<span class="n">val8</span> <span class="o">&amp;=</span> <span class="mh">0x7c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bAUTO_RATE_FALLBACK_CTL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val8</span> <span class="o">|=</span> <span class="n">RATE_FALLBACK_CTL_ENABLE</span> <span class="o">|</span> <span class="n">RATE_FALLBACK_CTL_AUTO_STEP1</span><span class="p">;</span>

		<span class="cm">/* &lt;RJ_TODO_8185B&gt; We shall set up the ARFR according to user&#39;s setting. */</span>
		<span class="n">PlatformIOWrite2Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ARFR</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">);</span> <span class="cm">/* set 1M ~ 54Mbps. */</span>
	<span class="p">}</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RATE_FALLBACK</span><span class="p">,</span> <span class="n">val8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MacConfig_85BASIC_HardCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *==========================================================================</span>
<span class="cm">	 * MACREG.TXT</span>
<span class="cm">	 *==========================================================================</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">nLinesRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u4bRegOffset</span><span class="p">,</span> <span class="n">u4bRegValue</span><span class="p">,</span> <span class="n">u4bPageIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nLinesRead</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAC_REG_TABLE</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nLinesRead</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* nLinesRead=101 */</span>
		<span class="n">u4bRegOffset</span> <span class="o">=</span> <span class="n">MAC_REG_TABLE</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">u4bRegValue</span> <span class="o">=</span> <span class="n">MAC_REG_TABLE</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">u4bRegOffset</span> <span class="o">==</span> <span class="mh">0x5e</span><span class="p">)</span>
					<span class="n">u4bPageIndex</span> <span class="o">=</span> <span class="n">u4bRegValue</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">u4bRegOffset</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u4bPageIndex</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u4bRegOffset</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u4bRegValue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* ============================================================================ */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MacConfig_85BASIC</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u8</span>			<span class="n">u1DA</span><span class="p">;</span>
	<span class="n">MacConfig_85BASIC_HardCode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* ============================================================================ */</span>

	<span class="cm">/* Follow TID_AC_MAP of WMac. */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TID_AC_MAP</span><span class="p">,</span> <span class="mh">0xfa50</span><span class="p">);</span>

	<span class="cm">/* Interrupt Migration, Jong suggested we use set 0x0000 first, 2005.12.14, by rcnjko. */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IntMig</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Prevent TPC to cause CRC error. Added by Annie, 2006-06-10. */</span>
	<span class="n">PlatformIOWrite4Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1F0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">PlatformIOWrite4Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1F4</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">PlatformIOWrite1Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1F8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Asked for by SD3 CM Lin, 2006.06.27, by rcnjko. */</span>
	<span class="cm">/* power save parameter based on &quot;87SE power save parameters 20071127.doc&quot;, as follow. */</span>

	<span class="cm">/* Enable DA10 TX power saving */</span>
	<span class="n">u1DA</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PHYPR</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PHYPR</span><span class="p">,</span> <span class="p">(</span><span class="n">u1DA</span> <span class="o">|</span> <span class="n">BIT2</span><span class="p">));</span>

	<span class="cm">/* POWER: */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x362</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

	<span class="cm">/* AFE. */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x370</span><span class="p">,</span> <span class="mh">0x0560</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x372</span><span class="p">,</span> <span class="mh">0x0560</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x374</span><span class="p">,</span> <span class="mh">0x0DA4</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x376</span><span class="p">,</span> <span class="mh">0x0DA4</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x378</span><span class="p">,</span> <span class="mh">0x0560</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x37A</span><span class="p">,</span> <span class="mh">0x0560</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x37C</span><span class="p">,</span> <span class="mh">0x00EC</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x37E</span><span class="p">,</span> <span class="mh">0x00EC</span><span class="p">);</span> <span class="cm">/* +edward */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">GetSupportedWirelessMode8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">btSupportedWirelessMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">btSupportedWirelessMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIRELESS_MODE_B</span> <span class="o">|</span> <span class="n">WIRELESS_MODE_G</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">btSupportedWirelessMode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ActUpdateChannelAccessSetting</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">WIRELESS_MODE</span> <span class="n">WirelessMode</span><span class="p">,</span>
				   <span class="n">PCHANNEL_ACCESS_SETTING</span> <span class="n">ChnlAccessSetting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>		<span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span>		<span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="n">AC_CODING</span>	<span class="n">eACI</span><span class="p">;</span>
	<span class="n">AC_PARAM</span>	<span class="n">AcParam</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">bFollowLegacySetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">u1bAIFS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	&lt;RJ_TODO_8185B&gt;</span>
<span class="cm">	 *	TODO: We still don&#39;t know how to set up these registers, just follow WMAC to</span>
<span class="cm">	 *	verify 8185B FPAG.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	&lt;RJ_TODO_8185B&gt;</span>
<span class="cm">	 *	Jong said CWmin/CWmax register are not functional in 8185B,</span>
<span class="cm">	 *	so we shall fill channel access realted register into AC parameter registers,</span>
<span class="cm">	 *	even in nQBss.</span>
<span class="cm">	 */</span>
	<span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">SIFS_Timer</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span> <span class="cm">/* Suggested by Jong, 2005.12.08. */</span>
	<span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">DIFS_Timer</span> <span class="o">=</span> <span class="mh">0x1C</span><span class="p">;</span> <span class="cm">/* 2006.06.02, by rcnjko. */</span>
	<span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">SlotTimeTimer</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* 2006.06.02, by rcnjko. */</span>
	<span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">EIFS_Timer</span> <span class="o">=</span> <span class="mh">0x5B</span><span class="p">;</span> <span class="cm">/* Suggested by wcchu, it is the default value of EIFS register, 2005.12.08. */</span>
	<span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">CWminIndex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* 2006.06.02, by rcnjko. */</span>
	<span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">CWmaxIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* 2006.06.02, by rcnjko. */</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIFS</span><span class="p">,</span> <span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">SIFS_Timer</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLOT</span><span class="p">,</span> <span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">SlotTimeTimer</span><span class="p">);</span> <span class="cm">/* Rewrited from directly use PlatformEFIOWrite1Byte(), by Annie, 2006-03-29. */</span>

	<span class="n">u1bAIFS</span> <span class="o">=</span> <span class="n">aSifsTime</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">SlotTimeTimer</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EIFS</span><span class="p">,</span> <span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">EIFS_Timer</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AckTimeOutReg</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">);</span> <span class="cm">/* &lt;RJ_EXPR_QOS&gt; Suggested by wcchu, it is the default value of EIFS register, 2005.12.08. */</span>

	<span class="p">{</span> <span class="cm">/* Legacy 802.11. */</span>
		<span class="n">bFollowLegacySetting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* this setting is copied from rtl8187B.  xiong-2006-11-13 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bFollowLegacySetting</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Follow 802.11 seeting to AC parameter, all AC shall use the same parameter.</span>
<span class="cm">		 *	2005.12.01, by rcnjko.</span>
<span class="cm">		 */</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">longData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AIFSN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Follow 802.11 DIFS.	*/</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ACM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmin</span> <span class="o">=</span> <span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">CWminIndex</span><span class="p">;</span> <span class="cm">/* Follow 802.11 CWmin. */</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmax</span> <span class="o">=</span> <span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">CWmaxIndex</span><span class="p">;</span> <span class="cm">/* Follow 802.11 CWmax. */</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">TXOPLimit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* lzm reserved 080826 */</span>
		<span class="cm">/* For turbo mode setting. port from 87B by Isaiah 2008-08-01 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">Turbo_Enable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">TXOPLimit</span> <span class="o">=</span> <span class="mh">0x01FF</span><span class="p">;</span>
		<span class="cm">/* For 87SE with Intel 4965  Ad-Hoc mode have poor throughput (19MB) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">TXOPLimit</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">eACI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eACI</span> <span class="o">&lt;</span> <span class="n">AC_MAX</span><span class="p">;</span> <span class="n">eACI</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ACI</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">eACI</span><span class="p">;</span>
			<span class="p">{</span>
				<span class="n">PAC_PARAM</span>	<span class="n">pAcParam</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAC_PARAM</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">AcParam</span><span class="p">);</span>
				<span class="n">AC_CODING</span>	<span class="n">eACI</span><span class="p">;</span>
				<span class="n">u8</span>		<span class="n">u1bAIFS</span><span class="p">;</span>
				<span class="n">u32</span>		<span class="n">u4bAcParam</span><span class="p">;</span>

				<span class="cm">/*  Retrieve paramters to update. */</span>
				<span class="n">eACI</span> <span class="o">=</span> <span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ACI</span><span class="p">;</span>
				<span class="n">u1bAIFS</span> <span class="o">=</span> <span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AIFSN</span> <span class="o">*</span> <span class="n">ChnlAccessSetting</span><span class="o">-&gt;</span><span class="n">SlotTimeTimer</span> <span class="o">+</span> <span class="n">aSifsTime</span><span class="p">;</span>
				<span class="n">u4bAcParam</span> <span class="o">=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">TXOPLimit</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_TXOP_LIMIT_OFFSET</span><span class="p">)</span>	<span class="o">|</span>
						<span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmax</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_ECW_MAX_OFFSET</span><span class="p">)</span>	<span class="o">|</span>
						<span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmin</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_ECW_MIN_OFFSET</span><span class="p">)</span>	<span class="o">|</span>
						<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">u1bAIFS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_AIFS_OFFSET</span><span class="p">));</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">eACI</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">AC1_BK</span>:
					<span class="cm">/* write_nic_dword(dev, AC_BK_PARAM, u4bAcParam); */</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">AC0_BE</span>:
					<span class="cm">/* write_nic_dword(dev, AC_BK_PARAM, u4bAcParam); */</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">AC2_VI</span>:
					<span class="cm">/* write_nic_dword(dev, AC_BK_PARAM, u4bAcParam); */</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">AC3_VO</span>:
					<span class="cm">/* write_nic_dword(dev, AC_BK_PARAM, u4bAcParam); */</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="nl">default:</span>
					<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;SetHwReg8185(): invalid ACI: %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eACI</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Cehck ACM bit. */</span>
				<span class="cm">/* If it is set, immediately set ACM control bit to downgrading AC for passing WMM testplan. Annie, 2005-12-13.	*/</span>
				<span class="p">{</span>
					<span class="n">PACI_AIFSN</span>	<span class="n">pAciAifsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">PACI_AIFSN</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">);</span>
					<span class="n">AC_CODING</span>	<span class="n">eACI</span> <span class="o">=</span> <span class="n">pAciAifsn</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">ACI</span><span class="p">;</span>

					<span class="cm">/*for 8187B AsynIORead issue */</span>
					<span class="n">u8</span>	<span class="n">AcmCtrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pAciAifsn</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">ACM</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* ACM bit is 1. */</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">eACI</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="n">AC0_BE</span>:
							<span class="n">AcmCtrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BEQ_ACM_EN</span><span class="o">|</span><span class="n">BEQ_ACM_CTL</span><span class="o">|</span><span class="n">ACM_HW_EN</span><span class="p">);</span> <span class="cm">/* or 0x21 */</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="n">AC2_VI</span>:
							<span class="n">AcmCtrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VIQ_ACM_EN</span><span class="o">|</span><span class="n">VIQ_ACM_CTL</span><span class="o">|</span><span class="n">ACM_HW_EN</span><span class="p">);</span> <span class="cm">/* or 0x42 */</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="n">AC3_VO</span>:
							<span class="n">AcmCtrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VOQ_ACM_EN</span><span class="o">|</span><span class="n">VOQ_ACM_CTL</span><span class="o">|</span><span class="n">ACM_HW_EN</span><span class="p">);</span> <span class="cm">/* or 0x84 */</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="nl">default:</span>
							<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;SetHwReg8185(): [HW_VAR_ACM_CTRL] ACM set failed: eACI is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eACI</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* ACM bit is 0. */</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">eACI</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="n">AC0_BE</span>:
							<span class="n">AcmCtrl</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">~</span><span class="n">BEQ_ACM_EN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BEQ_ACM_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ACM_HW_EN</span><span class="p">));</span> <span class="cm">/* and 0xDE */</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="n">AC2_VI</span>:
							<span class="n">AcmCtrl</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">~</span><span class="n">VIQ_ACM_EN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">VIQ_ACM_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ACM_HW_EN</span><span class="p">));</span> <span class="cm">/* and 0xBD */</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="n">AC3_VO</span>:
							<span class="n">AcmCtrl</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">~</span><span class="n">VOQ_ACM_EN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">VOQ_ACM_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ACM_HW_EN</span><span class="p">));</span> <span class="cm">/* and 0x7B */</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="nl">default:</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ACM_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ActSetWirelessMode8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">btWirelessMode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>  <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span>  <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">btSupportedWirelessMode</span> <span class="o">=</span> <span class="n">GetSupportedWirelessMode8185</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">btWirelessMode</span> <span class="o">&amp;</span> <span class="n">btSupportedWirelessMode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="p">{</span>
		<span class="cm">/* Don&#39;t switch to unsupported wireless mode, 2006.02.15, by rcnjko. */</span>
		<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;ActSetWirelessMode8185(): WirelessMode(%d) is not supported (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">btWirelessMode</span><span class="p">,</span> <span class="n">btSupportedWirelessMode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 1. Assign wireless mode to switch if necessary. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btWirelessMode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">btSupportedWirelessMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_A</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">btWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">btSupportedWirelessMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_G</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">btWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">btSupportedWirelessMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_B</span><span class="p">))</span>	<span class="p">{</span>
				<span class="n">btWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;ActSetWirelessMode8185(): No valid wireless mode supported, btSupportedWirelessMode(%x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">btSupportedWirelessMode</span><span class="p">);</span>
			<span class="n">btWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* </span>
<span class="cm"> 	 * 2. Swtich band: RF or BB specific actions,</span>
<span class="cm">	 * for example, refresh tables in omc8255, or change initial gain if necessary.</span>
<span class="cm">	 * Nothing to do for Zebra to switch band.</span>
<span class="cm">	 * Update current wireless mode if we switch to specified band successfully. </span>
<span class="cm">	 */</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIRELESS_MODE</span><span class="p">)</span><span class="n">btWirelessMode</span><span class="p">;</span>

	<span class="cm">/* 3. Change related setting. */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_A</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;WIRELESS_MODE_A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_B</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;WIRELESS_MODE_B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_G</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;WIRELESS_MODE_G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ActUpdateChannelAccessSetting</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelAccessSetting</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185b_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IMR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">IntrMask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DrvIFIndicateDisassociation</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
		<span class="cm">/* nothing is needed after disassociation request. */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MgntDisconnectIBSS</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DrvIFIndicateDisassociation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">unspec_reason</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>



	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Stop Beacon.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Vista add a Adhoc profile, HW radio off until OID_DOT11_RESET_REQUEST</span>
<span class="cm">	 *	Driver would set MSR=NO_LINK, then HW Radio ON, MgntQueue Stuck.</span>
<span class="cm">	 *	Because Bcn DMA isn&#39;t complete, mgnt queue would stuck until Bcn packet send.</span>
<span class="cm">	 *</span>
<span class="cm">	 *	Disable Beacon Queue Own bit, suggested by jong	</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_stop_send_beacons</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MlmeDisassociateRequest</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">asSta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">SendDisassociation</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">asSta</span><span class="p">,</span> <span class="n">asRsn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">asSta</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ShuChen TODO: change media status. */</span>
		<span class="cm">/* ShuChen TODO: What to do when disassociate. */</span>
		<span class="n">DrvIFIndicateDisassociation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">unspec_reason</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>

		<span class="n">ieee80211_disassociate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">MgntDisconnectAP</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Commented out by rcnjko, 2005.01.27:</span>
<span class="cm">	 * I move SecClearAllKeys() to MgntActSet_802_11_DISASSOCIATE().</span>
<span class="cm">	 *</span>
<span class="cm">	 *	2004/09/15, kcwu, the key should be cleared, or the new handshaking will not success</span>
<span class="cm">	 *</span>
<span class="cm">	 *	In WPA WPA2 need to Clear all key ... because new key will set after new handshaking.</span>
<span class="cm">	 *	2004.10.11, by rcnjko. </span>
<span class="cm">	 */</span>
	<span class="n">MlmeDisassociateRequest</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">asRsn</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">MgntDisconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Schedule an workitem to wake up for ps mode, 070109, by rcnjko.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">))</span>
		<span class="n">Dot11d_Reset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="cm">/* In adhoc mode, update beacon frame. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">MgntDisconnectIBSS</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm"> 			 * 	We clear key here instead of MgntDisconnectAP() because that</span>
<span class="cm">			 *	MgntActSet_802_11_DISASSOCIATE() is an interface called by OS,</span>
<span class="cm">			 *	e.g. OID_802_11_DISASSOCIATE in Windows while as MgntDisconnectAP() is</span>
<span class="cm">			 *	used to handle disassociation related things to AP, e.g. send Disassoc</span>
<span class="cm">			 *	frame to AP.  2005.01.27, by rcnjko. </span>
<span class="cm">			 */</span>
			<span class="n">MgntDisconnectAP</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">asRsn</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Indicate Disconnect, 2005.02.23, by rcnjko.	*/</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *		Chang RF Power State.</span>
<span class="cm"> *		Note that, only MgntActSet_RF_State() is allowed to set HW_VAR_RF_STATE.</span>
<span class="cm"> *</span>
<span class="cm"> *	Assumption:</span>
<span class="cm"> *		PASSIVE LEVEL.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">SetRFPowerState</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">RT_RF_POWER_STATE</span> <span class="n">eRFPowerState</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span>	<span class="n">bResult</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bResult</span><span class="p">;</span>

	<span class="n">bResult</span> <span class="o">=</span> <span class="n">SetZebraRFPowerState8185</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eRFPowerState</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bResult</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HalEnableRx8185Dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HalDisableRx8185Dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">MgntActSet_RF_State</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">RT_RF_POWER_STATE</span> <span class="n">StateToSet</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ChangeSource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span>	<span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span>	<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bConnectBySSID</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">RT_RF_POWER_STATE</span> <span class="n">rtState</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">RFWaitCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Prevent the race condition of RF state change. By Bruce, 2007-11-28.</span>
<span class="cm">	 *	Only one thread can change the RF state at one time, and others should wait to be executed.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="cm">/*  Set RF after the previous action is done.	*/</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RFWaitCounter</span><span class="o">++</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* 1 ms	*/</span>

				<span class="cm">/* Wait too long, return FALSE to avoid to be stuck here. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">RFWaitCounter</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 1sec */</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MgntActSet_RF_State(): Wait too long to set RF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="cm">/* TODO: Reset RF state? */</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtState</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">StateToSet</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eRfOn</span>:
		<span class="cm">/*</span>
<span class="cm">		 *	Turn On RF no matter the IPS setting because we need to update the RF state to Ndis under Vista, or</span>
<span class="cm">		 *	the Windows does not allow the driver to perform site survey any more. By Bruce, 2007-10-02.</span>
<span class="cm">		 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">ChangeSource</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfOff</span> <span class="o">&amp;&amp;</span> <span class="n">ChangeSource</span> <span class="o">&gt;=</span> <span class="n">RF_CHANGE_BY_HW</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInHctTest</span><span class="p">)</span>
				<span class="n">bConnectBySSID</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">eRfOff</span>:
		 <span class="cm">/* 070125, rcnjko: we always keep connected in AP mode. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">&gt;</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *	060808, Annie:</span>
<span class="cm">			 *	Disconnect to current BSS when radio off. Asked by QuanTa.</span>
<span class="cm">			 *</span>
<span class="cm">			 *	Calling MgntDisconnect() instead of MgntActSet_802_11_DISASSOCIATE(),</span>
<span class="cm">			 *	because we do NOT need to set ssid to dummy ones.</span>
<span class="cm">			 */</span>
			<span class="n">MgntDisconnect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">disas_lv_ss</span><span class="p">);</span>
			<span class="cm">/* Clear content of bssDesc[] and bssDesc4Query[] to avoid reporting old bss to UI. */</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">|=</span> <span class="n">ChangeSource</span><span class="p">;</span>
		<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eRfSleep</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">|=</span> <span class="n">ChangeSource</span><span class="p">;</span>
		<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bActionAllowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Config HW to the specified mode. */</span>
		<span class="n">SetRFPowerState</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">StateToSet</span><span class="p">);</span>

		<span class="cm">/* Turn on RF.	*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StateToSet</span> <span class="o">==</span> <span class="n">eRfOn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HalEnableRx8185Dummy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bConnectBySSID</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* by amy not supported	*/</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Turn off RF.	*/</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">StateToSet</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span>
			<span class="n">HalDisableRx8185Dummy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* Release RF spinlock	*/</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bActionAllowed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">InactivePowerSave</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *	This flag &quot;bSwRfProcessing&quot;, indicates the status of IPS procedure, should be set if the IPS workitem</span>
<span class="cm">	 *	is really scheduled.</span>
<span class="cm">	 *	The old code, sets this flag before scheduling the IPS workitem and however, at the same time the</span>
<span class="cm">	 *	previous IPS workitem did not end yet, fails to schedule the current workitem. Thus, bSwRfProcessing</span>
<span class="cm">	 *	blocks the IPS procedure of switching RF.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwRfProcessing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eInactivePowerState</span><span class="p">,</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	To solve CAM values miss in RF OFF, rewrite CAM values after RF ON. By Bruce, 2007-09-20.</span>
<span class="cm">	 */</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwRfProcessing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Description:</span>
<span class="cm"> *		Enter the inactive power save mode. RF will be off</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">IPSEnter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RT_RF_POWER_STATE</span> <span class="n">rtState</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtState</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Do not enter IPS in the following conditions:</span>
<span class="cm">		 *	(1) RF is already OFF or Sleep</span>
<span class="cm">		 *	(2) bSwRfProcessing (indicates the IPS is still under going)</span>
<span class="cm">		 *	(3) Connected (only disconnected can trigger IPS)</span>
<span class="cm">		 *	(4) IBSS (send Beacon)</span>
<span class="cm">		 *	(5) AP mode (send Beacon)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfOn</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwRfProcessing</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eInactivePowerState</span> <span class="o">=</span> <span class="n">eRfOff</span><span class="p">;</span>
			<span class="n">InactivePowerSave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">IPSLeave</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RT_RF_POWER_STATE</span> <span class="n">rtState</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtState</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfOff</span> <span class="o">||</span> <span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfSleep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwRfProcessing</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">&lt;=</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eInactivePowerState</span> <span class="o">=</span> <span class="n">eRfOn</span><span class="p">;</span>
			<span class="n">InactivePowerSave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185b_adapter_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">SupportedWirelessMode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">InitWirelessMode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bInvalidWirelessMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmpu8</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">btCR9346</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">TmpU1b</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">btPSR</span><span class="p">;</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24e</span><span class="p">,</span> <span class="p">(</span><span class="n">BIT5</span><span class="o">|</span><span class="n">BIT6</span><span class="o">|</span><span class="n">BIT0</span><span class="p">));</span>
	<span class="n">rtl8180_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">HwConfigureRTL8185</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MAC0</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MAC4</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">,</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf3</span><span class="p">);</span> <span class="cm">/* default network type to &#39;No Link&#39; */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BcnItv</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AtimWnd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">PlatformIOWrite2Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FEMR</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WPA_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">MacConfig_85BASIC</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Override the RFSW_CTRL (MAC offset 0x272-0x273), 2006.06.07, by rcnjko. */</span>
	<span class="cm">/* BT_DEMO_BOARD type */</span>
	<span class="n">PlatformIOWrite2Byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFSW_CTRL</span><span class="p">,</span> <span class="mh">0x569a</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *---------------------------------------------------------------------------</span>
<span class="cm">	 *	Set up PHY related.</span>
<span class="cm">	 *---------------------------------------------------------------------------</span>
<span class="cm">	 */</span>
	<span class="cm">/* Enable Config3.PARAM_En to revise AnaaParm. */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span> <span class="cm">/* enable config register write */</span>
	<span class="n">tmpu8</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="p">(</span><span class="n">tmpu8</span> <span class="o">|</span> <span class="n">CONFIG3_PARM_En</span><span class="p">));</span>
	<span class="cm">/* Turn on Analog power. */</span>
	<span class="cm">/* Asked for by William, otherwise, MAC 3-wire can&#39;t work, 2006.06.27, by rcnjko. */</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANAPARAM2</span><span class="p">,</span> <span class="n">ANAPARM2_ASIC_ON</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANAPARAM</span><span class="p">,</span> <span class="n">ANAPARM_ASIC_ON</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANAPARAM3</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="n">tmpu8</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* enable EEM0 and EEM1 in 9346CR */</span>
	<span class="n">btCR9346</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">,</span> <span class="p">(</span><span class="n">btCR9346</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">));</span>

	<span class="cm">/* B cut use LED1 to control HW RF on/off */</span>
	<span class="n">TmpU1b</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG5</span><span class="p">);</span>
	<span class="n">TmpU1b</span> <span class="o">=</span> <span class="n">TmpU1b</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT3</span><span class="p">;</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG5</span><span class="p">,</span> <span class="n">TmpU1b</span><span class="p">);</span>

	<span class="cm">/* disable EEM0 and EEM1 in 9346CR */</span>
	<span class="n">btCR9346</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xC0</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">,</span> <span class="n">btCR9346</span><span class="p">);</span>

	<span class="cm">/* Enable Led (suggested by Jong) */</span>
	<span class="cm">/* B-cut RF Radio on/off  5e[3]=0 */</span>
	<span class="n">btPSR</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">btPSR</span> <span class="o">|</span> <span class="n">BIT3</span><span class="p">));</span>
	<span class="cm">/* setup initial timing for RFE. */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">);</span>
	<span class="n">SetOutputEnableOfRfPins</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">,</span> <span class="mh">0x2488</span><span class="p">);</span>

	<span class="cm">/* PHY config. */</span>
	<span class="n">PhyConfig8185</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	We assume RegWirelessMode has already been initialized before,</span>
<span class="cm">	 *	however, we has to validate the wireless mode here and provide a</span>
<span class="cm">	 *	reasonable initialized value if necessary. 2005.01.13, by rcnjko.</span>
<span class="cm">	 */</span>
	<span class="n">SupportedWirelessMode</span> <span class="o">=</span> <span class="n">GetSupportedWirelessMode8185</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WIRELESS_MODE_A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* It should be one of B, G, A, or AUTO. */</span>
		<span class="n">bInvalidWirelessMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* One of B, G, A, or AUTO. */</span>
		<span class="cm">/* Check if the wireless mode is supported by RF. */</span>
		<span class="k">if</span>	<span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SupportedWirelessMode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bInvalidWirelessMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bInvalidWirelessMode</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Auto or other invalid value. */</span>
		<span class="cm">/* Assigne a wireless mode to initialize. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">SupportedWirelessMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_A</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">InitWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">SupportedWirelessMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_G</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">InitWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">SupportedWirelessMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_B</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">InitWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;InitializeAdapter8185(): No valid wireless mode supported, SupportedWirelessMode(%x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">SupportedWirelessMode</span><span class="p">);</span>
			<span class="n">InitWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize RegWirelessMode if it is not a valid one.	*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bInvalidWirelessMode</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIRELESS_MODE</span><span class="p">)</span><span class="n">InitWirelessMode</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* One of B, G, A. */</span>
		<span class="n">InitWirelessMode</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">=</span> <span class="n">eRfOff</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eRfOn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 *	If inactive power mode is enabled, disable rf while in disconnected state.</span>
<span class="cm">		 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span><span class="p">)</span>
		<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">dev</span> <span class="p">,</span> <span class="n">eRfOff</span><span class="p">,</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">);</span>

	<span class="n">ActSetWirelessMode8185</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">InitWirelessMode</span><span class="p">));</span>

	<span class="cm">/* ----------------------------------------------------------------------------- */</span>

	<span class="n">rtl8185b_irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185b_rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="cm">/* for now we accept data, management &amp; ctl frame*/</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;NIC in promisc mode&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span> <span class="o">||</span> \
	   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">RCR_APM</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">|</span> <span class="n">RCR_AAP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">|</span> <span class="n">RCR_ACF</span> <span class="o">|</span> <span class="n">RCR_APWRMGT</span> <span class="o">|</span> <span class="n">RCR_AICV</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">|</span> <span class="n">RCR_ACRC32</span><span class="p">;</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span><span class="p">);</span>

	<span class="n">fix_rx_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_RX_ENABLE_SHIFT</span><span class="p">));</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185b_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TCR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">TransmitConfig</span><span class="p">);</span>
	<span class="n">byte</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">);</span>
	<span class="n">byte</span> <span class="o">|=</span> <span class="n">MSR_LINK_ENEDCA</span><span class="p">;</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="n">fix_tx_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_TX_ENABLE_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
