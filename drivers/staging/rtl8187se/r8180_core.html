<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › r8180_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>r8180_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   This is part of rtl818x pci OpenSource driver - v 0.1</span>
<span class="cm">   Copyright (C) Andrea Merello 2004-2005  &lt;andreamrl@tiscali.it&gt;</span>
<span class="cm">   Released under the terms of GPL (General Public License)</span>

<span class="cm">   Parts of this driver are based on the GPL part of the official</span>
<span class="cm">   Realtek driver.</span>

<span class="cm">   Parts of this driver are based on the rtl8180 driver skeleton</span>
<span class="cm">   from Patric Schenke &amp; Andres Salomon.</span>

<span class="cm">   Parts of this driver are based on the Intel Pro Wireless 2100 GPL driver.</span>

<span class="cm">   Parts of BB/RF code are derived from David Young rtl8180 netbsd driver.</span>

<span class="cm">   RSSI calc function from &#39;The Deuce&#39;</span>

<span class="cm">   Some ideas borrowed from the 8139too.c driver included in linux kernel.</span>

<span class="cm">   We (I?) want to thanks the Authors of those projecs and also the</span>
<span class="cm">   Ndiswrapper&#39;s project Authors.</span>

<span class="cm">   A big big thanks goes also to Realtek corp. for their help in my attempt to</span>
<span class="cm">   add RTL8185 and RTL8225 support, and to David Young also.</span>

<span class="cm">   Power management interface routines.</span>
<span class="cm">   Written by Mariusz Matuszek.</span>
<span class="cm">*/</span>

<span class="cp">#undef RX_DONT_PASS_UL</span>
<span class="cp">#undef DUMMY_RX</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/eeprom_93cx6.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;r8180_hw.h&quot;</span>
<span class="cp">#include &quot;r8180.h&quot;</span>
<span class="cp">#include &quot;r8180_rtl8225.h&quot; </span><span class="cm">/* RTL8225 Radio frontend */</span><span class="cp"></span>
<span class="cp">#include &quot;r8180_93cx6.h&quot;   </span><span class="cm">/* Card EEPROM */</span><span class="cp"></span>
<span class="cp">#include &quot;r8180_wx.h&quot;</span>
<span class="cp">#include &quot;r8180_dm.h&quot;</span>

<span class="cp">#include &quot;ieee80211/dot11d.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">rtl8180_pci_id_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_REALTEK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="mh">0x8199</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">char</span> <span class="n">ifname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwseqnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwwep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">rtl8180_pci_id_tbl</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andrea Merello &lt;andreamrl@tiscali.it&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux driver for Realtek RTL8180 / RTL8185 WiFi cards&quot;</span><span class="p">);</span>


<span class="n">module_param_string</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifname</span><span class="p">),</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hwseqnum</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hwwep</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot; Net interface name, wlan%d=default&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwseqnum</span><span class="p">,</span> <span class="s">&quot; Try to use hardware 802.11 header sequence numbers. Zero=default&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwwep</span><span class="p">,</span> <span class="s">&quot; Try to use hardware WEP support. Still broken and not available on all cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="s">&quot; Channel bitmask for specific locales. NYI&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">rtl8180_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">rtl8180_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8180_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_stop</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8180_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_pci_suspend</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_stop</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out_pci_suspend:</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8180_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: pci_enable_device failed on resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Suspend/Resume resets the PCI configuration space, so we have to</span>
<span class="cm">	 * re-disable the RETRY_TIMEOUT register (0x41) to keep PCI Tx retries</span>
<span class="cm">	 * from interfering with C3 CPU state. pci_restore_state won&#39;t help</span>
<span class="cm">	 * here since it only restores the first 64 bytes pci config header.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_open</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span><span class="o">-&gt;</span><span class="n">ndo_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">rtl8180_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">RTL8180_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rtl8180_pci_id_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rtl8180_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">rtl8180_pci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">rtl8180_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">rtl8180_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">rtl8180_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">u8</span> <span class="nf">read_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0xff</span><span class="o">&amp;</span><span class="n">readb</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">read_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">read_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u8</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">force_pci_posting</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="n">rtl8180_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">set_nic_rxring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">set_nic_txring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">rtl8180_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_start_tx_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">rtl8180_proc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_registers</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
			  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* This dump the current register page */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">max</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">D:  %2x &gt; &quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%2x &quot;</span><span class="p">,</span>
					<span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">get_curr_tx_free_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_stats_hw</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
			  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_stats_rx</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
			  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;RX OK: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;RX Retry: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;RX CRC Error(0-500): %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;RX CRC Error(500-1000): %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;RX CRC Error(&gt;1000): %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;RX ICV Error: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxint</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmin</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmid</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmax</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxicverr</span>
		<span class="p">);</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_stats_tx</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
			  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">totalOK</span><span class="p">;</span>

	<span class="n">totalOK</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txnpokint</span><span class="o">+</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txhpokint</span><span class="o">+</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txlpokint</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;TX OK: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX Error: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX Retry: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX beacon OK: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX beacon error: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">totalOK</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txnperr</span><span class="o">+</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txhperr</span><span class="o">+</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txlperr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txretry</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeacon</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeaconerr</span>
	<span class="p">);</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_proc_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Initializing proc filesystem&quot;</span><span class="p">);</span>
	<span class="n">rtl8180_proc</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">RTL8180_MODULE_NAME</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_proc_module_remove</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">RTL8180_MODULE_NAME</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_proc_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;stats-hw&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;stats-tx&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;stats-rx&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rtl8180_proc</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_proc_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span> <span class="o">=</span> <span class="n">rtl8180_proc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to initialize /proc/net/r8180/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;stats-hw&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_stats_hw</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/r8180/%s/stats-hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;stats-rx&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_stats_rx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/r8180/%s/stats-rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;stats-tx&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_stats_tx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/r8180/%s/stats-tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_registers</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/r8180/%s/registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  FIXME: check if we can use some standard already-existent</span>
<span class="cm">  data type+functions in kernel</span>
<span class="cm">*/</span>

<span class="kt">short</span> <span class="nf">buffer_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span> <span class="o">**</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">buffer</span> <span class="o">**</span><span class="n">bufferhead</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>

		<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Failed to kmalloc head of TX/RX struct&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bufferhead</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="n">bufferhead</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">))</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Failed to kmalloc TX/RX struct&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer</span> <span class="o">**</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">short</span> <span class="n">consistent</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">consistent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				    <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
			<span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

	<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_buffer</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ASCII BUFFER DUMP (len: %x):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">BINARY BUFFER DUMP (len: %x):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_curr_tx_free_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MANAGE_PRIORITY</span>:
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringhead</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringtail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BK_PRIORITY</span>:
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringhead</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringtail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_PRIORITY</span>:
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringhead</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringtail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VI_PRIORITY</span>:
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringhead</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringtail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VO_PRIORITY</span>:
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringhead</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringtail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HI_PRIORITY</span>:
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringhead</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringtail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">&lt;=</span> <span class="n">tail</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span> <span class="o">-</span> <span class="p">(</span><span class="n">tail</span> <span class="o">-</span> <span class="n">head</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">tail</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">)</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;BUG&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">check_nic_enought_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">requiredbyte</span><span class="p">,</span> <span class="n">required</span><span class="p">;</span>

	<span class="n">requiredbyte</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_header_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">QoS_Enable</span><span class="p">)</span>
		<span class="n">requiredbyte</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">required</span> <span class="o">=</span> <span class="n">requiredbyte</span> <span class="o">/</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">requiredbyte</span> <span class="o">%</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">)</span>
		<span class="n">required</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* for now we keep two free descriptor as a safety boundary</span>
<span class="cm">	 * between the tail and the head</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">required</span><span class="o">+</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">get_curr_tx_free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priority</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fix_tx_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconring</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconcount</span><span class="p">;</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringhead</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapbufstail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapbufs</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringhead</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpbufstail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpbufs</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringhead</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepbufstail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepbufs</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringhead</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipbufstail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipbufs</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringhead</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopbufstail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopbufs</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringhead</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpbufstail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpbufs</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconbufstail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconbufs</span><span class="p">;</span>
	<span class="n">set_nic_txring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ieee80211_reset_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fix_rx_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_desc_size</span><span class="p">;</span>

	<span class="n">rx_desc_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 4*8 = 32 bytes */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">,</span> <span class="n">rxbuf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbufferhead</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">)</span><span class="o">*</span><span class="n">rx_desc_size</span><span class="p">);</span>
	     <span class="n">tmp</span> <span class="o">+=</span> <span class="n">rx_desc_size</span><span class="p">,</span> <span class="n">rxbuf</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbufferhead</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_nic_rxring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">QUALITY_MAP</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span>
	<span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span>
	<span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span>
	<span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">STRENGTH_MAP</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span>
	<span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span>
	<span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span>
	<span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">rtl8180_RSSI_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rssi</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">qual</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_qual</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">_rssi</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">*</span><span class="n">qual</span><span class="p">;</span>
	<span class="n">orig_qual</span> <span class="o">=</span> <span class="o">*</span><span class="n">qual</span><span class="p">;</span>
	<span class="n">_rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* avoid gcc complains.. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&lt;=</span> <span class="mh">0x4e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">QUALITY_MAP</span><span class="p">[</span><span class="n">q</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mh">0x32</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">qual</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">temp2</span> <span class="o">=</span> <span class="o">*</span><span class="n">rssi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_rssi</span> <span class="o">&lt;</span> <span class="mh">0x64</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_rssi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">rssi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">rssi</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INTA_MASK</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ecmd</span><span class="p">;</span>

	<span class="n">ecmd</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">);</span>
	<span class="n">ecmd</span> <span class="o">=</span> <span class="n">ecmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EPROM_CMD_OPERATING_MODE_MASK</span><span class="p">;</span>
	<span class="n">ecmd</span> <span class="o">=</span> <span class="n">ecmd</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">&lt;&lt;</span><span class="n">EPROM_CMD_OPERATING_MODE_SHIFT</span><span class="p">);</span>
	<span class="n">ecmd</span> <span class="o">=</span> <span class="n">ecmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EPROM_CS_SHIFT</span><span class="p">);</span>
	<span class="n">ecmd</span> <span class="o">=</span> <span class="n">ecmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EPROM_CK_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">rtl8180_adapter_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_beacon_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtl8180_update_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxconf</span><span class="p">;</span>

	<span class="n">msr</span>  <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">);</span>
	<span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_LINK_MASK</span><span class="p">;</span>

	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_CONF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_ADHOC</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
			<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_MASTER</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
			<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_MANAGED</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_NONE</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="n">rxconf</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">RX_CHECK_BSSID_SHIFT</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_NONE</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="n">rxconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">RX_CHECK_BSSID_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_CONF</span><span class="p">,</span> <span class="n">rxconf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_set_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;In %s: Invalid chnanel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxconf</span><span class="p">;</span>
	<span class="cm">/* for now we accept data, management &amp; ctl frame*/</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_CONF</span><span class="p">);</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_FILTER_MASK</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_MNG_FRAME_SHIFT</span><span class="p">);</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_DATA_FRAME_SHIFT</span><span class="p">);</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_BCAST_FRAME_SHIFT</span><span class="p">);</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_MCAST_FRAME_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;NIC in promisc mode&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span> <span class="o">||</span> \
	   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_ALLMAC_FRAME_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_NICMAC_FRAME_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_CTL_FRAME_SHIFT</span><span class="p">);</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_ICVERR_FRAME_SHIFT</span><span class="p">);</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_PWR_FRAME_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">ACCEPT_CRCERR_FRAME_SHIFT</span><span class="p">);</span>

	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RX_FIFO_THRESHOLD_MASK</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">RX_FIFO_THRESHOLD_NONE</span> <span class="o">&lt;&lt;</span> <span class="n">RX_FIFO_THRESHOLD_SHIFT</span><span class="p">);</span>

	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">RX_AUTORESETPHY_SHIFT</span><span class="p">);</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAX_RX_DMA_MASK</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">MAX_RX_DMA_2048</span><span class="o">&lt;&lt;</span><span class="n">MAX_RX_DMA_SHIFT</span><span class="p">);</span>

	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_ONLYERLPKT</span><span class="p">;</span>

	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RCR_CS_MASK</span><span class="p">;</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_CONF</span><span class="p">,</span> <span class="n">rxconf</span><span class="p">);</span>

	<span class="n">fix_rx_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_RX_ENABLE_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_nic_txring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_MANAGEPRIORITY_RING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringdma</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BKPRIORITY_RING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringdma</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BEPRIORITY_RING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringdma</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_VIPRIORITY_RING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringdma</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_VOPRIORITY_RING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringdma</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_HIGHPRIORITY_RING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringdma</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BEACON_RING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconringdma</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_conttx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">txconf</span><span class="p">;</span>

	<span class="n">txconf</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_CONF</span><span class="p">);</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TX_LOOPBACK_MASK</span><span class="p">;</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">TX_LOOPBACK_CONTINUE</span><span class="o">&lt;&lt;</span><span class="n">TX_LOOPBACK_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_CONF</span><span class="p">,</span> <span class="n">txconf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_conttx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">txconf</span><span class="p">;</span>

	<span class="n">txconf</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_CONF</span><span class="p">);</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TX_LOOPBACK_MASK</span><span class="p">;</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">TX_LOOPBACK_NONE</span><span class="o">&lt;&lt;</span><span class="n">TX_LOOPBACK_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_CONF</span><span class="p">,</span> <span class="n">txconf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_agc_ctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txconf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">txconf</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_CONF</span><span class="p">);</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CW_CONF</span><span class="p">);</span>
	<span class="n">byte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CW_CONF_PERPACKET_CW_SHIFT</span><span class="p">);</span>
	<span class="n">byte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CW_CONF_PERPACKET_RETRY_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CW_CONF</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="n">tx_agc_ctl</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_AGC_CTL</span><span class="p">);</span>
	<span class="n">tx_agc_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">TX_AGC_CTL_PERPACKET_GAIN_SHIFT</span><span class="p">);</span>
	<span class="n">tx_agc_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">TX_AGC_CTL_PERPACKET_ANTSEL_SHIFT</span><span class="p">);</span>
	<span class="n">tx_agc_ctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">TX_AGC_CTL_FEEDBACK_ANT</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_AGC_CTL</span><span class="p">,</span> <span class="n">tx_agc_ctl</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span> <span class="cm">/* Disable early TX */</span>

	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">TCR_PROBE_NOTIMESTAMP_SHIFT</span><span class="p">);</span>

	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TX_LOOPBACK_MASK</span><span class="p">;</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">TX_LOOPBACK_NONE</span><span class="o">&lt;&lt;</span><span class="n">TX_LOOPBACK_SHIFT</span><span class="p">);</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TCR_DPRETRY_MASK</span><span class="p">;</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TCR_RTSRETRY_MASK</span><span class="p">;</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_data</span><span class="o">&lt;&lt;</span><span class="n">TX_DPRETRY_SHIFT</span><span class="p">);</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_rts</span><span class="o">&lt;&lt;</span><span class="n">TX_RTSRETRY_SHIFT</span><span class="p">);</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">TX_NOCRC_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_plcp_len</span><span class="p">)</span>
		<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TCR_PLCP_LEN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="n">TCR_PLCP_LEN</span><span class="p">;</span>

	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TCR_MXDMA_MASK</span><span class="p">;</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">TCR_MXDMA_2048</span><span class="o">&lt;&lt;</span><span class="n">TCR_MXDMA_SHIFT</span><span class="p">);</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="n">TCR_CWMIN</span><span class="p">;</span>
	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="n">TCR_DISCW</span><span class="p">;</span>

	<span class="n">txconf</span> <span class="o">=</span> <span class="n">txconf</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TX_NOICV_SHIFT</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_CONF</span><span class="p">,</span> <span class="n">txconf</span><span class="p">);</span>

	<span class="n">fix_tx_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_TX_ENABLE_SHIFT</span><span class="p">));</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_CONF</span><span class="p">,</span> <span class="n">txconf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_beacon_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TPPOLLSTOP_BQ</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TPPollStop</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_mask</span><span class="p">);</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_beacon_tx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span> <span class="o">|=</span> <span class="n">TPPOLLSTOP_BQ</span><span class="p">;</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TPPollStop</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span><span class="p">);</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_rtx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="o">~</span>\
		       <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_RX_ENABLE_SHIFT</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_TX_ENABLE_SHIFT</span><span class="p">)));</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">alloc_tx_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_desc</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bufsize</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bufsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;TX buffer allocation too large&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_desc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * descriptor&#39;s buffer must be 256 byte aligned</span>
<span class="cm">		 * we shouldn&#39;t be here, since we set DMA mask !</span>
<span class="cm">		 */</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DMA buffer is not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TX_MANAGEPRIORITY_RING_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapbufs</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem for buffer NP&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TX_BKPRIORITY_RING_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpbufs</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem for buffer LP&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TX_BEPRIORITY_RING_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepbufs</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem for buffer NP&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TX_VIPRIORITY_RING_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipbufs</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem for buffer LP&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TX_VOPRIORITY_RING_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopbufs</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem for buffer NP&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TX_HIGHPRIORITY_RING_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpbufs</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem for buffer HP&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TX_BEACON_RING_ADDR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconbufs</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem for buffer BP&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span> <span class="cm">/* descriptor empty, owned by the drv */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dma_tmp</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">bufsize</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dma_desc</span><span class="o">+</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dma_desc</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">+</span><span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_MANAGEPRIORITY_RING_ADDR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_BKPRIORITY_RING_ADDR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_BEPRIORITY_RING_ADDR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_VIPRIORITY_RING_ADDR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_VOPRIORITY_RING_ADDR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_HIGHPRIORITY_RING_ADDR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_BEACON_RING_ADDR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">free_tx_desc_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringdma</span><span class="p">);</span>
	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapbufs</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringdma</span><span class="p">);</span>
	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpbufs</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringdma</span><span class="p">);</span>
	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepbufs</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringdma</span><span class="p">);</span>
	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipbufs</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringdma</span><span class="p">);</span>
	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopbufs</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringdma</span><span class="p">);</span>
	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpbufs</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconcount</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconringdma</span><span class="p">);</span>
	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconbufs</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">free_rx_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringdma</span><span class="p">);</span>

	<span class="n">buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">alloc_rx_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_desc</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_desc_size</span><span class="p">;</span>

	<span class="n">rx_desc_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 4*8 = 32 bytes */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bufsize</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bufsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;RX buffer allocation too large&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">rx_desc_size</span><span class="o">*</span><span class="n">count</span><span class="o">+</span><span class="mi">256</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">dma_desc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_desc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * descriptor&#39;s buffer must be 256 byte aligned</span>
<span class="cm">		 * should never happen since we specify the DMA mask</span>
<span class="cm">		 */</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DMA buffer is not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringdma</span> <span class="o">=</span> <span class="n">dma_desc</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">bufsize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Failed to kmalloc RX buffer&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_tmp</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buffer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dma_tmp</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbufferhead</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Unable to allocate mem RX buf&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* zero pads the header of the descriptor */</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">bufsize</span><span class="o">&amp;</span><span class="mh">0xfff</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dma_tmp</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span> <span class="cm">/* descriptor void, owned by the NIC */</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">+</span><span class="n">rx_desc_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">-</span><span class="n">rx_desc_size</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tmp</span><span class="o">-</span><span class="n">rx_desc_size</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">);</span> <span class="cm">/* this is the last descriptor */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">set_nic_rxring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pgreg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pgreg</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PGSELECT</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PGSELECT</span><span class="p">,</span> <span class="n">pgreg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">PGSELECT_PG_SHIFT</span><span class="p">));</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RXRING_ADDR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringdma</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cr</span><span class="p">;</span>

	<span class="n">rtl8180_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cr</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">cr</span> <span class="o">=</span> <span class="n">cr</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cr</span> <span class="o">=</span> <span class="n">cr</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_RST_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CMD_RST_SHIFT</span><span class="p">))</span>
		<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;Card reset timeout!&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Card successfully reset&quot;</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_LOAD</span><span class="p">);</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">u16</span> <span class="nf">ieeerate2rtlrate</span><span class="p">(</span><span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">20</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">55</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">110</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">60</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">90</span>:
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">180</span>:
		<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">240</span>:
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">360</span>:
		<span class="k">return</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">480</span>:
		<span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">540</span>:
		<span class="k">return</span> <span class="mi">11</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">rtl_rate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">540</span><span class="p">,</span> <span class="mi">720</span><span class="p">};</span>

<span class="kr">inline</span> <span class="n">u16</span> <span class="nf">rtl8180_rate2rate</span><span class="p">(</span><span class="kt">short</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rtl_rate</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">u8</span> <span class="nf">rtl8180_IsWirelessBMode</span><span class="p">(</span><span class="n">u16</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">110</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">90</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">220</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="n">N_DBPSOfRate</span><span class="p">(</span><span class="n">u16</span> <span class="n">DataRate</span><span class="p">);</span>

<span class="n">u16</span> <span class="nf">ComputeTxTime</span><span class="p">(</span><span class="n">u16</span> <span class="n">FrameLength</span><span class="p">,</span> <span class="n">u16</span> <span class="n">DataRate</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bManagementFrame</span><span class="p">,</span>
		  <span class="n">u8</span> <span class="n">bShortPreamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">FrameTime</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">N_DBPS</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">Ceiling</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8180_IsWirelessBMode</span><span class="p">(</span><span class="n">DataRate</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bManagementFrame</span> <span class="o">||</span> <span class="o">!</span><span class="n">bShortPreamble</span> <span class="o">||</span> <span class="n">DataRate</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
			<span class="cm">/* long preamble */</span>
			<span class="n">FrameTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mi">144</span><span class="o">+</span><span class="mi">48</span><span class="o">+</span><span class="p">(</span><span class="n">FrameLength</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">DataRate</span><span class="o">/</span><span class="mi">10</span><span class="p">)));</span>
		<span class="k">else</span>
			<span class="cm">/* short preamble */</span>
			<span class="n">FrameTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mi">72</span><span class="o">+</span><span class="mi">24</span><span class="o">+</span><span class="p">(</span><span class="n">FrameLength</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">DataRate</span><span class="o">/</span><span class="mi">10</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">FrameLength</span><span class="o">*</span><span class="mi">8</span> <span class="o">%</span> <span class="p">(</span><span class="n">DataRate</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* get the ceilling */</span>
			<span class="n">FrameTime</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* 802.11g DSSS-OFDM PLCP length field calculation. */</span>
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="n">N_DBPSOfRate</span><span class="p">(</span><span class="n">DataRate</span><span class="p">);</span>
		<span class="n">Ceiling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">FrameLength</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_DBPS</span>
				<span class="o">+</span> <span class="p">(((</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">FrameLength</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="n">N_DBPS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">FrameTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">Ceiling</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FrameTime</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">N_DBPSOfRate</span><span class="p">(</span><span class="n">u16</span> <span class="n">DataRate</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="n">u16</span> <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">DataRate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">60</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">90</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">180</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">240</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">360</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">144</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">480</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">540</span>:
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">216</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">N_DBPS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For Netgear case, they want good-looking signal strength.</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">NetgearSignalStrengthTranslate</span><span class="p">(</span><span class="kt">long</span> <span class="n">LastSS</span><span class="p">,</span> <span class="kt">long</span> <span class="n">CurrSS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">RetSS</span><span class="p">;</span>

	<span class="cm">/* Step 1. Scale mapping. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">71</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">+</span> <span class="p">((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">41</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">78</span> <span class="o">+</span> <span class="p">((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">66</span> <span class="o">+</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">30</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">21</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">54</span> <span class="o">+</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="p">(((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="n">CurrSS</span><span class="p">;</span>

	<span class="cm">/* Step 2. Smoothing. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LastSS</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="p">((</span><span class="n">LastSS</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">RetSS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">RetSS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Translate 0-100 signal strength index into dBm.</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">TranslateToDbm8185</span><span class="p">(</span><span class="n">u8</span> <span class="n">SignalStrengthIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">SignalPower</span><span class="p">;</span>

	<span class="cm">/* Translate to dBm (x=0.5y-95). */</span>
	<span class="n">SignalPower</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)((</span><span class="n">SignalStrengthIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">SignalPower</span> <span class="o">-=</span> <span class="mi">95</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SignalPower</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform signal smoothing for dynamic mechanism.</span>
<span class="cm"> * This is different with PerformSignalSmoothing8185 in smoothing formula.</span>
<span class="cm"> * No dramatic adjustion is apply because dynamic mechanism need some degree</span>
<span class="cm"> * of correctness. Ported from 8187B.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">PerformUndecoratedSignalSmoothing8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">bCckRate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Determin the current packet is CCK rate. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bCurCCKPkt</span> <span class="o">=</span> <span class="n">bCckRate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndecoratedSmoothedSS</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndecoratedSmoothedSS</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndecoratedSmoothedSS</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span>
					       <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndecoratedSmoothedSS</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndercorateSmoothedRxPower</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndercorateSmoothedRxPower</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span> <span class="o">+</span>
					    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RxPower</span> <span class="o">*</span> <span class="mi">11</span><span class="p">))</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bCckRate</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurCCKRSSI</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RSSI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurCCKRSSI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This is rough RX isr handling routine</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtl8180_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp_skb</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lastlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">quality</span><span class="p">,</span> <span class="n">signal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_desc_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rxpower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">RXAGC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">RxAGC_dBm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">LNA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">LNA_gain</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mo">02</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">39</span><span class="p">};</span>
	<span class="n">u8</span>  <span class="n">Antenna</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bHwError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bCRC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bICV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bCckRate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span>     <span class="n">RSSI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span>	<span class="n">SignalStrengthIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">98</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">IEEE80211_24GHZ_BAND</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">stats</span><span class="p">.</span><span class="n">nic_type</span> <span class="o">=</span> <span class="n">NIC_8185B</span><span class="p">;</span>
	<span class="n">rx_desc_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we have got an RX int, but the descriptor</span>
<span class="cm">		 * we are pointing is empty */</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxnodata</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="n">tmp2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">)</span>
				<span class="n">tmp</span>  <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rx_desc_size</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tmp</span> <span class="o">-=</span> <span class="n">rx_desc_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">)))</span>
				<span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* while there are filled descriptors */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">26</span><span class="p">))</span>
			<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;RX buffer overflow&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxicverr</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxdmafail</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* DMESG(&quot;EE: RX DMA FAILED at buffer pointed by descriptor %x&quot;,(u32)priv-&gt;rxringtail); */</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span> <span class="o">*</span> \
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
				    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">first</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">29</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_prevlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">last</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">28</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lastlen</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>

			<span class="cm">/* if the last descriptor (that should</span>
<span class="cm">			 * tell us the total packet len) tell</span>
<span class="cm">			 * us something less than the descriptors</span>
<span class="cm">			 * len we had until now, then there is some</span>
<span class="cm">			 * problem..</span>
<span class="cm">			 * workaround to prevent kernel panic</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lastlen</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_prevlen</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">lastlen</span><span class="o">-</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_prevlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmin</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmax</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmid</span><span class="o">++</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">padding</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x04000000</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">26</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">padding</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x04000000</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">26</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_prevlen</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_prevlen</span> <span class="o">&gt;</span> <span class="n">MAX_FRAG_THRESHOLD</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* HW is probably passing several buggy frames</span>
<span class="cm">			* without FD or LD flag set.</span>
<span class="cm">			* Throw this garbage away to prevent skb</span>
<span class="cm">			* memory exhausting</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span><span class="p">)</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00ff0000</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">signal</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">quality</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">));</span>

		<span class="n">stats</span><span class="p">.</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">rxpower</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span><span class="p">)(((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00ff0000</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">42</span><span class="p">;</span>
		<span class="n">RSSI</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span><span class="p">)(((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0000ff00</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x7f</span><span class="p">);</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">23</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">22</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">21</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">)))</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">;</span>

		<span class="n">stats</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rtl8180_rate2rate</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">Antenna</span> <span class="o">=</span> <span class="p">(((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00008000</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl8180_IsWirelessBMode</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">rate</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* OFDM rate. */</span>
			<span class="n">RxAGC_dBm</span> <span class="o">=</span> <span class="n">rxpower</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* bias */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* CCK rate. */</span>
			<span class="n">RxAGC_dBm</span> <span class="o">=</span> <span class="n">signal</span><span class="p">;</span> <span class="cm">/* bit 0 discard */</span>

			<span class="n">LNA</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">RxAGC_dBm</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* bit 6~ bit 5 */</span>
			<span class="n">BB</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">RxAGC_dBm</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span> <span class="cm">/* bit 4 ~ bit 0 */</span>

			<span class="n">RxAGC_dBm</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">LNA_gain</span><span class="p">[</span><span class="n">LNA</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">BB</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span> <span class="cm">/* Pin_11b=-(LNA_gain+BB_gain) (dBm) */</span>

			<span class="n">RxAGC_dBm</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* bias */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RxAGC_dBm</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="cm">/* absolute value */</span>
			<span class="n">RXAGC</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">RxAGC_dBm</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">bCckRate</span> <span class="o">=</span> <span class="n">rtl8180_IsWirelessBMode</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">rate</span><span class="p">);</span>
		<span class="cm">/* Translate RXAGC into 1-100. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl8180_IsWirelessBMode</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">rate</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* OFDM rate. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RXAGC</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">)</span>
				<span class="n">RXAGC</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RXAGC</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span>
				<span class="n">RXAGC</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
			<span class="n">RXAGC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span><span class="o">-</span><span class="n">RXAGC</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="mi">65</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* CCK rate. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RXAGC</span> <span class="o">&gt;</span> <span class="mi">95</span><span class="p">)</span>
				<span class="n">RXAGC</span> <span class="o">=</span> <span class="mi">95</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RXAGC</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span>
				<span class="n">RXAGC</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
			<span class="n">RXAGC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">95</span><span class="o">-</span><span class="n">RXAGC</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="mi">65</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">RXAGC</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span> <span class="o">=</span> <span class="n">RxAGC_dBm</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RxPower</span> <span class="o">=</span> <span class="n">rxpower</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RSSI</span> <span class="o">=</span> <span class="n">RSSI</span><span class="p">;</span>
		<span class="cm">/* SQ translation formula is provided by SD3 DZ. 2006.06.27 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">&gt;=</span> <span class="mi">127</span><span class="p">)</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/*0; */</span> <span class="cm">/* 0 will cause epc to show signal zero , walk around now; */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">quality</span> <span class="o">&lt;</span> <span class="mi">27</span><span class="p">)</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">-</span> <span class="n">quality</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>

		<span class="n">stats</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">quality</span><span class="p">;</span> <span class="cm">/*priv-&gt;wstats.qual.level = priv-&gt;SignalStrength; */</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">=</span> <span class="n">RXAGC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">=</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="mi">30</span><span class="p">;</span>
		<span class="cm">/* printk(&quot;==========================&gt;rx : RXAGC is %d,signalstrength is %d\n&quot;,RXAGC,stats.signalstrength); */</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalQuality</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span><span class="p">;</span>
		<span class="n">bHwError</span> <span class="o">=</span> <span class="p">(((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00000fff</span><span class="p">))</span> <span class="o">==</span> <span class="mi">4080</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x04000000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x08000000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10000000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(((</span><span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x20000000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bCRC</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00002000</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
		<span class="n">bICV</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00001000</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		    <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">!=</span> <span class="n">type</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">bHwError</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bCRC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bICV</span> <span class="o">&amp;&amp;</span>
		    <span class="n">eqMacAddr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
			<span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span> <span class="o">?</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span> <span class="o">:</span>
			<span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">?</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span> <span class="o">:</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* Perform signal smoothing for dynamic</span>
<span class="cm">			 * mechanism on demand. This is different</span>
<span class="cm">			 * with PerformSignalSmoothing8185 in smoothing</span>
<span class="cm">			 * fomula. No dramatic adjustion is apply</span>
<span class="cm">			 * because dynamic mechanism need some degree</span>
<span class="cm">			 * of correctness. */</span>
			<span class="n">PerformUndecoratedSignalSmoothing8185</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bCckRate</span><span class="p">);</span>

			<span class="cm">/* For good-looking singal strength. */</span>
			<span class="n">SignalStrengthIndex</span> <span class="o">=</span> <span class="n">NetgearSignalStrengthTranslate</span><span class="p">(</span>
							<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastSignalStrengthInPercent</span><span class="p">,</span>
							<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalStrength</span><span class="p">);</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastSignalStrengthInPercent</span> <span class="o">=</span> <span class="n">SignalStrengthIndex</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_SignalStrength</span> <span class="o">=</span> <span class="n">TranslateToDbm8185</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">SignalStrengthIndex</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need more correct power of received packets and the  &quot;SignalStrength&quot; of RxStats is beautified,</span>
<span class="cm">		 * so we record the correct power here.</span>
<span class="cm">		 */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_SignalQuality</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_SignalQuality</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_RecvSignalPower</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_RecvSignalPower</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>

		<span class="cm">/* Figure out which antenna that received the last packet. */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxPktAntenna</span> <span class="o">=</span> <span class="n">Antenna</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 0: aux, 1: main. */</span>
			<span class="n">SwAntennaDiversityRxOk8185</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalStrength</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* seems that HW sometimes fails to receive and</span>
<span class="cm">				   doesn&#39;t provide the last descriptor */</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxnolast</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* support for prism header has been originally added by Christian */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prism_hdr</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* if we are here we should have already RXed</span>
<span class="cm">			* the first frame.</span>
<span class="cm">			* If we get here and the skb is not allocated then</span>
<span class="cm">			* we have just throw out garbage (skb not allocated)</span>
<span class="cm">			* and we are still rxing garbage....</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">tmp_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_skb</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

				<span class="n">tmp_skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">tmp_skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>

				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">tmp_skb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
					<span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_rtl_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span> <span class="o">*</span> \
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
				    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

<span class="nl">drop:</span> <span class="cm">/* this is used when we have not enough mem */</span>
		<span class="cm">/* restore the descriptor */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">=</span>
			<span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">;</span>

		<span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">=</span>
			<span class="o">*</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span> <span class="o">+=</span> <span class="n">rx_desc_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span> <span class="o">&gt;=</span>
		   <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">)</span><span class="o">*</span><span class="n">rx_desc_size</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringtail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffer</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8180_dma_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_DMA_POLLING</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">priority</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_mask</span><span class="p">);</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_data_hard_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span> <span class="o">|=</span> <span class="n">TPPOLLSTOP_AC_VIQ</span><span class="p">;</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TPPollStop</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span><span class="p">);</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_data_hard_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TPPOLLSTOP_AC_VIQ</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TPPollStop</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_stop_mask</span><span class="p">);</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function TX data frames when the ieee80211 stack requires this.</span>
<span class="cm"> * It checks also if we need to stop the ieee tx queue, eventually do it</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtl8180_hard_data_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span>
<span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">morefrag</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">ieeerate2rtlrate</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * This function doesn&#39;t require lock because we make</span>
<span class="cm">	 * sure it&#39;s called with the tx_lock already acquired.</span>
<span class="cm">	 * this come from the kernel&#39;s hard_xmit callback (through</span>
<span class="cm">	 * the ieee stack, or from the try_wake_queue (again through</span>
<span class="cm">	 * the ieee stack.</span>
<span class="cm">	 */</span>
	<span class="n">priority</span> <span class="o">=</span> <span class="n">AC2Q</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_nic_enought_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priority</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;Error: no descriptor left by previous TX (avail %d) &quot;</span><span class="p">,</span>
			<span class="n">get_curr_tx_free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priority</span><span class="p">));</span>
		<span class="n">ieee80211_rtl_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtl8180_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">morefrag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_nic_enought_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priority</span><span class="p">))</span>
		<span class="n">ieee80211_rtl_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a rough attempt to TX a frame</span>
<span class="cm"> * This is called by the ieee 80211 stack to TX management frames.</span>
<span class="cm"> * If the ring is full packets are dropped (for data frame the queue</span>
<span class="cm"> * is stopped before this can happen). For this reason it is better</span>
<span class="cm"> * if the descriptors are larger than the largest management frame</span>
<span class="cm"> * we intend to TX: i&#39;m unsure what the HW does if it will not find</span>
<span class="cm"> * the last fragment of a frame because it has been dropped...</span>
<span class="cm"> * Since queues for Management and Data frames are different we</span>
<span class="cm"> * might use a different lock than tx_lock (for example mgmt_tx_lock)</span>
<span class="cm"> */</span>
<span class="cm">/* these function may loop if invoked with 0 descriptors or 0 len buffer */</span>
<span class="kt">int</span> <span class="nf">rtl8180_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>

	<span class="n">priority</span> <span class="o">=</span> <span class="n">MANAGE_PRIORITY</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl8180_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ieeerate2rtlrate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* longpre 144+48 shortpre 72+24 */</span>
<span class="n">u16</span> <span class="nf">rtl8180_len2duration</span><span class="p">(</span><span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="kt">short</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">duration</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">drift</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* 1mbps */</span>
		<span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="n">drift</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">duration</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 2mbps */</span>
		<span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="n">drift</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">duration</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* 5.5mbps */</span>
		<span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="n">drift</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">duration</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* 11mbps */</span>
		<span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="n">drift</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">duration</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drift</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">duration</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_prepare_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">word</span>  <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BcnItv</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BcnItv_BcnItv</span><span class="p">;</span> <span class="cm">/* clear Bcn_Itv */</span>
	<span class="n">word</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">);</span> <span class="cm">/* 0x64; */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BcnItv</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_beacon</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl8180_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">BEACON_PRIORITY</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ieeerate2rtlrate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">));</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function do the real dirty work: it enqueues a TX command</span>
<span class="cm"> * descriptor in the ring buffer, copyes the frame in a TX buffer</span>
<span class="cm"> * and kicks the NIC to ensure it does the DMA transfer.</span>
<span class="cm"> */</span>
<span class="kt">short</span> <span class="nf">rtl8180_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">txbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
		 <span class="kt">short</span> <span class="n">morefrag</span><span class="p">,</span> <span class="kt">short</span> <span class="n">descfrag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tail</span><span class="p">,</span> <span class="o">*</span><span class="n">temp_tail</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">begin</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">duration</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer</span> <span class="o">*</span><span class="n">buflist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">frag_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span><span class="n">txbuf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">bUseShortPreamble</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">bCTSEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">bRTSEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">Duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">RtsDur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">ThisFrameTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">TxDescDuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">ownbit_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MANAGE_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span><span class="p">;</span>
		<span class="n">buflist</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapbufstail</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BK_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span><span class="p">;</span>
		<span class="n">buflist</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpbufstail</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span><span class="p">;</span>
		<span class="n">buflist</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepbufstail</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VI_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span><span class="p">;</span>
		<span class="n">buflist</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipbufstail</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VO_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span><span class="p">;</span>
		<span class="n">buflist</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopbufstail</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HI_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span><span class="p">;</span>
		<span class="n">buflist</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpbufstail</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BEACON_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconring</span><span class="p">;</span>
		<span class="n">buflist</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconbufstail</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconcount</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">Duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">RtsDur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bRTSEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bCTSEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ThisFrameTime</span> <span class="o">=</span> <span class="n">ComputeTxTime</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">sCrcLng</span><span class="p">,</span> <span class="n">rtl8180_rate2rate</span><span class="p">(</span><span class="n">rate</span><span class="p">),</span>
						      <span class="mi">0</span><span class="p">,</span> <span class="n">bUseShortPreamble</span><span class="p">);</span>
			<span class="n">TxDescDuration</span> <span class="o">=</span> <span class="n">ThisFrameTime</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Unicast packet */</span>
			<span class="n">u16</span> <span class="n">AckTime</span><span class="p">;</span>

			<span class="cm">/* YJ,add,080828,for Keep alive */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxUnicast</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Figure out ACK rate according to BSS basic rate</span>
<span class="cm">			 * and Tx rate. */</span>
			<span class="n">AckTime</span> <span class="o">=</span> <span class="n">ComputeTxTime</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AckCTSLng = 14 use 1M bps send */</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">len</span> <span class="o">+</span> <span class="n">sCrcLng</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* RTS/CTS. */</span>
				<span class="n">u16</span> <span class="n">RtsTime</span><span class="p">,</span> <span class="n">CtsTime</span><span class="p">;</span>
				<span class="cm">/* u16 CtsRate; */</span>
				<span class="n">bRTSEnable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">bCTSEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* Rate and time required for RTS. */</span>
				<span class="n">RtsTime</span> <span class="o">=</span> <span class="n">ComputeTxTime</span><span class="p">(</span><span class="n">sAckCtsLng</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="cm">/* Rate and time required for CTS. */</span>
				<span class="n">CtsTime</span> <span class="o">=</span> <span class="n">ComputeTxTime</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AckCTSLng = 14 use 1M bps send */</span>

				<span class="cm">/* Figure out time required to transmit this frame. */</span>
				<span class="n">ThisFrameTime</span> <span class="o">=</span> <span class="n">ComputeTxTime</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">sCrcLng</span><span class="p">,</span>
						<span class="n">rtl8180_rate2rate</span><span class="p">(</span><span class="n">rate</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">bUseShortPreamble</span><span class="p">);</span>

				<span class="cm">/* RTS-CTS-ThisFrame-ACK. */</span>
				<span class="n">RtsDur</span> <span class="o">=</span> <span class="n">CtsTime</span> <span class="o">+</span> <span class="n">ThisFrameTime</span> <span class="o">+</span> <span class="n">AckTime</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">aSifsTime</span><span class="p">;</span>

				<span class="n">TxDescDuration</span> <span class="o">=</span> <span class="n">RtsTime</span> <span class="o">+</span> <span class="n">RtsDur</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Normal case. */</span>
				<span class="n">bCTSEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bRTSEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">RtsDur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">ThisFrameTime</span> <span class="o">=</span> <span class="n">ComputeTxTime</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">sCrcLng</span><span class="p">,</span> <span class="n">rtl8180_rate2rate</span><span class="p">(</span><span class="n">rate</span><span class="p">),</span>
							      <span class="mi">0</span><span class="p">,</span> <span class="n">bUseShortPreamble</span><span class="p">);</span>
				<span class="n">TxDescDuration</span> <span class="o">=</span> <span class="n">ThisFrameTime</span> <span class="o">+</span> <span class="n">aSifsTime</span> <span class="o">+</span> <span class="n">AckTime</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* ThisFrame-ACK. */</span>
				<span class="n">Duration</span> <span class="o">=</span> <span class="n">aSifsTime</span> <span class="o">+</span> <span class="n">AckTime</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* One or more fragments remained. */</span>
				<span class="n">u16</span> <span class="n">NextFragTime</span><span class="p">;</span>
				<span class="n">NextFragTime</span> <span class="o">=</span> <span class="n">ComputeTxTime</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">sCrcLng</span><span class="p">,</span> <span class="cm">/* pretend following packet length equal current packet */</span>
						<span class="n">rtl8180_rate2rate</span><span class="p">(</span><span class="n">rate</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">bUseShortPreamble</span><span class="p">);</span>

				<span class="cm">/* ThisFrag-ACk-NextFrag-ACK. */</span>
				<span class="n">Duration</span> <span class="o">=</span> <span class="n">NextFragTime</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">aSifsTime</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">AckTime</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="cm">/* End of Unicast packet */</span>

		<span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">Duration</span><span class="p">;</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">;</span>
	<span class="n">remain</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">temp_tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">remain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buflist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;TX buffer error, cannot TX frames. pri %d.&quot;</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">buflist</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priority</span> <span class="o">!=</span> <span class="n">BEACON_PRIORITY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;No more TX desc, returning %x of %x&quot;</span><span class="p">,</span>
			       <span class="n">remain</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txrdu</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">remain</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* zeroes header */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* FIXME: this should be triggered by HW encryption parameters.*/</span>
		<span class="o">*</span><span class="n">tail</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span> <span class="cm">/* no encrypt */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">remain</span> <span class="o">==</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">descfrag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ownbit_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="o">*</span><span class="n">tail</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">29</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* fist segment of the packet */</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="o">*</span><span class="n">tail</span> <span class="o">|</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ownbit_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buflen</span> <span class="o">&amp;&amp;</span> <span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">remain</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">txbuf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="cm">/* copy data into descriptor pointed DMAble buffer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">remain</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">+</span><span class="mi">4</span> <span class="o">&gt;=</span> <span class="n">buflen</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* ensure the last desc has at least 4 bytes payload */</span>

		<span class="p">}</span>
		<span class="n">txbuf</span> <span class="o">=</span> <span class="n">txbuf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* buffer length */</span>
		<span class="cm">/* Use short preamble or not */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span><span class="o">&amp;</span><span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">plcp_preamble_mode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/*  short mode now, not long! */</span>
			<span class="p">;</span> <span class="cm">/* *tail |= (1&lt;&lt;16); */</span>				<span class="cm">/* enable short preamble mode. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bCTSEnable</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">18</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bRTSEnable</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* rts enable */</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ieeerate2rtlrate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">19</span><span class="p">);</span> <span class="cm">/* RTS RATE */</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">23</span><span class="p">);</span> <span class="cm">/* rts enable */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RtsDur</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">);</span> <span class="cm">/* RTS Duration */</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">|=</span> <span class="p">((</span><span class="n">TxDescDuration</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span> <span class="cm">/* DURATION */</span>
		<span class="cm">/* *(tail+3) |= (0xe6&lt;&lt;16); */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">11</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span> <span class="cm">/* (priv-&gt;retry_data&lt;&lt;8); */</span> <span class="cm">/* retry lim; */</span>

		<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="o">*</span><span class="n">tail</span> <span class="o">|</span> <span class="p">((</span><span class="n">rate</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="cm">/* hw_plcp_len is not used for rtl8180 chip */</span>
		<span class="cm">/* FIXME */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_plcp_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">duration</span> <span class="o">=</span> <span class="n">rtl8180_len2duration</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">duration</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span> <span class="cm">/* plcp length extension */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">morefrag</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">tail</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span> <span class="cm">/* more fragment */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remain</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">tail</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">28</span><span class="p">);</span> <span class="cm">/* last segment of frame */</span>

		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span>

		<span class="n">wmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ownbit_flag</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="o">*</span><span class="n">tail</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span> <span class="cm">/* descriptor ready to be txed */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tail</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span> <span class="o">==</span> <span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="o">+</span><span class="mi">8</span><span class="p">;</span>

		<span class="n">buflist</span> <span class="o">=</span> <span class="n">buflist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">mb</span><span class="p">();</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MANAGE_PRIORITY</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringtail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapbufstail</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BK_PRIORITY</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringtail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpbufstail</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BE_PRIORITY</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringtail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepbufstail</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VI_PRIORITY</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringtail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipbufstail</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VO_PRIORITY</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringtail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopbufstail</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HI_PRIORITY</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringtail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpbufstail</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BEACON_PRIORITY</span>:
			<span class="cm">/*</span>
<span class="cm">			 * The HW seems to be happy with the 1st</span>
<span class="cm">			 * descriptor filled and the 2nd empty...</span>
<span class="cm">			 * So always update descriptor 1 and never</span>
<span class="cm">			 * touch 2nd</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">temp_tail</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp_tail</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span> <span class="cm">/* descriptor ready to be txed */</span>
	<span class="n">rtl8180_dma_kick</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">rtl8180_irq_rx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtl8180_link_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">beacon_interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="n">rtl8180_update_msr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSSID</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSSID</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">beacon_interval</span>  <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BEACON_INTERVAL</span><span class="p">);</span>
	<span class="n">beacon_interval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BEACON_INTERVAL_MASK</span><span class="p">;</span>
	<span class="n">beacon_interval</span> <span class="o">|=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BEACON_INTERVAL</span><span class="p">,</span> <span class="n">beacon_interval</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

	<span class="n">rtl8180_set_chan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_rq_tx_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">,</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">)</span> <span class="o">|</span> <span class="n">CONFIG4_PWRMGT</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl8180_is_tx_queue_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span> <span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span> <span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span> <span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span> <span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span> <span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">;</span> <span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* FIXME FIXME 5msecs is random */</span>
<span class="cp">#define HW_WAKE_DELAY 5</span>

<span class="kt">void</span> <span class="nf">rtl8180_hw_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">,</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CONFIG4_PWRMGT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_wakeup</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_hw_sleep_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_sleep</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_hw_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">th</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Writing HW register with 0 equals to disable</span>
<span class="cm">	 * the timer, that is not really what we want</span>
<span class="cm">	 */</span>
	<span class="n">tl</span> <span class="o">-=</span> <span class="n">MSECS</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="mi">7</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the interval in witch we are requested to sleep is too</span>
<span class="cm">	 * short then give up and remain awake</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">tl</span> <span class="o">&gt;=</span> <span class="n">rb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tl</span><span class="o">-</span><span class="n">rb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">MIN_SLEEP_TIME</span><span class="p">))</span>
		<span class="o">||</span> <span class="p">((</span><span class="n">rb</span> <span class="o">&gt;</span> <span class="n">tl</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rb</span><span class="o">-</span><span class="n">tl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">MIN_SLEEP_TIME</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;too short to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl</span> <span class="o">&gt;</span> <span class="n">rb</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">tl</span><span class="o">-</span><span class="n">rb</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">rb</span><span class="o">-</span><span class="n">tl</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DozePeriodInPast2Sec</span> <span class="o">+=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="cm">/* as tl may be less than rb */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_wakeup_wq</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we suspect the TimerInt is gone beyond tl</span>
<span class="cm">	 * while setting it, then give up</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">tl</span> <span class="o">&gt;</span> <span class="n">rb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tl</span><span class="o">-</span><span class="n">rb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">MAX_SLEEP_TIME</span><span class="p">)))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">tl</span> <span class="o">&lt;</span> <span class="n">rb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rb</span><span class="o">-</span><span class="n">tl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">MAX_SLEEP_TIME</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_sleep_wq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_wmm_param_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">wmm_param_update_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ac_param</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">wmm_param</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">AC_CODING</span>	<span class="n">eACI</span><span class="p">;</span>
	<span class="n">AC_PARAM</span>	<span class="n">AcParam</span><span class="p">;</span>
	<span class="n">PAC_PARAM</span>	<span class="n">pAcParam</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">QoS_Enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* legacy ac_xx_param update */</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">longData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AIFSN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Follow 802.11 DIFS. */</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ACM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmin</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Follow 802.11 CWmin. */</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmax</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* Follow 802.11 CWmax. */</span>
		<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">TXOPLimit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">eACI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eACI</span> <span class="o">&lt;</span> <span class="n">AC_MAX</span><span class="p">;</span> <span class="n">eACI</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AcParam</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ACI</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">eACI</span><span class="p">;</span>
			<span class="p">{</span>
				<span class="n">u8</span>		<span class="n">u1bAIFS</span><span class="p">;</span>
				<span class="n">u32</span>		<span class="n">u4bAcParam</span><span class="p">;</span>
				<span class="n">pAcParam</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAC_PARAM</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">AcParam</span><span class="p">);</span>
				<span class="cm">/* Retrieve paramters to update. */</span>
				<span class="n">u1bAIFS</span> <span class="o">=</span> <span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AIFSN</span> <span class="o">*</span> <span class="p">(((</span><span class="n">mode</span><span class="o">&amp;</span><span class="n">IEEE_G</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE_G</span><span class="p">)</span> <span class="o">?</span> <span class="mi">9</span> <span class="o">:</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">aSifsTime</span><span class="p">;</span>
				<span class="n">u4bAcParam</span> <span class="o">=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">TXOPLimit</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="n">AC_PARAM_TXOP_LIMIT_OFFSET</span><span class="p">)</span><span class="o">|</span>
					      <span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmax</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="n">AC_PARAM_ECW_MAX_OFFSET</span><span class="p">)</span><span class="o">|</span>
					      <span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmin</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="n">AC_PARAM_ECW_MIN_OFFSET</span><span class="p">)</span><span class="o">|</span>
					       <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">u1bAIFS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_AIFS_OFFSET</span><span class="p">));</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">eACI</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">AC1_BK</span>:
					<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_BK_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">AC0_BE</span>:
					<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_BE_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">AC2_VI</span>:
					<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_VI_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">AC3_VO</span>:
					<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_VO_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;SetHwReg8185():invalid ACI: %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eACI</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AC_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AcParam.longData = 0; */</span>
		<span class="n">pAcParam</span> <span class="o">=</span> <span class="p">(</span><span class="n">AC_PARAM</span> <span class="o">*</span><span class="p">)</span><span class="n">ac_param</span><span class="p">;</span>
		<span class="p">{</span>
			<span class="n">AC_CODING</span>	<span class="n">eACI</span><span class="p">;</span>
			<span class="n">u8</span>		<span class="n">u1bAIFS</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">u4bAcParam</span><span class="p">;</span>

			<span class="cm">/* Retrieve paramters to update. */</span>
			<span class="n">eACI</span> <span class="o">=</span> <span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ACI</span><span class="p">;</span>
			<span class="cm">/* Mode G/A: slotTimeTimer = 9; Mode B: 20 */</span>
			<span class="n">u1bAIFS</span> <span class="o">=</span> <span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">AciAifsn</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">AIFSN</span> <span class="o">*</span> <span class="p">(((</span><span class="n">mode</span><span class="o">&amp;</span><span class="n">IEEE_G</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE_G</span><span class="p">)</span> <span class="o">?</span> <span class="mi">9</span> <span class="o">:</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">aSifsTime</span><span class="p">;</span>
			<span class="n">u4bAcParam</span> <span class="o">=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">TXOPLimit</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_TXOP_LIMIT_OFFSET</span><span class="p">)</span>	<span class="o">|</span>
					<span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmax</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_ECW_MAX_OFFSET</span><span class="p">)</span>	<span class="o">|</span>
					<span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">pAcParam</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">Ecw</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">ECWmin</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_ECW_MIN_OFFSET</span><span class="p">)</span>	<span class="o">|</span>
					<span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">u1bAIFS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_AIFS_OFFSET</span><span class="p">));</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">eACI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AC1_BK</span>:
				<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_BK_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AC0_BE</span>:
				<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_BE_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AC2_VI</span>:
				<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_VI_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AC3_VO</span>:
				<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AC_VO_PARAM</span><span class="p">,</span> <span class="n">u4bAcParam</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;SetHwReg8185(): invalid ACI: %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eACI</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ac_param</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">AC_PARAM</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">rtl8180_tx_irq_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_restart_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="cm">/* void rtl8180_rq_tx_ack(struct work_struct *work); */</span>
<span class="kt">void</span> <span class="n">rtl8180_watch_dog_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_hw_wakeup_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_hw_sleep_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_sw_antenna_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8180_watch_dog</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">watch_dog_adaptive</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span><span class="o">*</span> <span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;&lt;----watch_dog_adaptive():driver is not up!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tx High Power Mechanism. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CheckHighPower</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">))</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_pw_wq</span><span class="p">);</span>

	<span class="cm">/* Tx Power Tracking on 87SE. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CheckTxPwrTracking</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">))</span>
		<span class="n">TxPwrTracking87SE</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Perform DIG immediately. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CheckDig</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_dig_wq</span><span class="p">);</span>
	<span class="n">rtl8180_watch_dog</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">GPIOChangeRFWorkItem</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">IEEE80211_WATCH_DOG_TIME</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">CHANNEL_LIST</span> <span class="n">ChannelPlan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">19</span><span class="p">},</span>		<span class="cm">/* FCC */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">},</span><span class="mi">11</span><span class="p">},</span>					<span class="cm">/* IC */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">21</span><span class="p">},</span>	<span class="cm">/* ETSI */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">21</span><span class="p">},</span>	<span class="cm">/* Spain. Change to ETSI. */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">21</span><span class="p">},</span>	<span class="cm">/* France. Change to ETSI. */</span>
	<span class="p">{{</span><span class="mi">14</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">9</span><span class="p">},</span>				<span class="cm">/* MKK */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">22</span><span class="p">},</span><span class="cm">/* MKK1 */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">21</span><span class="p">},</span>	<span class="cm">/* Israel. */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">46</span><span class="p">},</span><span class="mi">17</span><span class="p">},</span>		<span class="cm">/* For 11a , TELEC */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">},</span><span class="mi">14</span><span class="p">},</span>  <span class="cm">/* For Global Domain. 1-11:active scan, 12-14 passive scan. //+YJ, 080626 */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">},</span><span class="mi">13</span><span class="p">}</span> <span class="cm">/* world wide 13: ch1~ch11 active scan, ch12~13 passive //lzm add 080826 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8180_set_channel_map</span><span class="p">(</span><span class="n">u8</span> <span class="n">channel_plan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* lzm add 080826 */</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">MinPassiveChnlNum</span> <span class="o">=</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">IbssStartChnl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">channel_plan</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COUNTRY_CODE_FCC</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_IC</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_ETSI</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_SPAIN</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_FRANCE</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_MKK</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_MKK1</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_ISRAEL</span>:
	<span class="k">case</span> <span class="n">COUNTRY_CODE_TELEC</span>:
		<span class="p">{</span>
			<span class="n">Dot11d_Init</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Clear old channel map */</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">));</span>
				<span class="cm">/* Set new channel map */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Channel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span>
						<span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Channel</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">COUNTRY_CODE_GLOBAL_DOMAIN</span>:
		<span class="p">{</span>
			<span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bEnabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">Dot11d_Reset</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">COUNTRY_CODE_WORLD_WIDE_13_INDEX</span>:<span class="cm">/* lzm add 080826 */</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">MinPassiveChnlNum</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">IbssStartChnl</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="p">{</span>
			<span class="n">Dot11d_Init</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">));</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">GPIOChangeRFWorkItemCallBack</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="cm">/* YJ,add,080828 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8180_statistics_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">Stats</span> <span class="o">*</span><span class="n">pstats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pstats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Stats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8180_link_detect_init</span><span class="p">(</span><span class="n">plink_detect_t</span> <span class="n">plink_detect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">plink_detect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link_detect_t</span><span class="p">));</span>
	<span class="n">plink_detect</span><span class="o">-&gt;</span><span class="n">SlotNum</span> <span class="o">=</span> <span class="n">DEFAULT_SLOT_NUM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* YJ,add,080828,end */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8187se_eeprom_register_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom_93cx6</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">);</span>

	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_data_in</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">RTL818X_EEPROM_CMD_WRITE</span><span class="p">;</span>
	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_data_out</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">RTL818X_EEPROM_CMD_READ</span><span class="p">;</span>
	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_data_clock</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">RTL818X_EEPROM_CMD_CK</span><span class="p">;</span>
	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_chip_select</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">RTL818X_EEPROM_CMD_CS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8187se_eeprom_register_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom_93cx6</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_data_in</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">RTL818X_EEPROM_CMD_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_data_out</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">RTL818X_EEPROM_CMD_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_data_clock</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">RTL818X_EEPROM_CMD_CK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">reg_chip_select</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">RTL818X_EEPROM_CMD_CS</span><span class="p">;</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl8180_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">usValue</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmpu16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eeprom_93cx6</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom_val</span><span class="p">;</span>

	<span class="n">eeprom</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">eeprom</span><span class="p">.</span><span class="n">register_read</span> <span class="o">=</span> <span class="n">rtl8187se_eeprom_register_read</span><span class="p">;</span>
	<span class="n">eeprom</span><span class="p">.</span><span class="n">register_write</span> <span class="o">=</span> <span class="n">rtl8187se_eeprom_register_write</span><span class="p">;</span>
	<span class="n">eeprom</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">PCI_EEPROM_WIDTH_93C46</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_COUNTRY_CODE</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom_val</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_plan</span> <span class="o">=</span> <span class="n">eeprom_val</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_plan</span> <span class="o">&gt;</span> <span class="n">COUNTRY_CODE_GLOBAL_DOMAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rtl8180_init:Error channel plan! Set to default.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_plan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Channel plan is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_plan</span><span class="p">);</span>
	<span class="n">rtl8180_set_channel_map</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_plan</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>

	<span class="cm">/* FIXME: these constants are placed in a bad pleace. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>	<span class="cm">/* 1024; */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>		<span class="cm">/* 32; */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>	<span class="cm">/* 1024; */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>		<span class="cm">/* 32; */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconcount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SetRFPowerStateInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFProgType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInHctTest</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtl8180_statistics_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">rtl8180_link_detect_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">DEFAULT_BEACONINTERVAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_features</span>  <span class="o">=</span> <span class="n">IEEE_SOFTMAC_SCAN</span> <span class="o">|</span>
		<span class="n">IEEE_SOFTMAC_ASSOCIATE</span> <span class="o">|</span> <span class="n">IEEE_SOFTMAC_PROBERQ</span> <span class="o">|</span>
		<span class="n">IEEE_SOFTMAC_PROBERS</span> <span class="o">|</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span> <span class="cm">/* 11 mbps */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">IEEE80211_CCK_MODULATION</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">sta_wake_up</span> <span class="o">=</span> <span class="n">rtl8180_hw_wakeup</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ps_request_tx_ack</span> <span class="o">=</span> <span class="n">rtl8180_rq_tx_ack</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">enter_sleep_state</span> <span class="o">=</span> <span class="n">rtl8180_hw_sleep</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ps_is_queue_empty</span> <span class="o">=</span> <span class="n">rtl8180_is_tx_queue_empty</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_wep</span> <span class="o">=</span> <span class="n">hwwep</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prism_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_rts</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_RTS</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_data</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_DATA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SetRFPowerStateInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFProgType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInHctTest</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* false; */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bInactivePs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwRfProcessing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">=</span> <span class="n">eRfOff</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LedStrategy</span> <span class="o">=</span> <span class="n">SW_LED_MODE0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPollingTimes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* lzm add 080826 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bLeisurePs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dot11PowerSaveMode</span> <span class="o">=</span> <span class="n">eActive</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMinCheckPeriod</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxCheckPeriod</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMaxRxSsThreshold</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>	<span class="cm">/* 60-&gt;30 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsThreshold</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>	<span class="cm">/* 50-&gt;20 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdCheckPeriod</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMinCheckPeriod</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdTickCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSignalStrength</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegSwAntennaDiversityMechanism</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegDefaultAntenna</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxOkCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrAntennaIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdRxSsBeforeSwitched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SwAntennaDiversityTimer</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SwAntennaDiversityTimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SwAntennaDiversityTimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">SwAntennaDiversityTimerCallback</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDigMechanism</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bXtalCalibration</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTxPowerTrack</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FalseAlarmRegValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegDigOfdmFaUpTh</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span> <span class="cm">/* Upper threshold of OFDM false alarm, which is used in DIG. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberFallbackVote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">DIG_NumberUpgradeVote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastSignalStrengthInPercent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_SignalStrength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxPktAntenna</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* in 0-100 index. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_SignalQuality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* in dBm. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Stats_RecvSignalPower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdMainAntennaRxOkCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AdAuxAntennaRxOkCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHWAdSwitched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bRegHighPowerMechanism</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegHiPwrUpperTh</span> <span class="o">=</span> <span class="mi">77</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegHiPwrLowerTh</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegRSSIHiPwrUpperTh</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegRSSIHiPwrLowerTh</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bCurCCKPkt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">UndecoratedSmoothedSS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bToUpdateTxPwr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurCCKRSSI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RxPower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RSSI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxUnicast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">keepAliveLevel</span> <span class="o">=</span> <span class="n">DEFAULT_KEEP_ALIVE_LEVEL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">PowerProfile</span> <span class="o">=</span> <span class="n">POWER_PROFILE_AC</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxokCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxokCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRetryRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTryuping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrTxRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrRetryRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryupingCountNoData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TryDownCountLowData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxOKBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastFailTxRateSS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">FailTxRateCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastTxThroughput</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkBytesTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ForcedDataRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegBModeGainStage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_restart_wq</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_irq_wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_tx_irq_wq</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_wakeup_wq</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_hw_wakeup_wq</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_sleep_wq</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_hw_sleep_wq</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wmm_param_update_wq</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_wmm_param_update</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate_adapter_wq</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_rate_adapter</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_dig_wq</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_hw_dig_wq</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_pw_wq</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_tx_pw_wq</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">GPIOChangeRFWorkItem</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">GPIOChangeRFWorkItemCallBack</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">rtl8180_irq_rx_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">watch_dog_adaptive</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rateadapter_timer</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rateadapter_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rateadapter_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">timer_rate_adaptive</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RateAdaptivePeriod</span> <span class="o">=</span> <span class="n">RATE_ADAPTIVE_TIMER_PERIOD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bEnhanceTxPwr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span> <span class="o">=</span> <span class="n">rtl8180_hard_start_xmit</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">set_chan</span> <span class="o">=</span> <span class="n">rtl8180_set_chan</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">link_change</span> <span class="o">=</span> <span class="n">rtl8180_link_change</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span> <span class="o">=</span> <span class="n">rtl8180_hard_data_xmit</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span> <span class="o">=</span> <span class="n">rtl8180_data_hard_stop</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span> <span class="o">=</span> <span class="n">rtl8180_data_hard_resume</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">init_wmmparam_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">start_send_beacons</span> <span class="o">=</span> <span class="n">rtl8180_start_tx_beacon</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stop_send_beacons</span> <span class="o">=</span> <span class="n">rtl8180_beacon_tx_disable</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">DEFAULT_FRAG_THRESHOLD</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">MWIEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ShortRetryLimit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LongRetryLimit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CSMethod</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TransmitConfig</span> <span class="o">=</span>	<span class="n">TCR_DurProcMode_OFFSET</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="n">TCR_MXDMA_OFFSET</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ShortRetryLimit</span><span class="o">&lt;&lt;</span><span class="n">TCR_SRL_OFFSET</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LongRetryLimit</span><span class="o">&lt;&lt;</span><span class="n">TCR_LRL_OFFSET</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">0</span> <span class="o">?</span> <span class="n">TCR_SAT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">=</span>	<span class="n">RCR_AMF</span> <span class="o">|</span> <span class="n">RCR_ADF</span> <span class="o">|</span> <span class="n">RCR_ACF</span> <span class="o">|</span>
				<span class="n">RCR_AB</span> <span class="o">|</span> <span class="n">RCR_AM</span> <span class="o">|</span> <span class="n">RCR_APM</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="n">RCR_MXDMA_OFFSET</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span><span class="o">&lt;&lt;</span><span class="n">RCR_FIFO_OFFSET</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">?</span>
					 <span class="n">RCR_ONLYERLPKT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">IntrMask</span>		<span class="o">=</span> <span class="n">IMR_TMGDOK</span> <span class="o">|</span> <span class="n">IMR_TBDER</span> <span class="o">|</span> <span class="n">IMR_THPDER</span> <span class="o">|</span>
				  <span class="n">IMR_THPDER</span> <span class="o">|</span> <span class="n">IMR_THPDOK</span> <span class="o">|</span>
				  <span class="n">IMR_TVODER</span> <span class="o">|</span> <span class="n">IMR_TVODOK</span> <span class="o">|</span>
				  <span class="n">IMR_TVIDER</span> <span class="o">|</span> <span class="n">IMR_TVIDOK</span> <span class="o">|</span>
				  <span class="n">IMR_TBEDER</span> <span class="o">|</span> <span class="n">IMR_TBEDOK</span> <span class="o">|</span>
				  <span class="n">IMR_TBKDER</span> <span class="o">|</span> <span class="n">IMR_TBKDOK</span> <span class="o">|</span>
				  <span class="n">IMR_RDU</span> <span class="o">|</span>
				  <span class="n">IMR_RER</span> <span class="o">|</span> <span class="n">IMR_ROK</span> <span class="o">|</span>
				  <span class="n">IMR_RQoSOK</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InitialGain</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;MAC controller is a RTL8187SE b/g&quot;</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_ver</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">|=</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">short_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* just for sync 85 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">enable_gpio0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_SW_REVD_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom_val</span><span class="p">);</span>
	<span class="n">usValue</span> <span class="o">=</span> <span class="n">eeprom_val</span><span class="p">;</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;usValue is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usValue</span><span class="p">);</span>
	<span class="cm">/* 3Read AntennaDiversity */</span>

	<span class="cm">/* SW Antenna Diversity. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">usValue</span> <span class="o">&amp;</span> <span class="n">EEPROM_SW_AD_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EEPROM_SW_AD_ENABLE</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMSwAntennaDiversity</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMSwAntennaDiversity</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Default Antenna to use. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">usValue</span> <span class="o">&amp;</span> <span class="n">EEPROM_DEF_ANT_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EEPROM_DEF_ANT_1</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMDefaultAntenna1</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMDefaultAntenna1</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegSwAntennaDiversityMechanism</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Auto */</span>
		<span class="cm">/* 0: default from EEPROM. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwAntennaDiverity</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMSwAntennaDiversity</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* 1:disable antenna diversity, 2: enable antenna diversity. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwAntennaDiverity</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegSwAntennaDiversityMechanism</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegDefaultAntenna</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* 0: default from EEPROM. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDefaultAntenna1</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMDefaultAntenna1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* 1: main, 2: aux. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDefaultAntenna1</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegDefaultAntenna</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* rtl8185 can calc plcp len in HW. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_plcp_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">plcp_preamble_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* the eeprom type is stored in RCR register bit #6 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RCR_9356SEL</span> <span class="o">&amp;</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCR</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">=</span> <span class="n">EPROM_93c56</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">=</span> <span class="n">EPROM_93c46</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_multiread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EPROM_TXPW_CH1_2</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EPROM_TXPW_OFDM_CH1_2</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 3Read crystal calibration and thermal meter indication on 87SE. */</span>
	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSV</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpu16</span><span class="p">);</span>

	<span class="cm">/* Crystal calibration for Xin and Xout resp. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xout</span> <span class="o">=</span> <span class="n">tmpu16</span> <span class="o">&amp;</span> <span class="n">EEPROM_XTAL_CAL_XOUT_MASK</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">XtalCal_Xin</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmpu16</span> <span class="o">&amp;</span> <span class="n">EEPROM_XTAL_CAL_XIN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmpu16</span> <span class="o">&amp;</span> <span class="n">EEPROM_XTAL_CAL_ENABLE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bXtalCalibration</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Thermal meter reference indication. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span> <span class="o">=</span>  <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">tmpu16</span> <span class="o">&amp;</span> <span class="n">EEPROM_THERMAL_METER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmpu16</span> <span class="o">&amp;</span> <span class="n">EEPROM_THERMAL_METER_ENABLE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bTxPowerTrack</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EPROM_TXPW_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cck_txpwr_base</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ofdm_txpwr_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EPROM_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;EEPROM version %x&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rcr_csense</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">ENERGY_TRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom_val</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cs_treshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">eeprom_val</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">eeprom_93cx6_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">RFCHIPID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom_val</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_sleep</span> <span class="o">=</span> <span class="n">rtl8225z4_rf_sleep</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_wakeup</span> <span class="o">=</span> <span class="n">rtl8225z4_rf_wakeup</span><span class="p">;</span>
	<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;**PLEASE** REPORT SUCCESSFUL/UNSUCCESSFUL TO Realtek!&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_close</span> <span class="o">=</span> <span class="n">rtl8225z2_rf_close</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_init</span> <span class="o">=</span> <span class="n">rtl8225z2_rf_init</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span> <span class="o">=</span> <span class="n">rtl8225z2_rf_set_chan</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_sens</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_rx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">,</span>
				  <span class="n">TX_MANAGEPRIORITY_RING_ADDR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">,</span>
				 <span class="n">TX_BKPRIORITY_RING_ADDR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">,</span>
				 <span class="n">TX_BEPRIORITY_RING_ADDR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">,</span>
				  <span class="n">TX_VIPRIORITY_RING_ADDR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">,</span>
				  <span class="n">TX_VOPRIORITY_RING_ADDR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">,</span>
				  <span class="n">TX_HIGHPRIORITY_RING_ADDR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbuffsize</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbeaconcount</span><span class="p">,</span>
				  <span class="n">TX_BEACON_RING_ADDR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8180_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Error allocating IRQ %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;IRQ %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_no_hw_wep</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_set_hw_wep</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">pgreg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">security</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key0_word4</span><span class="p">;</span>

	<span class="n">pgreg</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PGSELECT</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PGSELECT</span><span class="p">,</span> <span class="n">pgreg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">PGSELECT_PG_SHIFT</span><span class="p">));</span>

	<span class="n">key0_word4</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">key0_word4</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
	<span class="n">key0_word4</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">key0_word4</span><span class="p">));</span>

	<span class="n">security</span>  <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SECURITY</span><span class="p">);</span>
	<span class="n">security</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">SECURITY_WEP_TX_ENABLE_SHIFT</span><span class="p">);</span>
	<span class="n">security</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">SECURITY_WEP_RX_ENABLE_SHIFT</span><span class="p">);</span>
	<span class="n">security</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SECURITY_ENCRYP_MASK</span><span class="p">;</span>
	<span class="n">security</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SECURITY_ENCRYP_104</span><span class="o">&lt;&lt;</span><span class="n">SECURITY_ENCRYP_SHIFT</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SECURITY</span><span class="p">,</span> <span class="n">security</span><span class="p">);</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;key %x %x %x %x&quot;</span><span class="p">,</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span>
	      <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span>
	      <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">KEY0</span><span class="p">));</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8185_rf_pins_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* u16 tmp; */</span>
	<span class="cm">/* tmp = read_nic_word(dev, RFPinsEnable); */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">);</span> <span class="cm">/* | tmp); */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185_set_anaparam2</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">conf3</span><span class="p">;</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>

	<span class="n">conf3</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="n">conf3</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CONFIG3_ANAPARAM_W_SHIFT</span><span class="p">));</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANAPARAM2</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

	<span class="n">conf3</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="n">conf3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CONFIG3_ANAPARAM_W_SHIFT</span><span class="p">));</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_set_anaparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">conf3</span><span class="p">;</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>

	<span class="n">conf3</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="n">conf3</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CONFIG3_ANAPARAM_W_SHIFT</span><span class="p">));</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ANAPARAM</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

	<span class="n">conf3</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="n">conf3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CONFIG3_ANAPARAM_W_SHIFT</span><span class="p">));</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185_tx_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_ANTENNA</span><span class="p">,</span> <span class="n">ant</span><span class="p">);</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185_write_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phyw</span><span class="p">;</span>

	<span class="n">adr</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">phyw</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">adr</span><span class="p">);</span>

	<span class="cm">/* Note that, we must write 0xff7c after 0x7d-0x7f to write BB register. */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">((</span><span class="n">phyw</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="p">((</span><span class="n">phyw</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="p">((</span><span class="n">phyw</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="p">((</span><span class="n">phyw</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)));</span>

	<span class="cm">/* this is ok to fail when we write AGC table. check for AGC table might be</span>
<span class="cm">	 * done by masking with 0x7f instead of 0xff</span>
<span class="cm">	 */</span>
	<span class="cm">/* if (phyr != (data&amp;0xff)) DMESGW(&quot;Phy write timeout %x %x %x&quot;, phyr, data, adr); */</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_phy_ofdm</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rtl8185_write_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_phy_cck</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rtl8185_write_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x10000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8185_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">basic_rate</span><span class="p">,</span> <span class="n">min_rr_rate</span><span class="p">,</span> <span class="n">max_rr_rate</span><span class="p">;</span>

	<span class="n">basic_rate</span> <span class="o">=</span> <span class="n">ieeerate2rtlrate</span><span class="p">(</span><span class="mi">240</span><span class="p">);</span>
	<span class="n">min_rr_rate</span> <span class="o">=</span> <span class="n">ieeerate2rtlrate</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
	<span class="n">max_rr_rate</span> <span class="o">=</span> <span class="n">ieeerate2rtlrate</span><span class="p">(</span><span class="mi">240</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESP_RATE</span><span class="p">,</span>
		       <span class="n">max_rr_rate</span><span class="o">&lt;&lt;</span><span class="n">MAX_RESP_RATE_SHIFT</span> <span class="o">|</span>
		       <span class="n">min_rr_rate</span><span class="o">&lt;&lt;</span><span class="n">MIN_RESP_RATE_SHIFT</span><span class="p">);</span>

	<span class="n">word</span>  <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRSR</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BRSR_MBR_8185</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">basic_rate</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">word</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRSR</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_adapter_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_rtx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8180_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* enable beacon timeout, beacon TX ok and err</span>
<span class="cm">	 * LP tx ok and err, HP TX ok and err, NP TX ok and err,</span>
<span class="cm">	 * RX ok and ERR, and GP timer</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="mh">0x6fcf</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_poll_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtl8180_beacon_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MAC0</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MAC4</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

	<span class="n">rtl8180_update_msr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* These might be unnecessary since we do in rx_enable / tx_enable */</span>
	<span class="n">fix_rx_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">fix_tx_fifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The following is very strange. seems to be that 1 means test mode,</span>
<span class="cm">	 * but we need to acknowledges the nic when a packet is ready</span>
<span class="cm">	 * although we set it to 0</span>
<span class="cm">	 */</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		       <span class="n">CONFIG2</span><span class="p">,</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span>\
		       <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">CONFIG2_DMA_POLLING_MODE_SHIFT</span><span class="p">));</span>
	<span class="cm">/* ^the nic isn&#39;t in test mode */</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		       <span class="n">CONFIG2</span><span class="p">,</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">));</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INT_TIMEOUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WPA_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtl8180_no_hw_wep</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8185_set_rate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RATE_FALLBACK</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GP_ENABLE</span><span class="p">,</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GP_ENABLE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">));</span>

	<span class="cm">/* FIXME cfg 3 ClkRun enable - isn&#39;t it ReadOnly ? */</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">)</span>
		       <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONFIG3_CLKRUN_SHIFT</span><span class="p">));</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_sens</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_sens</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">);</span>
	<span class="n">rtl8180_irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This configures registers for beacon tx and enables it via</span>
<span class="cm"> * rtl8180_beacon_tx_enable(). rtl8180_beacon_tx_disable() might</span>
<span class="cm"> * be used to stop beacon transmission</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtl8180_start_tx_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Enabling beacon TX&quot;</span><span class="p">);</span>
	<span class="n">rtl8180_prepare_beacon</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8180_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8180_beacon_tx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AtimWnd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AtimWnd_AtimWnd</span><span class="p">;</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AtimWnd</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span> <span class="cm">/* word |= */</span>

	<span class="n">word</span>  <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BintrItv</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BintrItv_BintrItv</span><span class="p">;</span>
	<span class="n">word</span> <span class="o">|=</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* priv-&gt;ieee80211-&gt;current_network.beacon_interval *</span>
<span class="cm">		((priv-&gt;txbeaconcount &gt; 1)?(priv-&gt;txbeaconcount-1):1);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">	*/</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BintrItv</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

	<span class="n">rtl8185b_irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">rtl8180_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change current and default preamble mode.</span>
<span class="cm"> */</span>
<span class="n">bool</span>
<span class="nf">MgntActSet_802_11_PowerSaveMode</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="n">RT_PS_MODE</span>		<span class="n">rtPsMode</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Currently, we do not change power save mode on IBSS mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="n">rtPsMode</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">LeisurePSEnter</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bLeisurePs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">==</span> <span class="n">IEEE80211_PS_DISABLED</span><span class="p">)</span>
			<span class="cm">/* IEEE80211_PS_ENABLE */</span>
			<span class="n">MgntActSet_802_11_PowerSaveMode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IEEE80211_PS_MBCAST</span><span class="o">|</span><span class="n">IEEE80211_PS_UNICAST</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">LeisurePSLeave</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bLeisurePs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">!=</span> <span class="n">IEEE80211_PS_DISABLED</span><span class="p">)</span>
			<span class="n">MgntActSet_802_11_PowerSaveMode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IEEE80211_PS_DISABLED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_hw_wakeup_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">hw_wakeup_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rtl8180_hw_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_hw_sleep_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">hw_sleep_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rtl8180_hw_sleep_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MgntLinkKeepAlive</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keepAliveLevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Keep-Alive.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">keepAliveLevel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">LastNumTxUnicast</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxUnicast</span> <span class="o">&amp;&amp;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">LastNumRxUnicast</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxUnicast</span><span class="p">)</span>
			<span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">IdleCount</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Send a Keep-Alive packet packet to AP if we had been idle for a while.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">IdleCount</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">KEEP_ALIVE_INTERVAL</span> <span class="o">/</span> <span class="n">CHECK_FOR_HANG_PERIOD</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">IdleCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ieee80211_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">IdleCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">LastNumTxUnicast</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxUnicast</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">LastNumRxUnicast</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxUnicast</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">read_acadapter_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtl8180_watch_dog</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">bEnterPS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">TotalRxNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">SlotIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOn</span><span class="p">))</span>
			<span class="n">IPSEnter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* YJ,add,080828,for link state check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SlotIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">SlotIndex</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">SlotNum</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">RxFrameNum</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxDataInPeriod</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxBcnInPeriod</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">SlotNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">TotalRxNum</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">RxFrameNum</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">TotalRxNum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_ASSOCIATING</span><span class="p">;</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* YJ,add,080828,for KeepAlive */</span>
	<span class="n">MgntLinkKeepAlive</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* YJ,add,080828,for LPS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">PowerProfile</span> <span class="o">==</span> <span class="n">POWER_PROFILE_BATTERY</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bLeisurePs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">PowerProfile</span> <span class="o">==</span> <span class="n">POWER_PROFILE_AC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LeisurePSLeave</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bLeisurePs</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxDataInPeriod</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">666</span> <span class="o">||</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">666</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bEnterPS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bEnterPS</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bEnterPS</span><span class="p">)</span>
			<span class="n">LeisurePSEnter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">LeisurePSLeave</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">LeisurePSLeave</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="n">bBusyTraffic</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxDataInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">NumRxBcnInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">_rtl8180_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Bringing up iface&quot;</span><span class="p">);</span>
	<span class="n">rtl8185b_adapter_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8185b_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8185b_tx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">IPSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">timer_rate_adaptive</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">watch_dog_adaptive</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bSwAntennaDiverity</span><span class="p">)</span>
			<span class="n">SwAntennaDiversityTimerCallback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ieee80211_softmac_start_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl8180_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8180_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl8180_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">_rtl8180_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl8180_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8180_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl8180_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ieee80211_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="cm">/* FIXME */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8180_rtx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8180_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rateadapter_timer</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate_adapter_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_wakeup_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_sleep_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_dig_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_pw_wq</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SwAntennaDiversityTimer</span><span class="p">);</span>
	<span class="n">SetZebraRFPowerState8185</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eRfOff</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_restart_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8180_priv</span><span class="p">,</span> <span class="n">reset_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">rtl8180_commit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rateadapter_timer</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate_adapter_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_wakeup_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_sleep_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">hw_dig_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_pw_wq</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SwAntennaDiversityTimer</span><span class="p">);</span>
	<span class="n">ieee80211_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="n">rtl8180_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8180_rtx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">_rtl8180_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8180_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">promisc</span><span class="p">;</span>

	<span class="n">promisc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">promisc</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">)</span>
		<span class="n">rtl8180_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="n">promisc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">r8180_set_mac_adr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mac</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl8180_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8180_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* based on ipw2200 driver */</span>
<span class="kt">int</span> <span class="nf">rtl8180_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_IOCTL_WPA_SUPPLICANT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_supplicant_ioctl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rtl8180_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">rtl8180_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">rtl8180_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">rtl8180_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">rtl8180_restart</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">rtl8180_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">r8180_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">r8180_set_mac_adr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ieee80211_rtl_xmit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rtl8180_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">unit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">,</span> <span class="n">pmem_flags</span><span class="p">;</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Configuring chip resources&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Failed to enable PCI device&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xffffff00ULL</span><span class="p">);</span>
	<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xffffff00ULL</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_ieee80211</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">pmem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pmem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pmem_flags</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmem_flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;region #1 not a MMIO resource, aborting&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">,</span> <span class="n">RTL8180_MODULE_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;request_mem_region failed!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;ioremap failed!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span> <span class="cm">/* shared mem start */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* shared mem end */</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">unit</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x04</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl8180_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8180_wx_handlers_def</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Oops: devname already taken! Trying wlan%%d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">);</span>
		<span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8180_init</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Initialization failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8180_proc_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Driver probe completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
				   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free_ieee80211</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">fail_free:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;wlan driver load failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">rtl8180_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">rtl8180_proc_remove_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8180_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8180_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Freeing irq %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">free_rx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">free_tx_desc_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
					   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">free_ieee80211</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;wlan driver removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* fun with the built-in ieee80211 stack... */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_deinit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_tkip_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_tkip_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_ccmp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_ccmp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_wep_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_wep_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rtl8180_pci_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_tkip_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_tkip_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_ccmp_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_ccmp_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_wep_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_wep_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Linux kernel driver for RTL8180 / RTL8185 based WLAN cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Copyright (c) 2004-2005, Andrea Merello</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Initializing module&quot;</span><span class="p">);</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Wireless extensions version %d&quot;</span><span class="p">,</span> <span class="n">WIRELESS_EXT</span><span class="p">);</span>
	<span class="n">rtl8180_proc_module_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8180_pci_driver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;No device found&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rtl8180_pci_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8180_pci_driver</span><span class="p">);</span>
	<span class="n">rtl8180_proc_module_remove</span><span class="p">();</span>
	<span class="n">ieee80211_crypto_tkip_exit</span><span class="p">();</span>
	<span class="n">ieee80211_crypto_ccmp_exit</span><span class="p">();</span>
	<span class="n">ieee80211_crypto_wep_exit</span><span class="p">();</span>
	<span class="n">ieee80211_crypto_deinit</span><span class="p">();</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Exiting&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_try_wake_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">enough_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">enough_desc</span> <span class="o">=</span> <span class="n">check_nic_enought_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pri</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enough_desc</span><span class="p">)</span>
		<span class="n">ieee80211_rtl_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_tx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">,</span> <span class="kt">short</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span> <span class="cm">/* tail virtual addr */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span> <span class="cm">/* head virtual addr */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">begin</span><span class="p">;</span> <span class="cm">/* start of ring virtual addr */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">nicv</span><span class="p">;</span> <span class="cm">/* nic pointer virtual addr */</span>
	<span class="n">u32</span> <span class="n">nic</span><span class="p">;</span> <span class="cm">/* nic pointer physical addr */</span>
	<span class="n">u32</span> <span class="n">nicbegin</span><span class="p">;</span> <span class="cm">/* start of ring physical addr */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="cm">/* physical addr are ok on 32 bits since we set DMA mask */</span>
	<span class="kt">int</span> <span class="n">offs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txretry</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* tony 20060601 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pri</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MANAGE_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapring</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringhead</span><span class="p">;</span>
		<span class="n">nic</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_MANAGEPRIORITY_RING_ADDR</span><span class="p">);</span>
		<span class="n">nicbegin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringdma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BK_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpring</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringhead</span><span class="p">;</span>
		<span class="n">nic</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BKPRIORITY_RING_ADDR</span><span class="p">);</span>
		<span class="n">nicbegin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringdma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepring</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringhead</span><span class="p">;</span>
		<span class="n">nic</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BEPRIORITY_RING_ADDR</span><span class="p">);</span>
		<span class="n">nicbegin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringdma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VI_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipring</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringhead</span><span class="p">;</span>
		<span class="n">nic</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_VIPRIORITY_RING_ADDR</span><span class="p">);</span>
		<span class="n">nicbegin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringdma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VO_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopring</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringhead</span><span class="p">;</span>
		<span class="n">nic</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_VOPRIORITY_RING_ADDR</span><span class="p">);</span>
		<span class="n">nicbegin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringdma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HI_PRIORITY</span>:
		<span class="n">tail</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringtail</span><span class="p">;</span>
		<span class="n">begin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpring</span><span class="p">;</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringhead</span><span class="p">;</span>
		<span class="n">nic</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_HIGHPRIORITY_RING_ADDR</span><span class="p">);</span>
		<span class="n">nicbegin</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringdma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nicv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">nic</span> <span class="o">-</span> <span class="n">nicbegin</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">begin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">head</span> <span class="o">&lt;=</span> <span class="n">tail</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nicv</span> <span class="o">&gt;</span> <span class="n">tail</span> <span class="o">||</span> <span class="n">nicv</span> <span class="o">&lt;</span> <span class="n">head</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">head</span> <span class="o">&gt;</span> <span class="n">tail</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nicv</span> <span class="o">&gt;</span> <span class="n">tail</span> <span class="o">&amp;&amp;</span> <span class="n">nicv</span> <span class="o">&lt;</span> <span class="n">head</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;nic has lost pointer&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="n">rtl8180_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We check all the descriptors between the head and the nic,</span>
<span class="cm">	 * but not the currently pointed by the nic (the next to be txed)</span>
<span class="cm">	 * and the previous of the pointed (might be in process ??)</span>
<span class="cm">	 */</span>
	<span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span> <span class="o">-</span> <span class="n">nicbegin</span><span class="p">);</span>
	<span class="n">offs</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">hd</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&gt;=</span> <span class="n">hd</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">-</span> <span class="n">hd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">hd</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x10000000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrRetryCnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x000000ff</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkTotal</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTxOkBytesTotal</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">head</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00000fff</span><span class="p">);</span>

		<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">head</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">head</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">head</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The head has been moved to the last certainly TXed</span>
<span class="cm">	 * (or at least processed by the nic) packet.</span>
<span class="cm">	 * The driver take forcefully owning of all these packets</span>
<span class="cm">	 * If the packet previous of the nic pointer has been</span>
<span class="cm">	 * processed this doesn&#39;t matter: it will be checked</span>
<span class="cm">	 * here at the next round. Anyway if no more packet are</span>
<span class="cm">	 * TXed no memory leak occur at all.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pri</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MANAGE_PRIORITY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txmapringhead</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtl8180_is_tx_queue_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ieee80211_ps_tx_ack</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="o">!</span><span class="n">error</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BK_PRIORITY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbkpringhead</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BE_PRIORITY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbepringhead</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VI_PRIORITY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvipringhead</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VO_PRIORITY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txvopringhead</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HI_PRIORITY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txhpringhead</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_tx_irq_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">watch_dog_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MANAGE_PRIORITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">irqreturn_t</span> <span class="nf">rtl8180_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">;</span>

	<span class="cm">/* We should return IRQ_NONE, but for now let me keep this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* ISR: 4bytes */</span>
	<span class="n">inta</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ISR</span><span class="p">);</span> <span class="cm">/* &amp; priv-&gt;IntrMask; */</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ISR</span><span class="p">,</span> <span class="n">inta</span><span class="p">);</span> <span class="cm">/* reset int situation */</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">shints</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * most probably we can safely return IRQ_NONE,</span>
<span class="cm">	 * but for now is better to avoid problems</span>
<span class="cm">	 */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HW disappeared */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ints</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TimeOut</span><span class="p">)</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TimerInt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TBDOK</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeacon</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TBDER</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeaconerr</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_TMGDOK</span><span class="p">)</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MANAGE_PRIORITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_THPDER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txhperr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HI_PRIORITY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_THPDOK</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* High priority tx ok */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* YJ,add,080828 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txhpokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HI_PRIORITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_RER</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TBKDER</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* corresponding to BK_PRIORITY */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbkperr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BK_PRIORITY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtl8180_try_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BE_PRIORITY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TBEDER</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* corresponding to BE_PRIORITY */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeperr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BE_PRIORITY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtl8180_try_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BE_PRIORITY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TNPDER</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* corresponding to VO_PRIORITY */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txnperr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NORM_PRIORITY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtl8180_try_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NORM_PRIORITY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TLPDER</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* corresponding to VI_PRIORITY */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txlperr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOW_PRIORITY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtl8180_try_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOW_PRIORITY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_ROK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_RQoSOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_BcnInt</span><span class="p">)</span>
		<span class="n">rtl8180_prepare_beacon</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_RDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;No RX descriptor available&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxrdu</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_RXFOVW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxoverflow</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TXFOVW</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txoverflow</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TNPDOK</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Normal priority tx ok */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* YJ,add,080828 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txnpokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NORM_PRIORITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TLPDOK</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Low priority tx ok */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* YJ,add,080828 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txlpokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOW_PRIORITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtl8180_try_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LOW_PRIORITY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TBKDOK</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* corresponding to BK_PRIORITY */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbkpokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* YJ,add,080828 */</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BK_PRIORITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtl8180_try_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BE_PRIORITY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">ISR_TBEDOK</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* corresponding to BE_PRIORITY */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeperr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* YJ,add,080828 */</span>
		<span class="n">rtl8180_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BE_PRIORITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtl8180_try_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BE_PRIORITY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8180_irq_rx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8180_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">GPIOChangeRFWorkItemCallBack</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">GPIOChangeRFWorkItem</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">btPSR</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">btConfig0</span><span class="p">;</span>
	<span class="n">RT_RF_POWER_STATE</span>	<span class="n">eRfPowerStateToSet</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bActuallySet</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">RadioPowerPath</span> <span class="o">=</span> <span class="s">&quot;/etc/acpi/events/RadioPower.sh&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;HOME=/&quot;</span><span class="p">,</span> <span class="s">&quot;TERM=linux&quot;</span><span class="p">,</span> <span class="s">&quot;PATH=/usr/bin:/bin&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">readf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readf_count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">PowerProfile</span> <span class="o">=</span> <span class="n">read_acadapter_file</span><span class="p">(</span><span class="s">&quot;/proc/acpi/ac_adapter/AC0/state&quot;</span><span class="p">);</span>

	<span class="n">readf_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">readf_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mh">0xffff</span><span class="p">;</span>
	<span class="cm">/* We should turn off LED before polling FF51[4]. */</span>

	<span class="cm">/* Turn off LED. */</span>
	<span class="n">btPSR</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">btPSR</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT3</span><span class="p">));</span>

	<span class="cm">/* It need to delay 4us suggested by Jong, 2008-01-16 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* HW radio On/Off according to the value of FF51[4](config0) */</span>
	<span class="n">btConfig0</span> <span class="o">=</span> <span class="n">btPSR</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG0</span><span class="p">);</span>

	<span class="n">eRfPowerStateToSet</span> <span class="o">=</span> <span class="p">(</span><span class="n">btConfig0</span> <span class="o">&amp;</span> <span class="n">BIT4</span><span class="p">)</span> <span class="o">?</span>  <span class="n">eRfOn</span> <span class="o">:</span> <span class="n">eRfOff</span><span class="p">;</span>

	<span class="cm">/* Turn LED back on when radio enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eRfPowerStateToSet</span> <span class="o">==</span> <span class="n">eRfOn</span><span class="p">)</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="n">btPSR</span> <span class="o">|</span> <span class="n">BIT3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">eRfPowerStateToSet</span> <span class="o">==</span> <span class="n">eRfOn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">bActuallySet</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">eRfPowerStateToSet</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">bActuallySet</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bActuallySet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eRfPowerStateToSet</span><span class="p">,</span> <span class="n">RF_CHANGE_BY_HW</span><span class="p">);</span>

		<span class="cm">/* To update the UI status for Power status changed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RFOFF&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RFON&quot;</span><span class="p">;</span>
		<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RadioPowerPath</span><span class="p">;</span>
		<span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">call_usermodehelper</span><span class="p">(</span><span class="n">RadioPowerPath</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">,</span> <span class="n">UMH_WAIT_PROC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">read_acadapter_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rtl8180_pci_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rtl8180_pci_module_exit</span><span class="p">);</span>

</pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME: check if correct ^^ worked with 0x3e8;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
