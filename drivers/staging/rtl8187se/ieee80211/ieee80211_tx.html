<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › ieee80211 › ieee80211_tx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ieee80211_tx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>

<span class="cm">  Copyright(c) 2003 - 2004 Intel Corporation. All rights reserved.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms of version 2 of the GNU General Public License as</span>
<span class="cm">  published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm">  Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in the</span>
<span class="cm">  file called LICENSE.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  James P. Ketrenos &lt;ipw2100-admin@linux.intel.com&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">******************************************************************************</span>

<span class="cm">  Few modifications for Realtek&#39;s Wi-Fi drivers by</span>
<span class="cm">  Andrea Merello &lt;andreamrl@tiscali.it&gt;</span>

<span class="cm">  A special thanks goes to Realtek for their support !</span>

<span class="cm">******************************************************************************/</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>include <linux/config.h></h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &quot;ieee80211.h&quot;</span>


<span class="cm">/*</span>


<span class="cm">802.11 Data Frame</span>


<span class="cm">802.11 frame_contorl for data frames - 2 bytes</span>
<span class="cm">     ,-----------------------------------------------------------------------------------------.</span>
<span class="cm">bits | 0  |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  |  a  |  b  |  c  |  d  |  e   |</span>
<span class="cm">     |----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|------|</span>
<span class="cm">val  | 0  |  0  |  0  |  1  |  x  |  0  |  0  |  0  |  1  |  0  |  x  |  x  |  x  |  x  |  x   |</span>
<span class="cm">     |----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|------|</span>
<span class="cm">desc | ^-ver-^  |  ^type-^  |  ^-----subtype-----^  | to  |from |more |retry| pwr |more |wep   |</span>
<span class="cm">     |          |           | x=0 data,x=1 data+ack | DS  | DS  |frag |     | mgm |data |      |</span>
<span class="cm">     &#39;-----------------------------------------------------------------------------------------&#39;</span>
<span class="cm">		                                    /\</span>
<span class="cm">                                                    |</span>
<span class="cm">802.11 Data Frame                                   |</span>
<span class="cm">           ,--------- &#39;ctrl&#39; expands to &gt;-----------&#39;</span>
<span class="cm">          |</span>
<span class="cm">      ,--&#39;---,-------------------------------------------------------------.</span>
<span class="cm">Bytes |  2   |  2   |    6    |    6    |    6    |  2   | 0..2312 |   4  |</span>
<span class="cm">      |------|------|---------|---------|---------|------|---------|------|</span>
<span class="cm">Desc. | ctrl | dura |  DA/RA  |   TA    |    SA   | Sequ |  Frame  |  fcs |</span>
<span class="cm">      |      | tion | (BSSID) |         |         | ence |  data   |      |</span>
<span class="cm">      `--------------------------------------------------|         |------&#39;</span>
<span class="cm">Total: 28 non-data bytes                                 `----.----&#39;</span>
<span class="cm">                                                              |</span>
<span class="cm">       .- &#39;Frame data&#39; expands to &lt;---------------------------&#39;</span>
<span class="cm">       |</span>
<span class="cm">       V</span>
<span class="cm">      ,---------------------------------------------------.</span>
<span class="cm">Bytes |  1   |  1   |    1    |    3     |  2   |  0-2304 |</span>
<span class="cm">      |------|------|---------|----------|------|---------|</span>
<span class="cm">Desc. | SNAP | SNAP | Control |Eth Tunnel| Type | IP      |</span>
<span class="cm">      | DSAP | SSAP |         |          |      | Packet  |</span>
<span class="cm">      | 0xAA | 0xAA |0x03 (UI)|0x00-00-F8|      |         |</span>
<span class="cm">      `-----------------------------------------|         |</span>
<span class="cm">Total: 8 non-data bytes                         `----.----&#39;</span>
<span class="cm">                                                     |</span>
<span class="cm">       .- &#39;IP Packet&#39; expands, if WEP enabled, to &lt;--&#39;</span>
<span class="cm">       |</span>
<span class="cm">       V</span>
<span class="cm">      ,-----------------------.</span>
<span class="cm">Bytes |  4  |   0-2296  |  4  |</span>
<span class="cm">      |-----|-----------|-----|</span>
<span class="cm">Desc. | IV  | Encrypted | ICV |</span>
<span class="cm">      |     | IP Packet |     |</span>
<span class="cm">      `-----------------------&#39;</span>
<span class="cm">Total: 8 non-data bytes</span>


<span class="cm">802.3 Ethernet Data Frame</span>

<span class="cm">      ,-----------------------------------------.</span>
<span class="cm">Bytes |   6   |   6   |  2   |  Variable |   4  |</span>
<span class="cm">      |-------|-------|------|-----------|------|</span>
<span class="cm">Desc. | Dest. | Source| Type | IP Packet |  fcs |</span>
<span class="cm">      |  MAC  |  MAC  |      |           |      |</span>
<span class="cm">      `-----------------------------------------&#39;</span>
<span class="cm">Total: 18 non-data bytes</span>

<span class="cm">In the event that fragmentation is required, the incoming payload is split into</span>
<span class="cm">N parts of size ieee-&gt;fts.  The first fragment contains the SNAP header and the</span>
<span class="cm">remaining packets are just data.</span>

<span class="cm">If encryption is enabled, each fragment payload size is reduced by enough space</span>
<span class="cm">to add the prefix and postfix (IV and ICV totalling 8 bytes in the case of WEP)</span>
<span class="cm">So if you have 1500 bytes of payload with ieee-&gt;fts set to 500 without</span>
<span class="cm">encryption it will take 3 frames.  With WEP it will take 4 frames as the</span>
<span class="cm">payload of each frame is reduced to 492 bytes.</span>

<span class="cm">* SKB visualization</span>
<span class="cm">*</span>
<span class="cm">*  ,- skb-&gt;data</span>
<span class="cm">* |</span>
<span class="cm">* |    ETHERNET HEADER        ,-&lt;-- PAYLOAD</span>
<span class="cm">* |                           |     14 bytes from skb-&gt;data</span>
<span class="cm">* |  2 bytes for Type --&gt; ,T. |     (sizeof ethhdr)</span>
<span class="cm">* |                       | | |</span>
<span class="cm">* |,-Dest.--. ,--Src.---. | | |</span>
<span class="cm">* |  6 bytes| | 6 bytes | | | |</span>
<span class="cm">* v         | |         | | | |</span>
<span class="cm">* 0         | v       1 | v | v           2</span>
<span class="cm">* 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5</span>
<span class="cm">*     ^     | ^         | ^ |</span>
<span class="cm">*     |     | |         | | |</span>
<span class="cm">*     |     | |         | `T&#39; &lt;---- 2 bytes for Type</span>
<span class="cm">*     |     | |         |</span>
<span class="cm">*     |     | &#39;---SNAP--&#39; &lt;-------- 6 bytes for SNAP</span>
<span class="cm">*     |     |</span>
<span class="cm">*     `-IV--&#39; &lt;-------------------- 4 bytes for IV (WEP)</span>
<span class="cm">*</span>
<span class="cm">*      SNAP HEADER</span>
<span class="cm">*</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">P802_1H_OUI</span><span class="p">[</span><span class="n">P80211_OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">RFC1042_OUI</span><span class="p">[</span><span class="n">P80211_OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ieee80211_put_snap</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">h_proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_snap_hdr</span> <span class="o">*</span><span class="n">snap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">oui</span><span class="p">;</span>

	<span class="n">snap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_snap_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">ssap</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h_proto</span> <span class="o">==</span> <span class="mh">0x8137</span> <span class="o">||</span> <span class="n">h_proto</span> <span class="o">==</span> <span class="mh">0x80f3</span><span class="p">)</span>
		<span class="n">oui</span> <span class="o">=</span> <span class="n">P802_1H_OUI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oui</span> <span class="o">=</span> <span class="n">RFC1042_OUI</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">oui</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">oui</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">oui</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">h_proto</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_encrypt_fragment</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span><span class="o">*</span> <span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_keyidx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

 <span class="cm">/*added to care about null crypt condition, to solve that system hangs when shared keys error*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">||</span> <span class="o">!</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IEEE80211_CRYPT_TKIP</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span> <span class="o">&amp;&amp;</span>
	    <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TKIP countermeasures: dropped &quot;</span>
			       <span class="s">&quot;TX packet to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* To encrypt, frame format is:</span>
<span class="cm">	 * IV (4 bytes), clear payload (including SNAP), ICV (4 bytes) */</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>PR: FIXME: Copied from hostap. Check fragmentation/MSDU/MPDU encryption.</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Host-based IEEE 802.11 fragmentation for TX is not yet supported, so</span>
<span class="cm">	 * call both MSDU and MPDU encryption functions from here. */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_msdu</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_msdu</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_mpdu</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_mpdu</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Encryption failed: len=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">.</span><span class="n">tx_discards</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_txb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ieee80211_txb</span> <span class="o">*</span><span class="nf">ieee80211_alloc_txb</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr_frags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txb_size</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">txb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_txb</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_frags</span><span class="p">),</span>
		<span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">txb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_txb</span><span class="p">));</span>
	<span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">txb</span><span class="o">-&gt;</span><span class="n">frag_size</span> <span class="o">=</span> <span class="n">txb_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">txb_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">nr_frags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="o">--</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">txb</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Classify the to-be send data packet
Need to acquire the sent queue index.</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="nf">ieee80211_classify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">ether_header</span> <span class="o">*</span><span class="n">eh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ether_header</span><span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wme_UP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="k">return</span><span class="p">(</span><span class="n">wme_UP</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">ether_type</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETHERTYPE_IP</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ih</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> \
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ether_header</span><span class="p">));</span>
    <span class="n">wme_UP</span> <span class="o">=</span> <span class="p">(</span><span class="n">ih</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x07</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span><span class="c1">//vtag packet</span>
<span class="cp">#ifndef VLAN_PRI_SHIFT</span>
<span class="cp">#define VLAN_PRI_SHIFT  13              </span><span class="cm">/* Shift to find VLAN user priority */</span><span class="cp"></span>
<span class="cp">#define VLAN_PRI_MASK   7               </span><span class="cm">/* Mask for user priority bits in VLAN */</span><span class="cp"></span>
<span class="cp">#endif</span>
	<span class="n">u32</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">wme_UP</span> <span class="o">=</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&gt;&gt;</span> <span class="n">VLAN_PRI_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VLAN_PRI_MASK</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ETH_P_PAE</span> <span class="o">==</span>  <span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>printk(KERN_WARNING "type = normal packet\n");</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wme_UP</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">wme_UP</span><span class="p">;</span>
  <span class="k">return</span><span class="p">(</span><span class="n">wme_UP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SKBs are added to the ieee-&gt;tx_queue. */</span>
<span class="kt">int</span> <span class="nf">ieee80211_rtl_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_txb</span> <span class="o">*</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="n">frag_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bytes_per_frag</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">,</span> <span class="n">bytes_last_frag</span><span class="p">,</span> <span class="n">frag_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ether_type</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">qos_ctl</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_frag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="n">header</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* Ensure zero initialized */</span>
		<span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">qos_ctl</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span><span class="o">*</span> <span class="n">crypt</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>printk(KERN_WARNING "upper layer packet!\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* If there is no driver handler to take the TXB, don&#39;t bother</span>
<span class="cm">	 * creating it... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hard_start_xmit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">))</span><span class="o">||</span>
	   <span class="p">((</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: No xmit handler.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_classify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">raw_tx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)){</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too small (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ether_type</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">);</span>

		<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_keyidx</span><span class="p">];</span>

		<span class="n">encrypt</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ether_type</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span> <span class="o">&amp;&amp;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">&amp;&amp;</span> <span class="n">ether_type</span> <span class="o">!=</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">ether_type</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="n">eap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">)</span> <span class="o">-</span> <span class="n">SNAP_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
			<span class="n">IEEE80211_DEBUG_EAP</span><span class="p">(</span><span class="s">&quot;TX: IEEE 802.11 EAPOL frame: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">eap_get_type</span><span class="p">(</span><span class="n">eap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="cp">#endif</span>

		<span class="cm">/* Save source and destination addresses */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="cm">/* Advance the SKB to the start of the payload */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">));</span>

		<span class="cm">/* Determine total amount of storage required for TXB packets */</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">QoS_Enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
				<span class="n">fc</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_QOS_DATA</span> <span class="o">|</span>
					<span class="n">IEEE80211_FCTL_WEP</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fc</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_QOS_DATA</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
				<span class="n">fc</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_DATA</span> <span class="o">|</span>
					<span class="n">IEEE80211_FCTL_WEP</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fc</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_DATA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">;</span>
			<span class="cm">/* To DS: Addr1 = BSSID, Addr2 = SA,</span>
<span class="cm">			Addr3 = DA */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not From/To DS: Addr1 = DA, Addr2 = SA,</span>
<span class="cm">			Addr3 = BSSID */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>printk(KERN_WARNING "essid MAC address is %pM", &amp;header.addr1);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>hdr<em>len = IEEE80211</em>3ADDR_LEN;</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* Determine fragmentation size based on destination (multicast</span>
<span class="cm">		* and broadcast are not fragmented) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">frag_size</span> <span class="o">=</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">;</span>
			<span class="n">qos_ctl</span> <span class="o">=</span> <span class="n">QOS_CTL_NOTCONTAIN_ACK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>printk(KERN<em>WARNING "&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;frag</em>size = %d\n", frag_size);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">frag_size</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span><span class="p">;</span><span class="c1">//default:392</span>
			<span class="n">qos_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">QoS_Enable</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">IEEE80211_3ADDR_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* skb-&gt;priority is set in the ieee80211_classify() */</span>
			<span class="n">qos_ctl</span> <span class="o">|=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
			<span class="n">header</span><span class="p">.</span><span class="n">qos_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qos_ctl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">IEEE80211_3ADDR_LEN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Determine amount of payload per fragment.  Regardless of if</span>
<span class="cm">		* this stack is providing the full 802.11 header, one will</span>
<span class="cm">		* eventually be affixed to this fragment -- so we must account for</span>
<span class="cm">		* it when determining the amount of payload space. */</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>bytes<em>per</em>frag = frag<em>size - (IEEE80211</em>3ADDR<em>LEN + (ieee->current</em>network->QoS_Enable ? 2:0));</p></td><td class="code"><div class="highlight"><pre>		<span class="n">bytes_per_frag</span> <span class="o">=</span> <span class="n">frag_size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">CFG_IEEE80211_COMPUTE_FCS</span> <span class="o">|</span> <span class="n">CFG_IEEE80211_RESERVE_FCS</span><span class="p">))</span>
			<span class="n">bytes_per_frag</span> <span class="o">-=</span> <span class="n">IEEE80211_FCS_LEN</span><span class="p">;</span>

		<span class="cm">/* Each fragment may need to have room for encryption pre/postfix */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
			<span class="n">bytes_per_frag</span> <span class="o">-=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_prefix_len</span> <span class="o">+</span>
				<span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_postfix_len</span><span class="p">;</span>

		<span class="cm">/* Number of fragments is the total bytes_per_frag /</span>
<span class="cm">		* payload_per_fragment */</span>
		<span class="n">nr_frags</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">bytes_per_frag</span><span class="p">;</span>
		<span class="n">bytes_last_frag</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">%</span> <span class="n">bytes_per_frag</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_last_frag</span><span class="p">)</span>
			<span class="n">nr_frags</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bytes_last_frag</span> <span class="o">=</span> <span class="n">bytes_per_frag</span><span class="p">;</span>

		<span class="cm">/* When we allocate the TXB we allocate enough space for the reserve</span>
<span class="cm">		* and full fragment bytes (bytes_per_frag doesn&#39;t include prefix,</span>
<span class="cm">		* postfix, header, FCS, etc.) */</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="n">ieee80211_alloc_txb</span><span class="p">(</span><span class="n">nr_frags</span><span class="p">,</span> <span class="n">frag_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not allocate TXB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">encrypted</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">;</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_frag</span> <span class="o">=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">skb_frag</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_prefix_len</span><span class="p">);</span>

			<span class="n">frag_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">frag_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

			<span class="cm">/* If this is not the last fragment, then add the MOREFRAGS</span>
<span class="cm">			* bit to the frame control */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
					<span class="n">fc</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">);</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes_per_frag</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* The last fragment takes the remaining length */</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes_last_frag</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">QoS_Enable</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>add 1 only indicate to corresponding seq number control 2006/7/12</p></td><td class="code"><div class="highlight"><pre>			  <span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">4</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>printk(KERN<em>WARNING "skb->priority = %d,", skb->priority);
printk(KERN</em>WARNING "type:%d: seq = %d\n",UP2AC(skb->priority),ieee->seq_ctrl[UP2AC(skb->priority)+1]);</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			  <span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">4</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>frag<em>hdr->seq</em>ctl = cpu<em>to</em>le16(ieee->seq_ctrl&lt;&lt;4 | i);</p></td><td class="code"><div class="highlight"><pre>			<span class="cm">/* Put a SNAP header on the first fragment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ieee80211_put_snap</span><span class="p">(</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)),</span>
					<span class="n">ether_type</span><span class="p">);</span>
				<span class="n">bytes</span> <span class="o">-=</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">bytes</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

			<span class="cm">/* Advance the SKB... */</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

			<span class="cm">/* Encryption routine will move the header forward in order</span>
<span class="cm">			* to insert the IV between the header and the payload */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
				<span class="n">ieee80211_encrypt_fragment</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb_frag</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">CFG_IEEE80211_COMPUTE_FCS</span> <span class="o">|</span> <span class="n">CFG_IEEE80211_RESERVE_FCS</span><span class="p">))</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Advance sequence number in data frame.
printk(KERN<em>WARNING "QoS Enalbed? %s\n", ieee->current</em>network.QoS_Enable?"Y":"N");</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">QoS_Enable</span><span class="p">)</span> <span class="p">{</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		  <span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  		  <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		  <span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too small (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txb</span> <span class="o">=</span> <span class="n">ieee80211_alloc_txb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not allocate TXB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">encrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">success:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">){</span>
			<span class="n">ieee80211_softmac_xmit</span><span class="p">(</span><span class="n">txb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hard_start_xmit</span><span class="p">)(</span><span class="n">txb</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ieee80211_txb_free</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

 <span class="nl">failed:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
