<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › ieee80211 › ieee80211_rx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ieee80211_rx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Original code based Host AP (software wireless LAN access point) driver</span>
<span class="cm"> * for Intersil Prism2/2.5/3 - hostap.o module, common routines</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001-2002, SSH Communications Security Corp and Jouni Malinen</span>
<span class="cm"> * &lt;jkmaline@cc.hut.fi&gt;</span>
<span class="cm"> * Copyright (c) 2002-2003, Jouni Malinen &lt;jkmaline@cc.hut.fi&gt;</span>
<span class="cm"> * Copyright (c) 2004, Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation. See README and COPYING for</span>
<span class="cm"> * more details.</span>
<span class="cm"> ******************************************************************************</span>

<span class="cm">  Few modifications for Realtek&#39;s Wi-Fi drivers by</span>
<span class="cm">  Andrea Merello &lt;andreamrl@tiscali.it&gt;</span>

<span class="cm">  A special thanks goes to Realtek for their support !</span>

<span class="cm">******************************************************************************/</span>


<span class="cp">#include &lt;linux/compiler.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>include <linux/config.h></h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>

<span class="cp">#include &quot;ieee80211.h&quot;</span>
<span class="cp">#include &quot;dot11d.h&quot;</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_monitor_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_80211_RAW</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span>
<span class="nf">ieee80211_frag_cache_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">,</span><span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_FRAG_CACHE_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG_FRAG</span><span class="p">(</span>
				<span class="s">&quot;expiring fragment cache entry &quot;</span>
				<span class="s">&quot;seq=%u last_frag=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">==</span> <span class="n">seq</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">frag</span> <span class="o">||</span> <span class="n">frag</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">ieee80211_frag_cache_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="n">hdr_3addrqos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="n">hdr_4addrqos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_4addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_4addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_3addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_3addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reserve enough space to fit maximum frame length */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span><span class="p">)</span> <span class="o">+</span>
				    <span class="mi">8</span> <span class="cm">/* LLC */</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="cm">/* alignment */</span> <span class="o">+</span>
				    <span class="mi">8</span> <span class="cm">/* WEP */</span> <span class="o">+</span>
				    <span class="n">ETH_ALEN</span> <span class="cm">/* WDS */</span> <span class="o">+</span>
				    <span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span><span class="o">?</span><span class="mi">2</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="cm">/* QOS Control */</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]];</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_FRAG_CACHE_LEN</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* received a fragment of a frame for which the head fragment</span>
<span class="cm">		 * should have already been received */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">ieee80211_frag_cache_find</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
						  <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_frag_cache_invalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="n">hdr_3addrqos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="n">hdr_4addrqos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_4addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_4addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_3addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_3addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">ieee80211_frag_cache_find</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
					  <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_FRAG</span><span class="p">(</span>
			<span class="s">&quot;could not invalidate fragment cache &quot;</span>
			<span class="s">&quot;entry (seq=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ieee80211_rx_frame_mgtmt</span>
<span class="cm"> *</span>
<span class="cm"> * Responsible for handling management control frames</span>
<span class="cm"> *</span>
<span class="cm"> * Called by ieee80211_rx */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_frame_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">stype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>cheat the the hdr type</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* On the struct stats definition there is written that</span>
<span class="cm">	 * this is not mandatory.... but seems that the probe</span>
<span class="cm">	 * response parser uses it</span>
<span class="cm">	 */</span>
	<span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">ieee80211_rx_mgt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			 <span class="n">rx_stats</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_rx_frame_softmac</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">);</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>



<span class="cm">/* See IEEE 802.1H for LLC/SNAP encapsulation/decapsulation */</span>
<span class="cm">/* Ethernet-II snap header (RFC1042 for most EtherTypes) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rfc1042_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
<span class="cm">/* Bridge-Tunnel header (for EtherTypes ETH_P_AARP and ETH_P_IPX) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bridge_tunnel_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
<span class="cm">/* No encapsulation header if EtherType &lt; 0x600 (=length) */</span>

<span class="cm">/* Called by ieee80211_rx_frame_decrypt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">hdrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">ethertype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>

	<span class="cm">/* check that the frame is unicast frame to us */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
	    <span class="n">IEEE80211_FCTL_TODS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ToDS frame with own addr BSSID and DA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
		   <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">&amp;&amp;</span>
		   <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FromDS frame with own addr as DA */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check for port access entity Ethernet type */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>pos = skb->data + 24;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pos</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethertype</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called only as a tasklet (software IRQ), by ieee80211_rx */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_frame_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_IEEE80211_CRYPT_TKIP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TKIP countermeasures: dropped &quot;</span>
			       <span class="s">&quot;received packet from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
			<span class="s">&quot;decryption failed (SA=%pM&quot;</span>
			<span class="s">&quot;) res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Decryption failed ICV &quot;</span>
					     <span class="s">&quot;mismatch (key %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">.</span><span class="n">rx_discards_undecryptable</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ), by ieee80211_rx */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_frame_decrypt_msdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">keyidx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_msdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_msdu</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: MSDU decryption/MIC verification failed&quot;</span>
		       <span class="s">&quot; (SA=%pM keyidx=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* this function is stolen from ipw2200 driver*/</span>
<span class="cp">#define IEEE_PACKET_RETRY_TIME (5*HZ)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_duplicate_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">last_seq</span><span class="p">,</span> <span class="o">*</span><span class="n">last_frag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="n">hdr_3addrqos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="n">hdr_4addrqos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>TO2DS and QoS</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_4addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_4addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span> <span class="c1">//QoS</span>
	  <span class="n">hdr_3addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_3addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// no QoS</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee_ibss_seq</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">%</span> <span class="n">IEEE_IBSS_MAC_HASH_SIZE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>for (pos = (head)->next; pos != (head); pos = pos->next)</p></td><td class="code"><div class="highlight"><pre>		<span class="n">__list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee_ibss_seq</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>if (memcmp(entry->mac, mac, ETH_ALEN)){</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_ibss_seq</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Cannot malloc new mac entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">frag_num</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">packet_time</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last_seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">frag_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_time</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">packet_time</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">last_seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxseq_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxfrag_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_time</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_packet_time</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>if(tid != 0) {
    printk(KERN<em>WARNING ":)))))))))))%x %x %x, fc(%x)\n", tid, *last</em>seq, seq, header->frame_ctl);
}</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">last_seq</span> <span class="o">==</span> <span class="n">seq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="o">*</span><span class="n">last_time</span> <span class="o">+</span> <span class="n">IEEE_PACKET_RETRY_TIME</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_frag</span> <span class="o">==</span> <span class="n">frag</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>printk(KERN_WARNING "[1] go drop!\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_frag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">frag</span><span class="p">)</span>
			<span class="cm">/* out-of-order fragment */</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>printk(KERN_WARNING "[2] go drop!\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">last_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>

	<span class="o">*</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
	<span class="o">*</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop:</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>BUG<em>ON(!(fc &amp; IEEE80211</em>FCTL_RETRY));
printk("DUP\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* All received frames are sent to this function. @skb contains the frame in</span>
<span class="cm"> * IEEE 802.11 format, i.e., in the format it was sent over air.</span>
<span class="cm"> * This function is called only as a tasklet (software IRQ). */</span>
<span class="kt">int</span> <span class="nf">ieee80211_rtl_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>struct r8180<em>priv *priv = (struct r8180</em>priv *)ieee80211_priv(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="kt">size_t</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ethertype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dst</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">src</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>cheat the the hdr type</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: SKB length &lt; 10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">stype</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>

	<span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>YJ,add,080828,for keep alive</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxUnicast</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxUnicast</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>YJ,add,080828,for keep alive,end</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_monitor_rx</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

		<span class="cm">/* allow NULL decrypt to indicate an station specific override</span>
<span class="cm">		 * for default encryption */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			      <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This seems to be triggered by some (multicast?)</span>
<span class="cm">			 * frames from other than current BSS, so just drop the</span>
<span class="cm">			 * frames silently instead of filling system log with</span>
<span class="cm">			 * these reports. */</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Decryption failed (not set)&quot;</span>
					     <span class="s">&quot; (SA=%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">.</span><span class="n">rx_discards_undecryptable</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_DATA_HDR3_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>if QoS enabled, should check the sequence for each of the AC</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">is_duplicate_packet</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_rx_frame_mgmt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data frame - extract src/dst addresses */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_DATA_HDR4_LEN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>


	<span class="cm">/* Nullfunc frames may have PS-bit set, so they must be passed to</span>
<span class="cm">	 * hostap_handle_sta_rx() before being dropped here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFACK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFPOLL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFACKPOLL</span><span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_QOS_DATA</span><span class="c1">//add by David,2006.8.4</span>
	    <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">)</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
				<span class="s">&quot;RX: dropped data frame &quot;</span>
				<span class="s">&quot;with no data (type=0x%02x, &quot;</span>
				<span class="s">&quot;subtype=0x%02x, len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxDataInPeriod</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxOkTotal</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* skb: hdr + (possibly fragmented, possibly encrypted) payload */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">keyidx</span> <span class="o">=</span> <span class="n">ieee80211_rx_frame_decrypt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">crypt</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* skb: hdr + (possibly fragmented) plaintext payload */</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>PR: FIXME: hostap has additional conditions in the "if" below:
ieee->host<em>decrypt &amp;&amp; (fc &amp; IEEE80211</em>FCTL_WEP) &amp;&amp;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flen</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag_skb</span> <span class="o">=</span> <span class="n">ieee80211_frag_cache_get</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">IEEE80211_DEBUG_FRAG</span><span class="p">(</span><span class="s">&quot;Rx Fragment received (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_RX</span> <span class="o">|</span> <span class="n">IEEE80211_DL_FRAG</span><span class="p">,</span>
					<span class="s">&quot;Rx cannot get skb from fragment &quot;</span>
					<span class="s">&quot;cache (morefrag=%d seq=%u frag=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="n">frag</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">flen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">flen</span> <span class="o">-=</span> <span class="n">hdrlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">flen</span> <span class="o">&gt;</span> <span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: host decrypted and &quot;</span>
			       <span class="s">&quot;reassembled frame did not fit skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ieee80211_frag_cache_invalidate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy first fragment (including full headers) into</span>
<span class="cm">			 * beginning of the fragment cache skb */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">frag_skb</span><span class="p">,</span> <span class="n">flen</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">flen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* append frame payload to the end of the fragment</span>
<span class="cm">			 * cache skb */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">frag_skb</span><span class="p">,</span> <span class="n">flen</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">,</span>
			       <span class="n">flen</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* more fragments expected - leave the skb in fragment</span>
<span class="cm">			 * cache for now; it will be delivered to upper layers</span>
<span class="cm">			 * after all fragments have been received */</span>
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* this was the last fragment and the frame will be</span>
<span class="cm">		 * delivered, so remove skb from fragment cache */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">frag_skb</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ieee80211_frag_cache_invalidate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* skb: hdr + (possible reassembled) full MSDU payload; possibly still</span>
<span class="cm">	 * encrypted/authenticated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_rx_frame_decrypt_msdu</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">crypt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="cm">/*ieee-&gt;ieee802_1x &amp;&amp;*/</span>
		    <span class="n">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">))</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
			<span class="cm">/* pass unencrypted EAPOL frames even if encryption is</span>
<span class="cm">			 * configured */</span>
			<span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="n">eap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="mi">24</span><span class="p">);</span>
			<span class="n">IEEE80211_DEBUG_EAP</span><span class="p">(</span><span class="s">&quot;RX: IEEE 802.1X EAPOL frame: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">eap_get_type</span><span class="p">(</span><span class="n">eap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
				<span class="s">&quot;encryption configured, but RX &quot;</span>
				<span class="s">&quot;frame not encrypted (SA=%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="n">eap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="mi">24</span><span class="p">);</span>
			<span class="n">IEEE80211_DEBUG_EAP</span><span class="p">(</span><span class="s">&quot;RX: IEEE 802.1X EAPOL frame: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">eap_get_type</span><span class="p">(</span><span class="n">eap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
			<span class="s">&quot;dropped unencrypted RX data &quot;</span>
			<span class="s">&quot;frame from %pM&quot;</span>
			<span class="s">&quot; (drop_unencrypted=1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">	if(ieee80211_is_eapol_frame(ieee, skb, hdrlen)) {</span>
<span class="cm">		printk(KERN_WARNING &quot;RX: IEEE802.1X EPAOL frame!\n&quot;);</span>
<span class="cm">	}</span>
<span class="cm">*/</span>
	<span class="cm">/* skb: hdr + (possible reassembled) full plaintext payload */</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">payload</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>


	<span class="cm">/* convert hdr + possible LLC headers into Ethernet header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdrlen</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">rfc1042_header</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	      <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_AARP</span> <span class="o">&amp;&amp;</span> <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_IPX</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">memcmp</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">bridge_tunnel_header</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* remove RFC1042 or Bridge-Tunnel encapsulation and</span>
<span class="cm">		 * replace EtherType */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">SNAP_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
		<span class="cm">/* Leave Ethernet header part of hdr and full payload */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span> <span class="cm">/* 802.11 crc not sufficient */</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rx_ps_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">rx_exit:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">rx_dropped:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Returning 0 indicates to caller that we have not handled the SKB--</span>
<span class="cm">	 * so it is still allocated and can be used again by underlying</span>
<span class="cm">	 * hardware as a DMA target */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MGMT_FRAME_FIXED_PART_LENGTH		0x24</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ieee80211_is_ofdm_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IEEE80211_BASIC_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_6MB</span>:
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_9MB</span>:
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_12MB</span>:
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_18MB</span>:
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_24MB</span>:
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_36MB</span>:
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_48MB</span>:
	<span class="k">case</span> <span class="n">IEEE80211_OFDM_RATE_54MB</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ieee80211_SignalStrengthTranslate</span><span class="p">(</span>
	<span class="kt">int</span>  <span class="n">CurrSS</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">RetSS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Step 1. Scale mapping.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">71</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">+</span> <span class="p">((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">41</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">78</span> <span class="o">+</span> <span class="p">((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">66</span> <span class="o">+</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">21</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">54</span> <span class="o">+</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="p">(((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="n">CurrSS</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>RT<em>TRACE(COMP</em>DBG, DBG_LOUD, ("##### After Mapping:  LastSS: %d, CurrSS: %d, RetSS: %d\n", LastSS, CurrSS, RetSS));</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Step 2. Smoothing.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>RT<em>TRACE(COMP</em>DBG, DBG_LOUD, ("$$$$$ After Smoothing:  LastSS: %d, CurrSS: %d, RetSS: %d\n", LastSS, CurrSS, RetSS));</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">RetSS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_extract_country_ie</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="n">info_element</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="n">addr2</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">Dot11d_UpdateCountryIe</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">addr2</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>070305, rcnjko: I update country IE watch dog here because
some AP (e.g. Cisco 1242) don't include country IE in their
probe response frame.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">IS_EQUAL_CIE_SRC</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">addr2</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">UPDATE_CIE_WATCHDOG</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ieee80211_TranslateToDbm</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignalStrengthIndex</span>	<span class="c1">// 0-100 index.</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignalPower</span><span class="p">;</span> <span class="c1">// in dBm.</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Translate to dBm (x=0.5y-95).</p></td><td class="code"><div class="highlight"><pre>	<span class="n">SignalPower</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">SignalStrengthIndex</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">SignalPower</span> <span class="o">-=</span> <span class="mi">95</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SignalPower</span><span class="p">;</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ieee80211_network_init</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
	<span class="kt">char</span> <span class="n">rates_str</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="n">info_element</span><span class="p">;</span>
 	<span class="n">u16</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">hOpRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">curRate_ex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Pull out fixed field data */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="cm">/* Where to pull this? beacon-&gt;listen_interval;*/</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_associate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>by amy 080312</p></td><td class="code"><div class="highlight"><pre>	<span class="n">network</span><span class="o">-&gt;</span><span class="n">HighestOperaRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>by amy 080312</p></td><td class="code"><div class="highlight"><pre>	<span class="n">network</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_IE_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">==</span> <span class="n">IEEE80211_52GHZ_BAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for A band (No DS info) */</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">received_channel</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_CCK</span><span class="p">;</span>

 	<span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 	<span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 	<span class="n">info_element</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info_element</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">beacon</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;SCAN: parse failed: info_element-&gt;len + 2 &gt; left : info_element-&gt;len+2=%d left=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span><span class="p">),</span>
					     <span class="n">left</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
               	<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MFIE_TYPE_SSID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_empty_essid</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
        		<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&lt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
                		<span class="n">memset</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">+</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">-</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_SSID: &#39;%s&#39; len=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_RATES</span>:
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">rates_str</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">MAX_RATES_LENGTH</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">curRate</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">hOpRate</span> <span class="o">&lt;</span> <span class="n">curRate</span> <span class="p">)</span>
					<span class="n">hOpRate</span> <span class="o">=</span> <span class="n">curRate</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates_str</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">rates_str</span><span class="p">),</span> <span class="s">&quot;%02X &quot;</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ofdm_rate</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_OFDM</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					    <span class="n">IEEE80211_BASIC_RATE_MASK</span><span class="p">)</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
							<span class="o">~</span><span class="n">NETWORK_HAS_CCK</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_RATES: &#39;%s&#39; (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">rates_str</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_RATES_EX</span>:
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">rates_str</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">MAX_RATES_EX_LENGTH</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">curRate_ex</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">hOpRate</span> <span class="o">&lt;</span> <span class="n">curRate_ex</span> <span class="p">)</span>
					<span class="n">hOpRate</span> <span class="o">=</span> <span class="n">curRate_ex</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates_str</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">rates_str</span><span class="p">),</span> <span class="s">&quot;%02X &quot;</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ofdm_rate</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_OFDM</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					    <span class="n">IEEE80211_BASIC_RATE_MASK</span><span class="p">)</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
							<span class="o">~</span><span class="n">NETWORK_HAS_CCK</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_RATES_EX: &#39;%s&#39; (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">rates_str</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_DS_SET</span>:
  			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_DS_SET: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">==</span> <span class="n">IEEE80211_24GHZ_BAND</span><span class="p">)</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

	 	<span class="k">case</span> <span class="n">MFIE_TYPE_FH_SET</span>:
  			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_FH_SET: ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_CF_SET</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_CF_SET: ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_TIM</span>:

			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">=</span> <span class="n">IEEE80211_DTIM_VALID</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">|=</span> <span class="n">IEEE80211_DTIM_MBCAST</span><span class="p">;</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>printk("offset1:%x aid:%x\n",offset, ieee->assoc_id);</p></td><td class="code"><div class="highlight"><pre>			<span class="cm">/* add and modified for ps 2008.1.22 */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="o">*</span><span class="n">offset</span> <span class="o">||</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span><span class="c1">// + ((aid % 8)? 0 : 1) ;</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>printk("offset:%x data:%x, ucast:%d\n", offset,
info<em>element->data[3+offset] ,
info</em>element->data[3+offset] &amp; (1&lt;&lt;(ieee->assoc_id%8)));</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="o">%</span><span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">|=</span> <span class="n">IEEE80211_DTIM_UCAST</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_IBSS_SET</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_IBSS_SET: ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_CHALLENGE</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_CHALLENGE: ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_GENERIC</span>:</pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>nic is 87B</p></td><td class="code"><div class="highlight"><pre>			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_GENERIC: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span>  <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
							 <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">info_element</span><span class="p">,</span>
				       <span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xe0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4c</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">nic_type</span><span class="p">)</span> <span class="p">{</span><span class="c1">//nic 87</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">5</span>  <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>printk(KERN<em>WARNING "wmm info updated: %x\n", info</em>element->data[6]);
WMM Information Element</p></td><td class="code"><div class="highlight"><pre>				<span class="n">network</span><span class="o">-&gt;</span><span class="n">wmm_info</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span>  <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Not care about version at present.
WMM Information Element
printk(KERN<em>WARNING "wmm info&amp;param updated: %x\n", info</em>element->data[6]);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">network</span><span class="o">-&gt;</span><span class="n">wmm_info</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>WMM Parameter Element</p></td><td class="code"><div class="highlight"><pre>				<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">));</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_RSN</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_RSN: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
						 <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="n">info_element</span><span class="p">,</span>
			       <span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFIE_TYPE_COUNTRY</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_COUNTRY: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><pre><code>    printk("=====&gt;Receive &lt;%s&gt; Country IE\n",network-&gt;ssid);
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee80211_extract_country_ie</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info_element</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;unsupported IE %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
  		<span class="p">}</span>

		<span class="n">left</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element_hdr</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">info_element</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="p">)</span>
                	<span class="o">&amp;</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">];</span>
  	<span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>by amy 080312</p></td><td class="code"><div class="highlight"><pre>	<span class="n">network</span><span class="o">-&gt;</span><span class="n">HighestOperaRate</span> <span class="o">=</span> <span class="n">hOpRate</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>by amy 080312</p></td><td class="code"><div class="highlight"><pre>	<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">==</span> <span class="n">IEEE80211_52GHZ_BAND</span><span class="p">)</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_A</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_OFDM</span><span class="p">)</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">IEEE_G</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_CCK</span><span class="p">)</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">IEEE_B</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Filtered out &#39;%s (%pM)&#39; &quot;</span>
				     <span class="s">&quot;network.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						  <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				     <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_empty_essid</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">ieee80211_TranslateToDbm</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">signalstrength</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>stats->noise = stats->signal - stats->noise;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ieee80211_TranslateToDbm</span><span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">signalstrength</span><span class="p">)</span> <span class="o">-</span> <span class="mi">25</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_same_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span> <span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* A network is only a duplicate if the channel, BSSID, ESSID</span>
<span class="cm">	 * and the capability field (in particular IBSS and BSS) all match.</span>
<span class="cm">	 * We treat all &lt;hidden&gt; with the same BSSID and channel</span>
<span class="cm">	 * as one network */</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>  <span class="c1">//YJ,mod,080819,for hidden ap</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>((src->ssid<em>len == dst->ssid</em>len) &amp;&amp;</p></td><td class="code"><div class="highlight"><pre>		<span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="c1">//YJ,mod,080819,for hidden ap</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>!memcmp(src->ssid, dst->ssid, src->ssid_len) &amp;&amp;</p></td><td class="code"><div class="highlight"><pre>		<span class="p">((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">)</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">signal</span> <span class="o">=</span> <span class="n">ieee80211_TranslateToDbm</span><span class="p">(</span><span class="n">quality</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>noise = signal - src->stats.noise;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">noise</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">noise</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">noise</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>if(strcmp(dst->ssid, "linksys_lzm000") == 0)
printk("ssid:%s, quality:%d, signal:%d\n", dst->ssid, quality, signal);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_stats</span><span class="p">));</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>printk("==================>stats.signal is %d\n",dst->stats.signal);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="p">;</span>


	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">HighestOperaRate</span><span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">HighestOperaRate</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>printk("==========>in %s: src->ssid is %s,chan is %d\n",<strong>func</strong>,src->ssid,src->channel);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>YJ,add,080819,for hidden ap</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>if(src->ssid_len == 13)
printk("=====================>>>>>>>> Dst ssid: %s Src ssid: %s\n", dst->ssid, src->ssid);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>YJ,add,080819,for hidden ap,end</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">atim_window</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">dtim_data</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>printk("update:%s, dtim<em>period:%x, dtim</em>data:%x\n", src->ssid, src->dtim<em>period, src->dtim</em>data);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">;</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/* dst-&gt;last_associate is not overwritten */</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>disable QoS process now, added by David 2006/7/25</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 1</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">wmm_info</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_info</span><span class="p">;</span> <span class="c1">//sure to exist in beacon or probe response frame.</span>
<span class="cm">/*</span>
<span class="cm">	if((dst-&gt;wmm_info^src-&gt;wmm_info)&amp;0x0f) {//Param Set Count change, update Parameter</span>
<span class="cm">	  memcpy(dst-&gt;wmm_param, src-&gt;wmm_param, IEEE80211_AC_PRAM_LEN);</span>
<span class="cm">	}</span>
<span class="cm">*/</span>
	<span class="k">if</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="o">||</span> \
	   <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="o">||</span> \
	   <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="o">||</span> \
	   <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">,</span> <span class="n">WME_AC_PRAM_LEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//for Rtl8187 simulation</span>
<span class="cp">#endif</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">SignalStrength</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span><span class="p">);</span>
<span class="p">}</span>


<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_process_probe_response</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="n">network</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">oldest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
	<span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="n">info_element</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">renew</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wmm_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_beacon</span> <span class="o">=</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>  <span class="c1">//YJ,add,080819,for hidden ap</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">));</span>

	<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span>
		<span class="s">&quot;&#39;%s&#39; (%pM): %c%c%c%c %c%c%c%c-%c%c%c%c %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">escape_essid</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
		<span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xf</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xe</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xd</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xc</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xb</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xa</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x9</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x8</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x7</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x6</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x5</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x4</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x3</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x2</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x1</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x0</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_network_init</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Dropped &#39;%s&#39; (%pM) via %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						  <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
				     <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span>
				     <span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">?</span>
				     <span class="s">&quot;PROBE RESPONSE&quot;</span> <span class="o">:</span> <span class="s">&quot;BEACON&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>For Asus EeePc request,
(1) if wireless adapter receive get any 802.11d country code in AP beacon,
   wireless adapter should follow the country code.
(2)  If there is no any country code in beacon,
      then wireless adapter should do active scan from ch1~11 and
      passive scan from ch12~14</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Case 1: Country code</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsLegalChannel</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Country code, filter probe response at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Case 2: No any country code.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">else</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Filter over channel ch12~14</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Global Domain, filter probe response at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Case 1: Country code</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsLegalChannel</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Country code, filter beacon at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Case 2: No any country code.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">else</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Filter over channel ch12~14</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Global Domain, filter beacon at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* The network parsed correctly -- so now we scan our known networks</span>
<span class="cm">	 * to see if we can find it in our list.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE:  This search is definitely not optimized.  Once its doing</span>
<span class="cm">	 *        the &quot;right thing&quot; we&#39;ll optimize it for efficiency if</span>
<span class="cm">	 *        necessary */</span>

	<span class="cm">/* Search for this entry in the list and update it if it is</span>
<span class="cm">	 * already there. */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">is_same_network</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="n">ieee</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wmm_info</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">wmm_info</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>YJ,add,080819,for hidden ap</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">is_beacon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">network</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">network</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxBcnInPeriod</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>YJ,add,080819,for hidden ap,end
printk("====>network.ssid=%s cur<em>ssid=%s\n", network.ssid, ieee->current</em>network.ssid);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">update_network</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_same_network</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="n">ieee</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">oldest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">&lt;</span> <span class="n">oldest</span><span class="o">-&gt;</span><span class="n">last_scanned</span><span class="p">))</span>
			<span class="n">oldest</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we didn&#39;t find a match, then get a new network slot to initialize</span>
<span class="cm">	 * with this beacon&#39;s information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If there are no more slots, expire the oldest */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oldest</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">oldest</span><span class="p">;</span>
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Expired &#39;%s&#39; (%pM) from &quot;</span>
					     <span class="s">&quot;network list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">escape_essid</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
							  <span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
					     <span class="n">target</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Otherwise just pull from the free list */</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>


<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Adding &#39;%s&#39; (%pM) via %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
						  <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">),</span>
				     <span class="n">network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span>
				     <span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">?</span>
				     <span class="s">&quot;PROBE RESPONSE&quot;</span> <span class="o">:</span> <span class="s">&quot;BEACON&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="p">));</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Updating &#39;%s&#39; (%pM) via %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						  <span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				     <span class="n">target</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span>
				     <span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">?</span>
				     <span class="s">&quot;PROBE RESPONSE&quot;</span> <span class="o">:</span> <span class="s">&quot;BEACON&quot;</span><span class="p">);</span>

		<span class="cm">/* we have an entry and we are going to update it. But this entry may</span>
<span class="cm">		 * be already expired. In this case we do the same as we found a new</span>
<span class="cm">		 * net and call the new_net handler</span>
<span class="cm">		 */</span>
		<span class="n">renew</span> <span class="o">=</span> <span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>YJ,add,080819,for hidden ap</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">is_beacon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">network</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">network</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>if(strncmp(network.ssid, "linksys-c",9) == 0)
printk("====>2 network.ssid=%s FLAG=%d target.ssid=%s FLAG=%d\n", network.ssid, network.flags, target->ssid, target->flags);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(((</span><span class="n">network</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">)</span> <span class="o">==</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">)</span> \
		    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">)))</span>\
		    <span class="o">||</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">))))</span>
			<span class="n">renew</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>YJ,add,080819,for hidden ap,end</p></td><td class="code"><div class="highlight"><pre>		<span class="n">update_network</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_rx_mgt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">))</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_BEACON</span>:
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;received BEACON (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Beacon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee80211_process_probe_response</span><span class="p">(</span>
			<span class="n">ieee</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span>:
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;received PROBE RESPONSE (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Probe response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee80211_process_probe_response</span><span class="p">(</span>
			<span class="n">ieee</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
