<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › ieee80211 › ieee80211_softmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ieee80211_softmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* IEEE 802.11 SoftMAC layer</span>
<span class="cm"> * Copyright (c) 2005 Andrea Merello &lt;andreamrl@tiscali.it&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Mostly extracted from the rtl8180-sa2400 driver for the</span>
<span class="cm"> * in-kernel generic ieee802.11 stack.</span>
<span class="cm"> *</span>
<span class="cm"> * Few lines might be stolen from other part of the ieee80211</span>
<span class="cm"> * stack. Copyright who own it&#39;s copyright</span>
<span class="cm"> *</span>
<span class="cm"> * WPA code stolen from the ipw2200 driver.</span>
<span class="cm"> * Copyright who own it&#39;s copyright.</span>
<span class="cm"> *</span>
<span class="cm"> * released under the GPL</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;ieee80211.h&quot;</span>

<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;dot11d.h&quot;</span>
<span class="n">u8</span> <span class="n">rsn_authen_cipher_suite</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xAC</span><span class="p">,</span><span class="mh">0x00</span><span class="p">},</span> <span class="c1">//Use group key, //Reserved</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xAC</span><span class="p">,</span><span class="mh">0x01</span><span class="p">},</span> <span class="c1">//WEP-40         //RSNA default</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xAC</span><span class="p">,</span><span class="mh">0x02</span><span class="p">},</span> <span class="c1">//TKIP           //NONE		//{used just as default}</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xAC</span><span class="p">,</span><span class="mh">0x03</span><span class="p">},</span> <span class="c1">//WRAP-historical</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xAC</span><span class="p">,</span><span class="mh">0x04</span><span class="p">},</span> <span class="c1">//CCMP</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0F</span><span class="p">,</span><span class="mh">0xAC</span><span class="p">,</span><span class="mh">0x05</span><span class="p">},</span> <span class="c1">//WEP-104</span>
<span class="p">};</span>

<span class="kt">short</span> <span class="nf">ieee80211_is_54g</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">ieee80211_is_shortslot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns the total length needed for placing the RATE MFIE</span>
<span class="cm"> * tag and the EXTENDED RATE MFIE tag if needed.</span>
<span class="cm"> * It encludes two bytes per tag for the tag itself and its len</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ieee80211_MFIE_rate_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CCK_MODULATION</span><span class="p">)</span>
		<span class="n">rate_len</span> <span class="o">=</span> <span class="n">IEEE80211_CCK_RATE_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">)</span>

		<span class="n">rate_len</span> <span class="o">+=</span> <span class="n">IEEE80211_OFDM_RATE_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rate_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* place the MFIE rate, tag to the memory (double) poised.</span>
<span class="cm"> * Then it updates the pointer so that</span>
<span class="cm"> * it points after the new MFIE tag added.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ieee80211_MFIE_Brate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CCK_MODULATION</span><span class="p">){</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_1MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_2MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_5MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_11MB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We may add an option for custom rates that specific HW might support */</span>
	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_MFIE_Grate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">){</span>

		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES_EX</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_6MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_9MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_12MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_18MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_24MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_36MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_48MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_54MB</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* We may add an option for custom rates that specific HW might support */</span>
	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_WMM_Info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span> <span class="c1">//0</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span><span class="c1">//5</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_USPD</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">wmm_info</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="o">|</span><span class="n">MAX_SP_Len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MAX_SP_Len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MAX_SP_Len</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_TURBO_Info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span> <span class="c1">//0</span>
        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">;</span>
        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span><span class="c1">//5</span>
        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
        <span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;This is enable turbo mode IE process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">enqueue_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nh</span><span class="p">;</span>
	<span class="n">nh</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MGMT_QUEUE_NUM</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * if the queue is full but we have newer frames then</span>
<span class="cm"> * just overwrites the oldest.</span>
<span class="cm"> *</span>
<span class="cm"> * if (nh == ieee-&gt;mgmt_queue_tail)</span>
<span class="cm"> *		return -1;</span>
<span class="cm"> */</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span> <span class="o">=</span> <span class="n">nh</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_ring</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>return 0;</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">dequeue_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">==</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_ring</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span><span class="p">];</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MGMT_QUEUE_NUM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_mgmt_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">ieee80211_sta_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">nl</span><span class="p">);</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">softmac_mgmt_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">single</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="o">*</span><span class="n">header</span><span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* called with 2nd param 0, no mgmt lock required */</span>
	<span class="n">ieee80211_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">single</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">){</span>

			<span class="n">enqueue_mgmt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* avoid watchdog triggers */</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* avoid watchdog triggers */</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">softmac_ps_mgmt_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">short</span> <span class="n">single</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="o">*</span><span class="n">header</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>


	<span class="k">if</span><span class="p">(</span><span class="n">single</span><span class="p">){</span>

		<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* avoid watchdog triggers */</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>

	<span class="p">}</span><span class="k">else</span><span class="p">{</span>

		<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* avoid watchdog triggers */</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>dev<em>kfree</em>skb_any(skb);//edit by thomas</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>by amy for power save</p></td><td class="code"><div class="highlight"><pre><span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_disassociate_skb</span><span class="p">(</span>
							<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
							<span class="n">u8</span>	<span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_disassoc_frame</span> <span class="o">*</span><span class="n">disass</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_disassoc_frame</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">disass</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_disassoc_frame</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_disassoc_frame</span><span class="p">));</span>
	<span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_DISASSOC</span><span class="p">);</span>
	<span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">disass</span><span class="o">-&gt;</span><span class="n">reasoncode</span> <span class="o">=</span> <span class="n">asRsn</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span>
<span class="nf">SendDisassociation</span><span class="p">(</span>
        <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
        <span class="n">u8</span><span class="o">*</span>                     <span class="n">asSta</span><span class="p">,</span>
        <span class="n">u8</span>                      <span class="n">asRsn</span>
<span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
        <span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_disassociate_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span><span class="n">ieee</span><span class="p">,</span><span class="n">asRsn</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">){</span>
                <span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>dev<em>kfree</em>skb_any(skb);//edit by thomas</p></td><td class="code"><div class="highlight"><pre>        <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>by amy for power save</p></td><td class="code"><div class="highlight"><pre><span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span><span class="n">rate_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span>

	<span class="n">rate_len</span> <span class="o">=</span> <span class="n">ieee80211_MFIE_rate_len</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_request</span><span class="p">)</span> <span class="o">+</span>
			    <span class="mi">2</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="n">rate_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_request</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_REQ</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//FIXME: is this OK ?</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">rate_len</span><span class="p">);</span>

	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_SSID</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ieee80211_MFIE_Brate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">ieee80211_MFIE_Grate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ieee80211_get_beacon_</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ext_ieee80211_send_beacon_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>unsigned long flags;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_beacon_</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">){</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_beacons</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="c1">//edit by thomas</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>printk(KERN_WARNING "[1] beacon sending!\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">MSECS</span><span class="p">(</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">-</span><span class="mi">5</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>spin<em>lock</em>irqsave(&amp;ieee->beacon_lock,flags);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_txing</span><span class="p">)</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>spin<em>unlock</em>irqrestore(&amp;ieee->beacon_lock,flags);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_send_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>unsigned long flags;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_beacon_</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">){</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_beacons</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="c1">//edit by thomas</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>printk(KERN_WARNING "[1] beacon sending!\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">MSECS</span><span class="p">(</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">-</span><span class="mi">5</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>spin<em>lock</em>irqsave(&amp;ieee->beacon_lock,flags);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_txing</span><span class="p">)</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>spin<em>unlock</em>irqrestore(&amp;ieee->beacon_lock,flags);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_send_beacon_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">_ieee</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ieee80211_send_beacon</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_send_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_probe_req</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">){</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_probe_rq</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>dev<em>kfree</em>skb_any(skb);//edit by thomas</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_send_probe_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_PROBERQ</span><span class="p">)){</span>
		<span class="n">ieee80211_send_probe</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee80211_send_probe</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this performs syncro scan blocking the caller until all channels</span>
<span class="cm"> * in the allowed channel map has been checked.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ieee80211_softmac_scan_syncro</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>printk("==================> Sync scan\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="k">do</span><span class="p">{</span>
			<span class="n">ch</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* scan completed */</span>

		<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
		<span class="cm">/* this function can be called in two situations</span>
<span class="cm">		 * 1- We have switched to ad-hoc mode and we are</span>
<span class="cm">		 *    performing a complete syncro scan before conclude</span>
<span class="cm">		 *    there are no interesting cell and to create a</span>
<span class="cm">		 *    new one. In this case the link state is</span>
<span class="cm">		 *    IEEE80211_NOLINK until we found an interesting cell.</span>
<span class="cm">		 *    If so the ieee8021_new_net, called by the RX path</span>
<span class="cm">		 *    will set the state to IEEE80211_LINKED, so we stop</span>
<span class="cm">		 *    scanning</span>
<span class="cm">		 * 2- We are linked and the root uses run iwlist scan.</span>
<span class="cm">		 *    So we switch to IEEE80211_LINKED_SCANNING to remember</span>
<span class="cm">		 *    that we are still logically linked (not interested in</span>
<span class="cm">		 *    new network events, despite for updating the net list,</span>
<span class="cm">		 *    but we are temporarily &#39;unlinked&#39; as the driver shall</span>
<span class="cm">		 *    not filter RX frames and the channel is changing.</span>
<span class="cm">		 * So the only situation in witch are interested is to check</span>
<span class="cm">		 * if the state become LINKED because of the #1 situation</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><pre><code>printk("=====&gt;channel=%d   ",ch);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><pre><code>    printk("====send probe request\n");
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee80211_send_probe_requests</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* this prevent excessive time wait when we</span>
<span class="cm">		 * need to wait for a syncro scan to end..</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>


		<span class="n">msleep_interruptible_rtl</span><span class="p">(</span><span class="n">IEEE80211_SOFTMAC_SCAN_TIME</span><span class="p">);</span>

	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="n">DOT11D_ScanComplete</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_softmac_ips_scan_syncro</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">watch_dog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><pre><code>     if(ieee-&gt;sync_scan_hurryup)
</code></pre>

<p>{</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><pre><code>printk("stop scan sync\n");
      goto out;
 }
</code></pre>

<p>printk("=======hh===============>ips scan\n");</p></td><td class="code"><div class="highlight"><pre>     	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="cm">/* this function can be called in two situations</span>
<span class="cm">                 * 1- We have switched to ad-hoc mode and we are</span>
<span class="cm">                 *    performing a complete syncro scan before conclude</span>
<span class="cm">                 *    there are no interesting cell and to create a</span>
<span class="cm">                 *    new one. In this case the link state is</span>
<span class="cm">                 *    IEEE80211_NOLINK until we found an interesting cell.</span>
<span class="cm">                 *    If so the ieee8021_new_net, called by the RX path</span>
<span class="cm">                 *    will set the state to IEEE80211_LINKED, so we stop</span>
<span class="cm">                 *    scanning</span>
<span class="cm">                 * 2- We are linked and the root uses run iwlist scan.</span>
<span class="cm">                 *    So we switch to IEEE80211_LINKED_SCANNING to remember</span>
<span class="cm">                 *    that we are still logically linked (not interested in</span>
<span class="cm">                 *    new network events, despite for updating the net list,</span>
<span class="cm">                 *    but we are temporarily &#39;unlinked&#39; as the driver shall</span>
<span class="cm">                 *    not filter RX frames and the channel is changing.</span>
<span class="cm">                 * So the only situation in witch are interested is to check</span>
<span class="cm">                 * if the state become LINKED because of the #1 situation</span>
<span class="cm">                 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><pre><code>    printk("======&gt;channel=%d  ",ieee-&gt;current_network.channel);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><pre><code>    printk("====send probe request\n");
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee80211_send_probe_requests</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
                <span class="p">}</span>
		<span class="cm">/* this prevent excessive time wait when we</span>
<span class="cm">                 * need to wait for a syncro scan to end..</span>
<span class="cm">                 */</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><pre><code>           if (ieee-&gt;sync_scan_hurryup)
                   goto out;
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">msleep_interruptible_rtl</span><span class="p">(</span><span class="n">IEEE80211_SOFTMAC_SCAN_TIME</span><span class="p">);</span>

		<span class="k">do</span><span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">watch_dog</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>if (++watch<em>dog >= 15);//MAX</em>CHANNEL_NUMBER)  //YJ,modified,080630</p></td><td class="code"><div class="highlight"><pre>				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* scan completed */</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">MAX_CHANNEL_NUMBER</span><span class="p">;</span>
		<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">]);</span>
        <span class="p">}</span>
<span class="nl">out:</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>ieee->sync<em>scan</em>hurryup = 0;
ieee->set<em>chan(ieee->dev, ch);
ieee->current</em>network.channel = ch;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="n">DOT11D_ScanComplete</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_softmac_scan_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">softmac_scan_wq</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">short</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel_map</span><span class="p">[</span><span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">,</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>printk("ieee80211<em>softmac</em>scan<em>wq ENABLE</em>IPS\n");
printk("in %s\n",<strong>func</strong>);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>

	<span class="k">do</span><span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">watchdog</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* no good chans */</span>

 	<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>printk("current<em>network.channel:%d\n", ieee->current</em>network.channel);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;error out, scanning = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ieee80211_send_probe_requests</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">,</span> <span class="n">IEEE80211_SOFTMAC_SCAN_TIME</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">watchdog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="n">DOT11D_ScanComplete</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_beacons_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_txing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ieee80211_send_beacon</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_beacons_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_txing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_stop_send_beacons</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stop_send_beacons</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stop_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_BEACONS</span><span class="p">)</span>
		<span class="n">ieee80211_beacons_stop</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_start_send_beacons</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_send_beacons</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_BEACONS</span><span class="p">)</span>
		<span class="n">ieee80211_beacons_start</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_softmac_stop_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>unsigned long flags;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>ieee->sync<em>scan</em>hurryup = 1;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>spin<em>lock</em>irqsave(&amp;ieee->lock, flags);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>del<em>timer</em>sync(&amp;ieee->scan_timer);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>spin<em>unlock</em>irqrestore(&amp;ieee->lock, flags);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_stop_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">)</span>
		<span class="n">ieee80211_softmac_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called with ieee-&gt;lock held */</span>
<span class="kt">void</span> <span class="nf">ieee80211_rtl_start_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">RESET_CIE_WATCHDOG</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>ieee80211<em>softmac</em>scan(ieee);
queue<em>work(ieee->wq, &amp;ieee->softmac</em>scan_wq);
care this,1203,2007,by lawrence</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 1</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="k">else</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_scan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* called with wx_sem held */</span>
<span class="kt">void</span> <span class="nf">ieee80211_start_scan_syncro</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">RESET_CIE_WATCHDOG</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">)</span>
		<span class="n">ieee80211_softmac_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_authentication_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">challengelen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_authentication</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">)</span> <span class="o">+</span> <span class="n">challengelen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">));</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">IEEE80211_STYPE_AUTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">challengelen</span><span class="p">)</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">|=</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">;</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mh">0x013a</span><span class="p">;</span> <span class="c1">//FIXME</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">?</span> <span class="n">WLAN_AUTH_OPEN</span> <span class="o">:</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_STATUS_SUCCESS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="nf">ieee80211_probe_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">beacon_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="n">beacon_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encrypt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">atim_len</span><span class="p">,</span><span class="n">erp_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span><span class="o">*</span> <span class="n">crypt</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_ex_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rate_ex_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">rate_ex_len</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span>
		<span class="n">atim_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">atim_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee80211_is_54g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">))</span>
		<span class="n">erp_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">erp_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">beacon_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span><span class="p">)</span><span class="o">+</span>
		<span class="n">ssid_len</span>
		<span class="o">+</span><span class="mi">3</span> <span class="c1">//channel</span>
		<span class="o">+</span><span class="n">rate_len</span>
		<span class="o">+</span><span class="n">rate_ex_len</span>
		<span class="o">+</span><span class="n">atim_len</span>
		<span class="o">+</span><span class="n">wpa_ie_len</span>
		<span class="o">+</span><span class="n">erp_len</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">beacon_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">beacon_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">beacon_size</span><span class="p">);</span>

	<span class="n">memcpy</span> <span class="p">(</span><span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span> <span class="p">(</span><span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span> <span class="p">(</span><span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//FIXME</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">short_slot</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT</span><span class="p">))</span>
		<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT</span><span class="p">);</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_keyidx</span><span class="p">];</span>

	<span class="n">encrypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="n">wpa_ie_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
		<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">);</span>


	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">);</span>

	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">MFIE_TYPE_SSID</span><span class="p">;</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span> <span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">+=</span> <span class="n">ssid_len</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">rate_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span><span class="n">rate_len</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">tag</span><span class="o">+=</span><span class="n">rate_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_DS_SET</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">atim_len</span><span class="p">){</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_IBSS_SET</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">tag</span><span class="p">))</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">atim_window</span><span class="p">);</span>
		<span class="n">tag</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">erp_len</span><span class="p">){</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_ERP</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">rate_ex_len</span><span class="p">){</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES_EX</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">rate_ex_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">,</span><span class="n">rate_ex_len</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">tag</span><span class="o">+=</span><span class="n">rate_ex_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wpa_ie_len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="p">{</span><span class="c1">//as Windows will set pairwise key same as the group key which is not allowed in Linux, so set this for IOT issue. WB 2008.07.07</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="nf">ieee80211_assoc_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">tag</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span><span class="o">*</span> <span class="n">crypt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span> <span class="o">*</span><span class="n">assoc</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="n">ieee80211_MFIE_rate_len</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span><span class="p">)</span> <span class="o">+</span> <span class="n">rate_len</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">assoc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span><span class="p">));</span>

	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_ASSOC_RESP</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">?</span>
		<span class="n">WLAN_CAPABILITY_BSS</span> <span class="o">:</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">);</span>


	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">short_slot</span><span class="p">)</span>
		<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span><span class="p">)</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_keyidx</span><span class="p">];</span>
	<span class="k">else</span> <span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">encrypt</span> <span class="o">=</span> <span class="p">(</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
		<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">);</span>

	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">==</span> <span class="mh">0x2007</span><span class="p">)</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rate_len</span><span class="p">);</span>

	<span class="n">ieee80211_MFIE_Brate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">ieee80211_MFIE_Grate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="nf">ieee80211_auth_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span><span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_authentication</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">);</span>

	<span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_AUTH_OPEN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_AUTH</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>


<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="nf">ieee80211_null_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span><span class="kt">short</span> <span class="n">pwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span> <span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
		<span class="n">IEEE80211_STYPE_NULLFUNC</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">pwr</span> <span class="o">?</span> <span class="n">IEEE80211_FCTL_PM</span><span class="o">:</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>


<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_resp_to_assoc_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ieee80211_assoc_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">){</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="c1">//edit by thomas</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_resp_to_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ieee80211_auth_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">){</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="c1">//edit by thomas</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_resp_to_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ieee80211_probe_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="c1">//edit by thomas</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_association_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>unsigned long flags;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">ieee80211_assoc_request_frame</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>short info<em>addr = 0;
int i;
u16 suite</em>count = 0;
u8 suit_select = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wpa_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>struct net<em>device *dev = ieee->dev;
union iwreq</em>data wrqu;
u8 *buff;
u8 *p;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if 1</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>for testing purpose</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsn_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsn_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="n">ieee80211_MFIE_rate_len</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wmm_info_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span><span class="o">?</span><span class="mi">9</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">turbo_info_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span><span class="o">?</span><span class="mi">9</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">u8</span>  <span class="n">encry_proto</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_type_notify</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>u8  pairwise<em>type = (ieee->wpax</em>type<em>notify >> 8) &amp; 0xff;
u8  authen</em>type = (ieee->wpax<em>type</em>notify >> 16) &amp; 0xff;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>[0] Notify type of encryption: WPA/WPA2
[1] pair wise type
[2] authen type</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_type_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IEEE_PROTO_WPA</span> <span class="o">==</span> <span class="n">encry_proto</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rsn_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IEEE_PROTO_RSN</span> <span class="o">==</span> <span class="n">encry_proto</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wpa_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_request_frame</span><span class="p">)</span><span class="o">+</span>
		<span class="o">+</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="c1">//essid tagged val</span>
		<span class="o">+</span> <span class="n">rate_len</span><span class="c1">//rates tagged val</span>
		<span class="o">+</span> <span class="n">wpa_len</span>
		<span class="o">+</span> <span class="n">rsn_len</span>
		<span class="o">+</span> <span class="n">wmm_info_len</span>
		<span class="o">+</span> <span class="n">turbo_info_len</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_request_frame</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_request_frame</span><span class="p">));</span>


	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">IEEE80211_STYPE_ASSOC_REQ</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span><span class="o">=</span> <span class="mi">37</span><span class="p">;</span> <span class="c1">//FIXME</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span><span class="c1">//for HW security, John</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_BSS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span> <span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">short_slot</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT</span><span class="p">);</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span> <span class="c1">//FIXME</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">MFIE_TYPE_SSID</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rate_len</span><span class="p">);</span>

	<span class="n">ieee80211_MFIE_Brate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">ieee80211_MFIE_Grate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>add rsn==0 condition for ap's mix security mode(wpa+wpa2), john2007.8.9
choose AES encryption as default algorithm while using mixed mode</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">wmm_info_len</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">wmm_info_len</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">ieee80211_WMM_Info</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">turbo_info_len</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">turbo_info_len</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ieee80211_TURBO_Info</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
        <span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_associate_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* don&#39;t scan, and avoid to have the RX path possibly</span>
<span class="cm">	 * try again to associate. Even do not react to AUTH or</span>
<span class="cm">	 * ASSOC response. Just wait for the retry wq to be scheduled.</span>
<span class="cm">	 * Here we will check if there are good nets to associate</span>
<span class="cm">	 * with, so we retry or just get back to NO_LINK and scanning</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_ASSOCIATING_AUTHENTICATING</span><span class="p">){</span>
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Authentication failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">no_auth_rs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Association failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">no_ass_rs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_ASSOCIATING_RETRY</span><span class="p">;</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">,</span><span class="n">IEEE80211_SOFTMAC_ASSOC_RETRY_TIME</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_associate_abort_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_associate_abort</span><span class="p">((</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_associate_step1</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Stopping scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_auth_rq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">=</span><span class="n">ieee80211_authentication_req</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">){</span>

		<span class="n">ieee80211_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span><span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_ASSOCIATING_AUTHENTICATING</span> <span class="p">;</span>
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Sending authentication request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>printk("---Sending authentication request\n");</p></td><td class="code"><div class="highlight"><pre>		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>BUGON when you try to add<em>timer twice, using mod</em>timer may be better, john0709</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">)){</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>If call dev<em>kfree</em>skb<em>any,a warning will ocur....
KERNEL: assertion (!atomic</em>read(&amp;skb->users)) failed at net/core/dev.c (1708)
So ... 1204 by lawrence.
printk("\nIn %s,line %d call kfree skb.",<strong>func</strong>,<strong>LINE</strong>);
dev<em>kfree</em>skb_any(skb);//edit by thomas</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_rtl_auth_challenge</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">challenge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>int hlen = sizeof(struct ieee80211_authentication);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_auth_rq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_authentication_req</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">chlen</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">ieee80211_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span><span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">chlen</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_CHALLENGE</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">chlen</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span> <span class="n">chlen</span><span class="p">);</span>

		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Sending authentication challenge response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ieee80211_encrypt_fragment</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="p">));</span>

		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">)){</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>printk("=========>add timer again, to crash\n");</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="c1">//edit by thomas</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">challenge</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_associate_step2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>

	<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Sending association request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_ass_rq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">=</span><span class="n">ieee80211_association_req</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">ieee80211_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span><span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">)){</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>dev<em>kfree</em>skb_any(skb);//edit by thomas</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_associate_complete_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">associate_complete_wq</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Associated successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee80211_is_54g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">)){</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using G rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using B rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_associate_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>ieee->seq_ctrl[i] = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_LINKED</span><span class="p">;</span>
	<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Successfully associated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_complete_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_associate_procedure_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">associate_procedure_wq</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ieee80211_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ieee80211_associate_step1</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_softmac_new_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp_ssid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tmp_ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">short</span> <span class="n">apset</span><span class="p">,</span><span class="n">ssidset</span><span class="p">,</span><span class="n">ssidbroad</span><span class="p">,</span><span class="n">apmatch</span><span class="p">,</span><span class="n">ssidmatch</span><span class="p">;</span>

	<span class="cm">/* we are interested in new new only if we are not associated</span>
<span class="cm">	 * and we are not associating / authenticating</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">){</span>
		<span class="cm">/* if the user specified the AP MAC, we need also the essid</span>
<span class="cm">		 * This could be obtained by beacons or, if the network does not</span>
<span class="cm">		 * broadcast it, it can be put manually.</span>
<span class="cm">		 */</span>
		<span class="n">apset</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wap_set</span><span class="p">;</span><span class="c1">//(memcmp(ieee-&gt;current_network.bssid, zero,ETH_ALEN)!=0 );</span>
		<span class="n">ssidset</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span><span class="p">;</span><span class="c1">//ieee-&gt;current_network.ssid[0] != &#39;\0&#39;;</span>
		<span class="n">ssidbroad</span> <span class="o">=</span>  <span class="o">!</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
		<span class="n">apmatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">!=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span>
			<span class="n">ssidmatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ssidmatch</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>printk("cur: %s, %d, net:%s, %d\n", ieee->current<em>network.ssid, ieee->current</em>network.ssid<em>len, net->ssid, net->ssid</em>len);
printk("apset=%d apmatch=%d ssidset=%d ssidbroad=%d ssidmatch=%d\n",apset,apmatch,ssidset,ssidbroad,ssidmatch);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span>	<span class="cm">/* if the user set the AP check if match.</span>
<span class="cm">			 * if the network does not broadcast essid we check the user supplied ANY essid</span>
<span class="cm">			 * if the network does broadcast and the user does not set essid it is OK</span>
<span class="cm">			 * if the network does broadcast and the user did set essid chech if essid match</span>
<span class="cm">			 */</span>
				<span class="p">(</span> <span class="n">apset</span> <span class="o">&amp;&amp;</span> <span class="n">apmatch</span> <span class="o">&amp;&amp;</span>
				  <span class="p">((</span><span class="n">ssidset</span> <span class="o">&amp;&amp;</span> <span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="n">ssidmatch</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ssidset</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="n">ssidset</span><span class="p">))</span> <span class="p">)</span> <span class="o">||</span>
				<span class="cm">/* if the ap is not set, check that the user set the bssid</span>
<span class="cm">				 * and the network does broadcast and that those two bssid matches</span>
<span class="cm">				 */</span>
				<span class="p">(</span><span class="o">!</span><span class="n">apset</span> <span class="o">&amp;&amp;</span> <span class="n">ssidset</span> <span class="o">&amp;&amp;</span> <span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="n">ssidmatch</span><span class="p">)</span>
		   <span class="p">){</span>


			<span class="cm">/* if the essid is hidden replace it with the</span>
<span class="cm">			 * essid provided by the user.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssidbroad</span><span class="p">){</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">tmp_ssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
				<span class="n">tmp_ssid_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssidbroad</span><span class="p">){</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">tmp_ssid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">tmp_ssid_len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Linking with %s: channel is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">){</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_ASSOCIATING</span><span class="p">;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">);</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ieee80211_is_54g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">)){</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using G rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span><span class="k">else</span><span class="p">{</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using B rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_LINKED</span><span class="p">;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_softmac_check_all_nets</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* if the state become different that NOLINK means</span>
<span class="cm">		 * we had found what we are searching for</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">time_after</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
			<span class="n">ieee80211_softmac_new_net</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">auth_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span><span class="o">**</span> <span class="n">challenge</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_authentication</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span><span class="p">))){</span>
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth resp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xcafe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">challenge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">)</span> <span class="o">+</span><span class="mi">3</span><span class="p">)){</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFIE_TYPE_CHALLENGE</span><span class="p">){</span>
			<span class="o">*</span><span class="n">chlen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">++</span><span class="p">);</span>
			<span class="o">*</span><span class="n">challenge</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">chlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">challenge</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

<span class="p">}</span>


<span class="kt">int</span> <span class="nf">auth_rq_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="n">u8</span><span class="o">*</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_authentication</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span><span class="p">))){</span>
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth request: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_authentication</span><span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">)</span>
		<span class="k">return</span>  <span class="n">WLAN_STATUS_NOT_SUPPORTED_AUTH_ALG</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">probe_rq_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">skbend</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ssidlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>   <span class="o">*</span><span class="n">header</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>   <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* corrupted */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">skbend</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tag</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">skbend</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">ssid</span> <span class="o">=</span> <span class="n">tag</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">ssidlen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tag</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* point to the len field */</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span> <span class="cm">/* point to the last data byte of the tag */</span>
		<span class="n">tag</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* point to the next tag */</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>IEEE80211DMESG("Card MAC address is "MACSTR, MAC2STR(src));</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ssidlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssid</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ssid not found in tagged param */</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssidlen</span><span class="p">));</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">assoc_rq_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="n">u8</span><span class="o">*</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_assoc_request_frame</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_request_frame</span><span class="p">)</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth request:%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_request_frame</span><span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">assoc_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">aid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span><span class="p">)){</span>
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth resp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xcafe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span><span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ieee80211_rx_probe_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>IEEE80211DMESG("Rx probe");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_probe_rq</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>DMESG("Dest is "MACSTR, MAC2STR(dest));</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">probe_rq_parse</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dest</span><span class="p">)){</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>IEEE80211DMESG("Was for me!");</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_probe_rs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ieee80211_resp_to_probe</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ieee80211_rx_auth_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>IEEE80211DMESG("Rx probe");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_auth_rq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">auth_rq_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_resp_to_auth</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>DMESG("Dest is "MACSTR, MAC2STR(dest));</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

 <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ieee80211_rx_assoc_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>unsigned long flags;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_ass_rq</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assoc_rq_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dest</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
		<span class="n">ieee80211_resp_to_assoc_rq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;New client associated: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">ieee80211_sta_ps_send_null_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">pwr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ieee80211_null_func</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pwr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">softmac_ps_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>

<span class="p">}</span>


<span class="kt">short</span> <span class="nf">ieee80211_sta_ps_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">time_h</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">time_l</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">dtim</span><span class="p">;</span>
	<span class="cm">/*if(ieee-&gt;ps == IEEE80211_PS_DISABLED ||</span>
<span class="cm">		ieee-&gt;iw_mode != IW_MODE_INFRA ||</span>
<span class="cm">		ieee-&gt;state != IEEE80211_LINKED)</span>

<span class="cm">		return 0;</span>
<span class="cm">	*/</span>
	<span class="n">dtim</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">dtim_data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>printk("DTIM\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dtim</span> <span class="o">&amp;</span> <span class="n">IEEE80211_DTIM_VALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>printk("VALID\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">dtim_data</span> <span class="o">=</span> <span class="n">IEEE80211_DTIM_INVALID</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dtim</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">IEEE80211_DTIM_UCAST</span> <span class="o">|</span> <span class="n">IEEE80211_DTIM_MBCAST</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">timeout</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rx_ps_time</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">timeout</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">!=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">time_l</span><span class="p">){</span>
		<span class="o">*</span><span class="n">time_l</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="o">+</span> <span class="n">MSECS</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><ul>
<li>ieee->current<em>network.dtim</em>period));
printk("beacon<em>interval:%x, dtim</em>period:%x, totol to Msecs:%x, HZ:%x\n", ieee->current<em>network.beacon</em>interval, ieee->current<em>network.dtim</em>period, MSECS(((ieee->current<em>network.beacon</em>interval * ieee->current<em>network.dtim</em>period))), HZ);</li>
</ul></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">time_h</span><span class="p">){</span>
		<span class="o">*</span><span class="n">time_h</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">time_l</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">time_l</span> <span class="o">&lt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="o">*</span><span class="n">time_h</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>


<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_sta_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">th</span><span class="p">,</span><span class="n">tl</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">sleep</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span><span class="n">flags2</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">==</span> <span class="n">IEEE80211_PS_DISABLED</span> <span class="o">||</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">)){</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><h1>warning CHECK<em>LOCK</em>HERE</h1></td><td class="code"><div class="highlight"><pre>		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

		<span class="n">ieee80211_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sleep</span> <span class="o">=</span> <span class="n">ieee80211_sta_ps_sleep</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tl</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>printk("===>%s,%d[2 wake, 1 sleep, 0 do nothing], ieee->sta<em>sleep = %d\n",<strong>func</strong>, sleep,ieee->sta</em>sleep);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* 2 wake, 1 sleep, 0 do nothing */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sleep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">sleep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">enter_sleep_state</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">th</span><span class="p">,</span><span class="n">tl</span><span class="p">);</span>

		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><pre><code>printk("send null 1\n");
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_is_queue_empty</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>


				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_request_tx_ack</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

				<span class="n">ieee80211_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_th</span> <span class="o">=</span> <span class="n">th</span><span class="p">;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_tl</span> <span class="o">=</span> <span class="n">tl</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

		<span class="p">}</span>


	<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">sleep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><h1>warning CHECK<em>LOCK</em>HERE</h1></td><td class="code"><div class="highlight"><pre>		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>printk("send wakeup packet\n");</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ieee80211_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_sta_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">nl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">nl</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>printk("Warning: driver is probably failing to report TX ps error\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_request_tx_ack</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">ieee80211_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_wake_up</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">nl</span><span class="p">){</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_request_tx_ack</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ieee80211_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_ps_tx_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">success</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span><span class="n">flags2</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
		<span class="cm">/* Null frame with PS bit set */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">success</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>printk("==================> %s::enter sleep state\n",<strong>func</strong>);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">enter_sleep_state</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_th</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_tl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* if the card report not success we can&#39;t be sure the AP</span>
<span class="cm">		 * has not RXed so we can&#39;t assume the AP believe us awake</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
	<span class="cm">/* 21112005 - tx again null without PS bit if lost */</span>
	<span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">success</span><span class="p">){</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
			<span class="n">ieee80211_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_frame_softmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">stype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">errcode</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">challenge</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chlen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aid</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span> <span class="o">*</span><span class="n">assoc_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="n">info_element</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">!=</span> <span class="n">IEEE80211_PS_DISABLED</span> <span class="o">&amp;&amp;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">))</span>

		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">&amp;&amp;</span>
		<span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rx_ps_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">IEEE80211_STYPE_ASSOC_RESP</span>:
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_REASSOC_RESP</span>:

			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;received [RE]ASSOCIATION RESPONSE (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_ASSOCIATING_AUTHENTICATED</span> <span class="o">&amp;&amp;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">){</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">errcode</span><span class="o">=</span><span class="n">assoc_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aid</span><span class="p">))){</span>
					<span class="n">u16</span> <span class="n">left</span><span class="p">;</span>

					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">=</span><span class="n">IEEE80211_LINKED</span><span class="p">;</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="n">aid</span><span class="p">;</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_ass_ok</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>printk(KERN<em>WARNING "nic</em>type = %s", (rx<em>stats->nic</em>type == 1)?"rtl8187":"rtl8187B");</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">nic_type</span><span class="p">)</span> <span class="c1">//card type is 8187</span>
					<span class="p">{</span>
						<span class="k">goto</span> <span class="n">associate_complete</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">assoc_resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span><span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
					<span class="n">info_element</span> <span class="o">=</span> 	<span class="o">&amp;</span><span class="n">assoc_resp</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">;</span>
					<span class="n">left</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">info_element</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">assoc_resp</span><span class="p">);</span>

					<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element_hdr</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;[re]associate response error!&quot;</span><span class="p">);</span>
							<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
						  <span class="k">case</span> <span class="n">MFIE_TYPE_GENERIC</span>:
						         <span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_GENERIC: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span>  <span class="o">&amp;&amp;</span>
							    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
							    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
							    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span>
							    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">&amp;&amp;</span>
							    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Not care about version at present.
WMM Parameter Element</p></td><td class="code"><div class="highlight"><pre>							    <span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">wmm_param</span><span class="p">,(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span>\
										    <span class="o">+</span> <span class="mi">8</span><span class="p">),(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">));</span>

					 	            <span class="k">if</span> <span class="p">(((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">wmm_info</span><span class="o">^</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">&amp;</span> \
										    <span class="mh">0x0f</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">init_wmmparam_flag</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>refresh parameter element for current network
update the register parameter for hardware</p></td><td class="code"><div class="highlight"><pre>							      <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">init_wmmparam_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							      <span class="n">queue_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wmm_param_update_wq</span><span class="p">);</span>

						            <span class="p">}</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>update info_element for current network</p></td><td class="code"><div class="highlight"><pre>						            <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">wmm_info</span>  <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
							<span class="p">}</span>
							<span class="k">break</span><span class="p">;</span>
						  <span class="nl">default:</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>nothing to do at present!!!</p></td><td class="code"><div class="highlight"><pre>							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="n">left</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element_hdr</span><span class="p">)</span> <span class="o">+</span>
							<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
						<span class="n">info_element</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="p">)</span>
							<span class="o">&amp;</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">];</span>
					<span class="p">}</span>
					<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">init_wmmparam_flag</span><span class="p">)</span> <span class="c1">//legacy AP, reset the AC_xx_param register</span>
					<span class="p">{</span>
						<span class="n">queue_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wmm_param_update_wq</span><span class="p">);</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">init_wmmparam_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//indicate AC_xx_param upated since last associate</span>
					<span class="p">}</span>
<span class="nl">associate_complete:</span>
					<span class="n">ieee80211_associate_complete</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
				<span class="p">}</span><span class="k">else</span><span class="p">{</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_ass_err</span><span class="o">++</span><span class="p">;</span>
					<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span>
						<span class="s">&quot;Association response status code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">errcode</span><span class="p">);</span>
					<span class="n">ieee80211_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IEEE80211_STYPE_ASSOC_REQ</span>:
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_REASSOC_REQ</span>:

			<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>

				<span class="n">ieee80211_rx_assoc_rq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IEEE80211_STYPE_AUTH</span>:

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">){</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_ASSOCIATING_AUTHENTICATING</span> <span class="o">&amp;&amp;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">){</span>

						<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Received authentication response&quot;</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">errcode</span><span class="o">=</span><span class="n">auth_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">challenge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chlen</span><span class="p">))){</span>
							<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">||</span> <span class="o">!</span><span class="n">challenge</span><span class="p">){</span>
								<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_ASSOCIATING_AUTHENTICATED</span><span class="p">;</span>
								<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_auth_rs_ok</span><span class="o">++</span><span class="p">;</span>

								<span class="n">ieee80211_associate_step2</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
							<span class="p">}</span><span class="k">else</span><span class="p">{</span>
								<span class="n">ieee80211_rtl_auth_challenge</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span> <span class="n">chlen</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span><span class="k">else</span><span class="p">{</span>
							<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_auth_rs_err</span><span class="o">++</span><span class="p">;</span>
							<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Authentication response status code 0x%x&quot;</span><span class="p">,</span><span class="n">errcode</span><span class="p">);</span>
							<span class="n">ieee80211_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
						<span class="p">}</span>

					<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">){</span>
						<span class="n">ieee80211_rx_auth_rq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IEEE80211_STYPE_PROBE_REQ</span>:

			<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_PROBERS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">||</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">))</span>

				<span class="n">ieee80211_rx_probe_rq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IEEE80211_STYPE_DISASSOC</span>:
		<span class="k">case</span> <span class="n">IEEE80211_STYPE_DEAUTH</span>:
			<span class="cm">/* FIXME for now repeat all the association procedure</span>
<span class="cm">			* both for disassociation and deauthentication</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">))){</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_ASSOCIATING</span><span class="p">;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">reassoc</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>notify<em>wx</em>assoc_event(ieee);  //YJ,del,080828, do not notify os here</p></td><td class="code"><div class="highlight"><pre>				<span class="n">queue_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>dev<em>kfree</em>skb_any(skb);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* following are for a simpler TX queue management.</span>
<span class="cm"> * Instead of using netif_[stop/wake]_queue the driver</span>
<span class="cm"> * will uses these two function (plus a reset one), that</span>
<span class="cm"> * will internally uses the kernel netif_* and takes</span>
<span class="cm"> * care of the ieee802.11 fragmentation.</span>
<span class="cm"> * So the driver receives a fragment per time and might</span>
<span class="cm"> * call the stop function when it want without take care</span>
<span class="cm"> * to have enough room to TX an entire packet.</span>
<span class="cm"> * This might be useful if each fragment need it&#39;s own</span>
<span class="cm"> * descriptor, thus just keep a total free memory &gt; than</span>
<span class="cm"> * the max fragmentation threshold is not enough.. If the</span>
<span class="cm"> * ieee802.11 stack passed a TXB struct then you needed</span>
<span class="cm"> * to keep N free descriptors where</span>
<span class="cm"> * N = MAX_PACKET_SIZE / MIN_FRAG_TRESHOLD</span>
<span class="cm"> * In this way you need just one and the 802.11 stack</span>
<span class="cm"> * will take care of buffering fragments and pass them to</span>
<span class="cm"> * to the driver later, when it wakes the queue.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ieee80211_softmac_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>


	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* called with 2nd parm 0, no tx mgmt lock required */</span>
	<span class="n">ieee80211_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">){</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="n">txb</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span>
				<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>(i+1)<txb->nr_frags);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ieee80211_txb_free</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>

	<span class="nl">exit:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* called with ieee-&gt;lock acquired */</span>
<span class="kt">void</span> <span class="nf">ieee80211_resume_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">frag</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">){</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>(i+1)<ieee->tx<em>pending.txb->nr</em>frags);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">ieee80211_txb_free</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_reset_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">init_mgmt_queue</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">){</span>
		<span class="n">ieee80211_txb_free</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_rtl_wake_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="o">*</span><span class="n">header</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span><span class="p">){</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dequeue_mgmt</span><span class="p">(</span><span class="n">ieee</span><span class="p">))){</span>

			<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>printk(KERN<em>ALERT "ieee80211</em>wake_queue \n");</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span><span class="c1">//edit by thomas</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">)</span>
		<span class="n">ieee80211_resume_tx</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">&amp;&amp;</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">swtxawake</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="n">exit</span> <span class="o">:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_rtl_stop_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>unsigned long flags;
spin<em>lock</em>irqsave(&amp;ieee->lock,flags);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)){</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">swtxstop</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>spin<em>unlock</em>irqrestore(&amp;ieee->lock,flags);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_randomize_cell</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* an IBSS cell address must have the two less significant</span>
<span class="cm">	 * bits of the first byte = 2</span>
<span class="cm">	 */</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called in user context only */</span>
<span class="kt">void</span> <span class="nf">ieee80211_start_master_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
			<span class="n">IEEE80211_DEFAULT_TX_ESSID</span><span class="p">,</span>
			<span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">IEEE80211_DEFAULT_TX_ESSID</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_LINKED</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_start_monitor_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">raw_tx</span><span class="p">){</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_start_ibss_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">start_ibss_wq</span><span class="p">);</span>

	<span class="cm">/* iwconfig mode ad-hoc will schedule this and return</span>
<span class="cm">	 * on the other hand this will block further iwconfig SET</span>
<span class="cm">	 * operations because of the wx_sem hold.</span>
<span class="cm">	 * Anyway some most set operations set a flag to speed-up</span>
<span class="cm">	 * (abort) this wq (when syncro scanning) before sleeping</span>
<span class="cm">	 * on the semaphore</span>
<span class="cm">	 */</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span><span class="n">IEEE80211_DEFAULT_TX_ESSID</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">IEEE80211_DEFAULT_TX_ESSID</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if we have this cell in our network list */</span>
	<span class="n">ieee80211_softmac_check_all_nets</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="cm">/* if not then the state is not linked. Maybe the user switched to</span>
<span class="cm">	 * ad-hoc mode just after being in monitor mode, or just after</span>
<span class="cm">	 * being very few time in managed mode (so the card have had no</span>
<span class="cm">	 * time to scan all the chans..) or we have just run up the iface</span>
<span class="cm">	 * after setting ad-hoc mode. So we have to give another try..</span>
<span class="cm">	 * Here, in ibss mode, should be safe to do this without extra care</span>
<span class="cm">	 * (in bss mode we had to make sure no-one tried to associate when</span>
<span class="cm">	 * we had just checked the ieee-&gt;state and we was going to start the</span>
<span class="cm">	 * scan) because in ibss mode the ieee80211_new_net function, when</span>
<span class="cm">	 * finds a good net, just set the ieee-&gt;state to IEEE80211_LINKED,</span>
<span class="cm">	 * so, at worst, we waste a bit of time to initiate an unneeded syncro</span>
<span class="cm">	 * scan, that will stop at the first round because it sees the state</span>
<span class="cm">	 * associated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">)</span>
		<span class="n">ieee80211_start_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="cm">/* the network definitively is not here.. create a new cell */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;creating new IBSS cell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wap_set</span><span class="p">)</span>
			<span class="n">ieee80211_randomize_cell</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CCK_MODULATION</span><span class="p">){</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_1MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_2MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_5MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_CCK_RATE_11MB</span><span class="p">;</span>

		<span class="p">}</span><span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">){</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_6MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_9MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_12MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_18MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_24MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_36MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_48MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE80211_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_RATE_54MB</span><span class="p">;</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>By default, WMM function will be disabled in IBSS mode</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">QoS_Enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">short_slot</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_LINKED</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">ieee80211_start_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;after sending beacon packet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_start_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_ibss_wq</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this is called only in user context, with wx_sem held */</span>
<span class="kt">void</span> <span class="nf">ieee80211_start_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Ref: 802.11d 11.1.3.3
STA shall not start a BSS unless properly formed Beacon frame including a Country IE.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* check if we have already found the net we</span>
<span class="cm">	 * are interested in (if any).</span>
<span class="cm">	 * if not (we are disassociated and we are not</span>
<span class="cm">	 * in associating / authenticating phase) start the background scanning.</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_softmac_check_all_nets</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="cm">/* ensure no-one start an associating process (thus setting</span>
<span class="cm">	 * the ieee-&gt;state to ieee80211_ASSOCIATING) while we</span>
<span class="cm">	 * have just cheked it and we are going to enable scan.</span>
<span class="cm">	 * The ieee80211_new_net function is always called with</span>
<span class="cm">	 * lock held (from both ieee80211_softmac_check_all_nets and</span>
<span class="cm">	 * the rx path), so we cannot be in the middle of such function</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><h1>ifdef ENABLE_IPS</h1>

<p>printk("start bss ENABLE_IPS\n");</p>

<h1>else</h1></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">){</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ieee80211_rtl_start_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><h1>endif</h1></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called only in userspace context */</span>
<span class="kt">void</span> <span class="nf">ieee80211_disassociate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">)</span>
			<span class="n">ieee80211_reset_queue</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="n">Dot11d_Reset</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">;</span>

<span class="p">}</span>
<span class="kt">void</span> <span class="nf">ieee80211_associate_retry_wq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">associate_retry_wq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_ASSOCIATING_RETRY</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="cm">/* until we do not set the state to IEEE80211_NOLINK</span>
<span class="cm">	* there are no possibility to have someone else trying</span>
<span class="cm">	* to start an association procedure (we get here with</span>
<span class="cm">	* ieee-&gt;state = IEEE80211_ASSOCIATING).</span>
<span class="cm">	* When we set the state to IEEE80211_NOLINK it is possible</span>
<span class="cm">	* that the RX path run an attempt to associate, but</span>
<span class="cm">	* both ieee80211_softmac_check_all_nets and the</span>
<span class="cm">	* RX path works with ieee-&gt;lock held so there are no</span>
<span class="cm">	* problems. If we are still disassociated then start a scan.</span>
<span class="cm">	* the lock here is necessary to ensure no one try to start</span>
<span class="cm">	* an association procedure when we have just checked the</span>
<span class="cm">	* state and we are going to start the scan.</span>
<span class="cm">	*/</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ieee80211_softmac_check_all_nets</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">){</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ieee80211_rtl_start_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>YJ,add,080828, notify os here</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>YJ,add,080828,end</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_get_beacon_</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">broadcast_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_probe_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">broadcast_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_BEACON</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ieee80211_get_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_beacon_</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_softmac_stop_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ieee80211_stop_protocol</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_stop_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ieee80211_stop_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SendDisassociation</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">WLAN_REASON_DISASSOC_STA_HAS_LEFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_ibss_wq</span><span class="p">);</span>
	<span class="n">ieee80211_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">ieee80211_disassociate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_softmac_start_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ieee80211_start_protocol</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_start_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="k">do</span><span class="p">{</span>
			<span class="n">ch</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span> <span class="cm">/* no channel found */</span>

		<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

       	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxseq_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxfrag_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_packet_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">init_wmmparam_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//reinitialize AC_xx_PARAM registers.</span>


	<span class="cm">/* if the user set the MAC of the ad-hoc cell and then</span>
<span class="cm">	 * switch to managed mode, shall we  make sure that association</span>
<span class="cm">	 * attempts does not fail just because the user provide the essid</span>
<span class="cm">	 * and the nic is still checking for the AP MAC ??</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_MODE_AUTO</span>:
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>not set break here intentionly</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
			<span class="n">ieee80211_start_bss</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
			<span class="n">ieee80211_start_ibss</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IW_MODE_MASTER</span>:
			<span class="n">ieee80211_start_master_bss</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
			<span class="n">ieee80211_start_monitor_mode</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
			<span class="n">ieee80211_start_bss</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cp">#define DRV_NAME  &quot;Ieee80211&quot;</span>
<span class="kt">void</span> <span class="nf">ieee80211_softmac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">));</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_NOLINK</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//so IEEE2100-like driver are happy</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wap_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span> <span class="n">IEEE80211_DEFAULT_BASIC_RATE</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><h1>ifdef ENABLE_LPS</h1></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="n">IEEE80211_PS_MBCAST</span><span class="o">|</span><span class="n">IEEE80211_PS_UNICAST</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><h1>else</h1>

<p>ieee->ps = IEEE80211<em>PS</em>DISABLED;</p>

<h1>endif</h1></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>by amy</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bInactivePs</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ListenInterval</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxDataInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//YJ,add,080828</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxBcnInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//YJ,add,080828</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxOkTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//+by amy 080312</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">NumRxUnicast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//YJ,add,080828,for keep alive</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>by amy</p></td><td class="code"><div class="highlight"><pre>	<span class="n">init_mgmt_queue</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ieee</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ieee80211_associate_abort_cb</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ieee</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ieee80211_send_beacon_cb</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">create_workqueue</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_ibss_wq</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">ieee80211_start_ibss_wq</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_complete_wq</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">ieee80211_associate_complete_wq</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">ieee80211_associate_procedure_wq</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">ieee80211_softmac_scan_wq</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">ieee80211_associate_retry_wq</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sync_scan_wq</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">ieee80211_wx_sync_scan_wq</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>INIT<em>WORK(&amp;ieee->watch</em>dog<em>wq,(void*) ieee80211</em>watch<em>dog</em>wq);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_task</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">ieee80211_sta_ps</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pDot11dInfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">RT_DOT11D_INFO</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_softmac_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>add for RF power on power of by lizhaoming 080512</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">GPIOChangeRFWorkItem</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pDot11dInfo</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************</span>
<span class="cm"> * Start of WPA code.                                   *</span>
<span class="cm"> * this is stolen from the ipw2200 driver               *</span>
<span class="cm"> ********************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_wpa_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is called when wpa_supplicant loads and closes the driver</span>
<span class="cm">	 * interface. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s WPA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">value</span> <span class="o">?</span> <span class="s">&quot;enabling&quot;</span> <span class="o">:</span> <span class="s">&quot;disabling&quot;</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ieee80211_wpa_assoc_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wpa_ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* make sure WPA is enabled */</span>
	<span class="n">ieee80211_wpa_enable</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ieee80211_disassociate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_wpa_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_MLME_STA_DEAUTH</span>:</pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>silently ignore</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_MLME_STA_DISASSOC</span>:
		<span class="n">ieee80211_disassociate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown MLME request: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_wpa_set_wpa_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_wpa_assoc_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AUTH_ALG_OPEN_SYSTEM			0x1</span>
<span class="cp">#define AUTH_ALG_SHARED_KEY			0x2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_wpa_set_auth_algs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ieee80211_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_AUTH_MODE</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_wpa_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_WPA_ENABLED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_enable</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_TKIP_COUNTERMEASURES</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span><span class="o">=</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_DROP_UNENCRYPTED</span>: <span class="p">{</span>
		<span class="cm">/* HACK:</span>
<span class="cm">		 *</span>
<span class="cm">		 * wpa_supplicant calls set_wpa_enabled when the driver</span>
<span class="cm">		 * is loaded and unloaded, regardless of if WPA is being</span>
<span class="cm">		 * used.  No other calls are made which can be used to</span>
<span class="cm">		 * determine if encryption will be used or not prior to</span>
<span class="cm">		 * association being expected.  If encryption is not being</span>
<span class="cm">		 * used, drop_unencrypted is set to false, else true -- we</span>
<span class="cm">		 * can use this to determine if the CAP_PRIVACY_ON bit should</span>
<span class="cm">		 * be set.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">ieee80211_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_ENABLED</span><span class="p">,</span>
			<span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span>
		<span class="p">};</span>
 		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="cm">/* We only change SEC_LEVEL for open mode. Others</span>
<span class="cm">		 * are set by ipw_wpa_set_encryption.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_PRIVACY_INVOKED</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span><span class="o">=</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_AUTH_ALGS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_set_auth_algs</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_IEEE_802_1X</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span><span class="o">=</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_WPAX_SELECT</span>:</pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>added for WPA2 mixed mode
printk(KERN_WARNING "------------------------>wpax value = %x\n", value);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_suitlist_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_type_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_type_notify</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_suitlist_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown WPA param: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* implementation borrowed from hostap driver */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_wpa_set_encryption</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_crypto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">[</span><span class="n">IEEE_CRYPT_ALG_NAME_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param_len</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Len mismatch %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param_len</span><span class="p">,</span>
			       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>FIXME FIXME
sec.encrypt = 0;</p></td><td class="code"><div class="highlight"><pre>			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ENABLED</span> <span class="o">|</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">ieee80211_crypt_delayed_deinit</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>FIXME FIXME
sec.encrypt = 1;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ENABLED</span><span class="p">;</span>

	<span class="cm">/* IPW HW cannot build TKIP MIC, host decryption still needed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_host_crypt</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">ieee80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">ieee80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">ieee80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">ieee80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unknown crypto alg &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_UNKNOWN_ALG</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">*</span><span class="n">new_crypt</span><span class="p">;</span>

		<span class="n">ieee80211_crypt_delayed_deinit</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>

		<span class="n">new_crypt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_crypt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">new_crypt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_crypt_data</span><span class="p">));</span>
		<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
			<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span>
				<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_crypt</span><span class="p">);</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_CRYPT_INIT_FAILED</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
				   <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span>
				   <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;key setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_KEY_SET_FAILED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">skip_host_crypt:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_keyidx</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">active_key</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">],</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>

	<span class="cm">/* Do not reset port if card is in Managed mode since resetting will</span>
<span class="cm">	 * generate new IEEE 802.11 authentication which may end up in looping</span>
<span class="cm">	 * with IEEE 802.1X.  If your hardware requires a reset after WEP</span>
<span class="cm">	 * configuration (for example... Prism2), implement the reset_port in</span>
<span class="cm">	 * the callbacks structures used to initialize the 802.11 stack. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">reset_on_keychange</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">reset_port</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;reset_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_CARD_CONF_FAILED</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_wpa_supplicant_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>IEEE<em>DEBUG</em>INFO("wpa_supplicant: len=%d\n", p->length);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">){</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">IEEE_CMD_SET_WPA_PARAM</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_set_param</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_param</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
					<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_param</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_CMD_SET_WPA_IE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_set_wpa_ie</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_CMD_SET_ENCRYPTION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_set_encryption</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_CMD_MLME</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_mlme</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
				   <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown WPA supplicant request: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">notify_wx_assoc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
