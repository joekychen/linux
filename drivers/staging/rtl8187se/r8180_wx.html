<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › r8180_wx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>r8180_wx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	This file contains wireless extension handlers.</span>

<span class="cm">	This is part of rtl8180 OpenSource driver.</span>
<span class="cm">	Copyright (C) Andrea Merello 2004-2005  &lt;andreamrl@tiscali.it&gt;</span>
<span class="cm">	Released under the terms of GPL (General Public Licence)</span>

<span class="cm">	Parts of this driver are based on the GPL part</span>
<span class="cm">	of the official realtek driver.</span>

<span class="cm">	Parts of this driver are based on the rtl8180 driver skeleton</span>
<span class="cm">	from Patric Schenke &amp; Andres Salomon.</span>

<span class="cm">	Parts of this driver are based on the Intel Pro Wireless 2100 GPL driver.</span>

<span class="cm">	We want to thanks the Authors of those projects and the Ndiswrapper</span>
<span class="cm">	project Authors.</span>
<span class="cm">*/</span>


<span class="cp">#include &quot;r8180.h&quot;</span>
<span class="cp">#include &quot;r8180_hw.h&quot;</span>

<span class="cp">#include &quot;ieee80211/dot11d.h&quot;</span>

<span class="n">u32</span> <span class="n">rtl8180_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">,</span> <span class="mi">5500000</span><span class="p">,</span> <span class="mi">11000000</span><span class="p">,</span>
	<span class="mi">6000000</span><span class="p">,</span> <span class="mi">9000000</span><span class="p">,</span> <span class="mi">12000000</span><span class="p">,</span> <span class="mi">18000000</span><span class="p">,</span> <span class="mi">24000000</span><span class="p">,</span> <span class="mi">36000000</span><span class="p">,</span> <span class="mi">48000000</span><span class="p">,</span> <span class="mi">54000000</span><span class="p">};</span>

<span class="cp">#define RATE_COUNT ARRAY_SIZE(rtl8180_rates)</span>

<span class="k">static</span> <span class="n">CHANNEL_LIST</span> <span class="n">DefaultChannelPlan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span> <span class="mi">19</span><span class="p">},</span>		<span class="cm">/* FCC */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span> <span class="mi">11</span><span class="p">},</span>						<span class="cm">/* IC */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span> <span class="mi">21</span><span class="p">},</span>	<span class="cm">/* ETSI	*/</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span> <span class="mi">21</span><span class="p">},</span>	<span class="cm">/* Spain. Change to ETSI. */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span> <span class="mi">21</span><span class="p">},</span>	<span class="cm">/* France. Change to ETSI. */</span>
	<span class="p">{{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span> <span class="mi">9</span><span class="p">},</span>						<span class="cm">/* MKK */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span> <span class="mi">22</span><span class="p">},</span>	<span class="cm">/* MKK1	*/</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">64</span><span class="p">},</span> <span class="mi">21</span><span class="p">},</span>	<span class="cm">/* Israel */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">46</span><span class="p">},</span> <span class="mi">17</span><span class="p">},</span>			<span class="cm">/* For 11a , TELEC */</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">},</span> <span class="mi">14</span><span class="p">}</span>					<span class="cm">/* For Global Domain. 1-11:active scan, 12-14 passive scan.*/</span>	<span class="cm">/* +YJ, 080626 */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ieee80211_wx_get_freq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">r8180_wx_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span><span class="o">*</span> <span class="n">tkey</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">key0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tkey</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Setting wep key to %x %x %x %x&quot;</span><span class="p">,</span>
		      <span class="n">tkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tkey</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tkey</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tkey</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">rtl8180_set_hw_wep</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_beaconinterval</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">aa</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">parms</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bi</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;setting beacon interval to %x&quot;</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">bi</span><span class="p">;</span>
	<span class="n">rtl8180_commit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ieee80211_wx_get_mode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ieee80211_wx_get_rate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_rate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_crcmon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">parms</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;bad CRC in monitor mode are %s&quot;</span><span class="p">,</span>
	      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span> <span class="o">?</span> <span class="s">&quot;accepted&quot;</span> <span class="o">:</span> <span class="s">&quot;rejected&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">rtl8180_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8180_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">IPSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_mode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* YJ,add,080819,for hidden ap */</span>
<span class="k">struct</span>  <span class="n">iw_range_with_scan_capa</span>	<span class="p">{</span>
		<span class="cm">/* Informative stuff (to choose between different interface) */</span>

		<span class="n">__u32</span>		<span class="n">throughput</span><span class="p">;</span> <span class="cm">/* To give an idea... */</span>

		<span class="cm">/* In theory this value should be the maximum benchmarked</span>
<span class="cm">		 * TCP/IP throughput, because with most of these devices the</span>
<span class="cm">		 * bit rate is meaningless (overhead an co) to estimate how</span>
<span class="cm">		 * fast the connection will go and pick the fastest one.</span>
<span class="cm">		 * I suggest people to play with Netperf or any benchmark...</span>
<span class="cm">		 */</span>

		<span class="cm">/* NWID (or domain id)	*/</span>
		<span class="n">__u32</span>           <span class="n">min_nwid</span><span class="p">;</span> <span class="cm">/* Minimal NWID we are able to set */</span>
		<span class="n">__u32</span>			<span class="n">max_nwid</span><span class="p">;</span> <span class="cm">/* Maximal NWID we are able to set */</span>

		<span class="cm">/* Old Frequency (backward compat - moved lower ) */</span>
		<span class="n">__u16</span>			<span class="n">old_num_channels</span><span class="p">;</span>
		<span class="n">__u8</span>			<span class="n">old_num_frequency</span><span class="p">;</span>

		<span class="cm">/* Scan capabilities */</span>
		<span class="n">__u8</span>			<span class="n">scan_capa</span><span class="p">;</span>
<span class="p">};</span>
<span class="cm">/* YJ,add,080819,for hidden ap */</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8180_wx_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">));</span>

	<span class="cm">/* Let&#39;s try to keep this struct in the same order as in</span>
<span class="cm">	 * linux/include/wireless.h</span>
<span class="cm">	 */</span>

	<span class="cm">/* TODO: See what values we can set, and remove the ones we can&#39;t</span>
<span class="cm">	 * set, or fill them with some default data.</span>
<span class="cm">	 */</span>

	<span class="cm">/* ~5 Mb/s real (802.11b) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* TODO: Not used in 802.11b?	*/</span>
<span class="cm">/*	range-&gt;min_nwid; */</span>	<span class="cm">/* Minimal NWID we are able to set */</span>
	<span class="cm">/* TODO: Not used in 802.11b?	*/</span>
<span class="cm">/*	range-&gt;max_nwid; */</span>	<span class="cm">/* Maximal NWID we are able to set */</span>

		<span class="cm">/* Old Frequency (backward compat - moved lower ) */</span>
<span class="cm">/*	range-&gt;old_num_channels; */</span>
<span class="cm">/*	range-&gt;old_num_frequency; */</span>
<span class="cm">/*	range-&gt;old_freq[6]; */</span> <span class="cm">/* Filler to keep &quot;version&quot; at the same offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_sens</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_sens</span><span class="p">;</span>	<span class="cm">/* signal level threshold range */</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="cm">/* TODO: Find real max RSSI and stick here */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">98</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* Updated all three */</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">92</span><span class="p">;</span> <span class="cm">/* &gt; 8% missed beacons is &#39;bad&#39; */</span>
	<span class="cm">/* TODO: Find real &#39;good&#39; to &#39;bad&#39; threshold value for RSSI */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="o">-</span><span class="mi">98</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* Updated all three */</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">RATE_COUNT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_BITRATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl8180_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="n">MIN_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pm_capa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Include only legal frequencies for some countries */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">)[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_wlan_frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">val</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* FIXME: do we need to set anything for channels */</span>
			<span class="cm">/* we don&#39;t use ? */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IW_MAX_FREQUENCIES</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_WPA2</span> <span class="o">|</span>
						<span class="n">IW_ENC_CAPA_CIPHER_TKIP</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_CIPHER_CCMP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_SCAN_THIS_ESSID</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">iw_scan_req</span><span class="o">*</span> <span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">)</span>		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">))</span>	<span class="p">{</span>
			<span class="n">IPSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ieee80211_softmac_ips_scan_syncro</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>	<span class="k">else</span>	<span class="p">{</span>
			<span class="cm">/* prevent scan in BusyTraffic */</span>
			<span class="cm">/* FIXME: Need to consider last scan time */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">link_detect</span><span class="p">.</span><span class="n">bBusyTraffic</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nb">true</span><span class="p">))</span>	<span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Now traffic is busy, please try later!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>	<span class="k">else</span>
				<span class="cm">/* prevent scan in BusyTraffic,end */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_scan</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>	<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_get_scan</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInactivePs</span><span class="p">)</span>
		<span class="n">IPSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_essid</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_get_essid</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_freq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ieee80211_wx_get_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">DEFAULT_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">MIN_FRAG_THRESHOLD</span> <span class="o">||</span>
		    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">fts</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">DEFAULT_FRAG_THRESHOLD</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_wap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">awrq</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ieee80211_wx_get_wap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_wep</span><span class="p">)</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">r8180_wx_set_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">else</span>	<span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Setting SW wep key&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_encode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ieee80211_wx_get_encode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_scan_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">aa</span><span class="p">,</span> <span class="k">union</span>
	<span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>	<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">parms</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIFETIME</span> <span class="o">||</span>
	    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">))</span>	<span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">R8180_MAX_RETRY</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_rts</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Setting retry for RTS/CTS data to %d&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

	<span class="p">}</span>	<span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_data</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Setting retry for non RTS/CTS data to %d&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME !</span>
<span class="cm">	 * We might try to write directly the TX config register</span>
<span class="cm">	 * or to restart just the (R)TX process.</span>
<span class="cm">	 * I&#39;m unsure if whole reset is really needed</span>
<span class="cm">	 */</span>

	<span class="n">rtl8180_commit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* can&#39;t be disabled */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_TYPE</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_MAX</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_rts</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_MIN</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_sens</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* we have not this support for this radio */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">short</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_sens</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* we have not this support for this radio */</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_sens</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sens</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_rawtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_rawtx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_get_power</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;=&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;=============================&gt;set power:%d, %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_power</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts</span> <span class="o">=</span> <span class="n">DEFAULT_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">MIN_RTS_THRESHOLD</span> <span class="o">||</span>
		    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_RTS_THRESHOLD</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>



	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
		 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_iwmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>



	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;802.11&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CCK_MODULATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;/g&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;g&quot;</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_iwmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">modulation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modulation</span> <span class="o">|=</span> <span class="n">IEEE80211_CCK_MODULATION</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_B</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;B mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modulation</span> <span class="o">|=</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_G</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;G mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modulation</span> <span class="o">|=</span> <span class="n">IEEE80211_CCK_MODULATION</span><span class="p">;</span>
		<span class="n">modulation</span> <span class="o">|=</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_B</span><span class="o">|</span><span class="n">IEEE_G</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;B/G mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_stop_protocol</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">modulation</span><span class="p">;</span>
		<span class="n">ieee80211_start_protocol</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">modulation</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>



	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>



	<span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">plcp_preamble_mode</span><span class="p">;</span>	<span class="cm">/* 0:auto 1:short 2:long */</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">extra</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">extra</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">plcp_preamble_mode</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">)</span> <span class="p">;</span>



	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_siglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>



	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="cm">/* Modify by hikaru 6.5 */</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">)</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span><span class="p">;</span><span class="cm">/*for interface test ,it should be the priv-&gt;wstats.qual.level; */</span>



	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_sigqual</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>



	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="cm">/* Modify by hikaru 6.5	*/</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">)</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span><span class="p">;</span><span class="cm">/* for interface test ,it should be the priv-&gt;wstats.qual.qual; */</span>



	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_reset_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txrdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxrdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxnolast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxnodata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxnopointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txnperr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txresumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxoverflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txnpokint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txhpokint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txhperr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">shints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txoverflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxdmafail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeacon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeaconerr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txlpokint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txlperr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txretry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="cm">/* 20060601 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmin</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxcrcerrmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxicverr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_radio_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_radio_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_channelplan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>



	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_plan</span><span class="p">;</span>



	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_channelplan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-----in fun %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* unsigned long flags; */</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DefaultChannelPlan</span><span class="p">[</span><span class="o">*</span><span class="n">val</span><span class="p">].</span><span class="n">Len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_plan</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
		<span class="cm">/* Clear old channel map 8 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Set new channel map */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">DefaultChannelPlan</span><span class="p">[</span><span class="o">*</span><span class="n">val</span><span class="p">].</span><span class="n">Len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">DefaultChannelPlan</span><span class="p">[</span><span class="o">*</span><span class="n">val</span><span class="p">].</span><span class="n">Channel</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		
	<span class="p">}</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* struct ieee80211_device *ieee; */</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;1020.0808&quot;</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* added by amy 080818 */</span>
<span class="cm">/*receive datarate from user typing valid rate is from 2 to 108 (1 - 54M), if input 0, return to normal rate adaptive. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_forcerate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">forcerate</span> <span class="o">=</span> <span class="o">*</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;==============&gt;%s(): forcerate is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">forcerate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">22</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">18</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">36</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">48</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">72</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">96</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">108</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ForcedDataRate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">forcerate</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">forcerate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ForcedDataRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;OK! return rate adaptive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>	<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ERR: wrong rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_enc_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
										<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
										<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_encode_ext</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_auth</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
										<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
										<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="cp">#if 1</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_mlme</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">wrqu</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8180_wx_set_gen_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="cp">#if 1</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wx_set_gen_ie</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>


<span class="p">}</span>
<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">r8180_wx_handlers</span><span class="p">[]</span> <span class="o">=</span>	<span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWCOMMIT */</span>
		<span class="n">r8180_wx_get_name</span><span class="p">,</span>			<span class="cm">/* SIOCGIWNAME */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCSIWNWID */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCGIWNWID */</span>
		<span class="n">r8180_wx_set_freq</span><span class="p">,</span>			<span class="cm">/* SIOCSIWFREQ */</span>
		<span class="n">r8180_wx_get_freq</span><span class="p">,</span>			<span class="cm">/* SIOCGIWFREQ */</span>
		<span class="n">r8180_wx_set_mode</span><span class="p">,</span>			<span class="cm">/* SIOCSIWMODE */</span>
		<span class="n">r8180_wx_get_mode</span><span class="p">,</span>			<span class="cm">/* SIOCGIWMODE */</span>
		<span class="n">r8180_wx_set_sens</span><span class="p">,</span>			<span class="cm">/* SIOCSIWSENS */</span>
		<span class="n">r8180_wx_get_sens</span><span class="p">,</span>			<span class="cm">/* SIOCGIWSENS */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWRANGE */</span>
		<span class="n">rtl8180_wx_get_range</span><span class="p">,</span>			<span class="cm">/* SIOCGIWRANGE */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWPRIV */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCGIWPRIV */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWSTATS */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCGIWSTATS */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCSIWSPY */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCGIWSPY */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCGIWTHRSPY */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCWIWTHRSPY */</span>
		<span class="n">r8180_wx_set_wap</span><span class="p">,</span>			<span class="cm">/* SIOCSIWAP */</span>
		<span class="n">r8180_wx_get_wap</span><span class="p">,</span>			<span class="cm">/* SIOCGIWAP */</span>
		<span class="n">r8180_wx_set_mlme</span><span class="p">,</span>			<span class="cm">/* SIOCSIWMLME*/</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCGIWAPLIST -- deprecated */</span>
		<span class="n">r8180_wx_set_scan</span><span class="p">,</span>			<span class="cm">/* SIOCSIWSCAN */</span>
		<span class="n">r8180_wx_get_scan</span><span class="p">,</span>			<span class="cm">/* SIOCGIWSCAN */</span>
		<span class="n">r8180_wx_set_essid</span><span class="p">,</span>			<span class="cm">/* SIOCSIWESSID */</span>
		<span class="n">r8180_wx_get_essid</span><span class="p">,</span>			<span class="cm">/* SIOCGIWESSID */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCSIWNICKN */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCGIWNICKN */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* -- hole -- */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* -- hole -- */</span>
		<span class="n">r8180_wx_set_rate</span><span class="p">,</span>			<span class="cm">/* SIOCSIWRATE */</span>
		<span class="n">r8180_wx_get_rate</span><span class="p">,</span>			<span class="cm">/* SIOCGIWRATE */</span>
		<span class="n">r8180_wx_set_rts</span><span class="p">,</span>			<span class="cm">/* SIOCSIWRTS */</span>
		<span class="n">r8180_wx_get_rts</span><span class="p">,</span>			<span class="cm">/* SIOCGIWRTS */</span>
		<span class="n">r8180_wx_set_frag</span><span class="p">,</span>			<span class="cm">/* SIOCSIWFRAG */</span>
		<span class="n">r8180_wx_get_frag</span><span class="p">,</span>			<span class="cm">/* SIOCGIWFRAG */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCSIWTXPOW */</span>
		<span class="n">dummy</span><span class="p">,</span>					<span class="cm">/* SIOCGIWTXPOW */</span>
		<span class="n">r8180_wx_set_retry</span><span class="p">,</span>			<span class="cm">/* SIOCSIWRETRY */</span>
		<span class="n">r8180_wx_get_retry</span><span class="p">,</span>			<span class="cm">/* SIOCGIWRETRY */</span>
		<span class="n">r8180_wx_set_enc</span><span class="p">,</span>			<span class="cm">/* SIOCSIWENCODE */</span>
		<span class="n">r8180_wx_get_enc</span><span class="p">,</span>			<span class="cm">/* SIOCGIWENCODE */</span>
		<span class="n">r8180_wx_set_power</span><span class="p">,</span>			<span class="cm">/* SIOCSIWPOWER */</span>
		<span class="n">r8180_wx_get_power</span><span class="p">,</span>			<span class="cm">/* SIOCGIWPOWER */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*---hole---*/</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*---hole---*/</span>
		<span class="n">r8180_wx_set_gen_ie</span><span class="p">,</span>			<span class="cm">/* SIOCSIWGENIE */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWGENIE */</span>
		<span class="n">r8180_wx_set_auth</span><span class="p">,</span>			<span class="cm">/* SIOCSIWAUTH */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWAUTH */</span>
		<span class="n">r8180_wx_set_enc_ext</span><span class="p">,</span>			<span class="cm">/* SIOCSIWENCODEEXT */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWENCODEEXT */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/* SIOCSIWPMKSA */</span>
		<span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*---hole---*/</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">r8180_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;badcrc&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;beaconint&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;activescan&quot;</span>

	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;rawtx&quot;</span>

	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x7</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;setiwmode&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;getiwmode&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0xA</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;setpreamble&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0xB</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getpreamble&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0xC</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0xD</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getrssi&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0xE</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0xF</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getlinkqual&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;resetstats&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x11</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;radioon&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x13</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;radiooff&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;setchannel&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x15</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getchannel&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x16</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x17</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;getversion&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;setrate&quot;</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">r8180_private_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">r8180_wx_set_crcmon</span><span class="p">,</span> <span class="cm">/*SIOCIWSECONDPRIV*/</span>
	<span class="n">dummy</span><span class="p">,</span>
	<span class="n">r8180_wx_set_beaconinterval</span><span class="p">,</span>
	<span class="n">dummy</span><span class="p">,</span>
	<span class="cm">/* r8180_wx_set_monitor_type, */</span>
	<span class="n">r8180_wx_set_scan_type</span><span class="p">,</span>
	<span class="n">dummy</span><span class="p">,</span>
	<span class="n">r8180_wx_set_rawtx</span><span class="p">,</span>
	<span class="n">dummy</span><span class="p">,</span>
	<span class="n">r8180_wx_set_iwmode</span><span class="p">,</span>
	<span class="n">r8180_wx_get_iwmode</span><span class="p">,</span>
	<span class="n">r8180_wx_set_preamble</span><span class="p">,</span>
	<span class="n">r8180_wx_get_preamble</span><span class="p">,</span>
	<span class="n">dummy</span><span class="p">,</span>
	<span class="n">r8180_wx_get_siglevel</span><span class="p">,</span>
	<span class="n">dummy</span><span class="p">,</span>
	<span class="n">r8180_wx_get_sigqual</span><span class="p">,</span>
	<span class="n">r8180_wx_reset_stats</span><span class="p">,</span>
	<span class="n">dummy</span><span class="p">,</span><span class="cm">/* r8180_wx_get_stats */</span>
	<span class="n">r8180_wx_radio_on</span><span class="p">,</span>
	<span class="n">r8180_wx_radio_off</span><span class="p">,</span>
	<span class="n">r8180_wx_set_channelplan</span><span class="p">,</span>
	<span class="n">r8180_wx_get_channelplan</span><span class="p">,</span>
	<span class="n">dummy</span><span class="p">,</span>
	<span class="n">r8180_wx_get_version</span><span class="p">,</span>
	<span class="n">r8180_wx_set_forcerate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_same_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
									<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
		<span class="cm">/* A network is only a duplicate if the channel, BSSID, ESSID</span>
<span class="cm">		 * and the capability field (in particular IBSS and BSS) all match.</span>
<span class="cm">		 * We treat all &lt;hidden&gt; with the same BSSID and channel</span>
<span class="cm">		 * as one network</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="cm">/* YJ,mod, 080819,for hidden ap */</span>
			<span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* YJ,mod, 080819,for hidden ap */</span>
			<span class="p">((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span> <span class="o">==</span>
			<span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">)</span> <span class="o">==</span>
			<span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/* WB modified to show signal to GUI on 18-01-2008 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">r8180_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span><span class="o">*</span> <span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp_level</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signal</span><span class="p">;</span>
	<span class="n">tmp_qual</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signalstrength</span><span class="p">;</span>
	<span class="n">tmp_noise</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>

	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">tmp_level</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">tmp_qual</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">tmp_noise</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">iw_handler_def</span>  <span class="n">r8180_wx_handlers_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">r8180_wx_handlers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_standard</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">r8180_wx_handlers</span><span class="p">),</span>
	<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">r8180_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_private</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">r8180_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r8180_private_args</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">r8180_get_wireless_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="o">*</span><span class="p">)</span><span class="n">r8180_private_args</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
