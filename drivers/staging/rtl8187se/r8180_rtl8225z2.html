<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8187se › r8180_rtl8225z2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>r8180_rtl8225z2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is part of the rtl8180-sa2400 driver</span>
<span class="cm"> * released under the GPL (See file COPYING for details).</span>
<span class="cm"> * Copyright (c) 2005 Andrea Merello &lt;andreamrl@tiscali.it&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This files contains programming code for the rtl8225</span>
<span class="cm"> * radio frontend.</span>
<span class="cm"> *</span>
<span class="cm"> * *Many* thanks to Realtek Corp. for their great support!</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;r8180_hw.h&quot;</span>
<span class="cp">#include &quot;r8180_rtl8225.h&quot;</span>
<span class="cp">#include &quot;r8180_93cx6.h&quot;</span>

<span class="cp">#include &quot;ieee80211/dot11d.h&quot;</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_rtl8225</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">out</span><span class="p">,</span> <span class="n">select</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bangdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">adr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="n">out</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff3</span><span class="p">;</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">,</span>
		<span class="p">(</span><span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x7</span><span class="p">));</span>

	<span class="n">select</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">,</span> <span class="n">select</span> <span class="o">|</span> <span class="mh">0x7</span> <span class="o">|</span>
		       <span class="n">SW_CONTROL_GPIO</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">out</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_EN</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">bangdata</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">out</span><span class="p">);</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">out</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">out</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>

		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">bangdata</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">out</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">out</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">out</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">out</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_EN</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">out</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_EN</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">,</span> <span class="n">select</span> <span class="o">|</span> <span class="n">SW_CONTROL_GPIO</span><span class="p">);</span>

	<span class="n">rtl8185_rf_pins_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rtl8225bcd_rxgain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0400</span><span class="p">,</span> <span class="mh">0x0401</span><span class="p">,</span> <span class="mh">0x0402</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="mh">0x0404</span><span class="p">,</span> <span class="mh">0x0405</span><span class="p">,</span> <span class="mh">0x0408</span><span class="p">,</span> <span class="mh">0x0409</span><span class="p">,</span>
	<span class="mh">0x040a</span><span class="p">,</span> <span class="mh">0x040b</span><span class="p">,</span> <span class="mh">0x0502</span><span class="p">,</span> <span class="mh">0x0503</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="mh">0x0505</span><span class="p">,</span> <span class="mh">0x0540</span><span class="p">,</span> <span class="mh">0x0541</span><span class="p">,</span>
	<span class="mh">0x0542</span><span class="p">,</span> <span class="mh">0x0543</span><span class="p">,</span> <span class="mh">0x0544</span><span class="p">,</span> <span class="mh">0x0545</span><span class="p">,</span> <span class="mh">0x0580</span><span class="p">,</span> <span class="mh">0x0581</span><span class="p">,</span> <span class="mh">0x0582</span><span class="p">,</span> <span class="mh">0x0583</span><span class="p">,</span>
	<span class="mh">0x0584</span><span class="p">,</span> <span class="mh">0x0585</span><span class="p">,</span> <span class="mh">0x0588</span><span class="p">,</span> <span class="mh">0x0589</span><span class="p">,</span> <span class="mh">0x058a</span><span class="p">,</span> <span class="mh">0x058b</span><span class="p">,</span> <span class="mh">0x0643</span><span class="p">,</span> <span class="mh">0x0644</span><span class="p">,</span>
	<span class="mh">0x0645</span><span class="p">,</span> <span class="mh">0x0680</span><span class="p">,</span> <span class="mh">0x0681</span><span class="p">,</span> <span class="mh">0x0682</span><span class="p">,</span> <span class="mh">0x0683</span><span class="p">,</span> <span class="mh">0x0684</span><span class="p">,</span> <span class="mh">0x0685</span><span class="p">,</span> <span class="mh">0x0688</span><span class="p">,</span>
	<span class="mh">0x0689</span><span class="p">,</span> <span class="mh">0x068a</span><span class="p">,</span> <span class="mh">0x068b</span><span class="p">,</span> <span class="mh">0x068c</span><span class="p">,</span> <span class="mh">0x0742</span><span class="p">,</span> <span class="mh">0x0743</span><span class="p">,</span> <span class="mh">0x0744</span><span class="p">,</span> <span class="mh">0x0745</span><span class="p">,</span>
	<span class="mh">0x0780</span><span class="p">,</span> <span class="mh">0x0781</span><span class="p">,</span> <span class="mh">0x0782</span><span class="p">,</span> <span class="mh">0x0783</span><span class="p">,</span> <span class="mh">0x0784</span><span class="p">,</span> <span class="mh">0x0785</span><span class="p">,</span> <span class="mh">0x0788</span><span class="p">,</span> <span class="mh">0x0789</span><span class="p">,</span>
	<span class="mh">0x078a</span><span class="p">,</span> <span class="mh">0x078b</span><span class="p">,</span> <span class="mh">0x078c</span><span class="p">,</span> <span class="mh">0x078d</span><span class="p">,</span> <span class="mh">0x0790</span><span class="p">,</span> <span class="mh">0x0791</span><span class="p">,</span> <span class="mh">0x0792</span><span class="p">,</span> <span class="mh">0x0793</span><span class="p">,</span>
	<span class="mh">0x0794</span><span class="p">,</span> <span class="mh">0x0795</span><span class="p">,</span> <span class="mh">0x0798</span><span class="p">,</span> <span class="mh">0x0799</span><span class="p">,</span> <span class="mh">0x079a</span><span class="p">,</span> <span class="mh">0x079b</span><span class="p">,</span> <span class="mh">0x079c</span><span class="p">,</span> <span class="mh">0x079d</span><span class="p">,</span>
	<span class="mh">0x07a0</span><span class="p">,</span> <span class="mh">0x07a1</span><span class="p">,</span> <span class="mh">0x07a2</span><span class="p">,</span> <span class="mh">0x07a3</span><span class="p">,</span> <span class="mh">0x07a4</span><span class="p">,</span> <span class="mh">0x07a5</span><span class="p">,</span> <span class="mh">0x07a8</span><span class="p">,</span> <span class="mh">0x07a9</span><span class="p">,</span>
	<span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x07ab</span><span class="p">,</span> <span class="mh">0x07ac</span><span class="p">,</span> <span class="mh">0x07ad</span><span class="p">,</span> <span class="mh">0x07b0</span><span class="p">,</span> <span class="mh">0x07b1</span><span class="p">,</span> <span class="mh">0x07b2</span><span class="p">,</span> <span class="mh">0x07b3</span><span class="p">,</span>
	<span class="mh">0x07b4</span><span class="p">,</span> <span class="mh">0x07b5</span><span class="p">,</span> <span class="mh">0x07b8</span><span class="p">,</span> <span class="mh">0x07b9</span><span class="p">,</span> <span class="mh">0x07ba</span><span class="p">,</span> <span class="mh">0x07bb</span><span class="p">,</span> <span class="mh">0x07bb</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225_agc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span>
	<span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span>
	<span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span>
	<span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span>
	<span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span>
	<span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span>
	<span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span>
	<span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span>
	<span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
	<span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span>
	<span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225_gain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span>	<span class="cm">/* -82dBm */</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span>	<span class="cm">/* -82dBm */</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>	<span class="cm">/* -82dBm */</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>	<span class="cm">/* -78dBm */</span>
	<span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>	<span class="cm">/* -74dBm */</span>
	<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>	<span class="cm">/* -70dBm */</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>	<span class="cm">/* -66dBm */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225_tx_gain_cck_ofdm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x7e</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225_tx_power_cck</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225_tx_power_cck_ch14</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225_tx_power_ofdm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xe4</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">rtl8225_chan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mh">0x0080</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0180</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">,</span> <span class="mh">0x0280</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">,</span> <span class="mh">0x0380</span><span class="p">,</span>
	<span class="mh">0x0400</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x0580</span><span class="p">,</span> <span class="mh">0x0600</span><span class="p">,</span> <span class="mh">0x0680</span><span class="p">,</span> <span class="mh">0x074A</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8225_SetTXPowerLevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">GainIdx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">GainSetting</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">power</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cck_power_table</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_cck_power_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_ofdm_power_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">min_ofdm_power_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cck_power_level</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ofdm_power_level</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>

	<span class="n">max_cck_power_level</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
	<span class="n">max_ofdm_power_level</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
	<span class="n">min_ofdm_power_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cck_power_level</span> <span class="o">&gt;</span> <span class="n">max_cck_power_level</span><span class="p">)</span>
		<span class="n">cck_power_level</span> <span class="o">=</span> <span class="n">max_cck_power_level</span><span class="p">;</span>

	<span class="n">GainIdx</span> <span class="o">=</span> <span class="n">cck_power_level</span> <span class="o">%</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">GainSetting</span> <span class="o">=</span> <span class="n">cck_power_level</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">cck_power_table</span> <span class="o">=</span> <span class="n">rtl8225_tx_power_cck_ch14</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cck_power_table</span> <span class="o">=</span> <span class="n">rtl8225_tx_power_cck</span><span class="p">;</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_GAIN_CCK</span><span class="p">,</span>
		       <span class="n">rtl8225_tx_gain_cck_ofdm</span><span class="p">[</span><span class="n">GainSetting</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">power</span> <span class="o">=</span> <span class="n">cck_power_table</span><span class="p">[</span><span class="n">GainIdx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x44</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME Is this delay really needed ? */</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_power_level</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_ofdm_power_level</span> <span class="o">-</span> <span class="n">min_ofdm_power_level</span><span class="p">))</span>
		<span class="n">ofdm_power_level</span> <span class="o">=</span> <span class="n">max_ofdm_power_level</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ofdm_power_level</span> <span class="o">+=</span> <span class="n">min_ofdm_power_level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_power_level</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span>
		<span class="n">ofdm_power_level</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>

	<span class="n">GainIdx</span> <span class="o">=</span> <span class="n">ofdm_power_level</span> <span class="o">%</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">GainSetting</span> <span class="o">=</span> <span class="n">ofdm_power_level</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">rtl8185_set_anaparam2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RTL8225_ANAPARAM2_ON</span><span class="p">);</span>

	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_GAIN_OFDM</span><span class="p">,</span>
		       <span class="n">rtl8225_tx_gain_cck_ofdm</span><span class="p">[</span><span class="n">GainSetting</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">power</span> <span class="o">=</span> <span class="n">rtl8225_tx_power_ofdm</span><span class="p">[</span><span class="n">GainIdx</span><span class="p">];</span>

	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225z2_threshold</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225z2_gain_bg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="cm">/* -82-1dBm */</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="cm">/* -82-2dBm */</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="cm">/* -82-3dBm */</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="cm">/* -78dBm */</span>
	<span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="cm">/* -74dBm */</span>
	<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="cm">/* -70dBm */</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="cm">/* -66dBm */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225z2_gain_a</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="cm">/* -82dBm */</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="cm">/* -82dBm */</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="cm">/* -82dBm */</span>
	<span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="cm">/* -78dBm */</span>
	<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="cm">/* -74dBm */</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="cm">/* -70dBm */</span>
	<span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="cm">/* -66dBm */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rtl8225z2_rxgain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0400</span><span class="p">,</span> <span class="mh">0x0401</span><span class="p">,</span> <span class="mh">0x0402</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="mh">0x0404</span><span class="p">,</span> <span class="mh">0x0405</span><span class="p">,</span> <span class="mh">0x0408</span><span class="p">,</span> <span class="mh">0x0409</span><span class="p">,</span>
	<span class="mh">0x040a</span><span class="p">,</span> <span class="mh">0x040b</span><span class="p">,</span> <span class="mh">0x0502</span><span class="p">,</span> <span class="mh">0x0503</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="mh">0x0505</span><span class="p">,</span> <span class="mh">0x0540</span><span class="p">,</span> <span class="mh">0x0541</span><span class="p">,</span>
	<span class="mh">0x0542</span><span class="p">,</span> <span class="mh">0x0543</span><span class="p">,</span> <span class="mh">0x0544</span><span class="p">,</span> <span class="mh">0x0545</span><span class="p">,</span> <span class="mh">0x0580</span><span class="p">,</span> <span class="mh">0x0581</span><span class="p">,</span> <span class="mh">0x0582</span><span class="p">,</span> <span class="mh">0x0583</span><span class="p">,</span>
	<span class="mh">0x0584</span><span class="p">,</span> <span class="mh">0x0585</span><span class="p">,</span> <span class="mh">0x0588</span><span class="p">,</span> <span class="mh">0x0589</span><span class="p">,</span> <span class="mh">0x058a</span><span class="p">,</span> <span class="mh">0x058b</span><span class="p">,</span> <span class="mh">0x0643</span><span class="p">,</span> <span class="mh">0x0644</span><span class="p">,</span>
	<span class="mh">0x0645</span><span class="p">,</span> <span class="mh">0x0680</span><span class="p">,</span> <span class="mh">0x0681</span><span class="p">,</span> <span class="mh">0x0682</span><span class="p">,</span> <span class="mh">0x0683</span><span class="p">,</span> <span class="mh">0x0684</span><span class="p">,</span> <span class="mh">0x0685</span><span class="p">,</span> <span class="mh">0x0688</span><span class="p">,</span>
	<span class="mh">0x0689</span><span class="p">,</span> <span class="mh">0x068a</span><span class="p">,</span> <span class="mh">0x068b</span><span class="p">,</span> <span class="mh">0x068c</span><span class="p">,</span> <span class="mh">0x0742</span><span class="p">,</span> <span class="mh">0x0743</span><span class="p">,</span> <span class="mh">0x0744</span><span class="p">,</span> <span class="mh">0x0745</span><span class="p">,</span>
	<span class="mh">0x0780</span><span class="p">,</span> <span class="mh">0x0781</span><span class="p">,</span> <span class="mh">0x0782</span><span class="p">,</span> <span class="mh">0x0783</span><span class="p">,</span> <span class="mh">0x0784</span><span class="p">,</span> <span class="mh">0x0785</span><span class="p">,</span> <span class="mh">0x0788</span><span class="p">,</span> <span class="mh">0x0789</span><span class="p">,</span>
	<span class="mh">0x078a</span><span class="p">,</span> <span class="mh">0x078b</span><span class="p">,</span> <span class="mh">0x078c</span><span class="p">,</span> <span class="mh">0x078d</span><span class="p">,</span> <span class="mh">0x0790</span><span class="p">,</span> <span class="mh">0x0791</span><span class="p">,</span> <span class="mh">0x0792</span><span class="p">,</span> <span class="mh">0x0793</span><span class="p">,</span>
	<span class="mh">0x0794</span><span class="p">,</span> <span class="mh">0x0795</span><span class="p">,</span> <span class="mh">0x0798</span><span class="p">,</span> <span class="mh">0x0799</span><span class="p">,</span> <span class="mh">0x079a</span><span class="p">,</span> <span class="mh">0x079b</span><span class="p">,</span> <span class="mh">0x079c</span><span class="p">,</span> <span class="mh">0x079d</span><span class="p">,</span>
	<span class="mh">0x07a0</span><span class="p">,</span> <span class="mh">0x07a1</span><span class="p">,</span> <span class="mh">0x07a2</span><span class="p">,</span> <span class="mh">0x07a3</span><span class="p">,</span> <span class="mh">0x07a4</span><span class="p">,</span> <span class="mh">0x07a5</span><span class="p">,</span> <span class="mh">0x07a8</span><span class="p">,</span> <span class="mh">0x07a9</span><span class="p">,</span>
	<span class="mh">0x03aa</span><span class="p">,</span> <span class="mh">0x03ab</span><span class="p">,</span> <span class="mh">0x03ac</span><span class="p">,</span> <span class="mh">0x03ad</span><span class="p">,</span> <span class="mh">0x03b0</span><span class="p">,</span> <span class="mh">0x03b1</span><span class="p">,</span> <span class="mh">0x03b2</span><span class="p">,</span> <span class="mh">0x03b3</span><span class="p">,</span>
	<span class="mh">0x03b4</span><span class="p">,</span> <span class="mh">0x03b5</span><span class="p">,</span> <span class="mh">0x03b8</span><span class="p">,</span> <span class="mh">0x03b9</span><span class="p">,</span> <span class="mh">0x03ba</span><span class="p">,</span> <span class="mh">0x03bb</span><span class="p">,</span> <span class="mh">0x03bb</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ZEBRA2_CCK_OFDM_GAIN_SETTING</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span>
	<span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225z2_tx_power_ofdm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225z2_tx_power_cck_ch14</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rtl8225z2_tx_power_cck</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">rtl8225z2_set_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">gain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rtl8225_gain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_B</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_G</span><span class="p">)</span>
		<span class="n">rtl8225_gain</span> <span class="o">=</span> <span class="n">rtl8225z2_gain_bg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rtl8225_gain</span> <span class="o">=</span> <span class="n">rtl8225z2_gain_a</span><span class="p">;</span>

	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="n">rtl8225_gain</span><span class="p">[</span><span class="n">gain</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">rtl8225_gain</span><span class="p">[</span><span class="n">gain</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">rtl8225_gain</span><span class="p">[</span><span class="n">gain</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">read_rtl8225</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data2Write</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">adr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dataRead</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">oval</span><span class="p">,</span> <span class="n">oval2</span><span class="p">,</span> <span class="n">oval3</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">bit</span><span class="p">,</span> <span class="n">rw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wLength</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rLength</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">low2high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oval</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">);</span>
	<span class="n">oval2</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">);</span>
	<span class="n">oval3</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">,</span> <span class="p">(</span><span class="n">oval2</span><span class="o">|</span><span class="mh">0xf</span><span class="p">));</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">,</span> <span class="p">(</span><span class="n">oval3</span><span class="o">|</span><span class="mh">0xf</span><span class="p">));</span>

	<span class="n">dataRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">oval</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_EN</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">oval</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">rw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">low2high</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0x01</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wLength</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">data2Write</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">oval</span> <span class="o">|</span> <span class="n">rw</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span>
				<span class="n">bit</span> <span class="o">|</span> <span class="n">oval</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span> <span class="o">|</span> <span class="n">rw</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span>
				<span class="n">bit</span> <span class="o">|</span> <span class="n">oval</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span> <span class="o">|</span> <span class="n">rw</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">low2high</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">mask</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rw</span> <span class="o">=</span> <span class="n">BB_HOST_BANG_RW</span><span class="p">;</span>
			<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span>
					<span class="n">bit</span> <span class="o">|</span> <span class="n">oval</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span> <span class="o">|</span> <span class="n">rw</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">oval</span> <span class="o">|</span> <span class="n">rw</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">data2Write</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span>
				<span class="n">oval</span> <span class="o">|</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">rw</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span>
				<span class="n">oval</span> <span class="o">|</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">rw</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">oval</span> <span class="o">|</span> <span class="n">bit</span> <span class="o">|</span> <span class="n">rw</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">low2high</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">mask</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">rw</span><span class="o">|</span><span class="n">oval</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">low2high</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">12</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must set data pin to HW controlled, otherwise RF can&#39;t driver it</span>
<span class="cm">	 * and value RF register won&#39;t be able to read back properly.</span>
<span class="cm">	 */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">,</span> <span class="p">(</span><span class="n">oval2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x01</span><span class="p">)));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">rw</span><span class="o">|</span><span class="n">oval</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">rw</span><span class="o">|</span><span class="n">oval</span><span class="o">|</span><span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">rw</span><span class="o">|</span><span class="n">oval</span><span class="o">|</span><span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="n">rw</span><span class="o">|</span><span class="n">oval</span><span class="o">|</span><span class="n">BB_HOST_BANG_CLK</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsInput</span><span class="p">);</span>

		<span class="n">dataRead</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">BB_HOST_BANG_CLK</span> <span class="o">?</span> <span class="n">mask</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="p">(</span><span class="n">rw</span><span class="o">|</span><span class="n">oval</span><span class="p">));</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">low2high</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">mask</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span>
			<span class="n">BB_HOST_BANG_EN</span> <span class="o">|</span> <span class="n">BB_HOST_BANG_RW</span> <span class="o">|</span> <span class="n">oval</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsEnable</span><span class="p">,</span> <span class="n">oval2</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">,</span> <span class="n">oval3</span><span class="p">);</span> <span class="cm">/* Set To SW Switch */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="mh">0x3a0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dataRead</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl8225_is_V_z2</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">vz2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x588</span><span class="p">)</span>
		<span class="n">vz2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>	<span class="cm">/* reg 9 pg 1 = 24 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x700</span><span class="p">)</span>
			<span class="n">vz2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sw back to pg 0 */</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vz2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8225z2_rf_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rtl8180_set_anaparam</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RTL8225z2_ANAPARAM_OFF</span><span class="p">);</span>
	<span class="n">rtl8185_set_anaparam2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RTL8225z2_ANAPARAM2_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map dBm into Tx power index according to current HW model, for example,</span>
<span class="cm"> * RF and PA, and current wireless mode.</span>
<span class="cm"> */</span>
<span class="n">s8</span> <span class="nf">DbmToTxPwrIdx</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">WIRELESS_MODE</span> <span class="n">WirelessMode</span><span class="p">,</span>
		 <span class="n">s32</span> <span class="n">PowerInDbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">bUseDefault</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * OFDM Power in dBm = Index * 0.5 + 0</span>
<span class="cm">	 * CCK Power in dBm = Index * 0.25 + 13</span>
<span class="cm">	 */</span>
	<span class="n">s32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WirelessMode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bUseDefault</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">PowerInDbm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="cm">/* 40 means 20 dBm. */</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">WirelessMode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bUseDefault</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">PowerInDbm</span><span class="p">)</span> <span class="o">-</span> <span class="mi">52</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="cm">/* 28 means 20 dBm. */</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TRUE if we want to use a default implementation.</span>
<span class="cm">	 * We shall set it to FALSE when we have exact translation formula</span>
<span class="cm">	 * for target IC. 070622, by rcnjko.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bUseDefault</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PowerInDbm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PowerInDbm</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">TxPwrIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">PowerInDbm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TxPwrIdx</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8225z2_SetTXPowerLevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">max_cck_power_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_ofdm_power_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">min_ofdm_power_level</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cck_power_level</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
	<span class="kt">char</span> <span class="n">ofdm_power_level</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chtxpwr_ofdm</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">IS_DOT11D_STATE_DONE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">MaxTxPwrInDbm</span> <span class="o">=</span> <span class="n">DOT11D_GetMaxTxPwrInDbm</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">CckMaxPwrIdx</span> <span class="o">=</span> <span class="n">DbmToTxPwrIdx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WIRELESS_MODE_B</span><span class="p">,</span>
							<span class="n">MaxTxPwrInDbm</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">OfdmMaxPwrIdx</span> <span class="o">=</span> <span class="n">DbmToTxPwrIdx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WIRELESS_MODE_G</span><span class="p">,</span>
							<span class="n">MaxTxPwrInDbm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cck_power_level</span> <span class="o">&gt;</span> <span class="n">CckMaxPwrIdx</span><span class="p">)</span>
			<span class="n">cck_power_level</span> <span class="o">=</span> <span class="n">CckMaxPwrIdx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_power_level</span> <span class="o">&gt;</span> <span class="n">OfdmMaxPwrIdx</span><span class="p">)</span>
			<span class="n">ofdm_power_level</span> <span class="o">=</span> <span class="n">OfdmMaxPwrIdx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_cck_power_level</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">max_ofdm_power_level</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
	<span class="n">min_ofdm_power_level</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cck_power_level</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span>
		<span class="n">cck_power_level</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CCK_TXAGC</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">ZEBRA2_CCK_OFDM_GAIN_SETTING</span><span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">cck_power_level</span><span class="p">]));</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_power_level</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span>
		<span class="n">ofdm_power_level</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OFDM_TXAGC</span><span class="p">,</span>
		       <span class="n">ZEBRA2_CCK_OFDM_GAIN_SETTING</span><span class="p">[(</span><span class="n">u8</span><span class="p">)</span><span class="n">ofdm_power_level</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_power_level</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_power_level</span> <span class="o">&lt;=</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8225z2_rf_set_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8225z2_SetTXPowerLevel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">rtl8225_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">RF_ReadReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F80</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rtl8225_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">rtl8225_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8225_host_pci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsOutput</span><span class="p">,</span> <span class="mh">0x480</span><span class="p">);</span>

	<span class="n">rtl8185_rf_pins_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFPinsSelect</span><span class="p">,</span> <span class="mh">0x88</span> <span class="o">|</span> <span class="n">SW_CONTROL_GPIO</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GP_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* bit 6 is for RF on/off detection */</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GP_ENABLE</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8225_rf_set_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">gset</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span> <span class="o">&amp;&amp;</span>
		<span class="n">ieee80211_is_54g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">;</span>

	<span class="n">rtl8225_SetTXPowerLevel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">rtl8225_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIFS</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIFS</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIFS</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DIFS</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_shortslot</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">))</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLOT</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLOT</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EIFS</span><span class="p">,</span> <span class="mi">81</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CW_VAL</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EIFS</span><span class="p">,</span> <span class="mi">81</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CW_VAL</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8225z2_rf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">brsr</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">rtl8225_host_pci_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_TIMING</span><span class="p">,</span> <span class="mh">0x000a8008</span><span class="p">);</span>

	<span class="n">brsr</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRSR</span><span class="p">);</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BRSR</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_PARA</span><span class="p">,</span> <span class="mh">0x100044</span><span class="p">);</span>

	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_CONFIG</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">rtl8180_set_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD_NORMAL</span><span class="p">);</span>

	<span class="n">rtl8185_rf_pins_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2bf</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xee0</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x44d</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x441</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x8c3</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0xc72</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">);</span>  <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">rtl8225_chan</span><span class="p">[</span><span class="n">channel</span><span class="p">]);</span>  <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>  <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0x335</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x9d4</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x7bb</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x850</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xcdf</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">);</span>  <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x114</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1b7</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">95</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">rtl8225z2_rxgain</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>

	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">);</span>

	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0xc4d</span><span class="p">);</span>

	<span class="cm">/* FIXME!! rtl8187 we have to check if calibrarion</span>
<span class="cm">	 * is successful and eventually cal. again (repeat</span>
<span class="cm">	 * the two write on reg 2)</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">read_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00000080</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c4d</span><span class="p">);</span>
		<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x044d</span><span class="p">);</span>
		<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">read_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00000080</span><span class="p">))</span>
			<span class="n">DMESGW</span><span class="p">(</span><span class="s">&quot;RF Calibration Failed!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x2bf</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">rtl8225_agc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* enable writing AGC table */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* FIXME maybe not needed */</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rtl8225z2_set_gain</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span> <span class="cm">/* CCK Carrier Sense Threshold */</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rtl8225z2_SetTXPowerLevel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* RX antenna default to A */</span>
	<span class="n">write_phy_cck</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* B: 0xDB */</span>
	<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* B: 0x10 */</span>

	<span class="n">rtl8185_tx_antenna</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>				<span class="cm">/* B: 0x00 */</span>

	<span class="cm">/* switch to high-speed 3-wire</span>
<span class="cm">	 * last digit. 2 for both cck and ofdm</span>
<span class="cm">	 */</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x15c00002</span><span class="p">);</span>
	<span class="n">rtl8185_rf_pins_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8225_rf_set_chan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8225z2_rf_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x1865</span><span class="p">);</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_PARA</span><span class="p">,</span> <span class="mh">0x10084</span><span class="p">);</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_TIMING</span><span class="p">,</span> <span class="mh">0xa8008</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>

		<span class="n">rtl8225z2_set_gain</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_rtl8225</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x1864</span><span class="p">);</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_PARA</span><span class="p">,</span> <span class="mh">0x10044</span><span class="p">);</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RF_TIMING</span><span class="p">,</span> <span class="mh">0xa8008</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>

		<span class="n">rtl8225z2_set_gain</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x04000002</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define MAX_DOZE_WAITING_TIMES_85B		20</span>
<span class="cp">#define MAX_POLLING_24F_TIMES_87SE		10</span>
<span class="cp">#define LPS_MAX_SLEEP_WAITING_TIMES_87SE	5</span>

<span class="n">bool</span> <span class="nf">SetZebraRFPowerState8185</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">RT_RF_POWER_STATE</span> <span class="n">eRFPowerState</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8180_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>			<span class="n">btCR9346</span><span class="p">,</span> <span class="n">btConfig3</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="n">bTurnOffBB</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">u1bTmp</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">bResult</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">QueueID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SetRFPowerStateInProgress</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SetRFPowerStateInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">btCR9346</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">,</span> <span class="p">(</span><span class="n">btCR9346</span> <span class="o">|</span> <span class="mh">0xC0</span><span class="p">));</span>

	<span class="n">btConfig3</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="p">(</span><span class="n">btConfig3</span> <span class="o">|</span> <span class="n">CONFIG3_PARM_En</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">eRFPowerState</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eRfOn</span>:
		<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x37C</span><span class="p">,</span> <span class="mh">0x00EC</span><span class="p">);</span>

		<span class="cm">/* turn on AFE */</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* turn on RF */</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0972</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="cm">/* turn on RF again */</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0972</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="cm">/* turn on BB */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

		<span class="cm">/* Avoid power down at init time. */</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG4</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFProgType</span><span class="p">);</span>

		<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">BIT5</span> <span class="o">|</span> <span class="n">BIT6</span><span class="p">))));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eRfSleep</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">QueueID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">QueueID</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_curr_tx_free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">QueueID</span><span class="p">)</span> <span class="o">==</span>
							<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">QueueID</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPollingTimes</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPollingTimes</span> <span class="o">&gt;=</span>
					<span class="n">LPS_MAX_SLEEP_WAITING_TIMES_87SE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bActionAllowed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* turn off BB RXIQ matrix to cut off rx signal */</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

			<span class="cm">/* turn off RF */</span>
			<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

			<span class="cm">/* turn off AFE except PLL */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">);</span>

			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u8</span> <span class="n">tmp24F</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24f</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">tmp24F</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span>
							<span class="p">(</span><span class="n">tmp24F</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">bTurnOffBB</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
						<span class="n">i</span><span class="o">++</span><span class="p">;</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPollingTimes</span><span class="o">++</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPollingTimes</span> <span class="o">&gt;=</span> <span class="n">LPS_MAX_SLEEP_WAITING_TIMES_87SE</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">bTurnOffBB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bTurnOffBB</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* turn off BB */</span>
				<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">);</span>
				<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u1bTmp</span> <span class="o">|</span> <span class="n">BIT5</span> <span class="o">|</span> <span class="n">BIT6</span><span class="p">));</span>

				<span class="cm">/* turn off AFE PLL */</span>
				<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">);</span>
				<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x37C</span><span class="p">,</span> <span class="mh">0x00FC</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eRfOff</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">QueueID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">QueueID</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_curr_tx_free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">QueueID</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">QueueID</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_DOZE_WAITING_TIMES_85B</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* turn off BB RXIQ matrix to cut off rx signal */</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">write_phy_ofdm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="cm">/* turn off RF */</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">RF_WriteReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

		<span class="cm">/* turn off AFE except PLL */</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">);</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">tmp24F</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24f</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">tmp24F</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp24F</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">bTurnOffBB</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">bTurnOffBB</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_POLLING_24F_TIMES_87SE</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bTurnOffBB</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* turn off BB */</span>
			<span class="n">u1bTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">);</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x24E</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bTmp</span> <span class="o">|</span> <span class="n">BIT5</span> <span class="o">|</span> <span class="n">BIT6</span><span class="p">));</span>

			<span class="cm">/* turn off AFE PLL (80M) */</span>
			<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">);</span>
			<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x37C</span><span class="p">,</span> <span class="mh">0x00FC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">btConfig3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CONFIG3_PARM_En</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CONFIG3</span><span class="p">,</span> <span class="n">btConfig3</span><span class="p">);</span>

	<span class="n">btCR9346</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xC0</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CR9346</span><span class="p">,</span> <span class="n">btCR9346</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bResult</span> <span class="o">&amp;&amp;</span> <span class="n">bActionAllowed</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">=</span> <span class="n">eRFPowerState</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SetRFPowerStateInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bResult</span> <span class="o">&amp;&amp;</span> <span class="n">bActionAllowed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8225z4_rf_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eRfSleep</span><span class="p">,</span> <span class="n">RF_CHANGE_BY_PS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8225z4_rf_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eRfOn</span><span class="p">,</span> <span class="n">RF_CHANGE_BY_PS</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
