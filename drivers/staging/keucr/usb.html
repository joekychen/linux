<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › keucr › usb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>usb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>

<span class="cp">#include &quot;usb.h&quot;</span>
<span class="cp">#include &quot;scsiglue.h&quot;</span>
<span class="cp">#include &quot;smil.h&quot;</span>
<span class="cp">#include &quot;transport.h&quot;</span>

<span class="cm">/* Some informational data */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Domao&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ENE USB Mass Storage driver for Linux&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">eucr_usb_ids</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x058f</span><span class="p">,</span> <span class="mh">0x6366</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf2</span><span class="p">,</span> <span class="mh">0x6230</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf2</span><span class="p">,</span> <span class="mh">0x6250</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>                                            <span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span> <span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">eucr_usb_ids</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eucr_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;--- eucr_suspend ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Wait until no command is running */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>US_DEBUGP("%s\n", <strong>func</strong>);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">suspend_resume_hook</span><span class="p">)</span>
		<span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">suspend_resume_hook</span><span class="p">)(</span><span class="n">us</span><span class="p">,</span> <span class="n">US_SUSPEND</span><span class="p">);</span>

	<span class="cm">/* When runtime PM is working, we&#39;ll set a flag to indicate</span>
<span class="cm">	 * whether we should autoresume when a SCSI request arrives. */</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>us->Power<em>IsResum = true;
us->SD</em>Status.Ready = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>EXPORT<em>SYMBOL</em>GPL(eucr_suspend);</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">eucr_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BYTE</span>    <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;--- eucr_resume---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>US_DEBUGP("%s\n", <strong>func</strong>);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">suspend_resume_hook</span><span class="p">)</span>
		<span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">suspend_resume_hook</span><span class="p">)(</span><span class="n">us</span><span class="p">,</span> <span class="n">US_RESUME</span><span class="p">);</span>


	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>

	
         <span class="n">us</span><span class="o">-&gt;</span><span class="n">Power_IsResum</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>us->SD_Status.Ready = 0; //??</p></td><td class="code"><div class="highlight"><pre>    	<span class="n">us</span><span class="o">-&gt;</span><span class="n">SM_Status</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PSM_STATUS</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">;</span>
    	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>EXPORT<em>SYMBOL</em>GPL(eucr_resume);</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">eucr_reset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BYTE</span>    <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;--- eucr_reset_resume---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>US_DEBUGP("%s\n", <strong>func</strong>);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Report the reset to the SCSI core */</span>
	<span class="n">usb_stor_report_bus_reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="cm">/* FIXME: Notify the subdrivers that they need to reinitialize</span>
<span class="cm">	 * the device */</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>ENE_InitMedia(us);</p></td><td class="code"><div class="highlight"><pre> 	<span class="n">us</span><span class="o">-&gt;</span><span class="n">Power_IsResum</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>us->SD_Status.Ready = 0; //??</p></td><td class="code"><div class="highlight"><pre>    	<span class="n">us</span><span class="o">-&gt;</span><span class="n">SM_Status</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PSM_STATUS</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>EXPORT<em>SYMBOL</em>GPL(usb<em>stor</em>reset_resume);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#else</span>

<span class="cp">#define eucr_suspend		NULL</span>
<span class="cp">#define eucr_resume		NULL</span>
<span class="cp">#define eucr_reset_resume	NULL</span>

<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>----- eucr<em>pre</em>reset() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">eucr_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- eucr_pre_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Make sure no command runs during the reset */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>----- eucr<em>post</em>reset() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">eucr_post_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- eucr_post_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Report the reset to the SCSI core */</span>
	<span class="n">usb_stor_report_bus_reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>----- fill<em>inquiry</em>response() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">fill_inquiry_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- fill_inquiry_response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span><span class="o">&lt;</span><span class="mi">36</span><span class="p">)</span> <span class="c1">// You lose.</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x20</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">28</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">u16</span> <span class="n">bcdDevice</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bcdDevice</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">unusual_dev</span><span class="o">-&gt;</span><span class="n">vendorName</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">unusual_dev</span><span class="o">-&gt;</span><span class="n">vendorName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">unusual_dev</span><span class="o">-&gt;</span><span class="n">vendorName</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">unusual_dev</span><span class="o">-&gt;</span><span class="n">productName</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">unusual_dev</span><span class="o">-&gt;</span><span class="n">productName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">unusual_dev</span><span class="o">-&gt;</span><span class="n">productName</span><span class="p">));</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="p">((</span><span class="n">bcdDevice</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="p">((</span><span class="n">bcdDevice</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="p">((</span><span class="n">bcdDevice</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="p">((</span><span class="n">bcdDevice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usb_stor_set_xfer_buf</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">,</span> <span class="n">TO_XFER_BUF</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>----- usb<em>stor</em>control_thread() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">usb_stor_control_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">)</span><span class="n">__us</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">us_to_host</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- usb_stor_control_thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(;;)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cmnd_ready</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="cm">/* lock the device pointers */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">));</span>

		<span class="cm">/* if the device has disconnected, we are free to exit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">US_FLIDX_DISCONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* lock access to the state */</span>
		<span class="n">scsi_lock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="cm">/* When we are called with no command pending, we&#39;re done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">scsi_unlock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>US_DEBUGP("-- exiting\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* has the command timed out *already* ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">US_FLIDX_TIMED_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">SkipForAbort</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scsi_unlock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">fflags</span> <span class="o">&amp;</span> <span class="n">US_FL_SCM_MULT_TARG</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&gt;</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">fflags</span> <span class="o">&amp;</span> <span class="n">US_FL_FIX_INQUIRY</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_ptr</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

			<span class="n">fill_inquiry_response</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="mi">36</span><span class="p">);</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">proto_handler</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* lock access to the state */</span>
		<span class="n">scsi_lock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="cm">/* indicate that the command is done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">!=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
<span class="nl">SkipForAbort:</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;scsi command aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">US_FLIDX_TIMED_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">));</span>

			<span class="cm">/* Allow USB transfers to resume */</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">US_FLIDX_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">US_FLIDX_TIMED_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* finished working on this command */</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">scsi_unlock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="cm">/* unlock the device pointers */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* for (;;) */</span>

	<span class="cm">/* Wait until we are told to stop */</span>
	<span class="k">for</span> <span class="p">(;;)</span>
	<span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>	</pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>----- associate_dev() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">associate_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- associate_dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Fill in the device-related fields */</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="cm">/* Store our private data in the interface */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>

	<span class="cm">/* Allocate the device-related DMA-mapped buffers */</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">cr</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cr_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb_ctrlrequest allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="n">US_IOBUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;I/O buffer allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">us</span><span class="o">-&gt;</span><span class="n">sensebuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">US_SENSE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">sensebuf</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Sense buffer allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>----- get<em>device</em>info() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">get_device_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="o">*</span><span class="n">idesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- get_device_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">us</span><span class="o">-&gt;</span><span class="n">subclass</span> <span class="o">=</span> <span class="n">idesc</span><span class="o">-&gt;</span><span class="n">bInterfaceSubClass</span><span class="p">;</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">idesc</span><span class="o">-&gt;</span><span class="n">bInterfaceProtocol</span><span class="p">;</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">fflags</span> <span class="o">=</span> <span class="n">USB_US_ORIG_FLAGS</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">);</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">Power_IsResum</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">fflags</span> <span class="o">&amp;</span> <span class="n">US_FL_IGNORE_DEVICE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;device ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">fflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">US_FL_GO_SLOW</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>----- get_transport() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">get_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- get_transport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_PR_BULK</span>:
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">transport_name</span> <span class="o">=</span> <span class="s">&quot;Bulk&quot;</span><span class="p">;</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">transport</span> <span class="o">=</span> <span class="n">usb_stor_Bulk_transport</span><span class="p">;</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">transport_reset</span> <span class="o">=</span> <span class="n">usb_stor_Bulk_reset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* pr_info(&quot;Transport: %s\n&quot;, us-&gt;transport_name); */</span>

	<span class="cm">/* fix for single-lun devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">fflags</span> <span class="o">&amp;</span> <span class="n">US_FL_SINGLE_LUN</span><span class="p">)</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>----- get_protocol() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">get_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- get_protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;us-&gt;pusb_dev-&gt;descriptor.idVendor = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;us-&gt;pusb_dev-&gt;descriptor.idProduct = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">subclass</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_SC_SCSI</span>:
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="s">&quot;Transparent SCSI&quot;</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span> <span class="o">==</span> <span class="mh">0x0CF2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">==</span> <span class="mh">0x6250</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">proto_handler</span> <span class="o">=</span> <span class="n">ENE_stor_invoke_transport</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">proto_handler</span> <span class="o">=</span> <span class="n">usb_stor_invoke_transport</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* pr_info(&quot;Protocol: %s\n&quot;, us-&gt;protocol_name); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>----- get_pipes() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">get_pipes</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">altsetting</span> <span class="o">=</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_int</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- get_pipes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_xfer_bulk</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_in</span><span class="p">)</span>
					<span class="n">ep_in</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_out</span><span class="p">)</span>
					<span class="n">ep_out</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_is_int_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_int</span><span class="p">)</span>
				<span class="n">ep_int</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_in</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep_out</span> <span class="o">||</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">USB_PR_CBI</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep_int</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Endpoint sanity check failed! Rejecting dev.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate and store the pipe values */</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">send_ctrl_pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_ctrl_pipe</span> <span class="o">=</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">send_bulk_pipe</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="n">ep_out</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">);</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_bulk_pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="n">ep_in</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep_int</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_intr_pipe</span> <span class="o">=</span> <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="n">ep_int</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">);</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">ep_bInterval</span> <span class="o">=</span> <span class="n">ep_int</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>----- usb<em>stor</em>acquire_resources() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">usb_stor_acquire_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- usb_stor_acquire_resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">current_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">current_urb</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;URB allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start up our control thread */</span>
	<span class="n">th</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">usb_stor_control_thread</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="s">&quot;eucr-storage&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">th</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unable to start control thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">ctl_thread</span> <span class="o">=</span> <span class="n">th</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>----- usb<em>stor</em>release_resources() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_stor_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- usb_stor_release_resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">SM_FreeMem</span><span class="p">();</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cmnd_ready</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">ctl_thread</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">ctl_thread</span><span class="p">);</span>

	<span class="cm">/* Call the destructor routine, if it exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra_destructor</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;-- calling extra_destructor()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra_destructor</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free the extra data and the URB */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">current_urb</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>----- dissociate_dev() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">dissociate_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- dissociate_dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">sensebuf</span><span class="p">);</span>

	<span class="cm">/* Free the device-related DMA-mapped buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">)</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">),</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">cr_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">)</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="n">US_IOBUF_SIZE</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf_dma</span><span class="p">);</span>

	<span class="cm">/* Remove our private data from the interface */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>----- quiesce<em>and</em>remove_host() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">quiesce_and_remove_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">us_to_host</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- quiesce_and_remove_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If the device is really gone, cut short reset delays */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">USB_STATE_NOTATTACHED</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">US_FLIDX_DISCONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>

	<span class="cm">/* Prevent SCSI-scanning (if it hasn&#39;t started yet)</span>
<span class="cm">	 * and wait for the SCSI-scanning thread to stop.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">US_FLIDX_DONT_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">delay_wait</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">scanning_done</span><span class="p">);</span>

	<span class="cm">/* Removing the host will perform an orderly shutdown: caches</span>
<span class="cm">	 * synchronized, disks spun down, etc.</span>
<span class="cm">	 */</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Prevent any new commands from being accepted and cut short</span>
<span class="cm">	 * reset delays.</span>
<span class="cm">	 */</span>
	<span class="n">scsi_lock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">US_FLIDX_DISCONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>
	<span class="n">scsi_unlock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">delay_wait</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>----- release_everything() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">release_everything</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- release_everything</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">usb_stor_release_resources</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="n">dissociate_dev</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">us_to_host</span><span class="p">(</span><span class="n">us</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>----- usb<em>stor</em>scan_thread() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">usb_stor_scan_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">__us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">)</span><span class="n">__us</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- usb_stor_scan_thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;EUCR : device found at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>

	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="cm">/* Wait for the timeout to expire or for a disconnect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay_use</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_event_freezable_timeout</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">delay_wait</span><span class="p">,</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">US_FLIDX_DONT_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">),</span>
				<span class="n">delay_use</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If the device is still connected, perform the scanning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">US_FLIDX_DONT_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="cm">/* For bulk-only devices, determine the max LUN value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">USB_PR_BULK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">fflags</span> <span class="o">&amp;</span> <span class="n">US_FL_SINGLE_LUN</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">usb_stor_Bulk_max_lun</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">us_to_host</span><span class="p">(</span><span class="n">us</span><span class="p">));</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;EUCR : device scan complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">complete_and_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">scanning_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>----- eucr_probe() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">eucr_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">BYTE</span>	<span class="n">MiscReg03</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- eucr_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_stor_host_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">us</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unable to allocate the scsi host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allow 16-byte CDBs and thus &gt; 2TB */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">us</span> <span class="o">=</span> <span class="n">host_to_us</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span><span class="p">));</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">));</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">cmnd_ready</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">));</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">delay_wait</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">scanning_done</span><span class="p">);</span>

	<span class="cm">/* Associate the us_data structure with the USB device */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">associate_dev</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>

	<span class="cm">/* Get Device info */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">get_device_info</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>

	<span class="cm">/* Get the transport, protocol, and pipe settings */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">get_transport</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">get_protocol</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">get_pipes</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>

	<span class="cm">/* Acquire all the other resources and add the host */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_acquire_resources</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unable to add the scsi host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start up the thread for delayed SCSI-device scanning */</span>
	<span class="n">th</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">usb_stor_scan_thread</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="s">&quot;eucr-stor-scan&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">th</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unable to start the device-scanning thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">scanning_done</span><span class="p">);</span>
		<span class="n">quiesce_and_remove_host</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>

	<span class="cm">/* probe card type */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ENE_Read_BYTE</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">REG_CARD_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MiscReg03</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">USB_STOR_XFER_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>
		<span class="n">quiesce_and_remove_host</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">MiscReg03</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">quiesce_and_remove_host</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;keucr: The driver only supports SM/MS card.\</span>
<span class="s">			To use SD card, \</span>
<span class="s">			please build driver/usb/storage/ums-eneub6250.ko</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">BadDevice</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We come here if there are any problems */</span>
<span class="nl">BadDevice:</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- eucr_probe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">release_everything</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>----- eucr_disconnect() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">eucr_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;usb --- eucr_disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">quiesce_and_remove_host</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="n">release_everything</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Initialization and registration</span>
<span class="cm"> ***********************************************************************/</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>----- usb<em>storage</em>driver() ---------------------</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">usb_storage_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;eucr&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>		<span class="n">eucr_probe</span><span class="p">,</span>
    	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	    <span class="n">eucr_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	    <span class="n">eucr_resume</span><span class="p">,</span>
    	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>	<span class="n">eucr_reset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">eucr_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_reset</span> <span class="o">=</span>	<span class="n">eucr_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_reset</span> <span class="o">=</span>	<span class="n">eucr_post_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>		<span class="n">eucr_usb_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">soft_unbind</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">usb_storage_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
