<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › keucr › smilmain.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>smilmain.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;usb.h&quot;</span>
<span class="cp">#include &quot;scsiglue.h&quot;</span>
<span class="cp">#include &quot;smcommon.h&quot;</span>
<span class="cp">#include &quot;smil.h&quot;</span>

<span class="kt">int</span>         <span class="n">Check_D_LogCHS</span>              <span class="p">(</span><span class="n">WORD</span> <span class="o">*</span><span class="p">,</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">,</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span>        <span class="n">Initialize_D_Media</span>          <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span>        <span class="n">PowerOff_D_Media</span>            <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Check_D_MediaPower</span>          <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Check_D_MediaExist</span>          <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Check_D_MediaWP</span>             <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Check_D_MediaFmt</span>            <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Check_D_MediaFmtForEraseAll</span> <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Conv_D_MediaAddr</span>            <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Inc_D_MediaAddr</span>             <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Check_D_FirstSect</span>           <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Check_D_LastSect</span>            <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Media_D_ReadOneSect</span>         <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">WORD</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Media_D_WriteOneSect</span>        <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">WORD</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Media_D_CopyBlockHead</span>       <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Media_D_CopyBlockTail</span>       <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Media_D_EraseOneBlock</span>       <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>         <span class="n">Media_D_EraseAllBlock</span>       <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span>  <span class="n">Copy_D_BlockAll</span>             <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Copy_D_BlockHead</span>            <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Copy_D_BlockTail</span>            <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Reassign_D_BlockHead</span>        <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span>  <span class="n">Assign_D_WriteBlock</span>         <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Release_D_ReadBlock</span>         <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Release_D_WriteBlock</span>        <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Release_D_CopySector</span>        <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span>  <span class="n">Copy_D_PhyOneSect</span>           <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Read_D_PhyOneSect</span>           <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">WORD</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Write_D_PhyOneSect</span>          <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">,</span> <span class="n">WORD</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Erase_D_PhyOneBlock</span>         <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">int</span>  <span class="n">Set_D_PhyFmtValue</span>           <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Search_D_CIS</span>                <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">Make_D_LogTable</span>             <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">Check_D_BlockIsFull</span>         <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span>  <span class="n">MarkFail_D_PhyOneBlock</span>      <span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="p">);</span>

<span class="n">DWORD</span> <span class="n">ErrXDCode</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">ErrCode</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>BYTE  SectBuf[SECTSIZE];</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">BYTE</span>  <span class="n">WorkBuf</span><span class="p">[</span><span class="n">SECTSIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="n">BYTE</span>  <span class="n">Redundant</span><span class="p">[</span><span class="n">REDTSIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="n">BYTE</span>  <span class="n">WorkRedund</span><span class="p">[</span><span class="n">REDTSIZE</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>WORD  Log2Phy[MAX<em>ZONENUM][MAX</em>LOGBLOCK];</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">WORD</span>  <span class="o">*</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">MAX_ZONENUM</span><span class="p">];</span>                 <span class="c1">// 128 x 1000,   Log2Phy[MAX_ZONENUM][MAX_LOGBLOCK];</span>
<span class="k">static</span> <span class="n">BYTE</span>  <span class="n">Assign</span><span class="p">[</span><span class="n">MAX_ZONENUM</span><span class="p">][</span><span class="n">MAX_BLOCKNUM</span><span class="o">/</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="n">WORD</span>  <span class="n">AssignStart</span><span class="p">[</span><span class="n">MAX_ZONENUM</span><span class="p">];</span>
<span class="n">WORD</span>  <span class="n">ReadBlock</span><span class="p">;</span>
<span class="n">WORD</span>  <span class="n">WriteBlock</span><span class="p">;</span>
<span class="n">DWORD</span> <span class="n">MediaChange</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DWORD</span> <span class="n">SectCopyMode</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>BIT Control Macro</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">BYTE</span> <span class="n">BitData</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x80</span> <span class="p">}</span> <span class="p">;</span>
<span class="cp">#define Set_D_Bit(a,b)    (a[(BYTE)((b)/8)]|= BitData[(b)%8])</span>
<span class="cp">#define Clr_D_Bit(a,b)    (a[(BYTE)((b)/8)]&amp;=~BitData[(b)%8])</span>
<span class="cp">#define Chk_D_Bit(a,b)    (a[(BYTE)((b)/8)] &amp; BitData[(b)%8])</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>extern PBYTE    SMHostAddr;</p></td><td class="code"><div class="highlight"><pre><span class="n">BYTE</span>     <span class="n">IsSSFDCCompliance</span><span class="p">;</span>
<span class="n">BYTE</span>     <span class="n">IsXDCompliance</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>//Power Control &amp; Media Exist Check Function
//----- Init<em>D</em>SmartMedia() --------------------------------------------
int Init<em>D</em>SmartMedia(void)
{
   int     i;</p>

<p>EMCR<em>Print("Init</em>D<em>SmartMedia start\n");
   for (i=0; i<MAX</em>ZONENUM; i++)
   {
       if (Log2Phy[i]!=NULL)
       {
           EMCR_Print("ExFreePool Zone = %x, Addr = %x\n", i, Log2Phy[i]);
           ExFreePool(Log2Phy[i]);
           Log2Phy[i] = NULL;
       }
   }</p>

<p>Initialize<em>D</em>Media();
   return(NO_ERROR);
}</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>----- SM_FreeMem() -------------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">SM_FreeMem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SM_FreeMem start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_ZONENUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Free Zone = %x, Addr = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">Log2Phy</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">Log2Phy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span><span class="n">NO_ERROR</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>//----- Pwoff<em>D</em>SmartMedia() -------------------------------------------
int Pwoff<em>D</em>SmartMedia(void)
{
   PowerOff<em>D</em>Media();
   return(NO_ERROR);
}</p>

<p>//----- Check<em>D</em>SmartMedia() -------------------------------------------
int Check<em>D</em>SmartMedia(void)
{
   if (Check<em>D</em>MediaExist())
       return(ErrCode);</p>

<p>return(NO_ERROR);
}</p>

<p>//----- Check<em>D</em>Parameter() --------------------------------------------
int Check<em>D</em>Parameter(PFDO<em>DEVICE</em>EXTENSION fdoExt,WORD *pcyl,BYTE *phead,BYTE *psect)
{
   if (Check<em>D</em>MediaPower())
       return(ErrCode);</p>

<p>if (Check<em>D</em>MediaFmt(fdoExt))
       return(ErrCode);</p>

<p>if (Check<em>D</em>LogCHS(pcyl,phead,psect))
       return(ErrCode);</p>

<p>return(NO_ERROR);
}</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>SmartMedia Read/Write/Erase Function
----- Media<em>D</em>ReadSector() -------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Media_D_ReadSector</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">start</span><span class="p">,</span><span class="n">WORD</span> <span class="n">count</span><span class="p">,</span><span class="n">BYTE</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WORD</span> <span class="n">len</span><span class="p">,</span> <span class="n">bn</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>if (Check<em>D</em>MediaPower())        ; ¦b 6250 don't care
   return(ErrCode);
if (Check<em>D</em>MediaFmt(fdoExt))    ;
   return(ErrCode);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">Conv_D_MediaAddr</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span> <span class="o">-</span> <span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">bn</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bn</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>if (Media<em>D</em>ReadOneSect(fdoExt, SectBuf))
if (Media<em>D</em>ReadOneSect(fdoExt, count, buf))</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">Media_D_ReadOneSect</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_EccReadErr</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span> <span class="o">+=</span> <span class="n">bn</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">bn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">bn</span> <span class="o">*</span> <span class="n">SECTSIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Inc_D_MediaAddr</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">(</span><span class="n">NO_ERROR</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>here
----- Media<em>D</em>CopySector() ------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Media_D_CopySector</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">start</span><span class="p">,</span><span class="n">WORD</span> <span class="n">count</span><span class="p">,</span><span class="n">BYTE</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>DWORD mode;
int i;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">WORD</span> <span class="n">len</span><span class="p">,</span> <span class="n">bn</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* pr_info(&quot;Media_D_CopySector !!!\n&quot;); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Conv_D_MediaAddr</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Assign_D_WriteBlock</span><span class="p">())</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span> <span class="o">-</span> <span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">bn</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="n">bn</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>if (Ssfdc<em>D</em>CopyBlock(fdoExt,count,buf,Redundant))</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_CopyBlock</span><span class="p">(</span><span class="n">us</span><span class="p">,</span><span class="n">bn</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">Redundant</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_WriteFault</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>if (Release<em>D</em>ReadBlock(fdoExt))</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">Release_D_CopySector</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_HwError</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_WriteFault</span><span class="p">;</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">bn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">bn</span> <span class="o">*</span> <span class="n">SECTSIZE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Inc_D_MediaAddr</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span><span class="n">NO_ERROR</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>----- Release<em>D</em>CopySector() ------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Release_D_CopySector</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">]</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">ReadBlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">==</span><span class="n">NO_ASSIGN</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Clr_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">);</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>

	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">int Media_D_WriteSector(PFDO_DEVICE_EXTENSION fdoExt, DWORD start,WORD count,BYTE *buf)</span>
<span class="cm">{</span>
<span class="cm">    int i;</span>
<span class="cm">    WORD len, bn;</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>


<span class="cm">//DIVIDER</span>

<span class="cm">    if (Conv_D_MediaAddr(fdoExt, start))</span>
<span class="cm">        return(ErrCode);</span>


<span class="cm">//DIVIDER</span>
<span class="cm">    if (Check_D_FirstSect())</span>
<span class="cm">    {</span>
<span class="cm">        if (Media_D_CopyBlockHead(fdoExt))</span>
<span class="cm">        {</span>
<span class="cm">            ErrCode = ERR_WriteFault;</span>
<span class="cm">            return(ErrCode);</span>
<span class="cm">        }</span>
<span class="cm">    }</span>

<span class="cm">    while(1)</span>
<span class="cm">    {</span>
<span class="cm">        if (!Check_D_FirstSect())</span>
<span class="cm">        {</span>
<span class="cm">            if (Assign_D_WriteBlock())</span>
<span class="cm">                return(ErrCode);</span>
<span class="cm">        }</span>

<span class="cm">        len = Ssfdc.MaxSectors - Media.Sector;</span>
<span class="cm">        if (count &gt; len)</span>
<span class="cm">           bn = len;</span>
<span class="cm">        else</span>
<span class="cm">           bn = count;</span>

<span class="cm">//DIVIDER</span>


<span class="cm">//DIVIDER</span>
<span class="cm">        if (Media_D_WriteOneSect(fdoExt, bn, buf))</span>
<span class="cm">        {</span>
<span class="cm">            ErrCode = ERR_WriteFault;</span>
<span class="cm">            return(ErrCode);</span>
<span class="cm">        }</span>

<span class="cm">        Media.Sector += bn - 1;</span>

<span class="cm">        if (!Check_D_LastSect())</span>
<span class="cm">        {</span>
<span class="cm">            if (Release_D_ReadBlock(fdoExt))</span>

<span class="cm">            {    if (ErrCode==ERR_HwError)</span>
<span class="cm">                {</span>
<span class="cm">                    ErrCode = ERR_WriteFault;</span>
<span class="cm">                    return(ErrCode);</span>
<span class="cm">                }</span>
<span class="cm">            }</span>
<span class="cm">        }</span>

<span class="cm">        count -= bn;</span>

<span class="cm">        if (count&lt;=0)</span>
<span class="cm">            break;</span>

<span class="cm">        buf += bn * SECTSIZE;</span>


<span class="cm">//DIVIDER</span>

<span class="cm">        if (Inc_D_MediaAddr(fdoExt))</span>
<span class="cm">            return(ErrCode);</span>
<span class="cm">    }</span>

<span class="cm">    if (!Check_D_LastSect())</span>
<span class="cm">        return(NO_ERROR);</span>

<span class="cm">    if (Inc_D_MediaAddr(fdoExt))</span>
<span class="cm">        return(ErrCode);</span>

<span class="cm">    if (Media_D_CopyBlockTail(fdoExt))</span>
<span class="cm">    {</span>
<span class="cm">        ErrCode = ERR_WriteFault;</span>
<span class="cm">        return(ErrCode);</span>
<span class="cm">    }</span>

<span class="cm">    return(NO_ERROR);</span>
<span class="cm">}</span>

<span class="cm">//DIVIDER</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Media_D_OneSectWriteStart(PFDO_DEVICE_EXTENSION fdoExt,DWORD start,BYTE *buf)</span>
<span class="cm">{</span>

<span class="cm">//DIVIDER</span>

<span class="cm">    return(NO_ERROR);</span>
<span class="cm">}</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Media_D_OneSectWriteNext(PFDO_DEVICE_EXTENSION fdoExt, BYTE *buf)</span>
<span class="cm">{</span>

<span class="cm">//DIVIDER</span>

<span class="cm">    return(NO_ERROR);</span>
<span class="cm">}</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Media_D_OneSectWriteFlush(PFDO_DEVICE_EXTENSION fdoExt)</span>
<span class="cm">{</span>
<span class="cm">    if (!Check_D_LastSect())</span>
<span class="cm">        return(NO_ERROR);</span>

<span class="cm">    if (Inc_D_MediaAddr(fdoExt))</span>
<span class="cm">        return(ErrCode);</span>

<span class="cm">    if (Media_D_CopyBlockTail(fdoExt))</span>
<span class="cm">    {</span>
<span class="cm">        ErrCode = ERR_WriteFault;</span>
<span class="cm">        return(ErrCode);</span>
<span class="cm">    }</span>

<span class="cm">    return(NO_ERROR);</span>
<span class="cm">}</span>

<span class="cm">//DIVIDER</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>----- Media<em>D</em>WriteSector() ------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Check_D_MediaFmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Check_D_MediaFmt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>if (Check<em>D</em>MediaPower())
   return(ErrCode);</p>

<p>if (Check<em>D</em>MediaFmt(fdoExt))
   return(ErrCode);</p>

<p>if (Check<em>D</em>MediaWP())
   return(ErrCode);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>ENE<em>Print("Media</em>D_WriteSector --- Sector = %x\n", Media.Sector);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MediaChange</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>

	<span class="n">MediaChange</span>  <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="n">SectCopyMode</span> <span class="o">=</span> <span class="n">COMPLETED</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>for(i=0;i<SECTSIZE;i++)
   SectBuf[i]=*buf++;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">Set_D_PhyFmtValue</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_UnknownMedia</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="p">}</span>
	</pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>if (Media<em>D</em>WriteOneSect(fdoExt, SectBuf))</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">Search_D_CIS</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_IllegalFmt</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="p">}</span>


    <span class="n">MediaChange</span> <span class="o">=</span> <span class="n">SMSUCCESS</span><span class="p">;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>if (--count&lt;=0)
   break;</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Conv_D_MediaAddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">temp</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>//----- Media<em>D</em>EraseBlock() -------------------------------------------
int Media<em>D</em>EraseBlock(PFDO<em>DEVICE</em>EXTENSION fdoExt, DWORD start,WORD count)
{
   if (Check<em>D</em>MediaPower())
       return(ErrCode);</p>

<p>if (Check<em>D</em>MediaFmt(fdoExt))
       return(ErrCode);</p>

<p>if (Check<em>D</em>MediaWP())
       return(ErrCode);</p>

<p>if (Conv<em>D</em>MediaAddr(start))
       return(ErrCode);</p>

<p>while(Check<em>D</em>FirstSect()) {
       if (Inc<em>D</em>MediaAddr(fdoExt))
           return(ErrCode);</p>

<pre><code>   if (--count&lt;=0)
       return(NO_ERROR);
</code></pre>

<p>}</p>

<p>while(1) {
       if (!Check<em>D</em>LastSect())
           if (Media<em>D</em>EraseOneBlock())
               if (ErrCode==ERR<em>HwError)
               {
                   ErrCode = ERR</em>WriteFault;
                   return(ErrCode);
               }</p>

<pre><code>   if (Inc_D_MediaAddr(fdoExt))
       return(ErrCode);

   if (--count&lt;=0)
       return(NO_ERROR);
</code></pre>

<p>}
}</p>

<p>//----- Media<em>D</em>EraseAll() ---------------------------------------------
int Media<em>D</em>EraseAll(PFDO<em>DEVICE</em>EXTENSION fdoExt)
{
   if (Check<em>D</em>MediaPower())
       return(ErrCode);</p>

<p>if (Check<em>D</em>MediaFmtForEraseAll(fdoExt))
       return(ErrCode);</p>

<p>if (Check<em>D</em>MediaWP())
       return(ErrCode);</p>

<p>if (Media<em>D</em>EraseAllBlock())
       return(ErrCode);</p>

<p>return(NO_ERROR);
}</p></td><td class="code"><div class="highlight"><pre>	<span class="n">temp</span>           <span class="o">=</span> <span class="n">addr</span><span class="o">/</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span><span class="p">;</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">Zone</span>     <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">temp</span><span class="o">/</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxLogBlocks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Make_D_LogTable</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_IllegalFmt</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span>   <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span><span class="o">%</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span><span class="p">);</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="p">)</span> <span class="p">(</span><span class="n">temp</span><span class="o">%</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxLogBlocks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxZones</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Clr_D_RedundantData</span><span class="p">(</span><span class="n">Redundant</span><span class="p">);</span>
		<span class="n">Set_D_LogBlockAddr</span><span class="p">(</span><span class="n">Redundant</span><span class="p">);</span>
		<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span> <span class="o">=</span> <span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">];</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_OutOfLBA</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>SmartMedia Write Function for One Sector Write Mode
----- Media<em>D</em>OneSectWriteStart() ------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Inc_D_MediaAddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WORD</span>        <span class="n">LogBlock</span> <span class="o">=</span> <span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>int i;
 SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
 ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p>

<p>//if (Check<em>D</em>MediaPower())
 //    return(ErrCode);
 //if (Check<em>D</em>MediaFmt(fdoExt))
 //    return(ErrCode);
 //if (Check<em>D</em>MediaWP())
 //    return(ErrCode);
 if (Conv<em>D</em>MediaAddr(fdoExt, start))
     return(ErrCode);</p>

<p>if (Check<em>D</em>FirstSect())
     if (Media<em>D</em>CopyBlockHead(fdoExt))
     {
         ErrCode = ERR_WriteFault;
         return(ErrCode);
     }</p>

<p>if (!Check<em>D</em>FirstSect())
     if (Assign<em>D</em>WriteBlock())
         return(ErrCode);</p>

<p>//for(i=0;i<SECTSIZE;i++)
 //    SectBuf[i]=*buf++;</p>

<p>//if (Media<em>D</em>WriteOneSect(fdoExt, SectBuf))
 if (Media<em>D</em>WriteOneSect(fdoExt, buf))
 {
     ErrCode = ERR_WriteFault;
     return(ErrCode);
 }</p>

<p>if (!Check<em>D</em>LastSect())
 {
     if (Release<em>D</em>ReadBlock(fdoExt))
         if (ErrCode==ERR<em>HwError)
         {
             ErrCode = ERR</em>WriteFault;
             return(ErrCode);
         }
 }</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Make_D_LogTable</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_IllegalFmt</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span> <span class="o">=</span> <span class="n">LogBlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxLogBlocks</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Clr_D_RedundantData</span><span class="p">(</span><span class="n">Redundant</span><span class="p">);</span>
		<span class="n">Set_D_LogBlockAddr</span><span class="p">(</span><span class="n">Redundant</span><span class="p">);</span>
		<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">];</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxZones</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Make_D_LogTable</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_IllegalFmt</span><span class="p">;</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">Clr_D_RedundantData</span><span class="p">(</span><span class="n">Redundant</span><span class="p">);</span>
		<span class="n">Set_D_LogBlockAddr</span><span class="p">(</span><span class="n">Redundant</span><span class="p">);</span>
		<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">];</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_OutOfLBA</span><span class="p">;</span>

	<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">int Check_D_FirstSect(void)</span>
<span class="cm">{</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>

<span class="cm">    if (!Media.Sector)</span>
<span class="cm">        return(SMSUCCESS);</span>

<span class="cm">    return(ERROR);</span>
<span class="cm">}</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Check_D_LastSect(void)</span>
<span class="cm">{</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>

<span class="cm">    if (Media.Sector&lt;(Ssfdc.MaxSectors-1))</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    return(SMSUCCESS);</span>
<span class="cm">}</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>----- Media<em>D</em>OneSectWriteNext() -------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Media_D_ReadOneSect</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">count</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">err</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Read_D_PhyOneSect</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_HwError</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_DataStatus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>

<span class="cp">#ifdef RDERR_REASSIGN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">&amp;</span><span class="n">MWP</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_CorReadErr</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span><span class="o">=</span><span class="n">ErrCode</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">retry</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Copy_D_BlockAll</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="p">(</span><span class="n">err</span><span class="o">==</span><span class="n">ERR_EccReadErr</span><span class="p">)</span><span class="o">?</span><span class="n">REQ_FAIL</span><span class="o">:</span><span class="n">REQ_ERASE</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_HwError</span><span class="p">)</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_CorReadErr</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">MediaChange</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_CorReadErr</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">int Media_D_WriteOneSect(PFDO_DEVICE_EXTENSION fdoExt, WORD count, BYTE *buf)</span>
<span class="cm">{</span>
<span class="cm">    DWORD retry;</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>

<span class="cm">    if (!Write_D_PhyOneSect(fdoExt, count, buf))</span>
<span class="cm">        return(SMSUCCESS);</span>
<span class="cm">    if (ErrCode==ERR_HwError)</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    for(retry=1; retry&lt;2; retry++)</span>
<span class="cm">    {</span>
<span class="cm">        if (Reassign_D_BlockHead(fdoExt))</span>
<span class="cm">        {</span>
<span class="cm">            if (ErrCode==ERR_HwError)</span>
<span class="cm">                return(ERROR);</span>
<span class="cm">            continue;</span>
<span class="cm">        }</span>

<span class="cm">        if (!Write_D_PhyOneSect(fdoExt, count, buf))</span>
<span class="cm">            return(SMSUCCESS);</span>
<span class="cm">        if (ErrCode==ERR_HwError)</span>
<span class="cm">            return(ERROR);</span>
<span class="cm">    }</span>

<span class="cm">    if (Release_D_WriteBlock(fdoExt))</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    ErrCode        = ERR_WriteFault;</span>
<span class="cm">    MediaChange = ERROR;</span>
<span class="cm">    return(ERROR);</span>
<span class="cm">}</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Media_D_CopyBlockHead(PFDO_DEVICE_EXTENSION fdoExt)</span>
<span class="cm">{</span>
<span class="cm">    DWORD retry;</span>

<span class="cm">    for(retry=0; retry&lt;2; retry++)</span>
<span class="cm">    {</span>
<span class="cm">        if (!Copy_D_BlockHead(fdoExt))</span>
<span class="cm">            return(SMSUCCESS);</span>
<span class="cm">        if (ErrCode==ERR_HwError)</span>
<span class="cm">            return(ERROR);</span>
<span class="cm">    }</span>

<span class="cm">    MediaChange = ERROR;</span>
<span class="cm">    return(ERROR);</span>
<span class="cm">}</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Media_D_CopyBlockTail(PFDO_DEVICE_EXTENSION fdoExt)</span>
<span class="cm">{</span>
<span class="cm">    DWORD retry;</span>

<span class="cm">    if (!Copy_D_BlockTail(fdoExt))</span>
<span class="cm">        return(SMSUCCESS);</span>
<span class="cm">    if (ErrCode==ERR_HwError)</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    for(retry=1; retry&lt;2; retry++)</span>
<span class="cm">    {</span>
<span class="cm">        if (Reassign_D_BlockHead(fdoExt))</span>
<span class="cm">        {</span>
<span class="cm">            if (ErrCode==ERR_HwError)</span>
<span class="cm">                return(ERROR);</span>
<span class="cm">            continue;</span>
<span class="cm">        }</span>

<span class="cm">        if (!Copy_D_BlockTail(fdoExt))</span>
<span class="cm">            return(SMSUCCESS);</span>
<span class="cm">        if (ErrCode==ERR_HwError)</span>
<span class="cm">            return(ERROR);</span>
<span class="cm">    }</span>

<span class="cm">    if (Release_D_WriteBlock(fdoExt))</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    ErrCode        = ERR_WriteFault;</span>
<span class="cm">    MediaChange = ERROR;</span>
<span class="cm">    return(ERROR);</span>
<span class="cm">}</span>

<span class="cm">//DIVIDER</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>int i;
 SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
 ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p>

<p>if (Inc<em>D</em>MediaAddr(fdoExt))
     return(ErrCode);</p>

<p>if (!Check<em>D</em>FirstSect())
   if (Assign<em>D</em>WriteBlock())
     return(ErrCode);</p>

<p>//for(i=0;i<SECTSIZE;i++)
 //    SectBuf[i]=*buf++;</p>

<p>//if (Media<em>D</em>WriteOneSect(fdoExt, SectBuf))
 if (Media<em>D</em>WriteOneSect(fdoExt, buf))
 {
     ErrCode = ERR_WriteFault;
     return(ErrCode);
 }</p>

<p>if (!Check<em>D</em>LastSect())
 {
     if (Release<em>D</em>ReadBlock(fdoExt))
         if (ErrCode==ERR<em>HwError)
         {
             ErrCode = ERR</em>WriteFault;
             return(ErrCode);
         }
 }</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Copy_D_BlockAll</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BYTE</span> <span class="n">sect</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>----- Media<em>D</em>OneSectWriteFlush() ------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="n">sect</span><span class="o">=</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Assign_D_WriteBlock</span><span class="p">())</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="n">REQ_FAIL</span><span class="p">)</span>
		<span class="n">SectCopyMode</span><span class="o">=</span><span class="n">REQ_FAIL</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Copy_D_PhyOneSect</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_HwError</span><span class="p">)</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Release_D_WriteBlock</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>

			<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_WriteFault</span><span class="p">;</span>
			<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">ReadBlock</span><span class="p">;</span>
			<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="n">sect</span><span class="p">;</span>

			<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Release_D_ReadBlock</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="n">sect</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">int Copy_D_BlockHead(PFDO_DEVICE_EXTENSION fdoExt)</span>
<span class="cm">{</span>
<span class="cm">    BYTE sect;</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>

<span class="cm">    sect=Media.Sector;</span>
<span class="cm">    if (Assign_D_WriteBlock())</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    for(Media.Sector=0; Media.Sector&lt;sect; Media.Sector++)</span>
<span class="cm">    {</span>
<span class="cm">        if (Copy_D_PhyOneSect(fdoExt))</span>
<span class="cm">        {</span>
<span class="cm">            if (ErrCode==ERR_HwError)</span>
<span class="cm">                return(ERROR);</span>
<span class="cm">            if (Release_D_WriteBlock(fdoExt))</span>
<span class="cm">                return(ERROR);</span>

<span class="cm">            ErrCode = ERR_WriteFault;</span>
<span class="cm">            Media.PhyBlock=ReadBlock;</span>
<span class="cm">            Media.Sector=sect;</span>

<span class="cm">            return(ERROR);</span>
<span class="cm">        }</span>
<span class="cm">    }</span>

<span class="cm">    Media.PhyBlock=WriteBlock;</span>
<span class="cm">    Media.Sector=sect;</span>
<span class="cm">    return(SMSUCCESS);</span>
<span class="cm">}</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Copy_D_BlockTail(PFDO_DEVICE_EXTENSION fdoExt)</span>
<span class="cm">{</span>
<span class="cm">    BYTE sect;</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>

<span class="cm">    for(sect=Media.Sector; Media.Sector&lt;Ssfdc.MaxSectors; Media.Sector++)</span>
<span class="cm">    {</span>
<span class="cm">        if (Copy_D_PhyOneSect(fdoExt))</span>
<span class="cm">        {</span>
<span class="cm">            if (ErrCode==ERR_HwError)</span>
<span class="cm">                return(ERROR);</span>

<span class="cm">            Media.PhyBlock=WriteBlock;</span>
<span class="cm">            Media.Sector=sect;</span>

<span class="cm">            return(ERROR);</span>
<span class="cm">        }</span>
<span class="cm">    }</span>

<span class="cm">    if (Release_D_ReadBlock(fdoExt))</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    Media.PhyBlock=WriteBlock;</span>
<span class="cm">    Media.Sector=sect;</span>
<span class="cm">    return(SMSUCCESS);</span>
<span class="cm">}</span>


<span class="cm">//DIVIDER</span>
<span class="cm">int Reassign_D_BlockHead(PFDO_DEVICE_EXTENSION fdoExt)</span>
<span class="cm">{</span>
<span class="cm">    DWORD  mode;</span>
<span class="cm">    WORD   block;</span>
<span class="cm">    BYTE   sect;</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>

<span class="cm">    mode=SectCopyMode;</span>
<span class="cm">    block=ReadBlock;</span>
<span class="cm">    sect=Media.Sector;</span>

<span class="cm">    if (Assign_D_WriteBlock())</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    SectCopyMode=REQ_FAIL;</span>

<span class="cm">    for(Media.Sector=0; Media.Sector&lt;sect; Media.Sector++)</span>
<span class="cm">    {</span>
<span class="cm">        if (Copy_D_PhyOneSect(fdoExt))</span>
<span class="cm">        {</span>
<span class="cm">            if (ErrCode==ERR_HwError)</span>
<span class="cm">                return(ERROR);</span>
<span class="cm">            if (Release_D_WriteBlock(fdoExt))</span>
<span class="cm">                return(ERROR);</span>

<span class="cm">            ErrCode = ERR_WriteFault;</span>
<span class="cm">            SectCopyMode=mode;</span>
<span class="cm">            WriteBlock=ReadBlock;</span>
<span class="cm">            ReadBlock=block;</span>
<span class="cm">            Media.Sector=sect;</span>
<span class="cm">            Media.PhyBlock=WriteBlock;</span>

<span class="cm">            return(ERROR);</span>
<span class="cm">        }</span>
<span class="cm">    }</span>

<span class="cm">    if (Release_D_ReadBlock(fdoExt))</span>
<span class="cm">        return(ERROR);</span>

<span class="cm">    SectCopyMode=mode;</span>
<span class="cm">    ReadBlock=block;</span>
<span class="cm">    Media.Sector=sect;</span>
<span class="cm">    Media.PhyBlock=WriteBlock;</span>
<span class="cm">    return(SMSUCCESS);</span>
<span class="cm">}</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>//LED Tern On/Off Subroutine
//----- SM<em>EnableLED() -----------------------------------------------
void SM</em>EnableLED(PFDO<em>DEVICE</em>EXTENSION fdoExt, BOOLEAN enable)
{
   if (fdoExt->Drive<em>IsSWLED)
   {
       if (enable)
          Led</em>D<em>TernOn();
       else
          Led</em>D_TernOff();
   }
}</p>

<p>//----- Led<em>D</em>TernOn() -------------------------------------------------
void Led<em>D</em>TernOn(void)
{
   if (Check<em>D</em>CardStsChg())
       MediaChange=ERROR;</p>

<p>Cnt<em>D</em>LedOn();
}</p>

<p>//----- Led<em>D</em>TernOff() ------------------------------------------------
void Led<em>D</em>TernOff(void)
{
   if (Check<em>D</em>CardStsChg())
       MediaChange=ERROR;</p>

<p>Cnt<em>D</em>LedOff();
}</p>

<p>//SmartMedia Logical Format Subroutine
//----- Check<em>D</em>LogCHS() -----------------------------------------------
int Check<em>D</em>LogCHS(WORD *c,BYTE *h,BYTE *s)
{
   switch(Ssfdc.Model) {
       case SSFDC1MB:   *c=125; *h= 4; *s= 4; break;
       case SSFDC2MB:   *c=125; *h= 4; *s= 8; break;
       case SSFDC4MB:   *c=250; *h= 4; *s= 8; break;
       case SSFDC8MB:   *c=250; *h= 4; *s=16; break;
       case SSFDC16MB:  *c=500; *h= 4; *s=16; break;
       case SSFDC32MB:  *c=500; *h= 8; *s=16; break;
       case SSFDC64MB:  *c=500; *h= 8; *s=32; break;
       case SSFDC128MB: *c=500; *h=16; *s=32; break;
       default:         *c= 0;  *h= 0; *s= 0; ErrCode = ERR_NoSmartMedia;    return(ERROR);
   }</p>

<p>return(SMSUCCESS);
}</p>

<p>//Power Control &amp; Media Exist Check Subroutine
//----- Initialize<em>D</em>Media() -------------------------------------------
void Initialize<em>D</em>Media(void)
{
   ErrCode      = NO<em>ERROR;
   MediaChange  = ERROR;
   SectCopyMode = COMPLETED;
   Cnt</em>D_Reset();
}</p>

<p>//----- PowerOff<em>D</em>Media() ---------------------------------------------
void PowerOff<em>D</em>Media(void)
{
   Cnt<em>D</em>PowerOff();
}</p>

<p>//----- Check<em>D</em>MediaPower() -------------------------------------------
int Check<em>D</em>MediaPower(void)
{
   //usleep(56<em>1024);
   if (Check_D_CardStsChg())
       MediaChange = ERROR;
   //usleep(56</em>1024);
   if ((!Check<em>D</em>CntPower())&amp;&amp;(!MediaChange))  // ¦³ power &amp; Media ¨S³Q change, «h return success
       return(SMSUCCESS);
   //usleep(56*1024);</p>

<p>if (Check<em>D</em>CardExist())                    // Check if card is not exist, return err
   {
       ErrCode        = ERR<em>NoSmartMedia;
       MediaChange = ERROR;
       return(ERROR);
   }
   //usleep(56*1024);
   if (Cnt</em>D<em>PowerOn())
   {
       ErrCode        = ERR</em>NoSmartMedia;
       MediaChange = ERROR;
       return(ERROR);
   }
   //usleep(56<em>1024);
   Ssfdc_D_Reset(fdoExt);
   //usleep(56</em>1024);
   return(SMSUCCESS);
}</p>

<p>//-----Check<em>D</em>MediaExist() --------------------------------------------
int Check<em>D</em>MediaExist(void)
{
   if (Check<em>D</em>CardStsChg())
       MediaChange = ERROR;</p>

<p>if (!Check<em>D</em>CardExist())
   {
       if (!MediaChange)
           return(SMSUCCESS);</p>

<pre><code>   ErrCode = ERR_ChangedMedia;
   return(ERROR);
</code></pre>

<p>}</p>

<p>ErrCode = ERR_NoSmartMedia;</p>

<p>return(ERROR);
}</p>

<p>//----- Check<em>D</em>MediaWP() ----------------------------------------------
int Check<em>D</em>MediaWP(void)
{
   if (Ssfdc.Attribute &amp;MWP)
   {
       ErrCode = ERR_WrtProtect;
       return(ERROR);
   }</p>

<p>return(SMSUCCESS);
}</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Assign_D_WriteBlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>SmartMedia Physical Format Test Subroutine
----- Check<em>D</em>MediaFmt() ---------------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ReadBlock</span><span class="o">=</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">WriteBlock</span><span class="o">=</span><span class="n">AssignStart</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">];</span> <span class="n">WriteBlock</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxBlocks</span><span class="p">;</span> <span class="n">WriteBlock</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Chk_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">WriteBlock</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Set_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">WriteBlock</span><span class="p">);</span>
			<span class="n">AssignStart</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">=</span><span class="n">WriteBlock</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
			<span class="n">SectCopyMode</span><span class="o">=</span><span class="n">REQ_ERASE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>ULONG i,j, result=FALSE, zone,block;</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">WriteBlock</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">WriteBlock</span><span class="o">&lt;</span><span class="n">AssignStart</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">];</span> <span class="n">WriteBlock</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Chk_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">WriteBlock</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Set_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">WriteBlock</span><span class="p">);</span>
			<span class="n">AssignStart</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">=</span><span class="n">WriteBlock</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
			<span class="n">SectCopyMode</span><span class="o">=</span><span class="n">REQ_ERASE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>usleep(56*1024);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">WriteBlock</span><span class="o">=</span><span class="n">NO_ASSIGN</span><span class="p">;</span>
	<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_WriteFault</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>usleep(56*1024);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>usleep(56*1024);</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Release_D_ReadBlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">mode</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>//----- Check<em>D</em>BlockIsFull() ----------------------------------
void Check<em>D</em>BlockIsFull()
{
   ULONG i, block;</p>

<p>if (IsXDCompliance || IsSSFDCCompliance)
   {
      // If the blocks are full then return write-protect.
      block = Ssfdc.MaxBlocks/8;
      for (Media.Zone=0; Media.Zone<Ssfdc.MaxZones; Media.Zone++)
      {
          if (Log2Phy[Media.Zone]==NULL)
          {
              if (Make<em>D</em>LogTable())
              {
                  ErrCode = ERR_IllegalFmt;
                  return;
              }
          }</p>

<pre><code>      for (i=0; i&lt;block; i++)
      {
          if (Assign[Media.Zone][i] != 0xFF)
             return;
      }
  }
  Ssfdc.Attribute |= WP;
</code></pre>

<p>}
}</p>

<p>//----- Check<em>D</em>MediaFmtForEraseAll() ----------------------------------
int Check<em>D</em>MediaFmtForEraseAll(PFDO<em>DEVICE</em>EXTENSION fdoExt)
{
   MediaChange  = ERROR;
   SectCopyMode = COMPLETED;</p>

<p>if (Set<em>D</em>PhyFmtValue(fdoExt))
   {
       ErrCode = ERR_UnknownMedia;
       return(ERROR);
   }</p>

<p>if (Search<em>D</em>CIS(fdoExt))
   {
       ErrCode = ERR_IllegalFmt;
       return(ERROR);
   }</p>

<p>return(SMSUCCESS);
}</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mode</span><span class="o">=</span><span class="n">SectCopyMode</span><span class="p">;</span>
	<span class="n">SectCopyMode</span><span class="o">=</span><span class="n">COMPLETED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="n">COMPLETED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>

	<span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">]</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">ReadBlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">==</span><span class="n">NO_ASSIGN</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="n">REQ_ERASE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Erase_D_PhyOneBlock</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ErrCode</span><span class="o">==</span><span class="n">ERR_HwError</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MarkFail_D_PhyOneBlock</span><span class="p">(</span><span class="n">us</span><span class="p">))</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">Clr_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MarkFail_D_PhyOneBlock</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>SmartMedia Physical Address Control Subroutine
----- Conv<em>D</em>MediaAddr() ---------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Release_D_WriteBlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>ULONG  zz;
SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">SectCopyMode</span><span class="o">=</span><span class="n">COMPLETED</span><span class="p">;</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MarkFail_D_PhyOneBlock</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">ReadBlock</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>----- Inc<em>D</em>MediaAddr() ----------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Copy_D_PhyOneSect</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>           <span class="n">i</span><span class="p">;</span>
	<span class="n">DWORD</span>  <span class="n">err</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* pr_info(&quot;Copy_D_PhyOneSect --- Secotr = %x\n&quot;, Media.Sector); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ReadBlock</span><span class="o">!=</span><span class="n">NO_ASSIGN</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">ReadBlock</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">retry</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadCisSect</span><span class="p">(</span><span class="n">us</span><span class="p">,</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">WorkRedund</span><span class="p">))</span>
				<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">Check_D_CISdata</span><span class="p">(</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">WorkRedund</span><span class="p">))</span>
				<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadSect</span><span class="p">(</span><span class="n">us</span><span class="p">,</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">WorkRedund</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Check_D_DataStatus</span><span class="p">(</span><span class="n">WorkRedund</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">err</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Check_D_ReadError</span><span class="p">(</span><span class="n">WorkRedund</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">err</span><span class="o">=</span><span class="n">SMSUCCESS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Check_D_Correct</span><span class="p">(</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">WorkRedund</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">err</span><span class="o">=</span><span class="n">SMSUCCESS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>

			<span class="n">err</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span>
			<span class="n">SectCopyMode</span><span class="o">=</span><span class="n">REQ_FAIL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">err</span><span class="o">=</span><span class="n">SMSUCCESS</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">SECTSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">WorkBuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">DUMMY_DATA</span><span class="p">;</span>
		<span class="n">Clr_D_RedundantData</span><span class="p">(</span><span class="n">WorkRedund</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Set_D_LogBlockAddr</span><span class="p">(</span><span class="n">WorkRedund</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="o">==</span><span class="n">ERROR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Set_D_RightECC</span><span class="p">(</span><span class="n">WorkRedund</span><span class="p">);</span>
		<span class="n">Set_D_DataStaus</span><span class="p">(</span><span class="n">WorkRedund</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">WriteBlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_WriteSectForCopy</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">WorkBuf</span><span class="p">,</span> <span class="n">WorkRedund</span><span class="p">))</span>
	<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_CheckStatus</span><span class="p">())</span>
	<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_WriteFault</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">ReadBlock</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>----- Check<em>D</em>FirstSect() --------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Read_D_PhyOneSect</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">count</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>           <span class="n">i</span><span class="p">;</span>
	<span class="n">DWORD</span>  <span class="n">retry</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>----- Check<em>D</em>LastSect() ---------------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">==</span><span class="n">NO_ASSIGN</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">SECTSIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++=</span><span class="n">DUMMY_DATA</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">retry</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadCisSect</span><span class="p">(</span><span class="n">us</span><span class="p">,</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">WorkRedund</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Check_D_CISdata</span><span class="p">(</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">WorkRedund</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>SmartMedia Read/Write Subroutine with Retry
----- Media<em>D</em>ReadOneSect() ------------------------------------------</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadBlock</span><span class="p">(</span><span class="n">us</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">Redundant</span><span class="p">))</span>
		<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Check_D_DataStatus</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
		<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_DataStatus</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Check_D_ReadError</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
			<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Check_D_Correct</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">Redundant</span><span class="p">))</span>
		<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_CorReadErr</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_EccReadErr</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">int Write_D_PhyOneSect(PFDO_DEVICE_EXTENSION fdoExt, WORD count, BYTE *buf)</span>
<span class="cm">{</span>
<span class="cm">    SSFDCTYPE_T aa = (SSFDCTYPE_T ) &amp;Ssfdc;</span>
<span class="cm">    ADDRESS_T   bb = (ADDRESS_T) &amp;Media;</span>


<span class="cm">//DIVIDER</span>
<span class="cm">    if (Ssfdc_D_WriteBlock(fdoExt,count,buf,Redundant))</span>
<span class="cm">    { ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }</span>
<span class="cm">    if (Ssfdc_D_CheckStatus())</span>
<span class="cm">    { ErrCode = ERR_WriteFault; return(ERROR); }</span>

<span class="cm">    return(SMSUCCESS);</span>
<span class="cm">}</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>----- Media<em>D</em>WriteOneSect() -----------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Erase_D_PhyOneBlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>SmartMedia Data Copy Subroutine with Retry
----- Media<em>D</em>CopyBlockHead() ----------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_EraseBlock</span><span class="p">(</span><span class="n">us</span><span class="p">))</span>
	<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span> <span class="n">MediaChange</span><span class="o">=</span><span class="n">ERROR</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_CheckStatus</span><span class="p">())</span>
	<span class="p">{</span> <span class="n">ErrCode</span> <span class="o">=</span> <span class="n">ERR_WriteFault</span><span class="p">;</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>

	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>----- Media<em>D</em>CopyBlockTail() ----------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Set_D_PhyFmtValue</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>//----- Media<em>D</em>EraseOneBlock() ----------------------------------------
int Media<em>D</em>EraseOneBlock(void)
{
   WORD        LogBlock = Media.LogBlock;
   WORD        PhyBlock = Media.PhyBlock;
   SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
   ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p>

<p>if (Media.PhyBlock==NO_ASSIGN)
       return(SMSUCCESS);</p>

<p>if (Log2Phy[Media.Zone]==NULL)
   {
       if (Make<em>D</em>LogTable())
       {
           ErrCode = ERR_IllegalFmt;
           return(ERROR);
       }
   }
   Media.LogBlock = LogBlock;
   Media.PhyBlock = PhyBlock;</p>

<p>Log2Phy[Media.Zone][Media.LogBlock]=NO_ASSIGN;</p>

<p>if (Erase<em>D</em>PhyOneBlock(fdoExt))
   {
       if (ErrCode==ERR<em>HwError)
           return(ERROR);
       if (MarkFail</em>D_PhyOneBlock())
           return(ERROR);</p>

<pre><code>   ErrCode = ERR_WriteFault;
   return(ERROR);
</code></pre>

<p>}</p>

<p>Clr<em>D</em>Bit(Assign[Media.Zone],Media.PhyBlock);
   Media.PhyBlock=NO_ASSIGN;
   return(SMSUCCESS);
}</p>

<p>//SmartMedia Erase Subroutine
//----- Media<em>D</em>EraseAllBlock() ----------------------------------------
int Media<em>D</em>EraseAllBlock(void)
{
   WORD cis=0;</p>

<p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
   ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p>

<p>MediaChange = ERROR;
   Media.Sector   = 0;</p>

<p>for(Media.Zone=0; Media.Zone<Ssfdc.MaxZones; Media.Zone++)
       for(Media.PhyBlock=0; Media.PhyBlock<Ssfdc.MaxBlocks; Media.PhyBlock++) {
           if (Ssfdc<em>D</em>ReadRedtData(Redundant))
           {
               Ssfdc<em>D</em>Reset(fdoExt);
               return(ERROR);
           }</p>

<pre><code>       Ssfdc_D_Reset(fdoExt);
       if (!Check_D_FailBlock(Redundant))
       {
           if (cis)
           {
               if (Ssfdc_D_EraseBlock(fdoExt))
               {
                   ErrCode = ERR_HwError;
                   return(ERROR);
               }

               if (Ssfdc_D_CheckStatus())
               {
                   if (MarkFail_D_PhyOneBlock())
                       return(ERROR);
               }

               continue;
           }

           if (Media.PhyBlock!=CisArea.PhyBlock)
           {
               ErrCode = ERR_IllegalFmt;
               return(ERROR);
           }

           cis++;
       }

   }
</code></pre>

<p>return(SMSUCCESS);
}</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">Set_D_SsfdcModel</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">SM_DeviceID</span><span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>SmartMedia Physical Sector Data Copy Subroutine
----- Copy<em>D</em>BlockAll() ----------------------------------------------</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Search_D_CIS</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>----- Copy<em>D</em>BlockHead() ---------------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxBlocks</span><span class="o">-</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxLogBlocks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadRedtData</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">Redundant</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Check_D_FailBlock</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">==</span><span class="p">(</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxBlocks</span><span class="o">-</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxLogBlocks</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">&lt;</span><span class="n">CIS_SEARCH_SECT</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadRedtData</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">Redundant</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Check_D_DataStatus</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadSect</span><span class="p">(</span><span class="n">us</span><span class="p">,</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">Redundant</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Check_D_CISdata</span><span class="p">(</span><span class="n">WorkBuf</span><span class="p">,</span><span class="n">Redundant</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
				<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">CisArea</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">;</span>
			<span class="n">CisArea</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="p">;</span>
			<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
			<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>----- Copy<em>D</em>BlockTail() ---------------------------------------------</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">Make_D_LogTable</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WORD</span>  <span class="n">phyblock</span><span class="p">,</span><span class="n">logblock</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>----- Reassign<em>D</em>BlockHead() -----------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_LOGBLOCK</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">WORD</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="cm">/* pr_info(&quot;ExAllocatePool Zone = %x, Addr = %x\n&quot;,</span>
<span class="cm">				Media.Zone, Log2Phy[Media.Zone]); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>SmartMedia Physical Block Assign/Release Subroutine
----- Assign<em>D</em>WriteBlock() ------------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="p">{</span>
		<span class="cm">/* pr_info(&quot;Make_D_LogTable --- MediaZone = 0x%x\n&quot;,</span>
<span class="cm">							Media.Zone); */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxLogBlocks</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">++</span><span class="p">)</span>
			<span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">]</span><span class="o">=</span><span class="n">NO_ASSIGN</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">&lt;</span><span class="p">(</span><span class="n">MAX_BLOCKNUM</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span> <span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">++</span><span class="p">)</span>
			<span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">]</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxBlocks</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">&lt;=</span><span class="n">CisArea</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">Set_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadRedtData</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">Redundant</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Check_D_DataBlank</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">Set_D_Bit</span><span class="p">(</span><span class="n">Assign</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">],</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Check_D_FailBlock</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">Load_D_LogBlockAddr</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">&gt;=</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxLogBlocks</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">]</span><span class="o">==</span><span class="n">NO_ASSIGN</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">]</span><span class="o">=</span><span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">phyblock</span>     <span class="o">=</span> <span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="p">;</span>
			<span class="n">logblock</span>     <span class="o">=</span> <span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="p">;</span>
			<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadRedtData</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">Redundant</span><span class="p">))</span>
			<span class="p">{</span> <span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Load_D_LogBlockAddr</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">==</span><span class="n">logblock</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">logblock</span><span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_ReadRedtData</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">Redundant</span><span class="p">))</span>
					<span class="p">{</span> <span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span> <span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span> <span class="p">}</span>

					<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">phyblock</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Load_D_LogBlockAddr</span><span class="p">(</span><span class="n">Redundant</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">LogBlock</span><span class="o">!=</span><span class="n">logblock</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">logblock</span><span class="p">];</span>
							<span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">logblock</span><span class="p">]</span><span class="o">=</span><span class="n">phyblock</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">logblock</span><span class="p">];</span>
						<span class="n">Log2Phy</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">][</span><span class="n">logblock</span><span class="p">]</span><span class="o">=</span><span class="n">phyblock</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>ErrXDCode = NO_ERROR;</p></td><td class="code"><div class="highlight"><pre>			<span class="n">Media</span><span class="p">.</span><span class="n">PhyBlock</span><span class="o">=</span><span class="n">phyblock</span><span class="p">;</span>

		<span class="p">}</span> <span class="c1">// End for (Media.PhyBlock&lt;Ssfdc.MaxBlocks)</span>

		<span class="n">AssignStart</span><span class="p">[</span><span class="n">Media</span><span class="p">.</span><span class="n">Zone</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="c1">// End for (Media.Zone&lt;MAX_ZONENUM)</span>

	<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>ErrXDCode = NO_ERROR;</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">MarkFail_D_PhyOneBlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BYTE</span> <span class="n">sect</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>For xD test
Ssfdc.Attribute |= WP;
ErrXDCode = ERR_WrtProtect;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">sect</span><span class="o">=</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="p">;</span>
	<span class="n">Set_D_FailBlock</span><span class="p">(</span><span class="n">WorkRedund</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>----- Release<em>D</em>ReadBlock() ------------------------------------------</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span><span class="p">(</span><span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">&lt;</span><span class="n">Ssfdc</span><span class="p">.</span><span class="n">MaxSectors</span><span class="p">;</span> <span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Ssfdc_D_WriteRedtData</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">WorkRedund</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
			<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span>   <span class="o">=</span> <span class="n">sect</span><span class="p">;</span>
			<span class="n">ErrCode</span>        <span class="o">=</span> <span class="n">ERR_HwError</span><span class="p">;</span>
			<span class="n">MediaChange</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="p">}</span> <span class="c1">// NO Status Check</span>
	<span class="p">}</span>

	<span class="n">Ssfdc_D_Reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="n">Media</span><span class="p">.</span><span class="n">Sector</span><span class="o">=</span><span class="n">sect</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">SMSUCCESS</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">/*</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>----- Release<em>D</em>WriteBlock() -----------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>SmartMedia Physical Sector Data Copy Subroutine
----- Copy<em>D</em>PhyOneSect() --------------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>SmartMedia Physical Sector Read/Write/Erase Subroutine
----- Read<em>D</em>PhyOneSect() --------------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>if (Ssfdc<em>D</em>ReadSect(fdoExt,buf,Redundant))</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>----- Write<em>D</em>PhyOneSect() -------------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>if (Ssfdc<em>D</em>WriteSect(fdoExt,buf,Redundant))</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>----- Erase<em>D</em>PhyOneBlock() ------------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>SmartMedia Physical Format Check Local Subroutine
----- Set<em>D</em>PhyFmtValue() --------------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>PPDO<em>DEVICE</em>EXTENSION   pdoExt;
   BYTE      idcode[4];
   DWORD     UserDefData<em>1, UserDefData</em>2, Data, mask;</p>

<p>//if (!fdoExt->ChildDeviceObject)       return(ERROR);
   //pdoExt = fdoExt->ChildDeviceObject->DeviceExtension;</p>

<p>Ssfdc<em>D</em>ReadID(idcode, READ<em>ID</em>1);</p>

<p>if (Set<em>D</em>SsfdcModel(idcode[1]))</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>//Use Multi-function pin to differentiate SM and xD.
   UserDefData<em>1 = ReadPCIReg(fdoExt->BusID, fdoExt->DevID, fdoExt->FuncID, PCI</em>REG<em>USER</em>DEF) &amp; 0x80;
   if (UserDefData<em>1)
   {
      if ( READ</em>PORT<em>BYTE(SM</em>REG<em>INT</em>STATUS) &amp; 0x80 )      fdoExt->DiskType = DISKTYPE<em>XD;
      if ( READ</em>PORT<em>BYTE(SM</em>REG<em>INT</em>STATUS) &amp; 0x40 )      fdoExt->DiskType = DISKTYPE_SM;</p>

<pre><code>  if ( IsXDCompliance &amp;&amp; (fdoExt-&gt;DiskType == DISKTYPE_XD) )
  {
     Ssfdc_D_ReadID(idcode, READ_ID_3);
     if (idcode[2] != 0xB5)
        return(ERROR);
  }
</code></pre>

<p>}</p>

<p>//Use GPIO to differentiate SM and xD.
   UserDefData<em>2 = ReadPCIReg(fdoExt->BusID, fdoExt->DevID, fdoExt->FuncID, PCI</em>REG<em>USER</em>DEF) >> 8;
   if ( UserDefData_2 )
   {
      Data = ReadPCIReg(fdoExt->BusID, fdoExt->DevID, 0, 0xAC);</p>

<pre><code>  mask = 1 &lt;&lt; (UserDefData_2-1);
  // 1 : xD , 0 : SM
  if ( Data &amp; mask)
     fdoExt-&gt;DiskType = DISKTYPE_XD;
  else
     fdoExt-&gt;DiskType = DISKTYPE_SM;

  if ( IsXDCompliance &amp;&amp; (fdoExt-&gt;DiskType == DISKTYPE_XD) )
  {
     Ssfdc_D_ReadID(idcode, READ_ID_3);
     if (idcode[2] != 0xB5)
        return(ERROR);
  }
</code></pre>

<p>}</p>

<p>if ( !(UserDefData<em>1 | UserDefData</em>2) )
   {
     // Use UserDefine Register to differentiate SM and xD.
     Ssfdc<em>D</em>ReadID(idcode, READ<em>ID</em>3);</p>

<pre><code> if (idcode[2] == 0xB5)
    fdoExt-&gt;DiskType = DISKTYPE_XD;
 else
 {
     if (!IsXDCompliance)
        fdoExt-&gt;DiskType = DISKTYPE_SM;
     else
        return(ERROR);
 }

 if (fdoExt-&gt;UserDef_DiskType == 0x04)  fdoExt-&gt;DiskType = DISKTYPE_XD;
 if (fdoExt-&gt;UserDef_DiskType == 0x08)  fdoExt-&gt;DiskType = DISKTYPE_SM;
</code></pre>

<p>}</p>

<p>if (!fdoExt->UserDef<em>DisableWP)
   {
      if (fdoExt->DiskType == DISKTYPE</em>SM)
      {
          if (Check<em>D</em>SsfdcWP())
             Ssfdc.Attribute|=WP;
      }
   }</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>----- Search<em>D</em>CIS() -------------------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>----- Make<em>D</em>LogTable() ----------------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>for(Media.Zone=0; Media.Zone<MAX_ZONENUM; Media.Zone++)
for(Media.Zone=0; Media.Zone<Ssfdc.MaxZones; Media.Zone++)</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>if (Check<em>D</em>DataStatus(Redundant))
   continue;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>here Not yet</p>

<h1>ifdef L2P<em>ERR</em>ERASE</h1>

<pre><code>    if (!(Ssfdc.Attribute &amp;MWP))
    {
        Ssfdc_D_Reset(fdoExt);
        if (Ssfdc_D_EraseBlock(fdoExt))
            return(ERROR);

        if (Ssfdc_D_CheckStatus())
        {
            if (MarkFail_D_PhyOneBlock())
                return(ERROR);
        }
        else
            Clr_D_Bit(Assign[Media.Zone],Media.PhyBlock);
    }
</code></pre>

<h1>else</h1>

<pre><code>    Ssfdc.Attribute|=MWP;
</code></pre>

<h1>endif</h1></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>----- MarkFail<em>D</em>PhyOneBlock() ---------------------------------------</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>SSFDCTYPE<em>T aa = (SSFDCTYPE</em>T ) &Ssfdc;
ADDRESS<em>T   bb = (ADDRESS</em>T) &Media;</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>Ssfdc<em>D</em>WriteRedtMode();</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>//----- SM<em>Init() ----------------------------------------------------
void SM</em>Init(void)
{
   <em>Hw</em>D<em>ClrIntCardChg();
   _Hw</em>D<em>SetIntMask();
   // For DMA Interrupt
   _Hw</em>D<em>ClrDMAIntCardChg();
   _Hw</em>D_SetDMAIntMask();
}</p>

<p>//----- Media<em>D</em>EraseAllRedtData() -----------------------------------
int Media<em>D</em>EraseAllRedtData(DWORD Index, BOOLEAN CheckBlock)
{
   BYTE    i;</p>

<p>if (Check<em>D</em>MediaPower())
       return(ErrCode);</p>

<p>if (Check<em>D</em>MediaWP())
       return(ErrCode);</p>

<p>for (i=0; i<REDTSIZE; i++)
       WorkRedund[i] = 0xFF;</p>

<p>Media.Zone = (BYTE)Index;
   for (Media.PhyBlock=0; Media.PhyBlock<Ssfdc.MaxBlocks; Media.PhyBlock++)
   {
       if ((!Media.Zone) &amp;&amp; (Media.PhyBlock&lt;=CisArea.PhyBlock))
           continue;</p>

<pre><code>   if (Ssfdc_D_EraseBlock(fdoExt))
   {
       ErrCode = ERR_HwError;
       return(ERROR);
   }

   for(Media.Sector=0; Media.Sector&lt;Ssfdc.MaxSectors; Media.Sector++)
   {
       Ssfdc_D_WriteRedtMode();

       if (Ssfdc_D_WriteRedtData(WorkRedund))
       {
           Ssfdc_D_Reset(fdoExt);
           ErrCode        = ERR_HwError;
           MediaChange    = ERROR;
           return(ERROR);
       } // NO Status Check
   }

   Ssfdc_D_Reset(fdoExt);
</code></pre>

<p>}</p>

<p>Ssfdc<em>D</em>Reset(fdoExt);</p>

<p>return(SMSUCCESS);
}</p>

<p>//----- Media<em>D</em>GetMediaInfo() ---------------------------------------
DWORD Media<em>D</em>GetMediaInfo(PFDO<em>DEVICE</em>EXTENSION fdoExt, PIOCTL<em>MEDIA</em>INFO<em>IN pParamIn, PIOCTL</em>MEDIA<em>INFO</em>OUT pParamOut)
{
   pParamOut->ErrCode = STATUS<em>CMD</em>FAIL;</p>

<p>Init<em>D</em>SmartMedia();</p>

<p>if (Check<em>D</em>MediaPower())
       return (ErrCode==ERR<em>NoSmartMedia) ? STATUS</em>CMD<em>NO</em>MEDIA : STATUS<em>CMD</em>FAIL;</p>

<p>if (Set<em>D</em>PhyFmtValue(fdoExt))
       return STATUS<em>CMD</em>FAIL;</p>

<p>//usleep(56*1024);
   if (Search<em>D</em>CIS(fdoExt))
       return STATUS<em>CMD</em>FAIL;</p>

<p>if (Check<em>D</em>MediaWP())
       return STATUS<em>CMD</em>MEDIA_WP;</p>

<p>pParamOut->PageSize  = Ssfdc.MaxSectors;
   pParamOut->BlockSize = Ssfdc.MaxBlocks;
   pParamOut->ZoneSize  = Ssfdc.MaxZones;</p>

<p>return STATUS<em>CMD</em>SUCCESS;
}*/</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
