<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › bcm › InterfaceIdleMode.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>InterfaceIdleMode.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;headers.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">Function:				InterfaceIdleModeWakeup</span>

<span class="cm">Description:			This is the hardware specific Function for waking up HW device from Idle mode.</span>
<span class="cm">						A software abort pattern is written to the device to wake it and necessary power state</span>
<span class="cm">						transitions from host are performed here.</span>

<span class="cm">Input parameters:		IN PMINI_ADAPTER Adapter   - Miniport Adapter Context</span>


<span class="cm">Return:				BCM_STATUS_SUCCESS - If Wakeup of the HW Interface was successful.</span>
<span class="cm">						Other           - If an error occurred.</span>
<span class="cm">*/</span>


<span class="cm">/*</span>
<span class="cm">Function:				InterfaceIdleModeRespond</span>

<span class="cm">Description:			This is the hardware specific Function for responding to Idle mode request from target.</span>
<span class="cm">						Necessary power state transitions from host for idle mode or other device specific</span>
<span class="cm">						initializations are performed here.</span>

<span class="cm">Input parameters:		IN PMINI_ADAPTER Adapter   - Miniport Adapter Context</span>


<span class="cm">Return:				BCM_STATUS_SUCCESS - If Idle mode response related HW configuration was successful.</span>
<span class="cm">						Other           - If an error occurred.</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">&quot;dmem bfc02f00  100&quot; tells how many time device went in Idle mode.</span>
<span class="cm">this value will be at address bfc02fa4.just before value d0ea1dle.</span>

<span class="cm">Set time value by writing at bfc02f98 7d0</span>

<span class="cm">checking the Ack timer expire on kannon by running command</span>
<span class="cm">d qcslog .. if it shows e means host has not send response to f/w with in 200 ms. Response should be</span>
<span class="cm">send to f/w with in 200 ms after the Idle/Shutdown req issued</span>

<span class="cm">*/</span>


<span class="kt">int</span> <span class="nf">InterfaceIdleModeRespond</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">puiBuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">uiRegRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;SubType of Message :0x%X&quot;</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">puiBuffer</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">puiBuffer</span><span class="p">)</span> <span class="o">==</span> <span class="n">GO_TO_IDLE_MODE_PAYLOAD</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot; Got GO_TO_IDLE_MODE_PAYLOAD(210) Msg Subtype&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">puiBuffer</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Got IDLE MODE WAKE UP Response From F/W&quot;</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">wrmalt</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">SW_ABORT_IDLEMODE_LOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegRead</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegRead</span><span class="p">));</span>
			<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wrm failed while clearing Idle Mode Reg&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">==</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">uiRegRead</span> <span class="o">=</span> <span class="mh">0x00000000</span> <span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">wrmalt</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DEBUG_INTERRUPT_GENERATOR_REGISTOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegRead</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegRead</span><span class="p">));</span>
				<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wrm failed while clearing Idle Mode	Reg&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Below Register should not br read in case of Manual and Protocol Idle mode.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">!=</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE</span><span class="p">)</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>clear on read Register</p></td><td class="code"><div class="highlight"><pre>				<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DEVICE_INT_OUT_EP_REG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegRead</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegRead</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;rdm failed while clearing H/W Abort Reg0&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>clear on read Register</p></td><td class="code"><div class="highlight"><pre>				<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DEVICE_INT_OUT_EP_REG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegRead</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegRead</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;rdm failed while clearing H/W Abort	Reg1&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device Up from Idle Mode&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Set Idle Mode Flag to False and Clear IdleMode reg.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bTriedToWakeUpFromlowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">lowpower_mode_wait_queue</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Device is already in Idle mode....&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span> <span class="p">;</span>
			<span class="p">}</span>

			<span class="n">uiRegRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Got Req from F/W to go in IDLE mode </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="o">==</span> <span class="n">BCS220_2</span> <span class="o">||</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS220_2BC</span> <span class="o">||</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="o">==</span> <span class="n">BCS250_BC</span> <span class="o">||</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="o">==</span> <span class="n">BCS220_3</span><span class="p">)</span>
			<span class="p">{</span>

				<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">HPM_CONFIG_MSW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegRead</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegRead</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;rdm failed while Reading HPM_CONFIG_LDO145 Reg 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span>


				<span class="n">uiRegRead</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span>

				<span class="n">status</span> <span class="o">=</span> <span class="n">wrmalt</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">HPM_CONFIG_MSW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegRead</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegRead</span><span class="p">));</span>
				<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wrm failed while clearing Idle Mode Reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span>
			<span class="n">SendIdleModeResponse</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">puiBuffer</span><span class="p">)</span> <span class="o">==</span> <span class="n">IDLE_MODE_SF_UPDATE_MSG</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;OverRiding Service Flow Params&quot;</span><span class="p">);</span>
		<span class="n">OverrideServiceFlowParams</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">puiBuffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InterfaceAbortIdlemode</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> 	<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip_id</span> <span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span><span class="n">itr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> 	<span class="n">lenwritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">aucAbortPattern</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">};</span>
	<span class="n">PS_INTERFACE_ADAPTER</span> <span class="n">psInterfaceAdapter</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Abort Bus suspend if its already suspended</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">psInterfaceAdapter</span><span class="o">-&gt;</span><span class="n">bSuspended</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bDoSuspend</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">psInterfaceAdapter</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Bus got wakeup..Aborting Idle mode... status:%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">==</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING</span><span class="p">)</span>
									<span class="o">||</span>
	   <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">==</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE</span><span class="p">))</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>write the SW abort pattern.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Writing pattern&lt;%d&gt; to SW_ABORT_IDLEMODE_LOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">SW_ABORT_IDLEMODE_LOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Pattern</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Pattern</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;WRM to Register SW_ABORT_IDLEMODE_LOC failed..&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">==</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DEBUG_INTERRUPT_GENERATOR_REGISTOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;WRM to DEBUG_INTERRUPT_GENERATOR_REGISTOR Register failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">!=</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Get a Interrupt Out URB and send 8 Bytes Down</span>
<span class="cm">		 * To be Done in Thread Context.</span>
<span class="cm">		 * Not using Asynchronous Mechanism.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_interrupt_msg</span> <span class="p">(</span><span class="n">psInterfaceAdapter</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">psInterfaceAdapter</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">psInterfaceAdapter</span><span class="o">-&gt;</span><span class="n">sIntrOut</span><span class="p">.</span><span class="n">int_out_endpointAddr</span><span class="p">),</span>
			<span class="n">aucAbortPattern</span><span class="p">,</span>
			<span class="mi">8</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lenwritten</span><span class="p">,</span>
			<span class="mi">5000</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Sending Abort pattern down fails with status:%d..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;NOB Sent down :%d&quot;</span><span class="p">,</span> <span class="n">lenwritten</span><span class="p">);</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>mdelay(25);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">timeout</span><span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">while</span><span class="p">(</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">jiffies</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">itr</span><span class="o">++</span> <span class="p">;</span>
			<span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">CHIP_ID_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>
			<span class="k">if</span><span class="p">(</span><span class="mh">0xbece3200</span><span class="o">==</span><span class="p">(</span><span class="n">chip_id</span><span class="o">&amp;~</span><span class="p">(</span><span class="mh">0xF0</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="n">chip_id</span> <span class="o">=</span> <span class="n">chip_id</span><span class="o">&amp;~</span><span class="p">(</span><span class="mh">0xF0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">jiffies</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Not able to read chip-id even after 25 msec&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Number of completed iteration to read chip-id :%lu&quot;</span><span class="p">,</span> <span class="n">itr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">SW_ABORT_IDLEMODE_LOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Pattern</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="s">&quot;WRM to Register SW_ABORT_IDLEMODE_LOC failed..&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">InterfaceIdleModeWakeup</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ULONG</span>	<span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bTriedToWakeUpFromlowPowerMode</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Wake up already attempted.. ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">IDLE_MODE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Writing Low Power Mode Abort pattern to the Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bTriedToWakeUpFromlowPowerMode</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">InterfaceAbortIdlemode</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usIdleModePattern</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">InterfaceHandleShutdownModeWakeup</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uiRegVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INT</span> <span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">==</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>clear idlemode interrupt.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">uiRegVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Status</span> <span class="o">=</span><span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DEBUG_INTERRUPT_GENERATOR_REGISTOR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegVal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegVal</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">Status</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="s">&quot;WRM to DEBUG_INTERRUPT_GENERATOR_REGISTOR Failed with err :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

    <span class="k">else</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>clear Interrupt EP registers.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DEVICE_INT_OUT_EP_REG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegVal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegVal</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="s">&quot;RDM of DEVICE_INT_OUT_EP_REG0 failed with Err :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DEVICE_INT_OUT_EP_REG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiRegVal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiRegVal</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="s">&quot;RDM of DEVICE_INT_OUT_EP_REG1 failed with Err :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
