<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › bcm › IPv6Protocol.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>IPv6Protocol.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;headers.h&quot;</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="n">MatchSrcIpv6Address</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span>
	<span class="n">IPV6Header</span> <span class="o">*</span><span class="n">pstIpv6Header</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="n">MatchDestIpv6Address</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span>
	<span class="n">IPV6Header</span> <span class="o">*</span><span class="n">pstIpv6Header</span><span class="p">);</span>
<span class="k">static</span> <span class="n">VOID</span> <span class="n">DumpIpv6Header</span><span class="p">(</span><span class="n">IPV6Header</span> <span class="o">*</span><span class="n">pstIpv6Header</span><span class="p">);</span>

<span class="k">static</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="nf">GetNextIPV6ChainedHeader</span><span class="p">(</span><span class="n">UCHAR</span> <span class="o">**</span><span class="n">ppucPayload</span><span class="p">,</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">pucNextHeader</span><span class="p">,</span> <span class="n">BOOLEAN</span> <span class="o">*</span><span class="n">bParseDone</span><span class="p">,</span> <span class="n">USHORT</span> <span class="o">*</span><span class="n">pusPayloadLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">pucRetHeaderPtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">pucPayloadPtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">USHORT</span>  <span class="n">usNextHeaderOffset</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ppucPayload</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">pusPayloadLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">*</span><span class="n">bParseDone</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pucRetHeaderPtr</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppucPayload</span><span class="p">;</span>
	<span class="n">pucPayloadPtr</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppucPayload</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pucRetHeaderPtr</span> <span class="o">||</span> <span class="o">!</span><span class="n">pucPayloadPtr</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the Nextt Header Type */</span>
	<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pucNextHeader</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPV6HDR_TYPE_HOPBYHOP</span>:
		<span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 HopByHop Header&quot;</span><span class="p">);</span>
			<span class="n">usNextHeaderOffset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IPV6HopByHopOptionsHeader</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IPV6HDR_TYPE_ROUTING</span>:
		<span class="p">{</span>
			<span class="n">IPV6RoutingHeader</span> <span class="o">*</span><span class="n">pstIpv6RoutingHeader</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Routing Header&quot;</span><span class="p">);</span>
			<span class="n">pstIpv6RoutingHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPV6RoutingHeader</span> <span class="o">*</span><span class="p">)</span><span class="n">pucPayloadPtr</span><span class="p">;</span>
			<span class="n">usNextHeaderOffset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IPV6RoutingHeader</span><span class="p">);</span>
			<span class="n">usNextHeaderOffset</span> <span class="o">+=</span> <span class="n">pstIpv6RoutingHeader</span><span class="o">-&gt;</span><span class="n">ucNumAddresses</span> <span class="o">*</span> <span class="n">IPV6_ADDRESS_SIZEINBYTES</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPV6HDR_TYPE_FRAGMENTATION</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Fragmentation Header&quot;</span><span class="p">);</span>
			<span class="n">usNextHeaderOffset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IPV6FragmentHeader</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPV6HDR_TYPE_DESTOPTS</span>:
		<span class="p">{</span>
			<span class="n">IPV6DestOptionsHeader</span> <span class="o">*</span><span class="n">pstIpv6DestOptsHdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPV6DestOptionsHeader</span> <span class="o">*</span><span class="p">)</span><span class="n">pucPayloadPtr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">nTotalOptions</span> <span class="o">=</span> <span class="n">pstIpv6DestOptsHdr</span><span class="o">-&gt;</span><span class="n">ucHdrExtLen</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 DestOpts Header Header&quot;</span><span class="p">);</span>
			<span class="n">usNextHeaderOffset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IPV6DestOptionsHeader</span><span class="p">);</span>
			<span class="n">usNextHeaderOffset</span> <span class="o">+=</span> <span class="n">nTotalOptions</span> <span class="o">*</span> <span class="n">IPV6_DESTOPTS_HDR_OPTIONSIZE</span> <span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPV6HDR_TYPE_AUTHENTICATION</span>:
		<span class="p">{</span>
			<span class="n">IPV6AuthenticationHeader</span> <span class="o">*</span><span class="n">pstIpv6AuthHdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPV6AuthenticationHeader</span> <span class="o">*</span><span class="p">)</span><span class="n">pucPayloadPtr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">nHdrLen</span> <span class="o">=</span> <span class="n">pstIpv6AuthHdr</span><span class="o">-&gt;</span><span class="n">ucLength</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Authentication Header&quot;</span><span class="p">);</span>
			<span class="n">usNextHeaderOffset</span> <span class="o">+=</span> <span class="n">nHdrLen</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPV6HDR_TYPE_ENCRYPTEDSECURITYPAYLOAD</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Encrypted Security Payload Header&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPV6_ICMP_HDR_TYPE</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">ICMP Header&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCP_HEADER_TYPE</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">TCP Header&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UDP_HEADER_TYPE</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">UDP Header&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="p">{</span>
			<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bParseDone</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pusPayloadLength</span> <span class="o">&lt;=</span> <span class="n">usNextHeaderOffset</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bParseDone</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pucNextHeader</span> <span class="o">=</span> <span class="o">*</span><span class="n">pucPayloadPtr</span><span class="p">;</span>
			<span class="n">pucPayloadPtr</span> <span class="o">+=</span> <span class="n">usNextHeaderOffset</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pusPayloadLength</span><span class="p">)</span> <span class="o">-=</span> <span class="n">usNextHeaderOffset</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="o">*</span><span class="n">ppucPayload</span> <span class="o">=</span> <span class="n">pucPayloadPtr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pucRetHeaderPtr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">UCHAR</span> <span class="nf">GetIpv6ProtocolPorts</span><span class="p">(</span><span class="n">UCHAR</span> <span class="o">*</span><span class="n">pucPayload</span><span class="p">,</span> <span class="n">USHORT</span> <span class="o">*</span><span class="n">pusSrcPort</span><span class="p">,</span>
	<span class="n">USHORT</span> <span class="o">*</span><span class="n">pusDestPort</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usPayloadLength</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="n">ucNextHeader</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">pIpv6HdrScanContext</span> <span class="o">=</span> <span class="n">pucPayload</span><span class="p">;</span>
	<span class="n">BOOLEAN</span> <span class="n">bDone</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">ucHeaderType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">pucNextHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pucPayload</span> <span class="o">||</span> <span class="p">(</span><span class="n">usPayloadLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pusSrcPort</span> <span class="o">=</span> <span class="o">*</span><span class="n">pusDestPort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucHeaderType</span> <span class="o">=</span> <span class="n">ucNextHeader</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">bDone</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pucNextHeader</span> <span class="o">=</span> <span class="n">GetNextIPV6ChainedHeader</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pIpv6HdrScanContext</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ucHeaderType</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bDone</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usPayloadLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bDone</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ucHeaderType</span> <span class="o">==</span> <span class="n">TCP_HEADER_TYPE</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">ucHeaderType</span> <span class="o">==</span> <span class="n">UDP_HEADER_TYPE</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">pusSrcPort</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PUSHORT</span><span class="p">)(</span><span class="n">pucNextHeader</span><span class="p">));</span>
				<span class="o">*</span><span class="n">pusDestPort</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">PUSHORT</span><span class="p">)(</span><span class="n">pucNextHeader</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
						<span class="n">DBG_LVL_ALL</span><span class="p">,</span>
						<span class="s">&quot;</span><span class="se">\n</span><span class="s">Protocol Ports - Src Port :0x%x Dest Port : 0x%x&quot;</span><span class="p">,</span>
						<span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">pusSrcPort</span><span class="p">),</span>
						<span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="n">pusDestPort</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ucHeaderType</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Arg 1 PMINI_ADAPTER Adapter is a pointer ot the driver contorl structure</span>
<span class="cm"> * Arg 2 PVOID pcIpHeader is a pointer to the IP header of the packet</span>
<span class="cm"> */</span>
<span class="n">USHORT</span>	<span class="nf">IpVersion6</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">pcIpHeader</span><span class="p">,</span>
					<span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">USHORT</span>	<span class="n">ushDestPort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">USHORT</span>	<span class="n">ushSrcPort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UCHAR</span>   <span class="n">ucNextProtocolAboveIP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">IPV6Header</span> <span class="o">*</span><span class="n">pstIpv6Header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">BOOLEAN</span> <span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
			<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IpVersion6 ==========&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pstIpv6Header</span> <span class="o">=</span> <span class="p">(</span><span class="n">IPV6Header</span> <span class="o">*</span><span class="p">)</span><span class="n">pcIpHeader</span><span class="p">;</span>

	<span class="n">DumpIpv6Header</span><span class="p">(</span><span class="n">pstIpv6Header</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to get the next higher layer protocol</span>
<span class="cm">	 * and the Ports Nos if TCP or UDP</span>
<span class="cm">	 */</span>
	<span class="n">ucNextProtocolAboveIP</span> <span class="o">=</span> <span class="n">GetIpv6ProtocolPorts</span><span class="p">((</span><span class="n">UCHAR</span> <span class="o">*</span><span class="p">)(</span><span class="n">pcIpHeader</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IPV6Header</span><span class="p">)),</span>
							<span class="o">&amp;</span><span class="n">ushSrcPort</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ushDestPort</span><span class="p">,</span>
							<span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">usPayloadLength</span><span class="p">,</span>
							<span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ucNextHeader</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucDirection</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * cannot be processed for classification.</span>
<span class="cm">			 * it is a down link connection</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">bIpv6Protocol</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We are looking for Ipv6 Classifiers</span>
<span class="cm">			 * Lets ignore this classifier and try the next one</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">MatchSrcIpv6Address</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span>
								<span class="n">pstIpv6Header</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">MatchDestIpv6Address</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span>
								<span class="n">pstIpv6Header</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Match the protocol type.</span>
<span class="cm">		 * For IPv6 the next protocol at end of</span>
<span class="cm">		 * Chain of IPv6 prot headers</span>
<span class="cm">		 */</span>
		<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">MatchProtocol</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span>
							<span class="n">ucNextProtocolAboveIP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
				<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Protocol Matched&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ucNextProtocolAboveIP</span> <span class="o">==</span> <span class="n">TCP_HEADER_TYPE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">ucNextProtocolAboveIP</span> <span class="o">==</span> <span class="n">UDP_HEADER_TYPE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Match Src Port */</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Source Port:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ntohs</span><span class="p">(</span><span class="n">ushSrcPort</span><span class="p">));</span>
			<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">MatchSrcPort</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span>
							<span class="n">ntohs</span><span class="p">(</span><span class="n">ushSrcPort</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Src Port Matched&quot;</span><span class="p">);</span>

			<span class="cm">/* Match Dest Port */</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Destination Port:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ntohs</span><span class="p">(</span><span class="n">ushDestPort</span><span class="p">));</span>
			<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">MatchDestPort</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span>
							<span class="n">ntohs</span><span class="p">(</span><span class="n">ushDestPort</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">IPv6 Dest Port Matched&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INT</span> <span class="n">iMatchedSFQueueIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iMatchedSFQueueIndex</span> <span class="o">=</span> <span class="n">SearchSfid</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ulSFID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iMatchedSFQueueIndex</span> <span class="o">&gt;=</span> <span class="n">NO_OF_QUEUES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iMatchedSFQueueIndex</span><span class="p">].</span><span class="n">bActive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
				<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bClassificationSucceed</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">MatchSrcIpv6Address</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span>
	<span class="n">IPV6Header</span> <span class="o">*</span><span class="n">pstIpv6Header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiIpv6AddrNoLongWords</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">aulSrcIP</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is the no. of Src Addresses ie Range of IP Addresses contained</span>
<span class="cm">	 * in the classifier rule for which we need to match</span>
<span class="cm">	 */</span>
	<span class="n">UINT</span>  <span class="n">uiCountIPSrcAddresses</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucIPSourceAddressLength</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">uiCountIPSrcAddresses</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>


	<span class="cm">/* First Convert the Ip Address in the packet to Host Endian order */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span> <span class="o">&lt;</span> <span class="n">uiIpv6AddrNoLongWords</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span><span class="o">++</span><span class="p">)</span>
		<span class="n">aulSrcIP</span><span class="p">[</span><span class="n">uiIpv6AddIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ulSrcIpAddress</span><span class="p">[</span><span class="n">uiIpv6AddIndex</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&lt;</span> <span class="n">uiCountIPSrcAddresses</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">+=</span> <span class="n">uiIpv6AddrNoLongWords</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s"> Src Ipv6 Address In Received Packet :</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
		<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">aulSrcIP</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s"> Src Ipv6 Mask In Classifier Rule:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv6Mask</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">]);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s"> Src Ipv6 Address In Classifier Rule :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv6Addr</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span> <span class="o">&lt;</span> <span class="n">uiIpv6AddrNoLongWords</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv6Mask</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="o">+</span><span class="n">uiIpv6AddIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aulSrcIP</span><span class="p">[</span><span class="n">uiIpv6AddIndex</span><span class="p">])</span>
				<span class="o">!=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv6Addr</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="o">+</span><span class="n">uiIpv6AddIndex</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Match failed for current Ipv6 Address</span>
<span class="cm">				 * Try next Ipv6 Address</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">uiIpv6AddIndex</span> <span class="o">==</span>  <span class="n">uiIpv6AddrNoLongWords</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Match Found */</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
						<span class="n">DBG_LVL_ALL</span><span class="p">,</span>
						<span class="s">&quot;Ipv6 Src Ip Address Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">MatchDestIpv6Address</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span>
	<span class="n">IPV6Header</span> <span class="o">*</span><span class="n">pstIpv6Header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiIpv6AddrNoLongWords</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">aulDestIP</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is the no. of Destination Addresses</span>
<span class="cm">	 * ie Range of IP Addresses contained in the classifier rule</span>
<span class="cm">	 * for which we need to match</span>
<span class="cm">	 */</span>
	<span class="n">UINT</span>  <span class="n">uiCountIPDestinationAddresses</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucIPDestinationAddressLength</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">uiCountIPDestinationAddresses</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>


	<span class="cm">/* First Convert the Ip Address in the packet to Host Endian order */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span> <span class="o">&lt;</span> <span class="n">uiIpv6AddrNoLongWords</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span><span class="o">++</span><span class="p">)</span>
		<span class="n">aulDestIP</span><span class="p">[</span><span class="n">uiIpv6AddIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ulDestIpAddress</span><span class="p">[</span><span class="n">uiIpv6AddIndex</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&lt;</span> <span class="n">uiCountIPDestinationAddresses</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">+=</span> <span class="n">uiIpv6AddrNoLongWords</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s"> Destination Ipv6 Address In Received Packet :</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
		<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">aulDestIP</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s"> Destination Ipv6 Mask In Classifier Rule :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv6Mask</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">]);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s"> Destination Ipv6 Address In Classifier Rule :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv6Addr</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span> <span class="o">&lt;</span> <span class="n">uiIpv6AddrNoLongWords</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv6Mask</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="o">+</span><span class="n">uiIpv6AddIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aulDestIP</span><span class="p">[</span><span class="n">uiIpv6AddIndex</span><span class="p">])</span>
				<span class="o">!=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv6Addr</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="o">+</span><span class="n">uiIpv6AddIndex</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Match failed for current Ipv6 Address.</span>
<span class="cm">				 * Try next Ipv6 Address</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">uiIpv6AddIndex</span> <span class="o">==</span>  <span class="n">uiIpv6AddrNoLongWords</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Match Found */</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span>
						<span class="n">DBG_LVL_ALL</span><span class="p">,</span>
						<span class="s">&quot;Ipv6 Destination Ip Address Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">DumpIpv6Address</span><span class="p">(</span><span class="n">ULONG</span> <span class="o">*</span><span class="n">puIpv6Address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiIpv6AddrNoLongWords</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">uiIpv6AddIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span> <span class="o">&lt;</span> <span class="n">uiIpv6AddrNoLongWords</span><span class="p">;</span> <span class="n">uiIpv6AddIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;:%lx&quot;</span><span class="p">,</span> <span class="n">puIpv6Address</span><span class="p">[</span><span class="n">uiIpv6AddIndex</span><span class="p">]);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">VOID</span> <span class="nf">DumpIpv6Header</span><span class="p">(</span><span class="n">IPV6Header</span> <span class="o">*</span><span class="n">pstIpv6Header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UCHAR</span> <span class="n">ucVersion</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">ucPrio</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;----Ipv6 Header---&quot;</span><span class="p">);</span>
	<span class="n">ucVersion</span> <span class="o">=</span> <span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ucVersionPrio</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;Version : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ucVersion</span><span class="p">);</span>
	<span class="n">ucPrio</span> <span class="o">=</span> <span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ucVersionPrio</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;Priority : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ucPrio</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * BCM_DEBUG_PRINT( Adapter,DBG_TYPE_TX, IPV6_DBG, DBG_LVL_ALL,</span>
<span class="cm">	 * &quot;Flow Label : %x\n&quot;,(pstIpv6Header-&gt;ucVersionPrio &amp;0xf0);</span>
<span class="cm">	 */</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;Payload Length : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">usPayloadLength</span><span class="p">));</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;Next Header : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ucNextHeader</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;Hop Limit : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ucHopLimit</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;Src Address :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ulSrcIpAddress</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;Dest Address :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">pstIpv6Header</span><span class="o">-&gt;</span><span class="n">ulDestIpAddress</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV6_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
			<span class="s">&quot;----Ipv6 Header End---&quot;</span><span class="p">);</span>


<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
