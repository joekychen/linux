<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › bcm › Bcmchar.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>Bcmchar.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/fs.h&gt;</span>

<span class="cp">#include &quot;headers.h&quot;</span>
<span class="cm">/***************************************************************</span>
<span class="cm">* Function	  - bcm_char_open()</span>
<span class="cm">*</span>
<span class="cm">* Description - This is the &quot;open&quot; entry point for the character</span>
<span class="cm">*				driver.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - inode: Pointer to the Inode structure of char device</span>
<span class="cm">*				filp : File pointer of the char device</span>
<span class="cm">*</span>
<span class="cm">* Returns	  - Zero(Success)</span>
<span class="cm">****************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_char_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PMINI_ADAPTER</span>       <span class="n">Adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PPER_TARANG_DATA</span>    <span class="n">pTarang</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">pTarang</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PER_TARANG_DATA</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pTarang</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">Adapter</span> <span class="o">=</span> <span class="n">Adapter</span><span class="p">;</span>
	<span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxCntrlMsgBitMask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mh">0xB</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>
	<span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pTarangs</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pTarangs</span> <span class="o">=</span> <span class="n">pTarang</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>

	<span class="cm">/* Store the Adapter structure */</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pTarang</span><span class="p">;</span>

	<span class="cm">/* Start Queuing the control response Packets */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ApplicationRunning</span><span class="p">);</span>

	<span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_char_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PPER_TARANG_DATA</span> <span class="n">pTarang</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ptmp</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="o">*</span><span class="n">npkt</span><span class="p">;</span>

	<span class="n">pTarang</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPER_TARANG_DATA</span><span class="p">)</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pTarang</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;ptarang is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Adapter</span> <span class="o">=</span> <span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">Adapter</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pTarangs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">tmp</span><span class="p">;</span> <span class="n">ptmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">pTarang</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptmp</span><span class="p">)</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pTarangs</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ptmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxAppControlHead</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">npkt</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">npkt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>

	<span class="cm">/* Stop Queuing the control response Packets */</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ApplicationRunning</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pTarang</span><span class="p">);</span>

	<span class="cm">/* remove this filp from the asynchronously notified filp&#39;s */</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bcm_char_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			     <span class="n">loff_t</span> <span class="o">*</span><span class="n">f_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PPER_TARANG_DATA</span> <span class="n">pTarang</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span>	<span class="n">Adapter</span> <span class="o">=</span> <span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">Adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">Packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">PktLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wait_ret_val</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">process_read_wait_queue</span><span class="p">,</span>
						<span class="p">(</span><span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxAppControlHead</span> <span class="o">||</span>
						 <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">device_removed</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wait_ret_val</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;Exiting as i&#39;ve been asked to exit!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">wait_ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">device_removed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;Device Removed... Killing the Apps...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_done</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxAppControlHead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Packet</span> <span class="o">=</span> <span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxAppControlHead</span><span class="p">;</span>
		<span class="n">DEQUEUEPACKET</span><span class="p">(</span><span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxAppControlHead</span><span class="p">,</span>
			      <span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxAppControlTail</span><span class="p">);</span>
		<span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">AppCtrlQueueLen</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PktLen</span> <span class="o">=</span> <span class="n">Packet</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">Packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">PktLen</span><span class="p">,</span> <span class="n">size</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">Packet</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;Returning from copy to user failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
				<span class="s">&quot;Read %zd Bytes From Adapter packet = %p by process %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PktLen</span><span class="p">,</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">Packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PktLen</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">bcm_char_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PPER_TARANG_DATA</span>  <span class="n">pTarang</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">Adapter</span><span class="p">;</span>
	<span class="n">INT</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">IOCTL_BUFFER</span> <span class="n">IoBuffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Parameters Passed to control IOCTL cmd=0x%X arg=0x%lX&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BCM_IOCTL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_READ</span><span class="p">)</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_WRITE</span><span class="p">)</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_IOC_NONE</span> <span class="o">==</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_NONE</span><span class="p">))</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">device_removed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IOCTL_MAC_ADDR_REQ</span>:
		<span class="k">case</span> <span class="n">IOCTL_LINK_REQ</span>:
		<span class="k">case</span> <span class="n">IOCTL_CM_REQUEST</span>:
		<span class="k">case</span> <span class="n">IOCTL_SS_INFO_REQ</span>:
		<span class="k">case</span> <span class="n">IOCTL_SEND_CONTROL_MESSAGE</span>:
		<span class="k">case</span> <span class="n">IOCTL_IDLE_REQ</span>:
		<span class="k">case</span> <span class="n">IOCTL_BCM_GPIO_SET_REQUEST</span>:
		<span class="k">case</span> <span class="n">IOCTL_BCM_GPIO_STATUS_REQUEST</span>:
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">Status</span> <span class="o">=</span> <span class="n">vendorextnIoctl</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">CONTINUE_COMMON_PATH</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Rdms for Swin Idle... */</span>
	<span class="k">case</span> <span class="n">IOCTL_BCM_REGISTER_READ_PRIVATE</span>: <span class="p">{</span>
		<span class="n">RDM_BUFFER</span>  <span class="n">sRdmBuffer</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">PCHAR</span> <span class="n">temp_buff</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">Bufflen</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">temp_value</span><span class="p">;</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sRdmBuffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sRdmBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span>
			<span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Bufflen</span> <span class="o">=</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">;</span>
		<span class="n">temp_value</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">Bufflen</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">Bufflen</span> <span class="o">+=</span> <span class="n">temp_value</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">temp_buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">Bufflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_buff</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">sRdmBuffer</span><span class="p">.</span><span class="n">Register</span><span class="p">,</span>
				<span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">temp_buff</span><span class="p">,</span> <span class="n">Bufflen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="n">temp_buff</span><span class="p">,</span> <span class="n">bytes</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_REGISTER_WRITE_PRIVATE</span>: <span class="p">{</span>
		<span class="n">WRM_BUFFER</span>  <span class="n">sWrmBuffer</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">UINT</span> <span class="n">uiTempVar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Copy Ioctl Buffer structure */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sWrmBuffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Get WrmBuffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sWrmBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">uiTempVar</span> <span class="o">=</span> <span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="n">EEPROM_REJECT_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">m_u32Customize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VSG_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_1</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_2</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_3</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_4</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;EEPROM Access Denied, not in VSG Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Register</span><span class="p">,</span>
				<span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;WRM Done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;WRM Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_REGISTER_READ</span>:
	<span class="k">case</span> <span class="n">IOCTL_BCM_EEPROM_REGISTER_READ</span>: <span class="p">{</span>
		<span class="n">RDM_BUFFER</span>  <span class="n">sRdmBuffer</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">PCHAR</span> <span class="n">temp_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">uiTempVar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Device in Idle Mode, Blocking Rdms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sRdmBuffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sRdmBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span>
			<span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">temp_buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_buff</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">sRdmBuffer</span><span class="p">.</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="mh">0x0F000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0F000000</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">sRdmBuffer</span><span class="p">.</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;RDM Done On invalid Address : %x Access Denied.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sRdmBuffer</span><span class="p">.</span><span class="n">Register</span><span class="p">);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">uiTempVar</span> <span class="o">=</span> <span class="n">sRdmBuffer</span><span class="p">.</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="n">EEPROM_REJECT_MASK</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">sRdmBuffer</span><span class="p">.</span><span class="n">Register</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">temp_buff</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="n">temp_buff</span><span class="p">,</span> <span class="n">bytes</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">IOCTL_BCM_REGISTER_WRITE</span>:
	<span class="k">case</span> <span class="n">IOCTL_BCM_EEPROM_REGISTER_WRITE</span>: <span class="p">{</span>
		<span class="n">WRM_BUFFER</span>  <span class="n">sWrmBuffer</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">UINT</span> <span class="n">uiTempVar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Device in Idle Mode, Blocking Wrms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sWrmBuffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Get WrmBuffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sWrmBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="mh">0x0F000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0F000000</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;WRM Done On invalid Address : %x Access Denied.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Register</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">uiTempVar</span> <span class="o">=</span> <span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="n">EEPROM_REJECT_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">m_u32Customize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VSG_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_1</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_2</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_3</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_4</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">IOCTL_BCM_REGISTER_WRITE</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;EEPROM Access Denied, not in VSG Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Register</span><span class="p">,</span>
					<span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Data</span><span class="p">,</span> <span class="n">sWrmBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;WRM Done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;WRM Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">IOCTL_BCM_GPIO_SET_REQUEST</span>: <span class="p">{</span>
		<span class="n">UCHAR</span> <span class="n">ucResetValue</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">UINT</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">uiBit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">uiOperation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">GPIO_INFO</span>   <span class="n">gpio_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;GPIO Can&#39;t be set/clear in Low power Mode&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio_info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio_info</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">uiBit</span>  <span class="o">=</span> <span class="n">gpio_info</span><span class="p">.</span><span class="n">uiGpioNumber</span><span class="p">;</span>
		<span class="n">uiOperation</span> <span class="o">=</span> <span class="n">gpio_info</span><span class="p">.</span><span class="n">uiGpioValue</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">uiBit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsReqGpioIsLedInNVM</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Sorry, Requested GPIO&lt;0x%X&gt; is not correspond to LED !!!&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Set - setting 1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uiOperation</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set the gpio output register */</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">BCM_GPIO_OUTPUT_SET_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Set the GPIO bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Failed to set the %dth GPIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiBit</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Set the gpio output register */</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">BCM_GPIO_OUTPUT_CLR_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Set the GPIO bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Failed to clear the %dth GPIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiBit</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">GPIO_MODE_REGISTER</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;GPIO_MODE_REGISTER read failed&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Set the gpio mode register to output */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span><span class="n">ucResetValue</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">uiBit</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">GPIO_MODE_REGISTER</span><span class="p">,</span>
					<span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Set the GPIO to output Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Failed to put GPIO in Output Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BCM_LED_THREAD_STATE_CHANGE_REQ</span>: <span class="p">{</span>
		<span class="n">USER_THREAD_REQ</span> <span class="n">threadReq</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;User made LED thread InActive&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;GPIO Can&#39;t be set/clear in Low power Mode&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">threadReq</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadReq</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="cm">/* if LED thread is running(Actively or Inactively) set it state to make inactive */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">threadReq</span><span class="p">.</span><span class="n">ThreadState</span> <span class="o">==</span> <span class="n">LED_THREAD_ACTIVATION_REQ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Activating thread req&quot;</span><span class="p">);</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">LED_THREAD_ACTIVE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;DeActivating Thread req.....&quot;</span><span class="p">);</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">LED_THREAD_INACTIVE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* signal thread. */</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GPIO_STATUS_REQUEST</span>: <span class="p">{</span>
		<span class="n">ULONG</span> <span class="n">uiBit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UCHAR</span> <span class="n">ucRead</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">GPIO_INFO</span>   <span class="n">gpio_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio_info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio_info</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">uiBit</span> <span class="o">=</span> <span class="n">gpio_info</span><span class="p">.</span><span class="n">uiGpioNumber</span><span class="p">;</span>

		<span class="cm">/* Set the gpio output register */</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">GPIO_PIN_STATE_REGISTER</span><span class="p">,</span>
					<span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucRead</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;RDM Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GPIO_MULTI_REQUEST</span>: <span class="p">{</span>
		<span class="n">UCHAR</span> <span class="n">ucResetValue</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">GPIO_MULTI_INFO</span> <span class="n">gpio_multi_info</span><span class="p">[</span><span class="n">MAX_IDX</span><span class="p">];</span>
		<span class="n">PGPIO_MULTI_INFO</span> <span class="n">pgpio_multi_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">PGPIO_MULTI_INFO</span><span class="p">)</span><span class="n">gpio_multi_info</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">pgpio_multi_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_IDX</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GPIO_MULTI_INFO</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio_multi_info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio_multi_info</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsReqGpioIsLedInNVM</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;Sorry, Requested GPIO&lt;0x%X&gt; is not correspond to NVM LED bit map&lt;0x%X&gt;!!!&quot;</span><span class="p">,</span>
					<span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">gpioBitMap</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Set the gpio output register */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOCommand</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Set 1&#39;s in GPIO OUTPUT REGISTER */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span><span class="n">ucResetValue</span> <span class="o">=</span>  <span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span> <span class="o">&amp;</span>
				<span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOCommand</span> <span class="o">&amp;</span>
				<span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOValue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span> <span class="n">ucResetValue</span><span class="p">)</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">BCM_GPIO_OUTPUT_SET_REG</span><span class="p">,</span>
							<span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;WRM to BCM_GPIO_OUTPUT_SET_REG Failed.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Clear to 0&#39;s in GPIO OUTPUT REGISTER */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span><span class="n">ucResetValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span> <span class="o">&amp;</span>
						<span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOCommand</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOValue</span><span class="p">)));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span> <span class="n">ucResetValue</span><span class="p">)</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">BCM_GPIO_OUTPUT_CLR_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;WRM to BCM_GPIO_OUTPUT_CLR_REG Failed.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">GPIO_PIN_STATE_REGISTER</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;RDM to GPIO_PIN_STATE_REGISTER Failed.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOValue</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span><span class="n">ucResetValue</span> <span class="o">&amp;</span>
								<span class="n">pgpio_multi_info</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio_multi_info</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;Failed while copying Content to IOBufer for user space err:%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GPIO_MODE_REQUEST</span>: <span class="p">{</span>
		<span class="n">UCHAR</span> <span class="n">ucResetValue</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">GPIO_MULTI_MODE</span> <span class="n">gpio_multi_mode</span><span class="p">[</span><span class="n">MAX_IDX</span><span class="p">];</span>
		<span class="n">PGPIO_MULTI_MODE</span> <span class="n">pgpio_multi_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">PGPIO_MULTI_MODE</span><span class="p">)</span><span class="n">gpio_multi_mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpio_multi_mode</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio_multi_mode</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">GPIO_MODE_REGISTER</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Read of GPIO_MODE_REGISTER failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Validating the request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IsReqGpioIsLedInNVM</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;Sorry, Requested GPIO&lt;0x%X&gt; is not correspond to NVM LED bit map&lt;0x%X&gt;!!!&quot;</span><span class="p">,</span>
					<span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">gpioBitMap</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* write all OUT&#39;s (1&#39;s) */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span> <span class="n">ucResetValue</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMode</span> <span class="o">&amp;</span>
						<span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">);</span>

			<span class="cm">/* write all IN&#39;s (0&#39;s) */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span> <span class="n">ucResetValue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="o">~</span><span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMode</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMask</span><span class="p">);</span>

			<span class="cm">/* Currently implemented return the modes of all GPIO&#39;s</span>
<span class="cm">			 * else needs to bit AND with  mask</span>
<span class="cm">			 */</span>
			<span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">;</span>

			<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">GPIO_MODE_REGISTER</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
						<span class="s">&quot;WRM to GPIO_MODE_REGISTER Done&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="s">&quot;WRM to GPIO_MODE_REGISTER Failed&quot;</span><span class="p">);</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cm">/* if uiGPIOMask is 0 then return mode register configuration */</span>
			<span class="n">pgpio_multi_mode</span><span class="p">[</span><span class="n">WIMAX_IDX</span><span class="p">].</span><span class="n">uiGPIOMode</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">UINT</span> <span class="o">*</span><span class="p">)</span><span class="n">ucResetValue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio_multi_mode</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;Failed while copying Content to IOBufer for user space err:%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_MAC_ADDR_REQ</span>:
	<span class="k">case</span> <span class="n">IOCTL_LINK_REQ</span>:
	<span class="k">case</span> <span class="n">IOCTL_CM_REQUEST</span>:
	<span class="k">case</span> <span class="n">IOCTL_SS_INFO_REQ</span>:
	<span class="k">case</span> <span class="n">IOCTL_SEND_CONTROL_MESSAGE</span>:
	<span class="k">case</span> <span class="n">IOCTL_IDLE_REQ</span>: <span class="p">{</span>
		<span class="n">PVOID</span> <span class="n">pvBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_request</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="n">MAX_CNTL_PKT_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">pvBuffer</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span>
				       <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">);</span>

		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">lowpower_mode_wait_queue</span><span class="p">,</span>
							<span class="o">!</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span><span class="p">,</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cntrlEnd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;Preparing Idle Mode is still True - Hence Rejecting control message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cntrlEnd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">CopyBufferToControlPacket</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">pvBuffer</span><span class="p">);</span>

<span class="nl">cntrlEnd:</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_BUFFER_DOWNLOAD_START</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>
					<span class="s">&quot;IOCTL_BCM_CHIP_RESET not allowed as EEPROM Read/Write is in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;Starting the firmware download PID =0x%x!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bBinDownloaded</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_process_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bCfgDownloaded</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">reset_card_proc</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: reset_card_proc Failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_BUFFER_DOWNLOAD</span>: <span class="p">{</span>
		<span class="n">FIRMWARE_INFO</span> <span class="o">*</span><span class="n">psFwInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Starting the firmware download PID =0x%x!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;Invalid way to download buffer. Use Start and then call this!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;Length for FW DLD is : %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FIRMWARE_INFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">psFwInfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psFwInfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psFwInfo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">psFwInfo</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psFwInfo</span><span class="o">-&gt;</span><span class="n">pvMappedFirmwareAddress</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">psFwInfo</span><span class="o">-&gt;</span><span class="n">u32FirmwareLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Something else is wrong %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">psFwInfo</span><span class="o">-&gt;</span><span class="n">u32FirmwareLength</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">bcm_ioctl_fw_download</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">psFwInfo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psFwInfo</span><span class="o">-&gt;</span><span class="n">u32StartingAddress</span> <span class="o">==</span> <span class="n">CONFIG_BEGIN_ADDR</span><span class="p">)</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;IOCTL: Configuration File Upload Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="s">&quot;IOCTL: Firmware File Upload Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* up(&amp;Adapter-&gt;fw_download_sema); */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">DRIVER_INIT</span><span class="p">;</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">bLedInitDone</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL: Firmware File Uploaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">psFwInfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_BUFFER_DOWNLOAD_STOP</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;FW download blocked as EEPROM Read/Write is in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bBinDownloaded</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bCfgDownloaded</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">CurrNumFreeTxDesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">CurrNumRecvDescs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">downloadDDR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* setting the Mips to Run */</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">run_card_proc</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Firm Download Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span>
					<span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Firm Download Over...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="cm">/* Wait for MailBox Interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StartInterruptUrb</span><span class="p">((</span><span class="n">PS_INTERFACE_ADAPTER</span><span class="p">)</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">))</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Unable to send interrupt...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">waiting_to_fw_download_done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ioctl_fw_dnld_wait_queue</span><span class="p">,</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">waiting_to_fw_download_done</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_process_pid</span> <span class="o">=</span> <span class="n">INVALID_PID</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">CurrNumFreeTxDesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">CurrNumRecvDescs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PrevNumRecvDescs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">cntrlpktCnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkUpStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">FW_DOWNLOAD_DONE</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BE_BUCKET_SIZE</span>:
		<span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">BEBucketSize</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_RTPS_BUCKET_SIZE</span>:
		<span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rtPSBucketSize</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_CHIP_RESET</span>: <span class="p">{</span>
		<span class="n">INT</span> <span class="n">NVMAccess</span> <span class="o">=</span> <span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NVMAccess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot; IOCTL_BCM_CHIP_RESET not allowed as EEPROM Read/Write is in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">reset_card_proc</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="n">flushAllAppQ</span><span class="p">();</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="n">ResetCounters</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_QOS_THRESHOLD</span>: <span class="p">{</span>
		<span class="n">USHORT</span> <span class="n">uiLoopIndex</span><span class="p">;</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&lt;</span> <span class="n">NO_OF_QUEUES</span><span class="p">;</span> <span class="n">uiLoopIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiThreshold</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_DUMP_PACKET_INFO</span>:
		<span class="n">DumpPackInfo</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="n">DumpPhsRules</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stBCMPhsContext</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_GET_PACK_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PacketInfo</span><span class="p">)</span><span class="o">*</span><span class="n">NO_OF_QUEUES</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_SWITCH_TRANSFER_MODE</span>: <span class="p">{</span>
		<span class="n">UINT</span> <span class="n">uiData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uiData</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uiData</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Allow All Packets */</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_SWITCH_TRANSFER_MODE: ETH_PACKET_TUNNELING_MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TransferMode</span> <span class="o">=</span> <span class="n">ETH_PACKET_TUNNELING_MODE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Allow IP only Packets */</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_SWITCH_TRANSFER_MODE: IP_PACKET_ONLY_MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TransferMode</span> <span class="o">=</span> <span class="n">IP_PACKET_ONLY_MODE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_DRIVER_VERSION</span>: <span class="p">{</span>
		<span class="n">ulong</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">ulong</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">VER_FILEVERSION_STR</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="n">VER_FILEVERSION_STR</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_CURRENT_STATUS</span>: <span class="p">{</span>
		<span class="n">LINK_STATE</span> <span class="n">link_state</span><span class="p">;</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;copy_from_user failed..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link_state</span><span class="p">));</span>
		<span class="n">link_state</span><span class="p">.</span><span class="n">bIdleMode</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">;</span>
		<span class="n">link_state</span><span class="p">.</span><span class="n">bShutdownMode</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span><span class="p">;</span>
		<span class="n">link_state</span><span class="p">.</span><span class="n">ucLinkStatus</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_state</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link_state</span><span class="p">),</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy_to_user Failed..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_SET_MAC_TRACING</span>: <span class="p">{</span>
		<span class="n">UINT</span>  <span class="n">tracing_flag</span><span class="p">;</span>

		<span class="cm">/* copy ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tracing_flag</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tracing_flag</span><span class="p">)</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pTarangs</span><span class="o">-&gt;</span><span class="n">MacTracingEnabled</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pTarangs</span><span class="o">-&gt;</span><span class="n">MacTracingEnabled</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_DSX_INDICATION</span>: <span class="p">{</span>
		<span class="n">ULONG</span> <span class="n">ulSFId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stLocalSFAddIndicationAlt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;Mismatch req: %lx needed is =0x%zx!!!&quot;</span><span class="p">,</span>
					<span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stLocalSFAddIndicationAlt</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ulSFId</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ulSFId</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Get DSX Data SF ID is =%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ulSFId</span><span class="p">);</span>
		<span class="n">get_dsx_sf_data_to_application</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">ulSFId</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_HOST_MIBS</span>: <span class="p">{</span>
		<span class="n">PVOID</span> <span class="n">temp_buff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_MIBS_HOST_STATS_MIBS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="s">&quot;Length Check failed %lu %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_MIBS_HOST_STATS_MIBS</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* FIXME: HOST_STATS are too big for kmalloc (122048)! */</span>
		<span class="n">temp_buff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">S_MIBS_HOST_STATS_MIBS</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_buff</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">ProcessGetHostMibs</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">temp_buff</span><span class="p">);</span>
		<span class="n">GetDroppedAppCntrlPktMibs</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">,</span> <span class="n">pTarang</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_FAILURE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="n">temp_buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_MIBS_HOST_STATS_MIBS</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">temp_buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_WAKE_UP_DEVICE_FROM_IDLE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bTriedToWakeUpFromlowPowerMode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usIdleModePattern</span> <span class="o">=</span> <span class="n">ABORT_IDLE_MODE</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bWakeUpDevice</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">process_rx_cntrlpkt</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_BULK_WRM</span>: <span class="p">{</span>
		<span class="n">PBULKWRM_BUFFER</span> <span class="n">pBulkBuffer</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">uiTempVar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">PCHAR</span> <span class="n">pvBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Device in Idle/Shutdown Mode, Blocking Wrms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">pvBuffer</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span>
				       <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">);</span>

		<span class="n">pBulkBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBULKWRM_BUFFER</span><span class="p">)</span><span class="n">pvBuffer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="mh">0x0F000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0F000000</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;WRM Done On invalid Address : %x Access Denied.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Register</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">uiTempVar</span> <span class="o">=</span> <span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Register</span> <span class="o">&amp;</span> <span class="n">EEPROM_REJECT_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">m_u32Customize</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VSG_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_1</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_2</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_3</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">uiTempVar</span> <span class="o">==</span> <span class="n">EEPROM_REJECT_REG_4</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">IOCTL_BCM_REGISTER_WRITE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;EEPROM Access Denied, not in VSG Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">SwapEndian</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Register</span><span class="p">,</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Values</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Register</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">pBulkBuffer</span><span class="o">-&gt;</span><span class="n">Values</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;WRM Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">pvBuffer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_NVM_SIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">==</span> <span class="n">NVM_EEPROM</span> <span class="o">||</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">==</span> <span class="n">NVM_FLASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiNVMDSDSize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_CAL_INIT</span>: <span class="p">{</span>
		<span class="n">UINT</span> <span class="n">uiSectorSize</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">==</span> <span class="n">NVM_FLASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uiSectorSize</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">uiSectorSize</span> <span class="o">&lt;</span> <span class="n">MIN_SECTOR_SIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">uiSectorSize</span> <span class="o">&gt;</span> <span class="n">MAX_SECTOR_SIZE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">)))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span> <span class="o">=</span> <span class="n">uiSectorSize</span><span class="p">;</span>
					<span class="n">BcmUpdateSectorSize</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_SET_DEBUG</span>:
<span class="cp">#ifdef DEBUG</span>
	<span class="p">{</span>
		<span class="n">USER_BCM_DBG_STATE</span> <span class="n">sUserDebugState</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;In SET_DEBUG ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sUserDebugState</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">USER_BCM_DBG_STATE</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_SET_DEBUG: OnOff=%d Type = 0x%x &quot;</span><span class="p">,</span>
				<span class="n">sUserDebugState</span><span class="p">.</span><span class="n">OnOff</span><span class="p">,</span> <span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Type</span><span class="p">);</span>
		<span class="cm">/* sUserDebugState.Subtype &lt;&lt;= 1; */</span>
		<span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Subtype</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Subtype</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;actual Subtype=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Subtype</span><span class="p">);</span>

		<span class="cm">/* Update new &#39;DebugState&#39; in the Adapter */</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stDebugState</span><span class="p">.</span><span class="n">type</span> <span class="o">|=</span> <span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Type</span><span class="p">;</span>
		<span class="cm">/* Subtype: A bitmap of 32 bits for Subtype per Type.</span>
<span class="cm">		 * Valid indexes in &#39;subtype&#39; array: 1,2,4,8</span>
<span class="cm">		 * corresponding to valid Type values. Hence we can use the &#39;Type&#39; field</span>
<span class="cm">		 * as the index value, ignoring the array entries 0,3,5,6,7 !</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sUserDebugState</span><span class="p">.</span><span class="n">OnOff</span><span class="p">)</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stDebugState</span><span class="p">.</span><span class="n">subtype</span><span class="p">[</span><span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Type</span><span class="p">]</span> <span class="o">|=</span> <span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Subtype</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stDebugState</span><span class="p">.</span><span class="n">subtype</span><span class="p">[</span><span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Type</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">sUserDebugState</span><span class="p">.</span><span class="n">Subtype</span><span class="p">;</span>

		<span class="n">BCM_SHOW_DEBUG_BITMAP</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_NVM_READ</span>:
	<span class="k">case</span> <span class="n">IOCTL_BCM_NVM_WRITE</span>: <span class="p">{</span>
		<span class="n">NVM_READWRITE</span>  <span class="n">stNVMReadWrite</span><span class="p">;</span>
		<span class="n">PUCHAR</span> <span class="n">pReadData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ULONG</span> <span class="n">ulDSDMagicNumInUsrBuff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv0</span><span class="p">,</span> <span class="n">tv1</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">==</span> <span class="n">NVM_FLASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiFlashLayoutMajorVersion</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;The Flash Control Section is Corrupted. Hence Rejection on NVM Read/Write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eActiveDSD</span> <span class="o">!=</span> <span class="n">DSD0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eActiveDSD</span> <span class="o">!=</span> <span class="n">DSD1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eActiveDSD</span> <span class="o">!=</span> <span class="n">DSD2</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;No DSD is active..hence NVM Command is blocked&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stNVMReadWrite</span><span class="p">,</span>
					<span class="p">(</span><span class="n">IOCTL_BCM_NVM_READ</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">?</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span> <span class="o">:</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">NVM_READWRITE</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Deny the access if the offset crosses the cal area limit.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span> <span class="o">&gt;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiNVMDSDSize</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiOffset</span> <span class="o">&gt;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiNVMDSDSize</span> <span class="o">-</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0,&quot;Can&#39;t allow access beyond NVM Size: 0x%x 0x%x\n&quot;, stNVMReadWrite.uiOffset, stNVMReadWrite.uiNumBytes); */</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pReadData</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">pBuffer</span><span class="p">,</span>
					<span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pReadData</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>

		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IOCTL_BCM_NVM_READ</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">Status</span> <span class="o">=</span> <span class="n">BeceemNVMRead</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">pReadData</span><span class="p">,</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiOffset</span><span class="p">,</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">pBuffer</span><span class="p">,</span> <span class="n">pReadData</span><span class="p">,</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bHeaderChangeAllowed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *			New Requirement:-</span>
<span class="cm">				 *			DSD section updation will be allowed in two case:-</span>
<span class="cm">				 *			1.  if DSD sig is present in DSD header means dongle is ok and updation is fruitfull</span>
<span class="cm">				 *			2.  if point 1 failes then user buff should have DSD sig. this point ensures that if dongle is</span>
<span class="cm">				 *			      corrupted then user space program first modify the DSD header with valid DSD sig so</span>
<span class="cm">				 *			      that this as well as further write may be worthwhile.</span>
<span class="cm">				 *</span>
<span class="cm">				 *			 This restriction has been put assuming that if DSD sig is corrupted, DSD</span>
<span class="cm">				 *			 data won&#39;t be considered valid.</span>
<span class="cm">				 */</span>

				<span class="n">Status</span> <span class="o">=</span> <span class="n">BcmFlash2xCorruptSig</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eActiveDSD</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiOffset</span> <span class="o">+</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiNVMDSDSize</span><span class="p">)</span> <span class="o">||</span>
						<span class="p">(</span><span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span> <span class="o">&lt;</span> <span class="n">SIGNATURE_SIZE</span><span class="p">))</span> <span class="p">{</span>

						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;DSD Sig is present neither in Flash nor User provided Input..&quot;</span><span class="p">);</span>
						<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">ulDSDMagicNumInUsrBuff</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">PUINT</span><span class="p">)(</span><span class="n">pReadData</span> <span class="o">+</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span> <span class="o">-</span> <span class="n">SIGNATURE_SIZE</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ulDSDMagicNumInUsrBuff</span> <span class="o">!=</span> <span class="n">DSD_IMAGE_MAGIC_NUMBER</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;DSD Sig is present neither in Flash nor User provided Input..&quot;</span><span class="p">);</span>
						<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">Status</span> <span class="o">=</span> <span class="n">BeceemNVMWrite</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">pReadData</span><span class="p">,</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiOffset</span><span class="p">,</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">uiNumBytes</span><span class="p">,</span> <span class="n">stNVMReadWrite</span><span class="p">.</span><span class="n">bVerify</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">))</span>
				<span class="n">BcmFlash2xWriteSig</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eActiveDSD</span><span class="p">);</span>

			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bHeaderChangeAllowed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv1</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot; timetaken by Write/read :%ld msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tv1</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">tv0</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="n">tv1</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">tv0</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">pReadData</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_FLASH2X_SECTION_READ</span>: <span class="p">{</span>
		<span class="n">FLASH2X_READWRITE</span> <span class="n">sFlash2xRead</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">PUCHAR</span> <span class="n">pReadBuff</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
		<span class="n">UINT</span> <span class="n">NOB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">BuffSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">ReadBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">ReadOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">OutPutBuff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flash Does not have 2.x map&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_FLASH2X_SECTION_READ Called&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="cm">/* Reading FLASH 2.x READ structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFlash2xRead</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_READWRITE</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.Section :%x&quot;</span><span class="p">,</span> <span class="n">sFlash2xRead</span><span class="p">.</span><span class="n">Section</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.offset :%x&quot;</span><span class="p">,</span> <span class="n">sFlash2xRead</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.numOfBytes :%x&quot;</span><span class="p">,</span> <span class="n">sFlash2xRead</span><span class="p">.</span><span class="n">numOfBytes</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.bVerify :%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sFlash2xRead</span><span class="p">.</span><span class="n">bVerify</span><span class="p">);</span>

		<span class="cm">/* This was internal to driver for raw read. now it has ben exposed to user space app. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">validateFlash2xReadWrite</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sFlash2xRead</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

		<span class="n">NOB</span> <span class="o">=</span> <span class="n">sFlash2xRead</span><span class="p">.</span><span class="n">numOfBytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&gt;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">)</span>
			<span class="n">BuffSize</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BuffSize</span> <span class="o">=</span> <span class="n">NOB</span><span class="p">;</span>

		<span class="n">ReadOffset</span> <span class="o">=</span> <span class="n">sFlash2xRead</span><span class="p">.</span><span class="n">offset</span> <span class="p">;</span>
		<span class="n">OutPutBuff</span> <span class="o">=</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">;</span>
		<span class="n">pReadBuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">kzalloc</span><span class="p">(</span><span class="n">BuffSize</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pReadBuff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed for Flash 2.x Read Structure&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pReadBuff</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">NOB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&gt;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">)</span>
				<span class="n">ReadBytes</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ReadBytes</span> <span class="o">=</span> <span class="n">NOB</span><span class="p">;</span>

			<span class="cm">/* Reading the data from Flash 2.x */</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">BcmFlash2xBulkRead</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">pReadBuff</span><span class="p">,</span> <span class="n">sFlash2xRead</span><span class="p">.</span><span class="n">Section</span><span class="p">,</span> <span class="n">ReadOffset</span><span class="p">,</span> <span class="n">ReadBytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Flash 2x read err with Status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">BCM_DEBUG_PRINT_BUFFER</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="n">pReadBuff</span><span class="p">,</span> <span class="n">ReadBytes</span><span class="p">);</span>

			<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">OutPutBuff</span><span class="p">,</span> <span class="n">pReadBuff</span><span class="p">,</span> <span class="n">ReadBytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Copy to use failed with status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pReadBuff</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">NOB</span> <span class="o">=</span> <span class="n">NOB</span> <span class="o">-</span> <span class="n">ReadBytes</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ReadOffset</span> <span class="o">=</span> <span class="n">ReadOffset</span> <span class="o">+</span> <span class="n">ReadBytes</span><span class="p">;</span>
				<span class="n">OutPutBuff</span> <span class="o">=</span> <span class="n">OutPutBuff</span> <span class="o">+</span> <span class="n">ReadBytes</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pReadBuff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_FLASH2X_SECTION_WRITE</span>: <span class="p">{</span>
		<span class="n">FLASH2X_READWRITE</span> <span class="n">sFlash2xWrite</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">PUCHAR</span> <span class="n">pWriteBuff</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">InputAddr</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">NOB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">BuffSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">WriteOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">WriteBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flash Does not have 2.x map&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* First make this False so that we can enable the Sector Permission Check in BeceemFlashBulkWrite */</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bAllDSDWriteAllow</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_FLASH2X_SECTION_WRITE Called&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="cm">/* Reading FLASH 2.x READ structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sFlash2xWrite</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_READWRITE</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.Section :%x&quot;</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">Section</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.offset :%d&quot;</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.numOfBytes :%x&quot;</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">numOfBytes</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sFlash2xRead.bVerify :%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">bVerify</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">Section</span> <span class="o">!=</span> <span class="n">VSA0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">Section</span> <span class="o">!=</span> <span class="n">VSA1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">Section</span> <span class="o">!=</span> <span class="n">VSA2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Only VSA write is allowed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">validateFlash2xReadWrite</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sFlash2xWrite</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

		<span class="n">InputAddr</span> <span class="o">=</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">pDataBuff</span><span class="p">;</span>
		<span class="n">WriteOffset</span> <span class="o">=</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">NOB</span> <span class="o">=</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">numOfBytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&gt;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">)</span>
			<span class="n">BuffSize</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BuffSize</span> <span class="o">=</span> <span class="n">NOB</span> <span class="p">;</span>

		<span class="n">pWriteBuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BuffSize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pWriteBuff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* extracting the remainder of the given offset. */</span>
		<span class="n">WriteBytes</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WriteOffset</span> <span class="o">%</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">)</span>
			<span class="n">WriteBytes</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span> <span class="o">-</span> <span class="p">(</span><span class="n">WriteOffset</span> <span class="o">%</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&lt;</span> <span class="n">WriteBytes</span><span class="p">)</span>
			<span class="n">WriteBytes</span> <span class="o">=</span> <span class="n">NOB</span><span class="p">;</span>

		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pWriteBuff</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BcmFlash2xCorruptSig</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">Section</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">pWriteBuff</span><span class="p">,</span> <span class="n">InputAddr</span><span class="p">,</span> <span class="n">WriteBytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy to user failed with status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pWriteBuff</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">BCM_DEBUG_PRINT_BUFFER</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="n">pWriteBuff</span><span class="p">,</span> <span class="n">WriteBytes</span><span class="p">);</span>

			<span class="cm">/* Writing the data from Flash 2.x */</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">BcmFlash2xBulkWrite</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">pWriteBuff</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">Section</span><span class="p">,</span> <span class="n">WriteOffset</span><span class="p">,</span> <span class="n">WriteBytes</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">bVerify</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flash 2x read err with Status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">NOB</span> <span class="o">=</span> <span class="n">NOB</span> <span class="o">-</span> <span class="n">WriteBytes</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WriteOffset</span> <span class="o">=</span> <span class="n">WriteOffset</span> <span class="o">+</span> <span class="n">WriteBytes</span><span class="p">;</span>
				<span class="n">InputAddr</span> <span class="o">=</span> <span class="n">InputAddr</span> <span class="o">+</span> <span class="n">WriteBytes</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&gt;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">)</span>
					<span class="n">WriteBytes</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSize</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">WriteBytes</span> <span class="o">=</span> <span class="n">NOB</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">BcmFlash2xWriteSig</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">sFlash2xWrite</span><span class="p">.</span><span class="n">Section</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pWriteBuff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_FLASH2X_SECTION_BITMAP</span>: <span class="p">{</span>
		<span class="n">PFLASH2X_BITMAP</span> <span class="n">psFlash2xBitMap</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_GET_FLASH2X_SECTION_BITMAP Called&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_BITMAP</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">psFlash2xBitMap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_BITMAP</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psFlash2xBitMap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Memory is not available&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Reading the Flash Sectio Bit map */</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psFlash2xBitMap</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BcmGetFlash2xSectionalBitMap</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">psFlash2xBitMap</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="n">psFlash2xBitMap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_BITMAP</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">psFlash2xBitMap</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">psFlash2xBitMap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_SET_ACTIVE_SECTION</span>: <span class="p">{</span>
		<span class="n">FLASH2X_SECTION_VAL</span> <span class="n">eFlash2xSectionVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_SET_ACTIVE_SECTION Called&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flash Does not have 2.x map&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy of IOCTL BUFFER failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eFlash2xSectionVal</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">INT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy of flash section val failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">BcmSetActiveSection</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">eFlash2xSectionVal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Failed to make it&#39;s priority Highest. Status %d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>

		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_IDENTIFY_ACTIVE_SECTION</span>: <span class="p">{</span>
		<span class="cm">/* Right Now we are taking care of only DSD */</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bAllDSDWriteAllow</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_IDENTIFY_ACTIVE_SECTION called&quot;</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_COPY_SECTION</span>: <span class="p">{</span>
		<span class="n">FLASH2X_COPY_SECTION</span> <span class="n">sCopySectStrut</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_COPY_SECTION  Called&quot;</span><span class="p">);</span>

		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bAllDSDWriteAllow</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flash Does not have 2.x map&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy of IOCTL BUFFER failed Status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sCopySectStrut</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_COPY_SECTION</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy of Copy_Section_Struct failed with Status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Source SEction :%x&quot;</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">SrcSection</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Destination SEction :%x&quot;</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">DstSection</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;offset :%x&quot;</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;NOB :%x&quot;</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">numOfBytes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsSectionExistInFlash</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">SrcSection</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Source Section&lt;%x&gt; does not exixt in Flash &quot;</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">SrcSection</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsSectionExistInFlash</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">DstSection</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Destinatio Section&lt;%x&gt; does not exixt in Flash &quot;</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">DstSection</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">SrcSection</span> <span class="o">==</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">DstSection</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Source and Destination section should be different&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">SrcSection</span> <span class="o">==</span> <span class="n">ISO_IMAGE1</span> <span class="o">||</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">SrcSection</span> <span class="o">==</span> <span class="n">ISO_IMAGE2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IsNonCDLessDevice</span><span class="p">(</span><span class="n">Adapter</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Device is Non-CDLess hence won&#39;t have ISO !!&quot;</span><span class="p">);</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">numOfBytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">BcmCopyISO</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Partial Copy of ISO section is not Allowed..&quot;</span><span class="p">);</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">BcmCopySection</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">SrcSection</span><span class="p">,</span>
					<span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">DstSection</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">sCopySectStrut</span><span class="p">.</span><span class="n">numOfBytes</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_FLASH_CS_INFO</span>: <span class="p">{</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot; IOCTL_BCM_GET_FLASH_CS_INFO Called&quot;</span><span class="p">);</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy of IOCTL BUFFER failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">!=</span> <span class="n">NVM_FLASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Connected device does not have flash&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_CS_INFO</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">psFlash2xCSInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH2X_CS_INFO</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH_CS_INFO</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">psFlashCSInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FLASH_CS_INFO</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_SELECT_DSD</span>: <span class="p">{</span>
		<span class="n">UINT</span> <span class="n">SectOfset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">FLASH2X_SECTION_VAL</span> <span class="n">eFlash2xSectionVal</span><span class="p">;</span>
		<span class="n">eFlash2xSectionVal</span> <span class="o">=</span> <span class="n">NO_SECTION_VAL</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_SELECT_DSD Called&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsFlash2x</span><span class="p">(</span><span class="n">Adapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flash Does not have 2.x map&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy of IOCTL BUFFER failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eFlash2xSectionVal</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">INT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy of flash section val failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Read Section :%d&quot;</span><span class="p">,</span> <span class="n">eFlash2xSectionVal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">eFlash2xSectionVal</span> <span class="o">!=</span> <span class="n">DSD0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">eFlash2xSectionVal</span> <span class="o">!=</span> <span class="n">DSD1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">eFlash2xSectionVal</span> <span class="o">!=</span> <span class="n">DSD2</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Passed section&lt;%x&gt; is not DSD section&quot;</span><span class="p">,</span> <span class="n">eFlash2xSectionVal</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">SectOfset</span> <span class="o">=</span> <span class="n">BcmGetSectionValStartOffset</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">eFlash2xSectionVal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SectOfset</span> <span class="o">==</span> <span class="n">INVALID_OFFSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Provided Section val &lt;%d&gt; does not exixt in Flash 2.x&quot;</span><span class="p">,</span> <span class="n">eFlash2xSectionVal</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bAllDSDWriteAllow</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulFlashCalStart</span> <span class="o">=</span> <span class="n">SectOfset</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eActiveDSD</span> <span class="o">=</span> <span class="n">eFlash2xSectionVal</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_NVM_RAW_READ</span>: <span class="p">{</span>
		<span class="n">NVM_READWRITE</span> <span class="n">stNVMRead</span><span class="p">;</span>
		<span class="n">INT</span> <span class="n">NOB</span> <span class="p">;</span>
		<span class="n">INT</span> <span class="n">BuffSize</span> <span class="p">;</span>
		<span class="n">INT</span> <span class="n">ReadOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">UINT</span> <span class="n">ReadBytes</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">PUCHAR</span> <span class="n">pReadBuff</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">OutPutBuff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">!=</span> <span class="n">NVM_FLASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;NVM TYPE is not Flash&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;copy_from_user 1 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stNVMRead</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NVM_READWRITE</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">NOB</span> <span class="o">=</span> <span class="n">stNVMRead</span><span class="p">.</span><span class="n">uiNumBytes</span><span class="p">;</span>
		<span class="cm">/* In Raw-Read max Buff size : 64MB */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&gt;</span> <span class="n">DEFAULT_BUFF_SIZE</span><span class="p">)</span>
			<span class="n">BuffSize</span> <span class="o">=</span> <span class="n">DEFAULT_BUFF_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">BuffSize</span> <span class="o">=</span> <span class="n">NOB</span><span class="p">;</span>

		<span class="n">ReadOffset</span> <span class="o">=</span> <span class="n">stNVMRead</span><span class="p">.</span><span class="n">uiOffset</span><span class="p">;</span>
		<span class="n">OutPutBuff</span> <span class="o">=</span> <span class="n">stNVMRead</span><span class="p">.</span><span class="n">pBuffer</span><span class="p">;</span>

		<span class="n">pReadBuff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">BuffSize</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pReadBuff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed for Flash 2.x Read Structure&quot;</span><span class="p">);</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device is in Idle/Shutdown Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pReadBuff</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bFlashRawRead</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">NOB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span> <span class="o">&gt;</span> <span class="n">DEFAULT_BUFF_SIZE</span><span class="p">)</span>
				<span class="n">ReadBytes</span> <span class="o">=</span> <span class="n">DEFAULT_BUFF_SIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ReadBytes</span> <span class="o">=</span> <span class="n">NOB</span><span class="p">;</span>

			<span class="cm">/* Reading the data from Flash 2.x */</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="n">BeceemNVMRead</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">pReadBuff</span><span class="p">,</span> <span class="n">ReadOffset</span><span class="p">,</span> <span class="n">ReadBytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Flash 2x read err with Status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">BCM_DEBUG_PRINT_BUFFER</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="n">pReadBuff</span><span class="p">,</span> <span class="n">ReadBytes</span><span class="p">);</span>

			<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">OutPutBuff</span><span class="p">,</span> <span class="n">pReadBuff</span><span class="p">,</span> <span class="n">ReadBytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Copy to use failed with status :%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pReadBuff</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">NOB</span> <span class="o">=</span> <span class="n">NOB</span> <span class="o">-</span> <span class="n">ReadBytes</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NOB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ReadOffset</span> <span class="o">=</span> <span class="n">ReadOffset</span> <span class="o">+</span> <span class="n">ReadBytes</span><span class="p">;</span>
				<span class="n">OutPutBuff</span> <span class="o">=</span> <span class="n">OutPutBuff</span> <span class="o">+</span> <span class="n">ReadBytes</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bFlashRawRead</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pReadBuff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_CNTRLMSG_MASK</span>: <span class="p">{</span>
		<span class="n">ULONG</span> <span class="n">RxCntrlMsgBitMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Copy Ioctl Buffer structure */</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;copy of Ioctl buffer is failed from user space&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">Status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RxCntrlMsgBitMask</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputBuffer</span><span class="p">,</span> <span class="n">IoBuffer</span><span class="p">.</span><span class="n">InputLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;copy of control bit mask failed from user space&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> Got user defined cntrl msg bit mask :%lx&quot;</span><span class="p">,</span> <span class="n">RxCntrlMsgBitMask</span><span class="p">);</span>
		<span class="n">pTarang</span><span class="o">-&gt;</span><span class="n">RxCntrlMsgBitMask</span> <span class="o">=</span> <span class="n">RxCntrlMsgBitMask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_GET_DEVICE_DRIVER_INFO</span>: <span class="p">{</span>
		<span class="n">DEVICE_DRIVER_INFO</span> <span class="n">DevInfo</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Called IOCTL_BCM_GET_DEVICE_DRIVER_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">DevInfo</span><span class="p">.</span><span class="n">MaxRDMBufferSize</span> <span class="o">=</span> <span class="n">BUFFER_4K</span><span class="p">;</span>
		<span class="n">DevInfo</span><span class="p">.</span><span class="n">u32DSDStartOffset</span> <span class="o">=</span> <span class="n">EEPROM_CALPARAM_START</span><span class="p">;</span>
		<span class="n">DevInfo</span><span class="p">.</span><span class="n">u32RxAlignmentCorrection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DevInfo</span><span class="p">.</span><span class="n">u32NVMType</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span><span class="p">;</span>
		<span class="n">DevInfo</span><span class="p">.</span><span class="n">u32InterfaceType</span> <span class="o">=</span> <span class="n">BCM_USB</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DevInfo</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DevInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DevInfo</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_BCM_TIME_SINCE_NET_ENTRY</span>: <span class="p">{</span>
		<span class="n">ST_TIME_ELAPSED</span> <span class="n">stTimeElapsedSinceNetEntry</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_BCM_TIME_SINCE_NET_ENTRY called&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IoBuffer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_BUFFER</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ST_TIME_ELAPSED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">stTimeElapsedSinceNetEntry</span><span class="p">.</span><span class="n">ul64TimeElapsedSinceNetEntry</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">liTimeSinceLastNetEntry</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">IoBuffer</span><span class="p">.</span><span class="n">OutputBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stTimeElapsedSinceNetEntry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ST_TIME_ELAPSED</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCTL_CLOSE_NOTIFICATION</span>:
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">OSAL_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IOCTL_CLOSE_NOTIFICATION&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: unknown ioctl cmd=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">bcm_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>    <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>     <span class="o">=</span> <span class="n">bcm_char_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>  <span class="o">=</span> <span class="n">bcm_char_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>     <span class="o">=</span> <span class="n">bcm_char_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>    <span class="o">=</span> <span class="n">bcm_char_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">register_control_device_interface</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>

	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcm_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: could not created character device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstCreatedClassDevice</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">bcm_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">MKDEV</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
						<span class="n">Adapter</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstCreatedClassDevice</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: class device create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstCreatedClassDevice</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">unregister_control_device_interface</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_destroy</span><span class="p">(</span><span class="n">bcm_class</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
