<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › bcm › Qos.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>Qos.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm">@file Qos.C</span>
<span class="cm">This file contains the routines related to Quality of Service.</span>
<span class="cm">*/</span>
<span class="cp">#include &quot;headers.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">EThCSGetPktInfo</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span><span class="n">PVOID</span> <span class="n">pvEthPayload</span><span class="p">,</span><span class="n">PS_ETHCS_PKT_INFO</span> <span class="n">pstEthCsPktInfo</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="n">EThCSClassifyPkt</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">,</span><span class="n">PS_ETHCS_PKT_INFO</span> <span class="n">pstEthCsPktInfo</span><span class="p">,</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span> <span class="n">B_UINT8</span> <span class="n">EthCSCupport</span><span class="p">);</span>

<span class="k">static</span> <span class="n">USHORT</span>	<span class="n">IpVersion4</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iphd</span><span class="p">,</span>
			   <span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span> <span class="p">);</span>

<span class="k">static</span> <span class="n">VOID</span> <span class="n">PruneQueue</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">INT</span> <span class="n">iIndex</span><span class="p">);</span>


<span class="cm">/*******************************************************************</span>
<span class="cm">* Function    - MatchSrcIpAddress()</span>
<span class="cm">*</span>
<span class="cm">* Description - Checks whether the Source IP address from the packet</span>
<span class="cm">*				matches with that of Queue.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - pstClassifierRule: Pointer to the packet info structure.</span>
<span class="cm">* 			  - ulSrcIP	    : Source IP address from the packet.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - TRUE(If address matches) else FAIL .</span>
<span class="cm">*********************************************************************/</span>
<span class="n">BOOLEAN</span> <span class="nf">MatchSrcIpAddress</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">ULONG</span> <span class="n">ulSrcIP</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UCHAR</span> 	<span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>

    <span class="n">ulSrcIP</span><span class="o">=</span><span class="n">ntohl</span><span class="p">(</span><span class="n">ulSrcIP</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucIPSourceAddressLength</span><span class="p">)</span>
       	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ucLoopIndex</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucIPSourceAddressLength</span><span class="p">);</span><span class="n">ucLoopIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Src Ip Address Mask:0x%x PacketIp:0x%x and Classification:0x%x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">],</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">ulSrcIP</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv6Addr</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ulSrcIP</span><span class="p">)</span><span class="o">==</span>
				<span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv4Addr</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span> <span class="p">))</span>
       	<span class="p">{</span>
       		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
       	<span class="p">}</span>
    <span class="p">}</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Src Ip Address Not Matched&quot;</span><span class="p">);</span>
   	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*******************************************************************</span>
<span class="cm">* Function    - MatchDestIpAddress()</span>
<span class="cm">*</span>
<span class="cm">* Description - Checks whether the Destination IP address from the packet</span>
<span class="cm">*				matches with that of Queue.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - pstClassifierRule: Pointer to the packet info structure.</span>
<span class="cm">* 			  - ulDestIP    : Destination IP address from the packet.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - TRUE(If address matches) else FAIL .</span>
<span class="cm">*********************************************************************/</span>
<span class="n">BOOLEAN</span> <span class="nf">MatchDestIpAddress</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">ULONG</span> <span class="n">ulDestIP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UCHAR</span> 	<span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span>	<span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>

	<span class="n">ulDestIP</span><span class="o">=</span><span class="n">ntohl</span><span class="p">(</span><span class="n">ulDestIP</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucIPDestinationAddressLength</span><span class="p">)</span>
       	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Destination Ip Address 0x%x 0x%x 0x%x  &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">ulDestIP</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">],</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv4Addr</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]);</span>

    <span class="k">for</span><span class="p">(</span><span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ucLoopIndex</span><span class="o">&lt;</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucIPDestinationAddressLength</span><span class="p">);</span><span class="n">ucLoopIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ulDestIP</span><span class="p">)</span><span class="o">==</span>
					<span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv4Addr</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]))</span>
       	<span class="p">{</span>
       		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
       	<span class="p">}</span>
    <span class="p">}</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Destination Ip Address Not Matched&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************************************************************</span>
<span class="cm">* Function    - MatchTos()</span>
<span class="cm">*</span>
<span class="cm">* Description - Checks the TOS from the packet matches with that of queue.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - pstClassifierRule   : Pointer to the packet info structure.</span>
<span class="cm">* 			  - ucTypeOfService: TOS from the packet.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - TRUE(If address matches) else FAIL.</span>
<span class="cm">**************************************************************************/</span>
<span class="n">BOOLEAN</span> <span class="nf">MatchTos</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">UCHAR</span> <span class="n">ucTypeOfService</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="mi">3</span> <span class="o">!=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucIPTypeOfServiceLength</span> <span class="p">)</span>
       	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucTosMask</span> <span class="o">&amp;</span> <span class="n">ucTypeOfService</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucTosHigh</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucTosMask</span> <span class="o">&amp;</span> <span class="n">ucTypeOfService</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucTosLow</span><span class="p">))</span>
    <span class="p">{</span>
       	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Type Of Service Not Matched&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">* Function    - MatchProtocol()</span>
<span class="cm">*</span>
<span class="cm">* Description - Checks the protocol from the packet matches with that of queue.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - pstClassifierRule: Pointer to the packet info structure.</span>
<span class="cm">* 			  - ucProtocol	: Protocol from the packet.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - TRUE(If address matches) else FAIL.</span>
<span class="cm">****************************************************************************/</span>
<span class="n">BOOLEAN</span> <span class="nf">MatchProtocol</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">UCHAR</span> <span class="n">ucProtocol</span><span class="p">)</span>
<span class="p">{</span>
   	<span class="n">UCHAR</span> 	<span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucProtocolLength</span><span class="p">)</span>
      	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ucLoopIndex</span><span class="o">&lt;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucProtocolLength</span><span class="p">;</span><span class="n">ucLoopIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
       	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Protocol:0x%X Classification Protocol:0x%X&quot;</span><span class="p">,</span><span class="n">ucProtocol</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucProtocol</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]);</span>
       	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucProtocol</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span><span class="o">==</span><span class="n">ucProtocol</span><span class="p">)</span>
       	<span class="p">{</span>
       		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
       	<span class="p">}</span>
    <span class="p">}</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Protocol Not Matched&quot;</span><span class="p">);</span>
   	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***********************************************************************</span>
<span class="cm">* Function    - MatchSrcPort()</span>
<span class="cm">*</span>
<span class="cm">* Description - Checks, Source port from the packet matches with that of queue.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - pstClassifierRule: Pointer to the packet info structure.</span>
<span class="cm">* 			  - ushSrcPort	: Source port from the packet.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - TRUE(If address matches) else FAIL.</span>
<span class="cm">***************************************************************************/</span>
<span class="n">BOOLEAN</span> <span class="nf">MatchSrcPort</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">USHORT</span> <span class="n">ushSrcPort</span><span class="p">)</span>
<span class="p">{</span>
    	<span class="n">UCHAR</span> 	<span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

		<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>


    	<span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucSrcPortRangeLength</span><span class="p">)</span>
        	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    	<span class="k">for</span><span class="p">(</span><span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ucLoopIndex</span><span class="o">&lt;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucSrcPortRangeLength</span><span class="p">;</span><span class="n">ucLoopIndex</span><span class="o">++</span><span class="p">)</span>
    	<span class="p">{</span>
        	<span class="k">if</span><span class="p">(</span><span class="n">ushSrcPort</span> <span class="o">&lt;=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usSrcPortRangeHi</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ushSrcPort</span> <span class="o">&gt;=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usSrcPortRangeLo</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">])</span>
	    	<span class="p">{</span>
		    	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	    	<span class="p">}</span>
    	<span class="p">}</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Src Port: %x Not Matched &quot;</span><span class="p">,</span><span class="n">ushSrcPort</span><span class="p">);</span>
    	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***********************************************************************</span>
<span class="cm">* Function    - MatchDestPort()</span>
<span class="cm">*</span>
<span class="cm">* Description - Checks, Destination port from packet matches with that of queue.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - pstClassifierRule: Pointer to the packet info structure.</span>
<span class="cm">* 			  - ushDestPort	: Destination port from the packet.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - TRUE(If address matches) else FAIL.</span>
<span class="cm">***************************************************************************/</span>
<span class="n">BOOLEAN</span> <span class="nf">MatchDestPort</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">USHORT</span> <span class="n">ushDestPort</span><span class="p">)</span>
<span class="p">{</span>
    	<span class="n">UCHAR</span> 	<span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>

    	<span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucDestPortRangeLength</span><span class="p">)</span>
        	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

    	<span class="k">for</span><span class="p">(</span><span class="n">ucLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ucLoopIndex</span><span class="o">&lt;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucDestPortRangeLength</span><span class="p">;</span><span class="n">ucLoopIndex</span><span class="o">++</span><span class="p">)</span>
    	<span class="p">{</span>
        	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Matching Port:0x%X   0x%X  0x%X&quot;</span><span class="p">,</span><span class="n">ushDestPort</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usDestPortRangeLo</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">],</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usDestPortRangeHi</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]);</span>

 		<span class="k">if</span><span class="p">(</span><span class="n">ushDestPort</span> <span class="o">&lt;=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usDestPortRangeHi</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ushDestPort</span> <span class="o">&gt;=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usDestPortRangeLo</span><span class="p">[</span><span class="n">ucLoopIndex</span><span class="p">])</span>
	    	<span class="p">{</span>
		    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	    	<span class="p">}</span>
    	<span class="p">}</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Dest Port: %x Not Matched&quot;</span><span class="p">,</span><span class="n">ushDestPort</span><span class="p">);</span>
    	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm">@ingroup tx_functions</span>
<span class="cm">Compares IPV4 Ip address and port number</span>
<span class="cm">@return Queue Index.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">USHORT</span>	<span class="nf">IpVersion4</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iphd</span><span class="p">,</span>
			   <span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">xporthdr</span>     		<span class="o">*</span><span class="n">xprt_hdr</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">BOOLEAN</span>	<span class="n">bClassificationSucceed</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;========&gt;&quot;</span><span class="p">);</span>

	<span class="n">xprt_hdr</span><span class="o">=</span><span class="p">(</span><span class="n">xporthdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">iphd</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Trying to see Direction = %d %d&quot;</span><span class="p">,</span>
			<span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucDirection</span><span class="p">,</span>
			<span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usVCID_Value</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Checking classifier validity</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">bUsed</span> <span class="o">||</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucDirection</span> <span class="o">==</span> <span class="n">DOWNLINK_DIR</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;is IPv6 check!&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">bIpv6Protocol</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p><strong><em>*</em><em>*</em><em>*</em><em></strong>Checking IP header parameter<strong></em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em><em>*</em></strong>//</p></td><td class="code"><div class="highlight"><pre>		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Trying to match Source IP Address&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">=</span>
			<span class="n">MatchSrcIpAddress</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span> <span class="n">iphd</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Source IP Address Matched&quot;</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">=</span>
			<span class="n">MatchDestIpAddress</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span> <span class="n">iphd</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Destination IP Address Matched&quot;</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">=</span>
			<span class="n">MatchTos</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span> <span class="n">iphd</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;TOS Match failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;TOS Matched&quot;</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">=</span>
			<span class="n">MatchProtocol</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">iphd</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Protocol Matched&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>if protocol is not TCP or UDP then no need of comparing source port and destination port</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">iphd</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">!=</span><span class="n">TCP</span> <span class="o">&amp;&amp;</span> <span class="n">iphd</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">!=</span><span class="n">UDP</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p><strong><em>*</em><em>*</em><em>*</em><em>*</em><em>*</strong>Checking Transport Layer Header field if present <strong></em><em>*</em><em>*</em><em>*</em><em>*</em></strong>//</p></td><td class="code"><div class="highlight"><pre>		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Source Port %04x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">iphd</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">==</span><span class="n">UDP</span><span class="p">)</span><span class="o">?</span><span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">uhdr</span><span class="p">.</span><span class="n">source</span><span class="o">:</span><span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">thdr</span><span class="p">.</span><span class="n">source</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">=</span>
			<span class="n">MatchSrcPort</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span>
				<span class="n">ntohs</span><span class="p">((</span><span class="n">iphd</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">UDP</span><span class="p">)</span><span class="o">?</span>
				<span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">uhdr</span><span class="p">.</span><span class="n">source</span><span class="o">:</span><span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">thdr</span><span class="p">.</span><span class="n">source</span><span class="p">))))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Src Port Matched&quot;</span><span class="p">);</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Destination Port %04x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">iphd</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">==</span><span class="n">UDP</span><span class="p">)</span><span class="o">?</span><span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">uhdr</span><span class="p">.</span><span class="n">dest</span><span class="o">:</span>
			<span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">thdr</span><span class="p">.</span><span class="n">dest</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">=</span>
			<span class="n">MatchDestPort</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">((</span><span class="n">iphd</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">UDP</span><span class="p">)</span><span class="o">?</span>
			<span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">uhdr</span><span class="p">.</span><span class="n">dest</span><span class="o">:</span><span class="n">xprt_hdr</span><span class="o">-&gt;</span><span class="n">thdr</span><span class="p">.</span><span class="n">dest</span><span class="p">))))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">TRUE</span><span class="o">==</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">INT</span> <span class="n">iMatchedSFQueueIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iMatchedSFQueueIndex</span> <span class="o">=</span> <span class="n">SearchSfid</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ulSFID</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">iMatchedSFQueueIndex</span> <span class="o">&gt;=</span> <span class="n">NO_OF_QUEUES</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iMatchedSFQueueIndex</span><span class="p">].</span><span class="n">bActive</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IpVersion4 &lt;==========&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bClassificationSucceed</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">PruneQueueAllSF</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">iIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">iIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iIndex</span> <span class="o">&lt;</span> <span class="n">HiPriority</span><span class="p">;</span> <span class="n">iIndex</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">bValid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">PruneQueue</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">iIndex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm">@ingroup tx_functions</span>
<span class="cm">This function checks if the max queue size for a queue</span>
<span class="cm">is less than number of bytes in the queue. If so -</span>
<span class="cm">drops packets from the Head till the number of bytes is</span>
<span class="cm">less than or equal to max queue size for the queue.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">VOID</span> <span class="nf">PruneQueue</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">INT</span> <span class="n">iIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">PacketToDrop</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">netstats</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">PRUNE_QUEUE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;=====&gt; Index %d&quot;</span><span class="p">,</span><span class="n">iIndex</span><span class="p">);</span>

   	<span class="k">if</span><span class="p">(</span><span class="n">iIndex</span> <span class="o">==</span> <span class="n">HiPriority</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Adapter</span> <span class="o">||</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">&gt;</span> <span class="n">HiPriority</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* To Store the netdevice statistic */</span>
	<span class="n">netstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>while((UINT)Adapter->PackInfo[iIndex].uiCurrentPacketsOnHost >
    SF<em>MAX</em>ALLOWED<em>PACKETS</em>TO_BACKUP)</p></td><td class="code"><div class="highlight"><pre>	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">PRUNE_QUEUE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiCurrentBytesOnHost:%x uiMaxBucketSize :%x&quot;</span><span class="p">,</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiCurrentBytesOnHost</span><span class="p">,</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiMaxBucketSize</span><span class="p">);</span>

		<span class="n">PacketToDrop</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">PacketToDrop</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiCurrentPacketsOnHost</span> <span class="o">&lt;</span> <span class="n">SF_MAX_ALLOWED_PACKETS_TO_BACKUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="o">*</span><span class="p">((</span><span class="n">B_UINT32</span> <span class="o">*</span><span class="p">)(</span><span class="n">PacketToDrop</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span><span class="o">+</span><span class="n">SKB_CB_LATENCY_OFFSET</span><span class="p">))</span><span class="o">/</span><span class="n">HZ</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiMaxLatency</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">PacketToDrop</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">Adapter</span><span class="p">))</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: tx queue %d overlimit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iIndex</span><span class="p">);</span>

			<span class="n">netstats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>

			<span class="n">DEQUEUEPACKET</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span><span class="p">,</span>
						<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">LastTxQueue</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>/ update current bytes and packets count</p></td><td class="code"><div class="highlight"><pre>			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiCurrentBytesOnHost</span> <span class="o">-=</span>
				<span class="n">PacketToDrop</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiCurrentPacketsOnHost</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>/ update dropped bytes and packets counts</p></td><td class="code"><div class="highlight"><pre>			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiDroppedCountBytes</span> <span class="o">+=</span> <span class="n">PacketToDrop</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiDroppedCountPackets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">PacketToDrop</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">PRUNE_QUEUE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Dropped Bytes:%x Dropped Packets:%x&quot;</span><span class="p">,</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiDroppedCountBytes</span><span class="p">,</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiDroppedCountPackets</span><span class="p">);</span>

		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">PRUNE_QUEUE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;TotalPacketCount:%x&quot;</span><span class="p">,</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">));</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">PRUNE_QUEUE</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;&lt;=====&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">flush_all_queues</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INT</span>		<span class="n">iQIndex</span><span class="p">;</span>
	<span class="n">UINT</span>	<span class="n">uiTotalPacketLength</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span>			<span class="n">PacketToDrop</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;=====&gt;&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>down(&amp;Adapter->data<em>packet</em>queue_lock);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span><span class="p">(</span><span class="n">iQIndex</span><span class="o">=</span><span class="n">LowPriority</span><span class="p">;</span> <span class="n">iQIndex</span><span class="o">&lt;</span><span class="n">HiPriority</span><span class="p">;</span> <span class="n">iQIndex</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">netstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">PacketToDrop</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">PacketToDrop</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">uiTotalPacketLength</span> <span class="o">=</span> <span class="n">PacketToDrop</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">netstats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">uiTotalPacketLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">DEQUEUEPACKET</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span><span class="p">,</span>
						<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">LastTxQueue</span><span class="p">);</span>

			<span class="cm">/* Free the skb */</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">PacketToDrop</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>/ update current bytes and packets count</p></td><td class="code"><div class="highlight"><pre>			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiCurrentBytesOnHost</span> <span class="o">-=</span> <span class="n">uiTotalPacketLength</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiCurrentPacketsOnHost</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>/ update dropped bytes and packets counts</p></td><td class="code"><div class="highlight"><pre>			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiDroppedCountBytes</span> <span class="o">+=</span> <span class="n">uiTotalPacketLength</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiDroppedCountPackets</span><span class="o">++</span><span class="p">;</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Dropped Bytes:%x Dropped Packets:%x&quot;</span><span class="p">,</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiDroppedCountBytes</span><span class="p">,</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiDroppedCountPackets</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>up(&amp;Adapter->data<em>packet</em>queue_lock);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;&lt;=====&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">USHORT</span> <span class="nf">ClassifyPacket</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INT</span>			<span class="n">uiLoopIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">S_ETHCS_PKT_INFO</span> <span class="n">stEthCsPktInfo</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">pvEThPayload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> 		<span class="o">*</span><span class="n">pIpHeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INT</span>	  <span class="n">uiSfIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">USHORT</span>	<span class="n">usIndex</span><span class="o">=</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usBestEffortQueueIndex</span><span class="p">;</span>
	<span class="n">BOOLEAN</span>	<span class="n">bFragmentedPkt</span><span class="o">=</span><span class="n">FALSE</span><span class="p">,</span><span class="n">bClassificationSucceed</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
	<span class="n">USHORT</span>	<span class="n">usCurrFragment</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">PTCP_HEADER</span> <span class="n">pTcpHeader</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">IpHeaderLength</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">TcpHeaderLength</span><span class="p">;</span>

	<span class="n">pvEThPayload</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">UINT32</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">+</span><span class="n">SKB_CB_TCPACK_OFFSET</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">EThCSGetPktInfo</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">pvEThPayload</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stEthCsPktInfo</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">stEthCsPktInfo</span><span class="p">.</span><span class="n">eNwpktEthFrameType</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">eEth802LLCFrame</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ClassifyPacket : 802LLCFrame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">pIpHeader</span> <span class="o">=</span> <span class="n">pvEThPayload</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ETH_CS_802_LLC_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">eEth802LLCSNAPFrame</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ClassifyPacket : 802LLC SNAP Frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pIpHeader</span> <span class="o">=</span> <span class="n">pvEThPayload</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ETH_CS_802_LLC_SNAP_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">eEth802QVLANFrame</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ClassifyPacket : 802.1Q VLANFrame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pIpHeader</span> <span class="o">=</span> <span class="n">pvEThPayload</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ETH_CS_802_Q_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">eEthOtherFrame</span>:
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ClassifyPacket : ETH Other Frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pIpHeader</span> <span class="o">=</span> <span class="n">pvEThPayload</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ETH_CS_ETH2_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ClassifyPacket : Unrecognized ETH Frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pIpHeader</span> <span class="o">=</span> <span class="n">pvEThPayload</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ETH_CS_ETH2_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">stEthCsPktInfo</span><span class="p">.</span><span class="n">eNwpktIPFrameType</span> <span class="o">==</span> <span class="n">eIPv4Packet</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">usCurrFragment</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">frag_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IP_OFFSET</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">frag_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IP_MF</span><span class="p">)</span> <span class="o">||</span> <span class="n">usCurrFragment</span><span class="p">)</span>
			<span class="n">bFragmentedPkt</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">bFragmentedPkt</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Fragmented  Packet. Get Frag Classifier Entry.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pstClassifierRule</span> <span class="o">=</span> <span class="n">GetFragIPClsEntry</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">)</span>
			<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;It is next Fragmented pkt&quot;</span><span class="p">);</span>
					<span class="n">bClassificationSucceed</span><span class="o">=</span><span class="n">TRUE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">frag_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IP_MF</span><span class="p">))</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Fragmented Last packet . Remove Frag Classifier Entry</p></td><td class="code"><div class="highlight"><pre>				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;This is the last fragmented Pkt&quot;</span><span class="p">);</span>
				<span class="n">DelFragIPClsEntry</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="n">MAX_CLASSIFIERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span><span class="o">--</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Iterate through all classifiers which are already in order of priority
to classify the packet until match found</p></td><td class="code"><div class="highlight"><pre>		<span class="k">do</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span><span class="o">==</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astClassifierTable</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bUsed</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">bClassificationSucceed</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;Adapter-&gt;PackInfo[%d].bvalid=True</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">uiLoopIndex</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astClassifierTable</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucDirection</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">bClassificationSucceed</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span><span class="c1">//cannot be processed for classification.</span>
				<span class="k">break</span><span class="p">;</span>						<span class="c1">// it is a down link connection</span>
			<span class="p">}</span>

			<span class="n">pstClassifierRule</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astClassifierTable</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">];</span>

			<span class="n">uiSfIndex</span> <span class="o">=</span> <span class="n">SearchSfid</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ulSFID</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uiSfIndex</span> <span class="o">&gt;=</span> <span class="n">NO_OF_QUEUES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;Queue Not Valid. SearchSfid for this classifier Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiSfIndex</span><span class="p">].</span><span class="n">bEthCSSupport</span><span class="p">)</span>
			<span class="p">{</span>

				<span class="k">if</span><span class="p">(</span><span class="n">eEthUnsupportedFrame</span><span class="o">==</span><span class="n">stEthCsPktInfo</span><span class="p">.</span><span class="n">eNwpktEthFrameType</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot; ClassifyPacket : Packet Not a Valid Supported Ethernet Frame </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>



				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;Performing ETH CS Classification on Classifier Rule ID : %x Service Flow ID : %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">uiClassifierRuleIndex</span><span class="p">,</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiSfIndex</span><span class="p">].</span><span class="n">ulSFID</span><span class="p">);</span>
				<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">EThCSClassifyPkt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">skb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stEthCsPktInfo</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiSfIndex</span><span class="p">].</span><span class="n">bEthCSSupport</span><span class="p">);</span>

				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;ClassifyPacket : Ethernet CS Classification Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="c1">// No ETH Supported on this SF</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">eEthOtherFrame</span> <span class="o">!=</span> <span class="n">stEthCsPktInfo</span><span class="p">.</span><span class="n">eNwpktEthFrameType</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot; ClassifyPacket : Packet Not a 802.3 Ethernet Frame... hence not allowed over non-ETH CS SF </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;Proceeding to IP CS Clasification&quot;</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiSfIndex</span><span class="p">].</span><span class="n">bIPCSSupport</span><span class="p">)</span>
			<span class="p">{</span>

				<span class="k">if</span><span class="p">(</span><span class="n">stEthCsPktInfo</span><span class="p">.</span><span class="n">eNwpktIPFrameType</span> <span class="o">==</span> <span class="n">eNonIPPacket</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot; ClassifyPacket : Packet is Not an IP Packet </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;Dump IP Header : </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">DumpFullPacket</span><span class="p">((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pIpHeader</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>

				<span class="k">if</span><span class="p">(</span><span class="n">stEthCsPktInfo</span><span class="p">.</span><span class="n">eNwpktIPFrameType</span> <span class="o">==</span> <span class="n">eIPv4Packet</span><span class="p">)</span>
					<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">IpVersion4</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">pIpHeader</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stEthCsPktInfo</span><span class="p">.</span><span class="n">eNwpktIPFrameType</span> <span class="o">==</span> <span class="n">eIPv6Packet</span><span class="p">)</span>
					<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">IpVersion6</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">pIpHeader</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">bClassificationSucceed</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;CF id : %d, SF ID is =%lu&quot;</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">uiClassifierRuleIndex</span><span class="p">,</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ulSFID</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Store The matched Classifier in SKB</p></td><td class="code"><div class="highlight"><pre>		<span class="o">*</span><span class="p">((</span><span class="n">UINT32</span><span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span><span class="o">+</span><span class="n">SKB_CB_CLASSIFICATION_OFFSET</span><span class="p">)</span> <span class="o">=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">uiClassifierRuleIndex</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="n">TCP</span> <span class="o">==</span> <span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bFragmentedPkt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ETH_AND_IP_HEADER_LEN</span> <span class="o">+</span> <span class="n">TCP_HEADER_LEN</span> <span class="o">&lt;=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			 <span class="n">IpHeaderLength</span>   <span class="o">=</span> <span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">;</span>
			 <span class="n">pTcpHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTCP_HEADER</span><span class="p">)(((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pIpHeader</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">IpHeaderLength</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
			 <span class="n">TcpHeaderLength</span>  <span class="o">=</span> <span class="n">GET_TCP_HEADER_LEN</span><span class="p">(</span><span class="n">pTcpHeader</span><span class="o">-&gt;</span><span class="n">HeaderLength</span><span class="p">);</span>

			<span class="k">if</span><span class="p">((</span><span class="n">pTcpHeader</span><span class="o">-&gt;</span><span class="n">ucFlags</span> <span class="o">&amp;</span> <span class="n">TCP_ACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">IpHeaderLength</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">TcpHeaderLength</span><span class="o">*</span><span class="mi">4</span><span class="p">)))</span>
			<span class="p">{</span>
    			<span class="o">*</span><span class="p">((</span><span class="n">UINT32</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">+</span><span class="n">SKB_CB_TCPACK_OFFSET</span> <span class="p">)</span> <span class="o">=</span> <span class="n">TCP_ACK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">usIndex</span> <span class="o">=</span> <span class="n">SearchSfid</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ulSFID</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;index is	=%d&quot;</span><span class="p">,</span> <span class="n">usIndex</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>If this is the first fragment of a Fragmented pkt, add this CF. Only This CF should be used for all other fragment of this Pkt.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">bFragmentedPkt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">usCurrFragment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>First Fragment of Fragmented Packet. Create Frag CLS Entry</p></td><td class="code"><div class="highlight"><pre>			<span class="n">S_FRAGMENTED_PACKET_INFO</span> <span class="n">stFragPktInfo</span><span class="p">;</span>
			<span class="n">stFragPktInfo</span><span class="p">.</span><span class="n">bUsed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">stFragPktInfo</span><span class="p">.</span><span class="n">ulSrcIpAddress</span> <span class="o">=</span> <span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">;</span>
			<span class="n">stFragPktInfo</span><span class="p">.</span><span class="n">usIpIdentification</span> <span class="o">=</span> <span class="n">pIpHeader</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="n">stFragPktInfo</span><span class="p">.</span><span class="n">pstMatchedClassifierEntry</span> <span class="o">=</span> <span class="n">pstClassifierRule</span><span class="p">;</span>
			<span class="n">stFragPktInfo</span><span class="p">.</span><span class="n">bOutOfOrderFragment</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="n">AddFragIPClsEntry</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stFragPktInfo</span><span class="p">);</span>
		<span class="p">}</span>


	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">usIndex</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">INVALID_QUEUE_INDEX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">EthCSMatchSrcMACAddress</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">PUCHAR</span> <span class="n">Mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucEthCSSrcMACLen</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;%s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAC_ADDRESS_SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;SRC MAC[%x] = %x ClassifierRuleSrcMAC = %x Mask : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">Mac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSSrcMAC</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSSrcMACMask</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSSrcMAC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSSrcMACMask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">!=</span>
			<span class="p">(</span><span class="n">Mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSSrcMACMask</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">EthCSMatchDestMACAddress</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">PUCHAR</span> <span class="n">Mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucEthCSDestMACLen</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;%s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAC_ADDRESS_SIZE</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;SRC MAC[%x] = %x ClassifierRuleSrcMAC = %x Mask : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">Mac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSDestMAC</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSDestMACMask</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSDestMAC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSDestMACMask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">!=</span>
			<span class="p">(</span><span class="n">Mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EThCSDestMACMask</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">EthCSMatchEThTypeSAP</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">,</span><span class="n">PS_ETHCS_PKT_INFO</span> <span class="n">pstEthCsPktInfo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">ucEtherTypeLen</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">||</span>
		<span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;%s SrcEtherType:%x CLS EtherType[0]:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">usEtherType</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;%s  CLS EtherType[1]:%x EtherType[2]:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">usEtherType</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">eEth802LLCFrame</span> <span class="o">!=</span> <span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;%s  EthCS DSAP:%x EtherType[2]:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">ucDSAP</span><span class="p">,</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">ucDSAP</span> <span class="o">==</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">au8EthCSEtherType</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">EthCSMatchVLANRules</span><span class="p">(</span><span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">,</span><span class="n">PS_ETHCS_PKT_INFO</span> <span class="n">pstEthCsPktInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BOOLEAN</span> <span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">USHORT</span> <span class="n">usVLANID</span><span class="p">;</span>
	<span class="n">B_UINT8</span> <span class="n">uPriority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;%s  CLS UserPrio:%x CLS VLANID:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">USHORT</span> <span class="o">*</span><span class="p">)</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usUserPriority</span><span class="p">)),</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usVLANID</span><span class="p">);</span>

	<span class="cm">/* In case FW didn&#39;t receive the TLV, the priority field should be ignored */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usValidityBitMap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">PKT_CLASSIFICATION_USER_PRIORITY_VALID</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span><span class="o">!=</span><span class="n">eEth802QVLANFrame</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="n">uPriority</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">USHORT</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ETH_HEADER_STRUC</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>

		<span class="k">if</span><span class="p">((</span><span class="n">uPriority</span> <span class="o">&gt;=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usUserPriority</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uPriority</span> <span class="o">&lt;=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usUserPriority</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
				<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;ETH CS 802.1 D  User Priority Rule Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usValidityBitMap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">PKT_CLASSIFICATION_VLANID_VALID</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span><span class="o">!=</span><span class="n">eEth802QVLANFrame</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="n">usVLANID</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">USHORT</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ETH_HEADER_STRUC</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;%s  Pkt VLANID %x Priority: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">usVLANID</span><span class="p">,</span> <span class="n">uPriority</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">usVLANID</span> <span class="o">==</span> <span class="p">((</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">usVLANID</span> <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;ETH CS 802.1 Q VLAN ID Rule Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">EThCSClassifyPkt</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">,</span>
				<span class="n">PS_ETHCS_PKT_INFO</span> <span class="n">pstEthCsPktInfo</span><span class="p">,</span>
				<span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierRule</span><span class="p">,</span>
				<span class="n">B_UINT8</span> <span class="n">EthCSCupport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BOOLEAN</span> <span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">EthCSMatchSrcMACAddress</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,((</span><span class="n">ETH_HEADER_STRUC</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">au8SourceAddress</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;ETH CS SrcMAC Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">EthCSMatchDestMACAddress</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,((</span><span class="n">ETH_HEADER_STRUC</span><span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">au8DestinationAddress</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;ETH CS DestMAC Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>classify on ETHType/802.2SAP TLV</p></td><td class="code"><div class="highlight"><pre>	<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">EthCSMatchEThTypeSAP</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">skb</span><span class="p">,</span><span class="n">pstEthCsPktInfo</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;ETH CS EthType/802.2SAP Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>classify on 802.1VLAN Header Parameters</p></td><td class="code"><div class="highlight"><pre>	<span class="n">bClassificationSucceed</span> <span class="o">=</span> <span class="n">EthCSMatchVLANRules</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="p">,</span><span class="n">skb</span><span class="p">,</span><span class="n">pstEthCsPktInfo</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bClassificationSucceed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;ETH CS 802.1 VLAN Rules Matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bClassificationSucceed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">EThCSGetPktInfo</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span><span class="n">PVOID</span> <span class="n">pvEthPayload</span><span class="p">,</span>
			    <span class="n">PS_ETHCS_PKT_INFO</span> <span class="n">pstEthCsPktInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">USHORT</span> <span class="n">u16Etype</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(((</span><span class="n">ETH_HEADER_STRUC</span><span class="o">*</span><span class="p">)</span><span class="n">pvEthPayload</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u16Etype</span><span class="p">);</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;EthCSGetPktInfo : Eth Hdr Type : %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">u16Etype</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">u16Etype</span> <span class="o">&gt;</span> <span class="mh">0x5dc</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;EthCSGetPktInfo : ETH2 Frame </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>ETH2 Frame</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">u16Etype</span> <span class="o">==</span> <span class="n">ETHERNET_FRAMETYPE_802QVLAN</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>802.1Q VLAN Header</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span> <span class="o">=</span> <span class="n">eEth802QVLANFrame</span><span class="p">;</span>
			<span class="n">u16Etype</span> <span class="o">=</span> <span class="p">((</span><span class="n">ETH_CS_802_Q_FRAME</span><span class="o">*</span><span class="p">)</span><span class="n">pvEthPayload</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">EthType</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>((ETH<em>CS</em>802<em>Q</em>FRAME*)pvEthPayload)->UserPriority</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span> <span class="o">=</span> <span class="n">eEthOtherFrame</span><span class="p">;</span>
			<span class="n">u16Etype</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">u16Etype</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>802.2 LLC</p></td><td class="code"><div class="highlight"><pre>		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;802.2 LLC Frame </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span> <span class="o">=</span> <span class="n">eEth802LLCFrame</span><span class="p">;</span>
		<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">ucDSAP</span> <span class="o">=</span> <span class="p">((</span><span class="n">ETH_CS_802_LLC_FRAME</span><span class="o">*</span><span class="p">)</span><span class="n">pvEthPayload</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">DSAP</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">ucDSAP</span> <span class="o">==</span> <span class="mh">0xAA</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ETH_CS_802_LLC_FRAME</span><span class="o">*</span><span class="p">)</span><span class="n">pvEthPayload</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SSAP</span> <span class="o">==</span> <span class="mh">0xAA</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>SNAP Frame</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span> <span class="o">=</span> <span class="n">eEth802LLCSNAPFrame</span><span class="p">;</span>
			<span class="n">u16Etype</span> <span class="o">=</span> <span class="p">((</span><span class="n">ETH_CS_802_LLC_SNAP_FRAME</span><span class="o">*</span><span class="p">)</span><span class="n">pvEthPayload</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">usEtherType</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">u16Etype</span> <span class="o">==</span> <span class="n">ETHERNET_FRAMETYPE_IPV4</span><span class="p">)</span>
		<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktIPFrameType</span> <span class="o">=</span> <span class="n">eIPv4Packet</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">u16Etype</span> <span class="o">==</span> <span class="n">ETHERNET_FRAMETYPE_IPV6</span><span class="p">)</span>
		<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktIPFrameType</span> <span class="o">=</span> <span class="n">eIPv6Packet</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktIPFrameType</span> <span class="o">=</span> <span class="n">eNonIPPacket</span><span class="p">;</span>

	<span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">usEtherType</span> <span class="o">=</span> <span class="p">((</span><span class="n">ETH_HEADER_STRUC</span><span class="o">*</span><span class="p">)</span><span class="n">pvEthPayload</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u16Etype</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;EthCsPktInfo-&gt;eNwpktIPFrameType : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktIPFrameType</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;EthCsPktInfo-&gt;eNwpktEthFrameType : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">eNwpktEthFrameType</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span>  <span class="s">&quot;EthCsPktInfo-&gt;usEtherType : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pstEthCsPktInfo</span><span class="o">-&gt;</span><span class="n">usEtherType</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
