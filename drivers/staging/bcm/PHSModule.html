<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › bcm › PHSModule.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>PHSModule.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;headers.h&quot;</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="n">CreateSFToClassifierRuleMapping</span><span class="p">(</span><span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span><span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span><span class="n">S_SERVICEFLOW_TABLE</span> <span class="o">*</span><span class="n">psServiceFlowTable</span><span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span><span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">);</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="n">CreateClassiferToPHSRuleMapping</span><span class="p">(</span><span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span><span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span><span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span><span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span><span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">);</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="n">CreateClassifierPHSRule</span><span class="p">(</span><span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span><span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span> <span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span><span class="n">E_CLASSIFIER_ENTRY_CONTEXT</span> <span class="n">eClsContext</span><span class="p">,</span><span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">);</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="n">UpdateClassifierPHSRule</span><span class="p">(</span><span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span><span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">pstClassifierEntry</span><span class="p">,</span><span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span> <span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span><span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">);</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="n">ValidatePHSRuleComplete</span><span class="p">(</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">);</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="n">DerefPhsRule</span><span class="p">(</span><span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span><span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span><span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">pstPhsRule</span><span class="p">);</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="n">GetClassifierEntry</span><span class="p">(</span><span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">pstClassifierTable</span><span class="p">,</span><span class="n">B_UINT32</span> <span class="n">uiClsid</span><span class="p">,</span><span class="n">E_CLASSIFIER_ENTRY_CONTEXT</span> <span class="n">eClsContext</span><span class="p">,</span> <span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">**</span><span class="n">ppstClassifierEntry</span><span class="p">);</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="n">GetPhsRuleEntry</span><span class="p">(</span><span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">pstClassifierTable</span><span class="p">,</span><span class="n">B_UINT32</span> <span class="n">uiPHSI</span><span class="p">,</span><span class="n">E_CLASSIFIER_ENTRY_CONTEXT</span> <span class="n">eClsContext</span><span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">**</span><span class="n">ppstPhsRule</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">free_phs_serviceflow_rules</span><span class="p">(</span><span class="n">S_SERVICEFLOW_TABLE</span> <span class="o">*</span><span class="n">psServiceFlowRulesTable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">phs_compress</span><span class="p">(</span><span class="n">S_PHS_RULE</span>   <span class="o">*</span><span class="n">phs_members</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">header_size</span><span class="p">,</span><span class="n">UINT</span> <span class="o">*</span><span class="n">new_header_size</span> <span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">verify_suppress_phsf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span>
								<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phsf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phsm</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phss</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phsv</span><span class="p">,</span><span class="n">UINT</span> <span class="o">*</span><span class="n">new_header_size</span> <span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">phs_decompress</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span>\
						  <span class="n">S_PHS_RULE</span>   <span class="o">*</span><span class="n">phs_rules</span><span class="p">,</span><span class="n">UINT</span> <span class="o">*</span><span class="n">header_size</span><span class="p">);</span>


<span class="k">static</span> <span class="n">ULONG</span> <span class="n">PhsCompress</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span>
				  <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span>
				  <span class="n">B_UINT16</span> <span class="n">uiClsId</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">pvInputBuffer</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">pvOutputBuffer</span><span class="p">,</span>
				  <span class="n">UINT</span> <span class="o">*</span><span class="n">pOldHeaderSize</span><span class="p">,</span>
				  <span class="n">UINT</span> <span class="o">*</span><span class="n">pNewHeaderSize</span> <span class="p">);</span>

<span class="k">static</span> <span class="n">ULONG</span> <span class="n">PhsDeCompress</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span>
				  <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">pvInputBuffer</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">pvOutputBuffer</span><span class="p">,</span>
				  <span class="n">UINT</span> <span class="o">*</span><span class="n">pInHeaderSize</span><span class="p">,</span>
				  <span class="n">UINT</span> <span class="o">*</span><span class="n">pOutHeaderSize</span><span class="p">);</span>



<span class="cp">#define IN</span>
<span class="cp">#define OUT</span>

<span class="cm">/*</span>
<span class="cm">Function:				PHSTransmit</span>

<span class="cm">Description:			This routine handle PHS(Payload Header Suppression for Tx path.</span>
<span class="cm">					It extracts a fragment of the NDIS_PACKET containing the header</span>
<span class="cm">					to be suppressed.It then supresses the header by invoking PHS exported compress routine.</span>
<span class="cm">					The header data after supression is copied back to the NDIS_PACKET.</span>


<span class="cm">Input parameters:		IN PMINI_ADAPTER Adapter         - Miniport Adapter Context</span>
<span class="cm">						IN Packet 				- NDIS packet containing data to be transmitted</span>
<span class="cm">						IN USHORT Vcid        - vcid pertaining to connection on which the packet is being sent.Used to</span>
<span class="cm">										        identify PHS rule to be applied.</span>
<span class="cm">						B_UINT16 uiClassifierRuleID - Classifier Rule ID</span>
<span class="cm">						BOOLEAN bHeaderSuppressionEnabled - indicates if header suprression is enabled for SF.</span>

<span class="cm">Return:					STATUS_SUCCESS - If the send was successful.</span>
<span class="cm">						Other          - If an error occured.</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">PHSTransmit</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">**</span><span class="n">pPacket</span><span class="p">,</span>
					 <span class="n">USHORT</span> <span class="n">Vcid</span><span class="p">,</span>
					 <span class="n">B_UINT16</span> <span class="n">uiClassifierRuleID</span><span class="p">,</span>
					 <span class="n">BOOLEAN</span> <span class="n">bHeaderSuppressionEnabled</span><span class="p">,</span>
					 <span class="n">UINT</span> <span class="o">*</span><span class="n">PacketLen</span><span class="p">,</span>
					 <span class="n">UCHAR</span> <span class="n">bEthCSSupport</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>PHS Sepcific</p></td><td class="code"><div class="highlight"><pre>	<span class="n">UINT</span>    <span class="n">unPHSPktHdrBytesCopied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span>	<span class="n">unPhsOldHdrSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span>	<span class="n">unPHSNewPktHeaderLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Pointer to PHS IN Hdr Buffer */</span>
	<span class="n">PUCHAR</span> <span class="n">pucPHSPktHdrInBuf</span> <span class="o">=</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stPhsTxContextInfo</span><span class="p">.</span><span class="n">ucaHdrSupressionInBuf</span><span class="p">;</span>
	<span class="cm">/* Pointer to PHS OUT Hdr Buffer */</span>
	<span class="n">PUCHAR</span>  <span class="n">pucPHSPktHdrOutBuf</span> <span class="o">=</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stPhsTxContextInfo</span><span class="p">.</span><span class="n">ucaHdrSupressionOutBuf</span><span class="p">;</span>
	<span class="n">UINT</span>       <span class="n">usPacketType</span><span class="p">;</span>
	<span class="n">UINT</span>       <span class="n">BytesToRemove</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">BOOLEAN</span>  <span class="n">bPHSI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LONG</span> <span class="n">ulPhsStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> 	<span class="n">numBytesCompressed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">newPacket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">Packet</span> <span class="o">=</span> <span class="o">*</span><span class="n">pPacket</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;In PHSTransmit&quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bEthCSSupport</span><span class="p">)</span>
		<span class="n">BytesToRemove</span><span class="o">=</span><span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">		Accumulate the header upto the size we support supression</span>
<span class="cm">		from NDIS packet</span>
<span class="cm">	*/</span>

	<span class="n">usPacketType</span><span class="o">=</span><span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">Packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>


	<span class="n">pucPHSPktHdrInBuf</span> <span class="o">=</span> <span class="n">Packet</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">BytesToRemove</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>considering data after ethernet header</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">PacketLen</span> <span class="o">-</span> <span class="n">BytesToRemove</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_PHS_LENGTHS</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="n">unPHSPktHdrBytesCopied</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">PacketLen</span> <span class="o">-</span> <span class="n">BytesToRemove</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">unPHSPktHdrBytesCopied</span> <span class="o">=</span> <span class="n">MAX_PHS_LENGTHS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">unPHSPktHdrBytesCopied</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">unPHSPktHdrBytesCopied</span> <span class="o">&lt;=</span> <span class="n">MAX_PHS_LENGTHS</span><span class="p">))</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Step 2 Supress Header using PHS and fill into intermediate ucaPHSPktHdrOutBuf.
Suppress only if IP Header and PHS Enabled For the Service Flow</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(((</span><span class="n">usPacketType</span> <span class="o">==</span> <span class="n">ETHERNET_FRAMETYPE_IPV4</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">usPacketType</span> <span class="o">==</span> <span class="n">ETHERNET_FRAMETYPE_IPV6</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">bHeaderSuppressionEnabled</span><span class="p">))</span>
		<span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Trying to PHS Compress Using Classifier rule 0x%X&quot;</span><span class="p">,</span><span class="n">uiClassifierRuleID</span><span class="p">);</span>


				<span class="n">unPHSNewPktHeaderLen</span> <span class="o">=</span> <span class="n">unPHSPktHdrBytesCopied</span><span class="p">;</span>
				<span class="n">ulPhsStatus</span> <span class="o">=</span> <span class="n">PhsCompress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stBCMPhsContext</span><span class="p">,</span>
					<span class="n">Vcid</span><span class="p">,</span>
					<span class="n">uiClassifierRuleID</span><span class="p">,</span>
					<span class="n">pucPHSPktHdrInBuf</span><span class="p">,</span>
					<span class="n">pucPHSPktHdrOutBuf</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">unPhsOldHdrSize</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">unPHSNewPktHeaderLen</span><span class="p">);</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">PHS Old header Size : %d New Header Size  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">unPhsOldHdrSize</span><span class="p">,</span><span class="n">unPHSNewPktHeaderLen</span><span class="p">);</span>

				<span class="k">if</span><span class="p">(</span><span class="n">unPHSNewPktHeaderLen</span> <span class="o">==</span> <span class="n">unPhsOldHdrSize</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span><span class="p">(</span>  <span class="n">ulPhsStatus</span> <span class="o">==</span> <span class="n">STATUS_PHS_COMPRESSED</span><span class="p">)</span>
							<span class="n">bPHSI</span> <span class="o">=</span> <span class="o">*</span><span class="n">pucPHSPktHdrOutBuf</span><span class="p">;</span>
					<span class="n">ulPhsStatus</span> <span class="o">=</span> <span class="n">STATUS_PHS_NOCOMPRESSION</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span><span class="p">(</span>  <span class="n">ulPhsStatus</span> <span class="o">==</span> <span class="n">STATUS_PHS_COMPRESSED</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;PHS Sending packet Compressed&quot;</span><span class="p">);</span>

					<span class="k">if</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">Packet</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">newPacket</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">Packet</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

						<span class="k">if</span><span class="p">(</span><span class="n">newPacket</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
							<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>

						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">Packet</span><span class="p">);</span>
						<span class="o">*</span><span class="n">pPacket</span> <span class="o">=</span> <span class="n">Packet</span> <span class="o">=</span> <span class="n">newPacket</span><span class="p">;</span>
						<span class="n">pucPHSPktHdrInBuf</span> <span class="o">=</span> <span class="n">Packet</span><span class="o">-&gt;</span><span class="n">data</span>  <span class="o">+</span> <span class="n">BytesToRemove</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">numBytesCompressed</span> <span class="o">=</span> <span class="n">unPhsOldHdrSize</span> <span class="o">-</span> <span class="p">(</span><span class="n">unPHSNewPktHeaderLen</span><span class="o">+</span><span class="n">PHSI_LEN</span><span class="p">);</span>

					<span class="n">memcpy</span><span class="p">(</span><span class="n">pucPHSPktHdrInBuf</span> <span class="o">+</span> <span class="n">numBytesCompressed</span><span class="p">,</span> <span class="n">pucPHSPktHdrOutBuf</span><span class="p">,</span> <span class="n">unPHSNewPktHeaderLen</span> <span class="o">+</span> <span class="n">PHSI_LEN</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">Packet</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">numBytesCompressed</span><span class="p">,</span> <span class="n">Packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">BytesToRemove</span><span class="p">);</span>
					<span class="n">skb_pull</span><span class="p">(</span><span class="n">Packet</span><span class="p">,</span> <span class="n">numBytesCompressed</span><span class="p">);</span>

					<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">else</span>
				<span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>if one byte headroom is not available, increase it through skb_cow</p></td><td class="code"><div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">Packet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">if</span><span class="p">(</span><span class="n">skb_cow</span><span class="p">(</span><span class="n">Packet</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;SKB Cow Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">skb_push</span><span class="p">(</span><span class="n">Packet</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>CAUTION: The MAC Header is getting corrupted here for IP CS - can be saved by copying 14 Bytes.  not needed .... hence corrupting it.</p></td><td class="code"><div class="highlight"><pre>					<span class="o">*</span><span class="p">(</span><span class="n">Packet</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">BytesToRemove</span><span class="p">)</span> <span class="o">=</span> <span class="n">bPHSI</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bHeaderSuppressionEnabled</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Header Suppression Disabled For SF: No PHS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>BCM<em>DEBUG</em>PRINT(Adapter,DBG<em>TYPE</em>OTHERS, PHS<em>SEND, DBG</em>LVL_ALL,"PHSTransmit : Dumping data packet After PHS");</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">PHSReceive</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span>
					<span class="n">USHORT</span> <span class="n">usVcid</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span>
					<span class="n">UINT</span> <span class="o">*</span><span class="n">punPacketLen</span><span class="p">,</span>
					<span class="n">UCHAR</span> <span class="o">*</span><span class="n">pucEthernetHdr</span><span class="p">,</span>
					<span class="n">UINT</span>	<span class="n">bHeaderSuppressionEnabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>   <span class="n">nStandardPktHdrLen</span>            		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>   <span class="n">nTotalsupressedPktHdrBytes</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">ulPhsStatus</span> 		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PUCHAR</span> <span class="n">pucInBuff</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
	<span class="n">UINT</span> <span class="n">TotalBytesAdded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bHeaderSuppressionEnabled</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Phs Disabled for incoming packet&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ulPhsStatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pucInBuff</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Restore  PHS suppressed header</p></td><td class="code"><div class="highlight"><pre>	<span class="n">nStandardPktHdrLen</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">ulPhsStatus</span> <span class="o">=</span> <span class="n">PhsDeCompress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stBCMPhsContext</span><span class="p">,</span>
		<span class="n">usVcid</span><span class="p">,</span>
		<span class="n">pucInBuff</span><span class="p">,</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ucaPHSPktRestoreBuf</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">nTotalsupressedPktHdrBytes</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">nStandardPktHdrLen</span><span class="p">);</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Supressed PktHdrLen : 0x%x Restored PktHdrLen : 0x%x&quot;</span><span class="p">,</span>
					<span class="n">nTotalsupressedPktHdrBytes</span><span class="p">,</span><span class="n">nStandardPktHdrLen</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ulPhsStatus</span> <span class="o">!=</span> <span class="n">STATUS_PHS_COMPRESSED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">TotalBytesAdded</span> <span class="o">=</span> <span class="n">nStandardPktHdrLen</span> <span class="o">-</span> <span class="n">nTotalsupressedPktHdrBytes</span> <span class="o">-</span> <span class="n">PHSI_LEN</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">TotalBytesAdded</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">SKB_RESERVE_ETHERNET_HEADER</span> <span class="o">+</span> <span class="n">TotalBytesAdded</span><span class="p">))</span>
				<span class="n">skb_push</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">TotalBytesAdded</span><span class="p">);</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">skb_cow</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span> <span class="o">+</span> <span class="n">TotalBytesAdded</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;cow failed in receive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">skb_push</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">TotalBytesAdded</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ucaPHSPktRestoreBuf</span><span class="p">,</span> <span class="n">nStandardPktHdrLen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DumpFullPacket</span><span class="p">(</span><span class="n">UCHAR</span> <span class="o">*</span><span class="n">pBuf</span><span class="p">,</span><span class="n">UINT</span> <span class="n">nPktLen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Dumping Data Packet&quot;</span><span class="p">);</span>
    <span class="n">BCM_DEBUG_PRINT_BUFFER</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">IPV4_DBG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="n">pBuf</span><span class="p">,</span><span class="n">nPktLen</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><hr />

<p>Procedure:   phs_init</p>

<p>Description: This routine is responsible for allocating memory for classifier and
PHS rules.</p>

<p>Arguments:
pPhsdeviceExtension - ptr to Device extension containing PHS Classifier rules and PHS Rules , RX, TX buffer etc</p>

<p>Returns:
TRUE(1)    -If allocation of memory was success full.</p>

<h2>FALSE    -If allocation of memory fails.</h2></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">phs_init</span><span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pPhsdeviceExtension</span><span class="p">,</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">S_SERVICEFLOW_TABLE</span> <span class="o">*</span><span class="n">pstServiceFlowTable</span><span class="p">;</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">PHS:phs_init function &quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">S_SERVICEFLOW_TABLE</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Allocation ServiceFlowPhsRulesTable failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pstServiceFlowTable</span> <span class="o">=</span> <span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SERVICEFLOWS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="n">sServiceFlow</span> <span class="o">=</span> <span class="n">pstServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">sServiceFlow</span><span class="p">.</span><span class="n">pstClassifierTable</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">S_CLASSIFIER_TABLE</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sServiceFlow</span><span class="p">.</span><span class="n">pstClassifierTable</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Allocation failed&quot;</span><span class="p">);</span>
			<span class="n">free_phs_serviceflow_rules</span><span class="p">(</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span>
                <span class="n">pstServiceFlowPhsRulesTable</span><span class="p">);</span>
			<span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">CompressedTxBuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PHS_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">CompressedTxBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Allocation failed&quot;</span><span class="p">);</span>
		<span class="n">free_phs_serviceflow_rules</span><span class="p">(</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">);</span>
		<span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

    <span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">UnCompressedRxBuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PHS_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">UnCompressedRxBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Allocation failed&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">CompressedTxBuffer</span><span class="p">);</span>
		<span class="n">free_phs_serviceflow_rules</span><span class="p">(</span><span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">);</span>
		<span class="n">pPhsdeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>



	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> phs_init Successfull&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">PhsCleanup</span><span class="p">(</span><span class="n">IN</span> <span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pPHSDeviceExt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pPHSDeviceExt</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">free_phs_serviceflow_rules</span><span class="p">(</span><span class="n">pPHSDeviceExt</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">);</span>
		<span class="n">pPHSDeviceExt</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pPHSDeviceExt</span><span class="o">-&gt;</span><span class="n">CompressedTxBuffer</span><span class="p">);</span>
	<span class="n">pPHSDeviceExt</span><span class="o">-&gt;</span><span class="n">CompressedTxBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pPHSDeviceExt</span><span class="o">-&gt;</span><span class="n">UnCompressedRxBuffer</span><span class="p">);</span>
	<span class="n">pPHSDeviceExt</span><span class="o">-&gt;</span><span class="n">UnCompressedRxBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>PHS functions</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*++</span>
<span class="cm">PhsUpdateClassifierRule</span>

<span class="cm">Routine Description:</span>
<span class="cm">    Exported function to add or modify a PHS Rule.</span>

<span class="cm">Arguments:</span>
<span class="cm">	IN void* pvContext - PHS Driver Specific Context</span>
<span class="cm">	IN B_UINT16 uiVcid    - The Service Flow ID for which the PHS rule applies</span>
<span class="cm">	IN B_UINT16  uiClsId   - The Classifier ID within the Service Flow for which the PHS rule applies.</span>
<span class="cm">	IN S_PHS_RULE *psPhsRule - The PHS Rule strcuture to be added to the PHS Rule table.</span>

<span class="cm">Return Value:</span>

<span class="cm">    0 if successful,</span>
<span class="cm">    &gt;0 Error.</span>

<span class="cm">--*/</span>
<span class="n">ULONG</span> <span class="nf">PhsUpdateClassifierRule</span><span class="p">(</span><span class="n">IN</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span>
								<span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiVcid</span> <span class="p">,</span>
								<span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiClsId</span>   <span class="p">,</span>
								<span class="n">IN</span> <span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span>
								<span class="n">IN</span> <span class="n">B_UINT8</span>  <span class="n">u8AssociatedPHSI</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">lStatus</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">nSFIndex</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span>
	<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>



	<span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pDeviceExtension</span><span class="o">=</span> <span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span><span class="p">)</span><span class="n">pvContext</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;PHS With Corr2 Changes </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pDeviceExtension</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Invalid Device Extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PHS_INVALID_DEVICE_EXETENSION</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span><span class="p">(</span><span class="n">u8AssociatedPHSI</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">ERR_PHS_INVALID_PHS_RULE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Retrieve the SFID Entry Index for requested Service Flow */</span>

	<span class="n">nSFIndex</span> <span class="o">=</span> <span class="n">GetServiceFlowEntry</span><span class="p">(</span><span class="n">pDeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">,</span>
	                <span class="n">uiVcid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstServiceFlowEntry</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">nSFIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* This is a new SF. Create a mapping entry for this */</span>
		<span class="n">lStatus</span> <span class="o">=</span> <span class="n">CreateSFToClassifierRuleMapping</span><span class="p">(</span><span class="n">uiVcid</span><span class="p">,</span> <span class="n">uiClsId</span><span class="p">,</span>
		      <span class="n">pDeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">,</span> <span class="n">psPhsRule</span><span class="p">,</span> <span class="n">u8AssociatedPHSI</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SF already Exists Add PHS Rule to existing SF */</span>
  	<span class="n">lStatus</span> <span class="o">=</span> <span class="n">CreateClassiferToPHSRuleMapping</span><span class="p">(</span><span class="n">uiVcid</span><span class="p">,</span> <span class="n">uiClsId</span><span class="p">,</span>
  	          <span class="n">pstServiceFlowEntry</span><span class="p">,</span> <span class="n">psPhsRule</span><span class="p">,</span> <span class="n">u8AssociatedPHSI</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*++</span>
<span class="cm">PhsDeletePHSRule</span>

<span class="cm">Routine Description:</span>
<span class="cm">   Deletes the specified phs Rule within Vcid</span>

<span class="cm">Arguments:</span>
<span class="cm">	IN void* pvContext - PHS Driver Specific Context</span>
<span class="cm">	IN B_UINT16  uiVcid    - The Service Flow ID for which the PHS rule applies</span>
<span class="cm">	IN B_UINT8  u8PHSI   - the PHS Index identifying PHS rule to be deleted.</span>

<span class="cm">Return Value:</span>

<span class="cm">    0 if successful,</span>
<span class="cm">    &gt;0 Error.</span>

<span class="cm">--*/</span>

<span class="n">ULONG</span> <span class="nf">PhsDeletePHSRule</span><span class="p">(</span><span class="n">IN</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span><span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span><span class="n">IN</span> <span class="n">B_UINT8</span> <span class="n">u8PHSI</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">lStatus</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">nSFIndex</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nClsidIndex</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span>
	<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">pstClassifierRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>


	<span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pDeviceExtension</span><span class="o">=</span> <span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span><span class="p">)</span><span class="n">pvContext</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;======&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pDeviceExtension</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Retrieve the SFID Entry Index for requested Service Flow</p></td><td class="code"><div class="highlight"><pre>		<span class="n">nSFIndex</span> <span class="o">=</span> <span class="n">GetServiceFlowEntry</span><span class="p">(</span><span class="n">pDeviceExtension</span>
		      <span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">,</span><span class="n">uiVcid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstServiceFlowEntry</span><span class="p">);</span>

       <span class="k">if</span><span class="p">(</span><span class="n">nSFIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;SFID Match Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_SF_MATCH_FAIL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pstClassifierRulesTable</span><span class="o">=</span><span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="n">nClsidIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">nClsidIndex</span><span class="o">&lt;</span><span class="n">MAX_PHSRULE_PER_SF</span><span class="p">;</span><span class="n">nClsidIndex</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">bUsed</span> <span class="o">&amp;&amp;</span> <span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span> <span class="o">==</span> <span class="n">u8PHSI</span><span class="p">)</span>					<span class="p">{</span>
						<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
							<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">--</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
							<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">);</span>
						<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">S_CLASSIFIER_ENTRY</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*++</span>
<span class="cm">PhsDeleteClassifierRule</span>

<span class="cm">Routine Description:</span>
<span class="cm">    Exported function to Delete a PHS Rule for the SFID,CLSID Pair.</span>

<span class="cm">Arguments:</span>
<span class="cm">	IN void* pvContext - PHS Driver Specific Context</span>
<span class="cm">	IN B_UINT16  uiVcid    - The Service Flow ID for which the PHS rule applies</span>
<span class="cm">	IN B_UINT16  uiClsId   - The Classifier ID within the Service Flow for which the PHS rule applies.</span>

<span class="cm">Return Value:</span>

<span class="cm">    0 if successful,</span>
<span class="cm">    &gt;0 Error.</span>

<span class="cm">--*/</span>
<span class="n">ULONG</span> <span class="nf">PhsDeleteClassifierRule</span><span class="p">(</span><span class="n">IN</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span><span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span> <span class="p">,</span><span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">lStatus</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">nSFIndex</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nClsidIndex</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span>
	<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">pstClassifierEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pDeviceExtension</span><span class="o">=</span> <span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span><span class="p">)</span><span class="n">pvContext</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pDeviceExtension</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Retrieve the SFID Entry Index for requested Service Flow</p></td><td class="code"><div class="highlight"><pre>		<span class="n">nSFIndex</span> <span class="o">=</span> <span class="n">GetServiceFlowEntry</span><span class="p">(</span><span class="n">pDeviceExtension</span>
		      <span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">,</span> <span class="n">uiVcid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstServiceFlowEntry</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">nSFIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;SFID Match Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_SF_MATCH_FAIL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nClsidIndex</span> <span class="o">=</span> <span class="n">GetClassifierEntry</span><span class="p">(</span><span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">,</span>
                  <span class="n">uiClsId</span><span class="p">,</span> <span class="n">eActiveClassifierRuleContext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstClassifierEntry</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">nClsidIndex</span> <span class="o">!=</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bUnclassifiedPHSRule</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
				<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_CLASSIFIER_ENTRY</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">nClsidIndex</span> <span class="o">=</span> <span class="n">GetClassifierEntry</span><span class="p">(</span><span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">,</span>
                    <span class="n">uiClsId</span><span class="p">,</span><span class="n">eOldClassifierRuleContext</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstClassifierEntry</span><span class="p">);</span>

	   <span class="k">if</span><span class="p">((</span><span class="n">nClsidIndex</span> <span class="o">!=</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bUnclassifiedPHSRule</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_CLASSIFIER_ENTRY</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*++</span>
<span class="cm">PhsDeleteSFRules</span>

<span class="cm">Routine Description:</span>
<span class="cm">    Exported function to Delete a all PHS Rules for the SFID.</span>

<span class="cm">Arguments:</span>
<span class="cm">	IN void* pvContext - PHS Driver Specific Context</span>
<span class="cm">	IN B_UINT16 uiVcid   - The Service Flow ID for which the PHS rules need to be deleted</span>

<span class="cm">Return Value:</span>

<span class="cm">    0 if successful,</span>
<span class="cm">    &gt;0 Error.</span>

<span class="cm">--*/</span>
<span class="n">ULONG</span> <span class="nf">PhsDeleteSFRules</span><span class="p">(</span><span class="n">IN</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span><span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">ULONG</span> <span class="n">lStatus</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">nSFIndex</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nClsidIndex</span> <span class="o">=</span><span class="mi">0</span>  <span class="p">;</span>
	<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">pstClassifierRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pDeviceExtension</span><span class="o">=</span> <span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span><span class="p">)</span><span class="n">pvContext</span><span class="p">;</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;====&gt; </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pDeviceExtension</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Retrieve the SFID Entry Index for requested Service Flow</p></td><td class="code"><div class="highlight"><pre>		<span class="n">nSFIndex</span> <span class="o">=</span> <span class="n">GetServiceFlowEntry</span><span class="p">(</span><span class="n">pDeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">,</span>
		                  <span class="n">uiVcid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstServiceFlowEntry</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">nSFIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;SFID Match Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_SF_MATCH_FAIL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pstClassifierRulesTable</span><span class="o">=</span><span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="n">nClsidIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">nClsidIndex</span><span class="o">&lt;</span><span class="n">MAX_PHSRULE_PER_SF</span><span class="p">;</span><span class="n">nClsidIndex</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
                                                        <span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
						<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
						                                    <span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">--</span><span class="p">;</span>
					<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
                                                          <span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">);</span>
					    <span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
                                        <span class="p">.</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_CLASSIFIER_ENTRY</span><span class="p">));</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
                                        <span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
						<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
						                  <span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">--</span><span class="p">;</span>
					<span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
                                        <span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span>
						      <span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">);</span>
					<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">]</span>
                              <span class="p">.</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">nClsidIndex</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_CLASSIFIER_ENTRY</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">bUsed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">uiVcid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*++</span>
<span class="cm">PhsCompress</span>

<span class="cm">Routine Description:</span>
<span class="cm">    Exported function to compress the data using PHS.</span>

<span class="cm">Arguments:</span>
<span class="cm">	IN void* pvContext - PHS Driver Specific Context.</span>
<span class="cm">	IN B_UINT16 uiVcid    - The Service Flow ID to which current packet header compression applies.</span>
<span class="cm">	IN UINT  uiClsId   - The Classifier ID to which current packet header compression applies.</span>
<span class="cm">	IN void *pvInputBuffer - The Input buffer containg packet header data</span>
<span class="cm">	IN void *pvOutputBuffer - The output buffer returned by this function after PHS</span>
<span class="cm">	IN UINT *pOldHeaderSize  - The actual size of the header before PHS</span>
<span class="cm">	IN UINT *pNewHeaderSize - The new size of the header after applying PHS</span>

<span class="cm">Return Value:</span>

<span class="cm">    0 if successful,</span>
<span class="cm">    &gt;0 Error.</span>

<span class="cm">--*/</span>
<span class="n">ULONG</span> <span class="nf">PhsCompress</span><span class="p">(</span><span class="n">IN</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span>
				  <span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span>
				  <span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiClsId</span><span class="p">,</span>
				  <span class="n">IN</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pvInputBuffer</span><span class="p">,</span>
				  <span class="n">OUT</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pvOutputBuffer</span><span class="p">,</span>
				  <span class="n">OUT</span> <span class="n">UINT</span> <span class="o">*</span><span class="n">pOldHeaderSize</span><span class="p">,</span>
				  <span class="n">OUT</span> <span class="n">UINT</span> <span class="o">*</span><span class="n">pNewHeaderSize</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">nSFIndex</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nClsidIndex</span> <span class="o">=</span><span class="mi">0</span>  <span class="p">;</span>
	<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">pstClassifierEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">lStatus</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>



	<span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pDeviceExtension</span><span class="o">=</span> <span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span><span class="p">)</span><span class="n">pvContext</span><span class="p">;</span>


	<span class="k">if</span><span class="p">(</span><span class="n">pDeviceExtension</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Invalid Device Extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lStatus</span> <span class="o">=</span>  <span class="n">STATUS_PHS_NOCOMPRESSION</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Suppressing header </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Retrieve the SFID Entry Index for requested Service Flow</p></td><td class="code"><div class="highlight"><pre>	<span class="n">nSFIndex</span> <span class="o">=</span> <span class="n">GetServiceFlowEntry</span><span class="p">(</span><span class="n">pDeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">,</span>
	                  <span class="n">uiVcid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstServiceFlowEntry</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">nSFIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;SFID Match Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lStatus</span> <span class="o">=</span>  <span class="n">STATUS_PHS_NOCOMPRESSION</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nClsidIndex</span> <span class="o">=</span> <span class="n">GetClassifierEntry</span><span class="p">(</span><span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">,</span>
                <span class="n">uiClsId</span><span class="p">,</span><span class="n">eActiveClassifierRuleContext</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstClassifierEntry</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">nClsidIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;No PHS Rule Defined For Classifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lStatus</span> <span class="o">=</span>  <span class="n">STATUS_PHS_NOCOMPRESSION</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>get rule from SF id,Cls ID pair and proceed</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pstPhsRule</span> <span class="o">=</span>  <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ValidatePHSRuleComplete</span><span class="p">(</span><span class="n">pstPhsRule</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;PHS Rule Defined For Classifier But Not Complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lStatus</span> <span class="o">=</span>  <span class="n">STATUS_PHS_NOCOMPRESSION</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Compress Packet</p></td><td class="code"><div class="highlight"><pre>	<span class="n">lStatus</span> <span class="o">=</span> <span class="n">phs_compress</span><span class="p">(</span><span class="n">pstPhsRule</span><span class="p">,(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pvInputBuffer</span><span class="p">,</span>
	      <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pvOutputBuffer</span><span class="p">,</span> <span class="n">pOldHeaderSize</span><span class="p">,</span><span class="n">pNewHeaderSize</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lStatus</span> <span class="o">==</span> <span class="n">STATUS_PHS_COMPRESSED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">PHSModifiedBytes</span> <span class="o">+=</span> <span class="o">*</span><span class="n">pOldHeaderSize</span> <span class="o">-</span> <span class="o">*</span><span class="n">pNewHeaderSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">PHSModifiedNumPackets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">PHSErrorNumPackets</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">lStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*++</span>
<span class="cm">PhsDeCompress</span>

<span class="cm">Routine Description:</span>
<span class="cm">    Exported function to restore the packet header in Rx path.</span>

<span class="cm">Arguments:</span>
<span class="cm">	IN void* pvContext - PHS Driver Specific Context.</span>
<span class="cm">	IN B_UINT16 uiVcid    - The Service Flow ID to which current packet header restoration applies.</span>
<span class="cm">	IN  void *pvInputBuffer - The Input buffer containg suppressed packet header data</span>
<span class="cm">	OUT void *pvOutputBuffer - The output buffer returned by this function after restoration</span>
<span class="cm">	OUT UINT *pHeaderSize   - The packet header size after restoration is returned in this parameter.</span>

<span class="cm">Return Value:</span>

<span class="cm">    0 if successful,</span>
<span class="cm">    &gt;0 Error.</span>

<span class="cm">--*/</span>
<span class="n">ULONG</span> <span class="nf">PhsDeCompress</span><span class="p">(</span><span class="n">IN</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pvContext</span><span class="p">,</span>
				  <span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span>
				  <span class="n">IN</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pvInputBuffer</span><span class="p">,</span>
				  <span class="n">OUT</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pvOutputBuffer</span><span class="p">,</span>
				  <span class="n">OUT</span> <span class="n">UINT</span> <span class="o">*</span><span class="n">pInHeaderSize</span><span class="p">,</span>
				  <span class="n">OUT</span> <span class="n">UINT</span> <span class="o">*</span><span class="n">pOutHeaderSize</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">nSFIndex</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nPhsRuleIndex</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span>
	<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">phsi</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pDeviceExtension</span><span class="o">=</span>
        <span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span><span class="p">)</span><span class="n">pvContext</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pInHeaderSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pDeviceExtension</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Invalid Device Extension</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PHS_INVALID_DEVICE_EXETENSION</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Restoring header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">phsi</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">pvInputBuffer</span><span class="p">));</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;PHSI To Be Used For restore : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">phsi</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">phsi</span> <span class="o">==</span> <span class="n">UNCOMPRESSED_PACKET</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">STATUS_PHS_NOCOMPRESSION</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Retrieve the SFID Entry Index for requested Service Flow</p></td><td class="code"><div class="highlight"><pre>	<span class="n">nSFIndex</span> <span class="o">=</span> <span class="n">GetServiceFlowEntry</span><span class="p">(</span><span class="n">pDeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="p">,</span>
	      <span class="n">uiVcid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstServiceFlowEntry</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">nSFIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;SFID Match Failed During Lookup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_SF_MATCH_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nPhsRuleIndex</span> <span class="o">=</span> <span class="n">GetPhsRuleEntry</span><span class="p">(</span><span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">,</span><span class="n">phsi</span><span class="p">,</span>
          <span class="n">eActiveClassifierRuleContext</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstPhsRule</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">nPhsRuleIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Phs Rule does not exist in  active rules table. Lets try in the old rules table.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">nPhsRuleIndex</span> <span class="o">=</span> <span class="n">GetPhsRuleEntry</span><span class="p">(</span><span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">,</span>
		      <span class="n">phsi</span><span class="p">,</span><span class="n">eOldClassifierRuleContext</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstPhsRule</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">nPhsRuleIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">ERR_PHSRULE_MATCH_FAIL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="o">*</span><span class="n">pInHeaderSize</span> <span class="o">=</span> <span class="n">phs_decompress</span><span class="p">((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pvInputBuffer</span><span class="p">,</span>
            <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pvOutputBuffer</span><span class="p">,</span><span class="n">pstPhsRule</span><span class="p">,</span><span class="n">pOutHeaderSize</span><span class="p">);</span>

	<span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">PHSModifiedBytes</span> <span class="o">+=</span> <span class="o">*</span><span class="n">pOutHeaderSize</span> <span class="o">-</span> <span class="o">*</span><span class="n">pInHeaderSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">PHSModifiedNumPackets</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">STATUS_PHS_COMPRESSED</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><hr />

<p>Procedure:   free<em>phs</em>serviceflow_rules</p>

<p>Description: This routine is responsible for freeing memory allocated for PHS rules.</p>

<p>Arguments:
rules    - ptr to S<em>SERVICEFLOW</em>TABLE structure.</p>

<p>Returns:</p>

<h2>Does not return any value.</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">free_phs_serviceflow_rules</span><span class="p">(</span><span class="n">S_SERVICEFLOW_TABLE</span> <span class="o">*</span><span class="n">psServiceFlowRulesTable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;=======&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">psServiceFlowRulesTable</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SERVICEFLOWS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="n">stServiceFlowEntry</span> <span class="o">=</span>
                <span class="n">psServiceFlowRulesTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">pstClassifierRulesTable</span> <span class="o">=</span>
                <span class="n">stServiceFlowEntry</span><span class="p">.</span><span class="n">pstClassifierTable</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">MAX_PHSRULE_PER_SF</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span>
                                                                                        <span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
							<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span>
  							                                                <span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">--</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span>
                                                                <span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
							<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">);</span>
						<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span>
                                                                <span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
							<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span>
							                                          <span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">--</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span>
                                                                      <span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
							<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span><span class="p">);</span>
						<span class="n">pstClassifierRulesTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierRulesTable</span><span class="p">);</span>
			    <span class="n">stServiceFlowEntry</span><span class="p">.</span><span class="n">pstClassifierTable</span> <span class="o">=</span> <span class="n">pstClassifierRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

    <span class="n">kfree</span><span class="p">(</span><span class="n">psServiceFlowRulesTable</span><span class="p">);</span>
    <span class="n">psServiceFlowRulesTable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">ValidatePHSRuleComplete</span><span class="p">(</span><span class="n">IN</span> <span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">psPhsRule</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>PHSI is not valid</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>PHSS Is Undefined</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Check if PHSF is defines for the PHS Rule</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSFLength</span><span class="p">)</span> <span class="c1">// If any part of PHSF is valid then Rule contains valid PHSF</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">UINT</span> <span class="nf">GetServiceFlowEntry</span><span class="p">(</span><span class="n">IN</span> <span class="n">S_SERVICEFLOW_TABLE</span> <span class="o">*</span><span class="n">psServiceFlowTable</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span><span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">**</span><span class="n">ppstServiceFlowEntry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SERVICEFLOWS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">psServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bUsed</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">psServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">uiVcid</span> <span class="o">==</span> <span class="n">uiVcid</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="o">*</span><span class="n">ppstServiceFlowEntry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ppstServiceFlowEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">UINT</span> <span class="nf">GetClassifierEntry</span><span class="p">(</span><span class="n">IN</span> <span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">pstClassifierTable</span><span class="p">,</span>
        <span class="n">IN</span> <span class="n">B_UINT32</span> <span class="n">uiClsid</span><span class="p">,</span><span class="n">E_CLASSIFIER_ENTRY_CONTEXT</span> <span class="n">eClsContext</span><span class="p">,</span>
        <span class="n">OUT</span> <span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">**</span><span class="n">ppstClassifierEntry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">psClassifierRules</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_PHSRULE_PER_SF</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="k">if</span><span class="p">(</span><span class="n">eClsContext</span> <span class="o">==</span> <span class="n">eActiveClassifierRuleContext</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">psClassifierRules</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pstClassifierTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">psClassifierRules</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pstClassifierTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">bUsed</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">uiClassifierRuleId</span> <span class="o">==</span> <span class="n">uiClsid</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="o">*</span><span class="n">ppstClassifierEntry</span> <span class="o">=</span> <span class="n">psClassifierRules</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="o">*</span><span class="n">ppstClassifierEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="nf">GetPhsRuleEntry</span><span class="p">(</span><span class="n">IN</span> <span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">pstClassifierTable</span><span class="p">,</span>
			    <span class="n">IN</span> <span class="n">B_UINT32</span> <span class="n">uiPHSI</span><span class="p">,</span><span class="n">E_CLASSIFIER_ENTRY_CONTEXT</span> <span class="n">eClsContext</span><span class="p">,</span>
			    <span class="n">OUT</span> <span class="n">S_PHS_RULE</span> <span class="o">**</span><span class="n">ppstPhsRule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">pstClassifierRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_PHSRULE_PER_SF</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">eClsContext</span> <span class="o">==</span> <span class="n">eActiveClassifierRuleContext</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">pstClassifierRule</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pstClassifierTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">pstClassifierRule</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pstClassifierTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">bUsed</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span> <span class="o">==</span> <span class="n">uiPHSI</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="o">*</span><span class="n">ppstPhsRule</span> <span class="o">=</span> <span class="n">pstClassifierRule</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="o">*</span><span class="n">ppstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">UINT</span> <span class="nf">CreateSFToClassifierRuleMapping</span><span class="p">(</span><span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span><span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span>
                      <span class="n">IN</span> <span class="n">S_SERVICEFLOW_TABLE</span> <span class="o">*</span><span class="n">psServiceFlowTable</span><span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span>
                      <span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iSfIndex</span><span class="p">;</span>
	<span class="n">BOOLEAN</span> <span class="n">bFreeEntryFound</span> <span class="o">=</span><span class="n">FALSE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Check for a free entry in SFID table</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span><span class="p">(</span><span class="n">iSfIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">iSfIndex</span> <span class="o">&lt;</span> <span class="n">MAX_SERVICEFLOWS</span><span class="p">;</span><span class="n">iSfIndex</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">psServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">iSfIndex</span><span class="p">].</span><span class="n">bUsed</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">bFreeEntryFound</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bFreeEntryFound</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_SFTABLE_FULL</span><span class="p">;</span>


	<span class="n">psaClassifiertable</span> <span class="o">=</span> <span class="n">psServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">iSfIndex</span><span class="p">].</span><span class="n">pstClassifierTable</span><span class="p">;</span>
	<span class="n">uiStatus</span> <span class="o">=</span> <span class="n">CreateClassifierPHSRule</span><span class="p">(</span><span class="n">uiClsId</span><span class="p">,</span><span class="n">psaClassifiertable</span><span class="p">,</span><span class="n">psPhsRule</span><span class="p">,</span>
	                      <span class="n">eActiveClassifierRuleContext</span><span class="p">,</span><span class="n">u8AssociatedPHSI</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">uiStatus</span> <span class="o">==</span> <span class="n">PHS_SUCCESS</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Add entry at free index to the SF</p></td><td class="code"><div class="highlight"><pre>		<span class="n">psServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">iSfIndex</span><span class="p">].</span><span class="n">bUsed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">psServiceFlowTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">iSfIndex</span><span class="p">].</span><span class="n">uiVcid</span> <span class="o">=</span> <span class="n">uiVcid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">uiStatus</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">UINT</span> <span class="nf">CreateClassiferToPHSRuleMapping</span><span class="p">(</span><span class="n">IN</span> <span class="n">B_UINT16</span> <span class="n">uiVcid</span><span class="p">,</span>
            <span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span><span class="n">IN</span> <span class="n">S_SERVICEFLOW_ENTRY</span> <span class="o">*</span><span class="n">pstServiceFlowEntry</span><span class="p">,</span>
              <span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span><span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">pstClassifierEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiStatus</span> <span class="o">=</span><span class="n">PHS_SUCCESS</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">nClassifierIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
    <span class="n">psaClassifiertable</span> <span class="o">=</span> <span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;==&gt;&quot;</span><span class="p">);</span>

	<span class="cm">/* Check if the supplied Classifier already exists */</span>
	<span class="n">nClassifierIndex</span> <span class="o">=</span><span class="n">GetClassifierEntry</span><span class="p">(</span>
	            <span class="n">pstServiceFlowEntry</span><span class="o">-&gt;</span><span class="n">pstClassifierTable</span><span class="p">,</span><span class="n">uiClsId</span><span class="p">,</span>
	            <span class="n">eActiveClassifierRuleContext</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pstClassifierEntry</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">nClassifierIndex</span> <span class="o">==</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		    The Classifier doesn&#39;t exist. So its a new classifier being added.</span>
<span class="cm">		     Add new entry to associate PHS Rule to the Classifier</span>
<span class="cm">		*/</span>

		<span class="n">uiStatus</span> <span class="o">=</span> <span class="n">CreateClassifierPHSRule</span><span class="p">(</span><span class="n">uiClsId</span><span class="p">,</span><span class="n">psaClassifiertable</span><span class="p">,</span>
		    <span class="n">psPhsRule</span><span class="p">,</span><span class="n">eActiveClassifierRuleContext</span><span class="p">,</span><span class="n">u8AssociatedPHSI</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">uiStatus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	  The Classifier exists.The PHS Rule for this classifier</span>
<span class="cm">	  is being modified</span>
<span class="cm">	  */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">u8PHSI</span> <span class="o">==</span> <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PHS_INVALID_PHS_RULE</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		    This rule already exists if any fields are changed for this PHS</span>
<span class="cm">		    rule update them.</span>
<span class="cm">		 */</span>
		 <span class="cm">/* If any part of PHSF is valid then we update PHSF */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSFLength</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>update PHSF</p></td><td class="code"><div class="highlight"><pre>			<span class="n">memcpy</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSF</span><span class="p">,</span>
			    <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSF</span> <span class="p">,</span> <span class="n">MAX_PHS_LENGTHS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSFLength</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>update PHSFLen</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSFLength</span> <span class="o">=</span>
			    <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSFLength</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSMLength</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>update PHSM</p></td><td class="code"><div class="highlight"><pre>			<span class="n">memcpy</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSM</span><span class="p">,</span>
			    <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSM</span><span class="p">,</span> <span class="n">MAX_PHS_LENGTHS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSMLength</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>update PHSM Len</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSMLength</span> <span class="o">=</span>
			    <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSMLength</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>update PHSS</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span> <span class="o">=</span> <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>update PHSV</p></td><td class="code"><div class="highlight"><pre>		<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSV</span> <span class="o">=</span> <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSV</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  A new rule is being set for this classifier.</span>
<span class="cm">		*/</span>
		<span class="n">uiStatus</span><span class="o">=</span><span class="n">UpdateClassifierPHSRule</span><span class="p">(</span> <span class="n">uiClsId</span><span class="p">,</span>  <span class="n">pstClassifierEntry</span><span class="p">,</span>
		      <span class="n">psaClassifiertable</span><span class="p">,</span>  <span class="n">psPhsRule</span><span class="p">,</span> <span class="n">u8AssociatedPHSI</span><span class="p">);</span>
	<span class="p">}</span>



	<span class="k">return</span> <span class="n">uiStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">UINT</span> <span class="nf">CreateClassifierPHSRule</span><span class="p">(</span><span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span>
    <span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span> <span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span>
    <span class="n">E_CLASSIFIER_ENTRY_CONTEXT</span> <span class="n">eClsContext</span><span class="p">,</span><span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">iClassifierIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BOOLEAN</span> <span class="n">bFreeEntryFound</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">psClassifierRules</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">nStatus</span> <span class="o">=</span> <span class="n">PHS_SUCCESS</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;Inside CreateClassifierPHSRule&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">psaClassifiertable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">ERR_INVALID_CLASSIFIERTABLE_FOR_SF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eClsContext</span> <span class="o">==</span> <span class="n">eOldClassifierRuleContext</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* If An Old Entry for this classifier ID already exists in the</span>
<span class="cm">		    old rules table replace it. */</span>

		<span class="n">iClassifierIndex</span> <span class="o">=</span>
		<span class="n">GetClassifierEntry</span><span class="p">(</span><span class="n">psaClassifiertable</span><span class="p">,</span> <span class="n">uiClsId</span><span class="p">,</span>
		            <span class="n">eClsContext</span><span class="p">,</span><span class="o">&amp;</span><span class="n">psClassifierRules</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">iClassifierIndex</span> <span class="o">!=</span> <span class="n">PHS_INVALID_TABLE_INDEX</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			    The Classifier already exists in the old rules table</span>
<span class="cm">		        Lets replace the old classifier with the new one.</span>
<span class="cm">			*/</span>
			<span class="n">bFreeEntryFound</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bFreeEntryFound</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  Continue to search for a free location to add the rule</span>
<span class="cm">		*/</span>
		<span class="k">for</span><span class="p">(</span><span class="n">iClassifierIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iClassifierIndex</span> <span class="o">&lt;</span>
            <span class="n">MAX_PHSRULE_PER_SF</span><span class="p">;</span> <span class="n">iClassifierIndex</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">eClsContext</span> <span class="o">==</span> <span class="n">eActiveClassifierRuleContext</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">psClassifierRules</span> <span class="o">=</span>
              <span class="o">&amp;</span><span class="n">psaClassifiertable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">iClassifierIndex</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">psClassifierRules</span> <span class="o">=</span>
                <span class="o">&amp;</span><span class="n">psaClassifiertable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">iClassifierIndex</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">bUsed</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">bFreeEntryFound</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bFreeEntryFound</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">eClsContext</span> <span class="o">==</span> <span class="n">eActiveClassifierRuleContext</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">ERR_CLSASSIFIER_TABLE_FULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Lets replace the oldest rule if we are looking in old Rule table</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">psaClassifiertable</span><span class="o">-&gt;</span><span class="n">uiOldestPhsRuleIndex</span> <span class="o">&gt;=</span>
                <span class="n">MAX_PHSRULE_PER_SF</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">psaClassifiertable</span><span class="o">-&gt;</span><span class="n">uiOldestPhsRuleIndex</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">iClassifierIndex</span> <span class="o">=</span> <span class="n">psaClassifiertable</span><span class="o">-&gt;</span><span class="n">uiOldestPhsRuleIndex</span><span class="p">;</span>
			<span class="n">psClassifierRules</span> <span class="o">=</span>
              <span class="o">&amp;</span><span class="n">psaClassifiertable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">iClassifierIndex</span><span class="p">];</span>

          <span class="p">(</span><span class="n">psaClassifiertable</span><span class="o">-&gt;</span><span class="n">uiOldestPhsRuleIndex</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eClsContext</span> <span class="o">==</span> <span class="n">eOldClassifierRuleContext</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">S_PHS_RULE</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ERR_PHSRULE_MEMALLOC_FAIL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">bUsed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">uiClassifierRuleId</span> <span class="o">=</span> <span class="n">uiClsId</span><span class="p">;</span>
		<span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">u8PHSI</span> <span class="o">=</span> <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span><span class="p">;</span>
		<span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">bUnclassifiedPHSRule</span> <span class="o">=</span> <span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">bUnclassifiedPHSRule</span><span class="p">;</span>

        <span class="cm">/* Update The PHS rule */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">psClassifierRules</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">,</span>
		    <span class="n">psPhsRule</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_PHS_RULE</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">nStatus</span> <span class="o">=</span> <span class="n">UpdateClassifierPHSRule</span><span class="p">(</span><span class="n">uiClsId</span><span class="p">,</span><span class="n">psClassifierRules</span><span class="p">,</span>
            <span class="n">psaClassifiertable</span><span class="p">,</span><span class="n">psPhsRule</span><span class="p">,</span><span class="n">u8AssociatedPHSI</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">UINT</span> <span class="nf">UpdateClassifierPHSRule</span><span class="p">(</span><span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span>
      <span class="n">IN</span> <span class="n">S_CLASSIFIER_ENTRY</span> <span class="o">*</span><span class="n">pstClassifierEntry</span><span class="p">,</span>
      <span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span> <span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">psPhsRule</span><span class="p">,</span>
      <span class="n">B_UINT8</span> <span class="n">u8AssociatedPHSI</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">pstAddPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UINT</span>              <span class="n">nPhsRuleIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BOOLEAN</span>       <span class="n">bPHSRuleOrphaned</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Step 1 Deref Any Exisiting PHS Rule in this classifier Entry*/</span>
	<span class="n">bPHSRuleOrphaned</span> <span class="o">=</span> <span class="n">DerefPhsRule</span><span class="p">(</span> <span class="n">uiClsId</span><span class="p">,</span> <span class="n">psaClassifiertable</span><span class="p">,</span>
	    <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Step 2 Search if there is a PHS Rule with u8AssociatedPHSI in Classifier table for this SF</p></td><td class="code"><div class="highlight"><pre>	<span class="n">nPhsRuleIndex</span> <span class="o">=</span><span class="n">GetPhsRuleEntry</span><span class="p">(</span><span class="n">psaClassifiertable</span><span class="p">,</span><span class="n">u8AssociatedPHSI</span><span class="p">,</span>
	    <span class="n">eActiveClassifierRuleContext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pstAddPhsRule</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">PHS_INVALID_TABLE_INDEX</span> <span class="o">==</span> <span class="n">nPhsRuleIndex</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Adding New PHSRuleEntry For Classifier&quot;</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">psPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Error PHSI is Zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERR_PHS_INVALID_PHS_RULE</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Step 2.a PHS Rule Does Not Exist .Create New PHS Rule for uiClsId</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">bPHSRuleOrphaned</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">S_PHS_RULE</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">return</span> <span class="n">ERR_PHSRULE_MEMALLOC_FAIL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">,</span> <span class="n">psPhsRule</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_PHS_RULE</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Step 2.b PHS Rule  Exists Tie uiClsId with the existing PHS Rule</p></td><td class="code"><div class="highlight"><pre>		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_DISPATCH</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Tying Classifier to Existing PHS Rule&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bPHSRuleOrphaned</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="p">);</span>
			<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span> <span class="o">=</span> <span class="n">pstAddPhsRule</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bUsed</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">u8PHSI</span> <span class="o">=</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span><span class="p">;</span>
	<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">uiClassifierRuleId</span> <span class="o">=</span> <span class="n">uiClsId</span><span class="p">;</span>
	<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bUnclassifiedPHSRule</span> <span class="o">=</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">bUnclassifiedPHSRule</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PHS_SUCCESS</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">BOOLEAN</span> <span class="nf">DerefPhsRule</span><span class="p">(</span><span class="n">IN</span> <span class="n">B_UINT16</span>  <span class="n">uiClsId</span><span class="p">,</span><span class="n">S_CLASSIFIER_TABLE</span> <span class="o">*</span><span class="n">psaClassifiertable</span><span class="p">,</span><span class="n">S_PHS_RULE</span> <span class="o">*</span><span class="n">pstPhsRule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pstPhsRule</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
		<span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8RefCnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/*if(pstPhsRule-&gt;u8PHSI)</span>

<span class="cm">//DIVIDER</span>
<span class="cm">		CreateClassifierPHSRule(uiClsId,psaClassifiertable,pstPhsRule,eOldClassifierRuleContext,pstPhsRule-&gt;u8PHSI);*/</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DumpPhsRules</span><span class="p">(</span><span class="n">PPHS_DEVICE_EXTENSION</span> <span class="n">pDeviceExtension</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> Dumping PHS Rules : </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SERVICEFLOWS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">S_SERVICEFLOW_ENTRY</span> <span class="n">stServFlowEntry</span> <span class="o">=</span>
				<span class="n">pDeviceExtension</span><span class="o">-&gt;</span><span class="n">pstServiceFlowPhsRulesTable</span><span class="o">-&gt;</span><span class="n">stSFList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">stServFlowEntry</span><span class="p">.</span><span class="n">bUsed</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">MAX_PHSRULE_PER_SF</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">l</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">l</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">S_CLASSIFIER_ENTRY</span> <span class="n">stClsEntry</span><span class="p">;</span>
					<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">stClsEntry</span> <span class="o">=</span> <span class="n">stServFlowEntry</span><span class="p">.</span><span class="n">pstClassifierTable</span><span class="o">-&gt;</span><span class="n">stActivePhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
						<span class="k">if</span><span class="p">(</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">bUsed</span><span class="p">)</span>
							<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> Active PHS Rule : </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">stClsEntry</span> <span class="o">=</span> <span class="n">stServFlowEntry</span><span class="p">.</span><span class="n">pstClassifierTable</span><span class="o">-&gt;</span><span class="n">stOldPhsRulesList</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
						<span class="k">if</span><span class="p">(</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">bUsed</span><span class="p">)</span>
							<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> Old PHS Rule : </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span><span class="p">(</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">bUsed</span><span class="p">)</span>
					<span class="p">{</span>

						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> VCID  : %#X&quot;</span><span class="p">,</span><span class="n">stServFlowEntry</span><span class="p">.</span><span class="n">uiVcid</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> ClassifierID  : %#X&quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">uiClassifierRuleId</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSRuleID  : %#X&quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">u8PHSI</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">****************PHS Rule********************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSI  : %#X&quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSFLength : %#X &quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSFLength</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSF : &quot;</span><span class="p">);</span>
						<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSFLength</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;%#X  &quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSF</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
						<span class="p">}</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSMLength  : %#X&quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSMLength</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSM :&quot;</span><span class="p">);</span>
						<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSMLength</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;%#X  &quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSM</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
						<span class="p">}</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSS : %#X &quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">DBG_LVL_ALL</span><span class="o">|</span><span class="n">DBG_NO_FUNC_PRINT</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> PHSV  : %#X&quot;</span><span class="p">,</span><span class="n">stClsEntry</span><span class="p">.</span><span class="n">pstPhsRule</span><span class="o">-&gt;</span><span class="n">u8PHSV</span><span class="p">);</span>
						<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">********************************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Store the currently active rule into the old rules list</p></td><td class="code"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">phs_decompress</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span>
 <span class="n">S_PHS_RULE</span>   <span class="o">*</span><span class="n">decomp_phs_rules</span><span class="p">,</span><span class="n">UINT</span> <span class="o">*</span><span class="n">header_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">phss</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	 <span class="n">S_PHS_RULE</span>   <span class="o">*</span><span class="n">tmp_memb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phsf</span><span class="p">,</span><span class="o">*</span><span class="n">phsm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_buf_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">header_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">in_buf</span><span class="o">++</span><span class="p">;</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;====&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">header_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">decomp_phs_rules</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">tmp_memb</span> <span class="o">=</span> <span class="n">decomp_phs_rules</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><hr />

<p>Procedure:   phs_decompress</p>

<p>Description: This routine restores the static fields within the packet.</p>

<p>Arguments:
in<em>buf            - ptr to incoming packet buffer.
out</em>buf            - ptr to output buffer where the suppressed header is copied.
decomp<em>phs</em>rules - ptr to PHS rule.
header<em>size        - ptr to field which holds the phss or phsf</em>length.</p>

<p>Returns:
size -The number of bytes of dynamic fields present with in the incoming packet
        header.</p>

<h2>0    -If PHS rule is NULL.If PHSI is 0 indicateing packet as uncompressed.</h2></td><td class="code"><div class="highlight"><pre>	<span class="n">phss</span>         <span class="o">=</span> <span class="n">tmp_memb</span><span class="o">-&gt;</span><span class="n">u8PHSS</span><span class="p">;</span>
	<span class="n">phsf</span>         <span class="o">=</span> <span class="n">tmp_memb</span><span class="o">-&gt;</span><span class="n">u8PHSF</span><span class="p">;</span>
	<span class="n">phsm</span>         <span class="o">=</span> <span class="n">tmp_memb</span><span class="o">-&gt;</span><span class="n">u8PHSM</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">phss</span> <span class="o">&gt;</span> <span class="n">MAX_PHS_LENGTHS</span><span class="p">)</span>
		<span class="n">phss</span> <span class="o">=</span> <span class="n">MAX_PHS_LENGTHS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>BCM<em>DEBUG</em>PRINT(Adapter,DBG<em>TYPE</em>OTHERS, PHS<em>RECEIVE,DBG</em>LVL<em>ALL,"\nDECOMP:In phs</em>decompress PHSI 1  %d",phsi));
*header<em>size = tmp</em>memb->u8PHSFLength;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span><span class="p">((</span><span class="n">phss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">in_buf_len</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span>  <span class="p">((</span><span class="o">*</span><span class="n">phsm</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">SUPPRESS</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="n">SUPPRESS</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="o">*</span><span class="n">out_buf</span> <span class="o">=</span> <span class="o">*</span><span class="n">phsf</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">DECOMP:In phss  %d phsf %d ouput %d&quot;</span><span class="p">,</span>
              <span class="n">phss</span><span class="p">,</span><span class="o">*</span><span class="n">phsf</span><span class="p">,</span><span class="o">*</span><span class="n">out_buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="o">*</span><span class="n">out_buf</span> <span class="o">=</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_RECEIVE</span><span class="p">,</span><span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">DECOMP:In phss  %d input %d ouput %d&quot;</span><span class="p">,</span>
            <span class="n">phss</span><span class="p">,</span><span class="o">*</span><span class="n">in_buf</span><span class="p">,</span><span class="o">*</span><span class="n">out_buf</span><span class="p">);</span>
			<span class="n">in_buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">out_buf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">phsf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">phss</span><span class="o">--</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">header_size</span><span class="o">=*</span><span class="n">header_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_NO_BIT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="n">phsm</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>BCM<em>DEBUG</em>PRINT(Adapter,DBG<em>TYPE</em>OTHERS, PHS<em>RECEIVE,DBG</em>LVL<em>ALL,"\nDECOMP:In phs</em>decompress PHSI  %d phss %d index %d",phsi,phss,index));</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">phs_compress</span><span class="p">(</span><span class="n">S_PHS_RULE</span>  <span class="o">*</span><span class="n">phs_rule</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span>
			<span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span><span class="n">UINT</span> <span class="o">*</span><span class="n">header_size</span><span class="p">,</span><span class="n">UINT</span> <span class="o">*</span><span class="n">new_header_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_addr</span> <span class="o">=</span> <span class="n">out_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">supress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">phs_rule</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">phs_compress(): phs_rule null!&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">out_buf</span> <span class="o">=</span> <span class="n">ZERO_PHSI</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">STATUS_PHS_NOCOMPRESSION</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span><span class="p">(</span><span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">new_header_size</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="o">*</span><span class="n">header_size</span> <span class="o">=</span> <span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="o">*</span><span class="n">header_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_header_size</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><hr />

<p>Procedure:   phs_compress</p>

<p>Description: This routine suppresses the static fields within the packet.Before
that it will verify the fields to be suppressed with the corresponding fields in the
phsf. For verification it checks the phsv field of PHS rule. If set and verification
succeeds it suppresses the field.If any one static field is found different none of
the static fields are suppressed then the packet is sent as uncompressed packet with
phsi=0.</p>

<p>Arguments:
phs<em>rule - ptr to PHS rule.
in</em>buf        - ptr to incoming packet buffer.
out<em>buf        - ptr to output buffer where the suppressed header is copied.
header</em>size    - ptr to field which holds the phss.</p>

<p>Returns:
size-The number of bytes copied into the output buffer i.e dynamic fields</p>

<h2>0    -If PHS rule is NULL.If PHSV field is not set.If the verification fails.</h2></td><td class="code"><div class="highlight"><pre>	<span class="n">out_buf</span><span class="o">++</span><span class="p">;</span>
	<span class="n">supress</span> <span class="o">=</span> <span class="n">verify_suppress_phsf</span><span class="p">(</span><span class="n">in_buf</span><span class="p">,</span><span class="n">out_buf</span><span class="p">,</span><span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSF</span><span class="p">,</span>
        <span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSM</span><span class="p">,</span> <span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSS</span><span class="p">,</span> <span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSV</span><span class="p">,</span><span class="n">new_header_size</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">supress</span> <span class="o">==</span> <span class="n">STATUS_PHS_COMPRESSED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="o">*</span><span class="n">old_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">COMP:In phs_compress phsi %d&quot;</span><span class="p">,</span><span class="n">phs_rule</span><span class="o">-&gt;</span><span class="n">u8PHSI</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="o">*</span><span class="n">old_addr</span> <span class="o">=</span> <span class="n">ZERO_PHSI</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">COMP:In phs_compress PHSV Verification failed&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">supress</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>To copy PHSI</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_suppress_phsf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phsf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phsm</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phss</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phsv</span><span class="p">,</span><span class="n">UINT</span><span class="o">*</span> <span class="n">new_header_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
    <span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">COMP:In verify_phsf PHSM - 0x%X&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">phsm</span><span class="p">);</span>


	<span class="k">if</span><span class="p">(</span><span class="n">phss</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">new_header_size</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">phss</span><span class="o">=*</span><span class="n">new_header_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span><span class="p">(</span><span class="n">phss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">phsm</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">SUPPRESS</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="n">SUPPRESS</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">in_buffer</span> <span class="o">!=</span> <span class="o">*</span><span class="n">phsf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">phsv</span> <span class="o">==</span> <span class="n">VERIFY</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">COMP:In verify_phsf failed for field  %d buf  %d phsf %d&quot;</span><span class="p">,</span><span class="n">phss</span><span class="p">,</span><span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="o">*</span><span class="n">phsf</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">STATUS_PHS_NOCOMPRESSION</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">COMP:In verify_phsf success for field  %d buf  %d phsf %d&quot;</span><span class="p">,</span><span class="n">phss</span><span class="p">,</span><span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="o">*</span><span class="n">phsf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="o">*</span><span class="n">out_buffer</span> <span class="o">=</span> <span class="o">*</span><span class="n">in_buffer</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">COMP:In copying_header input %d  out %d&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="o">*</span><span class="n">out_buffer</span><span class="p">);</span>
			<span class="n">out_buffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">size</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">in_buffer</span><span class="o">++</span><span class="p">;</span>
		<span class="n">phsf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">phss</span><span class="o">--</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_NO_BIT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="n">phsm</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span><span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">PHS_SEND</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">COMP:In verify_phsf success&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">new_header_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">STATUS_PHS_COMPRESSED</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><hr />

<p>Procedure:    verify<em>suppress</em>phsf</p>

<p>Description: This routine verifies the fields of the packet and if all the
static fields are equal it adds the phsi of that PHS rule.If any static
field differs it woun't suppress any field.</p>

<p>Arguments:
rules<em>set    - ptr to classifier</em>rules.
in<em>buffer    - ptr to incoming packet buffer.
out</em>buffer    - ptr to output buffer where the suppressed header is copied.
phsf            - ptr to phsf.
phsm            - ptr to phsm.
phss            - variable holding phss.</p>

<p>Returns:
size-The number of bytes copied into the output buffer i.e dynamic fields.</p>

<h2>0    -Packet has failed the verification.</h2></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
