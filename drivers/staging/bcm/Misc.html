<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › bcm › Misc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>Misc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;headers.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">BcmFileDownload</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">VOID</span> <span class="n">doPowerAutoCorrection</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">psAdapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">HandleShutDownModeRequest</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">PUCHAR</span> <span class="n">pucBuffer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bcm_parse_target_params</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">beceem_protocol_reset</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">);</span>

<span class="k">static</span> <span class="n">VOID</span> <span class="nf">default_wimax_protocol_initialize</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiLoopIndex</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&lt;</span> <span class="n">NO_OF_QUEUES</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">uiLoopIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiThreshold</span> <span class="o">=</span> <span class="n">TX_PACKET_THRESHOLD</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiMaxAllowedRate</span> <span class="o">=</span> <span class="n">MAX_ALLOWED_RATE</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiMaxBucketSize</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">BEBucketSize</span> <span class="o">=</span> <span class="n">BE_BUCKET_SIZE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rtPSBucketSize</span> <span class="o">=</span> <span class="n">rtPS_BUCKET_SIZE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="n">SYNC_UP_REQUEST</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TransferMode</span> <span class="o">=</span> <span class="n">IP_PACKET_ONLY_MODE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usBestEffortQueueIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">INT</span> <span class="nf">InitAdapter</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">psAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INT</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Initialising Adapter = %p&quot;</span><span class="p">,</span> <span class="n">psAdapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psAdapter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Adapter is NULL&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">control_queue_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">txtransmitlock</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">RxAppControlQueuelock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">fw_download_sema</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NO_OF_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">process_rx_cntrlpkt</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">tx_packet_wait_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">process_read_wait_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">ioctl_fw_dnld_wait_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">lowpower_mode_wait_queue</span><span class="p">);</span>
	<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">waiting_to_fw_download_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">fw_download_done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">default_wimax_protocol_initialize</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CNTRL_PKTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">txctlpacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_CNTL_PKT_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">txctlpacket</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;No More Cntl pkts got, max got is %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AllocAdapterDsxBuffer</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Failed to allocate DSX buffers&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize PHS interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phs_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">stBCMPhsContext</span><span class="p">,</span> <span class="n">psAdapter</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;%s:%s:%d:Error PHS Init Failed=====&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Status</span> <span class="o">=</span> <span class="n">BcmAllocFlashCSStructure</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Memory Allocation for Flash structure failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Status</span> <span class="o">=</span> <span class="n">vendorextnInit</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">STATUS_SUCCESS</span> <span class="o">!=</span> <span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Vendor Init Failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Adapter initialised&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">AdapterFree</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">beceem_protocol_reset</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
	<span class="n">vendorextnExit</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">control_packet_handler</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">control_packet_handler</span><span class="p">))</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">control_packet_handler</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">transmit_packet_thread</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">transmit_packet_thread</span><span class="p">))</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">transmit_packet_thread</span><span class="p">);</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">process_read_wait_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span> <span class="o">|</span> <span class="n">BCM_LED_THREAD_RUNNING_INACTIVELY</span><span class="p">))</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_cntrl_threadid</span><span class="p">);</span>

	<span class="n">unregister_networkdev</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>

	<span class="cm">/* FIXME: use proper wait_event and refcounting */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ApplicationRunning</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Waiting for Application to close.. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ApplicationRunning</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">unregister_control_device_interface</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">MAX_CNTRL_PKTS</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">txctlpacket</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

	<span class="n">FreeAdapterDsxBuffer</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">);</span>

	<span class="cm">/* Free the PHS Interface */</span>
	<span class="n">PhsCleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">stBCMPhsContext</span><span class="p">);</span>

	<span class="n">BcmDeAllocFlashCSStructure</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_worker_threads</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">psAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Rx Control Packets Processing */</span>
	<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">control_packet_handler</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span>
							<span class="n">control_packet_handler</span><span class="p">,</span> <span class="n">psAdapter</span><span class="p">,</span> <span class="s">&quot;%s-rx&quot;</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">control_packet_handler</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: could not create control thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">control_packet_handler</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Tx Thread */</span>
	<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">transmit_packet_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span>
							<span class="n">tx_pkt_handler</span><span class="p">,</span> <span class="n">psAdapter</span><span class="p">,</span> <span class="s">&quot;%s-tx&quot;</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">transmit_packet_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: could not creat transmit thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">control_packet_handler</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">transmit_packet_thread</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">open_firmware_file</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">flp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">flp</span> <span class="o">=</span> <span class="n">filp_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">flp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;Unable To Open File %s, err %ld&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">flp</span><span class="p">));</span>
		<span class="n">flp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">device_removed</span><span class="p">)</span>
		<span class="n">flp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">flp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Arguments:</span>
<span class="cm"> * Logical Adapter</span>
<span class="cm"> * Path to image file</span>
<span class="cm"> * Download Address on the chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">BcmFileDownload</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">errorno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">flp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">open_firmware_file</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errorno</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Unable to Open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_download</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Opened file is = %s and length =0x%lx to be downloaded at =0x%x&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">,</span> <span class="n">loc</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;download start %lx&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bcm_file_download</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">,</span> <span class="n">flp</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Failed to download the firmware with error %x!!!&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="n">errorno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_download</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">vfs_llseek</span><span class="p">(</span><span class="n">flp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bcm_file_readback_from_chip</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">,</span> <span class="n">flp</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Failed to read back firmware!&quot;</span><span class="p">);</span>
		<span class="n">errorno</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_download</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit_download:</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">flp</span><span class="p">)))</span>
		<span class="n">filp_close</span><span class="p">(</span><span class="n">flp</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">errorno</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @ingroup ctrl_pkt_functions</span>
<span class="cm"> * This function copies the contents of given buffer</span>
<span class="cm"> * to the control packet and queues it for transmission.</span>
<span class="cm"> * @note Do not acquire the spinock, as it it already acquired.</span>
<span class="cm"> * @return  SUCCESS/FAILURE.</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> * Logical Adapter</span>
<span class="cm"> * Control Packet Buffer</span>
<span class="cm"> */</span>
<span class="n">INT</span> <span class="nf">CopyBufferToControlPacket</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">ioBuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PLEADER</span>	<span class="n">pLeader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">INT</span> <span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ctrl_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PLINK_REQUEST</span> <span class="n">pLinkReq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PUCHAR</span> <span class="n">pucAddIndication</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;======&gt;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioBuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Got Null Buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pLinkReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLINK_REQUEST</span><span class="p">)</span><span class="n">ioBuffer</span><span class="p">;</span>
	<span class="n">pLeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLEADER</span><span class="p">)</span><span class="n">ioBuffer</span><span class="p">;</span> <span class="cm">/* ioBuffer Contains sw_Status and Payload */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span> <span class="o">&amp;&amp;</span>
		<span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">LINK_DOWN_REQ_PAYLOAD</span> <span class="o">&amp;&amp;</span>
		<span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">LINK_SYNC_UP_SUBTYPE</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Got sync down in SHUTDOWN..we could not process this. */</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;SYNC DOWN Request in Shut Down Mode..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">LINK_UP_CONTROL_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">LINK_UP_REQ_PAYLOAD</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">LINK_SYNC_UP_SUBTYPE</span><span class="p">))</span> <span class="o">||</span> <span class="cm">/* Sync Up Command */</span>
			<span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">NETWORK_ENTRY_REQ_PAYLOAD</span><span class="p">))</span> <span class="cm">/* Net Entry Command */</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">&gt;</span> <span class="n">PHY_SYNC_ACHIVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;LinkStatus is Greater than PHY_SYN_ACHIEVED&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;SYNC UP IN SHUTDOWN..Device WakeUp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bTriedToWakeUpFromlowPowerMode</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Waking up for the First Time..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usIdleModePattern</span> <span class="o">=</span> <span class="n">ABORT_SHUTDOWN_MODE</span><span class="p">;</span> <span class="cm">/* change it to 1 for current support. */</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bWakeUpDevice</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">process_rx_cntrlpkt</span><span class="p">);</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">lowpower_mode_wait_queue</span><span class="p">,</span> <span class="o">!</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Shutdown Mode Wake up Failed - No Wake Up Received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Wakeup has been tried already...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TRUE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0,&quot;Device is in Idle mode ... hence\n&quot;); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">LINK_UP_CONTROL_REQ</span> <span class="o">||</span> <span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="mh">0x80</span> <span class="o">||</span>
			<span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">CM_CONTROL_NEWDSX_MULTICLASSIFIER_REQ</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">LINK_UP_CONTROL_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">LINK_DOWN_REQ_PAYLOAD</span><span class="p">))</span>	<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">LINK_SYNC_DOWN_SUBTYPE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Link Down Sent in Idle Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usIdleModePattern</span> <span class="o">=</span> <span class="n">ABORT_IDLE_SYNCDOWN</span><span class="p">;</span> <span class="cm">/* LINK DOWN sent in Idle Mode */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ABORT_IDLE_MODE pattern is being written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usIdleModePattern</span> <span class="o">=</span> <span class="n">ABORT_IDLE_REG</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ABORT_IDLE_MODE pattern is being written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usIdleModePattern</span> <span class="o">=</span> <span class="n">ABORT_IDLE_MODE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*Setting bIdleMode_tx_from_host to TRUE to indicate LED control thread to represent</span>
<span class="cm">			 *  the wake up from idlemode is from host</span>
<span class="cm">			 */</span>
			<span class="cm">/* Adapter-&gt;LEDInfo.bIdleMode_tx_from_host = TRUE; */</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bWakeUpDevice</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">process_rx_cntrlpkt</span><span class="p">);</span>

			<span class="cm">/* We should not send DREG message down while in idlemode. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">LINK_DOWN_REQ_PAYLOAD</span> <span class="o">==</span> <span class="n">pLinkReq</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

			<span class="n">Status</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">lowpower_mode_wait_queue</span><span class="p">,</span> <span class="o">!</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Idle Mode Wake up Failed - No Wake Up Received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The Driver has to send control messages with a particular VCID */</span>
	<span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Vcid</span> <span class="o">=</span> <span class="n">VCID_CONTROL_PACKET</span><span class="p">;</span> <span class="cm">/* VCID for control packet. */</span>

	<span class="cm">/* Allocate skb for Control Packet */</span>
	<span class="n">pktlen</span> <span class="o">=</span> <span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">;</span>
	<span class="n">ctrl_buff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">txctlpacket</span><span class="p">[</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">index_wr_txcntrlpkt</span><span class="p">)</span><span class="o">%</span><span class="n">MAX_CNTRL_PKTS</span><span class="p">];</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Control packet to be taken =%d and address is =%pincoming address is =%p and packet len=%x&quot;</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">index_wr_txcntrlpkt</span><span class="p">),</span> <span class="n">ctrl_buff</span><span class="p">,</span> <span class="n">ioBuffer</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pLeader</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span> <span class="n">CM_CONTROL_NEWDSX_MULTICLASSIFIER_REQ</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Restructure the DSX message to handle Multiple classifier Support</span>
<span class="cm">				 * Write the Service Flow param Structures directly to the target</span>
<span class="cm">				 * and embed the pointers in the DSX messages sent to target.</span>
<span class="cm">				 */</span>
				<span class="cm">/* Lets store the current length of the control packet we are transmitting */</span>
				<span class="n">pucAddIndication</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">ioBuffer</span> <span class="o">+</span> <span class="n">LEADER_SIZE</span><span class="p">;</span>
				<span class="n">pktlen</span> <span class="o">=</span> <span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">;</span>
				<span class="n">Status</span> <span class="o">=</span> <span class="n">StoreCmControlResponseMessage</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pucAddIndication</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pktlen</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ClearTargetDSXBuffer</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">((</span><span class="n">stLocalSFAddIndicationAlt</span> <span class="o">*</span><span class="p">)</span><span class="n">pucAddIndication</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u16TID</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot; Error Restoring The DSX Control Packet. Dsx Buffers on Target may not be Setup Properly &quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * update the leader to use the new length</span>
<span class="cm">				 * The length of the control packet is length of message being sent + Leader length</span>
<span class="cm">				 */</span>
				<span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">pktlen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pktlen</span> <span class="o">+</span> <span class="n">LEADER_SIZE</span> <span class="o">&gt;</span> <span class="n">MAX_CNTL_PKT_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">ctrl_buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pktlen</span><span class="o">+</span><span class="n">LEADER_SIZE</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Copying the Control Packet Buffer with length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">PLEADER</span><span class="p">)</span><span class="n">ctrl_buff</span> <span class="o">=</span> <span class="o">*</span><span class="n">pLeader</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ctrl_buff</span> <span class="o">+</span> <span class="n">LEADER_SIZE</span><span class="p">,</span> <span class="p">((</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">ioBuffer</span> <span class="o">+</span> <span class="n">LEADER_SIZE</span><span class="p">),</span> <span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Enqueuing the Control Packet&quot;</span><span class="p">);</span>

		<span class="cm">/* Update the statistics counters */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">HiPriority</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">HiPriority</span><span class="p">].</span><span class="n">uiCurrentBytesOnHost</span> <span class="o">+=</span> <span class="n">pLeader</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">;</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">HiPriority</span><span class="p">].</span><span class="n">uiCurrentPacketsOnHost</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">HiPriority</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">HiPriority</span><span class="p">].</span><span class="n">bValid</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;CurrBytesOnHost: %x bValid: %x&quot;</span><span class="p">,</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">HiPriority</span><span class="p">].</span><span class="n">uiCurrentBytesOnHost</span><span class="p">,</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">HiPriority</span><span class="p">].</span><span class="n">bValid</span><span class="p">);</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="cm">/*Queue the packet for transmission */</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">index_wr_txcntrlpkt</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Calling transmit_packets&quot;</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TxPktAvail</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">tx_packet_wait_queue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">Status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;mem allocation Failed&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_TX</span><span class="p">,</span> <span class="n">TX_CONTROL</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;&lt;====&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*****************************************************************</span>
<span class="c">* Function    - SendStatisticsPointerRequest()</span>
<span class="c">*</span>
<span class="c">* Description - This function builds and forwards the Statistics</span>
<span class="c">* Pointer Request control Packet.</span>
<span class="c">*</span>
<span class="c">* Parameters  - Adapter					: Pointer to Adapter structure.</span>
<span class="c">* - pstStatisticsPtrRequest : Pointer to link request.</span>
<span class="c">*</span>
<span class="c">* Returns     - None.</span>
<span class="c">*****************************************************************/</span>
<span class="c">static VOID SendStatisticsPointerRequest(PMINI_ADAPTER Adapter, PLINK_REQUEST pstStatisticsPtrRequest)</span>
<span class="c">{</span>
<span class="c">	BCM_DEBUG_PRINT(Adapter, DBG_TYPE_RX, RX_DPC, DBG_LVL_ALL, &quot;======&gt;&quot;);</span>
<span class="c">	pstStatisticsPtrRequest-&gt;Leader.Status = STATS_POINTER_REQ_STATUS;</span>
<span class="c">	pstStatisticsPtrRequest-&gt;Leader.PLength = sizeof(ULONG); /* minimum 4 bytes */</span>
<span class="c">	pstStatisticsPtrRequest-&gt;szData[0] = STATISTICS_POINTER_REQ;</span>
<span class="c">	CopyBufferToControlPacket(Adapter, pstStatisticsPtrRequest);</span>
<span class="c">	BCM_DEBUG_PRINT(Adapter, DBG_TYPE_RX, RX_DPC, DBG_LVL_ALL, &quot;&lt;=====&quot;);</span>
<span class="c">	return;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/******************************************************************</span>
<span class="cm">* Function    - LinkMessage()</span>
<span class="cm">*</span>
<span class="cm">* Description - This function builds the Sync-up and Link-up request</span>
<span class="cm">* packet messages depending on the device Link status.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - Adapter:	Pointer to the Adapter structure.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - None.</span>
<span class="cm">*******************************************************************/</span>
<span class="n">VOID</span> <span class="nf">LinkMessage</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PLINK_REQUEST</span> <span class="n">pstLinkRequest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">LINK_UP_MSG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;=====&gt;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">==</span> <span class="n">SYNC_UP_REQUEST</span> <span class="o">&amp;&amp;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoSyncup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pstLinkRequest</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">LINK_REQUEST</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pstLinkRequest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">LINK_UP_MSG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Can not allocate memory for Link request!&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* sync up request... */</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="n">WAIT_FOR_SYNC</span><span class="p">;</span> <span class="cm">/* current link status */</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">LINK_UP_MSG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Requesting For SyncUp...&quot;</span><span class="p">);</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINK_UP_REQ_PAYLOAD</span><span class="p">;</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINK_SYNC_UP_SUBTYPE</span><span class="p">;</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">Leader</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">LINK_UP_CONTROL_REQ</span><span class="p">;</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">Leader</span><span class="p">.</span><span class="n">PLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bSyncUpRequestSent</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">==</span> <span class="n">PHY_SYNC_ACHIVED</span> <span class="o">&amp;&amp;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoLinkUp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pstLinkRequest</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">LINK_REQUEST</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pstLinkRequest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">LINK_UP_MSG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Can not allocate memory for Link request!&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* LINK_UP_REQUEST */</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">LINK_UP_MSG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Requesting For LinkUp...&quot;</span><span class="p">);</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINK_UP_REQ_PAYLOAD</span><span class="p">;</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINK_NET_ENTRY</span><span class="p">;</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">Leader</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">LINK_UP_CONTROL_REQ</span><span class="p">;</span>
		<span class="n">pstLinkRequest</span><span class="o">-&gt;</span><span class="n">Leader</span><span class="p">.</span><span class="n">PLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pstLinkRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">LINK_UP_MSG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Calling CopyBufferToControlPacket&quot;</span><span class="p">);</span>
		<span class="n">CopyBufferToControlPacket</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pstLinkRequest</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pstLinkRequest</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">LINK_UP_MSG</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;LinkMessage &lt;=====&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************************</span>
<span class="cm">* Function    - StatisticsResponse()</span>
<span class="cm">*</span>
<span class="cm">* Description - This function handles the Statistics response packet.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - Adapter	: Pointer to the Adapter structure.</span>
<span class="cm">* - pvBuffer: Starting address of Statistic response data.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - None.</span>
<span class="cm">************************************************************************/</span>
<span class="n">VOID</span> <span class="nf">StatisticsResponse</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">pvBuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;%s====&gt;&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">StatisticsPointer</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">pvBuffer</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Stats at %x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT</span><span class="p">)</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">StatisticsPointer</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;%s &lt;====&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************************</span>
<span class="cm">* Function    - LinkControlResponseMessage()</span>
<span class="cm">*</span>
<span class="cm">* Description - This function handles the Link response packets.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - Adapter	 : Pointer to the Adapter structure.</span>
<span class="cm">* - pucBuffer: Starting address of Link response data.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - None.</span>
<span class="cm">***********************************************************************/</span>
<span class="n">VOID</span> <span class="nf">LinkControlResponseMessage</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">PUCHAR</span> <span class="n">pucBuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;=====&gt;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pucBuffer</span> <span class="o">==</span> <span class="n">LINK_UP_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pucBuffer</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PHY_SYNC_ACHIVED</span>: <span class="cm">/* SYNCed UP */</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PHY_SYNC_ACHIVED&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">==</span> <span class="n">LINKUP_DONE</span><span class="p">)</span>
					<span class="n">beceem_protocol_reset</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>

				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usBestEffortQueueIndex</span> <span class="o">=</span> <span class="n">INVALID_QUEUE_INDEX</span><span class="p">;</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="n">PHY_SYNC_ACHIVED</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">NO_NETWORK_ENTRY</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">LinkMessage</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINKUP_DONE</span>:
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;LINKUP_DONE&quot;</span><span class="p">);</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="n">LINKUP_DONE</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPHSEnabled</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pucBuffer</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bETHCSEnabled</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pucBuffer</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ETH_CS_MASK</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PHS Support Status Received In LinkUp Ack : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPHSEnabled</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">NORMAL_OPERATION</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">LinkMessage</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WAIT_FOR_SYNC</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Driver to ignore the DREG_RECEIVED</span>
<span class="cm">			 * WiMAX Application should handle this Message</span>
<span class="cm">			 */</span>
			<span class="cm">/* Adapter-&gt;liTimeSinceLastNetEntry = 0; */</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkUpStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">usBestEffortQueueIndex</span> <span class="o">=</span> <span class="n">INVALID_QUEUE_INDEX</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bTriedToWakeUpFromlowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="n">beceem_protocol_reset</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LINK_SHUTDOWN_REQ_FROM_FIRMWARE</span>:
		<span class="k">case</span> <span class="n">COMPLETE_WAKE_UP_NOTIFICATION_FRM_FW</span>:
		<span class="p">{</span>
			<span class="n">HandleShutDownModeRequest</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pucBuffer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;default case:LinkResponse %x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">pucBuffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SET_MAC_ADDRESS_RESPONSE</span> <span class="o">==</span> <span class="o">*</span><span class="n">pucBuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PUCHAR</span> <span class="n">puMacAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pucBuffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="n">SYNC_UP_REQUEST</span><span class="p">;</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;MAC address response, sending SYNC_UP&quot;</span><span class="p">);</span>
		<span class="n">LinkMessage</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">puMacAddr</span><span class="p">,</span> <span class="n">MAC_ADDRESS_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;%s &lt;=====&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SendIdleModeResponse</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INT</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NVMAccess</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lowPwrAbortMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="n">CONTROL_MESSAGE</span> <span class="n">stIdleResponse</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tv</span><span class="p">));</span>
	<span class="n">stIdleResponse</span><span class="p">.</span><span class="n">Leader</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">IDLE_MESSAGE</span><span class="p">;</span>
	<span class="n">stIdleResponse</span><span class="p">.</span><span class="n">Leader</span><span class="p">.</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">IDLE_MODE_PAYLOAD_LENGTH</span><span class="p">;</span>
	<span class="n">stIdleResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GO_TO_IDLE_MODE_PAYLOAD</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot; ============&gt;&quot;</span><span class="p">);</span>

	<span class="cm">/*********************************</span>
<span class="cm">	 *down_trylock -</span>
<span class="cm">	 * if [ semaphore is available ]</span>
<span class="cm">	 *		 acquire semaphone and return value 0 ;</span>
<span class="cm">	 *   else</span>
<span class="cm">	 *		 return non-zero value ;</span>
<span class="cm">	 *</span>
<span class="cm">	 ***********************************/</span>

	<span class="n">NVMAccess</span> <span class="o">=</span> <span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
	<span class="n">lowPwrAbortMsg</span> <span class="o">=</span> <span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">NVMAccess</span> <span class="o">||</span> <span class="n">lowPwrAbortMsg</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">!=</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NVMAccess</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lowPwrAbortMsg</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>

		<span class="n">stIdleResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TARGET_CAN_NOT_GO_TO_IDLE_MODE</span><span class="p">;</span> <span class="cm">/* NACK- device access is going on. */</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;HOST IS NACKING Idle mode To F/W!!!!!!!!&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stIdleResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TARGET_CAN_GO_TO_IDLE_MODE</span><span class="p">;</span> <span class="cm">/* 2; Idle ACK */</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">StatisticsPointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Wait for the LED to TURN OFF before sending ACK response */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INT</span> <span class="n">iRetVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Wake the LED Thread with IDLEMODE_ENTER State */</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">LOWPOWER_MODE_ENTER</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;LED Thread is Running..Hence Setting LED Event as IDLEMODE_ENTER jiffies:%ld&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>

			<span class="cm">/* Wait for 1 SEC for LED to OFF */</span>
			<span class="n">iRetVal</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">idleModeSyncEvent</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">bIdle_led_off</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>

			<span class="cm">/* If Timed Out to Sync IDLE MODE Enter, do IDLE mode Exit and Send NACK to device */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iRetVal</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stIdleResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TARGET_CAN_NOT_GO_TO_IDLE_MODE</span><span class="p">;</span> <span class="cm">/* NACK- device access is going on. */</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">NORMAL_OPERATION</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;NACKING Idle mode as time out happen from LED side!!!!!!!!&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stIdleResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">TARGET_CAN_GO_TO_IDLE_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ACKING IDLE MODE !!!!!!!!!&quot;</span><span class="p">);</span>
			<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
			<span class="cm">/* Killing all URBS. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bDoSuspend</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
				<span class="n">Bcm_kill_all_URBs</span><span class="p">((</span><span class="n">PS_INTERFACE_ADAPTER</span><span class="p">)(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NVMAccess</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lowPwrAbortMsg</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">CopyBufferToControlPacket</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stIdleResponse</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;fail to send the Idle mode Request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">StartInterruptUrb</span><span class="p">((</span><span class="n">PS_INTERFACE_ADAPTER</span><span class="p">)(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_RX</span><span class="p">,</span> <span class="n">RX_DPC</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;IdleMode Msg submitter to Q :%ld ms&quot;</span><span class="p">,</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************</span>
<span class="cm">* Function    - DumpPackInfo()</span>
<span class="cm">*</span>
<span class="cm">* Description - This function dumps the all Queue(PackInfo[]) details.</span>
<span class="cm">*</span>
<span class="cm">* Parameters  - Adapter: Pointer to the Adapter structure.</span>
<span class="cm">*</span>
<span class="cm">* Returns     - None.</span>
<span class="cm">*******************************************************************/</span>
<span class="n">VOID</span> <span class="nf">DumpPackInfo</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">uiClsfrIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="n">pstClassifierEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&lt;</span> <span class="n">NO_OF_QUEUES</span><span class="p">;</span> <span class="n">uiLoopIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;*********** Showing Details Of Queue %d***** ******&quot;</span><span class="p">,</span> <span class="n">uiLoopIndex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bValid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;bValid is FALSE for %X index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiLoopIndex</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot; Dumping	SF Rule Entry For SFID %lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ulSFID</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot; ucDirection %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucDirection</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucIpVersion</span> <span class="o">==</span> <span class="n">IPV6</span><span class="p">)</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Ipv6 Service Flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Ipv4 Service Flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;SF Traffic Priority %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">u8TrafficPriority</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">uiClsfrIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiClsfrIndex</span> <span class="o">&lt;</span> <span class="n">MAX_CLASSIFIERS</span><span class="p">;</span> <span class="n">uiClsfrIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pstClassifierEntry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astClassifierTable</span><span class="p">[</span><span class="n">uiClsfrIndex</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bUsed</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">ulSFID</span> <span class="o">!=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ulSFID</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Dumping Classifier Rule Entry For Index: %X Classifier Rule ID : %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiClsfrIndex</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">uiClassifierRuleIndex</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Dumping Classifier Rule Entry For Index: %X usVCID_Value : %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiClsfrIndex</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">usVCID_Value</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Dumping Classifier Rule Entry For Index: %X bProtocolValid : %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiClsfrIndex</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bProtocolValid</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Dumping Classifier Rule Entry For Index: %X bTOSValid : %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiClsfrIndex</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bTOSValid</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Dumping Classifier Rule Entry For Index: %X bDestIpValid : %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiClsfrIndex</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bDestIpValid</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Dumping Classifier Rule Entry For Index: %X bSrcIpValid : %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiClsfrIndex</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">bSrcIpValid</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="n">MAX_PORT_RANGE</span><span class="p">;</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">usSrcPortRangeLo:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">usSrcPortRangeLo</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">usSrcPortRangeHi:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">usSrcPortRangeHi</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">usDestPortRangeLo:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">usDestPortRangeLo</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">usDestPortRangeHi:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">usDestPortRangeHi</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ucIPSourceAddressLength : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">ucIPSourceAddressLength</span><span class="p">);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ucIPDestinationAddressLength : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">ucIPDestinationAddressLength</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">ucIPSourceAddressLength</span><span class="p">;</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucIpVersion</span> <span class="o">==</span> <span class="n">IPV6</span><span class="p">)</span>	<span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Ipv6 ulSrcIpAddr :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv6Addr</span><span class="p">);</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Ipv6 ulSrcIpMask :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv6Mask</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ulSrcIpAddr:%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv4Addr</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ulSrcIpMask:%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stSrcIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">ucIPDestinationAddressLength</span><span class="p">;</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucIpVersion</span> <span class="o">==</span> <span class="n">IPV6</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Ipv6 ulDestIpAddr :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv6Addr</span><span class="p">);</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Ipv6 ulDestIpMask :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">DumpIpv6Address</span><span class="p">(</span><span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv6Mask</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ulDestIpAddr:%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv4Addr</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
					<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ulDestIpMask:%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">stDestIpAddress</span><span class="p">.</span><span class="n">ulIpv4Mask</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">ucProtocol:0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">ucProtocol</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">u8ClassifierRulePriority:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstClassifierEntry</span><span class="o">-&gt;</span><span class="n">u8ClassifierRulePriority</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ulSFID:%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ulSFID</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;usVCID_Value:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">usVCID_Value</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;PhsEnabled: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bHeaderSuppressionEnabled</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiThreshold:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiThreshold</span><span class="p">);</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;bValid:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bValid</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;bActive:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bActive</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ActivateReqSent: %x&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bActivateRequestSent</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;u8QueueType:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">u8QueueType</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiMaxBucketSize:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiMaxBucketSize</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiPerSFTxResourceCount:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiPerSFTxResourceCount</span><span class="p">));</span>
		<span class="cm">/* DumpDebug(DUMP_INFO,(&quot;bCSSupport:%X\n&quot;,Adapter-&gt;PackInfo[uiLoopIndex].bCSSupport)); */</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;CurrQueueDepthOnTarget: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiCurrentQueueDepthOnTarget</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiCurrentBytesOnHost:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiCurrentBytesOnHost</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiCurrentPacketsOnHost:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiCurrentPacketsOnHost</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiDroppedCountBytes:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiDroppedCountBytes</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiDroppedCountPackets:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiDroppedCountPackets</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiSentBytes:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiSentBytes</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiSentPackets:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiSentPackets</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiCurrentDrainRate:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiCurrentDrainRate</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiThisPeriodSentBytes:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiThisPeriodSentBytes</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;liDrainCalculated:%llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">liDrainCalculated</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiCurrentTokenCount:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiCurrentTokenCount</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;liLastUpdateTokenAt:%llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">liLastUpdateTokenAt</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiMaxAllowedRate:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiMaxAllowedRate</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiPendedLast:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiPendedLast</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;NumOfPacketsSent:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">NumOfPacketsSent</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Direction: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucDirection</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;CID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">usCID</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ProtocolValid: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bProtocolValid</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;TOSValid: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bTOSValid</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;DestIpValid: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bDestIpValid</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;SrcIpValid: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bSrcIpValid</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ActiveSet: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bActiveSet</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;AdmittedSet: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bAdmittedSet</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;AuthzSet: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bAuthorizedSet</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ClassifyPrority: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">bClassifierPriority</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;uiMaxLatency: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">uiMaxLatency</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ServiceClassName: %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucServiceClassName</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucServiceClassName</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucServiceClassName</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">].</span><span class="n">ucServiceClassName</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cm">/* BCM_DEBUG_PRINT (Adapter, DBG_TYPE_OTHERS, DUMP_INFO, DBG_LVL_ALL, &quot;bHeaderSuppressionEnabled :%X\n&quot;, Adapter-&gt;PackInfo[uiLoopIndex].bHeaderSuppressionEnabled);</span>
<span class="cm"> * BCM_DEBUG_PRINT (Adapter, DBG_TYPE_OTHERS, DUMP_INFO, DBG_LVL_ALL, &quot;uiTotalTxBytes:%X\n&quot;, Adapter-&gt;PackInfo[uiLoopIndex].uiTotalTxBytes);</span>
<span class="cm"> * BCM_DEBUG_PRINT (Adapter, DBG_TYPE_OTHERS, DUMP_INFO, DBG_LVL_ALL, &quot;uiTotalRxBytes:%X\n&quot;, Adapter-&gt;PackInfo[uiLoopIndex].uiTotalRxBytes);</span>
<span class="cm"> *		DumpDebug(DUMP_INFO,(&quot;				uiRanOutOfResCount:%X\n&quot;,Adapter-&gt;PackInfo[uiLoopIndex].uiRanOutOfResCount));</span>
<span class="cm"> */</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&lt;</span> <span class="n">MIBS_MAX_HIST_ENTRIES</span><span class="p">;</span> <span class="n">uiLoopIndex</span><span class="o">++</span><span class="p">)</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Adapter-&gt;aRxPktSizeHist[%x] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiLoopIndex</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">aRxPktSizeHist</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">uiLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiLoopIndex</span> <span class="o">&lt;</span> <span class="n">MIBS_MAX_HIST_ENTRIES</span><span class="p">;</span> <span class="n">uiLoopIndex</span><span class="o">++</span><span class="p">)</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">DUMP_INFO</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Adapter-&gt;aTxPktSizeHist[%x] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiLoopIndex</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">aTxPktSizeHist</span><span class="p">[</span><span class="n">uiLoopIndex</span><span class="p">]);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">reset_card_proc</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">ps_adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span> <span class="o">=</span> <span class="n">GET_BCM_ADAPTER</span><span class="p">(</span><span class="n">gblpnetdev</span><span class="p">);</span>
	<span class="n">PS_INTERFACE_ADAPTER</span> <span class="n">psIntfAdapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uiResetValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">psIntfAdapter</span> <span class="o">=</span> <span class="p">((</span><span class="n">PS_INTERFACE_ADAPTER</span><span class="p">)(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">));</span>
	<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">bDDRInitDone</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">T3LPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SYS_CFG register is write protected hence for modifying this reg value, it should be read twice before */</span>
		<span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>

		<span class="cm">/* making bit[6...5] same as was before f/w download. this setting force the h/w to */</span>
		<span class="cm">/* re-populated the SP RAM area with the string descriptor. */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">|</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">syscfgBefFwDld</span> <span class="o">&amp;</span> <span class="mh">0x00000060</span><span class="p">);</span>
		<span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* killing all submitted URBs. */</span>
	<span class="n">psIntfAdapter</span><span class="o">-&gt;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">StopAllXaction</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">Bcm_kill_all_URBs</span><span class="p">(</span><span class="n">psIntfAdapter</span><span class="p">);</span>
	<span class="cm">/* Reset the UMA-B Device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">T3LPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Resetting UMA-B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_reset_device</span><span class="p">(</span><span class="n">psIntfAdapter</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
		<span class="n">psIntfAdapter</span><span class="o">-&gt;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">StopAllXaction</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Reset failed with ret value :%d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS220_2</span> <span class="o">||</span>
			<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS220_2BC</span> <span class="o">||</span>
			<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS250_BC</span> <span class="o">||</span>
			<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS220_3</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">HPM_CONFIG_LDO145</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;read failed with status :%d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* setting 0th bit */</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">HPM_CONFIG_LDO145</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;write failed with status :%d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="mh">0x0f007018</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;read failed with status :%d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="mh">0x0f007018</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;write failed with status :%d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Toggling the GPIO 8, 9 */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">GPIO_OUTPUT_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;write failed with status :%d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">GPIO_MODE_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;write failed with status :%d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ps_adapter-&gt;downloadDDR = false; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">bFlashBoot</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In flash boot mode MIPS state register has reverse polarity.</span>
<span class="cm">		 * So just or with setting bit 30.</span>
<span class="cm">		 * Make the MIPS in Reset state.</span>
<span class="cm">		 */</span>
		<span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">CLOCK_RESET_CNTRL_REG_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiResetValue</span><span class="p">));</span>
		<span class="n">uiResetValue</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">CLOCK_RESET_CNTRL_REG_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiResetValue</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">T3LPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uiResetValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * WA for SYSConfig Issue.</span>
<span class="cm">		 * Read SYSCFG Twice to make it writable.</span>
<span class="cm">		 */</span>
		<span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiResetValue</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uiResetValue</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">uiResetValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiResetValue</span><span class="p">));</span> <span class="cm">/* 2nd read to make it writable. */</span>
			<span class="n">uiResetValue</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">));</span>
			<span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiResetValue</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">uiResetValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="mh">0x0f01186c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uiResetValue</span><span class="p">));</span>

<span class="nl">err_exit:</span>
	<span class="n">psIntfAdapter</span><span class="o">-&gt;</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">StopAllXaction</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">run_card_proc</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">ps_adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">CLOCK_RESET_CNTRL_REG_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;%s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">bFlashBoot</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">CLOCK_RESET_CNTRL_REG_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;%s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">STATUS_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">InitCardAndDownloadFirmware</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">ps_adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Create the threads first and then download the</span>
<span class="cm">	 * Firm/DDR Settings..</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">create_worker_threads</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bcm_parse_target_params</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">T3LPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">syscfgBefFwDld</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">bFlashBoot</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reset_card_proc</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>

	<span class="cm">/* Initializing the NVM. */</span>
	<span class="n">BcmInitNVM</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ddr_init</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;ddr_init Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Download cfg file */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">buffDnldVerify</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">STARGETPARAMS</span><span class="p">),</span>
				<span class="n">CONFIG_BEGIN_ADDR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Error downloading CFG file&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">OUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_networkdev</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Register Netdevice failed. Cleanup needs to be performed.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">AutoFirmDld</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;AutoFirmDld Disabled in CFG File..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* If Auto f/w download is disable, register the control interface, */</span>
		<span class="cm">/* register the control interface after the mailbox. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">register_control_device_interface</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Register Control Device failed. Cleanup needs to be performed.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do the LED Settings here. It will be used by the Firmware Download</span>
<span class="cm">	 * Thread.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * 1. If the LED Settings fails, do not stop and do the Firmware download.</span>
<span class="cm">	 * 2. This init would happened only if the cfg file is present, else</span>
<span class="cm">	 *    call from the ioctl context.</span>
<span class="cm">	 */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">InitLedSettings</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;INIT LED FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">DRIVER_INIT</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">FW_DOWNLOAD</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">EEPROM_CAL_DATA_INTERNAL_LOC</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
	<span class="n">wrmalt</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">EEPROM_CAL_DATA_INTERNAL_LOC</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">==</span> <span class="n">NVM_FLASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">PropagateCalParamsFromFlashToMemory</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Propagation of Cal param failed ..&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">OUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Download Firmare */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">BcmFileDownload</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">BIN_FILE</span><span class="p">,</span> <span class="n">FIRMWARE_BEGIN_ADDR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;No Firmware File is present...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">OUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">run_card_proc</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">ps_adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;run_card_proc Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">OUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">fw_download_done</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="nl">OUT:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">FW_DOWNLOAD_DONE</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps_adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_parse_target_params</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">flp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFFER_1K</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">STARGETPARAMS</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">open_firmware_file</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">CFG_FILE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;NOT ABLE TO OPEN THE %s FILE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CFG_FILE</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vfs_read</span><span class="p">(</span><span class="n">flp</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFFER_1K</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARGETPARAMS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Mismatch in Target Param Structure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">filp_close</span><span class="p">(</span><span class="n">flp</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">filp_close</span><span class="p">(</span><span class="n">flp</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">);</span>

	<span class="cm">/* Check for autolink in config params */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Values in Adapter-&gt;pstargetparams are in network byte order</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARGETPARAMS</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="n">beceem_parse_target_struct</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">beceem_parse_target_struct</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiHostDrvrCfg6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uiEEPROMFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">m_u32PhyParameter2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AUTO_SYNC_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: AutoSyncup is Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoSyncup</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: AutoSyncup is Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoSyncup</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AUTO_LINKUP_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: Enabling autolink up&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoLinkUp</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: Disabling autolink up&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoLinkUp</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Setting the DDR Setting.. */</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DDRSetting</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: DDR Setting: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DDRSetting</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: Power Save Mode: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AUTO_FIRM_DOWNLOAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: Enabling Auto Firmware Download</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoFirmDld</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: Disabling Auto Firmware Download</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoFirmDld</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">uiHostDrvrCfg6</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span><span class="p">);</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bMipsConfig</span> <span class="o">=</span> <span class="p">(</span><span class="n">uiHostDrvrCfg6</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: MIPSConfig   : 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bMipsConfig</span><span class="p">);</span>
	<span class="cm">/* used for backward compatibility. */</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bDPLLConfig</span> <span class="o">=</span> <span class="p">(</span><span class="n">uiHostDrvrCfg6</span><span class="o">&gt;&gt;</span><span class="mi">19</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PmuMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">uiHostDrvrCfg6</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: PMU MODE: %x&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PmuMode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">uiHostDrvrCfg6</span> <span class="o">&gt;&gt;</span> <span class="n">HOST_BUS_SUSPEND_BIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bDoSuspend</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: Making DoSuspend TRUE as per configFile&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uiEEPROMFlag</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">m_u32EEPROMFlag</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot;: uiEEPROMFlag  : 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uiEEPROMFlag</span><span class="p">);</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">eNVMType</span> <span class="o">=</span> <span class="p">(</span><span class="n">NVM_TYPE</span><span class="p">)((</span><span class="n">uiEEPROMFlag</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bStatusWrite</span> <span class="o">=</span> <span class="p">(</span><span class="n">uiEEPROMFlag</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiSectorSizeInCFG</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">&amp;</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig4</span><span class="p">));</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bSectorSizeOverride</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">((</span><span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig4</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">m_u32PowerSavingModeOptions</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">=</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">!=</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE</span><span class="p">)</span>
		<span class="n">doPowerAutoCorrection</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">VOID</span> <span class="nf">doPowerAutoCorrection</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">psAdapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">reporting_mode</span><span class="p">;</span>

	<span class="n">reporting_mode</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">m_u32PowerSavingModeOptions</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">bIsAutoCorrectEnabled</span> <span class="o">=</span> <span class="o">!</span><span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reporting_mode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;can&#39;t do suspen/resume as reporting mode is enable&quot;</span><span class="p">);</span>
		<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">bDoSuspend</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">bIsAutoCorrectEnabled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;=</span> <span class="n">T3LPB</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If reporting mode is enable, switch PMU to PMC */</span>
		<span class="p">{</span>
			<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">=</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PMU_CLOCK_GATING</span><span class="p">;</span>
			<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">bDoSuspend</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clearing space bit[15..12] */</span>
		<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">htonl</span><span class="p">((</span><span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)));</span>
		<span class="cm">/* placing the power save mode option */</span>
		<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span> <span class="o">|=</span> <span class="n">htonl</span><span class="p">((</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">bIsAutoCorrectEnabled</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* remove the autocorrect disable bit set before dumping. */</span>
		<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">pstargetparams</span><span class="o">-&gt;</span><span class="n">HostDrvrConfig6</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">htonl</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">psAdapter</span><span class="p">,</span> <span class="n">DBG_TYPE_INITEXIT</span><span class="p">,</span> <span class="n">MP_INIT</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Using Forced User Choice: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psAdapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static unsigned char *ReadMacAddrEEPROM(PMINI_ADAPTER Adapter, ulong dwAddress)</span>
<span class="c">{</span>
<span class="c">	int status = 0, i = 0;</span>
<span class="c">	unsigned int temp = 0;</span>
<span class="c">	unsigned char *pucmacaddr = kmalloc(MAC_ADDRESS_SIZE, GFP_KERNEL);</span>
<span class="c">	int bytes;</span>

<span class="c">	if (!pucmacaddr) {</span>
<span class="c">		BCM_DEBUG_PRINT(Adapter, DBG_TYPE_PRINTK, 0, 0, &quot;No Buffers to Read the EEPROM Address\n&quot;);</span>
<span class="c">		return NULL;</span>
<span class="c">	}</span>

<span class="c">	dwAddress |= 0x5b000000;</span>
<span class="c">	status = wrmalt(Adapter, EEPROM_COMMAND_Q_REG, (PUINT)&amp;dwAddress, sizeof(UINT));</span>
<span class="c">	if (status != STATUS_SUCCESS) {</span>
<span class="c">		BCM_DEBUG_PRINT(Adapter, DBG_TYPE_PRINTK, 0, 0, &quot;wrm Failed..\n&quot;);</span>
<span class="c">		kfree(pucmacaddr);</span>
<span class="c">		pucmacaddr = NULL;</span>
<span class="c">		goto OUT;</span>
<span class="c">	}</span>

<span class="c">	for (i = 0; i &lt; MAC_ADDRESS_SIZE; i++) {</span>
<span class="c">		bytes = rdmalt(Adapter, EEPROM_READ_DATA_Q_REG, &amp;temp, sizeof(temp));</span>
<span class="c">		if (bytes &lt; 0) {</span>
<span class="c">			status = bytes;</span>
<span class="c">			BCM_DEBUG_PRINT(Adapter, DBG_TYPE_PRINTK, 0, 0, &quot;rdm Failed..\n&quot;);</span>
<span class="c">			kfree(pucmacaddr);</span>
<span class="c">			pucmacaddr = NULL;</span>
<span class="c">			goto OUT;</span>
<span class="c">		}</span>
<span class="c">		pucmacaddr[i] = temp &amp; 0xff;</span>
<span class="c">		BCM_DEBUG_PRINT(Adapter, DBG_TYPE_INITEXIT, DRV_ENTRY, DBG_LVL_ALL, &quot;%x\n&quot;, pucmacaddr[i]);</span>
<span class="c">	}</span>
<span class="c">OUT:</span>
<span class="c">	return pucmacaddr;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convertEndian</span><span class="p">(</span><span class="n">B_UINT8</span> <span class="n">rwFlag</span><span class="p">,</span> <span class="n">PUINT</span> <span class="n">puiBuffer</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiByteCount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RWM_WRITE</span> <span class="o">==</span> <span class="n">rwFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">uiByteCount</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span>
			<span class="n">puiBuffer</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">puiBuffer</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">uiByteCount</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">));</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span>
			<span class="n">puiBuffer</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">puiBuffer</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define CACHE_ADDRESS_MASK 0x80000000</span>
<span class="cp">#define UNCACHE_ADDRESS_MASK 0xa0000000</span>

<span class="kt">int</span> <span class="nf">rdm</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">PCHAR</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">interface_rdm</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">,</span>
				<span class="n">uiAddress</span><span class="p">,</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="n">sSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wrm</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">PCHAR</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iRetVal</span><span class="p">;</span>

	<span class="n">iRetVal</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">interface_wrm</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">,</span>
					<span class="n">uiAddress</span><span class="p">,</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="n">sSize</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iRetVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wrmalt</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">PUINT</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">convertEndian</span><span class="p">(</span><span class="n">RWM_WRITE</span><span class="p">,</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wrm</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pucBuff</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rdmalt</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">PUINT</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INT</span> <span class="n">uiRetVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">uiRetVal</span> <span class="o">=</span> <span class="n">rdm</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">pucBuff</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">convertEndian</span><span class="p">(</span><span class="n">RWM_READ</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">pucBuff</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uiRetVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wrmWithLock</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">PCHAR</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sSize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INT</span> <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wrm</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="n">sSize</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wrmaltWithLock</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">PUINT</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iRetVal</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">iRetVal</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iRetVal</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iRetVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rdmaltWithLock</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">PUINT</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INT</span> <span class="n">uiRetVal</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">uiRetVal</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uiRetVal</span> <span class="o">=</span> <span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">uiAddress</span><span class="p">,</span> <span class="n">pucBuff</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">uiRetVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">VOID</span> <span class="nf">HandleShutDownModeWakeup</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">clear_abort_pattern</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;====&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* target has woken up From Shut Down */</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Clearing Shut Down Software abort pattern</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">Status</span> <span class="o">=</span> <span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">SW_ABORT_IDLEMODE_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clear_abort_pattern</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clear_abort_pattern</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;WRM to SW_ABORT_IDLEMODE_LOC failed with err:%d&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ulPowerSaveMode</span> <span class="o">!=</span> <span class="n">DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">InterfaceHandleShutdownModeWakeup</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">NO_NETWORK_ENTRY</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bTriedToWakeUpFromlowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">lowpower_mode_wait_queue</span><span class="p">);</span>
	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;&lt;====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">VOID</span> <span class="nf">SendShutModeResponse</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONTROL_MESSAGE</span> <span class="n">stShutdownResponse</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">NVMAccess</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lowPwrAbortMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UINT</span> <span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stShutdownResponse</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONTROL_MESSAGE</span><span class="p">));</span>
	<span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">Leader</span><span class="p">.</span><span class="n">Status</span>  <span class="o">=</span> <span class="n">LINK_UP_CONTROL_REQ</span><span class="p">;</span>
	<span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">Leader</span><span class="p">.</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 8 bytes; */</span>
	<span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINK_UP_ACK</span><span class="p">;</span>
	<span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LINK_SHUTDOWN_REQ_FROM_FIRMWARE</span><span class="p">;</span>

	<span class="cm">/*********************************</span>
<span class="cm">	 * down_trylock -</span>
<span class="cm">	 * if [ semaphore is available ]</span>
<span class="cm">	 *		 acquire semaphone and return value 0 ;</span>
<span class="cm">	 *   else</span>
<span class="cm">	 *		 return non-zero value ;</span>
<span class="cm">	 *</span>
<span class="cm">	 ***********************************/</span>

	<span class="n">NVMAccess</span> <span class="o">=</span> <span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>
	<span class="n">lowPwrAbortMsg</span> <span class="o">=</span> <span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NVMAccess</span> <span class="o">||</span> <span class="n">lowPwrAbortMsg</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NVMAccess</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lowPwrAbortMsg</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>

		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Device Access is going on NACK the Shut Down MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHUTDOWN_NACK_FROM_DRIVER</span><span class="p">;</span> <span class="cm">/* NACK- device access is going on. */</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;Sending SHUTDOWN MODE ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHUTDOWN_ACK_FROM_DRIVER</span><span class="p">;</span> <span class="cm">/* ShutDown ACK */</span>

		<span class="cm">/* Wait for the LED to TURN OFF before sending ACK response */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">led_thread_running</span> <span class="o">&amp;</span> <span class="n">BCM_LED_THREAD_RUNNING_ACTIVELY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INT</span> <span class="n">iRetVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Wake the LED Thread with LOWPOWER_MODE_ENTER State */</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">LOWPOWER_MODE_ENTER</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>

			<span class="cm">/* Wait for 1 SEC for LED to OFF */</span>
			<span class="n">iRetVal</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">idleModeSyncEvent</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">bIdle_led_off</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>

			<span class="cm">/* If Timed Out to Sync IDLE MODE Enter, do IDLE mode Exit and Send NACK to device */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iRetVal</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHUTDOWN_NACK_FROM_DRIVER</span><span class="p">;</span> <span class="cm">/* NACK- device access is going on. */</span>
				<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">DriverState</span> <span class="o">=</span> <span class="n">NO_NETWORK_ENTRY</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LEDInfo</span><span class="p">.</span><span class="n">notify_led_event</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stShutdownResponse</span><span class="p">.</span><span class="n">szData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">SHUTDOWN_ACK_FROM_DRIVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ACKING SHUTDOWN MODE !!!!!!!!!&quot;</span><span class="p">);</span>
			<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">rdmwrmsync</span><span class="p">);</span>
			<span class="cm">/* Killing all URBS. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bDoSuspend</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
				<span class="n">Bcm_kill_all_URBs</span><span class="p">((</span><span class="n">PS_INTERFACE_ADAPTER</span><span class="p">)(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NVMAccess</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">NVMRdmWrmLock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lowPwrAbortMsg</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LowPowerModeSync</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">Status</span> <span class="o">=</span> <span class="n">CopyBufferToControlPacket</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stShutdownResponse</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;fail to send the Idle mode Request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bPreparingForLowPowerMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="n">StartInterruptUrb</span><span class="p">((</span><span class="n">PS_INTERFACE_ADAPTER</span><span class="p">)(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">pvInterfaceAdapter</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">HandleShutDownModeRequest</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">PUCHAR</span> <span class="n">pucBuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">B_UINT32</span> <span class="n">uiResetValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;====&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pucBuffer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span>  <span class="n">COMPLETE_WAKE_UP_NOTIFICATION_FRM_FW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HandleShutDownModeWakeup</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pucBuffer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span>  <span class="n">LINK_SHUTDOWN_REQ_FROM_FIRMWARE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Target wants to go to Shut Down Mode */</span>
		<span class="cm">/* InterfacePrepareForShutdown(Adapter); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS220_2</span> <span class="o">||</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS220_2BC</span> <span class="o">||</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS250_BC</span> <span class="o">||</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="n">BCS220_3</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">rdmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">HPM_CONFIG_MSW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">uiResetValue</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span>
			<span class="n">wrmalt</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">HPM_CONFIG_MSW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uiResetValue</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">SendShutModeResponse</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
		<span class="n">BCM_DEBUG_PRINT</span> <span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;ShutDownModeResponse:Notification received: Sending the response(Ack/Nack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_OTHERS</span><span class="p">,</span> <span class="n">MP_SHUTDOWN</span><span class="p">,</span> <span class="n">DBG_LVL_ALL</span><span class="p">,</span> <span class="s">&quot;&lt;====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="nf">ResetCounters</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">beceem_protocol_reset</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">CurrNumRecvDescs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PrevNumRecvDescs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkUpStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">cntrlpktCnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">fw_download_done</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">AutoLinkUp</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bShutStatus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">S_CLASSIFIER_RULE</span> <span class="o">*</span><span class="nf">GetFragIPClsEntry</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usIpIdentification</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">SrcIP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="n">MAX_FRAGMENTEDIP_CLASSIFICATION_ENTRIES</span><span class="p">;</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">bUsed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">usIpIdentification</span> <span class="o">==</span> <span class="n">usIpIdentification</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">ulSrcIpAddress</span> <span class="o">==</span> <span class="n">SrcIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">bOutOfOrderFragment</span><span class="p">)</span>

			<span class="k">return</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">pstMatchedClassifierEntry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">AddFragIPClsEntry</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">PS_FRAGMENTED_PACKET_INFO</span> <span class="n">psFragPktInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="n">MAX_FRAGMENTEDIP_CLASSIFICATION_ENTRIES</span><span class="p">;</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">bUsed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">],</span> <span class="n">psFragPktInfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_FRAGMENTED_PACKET_INFO</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DelFragIPClsEntry</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usIpIdentification</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">SrcIp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">uiIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uiIndex</span> <span class="o">&lt;</span> <span class="n">MAX_FRAGMENTEDIP_CLASSIFICATION_ENTRIES</span><span class="p">;</span> <span class="n">uiIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">bUsed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">usIpIdentification</span> <span class="o">==</span> <span class="n">usIpIdentification</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">].</span><span class="n">ulSrcIpAddress</span> <span class="o">==</span> <span class="n">SrcIp</span><span class="p">))</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">[</span><span class="n">uiIndex</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_FRAGMENTED_PACKET_INFO</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">update_per_cid_rx</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UINT</span> <span class="n">qindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">liDrainCalculated</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">XSECONDS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qindex</span> <span class="o">&lt;</span> <span class="n">HiPriority</span><span class="p">;</span> <span class="n">qindex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">ucDirection</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiCurrentRxRate</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiCurrentRxRate</span> <span class="o">+</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiThisPeriodRxBytes</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiThisPeriodRxBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiCurrentDrainRate</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiCurrentDrainRate</span> <span class="o">+</span>
					<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiThisPeriodSentBytes</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">qindex</span><span class="p">].</span><span class="n">uiThisPeriodSentBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">liDrainCalculated</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">update_per_sf_desc_cnts</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INT</span> <span class="n">iIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uibuff</span><span class="p">[</span><span class="n">MAX_TARGET_DSX_BUFFERS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiMBupdate</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">rdmaltWithLock</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">TARGET_SFID_TXDESC_MAP_LOC</span><span class="p">,</span> <span class="p">(</span><span class="n">PUINT</span><span class="p">)</span><span class="n">uibuff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UINT</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_TARGET_DSX_BUFFERS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;rdm failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iIndex</span> <span class="o">&lt;</span> <span class="n">HiPriority</span><span class="p">;</span> <span class="n">iIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">bValid</span> <span class="o">&amp;&amp;</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">ucDirection</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">usVCID_Value</span> <span class="o">&lt;</span> <span class="n">MAX_TARGET_DSX_BUFFERS</span><span class="p">)</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">uiPerSFTxResourceCount</span><span class="p">,</span> <span class="n">uibuff</span><span class="p">[</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">usVCID_Value</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">BCM_DEBUG_PRINT</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">DBG_TYPE_PRINTK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Invalid VCID : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iIndex</span><span class="p">].</span><span class="n">usVCID_Value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">uiMBupdate</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">flush_queue</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">iQIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">PacketToDrop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">netstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PacketToDrop</span> <span class="o">=</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PacketToDrop</span> <span class="o">&amp;&amp;</span> <span class="n">PacketToDrop</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netstats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">DEQUEUEPACKET</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">FirstTxQueue</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">LastTxQueue</span><span class="p">);</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiCurrentPacketsOnHost</span><span class="o">--</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiCurrentBytesOnHost</span> <span class="o">-=</span> <span class="n">PacketToDrop</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

			<span class="cm">/* Adding dropped statistics */</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiDroppedCountBytes</span> <span class="o">+=</span> <span class="n">PacketToDrop</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">uiDroppedCountPackets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">PacketToDrop</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TotalPacketCount</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">iQIndex</span><span class="p">].</span><span class="n">SFQueueLock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beceem_protocol_reset</span><span class="p">(</span><span class="n">PMINI_ADAPTER</span> <span class="n">Adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">Adapter</span><span class="p">))</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: protocol reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">IdleMode</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">LinkUpStatus</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">ClearTargetDSXBuffer</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
	<span class="cm">/* Delete All Classifier Rules */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HiPriority</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DeleteAllClassifiersForSF</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">flush_all_queues</span><span class="p">(</span><span class="n">Adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TimerActive</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">TimerActive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">astFragmentedPktClassifierTable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_FRAGMENTED_PACKET_INFO</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_FRAGMENTEDIP_CLASSIFICATION_ENTRIES</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HiPriority</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* resetting only the first size (S_MIBS_SERVICEFLOW_TABLE) for the SF. */</span>
		<span class="cm">/* It is same between MIBs and SF. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">PackInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stMibsExtServiceFlowTable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">S_MIBS_EXTSERVICEFLOW_PARAMETERS</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
