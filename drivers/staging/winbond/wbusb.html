<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › winbond › wbusb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wbusb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Pavel Machek &lt;pavel@ucw.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Distribute under GPLv2.</span>
<span class="cm"> *</span>
<span class="cm"> * The original driver was written by:</span>
<span class="cm"> *     Jeff Lee &lt;YY_Lee@issc.com.tw&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * and was adapted to the 2.6 kernel by:</span>
<span class="cm"> *     Costantino Leandro (Rxart Desktop) &lt;le_costantino@pixartargentina.com.ar&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;mds_f.h&quot;</span>
<span class="cp">#include &quot;mto.h&quot;</span>
<span class="cp">#include &quot;wbhal.h&quot;</span>
<span class="cp">#include &quot;wb35reg_f.h&quot;</span>
<span class="cp">#include &quot;wb35tx_f.h&quot;</span>
<span class="cp">#include &quot;wb35rx_f.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IS89C35 802.11bg WLAN USB Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.1&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">wb35_table</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0416</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x18E8</span><span class="p">,</span> <span class="mh">0x6201</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x18E8</span><span class="p">,</span> <span class="mh">0x6206</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x18E8</span><span class="p">,</span> <span class="mh">0x6217</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x18E8</span><span class="p">,</span> <span class="mh">0x6230</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x18E8</span><span class="p">,</span> <span class="mh">0x6233</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1131</span><span class="p">,</span> <span class="mh">0x2035</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">wb35_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">wbsoft_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">wbsoft_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">wbsoft_band_2GHz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span>	<span class="o">=</span> <span class="n">wbsoft_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wbsoft_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span>	<span class="o">=</span> <span class="n">wbsoft_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wbsoft_rates</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_beacon_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">u16</span> <span class="n">beacon_period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">BeaconPeriod</span> <span class="o">=</span> <span class="n">beacon_period</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">BeaconPeriod</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">ProbeDelay</span><span class="p">;</span>
	<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0848</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsoft_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">hal_set_beacon_period</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsoft_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wbsoft_remove interface called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsoft_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsoft_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">wbsoft_prepare_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">netdev_hw_addr_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netdev_hw_addr_list_count</span><span class="p">(</span><span class="n">mc_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsoft_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span>
				    <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_flags</span><span class="p">;</span>

	<span class="n">new_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span>
		<span class="n">new_flags</span> <span class="o">|=</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">multicast</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">))</span>
		<span class="n">new_flags</span> <span class="o">|=</span> <span class="n">FIF_ALLMULTI</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span><span class="p">;</span>

	<span class="o">*</span><span class="n">total_flags</span> <span class="o">=</span> <span class="n">new_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsoft_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">IsInUsed</span> <span class="o">!=</span> <span class="n">PACKET_FREE_TO_USE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">wNumTxMMPDUDiscarded</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">IsInUsed</span> <span class="o">=</span> <span class="n">PACKET_COME_FROM_MLME</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">pMMPDU</span>		<span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">DataType</span>	<span class="o">=</span> <span class="n">FRAME_TYPE_802_11_MANAGEMENT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">len</span>		<span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">wNumTxMMPDU</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * H/W will enter power save by set the register. S/W don&#39;t send null</span>
<span class="cm">	 * frame with PWRMgt bit enbled to enter power save now.</span>
<span class="cm">	 */</span>

	<span class="n">Mds_Tx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsoft_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_radio_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">radio_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio_off</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* disable Baseband receive off */</span>
		<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentRadioSw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* off */</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M24_MacControl</span> <span class="o">&amp;=</span> <span class="mh">0xffffffbf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentRadioSw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* on */</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M24_MacControl</span> <span class="o">|=</span> <span class="mh">0x00000040</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0824</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">M24_MacControl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_current_channel_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chan_info</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Going to channel: %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">.</span><span class="n">band</span><span class="p">,</span> <span class="n">channel</span><span class="p">.</span><span class="n">ChanNo</span><span class="p">);</span>

	<span class="n">RFSynthesizer_SwitchingChannel</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span> <span class="cm">/* Switch channel */</span>
	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">ChanNo</span><span class="p">;</span>
	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">band</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Set channel is %d, band =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M28_MacControl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* Clean channel information field */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M28_MacControl</span> <span class="o">|=</span> <span class="n">channel</span><span class="p">.</span><span class="n">ChanNo</span><span class="p">;</span>
	<span class="n">Wb35Reg_WriteWithCallbackValue</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0828</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">M28_MacControl</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">channel</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chan_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_current_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chan_info</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hal_set_current_channel_ex</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_accept_broadcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02000000</span><span class="p">;</span>	<span class="cm">/* The HW value */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">|=</span> <span class="mh">0x02000000</span><span class="p">;</span>	<span class="cm">/* The HW value */</span>

	<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* For wep key error detection, we need to accept broadcast packets to be received temporary. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_accept_promiscuous</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">|=</span> <span class="mh">0x00400000</span><span class="p">;</span>
		<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00400000</span><span class="p">;</span>
		<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_accept_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01000000</span><span class="p">;</span>	<span class="cm">/* The HW value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">|=</span> <span class="mh">0x01000000</span><span class="p">;</span>	<span class="cm">/* The HW value */</span>
	<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_accept_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span>	<span class="cm">/* Due to SME and MLME are not suitable for 35 */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04000000</span><span class="p">;</span>	<span class="cm">/* The HW value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span> <span class="o">|=</span> <span class="mh">0x04000000</span><span class="p">;</span>	<span class="cm">/* The HW value */</span>

	<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">M00_MacControl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsoft_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chan_info</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wbsoft_config called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Should use channel_num, or something, as that is already pre-translated */</span>
	<span class="n">ch</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ch</span><span class="p">.</span><span class="n">ChanNo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hal_set_current_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">hal_set_accept_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hal_set_accept_promiscuous</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hal_set_accept_multicast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hal_set_accept_beacon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hal_set_radio_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">wbsoft_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wbsoft_get_tsf called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">wbsoft_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>			<span class="o">=</span> <span class="n">wbsoft_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">wbsoft_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">wbsoft_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>		<span class="o">=</span> <span class="n">wbsoft_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>	<span class="o">=</span> <span class="n">wbsoft_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>			<span class="o">=</span> <span class="n">wbsoft_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_multicast</span>	<span class="o">=</span> <span class="n">wbsoft_prepare_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>	<span class="o">=</span> <span class="n">wbsoft_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>		<span class="o">=</span> <span class="n">wbsoft_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span>		<span class="o">=</span> <span class="n">wbsoft_get_tsf</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_set_ethernet_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">current_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ltmp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentMacAddress</span><span class="p">,</span> <span class="n">current_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ltmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentMacAddress</span><span class="p">);</span>
	<span class="n">ltmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentMacAddress</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">Wb35Reg_BurstWrite</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03e8</span><span class="p">,</span> <span class="n">ltmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AUTO_INCREMENT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_get_permanent_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pethernet_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pethernet_address</span><span class="p">,</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">PermanentMacAddress</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">Wb35Rx</span><span class="p">.</span><span class="n">rx_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">Wb35Rx_stop</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>

	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">Wb35Tx</span><span class="p">.</span><span class="n">tx_halt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">Wb35Tx_stop</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">D00_DmaControl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xc0000000</span><span class="p">;</span>	<span class="cm">/* Tx Off, Rx Off */</span>
	<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">D00_DmaControl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">hal_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">EP0vm_state</span> <span class="o">!=</span> <span class="n">VM_STOP</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">hal_get_antenna_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">BB2C</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 0 : radio on; 1: radio off */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">hal_get_hw_radio_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* read the bit16 of register U1B0 */</span>
	<span class="n">Wb35Reg_Read</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x3b0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1B0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1B0</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentRadioHw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentRadioHw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">LED_GRAY</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">LED_GRAY2</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_led_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wb35_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">LEDSet</span> <span class="o">=</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SoftwareSet</span> <span class="o">&amp;</span> <span class="n">HAL_LED_SET_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">HAL_LED_SET_SHIFT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">ltmp</span><span class="p">,</span> <span class="n">ltmp2</span><span class="p">;</span>
	<span class="n">ltmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ltmp2</span> <span class="o">=</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_control</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ltmp2</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>	<span class="p">{</span> <span class="cm">/* 5 is WPS mode */</span>
			<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">ltmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_control</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ltmp2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* [0.2 On][0.1 Off]... */</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">%=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">ltmp</span> <span class="o">=</span> <span class="mh">0x1010</span><span class="p">;</span>	<span class="cm">/* Led 1 &amp; 0 Green and Red */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* Turn off */</span>
					<span class="n">ltmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* [0.1 On][0.1 Off]... */</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">%=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">ltmp</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">;</span>	<span class="cm">/* Led 0 red color */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span><span class="p">)</span> <span class="cm">/* Turn off */</span>
					<span class="n">ltmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* [0.1 On][0.1 Off][0.1 On][0.1 Off][0.1 On][0.1 Off][0.1 On][0.1 Off][0.1 On][0.1 Off][0.5 Off]... */</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">%=</span> <span class="mi">15</span><span class="p">;</span>
				<span class="n">ltmp</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">;</span>	<span class="cm">/* Led 0 red color */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span> <span class="cm">/* Turn off 0.6 sec */</span>
					<span class="n">ltmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* [300 On][ off ] */</span>
				<span class="n">ltmp</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>	<span class="cm">/* Led 1 Green color */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">&gt;=</span> <span class="mi">3000</span><span class="p">)</span>
					<span class="n">ltmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* led maybe on after 300sec * 32bit counter overlap. */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span><span class="o">++</span><span class="p">;</span>

			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">=</span> <span class="n">ltmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">LEDSet</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Only 111 mode has 2 LEDs on PCB. */</span>
				<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* Copy LED result to each LED control register */</span>
				<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ltmp</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentRadioSw</span> <span class="o">||</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">CurrentRadioHw</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* If radio off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x1010</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1010</span><span class="p">;</span>
			<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">LEDSet</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* [100] Only 1 Led be placed on PCB and use pin 21 of IC. Use LED_0 for showing */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_LinkOn</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Blink only if not Link On */</span>
				<span class="cm">/* Blinking if scanning is on progress */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Scanning</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 On */</span>
						<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 Off */</span>
						<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Turn Off LED_0 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 Off */</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Turn On LED_0 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
					<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 Off */</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* [110] Only 1 Led be placed on PCB and use pin 21 of IC. Use LED_0 for showing */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_LinkOn</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Blink only if not Link On */</span>
				<span class="cm">/* Blinking if scanning is on progress */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Scanning</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 On */</span>
						<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1f</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 Off */</span>
						<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Gray blinking if in disconnect state and not scanning */</span>
					<span class="n">ltmp</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">;</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1f</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">LED_GRAY2</span><span class="p">[(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">%</span> <span class="mi">30</span><span class="p">)])</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span>
						    <span class="n">LED_GRAY2</span><span class="p">[(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">%</span> <span class="mi">30</span><span class="p">)];</span>
					<span class="p">}</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">!=</span> <span class="n">ltmp</span><span class="p">)</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 Off */</span>
					<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Turn On LED_0 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
					<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_0 Off */</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* [101] Only 1 Led be placed on PCB and use LED_1 for showing */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_LinkOn</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Blink only if not Link On */</span>
				<span class="cm">/* Blinking if scanning is on progress */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Scanning</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_1 On */</span>
						<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_1 Off */</span>
						<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Turn Off LED_1 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_1 Off */</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Is transmitting/receiving ?? */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">RxByteCount</span> <span class="o">!=</span>
				     <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">RxByteCountLast</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">TxByteCount</span> <span class="o">!=</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">TxByteCountLast</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">!=</span>
					    <span class="mh">0x3000</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x3000</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_1 On */</span>
					<span class="p">}</span>
					<span class="cm">/* Update variable */</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">RxByteCountLast</span> <span class="o">=</span>
					    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">RxByteCount</span><span class="p">;</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">TxByteCountLast</span> <span class="o">=</span>
					    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">TxByteCount</span><span class="p">;</span>
					<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Turn On LED_1 and blinking if transmitting/receiving */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">!=</span>
					    <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span>
						    <span class="o">~</span><span class="mh">0x3000</span><span class="p">;</span>
						<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span>
						    <span class="mh">0x1000</span><span class="p">;</span>
						<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>	<span class="cm">/* LED_1 On */</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* Default setting. 2 LED be placed on PCB. LED_0: Link On LED_1 Active */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x3000</span><span class="p">;</span>	<span class="cm">/* LED_1 is always on and event enable */</span>
				<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span>
					      <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Gray blinking */</span>
				<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
				<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
				<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span>
				    <span class="n">LED_GRAY</span><span class="p">[(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20</span><span class="p">];</span>
				<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span>
					      <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>

				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
					<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Stop blinking */</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
					<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span>
						      <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_LinkOn</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Check the LED_0 */</span>
					<span class="cm">/* Try to turn ON LED_0 after gray blinking */</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LED_Blinking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Start blinking */</span>
					<span class="n">TimeInterval</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Check the LED_0 */</span>
					<span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
					<span class="n">Wb35Reg_Write</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="mh">0x03bc</span><span class="p">,</span>
						      <span class="n">reg</span><span class="o">-&gt;</span><span class="n">U1BC_LEDConfigure</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">time_count</span> <span class="o">+=</span> <span class="n">TimeInterval</span><span class="p">;</span>
	<span class="n">Wb35Tx_CurrentTime</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">time_count</span><span class="p">);</span>
	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">TimeInterval</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hal_init_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">SoftwareSet</span><span class="p">;</span>

	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">MaxReceiveLifeTime</span> <span class="o">=</span> <span class="n">DEFAULT_MSDU_LIFE_TIME</span><span class="p">;</span>
	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">FragmentThreshold</span> <span class="o">=</span> <span class="n">DEFAULT_FRAGMENT_THRESHOLD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Wb35Reg_initial</span><span class="p">(</span><span class="n">pHwData</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_reg_destroy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Wb35Tx_initial</span><span class="p">(</span><span class="n">pHwData</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_tx_destroy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Wb35Rx_initial</span><span class="p">(</span><span class="n">pHwData</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_rx_destroy</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">);</span>
	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">hal_led_control</span><span class="p">;</span>
	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">);</span>

	<span class="n">SoftwareSet</span> <span class="o">=</span> <span class="n">hal_software_set</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>

	<span class="n">Wb35Rx_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">Wb35Tx_EP2VM_start</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_rx_destroy:</span>
	<span class="n">Wb35Rx_destroy</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
<span class="nl">error_tx_destroy:</span>
	<span class="n">Wb35Tx_destroy</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
<span class="nl">error_reg_destroy:</span>
	<span class="n">Wb35Reg_destroy</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>

	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">SurpriseRemove</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wb35_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">EEPROM_region</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">HwRadioOff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pMacAddr2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pMacAddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">RF_DECIDE_BY_INF</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Mds</span><span class="p">.</span><span class="n">TxRTSThreshold</span>		<span class="o">=</span> <span class="n">DEFAULT_RTSThreshold</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Mds</span><span class="p">.</span><span class="n">TxFragmentThreshold</span>		<span class="o">=</span> <span class="n">DEFAULT_FRAGMENT_THRESHOLD</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">region_INF</span>		<span class="o">=</span> <span class="n">REGION_AUTO</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">TxRateMode</span>		<span class="o">=</span> <span class="n">RATE_AUTO</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">bMacOperationMode</span>	<span class="o">=</span> <span class="n">MODE_802_11_BG</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">MTUsize</span>		<span class="o">=</span> <span class="n">MAX_ETHERNET_PACKET_SIZE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">bPreambleMode</span>		<span class="o">=</span> <span class="n">AUTO_MODE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">bWepKeyError</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">bToSelfPacketReceived</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">WepKeyDetectTimerCount</span>	<span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* 2 seconds */</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">RadioOffStatus</span><span class="p">.</span><span class="n">boSwRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hal_init_hardware</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">EEPROM_region</span> <span class="o">=</span> <span class="n">hal_get_region_from_EEPROM</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EEPROM_region</span> <span class="o">!=</span> <span class="n">REGION_AUTO</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">EEPROM_region</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">region_INF</span> <span class="o">!=</span> <span class="n">REGION_AUTO</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">region_INF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">REGION_USA</span><span class="p">;</span>	<span class="cm">/* default setting */</span>
	<span class="p">}</span>

	<span class="n">Mds_initial</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no user-defined address in the registry, use the address</span>
<span class="cm">	 * &quot;burned&quot; on the NIC instead.</span>
<span class="cm">	 */</span>
	<span class="n">pMacAddr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">ThisMacAddress</span><span class="p">;</span>
	<span class="n">pMacAddr2</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">PermanentAddress</span><span class="p">;</span>

	<span class="cm">/* Reading ethernet address from EEPROM */</span>
	<span class="n">hal_get_permanent_address</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">PermanentAddress</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pMacAddr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MAC_ADDR_LENGTH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pMacAddr</span><span class="p">,</span> <span class="n">pMacAddr2</span><span class="p">,</span> <span class="n">MAC_ADDR_LENGTH</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set the user define MAC address */</span>
		<span class="n">hal_set_ethernet_address</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">ThisMacAddress</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">bAntennaNo</span> <span class="o">=</span> <span class="n">hal_get_antenna_number</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Driver init, antenna no = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">bAntennaNo</span><span class="p">);</span>
	<span class="n">hal_get_hw_radio_off</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>

	<span class="cm">/* Waiting for HAL setting OK */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">hal_idle</span><span class="p">(</span><span class="n">pHwData</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">MTO_Init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">HwRadioOff</span> <span class="o">=</span> <span class="n">hal_get_hw_radio_off</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">RadioOffStatus</span><span class="p">.</span><span class="n">boHwRadioOff</span> <span class="o">=</span> <span class="o">!!</span><span class="n">HwRadioOff</span><span class="p">;</span>

	<span class="n">hal_set_radio_mode</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">RadioOffStatus</span><span class="p">.</span>
					   <span class="n">boSwRadioOff</span>
					   <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sLocalPara</span><span class="p">.</span><span class="n">RadioOffStatus</span><span class="p">.</span>
					   <span class="n">boHwRadioOff</span><span class="p">));</span>

	<span class="cm">/* Notify hal that the driver is ready now. */</span>
	<span class="n">hal_driver_init_OK</span><span class="p">(</span><span class="n">pHwData</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wb35_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ltmp</span><span class="p">;</span>

	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>

	<span class="cm">/* Check the device if it already be opened */</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="mh">0x01</span><span class="p">,</span>
			     <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
			     <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ltmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Is already initialized? */</span>
	<span class="n">ltmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ltmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ltmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wbsoft_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">.</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">wMaxPacketSize</span> <span class="o">==</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[w35und] Working on USB 2.0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">wb35_hw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free_hw</span><span class="p">;</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev_addr</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">];</span>
		<span class="n">hal_get_permanent_address</span><span class="p">(</span><span class="n">pHwData</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">);</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>	<span class="cm">/* FIXME */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_SIGNAL_UNSPEC</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_signal</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wbsoft_band_2GHz</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free_hw</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_free_hw:</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hal_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">LEDTimer</span><span class="p">);</span>
	<span class="cm">/* XXX: Wait for Timer DPC exit. */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">Wb35Rx_destroy</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
	<span class="n">Wb35Tx_destroy</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
	<span class="n">Wb35Reg_destroy</span><span class="p">(</span><span class="n">pHwData</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wb35_hw_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Turn off Rx and Tx hardware ability */</span>
	<span class="n">hal_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;[w35und] Hal_stop O.K.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Waiting Irp completed */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">hal_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wb35_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">wb35_hw_halt</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">wb35_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;w35und&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">wb35_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">wb35_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">wb35_disconnect</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">wb35_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
