<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › winbond › mds.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mds.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;mds_f.h&quot;</span>
<span class="cp">#include &quot;mto.h&quot;</span>
<span class="cp">#include &quot;wbhal.h&quot;</span>
<span class="cp">#include &quot;wb35tx_f.h&quot;</span>

<span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">Mds_initial</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_mds</span> <span class="o">*</span><span class="n">pMds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Mds</span><span class="p">;</span>

	<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxPause</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxRTSThreshold</span> <span class="o">=</span> <span class="n">DEFAULT_RTSThreshold</span><span class="p">;</span>
	<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxFragmentThreshold</span> <span class="o">=</span> <span class="n">DEFAULT_FRAGMENT_THRESHOLD</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hal_get_tx_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">pTxBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">Mds_DurationSet</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">wb35_descriptor</span> <span class="o">*</span><span class="n">pDes</span><span class="p">,</span>  <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="n">pT00</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">T01_descriptor</span> <span class="o">*</span><span class="n">pT01</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">Duration</span><span class="p">,</span> <span class="n">NextBodyLen</span><span class="p">,</span> <span class="n">OffsetSize</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">Rate</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">CTS_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">RTS_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="n">pNextT00</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">BodyLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">boGroupAddr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">OffsetSize</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">FragmentThreshold</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">OffsetSize</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
	<span class="n">Rate</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">TxRate</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Rate</span><span class="p">)</span>
		<span class="n">Rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pT00</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">pT01</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T01_descriptor</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">pNextT00</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="o">+</span><span class="n">OffsetSize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">DOT_11_DA_OFFSET</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="cm">/* +8 for USB hdr */</span>
		<span class="n">boGroupAddr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/******************************************</span>
<span class="cm">	 * Set RTS/CTS mechanism</span>
<span class="cm">	 ******************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boGroupAddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NOTE : If the protection mode is enabled and the MSDU will be fragmented,</span>
<span class="cm">		 *		 the tx rates of MPDUs will all be DSSS rates. So it will not use</span>
<span class="cm">		 *		 CTS-to-self in this case. CTS-To-self will only be used when without</span>
<span class="cm">		 *		 fragmentation. -- 20050112 */</span>
		<span class="n">BodyLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_frame_length</span><span class="p">;</span>	<span class="cm">/* include 802.11 header */</span>
		<span class="n">BodyLen</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* CRC */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">BodyLen</span> <span class="o">&gt;=</span> <span class="n">CURRENT_RTS_THRESHOLD</span><span class="p">)</span>
			<span class="n">RTS_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* Using RTS */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_modulation_type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Is using OFDM */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CURRENT_PROTECT_MECHANISM</span><span class="p">)</span> <span class="cm">/* Is using protect */</span>
					<span class="n">CTS_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* Using CTS */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RTS_on</span> <span class="o">||</span> <span class="n">CTS_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_modulation_type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Is using OFDM */</span>
			<span class="cm">/* CTS duration</span>
<span class="cm">			 *  2 SIFS + DATA transmit time + 1 ACK</span>
<span class="cm">			 *  ACK Rate : 24 Mega bps</span>
<span class="cm">			 *  ACK frame length = 14 bytes */</span>
			<span class="n">Duration</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">DEFAULT_SIFSTIME</span> <span class="o">+</span>
					   <span class="mi">2</span><span class="o">*</span><span class="n">PREAMBLE_PLUS_SIGNAL_PLUS_SIGNALEXTENSION</span> <span class="o">+</span>
					   <span class="p">((</span><span class="n">BodyLen</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="n">Rate</span><span class="o">*</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Rate</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">Tsym</span> <span class="o">+</span>
					   <span class="p">((</span><span class="mi">112</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="mi">95</span><span class="p">)</span><span class="o">/</span><span class="mi">96</span><span class="p">)</span><span class="o">*</span><span class="n">Tsym</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span> <span class="cm">/* DSSS */</span>
			<span class="cm">/* CTS duration</span>
<span class="cm">			 *  2 SIFS + DATA transmit time + 1 ACK</span>
<span class="cm">			 *  Rate : ?? Mega bps</span>
<span class="cm">			 *  ACK frame length = 14 bytes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_plcp_header_length</span><span class="p">)</span> <span class="cm">/* long preamble */</span>
				<span class="n">Duration</span> <span class="o">=</span> <span class="n">LONG_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">Duration</span> <span class="o">=</span> <span class="n">SHORT_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>

			<span class="n">Duration</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">BodyLen</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">Rate</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">Rate</span> <span class="o">+</span>
						<span class="n">DEFAULT_SIFSTIME</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RTS_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_modulation_type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Is using OFDM */</span>
				<span class="cm">/* CTS + 1 SIFS + CTS duration</span>
<span class="cm">				 * CTS Rate : 24 Mega bps</span>
<span class="cm">				 * CTS frame length = 14 bytes */</span>
				<span class="n">Duration</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DEFAULT_SIFSTIME</span> <span class="o">+</span>
								<span class="n">PREAMBLE_PLUS_SIGNAL_PLUS_SIGNALEXTENSION</span> <span class="o">+</span>
								<span class="p">((</span><span class="mi">112</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="mi">95</span><span class="p">)</span><span class="o">/</span><span class="mi">96</span><span class="p">)</span><span class="o">*</span><span class="n">Tsym</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* CTS + 1 SIFS + CTS duration</span>
<span class="cm">				 * CTS Rate : ?? Mega bps</span>
<span class="cm">				 * CTS frame length = 14 bytes */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_plcp_header_length</span><span class="p">)</span> <span class="cm">/* long preamble */</span>
					<span class="n">Duration</span> <span class="o">+=</span> <span class="n">LONG_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">Duration</span> <span class="o">+=</span> <span class="n">SHORT_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="p">;</span>

				<span class="n">Duration</span> <span class="o">+=</span> <span class="p">(((</span><span class="mi">112</span> <span class="o">+</span> <span class="n">Rate</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">Rate</span><span class="p">)</span> <span class="o">+</span> <span class="n">DEFAULT_SIFSTIME</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Set the value into USB descriptor */</span>
		<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_add_rts</span> <span class="o">=</span> <span class="n">RTS_on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_add_cts</span> <span class="o">=</span> <span class="n">CTS_on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_rts_cts_duration</span> <span class="o">=</span> <span class="n">Duration</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/******************************************</span>
<span class="cm">	 * Fill the more fragment descriptor</span>
<span class="cm">	 ******************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boGroupAddr</span><span class="p">)</span>
		<span class="n">Duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">FragmentCount</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NextBodyLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pNextT00</span><span class="o">-&gt;</span><span class="n">T00_frame_length</span><span class="p">;</span>
			<span class="n">NextBodyLen</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* CRC */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_modulation_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* OFDM</span>
<span class="cm">				 *  data transmit time + 3 SIFS + 2 ACK</span>
<span class="cm">				 *  Rate : ??Mega bps</span>
<span class="cm">				 *  ACK frame length = 14 bytes, tx rate = 24M */</span>
				<span class="n">Duration</span> <span class="o">=</span> <span class="n">PREAMBLE_PLUS_SIGNAL_PLUS_SIGNALEXTENSION</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">Duration</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">NextBodyLen</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="n">Rate</span><span class="o">*</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Rate</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span> <span class="o">*</span> <span class="n">Tsym</span> <span class="o">+</span>
							<span class="p">(((</span><span class="mi">2</span><span class="o">*</span><span class="mi">14</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="mi">95</span><span class="p">)</span><span class="o">/</span><span class="mi">96</span><span class="p">)</span><span class="o">*</span><span class="n">Tsym</span> <span class="o">+</span>
							<span class="n">DEFAULT_SIFSTIME</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* DSSS</span>
<span class="cm">				 *  data transmit time + 2 ACK + 3 SIFS</span>
<span class="cm">				 *  Rate : ??Mega bps</span>
<span class="cm">				 *  ACK frame length = 14 bytes</span>
<span class="cm">				 * TODO : */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_plcp_header_length</span><span class="p">)</span> <span class="cm">/* long preamble */</span>
					<span class="n">Duration</span> <span class="o">=</span> <span class="n">LONG_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">Duration</span> <span class="o">=</span> <span class="n">SHORT_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>

				<span class="n">Duration</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">NextBodyLen</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">14</span><span class="p">))</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">Rate</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">Rate</span> <span class="o">+</span>
							<span class="n">DEFAULT_SIFSTIME</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">Duration</span><span class="p">);</span> <span class="cm">/* 4 USHOR for skip 8B USB, 2USHORT=FC + Duration */</span>

			<span class="cm">/* ----20061009 add by anson&#39;s endian */</span>
			<span class="n">pNextT00</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pNextT00</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="cm">/* ----end 20061009 add by anson&#39;s endian */</span>

			<span class="n">buffer</span> <span class="o">+=</span> <span class="n">OffsetSize</span><span class="p">;</span>
			<span class="n">pT01</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T01_descriptor</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* The last fragment will not have the next fragment */</span>
				<span class="n">pNextT00</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span><span class="o">+</span><span class="n">OffsetSize</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*******************************************</span>
<span class="cm">		 * Fill the last fragment descriptor</span>
<span class="cm">		 *******************************************/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_modulation_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* OFDM</span>
<span class="cm">			 *  1 SIFS + 1 ACK</span>
<span class="cm">			 *  Rate : 24 Mega bps</span>
<span class="cm">			 * ACK frame length = 14 bytes */</span>
			<span class="n">Duration</span> <span class="o">=</span> <span class="n">PREAMBLE_PLUS_SIGNAL_PLUS_SIGNALEXTENSION</span><span class="p">;</span>
			<span class="cm">/* The Tx rate of ACK use 24M */</span>
			<span class="n">Duration</span> <span class="o">+=</span> <span class="p">(((</span><span class="mi">112</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="mi">95</span><span class="p">)</span><span class="o">/</span><span class="mi">96</span><span class="p">)</span><span class="o">*</span><span class="n">Tsym</span> <span class="o">+</span> <span class="n">DEFAULT_SIFSTIME</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DSSS</span>
<span class="cm">			 * 1 ACK + 1 SIFS</span>
<span class="cm">			 * Rate : ?? Mega bps</span>
<span class="cm">			 * ACK frame length = 14 bytes(112 bits) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_plcp_header_length</span><span class="p">)</span> <span class="cm">/* long preamble */</span>
				<span class="n">Duration</span> <span class="o">=</span> <span class="n">LONG_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">Duration</span> <span class="o">=</span> <span class="n">SHORT_PREAMBLE_PLUS_PLCPHEADER_TIME</span><span class="p">;</span>

			<span class="n">Duration</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">112</span> <span class="o">+</span> <span class="n">Rate</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">Rate</span> <span class="o">+</span> <span class="n">DEFAULT_SIFSTIME</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">Duration</span><span class="p">);</span> <span class="cm">/* 4 USHOR for skip 8B USB, 2USHORT=FC + Duration */</span>
	<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pT00</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="cm">/* --end 20061009 add */</span>

<span class="p">}</span>

<span class="cm">/* The function return the 4n size of usb pk */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">Mds_BodyCopy</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wb35_descriptor</span> <span class="o">*</span><span class="n">pDes</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">TargetBuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="n">pT00</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wb35_mds</span> <span class="o">*</span><span class="n">pMds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Mds</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">src_buffer</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">pctmp</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">SizeLeft</span><span class="p">,</span> <span class="n">CopySize</span><span class="p">,</span> <span class="n">CopyLeft</span><span class="p">,</span> <span class="n">stmp</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">buf_index</span><span class="p">,</span> <span class="n">FragmentCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/* Copy fragment body */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">TargetBuffer</span><span class="p">;</span> <span class="cm">/* shift 8B usb + 24B 802.11 */</span>
	<span class="n">SizeLeft</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_total_size</span><span class="p">;</span>
	<span class="n">buf_index</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_start_index</span><span class="p">;</span>

	<span class="n">pT00</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">SizeLeft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pT00</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">CopySize</span> <span class="o">=</span> <span class="n">SizeLeft</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SizeLeft</span> <span class="o">&gt;</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">FragmentThreshold</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CopySize</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">FragmentThreshold</span><span class="p">;</span>
			<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_frame_length</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">CopySize</span><span class="p">;</span> <span class="cm">/* Set USB length */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_frame_length</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">SizeLeft</span><span class="p">;</span> <span class="cm">/* Set USB length */</span>

		<span class="n">SizeLeft</span> <span class="o">-=</span> <span class="n">CopySize</span><span class="p">;</span>

		<span class="cm">/* 1 Byte operation */</span>
		<span class="n">pctmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">DOT_11_SEQUENCE_OFFSET</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pctmp</span> <span class="o">&amp;=</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pctmp</span> <span class="o">|=</span> <span class="n">FragmentCount</span><span class="p">;</span> <span class="cm">/* 931130.5.m */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FragmentCount</span><span class="p">)</span>
			<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_first_mpdu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">buffer</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span> <span class="cm">/* 8B usb + 24B 802.11 header */</span>
		<span class="n">Size</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="cm">/* Copy into buffer */</span>
		<span class="n">stmp</span> <span class="o">=</span> <span class="n">CopySize</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">stmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* 4n Alignment */</span>
		<span class="n">Size</span> <span class="o">+=</span> <span class="n">stmp</span><span class="p">;</span> <span class="cm">/* Current 4n offset of mpdu */</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">CopySize</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Copy body */</span>
			<span class="n">src_buffer</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_address</span><span class="p">[</span><span class="n">buf_index</span><span class="p">];</span>
			<span class="n">CopyLeft</span> <span class="o">=</span> <span class="n">CopySize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CopySize</span> <span class="o">&gt;=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">[</span><span class="n">buf_index</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">CopyLeft</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">[</span><span class="n">buf_index</span><span class="p">];</span>

				<span class="cm">/* Get the next buffer of descriptor */</span>
				<span class="n">buf_index</span><span class="o">++</span><span class="p">;</span>
				<span class="n">buf_index</span> <span class="o">%=</span> <span class="n">MAX_DESCRIPTOR_BUFFER_INDEX</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">u8</span>	<span class="o">*</span><span class="n">pctmp</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_address</span><span class="p">[</span><span class="n">buf_index</span><span class="p">];</span>
				<span class="n">pctmp</span> <span class="o">+=</span> <span class="n">CopySize</span><span class="p">;</span>
				<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_address</span><span class="p">[</span><span class="n">buf_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pctmp</span><span class="p">;</span>
				<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">[</span><span class="n">buf_index</span><span class="p">]</span> <span class="o">-=</span> <span class="n">CopySize</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">src_buffer</span><span class="p">,</span> <span class="n">CopyLeft</span><span class="p">);</span>
			<span class="n">buffer</span> <span class="o">+=</span> <span class="n">CopyLeft</span><span class="p">;</span>
			<span class="n">CopySize</span> <span class="o">-=</span> <span class="n">CopyLeft</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* 931130.5.n */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicAdd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SizeLeft</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteAddress</span><span class="p">[</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicAdd</span><span class="p">;</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteSize</span><span class="p">[</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicAdd</span><span class="p">;</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicAdd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SizeLeft</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 931130.5.p */</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicAdd</span> <span class="o">=</span> <span class="n">SizeLeft</span><span class="p">;</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteAddress</span><span class="p">[</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">-</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">SizeLeft</span><span class="p">);</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteSize</span><span class="p">[</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">SizeLeft</span><span class="p">;</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">MicWriteIndex</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Does it need to generate the new header for next mpdu? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SizeLeft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buffer</span> <span class="o">=</span> <span class="n">TargetBuffer</span> <span class="o">+</span> <span class="n">Size</span><span class="p">;</span> <span class="cm">/* Get the next 4n start address */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">TargetBuffer</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span> <span class="cm">/* Copy 8B USB +24B 802.11 */</span>
			<span class="n">pT00</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
			<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_first_mpdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">FragmentCount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_last_mpdu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_IsLastMpdu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pT00</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* +8 for USB hdr */</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Clear more frag bit of 802.11 frame control */</span>
	<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">FragmentCount</span> <span class="o">=</span> <span class="n">FragmentCount</span><span class="p">;</span> <span class="cm">/* Update the correct fragment number */</span>
	<span class="k">return</span> <span class="n">Size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">Mds_HeaderCopy</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wb35_descriptor</span> <span class="o">*</span><span class="n">pDes</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">TargetBuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_mds</span> <span class="o">*</span><span class="n">pMds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Mds</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">src_buffer</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_address</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* 931130.5.g */</span>
	<span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="n">pT00</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">T01_descriptor</span> <span class="o">*</span><span class="n">pT01</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">stmp</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">i</span><span class="p">,</span> <span class="n">ctmp1</span><span class="p">,</span> <span class="n">ctmp2</span><span class="p">,</span> <span class="n">ctmpf</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">FragmentThreshold</span> <span class="o">=</span> <span class="n">CURRENT_FRAGMENT_THRESHOLD</span><span class="p">;</span>


	<span class="n">stmp</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_total_size</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set USB header 8 byte</span>
<span class="cm">	 */</span>
	<span class="n">pT00</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T00_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">TargetBuffer</span><span class="p">;</span>
	<span class="n">TargetBuffer</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pT01</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">T01_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">TargetBuffer</span><span class="p">;</span>
	<span class="n">TargetBuffer</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Clear */</span>
	<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Clear */</span>

	<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_tx_packet_id</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">Descriptor_ID</span><span class="p">;</span> <span class="cm">/* Set packet ID */</span>
	<span class="n">pT00</span><span class="o">-&gt;</span><span class="n">T00_header_length</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="cm">/* Set header length */</span>
	<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_retry_abort_ebable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 921013 931130.5.h */</span>

	<span class="cm">/* Key ID setup */</span>
	<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_wep_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">FragmentThreshold</span> <span class="o">=</span> <span class="n">DEFAULT_FRAGMENT_THRESHOLD</span><span class="p">;</span>	<span class="cm">/* Do not fragment */</span>
	<span class="cm">/* Copy full data, the 1&#39;st buffer contain all the data 931130.5.j */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">TargetBuffer</span><span class="p">,</span> <span class="n">src_buffer</span><span class="p">,</span> <span class="n">DOT_11_MAC_HEADER_SIZE</span><span class="p">);</span> <span class="cm">/* Copy header */</span>
	<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_buffer</span> <span class="o">+</span> <span class="n">DOT_11_MAC_HEADER_SIZE</span><span class="p">;</span>
	<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_total_size</span> <span class="o">-=</span> <span class="n">DOT_11_MAC_HEADER_SIZE</span><span class="p">;</span>
	<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">buffer_total_size</span><span class="p">;</span>

	<span class="cm">/* Set fragment threshold */</span>
	<span class="n">FragmentThreshold</span> <span class="o">-=</span> <span class="p">(</span><span class="n">DOT_11_MAC_HEADER_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">FragmentThreshold</span> <span class="o">=</span> <span class="n">FragmentThreshold</span><span class="p">;</span>

	<span class="cm">/* Set more frag bit */</span>
	<span class="n">TargetBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Set more frag bit */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set tx rate</span>
<span class="cm">	 */</span>
	<span class="n">stmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">TargetBuffer</span><span class="o">+</span><span class="mi">30</span><span class="p">);</span> <span class="cm">/* 2n alignment address */</span>

	<span class="cm">/* Use basic rate */</span>
	<span class="n">ctmp1</span> <span class="o">=</span> <span class="n">ctmpf</span> <span class="o">=</span> <span class="n">CURRENT_TX_RATE_FOR_MNG</span><span class="p">;</span>

	<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">TxRate</span> <span class="o">=</span> <span class="n">ctmp1</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Tx rate =%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctmp1</span><span class="p">);</span>

	<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_modulation_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctmp1</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ctmp1</span> <span class="o">=</span> <span class="n">ctmpf</span><span class="p">;</span>

		<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxRate</span><span class="p">[</span><span class="n">pDes</span><span class="o">-&gt;</span><span class="n">Descriptor_ID</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctmp1</span><span class="p">;</span> <span class="cm">/* backup the ta rate and fall back rate */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">108</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">96</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* Rate convert for USB */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">72</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">48</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">36</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">18</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">22</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctmp1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctmp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* if( ctmp1 == 2  ) or default */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_transmit_rate</span> <span class="o">=</span> <span class="n">ctmp2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_fall_back_rate</span> <span class="o">=</span> <span class="n">ctmp2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set preamble type</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_modulation_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_transmit_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>	<span class="cm">/* RATE_1M */</span>
		<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">PreambleMode</span> <span class="o">=</span>  <span class="n">WLAN_PREAMBLE_TYPE_LONG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pDes</span><span class="o">-&gt;</span><span class="n">PreambleMode</span> <span class="o">=</span>  <span class="n">CURRENT_PREAMBLE_MODE</span><span class="p">;</span>
	<span class="n">pT01</span><span class="o">-&gt;</span><span class="n">T01_plcp_header_length</span> <span class="o">=</span> <span class="n">pDes</span><span class="o">-&gt;</span><span class="n">PreambleMode</span><span class="p">;</span>	<span class="cm">/* Set preamble */</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MLME_GetNextPacket</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wb35_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">InternalUsed</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">buffer_start_index</span> <span class="o">+</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">buffer_number</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">InternalUsed</span> <span class="o">%=</span> <span class="n">MAX_DESCRIPTOR_BUFFER_INDEX</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">buffer_address</span><span class="p">[</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">InternalUsed</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">pMMPDU</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">[</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">InternalUsed</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">buffer_total_size</span> <span class="o">+=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">buffer_number</span><span class="o">++</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">Type</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">DataType</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MLMEfreeMMPDUBuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">pData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Reclaim the data buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_TX_MMPDU</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pData</span> <span class="o">==</span> <span class="p">(</span><span class="n">s8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">TxMMPDU</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">TxMMPDUInUse</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">TxMMPDUInUse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>  <span class="p">{</span>
		<span class="cm">/* Something wrong</span>
<span class="cm">		 PD43 Add debug code here??? */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MLME_SendComplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">PacketID</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SendOK</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Reclaim the data buffer */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MLMEfreeMMPDUBuffer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">pMMPDU</span><span class="p">);</span>

	<span class="cm">/* Return resource */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">IsInUsed</span> <span class="o">=</span> <span class="n">PACKET_FREE_TO_USE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">Mds_Tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wb35_mds</span> <span class="o">*</span><span class="n">pMds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Mds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wb35_descriptor</span>	<span class="n">TxDes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wb35_descriptor</span> <span class="o">*</span><span class="n">pTxDes</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TxDes</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">XmitBufAddress</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">XmitBufSize</span><span class="p">,</span> <span class="n">PacketSize</span><span class="p">,</span> <span class="n">stmp</span><span class="p">,</span> <span class="n">CurrentSize</span><span class="p">,</span> <span class="n">FragmentThreshold</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">FillIndex</span><span class="p">,</span> <span class="n">TxDesIndex</span><span class="p">,</span> <span class="n">FragmentCount</span><span class="p">,</span> <span class="n">FillCount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">BufferFilled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxPause</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hal_driver_init_OK</span><span class="p">(</span><span class="n">pHwData</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Only one thread can be run here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxThreadCount</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="cm">/* Start to fill the data */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">FillIndex</span> <span class="o">=</span> <span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxFillIndex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxOwner</span><span class="p">[</span><span class="n">FillIndex</span><span class="p">])</span> <span class="p">{</span> <span class="cm">/* Is owned by software 0:Yes 1:No */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;[Mds_Tx] Tx Owner is H/W.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">XmitBufAddress</span> <span class="o">=</span> <span class="n">pMds</span><span class="o">-&gt;</span><span class="n">pTxBuffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_USB_TX_BUFFER</span> <span class="o">*</span> <span class="n">FillIndex</span><span class="p">);</span> <span class="cm">/* Get buffer */</span>
		<span class="n">XmitBufSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">FillCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">PacketSize</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sMlmeFrame</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PacketSize</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* For Check the buffer resource */</span>
			<span class="n">FragmentThreshold</span> <span class="o">=</span> <span class="n">CURRENT_FRAGMENT_THRESHOLD</span><span class="p">;</span>
			<span class="cm">/* 931130.5.b */</span>
			<span class="n">FragmentCount</span> <span class="o">=</span> <span class="n">PacketSize</span><span class="o">/</span><span class="n">FragmentThreshold</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">stmp</span> <span class="o">=</span> <span class="n">PacketSize</span> <span class="o">+</span> <span class="n">FragmentCount</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 931130.5.c 8:MIC */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">XmitBufSize</span> <span class="o">+</span> <span class="n">stmp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_USB_TX_BUFFER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[Mds_Tx] Excess max tx buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* buffer is not enough */</span>
			<span class="p">}</span>


			<span class="cm">/*</span>
<span class="cm">			 * Start transmitting</span>
<span class="cm">			 */</span>
			<span class="n">BufferFilled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/* Leaves first u8 intact */</span>
			<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pTxDes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wb35_descriptor</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">TxDesIndex</span> <span class="o">=</span> <span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxDesIndex</span><span class="p">;</span> <span class="cm">/* Get the current ID */</span>
			<span class="n">pTxDes</span><span class="o">-&gt;</span><span class="n">Descriptor_ID</span> <span class="o">=</span> <span class="n">TxDesIndex</span><span class="p">;</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxDesFrom</span><span class="p">[</span><span class="n">TxDesIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Storing the information of source coming from */</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxDesIndex</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxDesIndex</span> <span class="o">%=</span> <span class="n">MAX_USB_TX_DESCRIPTOR</span><span class="p">;</span>

			<span class="n">MLME_GetNextPacket</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pTxDes</span><span class="p">);</span>

			<span class="cm">/* Copy header. 8byte USB + 24byte 802.11Hdr. Set TxRate, Preamble type */</span>
			<span class="n">Mds_HeaderCopy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pTxDes</span><span class="p">,</span> <span class="n">XmitBufAddress</span><span class="p">);</span>

			<span class="cm">/* For speed up Key setting */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pTxDes</span><span class="o">-&gt;</span><span class="n">EapFix</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;35: EPA 4th frame detected. Size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PacketSize</span><span class="p">);</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">IsKeyPreSet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Copy (fragment) frame body, and set USB, 802.11 hdr flag */</span>
			<span class="n">CurrentSize</span> <span class="o">=</span> <span class="n">Mds_BodyCopy</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pTxDes</span><span class="p">,</span> <span class="n">XmitBufAddress</span><span class="p">);</span>

			<span class="cm">/* Set RTS/CTS and Normal duration field into buffer */</span>
			<span class="n">Mds_DurationSet</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pTxDes</span><span class="p">,</span> <span class="n">XmitBufAddress</span><span class="p">);</span>

			<span class="cm">/* Shift to the next address */</span>
			<span class="n">XmitBufSize</span> <span class="o">+=</span> <span class="n">CurrentSize</span><span class="p">;</span>
			<span class="n">XmitBufAddress</span> <span class="o">+=</span> <span class="n">CurrentSize</span><span class="p">;</span>

			<span class="cm">/* Get packet to transmit completed, 1:TESTSTA 2:MLME 3: Ndis data */</span>
			<span class="n">MLME_SendComplete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="cm">/* Software TSC count 20060214 */</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxTsc</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxTsc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxTsc_2</span><span class="o">++</span><span class="p">;</span>

			<span class="n">FillCount</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* 20060928 */</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">HAL_USB_MODE_BURST</span><span class="p">(</span><span class="n">pHwData</span><span class="p">));</span> <span class="cm">/* End of multiple MSDU copy loop. false = single true = multiple sending  */</span>

		<span class="cm">/* Move to the next one, if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BufferFilled</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* size setting */</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxBufferSize</span><span class="p">[</span><span class="n">FillIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">XmitBufSize</span><span class="p">;</span>

			<span class="cm">/* 20060928 set Tx count */</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxCountInBuffer</span><span class="p">[</span><span class="n">FillIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">FillCount</span><span class="p">;</span>

			<span class="cm">/* Set owner flag */</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxOwner</span><span class="p">[</span><span class="n">FillIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxFillIndex</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxFillIndex</span> <span class="o">%=</span> <span class="n">MAX_USB_TX_BUFFER_NUMBER</span><span class="p">;</span>
			<span class="n">BufferFilled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PacketSize</span><span class="p">)</span> <span class="cm">/* No more pk for transmitting */</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start to send by lower module</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">IsKeyPreSet</span><span class="p">)</span>
		<span class="n">Wb35Tx_start</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">cleanup:</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxThreadCount</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">Mds_SendComplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsoft_priv</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">T02_descriptor</span> <span class="o">*</span><span class="n">pT02</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wb35_mds</span> <span class="o">*</span><span class="n">pMds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Mds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_data</span> <span class="o">*</span><span class="n">pHwData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sHwData</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">PacketId</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_Tx_PktID</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">SendOK</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">RetryCount</span><span class="p">,</span> <span class="n">TxRate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_IgnoreResult</span><span class="p">)</span> <span class="cm">/* Don&#39;t care the result */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_IsLastMpdu</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: DTO -- get the retry count and fragment count */</span>
		<span class="cm">/* Tx rate */</span>
		<span class="n">TxRate</span> <span class="o">=</span> <span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxRate</span><span class="p">[</span><span class="n">PacketId</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">RetryCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_MPDU_Cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">FLAG_ERROR_TX_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SendOK</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_transmit_abort</span> <span class="o">||</span> <span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_out_of_MaxTxMSDULiftTime</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* retry error */</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">dto_tx_retry_count</span> <span class="o">+=</span> <span class="p">(</span><span class="n">RetryCount</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
				<span class="cm">/* [for tx debug] */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">RetryCount</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">tx_retry_count</span><span class="p">[</span><span class="n">RetryCount</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RetryCount</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">tx_retry_count</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+=</span> <span class="n">RetryCount</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dto_tx_retry_count =%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">dto_tx_retry_count</span><span class="p">);</span>
				<span class="n">MTO_SetTxCount</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">TxRate</span><span class="p">,</span> <span class="n">RetryCount</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">dto_tx_frag_count</span> <span class="o">+=</span> <span class="p">(</span><span class="n">RetryCount</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* [for tx debug] */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_transmit_abort_due_to_TBTT</span><span class="p">)</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">tx_TBTT_start_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_transmit_without_encryption_due_to_wep_on_false</span><span class="p">)</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">tx_WepOn_false_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_discard_due_to_null_wep_key</span><span class="p">)</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">tx_Null_key_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">T02_effective_transmission_rate</span><span class="p">)</span>
				<span class="n">pHwData</span><span class="o">-&gt;</span><span class="n">tx_ETR_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">MTO_SetTxCount</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">TxRate</span><span class="p">,</span> <span class="n">RetryCount</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Clear send result buffer */</span>
		<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxResult</span><span class="p">[</span><span class="n">PacketId</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pMds</span><span class="o">-&gt;</span><span class="n">TxResult</span><span class="p">[</span><span class="n">PacketId</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">pT02</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0ffff</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
