<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8192u › ieee80211 › ieee80211_rx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ieee80211_rx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Original code based Host AP (software wireless LAN access point) driver</span>
<span class="cm"> * for Intersil Prism2/2.5/3 - hostap.o module, common routines</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001-2002, SSH Communications Security Corp and Jouni Malinen</span>
<span class="cm"> * &lt;jkmaline@cc.hut.fi&gt;</span>
<span class="cm"> * Copyright (c) 2002-2003, Jouni Malinen &lt;jkmaline@cc.hut.fi&gt;</span>
<span class="cm"> * Copyright (c) 2004, Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation. See README and COPYING for</span>
<span class="cm"> * more details.</span>
<span class="cm"> ******************************************************************************</span>

<span class="cm">  Few modifications for Realtek&#39;s Wi-Fi drivers by</span>
<span class="cm">  Andrea Merello &lt;andreamrl@tiscali.it&gt;</span>

<span class="cm">  A special thanks goes to Realtek for their support !</span>

<span class="cm">******************************************************************************/</span>


<span class="cp">#include &lt;linux/compiler.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>include <linux/config.h></h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>

<span class="cp">#include &quot;ieee80211.h&quot;</span>
<span class="cp">#include &quot;dot11d.h&quot;</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_monitor_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
        <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_80211_RAW</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span>
<span class="nf">ieee80211_frag_cache_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">,</span><span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_FRAG_CACHE_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG_FRAG</span><span class="p">(</span>
				<span class="s">&quot;expiring fragment cache entry &quot;</span>
				<span class="s">&quot;seq=%u last_frag=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">==</span> <span class="n">seq</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">frag</span> <span class="o">||</span> <span class="n">frag</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">ieee80211_frag_cache_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="n">hdr_3addrqos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="n">hdr_4addrqos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_4addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_4addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QCTL_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_3addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_3addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QCTL_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reserve enough space to fit maximum frame length */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span><span class="p">)</span> <span class="o">+</span>
				    <span class="mi">8</span> <span class="cm">/* LLC */</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="cm">/* alignment */</span> <span class="o">+</span>
				    <span class="mi">8</span> <span class="cm">/* WEP */</span> <span class="o">+</span>
				    <span class="n">ETH_ALEN</span> <span class="cm">/* WDS */</span> <span class="o">+</span>
				    <span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span><span class="o">?</span><span class="mi">2</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="cm">/* QOS Control */</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]];</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">IEEE80211_FRAG_CACHE_LEN</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* received a fragment of a frame for which the head fragment</span>
<span class="cm">		 * should have already been received */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">ieee80211_frag_cache_find</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
						  <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_frag_cache_invalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="n">hdr_3addrqos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="n">hdr_4addrqos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_4addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_4addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QCTL_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_3addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_3addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QCTL_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">ieee80211_frag_cache_find</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
					  <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_FRAG</span><span class="p">(</span>
			<span class="s">&quot;could not invalidate fragment cache &quot;</span>
			<span class="s">&quot;entry (seq=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ieee80211_rx_frame_mgtmt</span>
<span class="cm"> *</span>
<span class="cm"> * Responsible for handling management control frames</span>
<span class="cm"> *</span>
<span class="cm"> * Called by ieee80211_rx */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_frame_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">stype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* On the struct stats definition there is written that</span>
<span class="cm">	 * this is not mandatory.... but seems that the probe</span>
<span class="cm">	 * response parser uses it</span>
<span class="cm">	 */</span>
        <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span> <span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">ieee80211_rx_mgt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">rx_stats</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>if ((ieee->state == IEEE80211<em>LINKED) &amp;&amp; (memcmp(hdr->addr3, ieee->current</em>network.bssid, ETH_ALEN)))</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)))</span><span class="c1">//use ADDR1 to perform address matching for Management frames</span>
        <span class="p">{</span>
                <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">ieee80211_rx_frame_softmac</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">);</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cp">#ifdef NOT_YET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Master mode not yet supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">  hostap_update_sta_ps(ieee, (struct hostap_ieee80211_hdr_4addr *)</span>
<span class="cm">  skb-&gt;data);*/</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hostapd</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_TYPE_MGMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">WLAN_FC_STYPE_BEACON</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
			<span class="cm">/* Process beacon frames also in kernel driver to</span>
<span class="cm">			 * update STA(AP) table statistics */</span>
			<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb2</span><span class="p">)</span>
				<span class="n">hostap_rx</span><span class="p">(</span><span class="n">skb2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb2</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* send management frames to the user space daemon for</span>
<span class="cm">		 * processing */</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">apdevstats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">apdevstats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">prism2_rx_80211</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">PRISM2_RX_MGMT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">WLAN_FC_TYPE_MGMT</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">WLAN_FC_TYPE_CTRL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown management frame &quot;</span>
			       <span class="s">&quot;(type=0x%02x, stype=0x%02x) dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hostap_rx</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hostap_rx_frame_mgmt: management frame &quot;</span>
	       <span class="s">&quot;received in non-Host AP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cp">#endif</span>
<span class="p">}</span>



<span class="cm">/* See IEEE 802.1H for LLC/SNAP encapsulation/decapsulation */</span>
<span class="cm">/* Ethernet-II snap header (RFC1042 for most EtherTypes) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rfc1042_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
<span class="cm">/* Bridge-Tunnel header (for EtherTypes ETH_P_AARP and ETH_P_IPX) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bridge_tunnel_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
<span class="cm">/* No encapsulation header if EtherType &lt; 0x600 (=length) */</span>

<span class="cm">/* Called by ieee80211_rx_frame_decrypt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">hdrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">ethertype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>

	<span class="cm">/* check that the frame is unicast frame to us */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
	    <span class="n">IEEE80211_FCTL_TODS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ToDS frame with own addr BSSID and DA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
		   <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">&amp;&amp;</span>
		   <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FromDS frame with own addr as DA */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check for port access entity Ethernet type */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>pos = skb->data + 24;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pos</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethertype</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called only as a tasklet (software IRQ), by ieee80211_rx */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_frame_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hwsec_active</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bHwSec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_IEEE80211_CRYPT_TKIP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TKIP countermeasures: dropped &quot;</span>
			       <span class="s">&quot;received packet from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
			<span class="s">&quot;decryption failed (SA=%pM&quot;</span>
			<span class="s">&quot;) res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Decryption failed ICV &quot;</span>
					     <span class="s">&quot;mismatch (key %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">.</span><span class="n">rx_discards_undecryptable</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ), by ieee80211_rx */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ieee80211_rx_frame_decrypt_msdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">keyidx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_msdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hwsec_active</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bHwSec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_msdu</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: MSDU decryption/MIC verification failed&quot;</span>
		       <span class="s">&quot; (SA=%pM keyidx=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* this function is stolen from ipw2200 driver*/</span>
<span class="cp">#define IEEE_PACKET_RETRY_TIME (5*HZ)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_duplicate_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">last_seq</span><span class="p">,</span> <span class="o">*</span><span class="n">last_frag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span> <span class="o">*</span><span class="n">hdr_3addrqos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="n">hdr_4addrqos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>TO2DS and QoS</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FCTL_DSTODS</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">hdr_4addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addrqos</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_4addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QCTL_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span> <span class="c1">//QoS</span>
	  <span class="n">hdr_3addrqos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addrqos</span><span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr_3addrqos</span><span class="o">-&gt;</span><span class="n">qos_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QCTL_TID</span><span class="p">;</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	  <span class="n">tid</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// no QoS</span>
	  <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee_ibss_seq</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">%</span> <span class="n">IEEE_IBSS_MAC_HASH_SIZE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>for (pos = (head)->next; pos != (head); pos = pos->next)
<em>_list</em>for<em>each(p, &amp;ieee->ibss</em>mac_hash[index]) {</p></td><td class="code"><div class="highlight"><pre>		<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee_ibss_seq</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>if (memcmp(entry->mac, mac, ETH_ALEN)){</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_ibss_seq</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Cannot malloc new mac entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">frag_num</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">packet_time</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ibss_mac_hash</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last_seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">frag_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_time</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">packet_time</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">last_seq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxseq_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxfrag_num</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="n">last_time</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_packet_time</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>if(tid != 0) {
    printk(KERN<em>WARNING ":)))))))))))%x %x %x, fc(%x)\n", tid, *last</em>seq, seq, header->frame_ctl);
}</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">last_seq</span> <span class="o">==</span> <span class="n">seq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="o">*</span><span class="n">last_time</span> <span class="o">+</span> <span class="n">IEEE_PACKET_RETRY_TIME</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_frag</span> <span class="o">==</span> <span class="n">frag</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>printk(KERN_WARNING "[1] go drop!\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_frag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">frag</span><span class="p">)</span>
			<span class="cm">/* out-of-order fragment */</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>printk(KERN_WARNING "[2] go drop!\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">last_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>

	<span class="o">*</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
	<span class="o">*</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop:</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>BUG<em>ON(!(fc &amp; IEEE80211</em>FCTL_RETRY));
printk("DUP\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">bool</span>
<span class="nf">AddReorderEntry</span><span class="p">(</span>
	<span class="n">PRX_TS_RECORD</span>			<span class="n">pTS</span><span class="p">,</span>
	<span class="n">PRX_REORDER_ENTRY</span>		<span class="n">pReorderEntry</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pList</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPendingPktList</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">pList</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPendingPktList</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">SN_LESS</span><span class="p">(</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">SeqNum</span><span class="p">,</span> <span class="p">((</span><span class="n">PRX_REORDER_ENTRY</span><span class="p">)</span><span class="n">list_entry</span><span class="p">(</span><span class="n">pList</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="n">RX_REORDER_ENTRY</span><span class="p">,</span><span class="n">List</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">SeqNum</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">pList</span> <span class="o">=</span> <span class="n">pList</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">SN_EQUAL</span><span class="p">(</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">SeqNum</span><span class="p">,</span> <span class="p">((</span><span class="n">PRX_REORDER_ENTRY</span><span class="p">)</span><span class="n">list_entry</span><span class="p">(</span><span class="n">pList</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="n">RX_REORDER_ENTRY</span><span class="p">,</span><span class="n">List</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">SeqNum</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">pList</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">.</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">;</span>
	<span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">pList</span><span class="p">;</span>
	<span class="n">pList</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_indicate_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rxb</span><span class="o">**</span> <span class="n">prxbIndicateArray</span><span class="p">,</span><span class="n">u8</span>  <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ethertype</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>if(index > 1)
    IEEE80211<em>DEBUG(IEEE80211</em>DL_REORDER,"%s(): hahahahhhh, We indicate packet from reorder list, index is %u\n",<strong>FUNCTION</strong>,index);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">index</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>added by amy for reorder</p></td><td class="code"><div class="highlight"><pre>		<span class="k">struct</span> <span class="n">ieee80211_rxb</span><span class="o">*</span> <span class="n">prxb</span> <span class="o">=</span> <span class="n">prxbIndicateArray</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">prxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sub_skb</span> <span class="o">=</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* convert hdr + possible LLC headers into Ethernet header */</span>
			<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rfc1042_header</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				  <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_AARP</span> <span class="o">&amp;&amp;</span> <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_IPX</span><span class="p">)</span> <span class="o">||</span>
				 <span class="n">memcmp</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bridge_tunnel_header</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* remove RFC1042 or Bridge-Tunnel encapsulation and</span>
<span class="cm">			 * replace EtherType */</span>
				<span class="n">skb_pull</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
			<span class="cm">/* Leave Ethernet header part of hdr and full payload */</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>stats->rx<em>packets++;
stats->rx</em>bytes += sub_skb->len;</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* Indicat the packets to upper layer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sub_skb</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>printk("0skb_len(%d)\n", skb->len);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
				<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
				<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span> <span class="cm">/* 802.11 crc not sufficient */</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>skb->ip<em>summed = CHECKSUM</em>UNNECESSARY; /* 802.11 crc not sufficient */</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rx_ps_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>printk("1skb_len(%d)\n", skb->len);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">netif_rx</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">prxb</span><span class="p">);</span>
		<span class="n">prxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">RxReorderIndicatePacket</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_rxb</span><span class="o">*</span> <span class="n">prxb</span><span class="p">,</span>
		<span class="n">PRX_TS_RECORD</span>		<span class="n">pTS</span><span class="p">,</span>
		<span class="n">u16</span>			<span class="n">SeqNum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PRT_HIGH_THROUGHPUT</span>	<span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>
	<span class="n">PRX_REORDER_ENTRY</span> 	<span class="n">pReorderEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rxb</span><span class="o">*</span> <span class="n">prxbIndicateArray</span><span class="p">[</span><span class="n">REORDER_WIN_SIZE</span><span class="p">];</span>
	<span class="n">u8</span>			<span class="n">WinSize</span> <span class="o">=</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">RxReorderWinSize</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">WinEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">+</span> <span class="n">WinSize</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4096</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">bMatchWinStart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">bPktInBuf</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span><span class="s">&quot;%s(): Seq is %d,pTS-&gt;RxIndicateSeq is %d, WinSize is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">SeqNum</span><span class="p">,</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">,</span><span class="n">WinSize</span><span class="p">);</span>
	<span class="cm">/* Rx Reorder initialize condition.*/</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">=</span> <span class="n">SeqNum</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Drop out the packet which SeqNum is smaller than WinStart */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SN_LESS</span><span class="p">(</span><span class="n">SeqNum</span><span class="p">,</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span><span class="s">&quot;Packet Drop! IndicateSeq: %d, NewSeq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">);</span>
		<span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">RxReorderDropCounter</span><span class="o">++</span><span class="p">;</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">prxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">prxb</span><span class="p">);</span>
			<span class="n">prxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sliding window manipulation. Conditions includes:</span>
<span class="cm">	 * 1. Incoming SeqNum is equal to WinStart =&gt;Window shift 1</span>
<span class="cm">	 * 2. Incoming SeqNum is larger than the WinEnd =&gt; Window shift N</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SN_EQUAL</span><span class="p">(</span><span class="n">SeqNum</span><span class="p">,</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">=</span> <span class="p">(</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">bMatchWinStart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SN_LESS</span><span class="p">(</span><span class="n">WinEnd</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">SeqNum</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">WinSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">=</span> <span class="n">SeqNum</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span><span class="n">WinSize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">=</span> <span class="mi">4095</span> <span class="o">-</span> <span class="p">(</span><span class="n">WinSize</span> <span class="o">-</span> <span class="p">(</span><span class="n">SeqNum</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span> <span class="s">&quot;Window Shift! IndicateSeq: %d, NewSeq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Indication process.</span>
<span class="cm">	 * After Packet dropping and Sliding Window shifting as above, we can now just indicate the packets</span>
<span class="cm">	 * with the SeqNum smaller than latest WinStart and buffer other packets.</span>
<span class="cm">	 */</span>
	<span class="cm">/* For Rx Reorder condition:</span>
<span class="cm">	 * 1. All packets with SeqNum smaller than WinStart =&gt; Indicate</span>
<span class="cm">	 * 2. All packets with SeqNum larger than or equal to WinStart =&gt; Buffer it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bMatchWinStart</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Current packet is going to be indicated.*/</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span> <span class="s">&quot;Packets indication!! IndicateSeq: %d, NewSeq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
				<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">);</span>
		<span class="n">prxbIndicateArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">prxb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><pre><code>printk("========================&gt;%s(): SeqNum is %d\n",__FUNCTION__,SeqNum);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Current packet is going to be inserted into pending list.*/</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>IEEE80211<em>DEBUG(IEEE80211</em>DL_REORDER,"%s(): We RX no ordered packed, insert to ordered list\n",<strong>FUNCTION</strong>);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">RxReorder_Unused_List</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pReorderEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRX_REORDER_ENTRY</span><span class="p">)</span><span class="n">list_entry</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">RxReorder_Unused_List</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="n">RX_REORDER_ENTRY</span><span class="p">,</span><span class="n">List</span><span class="p">);</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">);</span>

			<span class="cm">/* Make a reorder entry and insert into a the packet list.*/</span>
			<span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">SeqNum</span> <span class="o">=</span> <span class="n">SeqNum</span><span class="p">;</span>
			<span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">prxb</span> <span class="o">=</span> <span class="n">prxb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><pre><code>IEEE80211_DEBUG(IEEE80211_DL_REORDER,"%s(): pREorderEntry-&gt;SeqNum is %d\n",__FUNCTION__,pReorderEntry-&gt;SeqNum);
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">AddReorderEntry</span><span class="p">(</span><span class="n">pTS</span><span class="p">,</span> <span class="n">pReorderEntry</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span> <span class="s">&quot;%s(): Duplicate packet is dropped!! IndicateSeq: %d, NewSeq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">RxReorder_Unused_List</span><span class="p">);</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">prxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="p">}</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">prxb</span><span class="p">);</span>
					<span class="n">prxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span>
					 <span class="s">&quot;Pkt insert into buffer!! IndicateSeq: %d, NewSeq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Packets are dropped if there is not enough reorder entries.</span>
<span class="cm">			 * This part shall be modified!! We can just indicate all the</span>
<span class="cm">			 * packets in buffer and get reorder entries.</span>
<span class="cm">			 */</span>
			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;RxReorderIndicatePacket(): There is no reorder entry!! Packet is dropped!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">prxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">prxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">prxb</span><span class="p">);</span>
				<span class="n">prxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check if there is any packet need indicate.*/</span>
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPendingPktList</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span><span class="s">&quot;%s(): start RREORDER indicate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="n">pReorderEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRX_REORDER_ENTRY</span><span class="p">)</span><span class="n">list_entry</span><span class="p">(</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPendingPktList</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span><span class="n">RX_REORDER_ENTRY</span><span class="p">,</span><span class="n">List</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">SN_LESS</span><span class="p">(</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">SeqNum</span><span class="p">,</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">SN_EQUAL</span><span class="p">(</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">SeqNum</span><span class="p">,</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="cm">/* This protect buffer from overflow. */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">REORDER_WIN_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;RxReorderIndicatePacket(): Buffer overflow!! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bPktInBuf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">SN_EQUAL</span><span class="p">(</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">SeqNum</span><span class="p">,</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">))</span>
				<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">=</span> <span class="p">(</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4096</span><span class="p">;</span>

			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span><span class="s">&quot;Packets indication!! IndicateSeq: %d, NewSeq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">);</span>
			<span class="n">prxbIndicateArray</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">prxb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>printk("========================>%s(): pReorderEntry->SeqNum is %d\n",<strong>FUNCTION</strong>,pReorderEntry->SeqNum);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">index</span><span class="o">++</span><span class="p">;</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pReorderEntry</span><span class="o">-&gt;</span><span class="n">List</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">RxReorder_Unused_List</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bPktInBuf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handling pending timer. Set this timer to prevent from long time Rx buffering.*/</span>
	<span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Cancel previous pending timer.
del<em>timer</em>sync(&amp;pTS->RxPktPendingTimer);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxTimeoutIndicateSeq</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Indicate packets</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&gt;</span><span class="n">REORDER_WIN_SIZE</span><span class="p">){</span>
			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;RxReorderIndicatePacket(): Rx Reorer buffer full!! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ieee80211_indicate_packets</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">prxbIndicateArray</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">bPktInBuf</span> <span class="o">&amp;&amp;</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxTimeoutIndicateSeq</span><span class="o">==</span><span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Set new pending timer.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span><span class="s">&quot;%s(): SET rx timeout timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxTimeoutIndicateSeq</span> <span class="o">=</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxIndicateSeq</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPktPendingTimer</span><span class="p">))</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPktPendingTimer</span><span class="p">);</span>
		<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPktPendingTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">RxReorderPendingTime</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxPktPendingTimer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">parse_subframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
                  <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ieee80211_rxb</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span><span class="n">u8</span><span class="o">*</span> <span class="n">src</span><span class="p">,</span><span class="n">u8</span><span class="o">*</span> <span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span>  <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span> <span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>

	<span class="n">u16</span>		<span class="n">LLCOffset</span><span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">ChkLength</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">bIsAggregateFrame</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">nSubframe_Length</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">nPadding_Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">SeqNum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sub_skb</span><span class="p">;</span>
	<span class="n">u8</span>             <span class="o">*</span><span class="n">data_ptr</span><span class="p">;</span>
	<span class="cm">/* just for debug purpose */</span>
	<span class="n">SeqNum</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">));</span>

	<span class="k">if</span><span class="p">((</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span><span class="o">&amp;&amp;</span>\
			<span class="p">(((</span><span class="n">frameqos</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_3ADDR_LEN</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">reserved</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bIsAggregateFrame</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">IEEE80211_QOS_HAS_SEQ</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">LLCOffset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">bContainHTC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LLCOffset</span> <span class="o">+=</span> <span class="n">sHTCLng</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>printk("ChkLength = %d\n", LLCOffset);
Null packet, don't indicate it to upper layer</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ChkLength</span> <span class="o">=</span> <span class="n">LLCOffset</span><span class="p">;</span><span class="cm">/* + (Frame_WEP(frame)!=0 ?Adapter-&gt;MgntInfo.SecurityInfo.EncryptionHeadOverhead:0);*/</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">ChkLength</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">LLCOffset</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bIsAggregateFrame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef JOHN_NOCPY</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>IEEE80211<em>DEBUG</em>DATA(IEEE80211<em>DL</em>RX,skb->data,skb->len);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ETHERNET_HEADER_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Offset 12 denote 2 mac address */</span>
			<span class="n">nSubframe_Length</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">12</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>==m==>change the length order</p></td><td class="code"><div class="highlight"><pre>			<span class="n">nSubframe_Length</span> <span class="o">=</span> <span class="p">(</span><span class="n">nSubframe_Length</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">nSubframe_Length</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ETHERNET_HEADER_SIZE</span> <span class="o">+</span> <span class="n">nSubframe_Length</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: A-MSDU parse error!! pRfd-&gt;nTotalSubframe : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
						<span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: A-MSDU parse error!! Subframe Length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">nSubframe_Length</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nRemain_Length is %d and nSubframe_Length is : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="n">nSubframe_Length</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;The Packet SeqNum is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">SeqNum</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* move the data point to data content */</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETHERNET_HEADER_SIZE</span><span class="p">);</span>

<span class="cp">#ifdef JOHN_NOCPY</span>
			<span class="n">sub_skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">nSubframe_Length</span><span class="p">;</span>
			<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">nSubframe_Length</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="cm">/* Allocate new skb for releasing to upper layer */</span>
			<span class="n">sub_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">nSubframe_Length</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
			<span class="n">data_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">nSubframe_Length</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data_ptr</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">nSubframe_Length</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_skb</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span> <span class="o">&gt;=</span> <span class="n">MAX_SUBFRAME_COUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IEEE80211_DEBUG_RX</span><span class="p">(</span><span class="s">&quot;ParseSubframe(): Too many Subframes! Packets dropped!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">nSubframe_Length</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nPadding_Length</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">((</span><span class="n">nSubframe_Length</span> <span class="o">+</span> <span class="n">ETHERNET_HEADER_SIZE</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">nPadding_Length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nPadding_Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">nPadding_Length</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">nPadding_Length</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef JOHN_NOCPY</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>{just for debug added by david
printk("AMSDU::rxb->nr<em>subframes = %d\n",rxb->nr</em>subframes);
}</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* All received frames are sent to this function. @skb contains the frame in</span>
<span class="cm"> * IEEE 802.11 format, i.e., in the format it was sent over air.</span>
<span class="cm"> * This function is called only as a tasklet (software IRQ). */</span>
<span class="kt">int</span> <span class="nf">ieee80211_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>struct ieee80211<em>hdr</em>3addrqos *hdr;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">size_t</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ethertype</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>added by amy for reorder</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span>	<span class="n">TID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">SeqNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PRX_TS_RECORD</span> <span class="n">pTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>bool bIsAggregateFrame = false;
added by amy for reorder</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef NOT_YET</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">wds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">wds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frame_authorized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from_assoc_ap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>u16 qos_ctl = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span> <span class="n">dst</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">src</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rxb</span><span class="o">*</span> <span class="n">rxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>cheat the the hdr type</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: SKB length &lt; 10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">stype</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>

	<span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">HTCCheck</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;find HTCControl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">bContainHTC</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>IEEE80211<em>DEBUG</em>DATA(IEEE80211<em>DL</em>DATA, skb->data, skb->len);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef NOT_YET</span>
<span class="cp">#if WIRELESS_EXT &gt; 15</span>
	<span class="cm">/* Put this code here so that we avoid duplicating it in all</span>
<span class="cm">	 * Rx paths. - Jean II */</span>
<span class="cp">#ifdef IW_WIRELESS_SPY		</span><span class="cm">/* defined in iw_handler.h */</span><span class="cp"></span>
	<span class="cm">/* If spy monitoring on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">wstats</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* No qual value */</span>
		<span class="cm">/* Update spy records */</span>
		<span class="n">wireless_spy_update</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wstats</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IW_WIRELESS_SPY */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* WIRELESS_EXT &gt; 15 */</span><span class="cp"></span>
	<span class="n">hostap_update_rx_stats</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if WIRELESS_EXT &gt; 15</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_monitor_rx</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="cp">#ifdef NOT_YET</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Use station specific key to override default keys if the</span>
<span class="cm">		 * receiver address is a unicast address (&quot;individual RA&quot;). If</span>
<span class="cm">		 * bcrx_sta_key parameter is set, station specific key is used</span>
<span class="cm">		 * even with broad/multicast targets (this is against IEEE</span>
<span class="cm">		 * 802.11, but makes it easier to use different keys with</span>
<span class="cm">		 * stations that do not support WEP key mapping). */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bcrx_sta_key</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">hostap_handle_sta_crypto</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypt</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">sta</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* allow NULL decrypt to indicate an station specific override</span>
<span class="cm">		 * for default encryption */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			      <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This seems to be triggered by some (multicast?)</span>
<span class="cm">			 * frames from other than current BSS, so just drop the</span>
<span class="cm">			 * frames silently instead of filling system log with</span>
<span class="cm">			 * these reports. */</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span><span class="s">&quot;Decryption failed (not set)&quot;</span>
					     <span class="s">&quot; (SA=%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">.</span><span class="n">rx_discards_undecryptable</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_DATA_HDR3_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>if QoS enabled, should check the sequence for each of the AC</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurRxReorderEnable</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="o">||</span> <span class="o">!</span><span class="n">IsDataFrame</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">||</span> <span class="n">IsLegacyDataFrame</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_duplicate_packet</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">PRX_TS_RECORD</span> <span class="n">pRxTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>IEEE80211<em>DEBUG(IEEE80211</em>DL_REORDER,"%s(): QOS ENABLE AND RECEIVE QOS DATA , we will get Ts, tid:%d\n",<strong>FUNCTION</strong>, tid);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">GetTs</span><span class="p">(</span>
				<span class="n">ieee</span><span class="p">,</span>
				<span class="p">(</span><span class="n">PTS_COMMON_INFO</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pRxTS</span><span class="p">,</span>
				<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">Frame_QoSTID</span><span class="p">((</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)),</span>
				<span class="n">RX_DIR</span><span class="p">,</span>
				<span class="nb">true</span><span class="p">))</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>IEEE80211<em>DEBUG(IEEE80211</em>DL<em>REORDER,"%s(): pRxTS->RxLastFragNum is %d,frag is %d,pRxTS->RxLastSeqNum is %d,seq is %d\n",<strong>FUNCTION</strong>,pRxTS->RxLastFragNum,frag,pRxTS->RxLastSeqNum,WLAN</em>GET<em>SEQ</em>SEQ(sc));</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span> 	<span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">))</span>  <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="n">pRxTS</span><span class="o">-&gt;</span><span class="n">RxLastFragNum</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">pRxTS</span><span class="o">-&gt;</span><span class="n">RxLastSeqNum</span><span class="p">)</span>	<span class="p">)</span>
			<span class="p">{</span>
				<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">pRxTS</span><span class="o">-&gt;</span><span class="n">RxLastFragNum</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
				<span class="n">pRxTS</span><span class="o">-&gt;</span><span class="n">RxLastSeqNum</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;%s(): No TS!! Skip the check!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>IEEE80211<em>DEBUG</em>DATA(IEEE80211<em>DL</em>DATA, skb->data, skb->len);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_rx_frame_mgmt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data frame - extract src/dst addresses */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_DATA_HDR4_LEN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef NOT_YET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_rx_frame_wds</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wds</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">wds</span><span class="p">;</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="n">hostap_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wds</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stadev</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_ap_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Frame from BSSID of the AP for which we are a client */</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stadev</span><span class="p">;</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="n">hostap_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">from_assoc_ap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

<span class="cp">#ifdef NOT_YET</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">||</span>
	     <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_REPEAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">from_assoc_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hostap_handle_sta_rx</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span>
					     <span class="n">wds</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AP_RX_CONTINUE_NOT_AUTHORIZED</span>:
			<span class="n">frame_authorized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RX_CONTINUE</span>:
			<span class="n">frame_authorized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RX_DROP</span>:
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RX_EXIT</span>:
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>IEEE80211<em>DEBUG</em>DATA(IEEE80211<em>DL</em>DATA, skb->data, skb->len);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Nullfunc frames may have PS-bit set, so they must be passed to</span>
<span class="cm">	 * hostap_handle_sta_rx() before being dropped here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFACK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFPOLL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFACKPOLL</span><span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_QOS_DATA</span><span class="c1">//add by David,2006.8.4</span>
	    <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">)</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
				<span class="s">&quot;RX: dropped data frame &quot;</span>
				<span class="s">&quot;with no data (type=0x%02x, &quot;</span>
				<span class="s">&quot;subtype=0x%02x, len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
                <span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>

	<span class="cm">/* skb: hdr + (possibly fragmented, possibly encrypted) payload */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">keyidx</span> <span class="o">=</span> <span class="n">ieee80211_rx_frame_decrypt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">crypt</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;decrypt frame error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* skb: hdr + (possibly fragmented) plaintext payload */</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>PR: FIXME: hostap has additional conditions in the "if" below:
ieee->host<em>decrypt &amp;&amp; (fc &amp; IEEE80211</em>FCTL_WEP) &amp;&amp;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flen</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag_skb</span> <span class="o">=</span> <span class="n">ieee80211_frag_cache_get</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">IEEE80211_DEBUG_FRAG</span><span class="p">(</span><span class="s">&quot;Rx Fragment received (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_RX</span> <span class="o">|</span> <span class="n">IEEE80211_DL_FRAG</span><span class="p">,</span>
					<span class="s">&quot;Rx cannot get skb from fragment &quot;</span>
					<span class="s">&quot;cache (morefrag=%d seq=%u frag=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="n">frag</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">flen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">flen</span> <span class="o">-=</span> <span class="n">hdrlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">flen</span> <span class="o">&gt;</span> <span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: host decrypted and &quot;</span>
			       <span class="s">&quot;reassembled frame did not fit skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ieee80211_frag_cache_invalidate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy first fragment (including full headers) into</span>
<span class="cm">			 * beginning of the fragment cache skb */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">frag_skb</span><span class="p">,</span> <span class="n">flen</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">flen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* append frame payload to the end of the fragment</span>
<span class="cm">			 * cache skb */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">frag_skb</span><span class="p">,</span> <span class="n">flen</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">,</span>
			       <span class="n">flen</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* more fragments expected - leave the skb in fragment</span>
<span class="cm">			 * cache for now; it will be delivered to upper layers</span>
<span class="cm">			 * after all fragments have been received */</span>
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* this was the last fragment and the frame will be</span>
<span class="cm">		 * delivered, so remove skb from fragment cache */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">frag_skb</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ieee80211_frag_cache_invalidate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* skb: hdr + (possible reassembled) full MSDU payload; possibly still</span>
<span class="cm">	 * encrypted/authenticated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_rx_frame_decrypt_msdu</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">crypt</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;==&gt;decrypt msdu error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>added by amy for AP roaming</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span><span class="o">++</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="cm">/*ieee-&gt;ieee802_1x &amp;&amp;*/</span>
		    <span class="n">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">))</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
			<span class="cm">/* pass unencrypted EAPOL frames even if encryption is</span>
<span class="cm">			 * configured */</span>
			<span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="n">eap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="mi">24</span><span class="p">);</span>
			<span class="n">IEEE80211_DEBUG_EAP</span><span class="p">(</span><span class="s">&quot;RX: IEEE 802.1X EAPOL frame: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">eap_get_type</span><span class="p">(</span><span class="n">eap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
				<span class="s">&quot;encryption configured, but RX &quot;</span>
				<span class="s">&quot;frame not encrypted (SA=%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="n">eap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="mi">24</span><span class="p">);</span>
			<span class="n">IEEE80211_DEBUG_EAP</span><span class="p">(</span><span class="s">&quot;RX: IEEE 802.1X EAPOL frame: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">eap_get_type</span><span class="p">(</span><span class="n">eap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_is_eapol_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_DROP</span><span class="p">(</span>
			<span class="s">&quot;dropped unencrypted RX data &quot;</span>
			<span class="s">&quot;frame from %pM&quot;</span>
			<span class="s">&quot; (drop_unencrypted=1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">	if(ieee80211_is_eapol_frame(ieee, skb, hdrlen)) {</span>
<span class="cm">		printk(KERN_WARNING &quot;RX: IEEE802.1X EPAOL frame!\n&quot;);</span>
<span class="cm">	}</span>
<span class="cm">*/</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>added by amy for reorder</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="n">IsQoSDataFrame</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">TID</span> <span class="o">=</span> <span class="n">Frame_QoSTID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">SeqNum</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">GetTs</span><span class="p">(</span><span class="n">ieee</span><span class="p">,(</span><span class="n">PTS_COMMON_INFO</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pTS</span><span class="p">,</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span><span class="n">TID</span><span class="p">,</span><span class="n">RX_DIR</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">TID</span> <span class="o">!=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">TID</span> <span class="o">!=</span><span class="mi">3</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bis_any_nonbepkts</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>added by amy for reorder</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* skb: hdr + (possible reassembled) full plaintext payload */</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>ethertype = (payload[6] &lt;&lt; 8) | payload[7];</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rxb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rxb</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rxb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span><span class="s">&quot;%s(): kmalloc rxb error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* to parse amsdu packets */</span>
	<span class="cm">/* qos data packets &amp; reserved bit is 1 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">parse_subframe</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">rx_stats</span><span class="p">,</span><span class="n">rxb</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only to free rxb, and not submit the packets to upper layer */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>added by amy for reorder</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurRxReorderEnable</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">||</span><span class="n">pTS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>added by amy for reorder</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">nr_subframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sub_skb</span> <span class="o">=</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">subframes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sub_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* convert hdr + possible LLC headers into Ethernet header */</span>
				<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
						<span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rfc1042_header</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
						  <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_AARP</span> <span class="o">&amp;&amp;</span> <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_IPX</span><span class="p">)</span> <span class="o">||</span>
						 <span class="n">memcmp</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bridge_tunnel_header</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* remove RFC1042 or Bridge-Tunnel encapsulation and</span>
<span class="cm">					 * replace EtherType */</span>
					<span class="n">skb_pull</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">SNAP_SIZE</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
					<span class="cm">/* Leave Ethernet header part of hdr and full payload */</span>
					<span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Indicat the packets to upper layer */</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>printk("0skb_len(%d)\n", skb->len);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
				<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
				<span class="n">sub_skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span> <span class="cm">/* 802.11 crc not sufficient */</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>skb->ip<em>summed = CHECKSUM</em>UNNECESSARY; /* 802.11 crc not sufficient */</p></td><td class="code"><div class="highlight"><pre>				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rx_ps_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>printk("1skb_len(%d)\n", skb->len);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">netif_rx</span><span class="p">(</span><span class="n">sub_skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_REORDER</span><span class="p">,</span><span class="s">&quot;%s(): REORDER ENABLE AND PTS not NULL, and we will enter RxReorderIndicatePacket()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="n">RxReorderIndicatePacket</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">rxb</span><span class="p">,</span> <span class="n">pTS</span><span class="p">,</span> <span class="n">SeqNum</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifndef JOHN_NOCPY</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>

 <span class="nl">rx_exit:</span>
<span class="cp">#ifdef NOT_YET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">hostap_handle_sta_release</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">rx_dropped:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="n">rxb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Returning 0 indicates to caller that we have not handled the SKB--</span>
<span class="cm">	 * so it is still allocated and can be used again by underlying</span>
<span class="cm">	 * hardware as a DMA target */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MGMT_FRAME_FIXED_PART_LENGTH            0x24</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">qos_oui</span><span class="p">[</span><span class="n">QOS_OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xF2</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">* Make the structure we read from the beacon packet to have</span>
<span class="cm">* the right values</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_verify_qos_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_information_element</span>
                                     <span class="o">*</span><span class="n">info_element</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sub_type</span><span class="p">)</span>
<span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">qui_subtype</span> <span class="o">!=</span> <span class="n">sub_type</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">qui</span><span class="p">,</span> <span class="n">qos_oui</span><span class="p">,</span> <span class="n">QOS_OUI_LEN</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">qui_type</span> <span class="o">!=</span> <span class="n">QOS_OUI_TYPE</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">QOS_VERSION_1</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Parse a QoS parameter element</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_read_qos_param_element</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_parameter_info</span>
                                            <span class="o">*</span><span class="n">element_param</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_info_element</span>
                                            <span class="o">*</span><span class="n">info_element</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_parameter_info</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">info_element</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">element_param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">QOS_ELEMENT_ID</span> <span class="o">&amp;&amp;</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">element_param</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">qui</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
                       <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
                <span class="n">element_param</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">elementID</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
                <span class="n">element_param</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_verify_qos_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">element_param</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">,</span>
                                                <span class="n">QOS_OUI_PARAM_SUB_TYPE</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse a QoS information element</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_read_qos_info_element</span><span class="p">(</span><span class="k">struct</span>
                                           <span class="n">ieee80211_qos_information_element</span>
                                           <span class="o">*</span><span class="n">element_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_info_element</span>
                                           <span class="o">*</span><span class="n">info_element</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_information_element</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">element_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info_element</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">QOS_ELEMENT_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">element_info</span><span class="o">-&gt;</span><span class="n">qui</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
                       <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
                <span class="n">element_info</span><span class="o">-&gt;</span><span class="n">elementID</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
                <span class="n">element_info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_verify_qos_info</span><span class="p">(</span><span class="n">element_info</span><span class="p">,</span>
                                                <span class="n">QOS_OUI_INFO_SUB_TYPE</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Write QoS parameters from the ac parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_qos_convert_ac_to_parameters</span><span class="p">(</span><span class="k">struct</span>
                                                  <span class="n">ieee80211_qos_parameter_info</span>
                                                  <span class="o">*</span><span class="n">param_elm</span><span class="p">,</span> <span class="k">struct</span>
                                                  <span class="n">ieee80211_qos_parameters</span>
                                                  <span class="o">*</span><span class="n">qos_param</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ieee80211_qos_ac_parameter</span> <span class="o">*</span><span class="n">ac_params</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">aci</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>u8 cw<em>min;
u8 cw</em>max;</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ac_params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param_elm</span><span class="o">-&gt;</span><span class="n">ac_params_record</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">aci</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac_params</span><span class="o">-&gt;</span><span class="n">aci_aifsn</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">aci</span> <span class="o">&gt;=</span> <span class="n">QOS_QUEUE_NUM</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
                <span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac_params</span><span class="o">-&gt;</span><span class="n">aci_aifsn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

		<span class="cm">/* WMM spec P.11: The minimum value for AIFSN shall be 2 */</span>
                <span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span><span class="o">:</span><span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">[</span><span class="n">aci</span><span class="p">];</span>

                <span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac_params</span><span class="o">-&gt;</span><span class="n">ecw_min_max</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

                <span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ac_params</span><span class="o">-&gt;</span><span class="n">ecw_min_max</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

                <span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">=</span>
                    <span class="p">(</span><span class="n">ac_params</span><span class="o">-&gt;</span><span class="n">aci_aifsn</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
                <span class="n">qos_param</span><span class="o">-&gt;</span><span class="n">tx_op_limit</span><span class="p">[</span><span class="n">aci</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ac_params</span><span class="o">-&gt;</span><span class="n">tx_op_limit</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * we have a generic data element which it may contain QoS information or</span>
<span class="cm"> * parameters element. check the information element length to decide</span>
<span class="cm"> * which type to read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee80211_parse_qos_info_param_IE</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span>
                                             <span class="o">*</span><span class="n">info_element</span><span class="p">,</span>
                                             <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ieee80211_qos_parameters</span> <span class="o">*</span><span class="n">qos_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ieee80211_qos_information_element</span> <span class="n">qos_info_element</span><span class="p">;</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">ieee80211_read_qos_info_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos_info_element</span><span class="p">,</span> <span class="n">info_element</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span> <span class="o">=</span> <span class="n">qos_info_element</span><span class="p">.</span><span class="n">ac_info</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
                <span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_QOS_INFORMATION</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">ieee80211_qos_parameter_info</span> <span class="n">param_element</span><span class="p">;</span>

                <span class="n">rc</span> <span class="o">=</span> <span class="n">ieee80211_read_qos_param_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_element</span><span class="p">,</span>
                                                      <span class="n">info_element</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">qos_param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">);</span>
                        <span class="n">ieee80211_qos_convert_ac_to_parameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_element</span><span class="p">,</span>
                                                               <span class="n">qos_param</span><span class="p">);</span>
                        <span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">;</span>
                        <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span> <span class="o">=</span>
                            <span class="n">param_element</span><span class="p">.</span><span class="n">info_element</span><span class="p">.</span><span class="n">ac_info</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">IEEE80211_DEBUG_QOS</span><span class="p">(</span><span class="s">&quot;QoS is supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
<span class="cp">#define MFIE_STRING(x) case MFIE_TYPE_ ##x: return #x</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_info_element_string</span><span class="p">(</span><span class="n">u16</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">SSID</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">RATES</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">FH_SET</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">DS_SET</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">CF_SET</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">TIM</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">IBSS_SET</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">COUNTRY</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">HOP_PARAMS</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">HOP_TABLE</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">REQUEST</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">CHALLENGE</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">POWER_CONSTRAINT</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">POWER_CAPABILITY</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">TPC_REQUEST</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">TPC_REPORT</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">SUPP_CHANNELS</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">CSA</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">MEASURE_REQUEST</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">MEASURE_REPORT</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">QUIET</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">IBSS_DFS</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>MFIE<em>STRING(ERP</em>INFO);</p></td><td class="code"><div class="highlight"><pre>                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">RSN</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">RATES_EX</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">GENERIC</span><span class="p">);</span>
                <span class="n">MFIE_STRING</span><span class="p">(</span><span class="n">QOS_PARAMETER</span><span class="p">);</span>
        <span class="nl">default:</span>
                <span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_extract_country_ie</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="n">info_element</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="n">addr2</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">Dot11d_UpdateCountryIe</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">addr2</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>070305, rcnjko: I update country IE watch dog here because
some AP (e.g. Cisco 1242) don't include country IE in their
probe response frame.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">IS_EQUAL_CIE_SRC</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">addr2</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">UPDATE_CIE_WATCHDOG</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ieee80211_parse_info_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="n">info_element</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">length</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">offset</span><span class="p">;</span>
        <span class="n">u16</span>	<span class="n">tmp_htcap_len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">tmp_htinfo_len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ht_realtek_agg_len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">ht_realtek_agg_buf</span><span class="p">[</span><span class="n">MAX_IE_LEN</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>u16 broadcom_len = 0;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
	<span class="kt">char</span> <span class="n">rates_str</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info_element</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info_element</span><span class="p">)</span> <span class="o">+</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Info elem: parse failed: &quot;</span>
					     <span class="s">&quot;info_element-&gt;len + 2 &gt; left : &quot;</span>
					     <span class="s">&quot;info_element-&gt;len+2=%zd left=%d, id=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info_element</span><span class="p">),</span>
					     <span class="n">length</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="cm">/* We stop processing but don&#39;t return an error here</span>
<span class="cm">			 * because some misbehaviour APs break this rule. ie.</span>
<span class="cm">			 * Orinoco AP1000. */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MFIE_TYPE_SSID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_empty_essid</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&lt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">+</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">-</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_SSID: &#39;%s&#39; len=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_RATES</span>:
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">rates_str</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						 <span class="n">MAX_RATES_LENGTH</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates_str</span><span class="p">)</span> <span class="o">-</span>
					      <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">rates_str</span><span class="p">),</span> <span class="s">&quot;%02X &quot;</span><span class="p">,</span>
					      <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ofdm_rate</span>
				    <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_OFDM</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					    <span class="n">IEEE80211_BASIC_RATE_MASK</span><span class="p">)</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
						    <span class="o">~</span><span class="n">NETWORK_HAS_CCK</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_RATES: &#39;%s&#39; (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">rates_str</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_RATES_EX</span>:
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">rates_str</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						    <span class="n">MAX_RATES_EX_LENGTH</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates_str</span><span class="p">)</span> <span class="o">-</span>
					      <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">rates_str</span><span class="p">),</span> <span class="s">&quot;%02X &quot;</span><span class="p">,</span>
					      <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ofdm_rate</span>
				    <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_OFDM</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					    <span class="n">IEEE80211_BASIC_RATE_MASK</span><span class="p">)</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
						    <span class="o">~</span><span class="n">NETWORK_HAS_CCK</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_RATES_EX: &#39;%s&#39; (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">rates_str</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_DS_SET</span>:
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_DS_SET: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_FH_SET</span>:
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_FH_SET: ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_CF_SET</span>:
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_CF_SET: ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_TIM</span>:
			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">network</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">.</span><span class="n">tim_count</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">.</span><span class="n">tim_period</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

                        <span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
                                <span class="k">break</span><span class="p">;</span>

                        <span class="n">network</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="n">network</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

                        <span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">=</span> <span class="n">IEEE80211_DTIM_VALID</span><span class="p">;</span>

                        <span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="k">break</span><span class="p">;</span>

                        <span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">|=</span> <span class="n">IEEE80211_DTIM_MBCAST</span><span class="p">;</span>

                        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>printk("offset1:%x aid:%x\n",offset, ieee->assoc_id);</p></td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="o">*</span><span class="n">offset</span> <span class="o">||</span>
                                <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>

                                <span class="k">break</span><span class="p">;</span>

                        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span><span class="c1">// + ((aid % 8)? 0 : 1) ;</span>

                        <span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="o">%</span><span class="mi">8</span><span class="p">)))</span>
                                <span class="n">network</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">|=</span> <span class="n">IEEE80211_DTIM_UCAST</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>IEEE80211<em>DEBUG</em>MGMT("MFIE<em>TYPE</em>TIM: partially ignored\n");</p></td><td class="code"><div class="highlight"><pre>			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_ERP</span>:
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">erp_value</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_ERP_VALUE</span><span class="p">;</span>
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_ERP_SET: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">network</span><span class="o">-&gt;</span><span class="n">erp_value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFIE_TYPE_IBSS_SET</span>:
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_IBSS_SET: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">network</span><span class="o">-&gt;</span><span class="n">atim_window</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_CHALLENGE</span>:
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_CHALLENGE: ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_GENERIC</span>:
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_GENERIC: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_parse_qos_info_param_IE</span><span class="p">(</span><span class="n">info_element</span><span class="p">,</span>
							       <span class="n">network</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span>
			    <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
							  <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">info_element</span><span class="p">,</span>
				       <span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

<span class="cp">#ifdef THOMAS_TURBO</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
                            <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
                            <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xe0</span> <span class="o">&amp;&amp;</span>
                            <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4c</span> <span class="o">&amp;&amp;</span>
                            <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span>
                            <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">network</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>for HTcap and HTinfo parameters</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">tmp_htcap_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
				   <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				   <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x90</span> <span class="o">&amp;&amp;</span>
				   <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4c</span> <span class="o">&amp;&amp;</span>
				   <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x033</span><span class="p">){</span>

						<span class="n">tmp_htcap_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,(</span><span class="n">u8</span><span class="p">)</span><span class="n">MAX_IE_LEN</span><span class="p">);</span>
				   		<span class="k">if</span><span class="p">(</span><span class="n">tmp_htcap_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
				   			<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTSpecVer</span> <span class="o">=</span> <span class="n">HT_SPEC_VER_EWC</span><span class="p">;</span>
							<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span> <span class="o">=</span> <span class="n">tmp_htcap_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">)</span><span class="o">?</span>\
								<span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">)</span><span class="o">:</span><span class="n">tmp_htcap_len</span><span class="p">;</span>
							<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">,</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span><span class="p">);</span>
				   		<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">tmp_htcap_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>


			<span class="k">if</span><span class="p">(</span><span class="n">tmp_htinfo_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
					<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				   	<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x90</span> <span class="o">&amp;&amp;</span>
				   	<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4c</span> <span class="o">&amp;&amp;</span>
				   	<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x034</span><span class="p">){</span>

						<span class="n">tmp_htinfo_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,(</span><span class="n">u8</span><span class="p">)</span><span class="n">MAX_IE_LEN</span><span class="p">);</span>
						<span class="k">if</span><span class="p">(</span><span class="n">tmp_htinfo_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
							<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTSpecVer</span> <span class="o">=</span> <span class="n">HT_SPEC_VER_EWC</span><span class="p">;</span>
							<span class="k">if</span><span class="p">(</span><span class="n">tmp_htinfo_len</span><span class="p">){</span>
								<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span> <span class="o">=</span> <span class="n">tmp_htinfo_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">)</span><span class="o">?</span>\
									<span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">)</span><span class="o">:</span><span class="n">tmp_htinfo_len</span><span class="p">;</span>
								<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">,</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span><span class="p">);</span>
							<span class="p">}</span>

						<span class="p">}</span>

				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">aggregation</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span><span class="p">){</span>
					<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
						<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
						<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xe0</span> <span class="o">&amp;&amp;</span>
						<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4c</span> <span class="o">&amp;&amp;</span>
						<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">){</span>

						<span class="n">ht_realtek_agg_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,(</span><span class="n">u8</span><span class="p">)</span><span class="n">MAX_IE_LEN</span><span class="p">);</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="n">ht_realtek_agg_buf</span><span class="p">,</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

					<span class="p">}</span>
					<span class="k">if</span><span class="p">(</span><span class="n">ht_realtek_agg_len</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">){</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTAggregation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

						<span class="k">if</span><span class="p">((</span><span class="n">ht_realtek_agg_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ht_realtek_agg_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTLongSlotTime</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

			<span class="p">}</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>if(tmp<em>htcap</em>len !=0  ||  tmp<em>htinfo</em>len != 0)</p></td><td class="code"><div class="highlight"><pre>			<span class="p">{</span>
				<span class="k">if</span><span class="p">((</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x05</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xb5</span><span class="p">)</span> <span class="o">||</span>
					 <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0a</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf7</span><span class="p">)</span> <span class="o">||</span>
					 <span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span>
					 <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)){</span>

						<span class="n">network</span><span class="o">-&gt;</span><span class="n">broadcom_cap_exist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0c</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x43</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">ralink_cap_exist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">ralink_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>added by amy for atheros AP</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">((</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x13</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x74</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;========&gt;%s(): athros AP is exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">atheros_cap_exist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">atheros_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x96</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">cisco_cap_exist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">cisco_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>added by amy for LEAP of cisco</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x96</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">CcxRmState</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">CcxRmState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">bCcxRmEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">bCcxRmEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>CCXv4 Table 59-1 MBSSID Masks.</p></td><td class="code"><div class="highlight"><pre>					<span class="n">network</span><span class="o">-&gt;</span><span class="n">MBssidMask</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">CcxRmState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
					<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">MBssidMask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">bMBssidValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">MBssidMask</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">MBssidMask</span><span class="p">);</span>
						<span class="n">cpMacAddr</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">MBssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">MBssid</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">MBssidMask</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">network</span><span class="o">-&gt;</span><span class="n">bMBssidValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bCcxRmEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4</span>  <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x96</span> <span class="o">&amp;&amp;</span>
				<span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bWithCcxVerNum</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">BssCcxVerNumber</span> <span class="o">=</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bWithCcxVerNum</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">BssCcxVerNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_RSN</span>:
			<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_RSN: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
						  <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="n">info_element</span><span class="p">,</span>
			       <span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>HT related element.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">MFIE_TYPE_HT_CAP</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_HT_CAP: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">tmp_htcap_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,(</span><span class="n">u8</span><span class="p">)</span><span class="n">MAX_IE_LEN</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tmp_htcap_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTSpecVer</span> <span class="o">=</span> <span class="n">HT_SPEC_VER_EWC</span><span class="p">;</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span> <span class="o">=</span> <span class="n">tmp_htcap_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">)</span><span class="o">?</span>\
					<span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">)</span><span class="o">:</span><span class="n">tmp_htcap_len</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">,</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>If peer is HT, but not WMM, call QosSetLegacyWMMParamWithHT()
windows driver will update WMM parameters each beacon received once connected
Linux driver is a bit different.</p></td><td class="code"><div class="highlight"><pre>				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>


		<span class="k">case</span> <span class="n">MFIE_TYPE_HT_INFO</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_HT_INFO: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">tmp_htinfo_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,(</span><span class="n">u8</span><span class="p">)</span><span class="n">MAX_IE_LEN</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tmp_htinfo_len</span><span class="p">){</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTSpecVer</span> <span class="o">=</span> <span class="n">HT_SPEC_VER_IEEE</span><span class="p">;</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span> <span class="o">=</span> <span class="n">tmp_htinfo_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">)</span><span class="o">?</span>\
					<span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">)</span><span class="o">:</span><span class="n">tmp_htinfo_len</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">,</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_AIRONET</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_AIRONET: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span><span class="n">IE_CISCO_FLAG_POSITION</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bWithAironetIE</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>CCX 1 spec v1.13, A01.1 CKIP Negotiation (page23):
"A Cisco access point advertises support for CKIP in beacon and probe response packets,
 by adding an Aironet element and setting one or both of the CKIP negotiation bits."</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span>	<span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">IE_CISCO_FLAG_POSITION</span><span class="p">]</span><span class="o">&amp;</span><span class="n">SUPPORT_CKIP_MIC</span><span class="p">)</span>	<span class="o">||</span>
					<span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">IE_CISCO_FLAG_POSITION</span><span class="p">]</span><span class="o">&amp;</span><span class="n">SUPPORT_CKIP_PK</span><span class="p">)</span>	<span class="p">)</span>
				<span class="p">{</span>
		 			<span class="n">network</span><span class="o">-&gt;</span><span class="n">bCkipSupported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">network</span><span class="o">-&gt;</span><span class="n">bCkipSupported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">bWithAironetIE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		 		<span class="n">network</span><span class="o">-&gt;</span><span class="n">bCkipSupported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MFIE_TYPE_QOS_PARAMETER</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;QoS Error need to parse QOS_PARAMETER IE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MFIE_TYPE_COUNTRY</span>:
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;MFIE_TYPE_COUNTRY: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>printk("=====>Receive &lt;%s> Country IE\n",network->ssid);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee80211_extract_country_ie</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">info_element</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span><span class="c1">//addr2 is same as addr3 when from an AP</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/* TODO */</span>
		<span class="nl">default:</span>
			<span class="n">IEEE80211_DEBUG_MGMT</span>
			    <span class="p">(</span><span class="s">&quot;Unsupported info element: %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">get_info_element_string</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span>
			     <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">length</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info_element</span><span class="p">)</span> <span class="o">+</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">info_element</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info_element</span><span class="o">-&gt;</span>
		    <span class="n">data</span><span class="p">[</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">atheros_cap_exist</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">broadcom_cap_exist</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">cisco_cap_exist</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ralink_cap_exist</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTAggregation</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">unknown_cap_exist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">unknown_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">ieee80211_SignalStrengthTranslate</span><span class="p">(</span>
	<span class="n">u8</span>  <span class="n">CurrSS</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">RetSS</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>Step 1. Scale mapping.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">71</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">+</span> <span class="p">((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">41</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">78</span> <span class="o">+</span> <span class="p">((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">66</span> <span class="o">+</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">21</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">54</span> <span class="o">+</span> <span class="p">(</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">CurrSS</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="p">(((</span><span class="n">CurrSS</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CurrSS</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">RetSS</span> <span class="o">=</span> <span class="n">CurrSS</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>RT<em>TRACE(COMP</em>DBG, DBG_LOUD, ("##### After Mapping:  LastSS: %d, CurrSS: %d, RetSS: %d\n", LastSS, CurrSS, RetSS));</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Step 2. Smoothing.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>RT<em>TRACE(COMP</em>DBG, DBG_LOUD, ("$$$$$ After Smoothing:  LastSS: %d, CurrSS: %d, RetSS: %d\n", LastSS, CurrSS, RetSS));</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">RetSS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">ieee80211_translate_todbm</span><span class="p">(</span><span class="n">u8</span> <span class="n">signal_strength_index</span>	<span class="p">)</span><span class="c1">// 0-100 index.</span>
<span class="p">{</span>
	<span class="kt">long</span>	<span class="n">signal_power</span><span class="p">;</span> <span class="c1">// in dBm.</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Translate to dBm (x=0.5y-95).</p></td><td class="code"><div class="highlight"><pre>	<span class="n">signal_power</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)((</span><span class="n">signal_strength_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">signal_power</span> <span class="o">-=</span> <span class="mi">95</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">signal_power</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ieee80211_network_init</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>char rates_str[64];
char *p;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>

        <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Pull out fixed field data */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="cm">/* Where to pull this? beacon-&gt;listen_interval;*/</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">last_associate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">erp_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span> <span class="o">?</span>
            <span class="mh">0x3</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">berp_info_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">network</span><span class="o">-&gt;</span><span class="n">broadcom_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">ralink_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">atheros_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">cisco_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">unknown_cap_exist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#ifdef THOMAS_TURBO</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_IE_LEN</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Initialize HT parameters
ieee80211<em>ht</em>initialize(&amp;network->bssht);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">HTInitializeBssDesc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">==</span> <span class="n">IEEE80211_52GHZ_BAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for A band (No DS info) */</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">received_channel</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_HAS_CCK</span><span class="p">;</span>

 	<span class="n">network</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 	<span class="n">network</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_parse_info_param</span>
            <span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">beacon</span><span class="p">),</span> <span class="n">network</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">==</span> <span class="n">IEEE80211_52GHZ_BAND</span><span class="p">)</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_A</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_OFDM</span><span class="p">)</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">IEEE_G</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_CCK</span><span class="p">)</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">IEEE_B</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Filtered out &#39;%s (%pM)&#39; &quot;</span>
				     <span class="s">&quot;network.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						  <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				     <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_A</span><span class="p">)</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_N_5G</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE_G</span> <span class="o">|</span> <span class="n">IEEE_B</span><span class="p">))</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_N_24G</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_empty_essid</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">+</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>stats->signal = ieee80211_SignalStrengthTranslate(stats->signal);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ieee80211_translate_todbm</span><span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="mi">100</span><span class="o">-</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">))</span> <span class="o">-</span><span class="mi">25</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_same_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* A network is only a duplicate if the channel, BSSID, ESSID</span>
<span class="cm">	 * and the capability field (in particular IBSS and BSS) all match.</span>
<span class="cm">	 * We treat all &lt;hidden&gt; with the same BSSID and channel</span>
<span class="cm">	 * as one network */</span>
	<span class="k">return</span> <span class="c1">//((src-&gt;ssid_len == dst-&gt;ssid_len) &amp;&amp;</span>
		<span class="p">(((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>!memcmp(src->ssid, dst->ssid, src->ssid_len) &amp;&amp;</p></td><td class="code"><div class="highlight"><pre>		<span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">)</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_network</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">qos_active</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">old_param</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_stats</span><span class="p">));</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_ERP_VALUE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">erp_value</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">erp_value</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">berp_info_valid</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">berp_info_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">atim_window</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">dtim_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">dtim_data</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">last_dtim_sta_time</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">tim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tim_parameters</span><span class="p">));</span>

        <span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTAggregation</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTAggregation</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span><span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">,</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">,</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span><span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">,</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">,</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTSpecVer</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTSpecVer</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTLongSlotTime</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTLongSlotTime</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">broadcom_cap_exist</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">broadcom_cap_exist</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ralink_cap_exist</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ralink_cap_exist</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">atheros_cap_exist</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">atheros_cap_exist</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">cisco_cap_exist</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">cisco_cap_exist</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">unknown_cap_exist</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">unknown_cap_exist</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">;</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/* qos related parameters */</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>qos<em>active = src->qos</em>data.active;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">qos_active</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>old<em>param = dst->qos</em>data.old<em>param</em>count;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">old_param</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_MASK</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_data</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">QoS_Enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span>
			<span class="n">IEEE80211_DEBUG_QOS</span>
				<span class="p">(</span><span class="s">&quot;QoS the network %s is QoS supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">IEEE80211_DEBUG_QOS</span>
				<span class="p">(</span><span class="s">&quot;QoS the network is QoS supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">qos_active</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span> <span class="n">old_param</span><span class="p">;</span>

	<span class="cm">/* dst-&gt;last_associate is not overwritten */</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">wmm_info</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_info</span><span class="p">;</span> <span class="c1">//sure to exist in beacon or probe response frame.</span>
	<span class="k">if</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="o">||</span> \
	   <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="o">||</span> \
	   <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="o">||</span> \
	   <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ac_aci_acm_aifsn</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">wmm_param</span><span class="p">,</span> <span class="n">WME_AC_PRAM_LEN</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>dst->QoS<em>Enable = src->QoS</em>Enable;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef THOMAS_TURBO</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">CountryIeBuf</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">CountryIeLen</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>added by amy for LEAP</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bWithAironetIE</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bWithAironetIE</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bCkipSupported</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bCkipSupported</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">CcxRmState</span><span class="p">,</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">CcxRmState</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bCcxRmEnable</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bCcxRmEnable</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">MBssidMask</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">MBssidMask</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bMBssidValid</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bMBssidValid</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">MBssid</span><span class="p">,</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">MBssid</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">bWithCcxVerNum</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">bWithCcxVerNum</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">BssCcxVerNumber</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">BssCcxVerNumber</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_beacon</span><span class="p">(</span><span class="n">__le16</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ieee80211_process_probe_response</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="n">network</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">oldest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
	<span class="k">struct</span> <span class="n">ieee80211_info_element</span> <span class="o">*</span><span class="n">info_element</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">renew</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>u8 wmm_info;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">));</span>
	<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span>
		<span class="s">&quot;&#39;%s&#39; (%pM): %c%c%c%c %c%c%c%c-%c%c%c%c %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">escape_essid</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
		<span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xf</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xe</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xd</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xc</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xb</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0xa</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x9</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x8</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x7</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x6</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x5</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x4</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x3</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x2</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x1</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mh">0x0</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_network_init</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Dropped &#39;%s&#39; (%pM) via %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">info_element</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						  <span class="n">info_element</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
				     <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span>
				     <span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">?</span>
				     <span class="s">&quot;PROBE RESPONSE&quot;</span> <span class="o">:</span> <span class="s">&quot;BEACON&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>For Asus EeePc request,
(1) if wireless adapter receive get any 802.11d country code in AP beacon,
   wireless adapter should follow the country code.
(2)  If there is no any country code in beacon,
      then wireless adapter should do active scan from ch1~11 and
      passive scan from ch12~14</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsLegalChannel</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>Case 1: Country code</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsLegalChannel</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Country code, filter probe response at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Case 2: No any country code.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">else</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>Filter over channel ch12~14</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Global Domain, filter probe response at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>Case 1: Country code</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">IsLegalChannel</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Country code, filter beacon at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>Case 2: No any country code.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">else</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>Filter over channel ch12~14</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GetScanInfo(): For Global Domain, filter beacon at channel(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The network parsed correctly -- so now we scan our known networks</span>
<span class="cm">	 * to see if we can find it in our list.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE:  This search is definitely not optimized.  Once its doing</span>
<span class="cm">	 *        the &quot;right thing&quot; we&#39;ll optimize it for efficiency if</span>
<span class="cm">	 *        necessary */</span>

	<span class="cm">/* Search for this entry in the list and update it if it is</span>
<span class="cm">	 * already there. */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">is_same_network</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="n">ieee</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">update_network</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_N_24G</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_G</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">berp_info_valid</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">erp_value</span><span class="o">&amp;</span> <span class="n">ERP_UseProtection</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">buseprotection</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">buseprotection</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">is_beacon</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="c1">//hidden AP</span>
			<span class="n">network</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">network</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_same_network</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="n">ieee</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">oldest</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">&lt;</span> <span class="n">oldest</span><span class="o">-&gt;</span><span class="n">last_scanned</span><span class="p">))</span>
			<span class="n">oldest</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we didn&#39;t find a match, then get a new network slot to initialize</span>
<span class="cm">	 * with this beacon&#39;s information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If there are no more slots, expire the oldest */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oldest</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">oldest</span><span class="p">;</span>
			<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Expired &#39;%s&#39; (%pM) from &quot;</span>
					     <span class="s">&quot;network list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">escape_essid</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
							  <span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
					     <span class="n">target</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Otherwise just pull from the free list */</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>


<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Adding &#39;%s&#39; (%pM) via %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
						  <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">),</span>
				     <span class="n">network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span>
				     <span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">?</span>
				     <span class="s">&quot;PROBE RESPONSE&quot;</span> <span class="o">:</span> <span class="s">&quot;BEACON&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="p">));</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span>
			<span class="n">ieee80211_softmac_new_net</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="o">&amp;</span><span class="n">network</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Updating &#39;%s&#39; (%pM) via %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">escape_essid</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
						  <span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">),</span>
				     <span class="n">target</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span>
				     <span class="n">IEEE80211_STYPE_PROBE_RESP</span> <span class="o">?</span>
				     <span class="s">&quot;PROBE RESPONSE&quot;</span> <span class="o">:</span> <span class="s">&quot;BEACON&quot;</span><span class="p">);</span>

		<span class="cm">/* we have an entry and we are going to update it. But this entry may</span>
<span class="cm">		 * be already expired. In this case we do the same as we found a new</span>
<span class="cm">		 * net and call the new_net handler</span>
<span class="cm">		 */</span>
		<span class="n">renew</span> <span class="o">=</span> <span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>YJ,add,080819,for hidden ap</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">is_beacon</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">network</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">network</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">NETWORK_EMPTY_ESSID</span> <span class="o">&amp;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>if(strncmp(network.ssid, "linksys-c",9) == 0)
printk("====>2 network.ssid=%s FLAG=%d target.ssid=%s FLAG=%d\n", network.ssid, network.flags, target->ssid, target->flags);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(((</span><span class="n">network</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">)</span> <span class="o">==</span> <span class="n">NETWORK_EMPTY_ESSID</span><span class="p">)</span> \
		    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">)))</span>\
		    <span class="o">||</span><span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_NOLINK</span><span class="p">))))</span>
			<span class="n">renew</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>YJ,add,080819,for hidden ap,end</p></td><td class="code"><div class="highlight"><pre>		<span class="n">update_network</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">renew</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">))</span>
			<span class="n">ieee80211_softmac_new_net</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span><span class="o">&amp;</span><span class="n">network</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_beacon</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">is_same_network</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">network</span><span class="p">,</span> <span class="n">ieee</span><span class="p">)</span><span class="o">&amp;&amp;</span>\
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">handle_beacon</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">handle_beacon</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">beacon</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ieee80211_rx_mgt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_hdr_4addr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">))</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_BEACON</span>:
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;received BEACON (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Beacon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee80211_process_probe_response</span><span class="p">(</span>
			<span class="n">ieee</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span>:
		<span class="n">IEEE80211_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;received PROBE RESPONSE (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>
		<span class="n">IEEE80211_DEBUG_SCAN</span><span class="p">(</span><span class="s">&quot;Probe response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee80211_process_probe_response</span><span class="p">(</span>
			<span class="n">ieee</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_probe_response</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_rx_mgt</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ieee80211_rx</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
