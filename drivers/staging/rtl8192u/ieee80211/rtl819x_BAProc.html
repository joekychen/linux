<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8192u › ieee80211 › rtl819x_BAProc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rtl819x_BAProc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/********************************************************************************************************************************</span>
<span class="cm"> * This file is created to process BA Action Frame. According to 802.11 spec, there are 3 BA action types at all. And as BA is</span>
<span class="cm"> * related to TS, this part need some struture defined in QOS side code. Also TX RX is going to be resturctured, so how to send</span>
<span class="cm"> * ADDBAREQ ADDBARSP and DELBA packet is still on consideration. Temporarily use MANAGE QUEUE instead of Normal Queue.</span>
<span class="cm"> * WB 2008-05-27</span>
<span class="cm"> * *****************************************************************************************************************************/</span>
<span class="cp">#include &quot;ieee80211.h&quot;</span>
<span class="cp">#include &quot;rtl819x_BA.h&quot;</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function:  Activate BA entry. And if Time is nozero, start timer.</span>
<span class="cm"> *   input:  PBA_RECORD 		pBA  //BA entry to be enabled</span>
<span class="cm"> *   	     u16 			Time //indicate time delay.</span>
<span class="cm"> *  output:  none</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">void</span> <span class="nf">ActivateBAEntry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">PBA_RECORD</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">u16</span> <span class="n">Time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">bValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">Time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pBA</span><span class="o">-&gt;</span><span class="n">Timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">Time</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function:  deactivate BA entry, including its timer.</span>
<span class="cm"> *   input:  PBA_RECORD 		pBA  //BA entry to be disabled</span>
<span class="cm"> *  output:  none</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">void</span> <span class="nf">DeActivateBAEntry</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">PBA_RECORD</span> <span class="n">pBA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">bValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pBA</span><span class="o">-&gt;</span><span class="n">Timer</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: deactivete BA entry in Tx Ts, and send DELBA.</span>
<span class="cm"> *   input:</span>
<span class="cm"> *   	     PTX_TS_RECORD		pTxTs //Tx Ts which is to deactivate BA entry.</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  notice:  As PTX_TS_RECORD structure will be defined in QOS, so wait to be merged. //FIXME</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="n">u8</span> <span class="nf">TxTsDeleteBA</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">PTX_TS_RECORD</span>	<span class="n">pTxTs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PBA_RECORD</span>		<span class="n">pAdmittedBa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxAdmittedBARecord</span><span class="p">;</span>  <span class="c1">//These two BA entries must exist in TS structure</span>
	<span class="n">PBA_RECORD</span>		<span class="n">pPendingBa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxPendingBARecord</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">bSendDELBA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Delete pending BA</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">pPendingBa</span><span class="o">-&gt;</span><span class="n">bValid</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pPendingBa</span><span class="p">);</span>
		<span class="n">bSendDELBA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Delete admitted BA</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">pAdmittedBa</span><span class="o">-&gt;</span><span class="n">bValid</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pAdmittedBa</span><span class="p">);</span>
		<span class="n">bSendDELBA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bSendDELBA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: deactivete BA entry in Tx Ts, and send DELBA.</span>
<span class="cm"> *   input:</span>
<span class="cm"> *   	     PRX_TS_RECORD		pRxTs //Rx Ts which is to deactivate BA entry.</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  notice:  As PRX_TS_RECORD structure will be defined in QOS, so wait to be merged. //FIXME, same with above</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="n">u8</span> <span class="nf">RxTsDeleteBA</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">PRX_TS_RECORD</span>	<span class="n">pRxTs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PBA_RECORD</span>		<span class="n">pBa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pRxTs</span><span class="o">-&gt;</span><span class="n">RxAdmittedBARecord</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">bSendDELBA</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pBa</span><span class="o">-&gt;</span><span class="n">bValid</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pBa</span><span class="p">);</span>
		<span class="n">bSendDELBA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bSendDELBA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: reset BA entry</span>
<span class="cm"> *   input:</span>
<span class="cm"> *   	     PBA_RECORD		pBA //entry to be reset</span>
<span class="cm"> *  output:  none</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">void</span> <span class="nf">ResetBaEntry</span><span class="p">(</span> <span class="n">PBA_RECORD</span> <span class="n">pBA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">bValid</span>			<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">shortData</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaTimeoutValue</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">DialogToken</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaStartSeqCtrl</span><span class="p">.</span><span class="n">ShortData</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>These functions need porting here or not?</p></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************************************************************</span>
<span class="cm"> *function:  construct ADDBAREQ and ADDBARSP frame here together.</span>
<span class="cm"> *   input:  u8* 		Dst 	//ADDBA frame&#39;s destination</span>
<span class="cm"> *   	     PBA_RECORD 	pBA	//BA_RECORD entry which stores the necessary information for BA.</span>
<span class="cm"> *   	     u16 		StatusCode  //status code in RSP and I will use it to indicate whether it&#39;s RSP or REQ(will I?)</span>
<span class="cm"> *   	     u8			type	//indicate whether it&#39;s RSP(ACT_ADDBARSP) ow REQ(ACT_ADDBAREQ)</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  return:  sk_buff* 		skb     //return constructed skb to xmit</span>
<span class="cm">*******************************************************************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="nf">ieee80211_ADDBA</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">Dst</span><span class="p">,</span> <span class="n">PBA_RECORD</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">u16</span> <span class="n">StatusCode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	 <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span> <span class="n">BAReq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">tag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>category(1) + action field(1) + Dialog Token(1) + BA Parameter Set(2) +  BA Timeout Value(2) +  BA Start SeqCtrl(2)(or StatusCode(2))</p></td><td class="code"><div class="highlight"><pre>	<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_TRACE</span> <span class="o">|</span> <span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="s">&quot;========&gt;%s(), frame(%d) sentd to:%pM, ieee-&gt;dev:%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">Dst</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pBA</span> <span class="o">==</span> <span class="nb">NULL</span><span class="o">||</span><span class="n">ieee</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;pBA(%p) is NULL or ieee(%p) is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span> <span class="c1">//need to add something others? FIXME</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc skb for ADDBA_REQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span>  	<span class="c1">//I wonder whether it&#39;s necessary. Apparently kernel will not do it when alloc a skb.</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">BAReq</span> <span class="o">=</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">BAReq</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">Dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">BAReq</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">BAReq</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">BAReq</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_MANAGE_ACT</span><span class="p">);</span> <span class="c1">//action frame</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>tag += sizeof( struct ieee80211<em>hdr</em>3addr); //move to action field</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">++=</span> <span class="n">ACT_CAT_BA</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">++=</span> <span class="n">type</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Dialog Token</p></td><td class="code"><div class="highlight"><pre>	<span class="o">*</span><span class="n">tag</span> <span class="o">++=</span> <span class="n">pBA</span><span class="o">-&gt;</span><span class="n">DialogToken</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACT_ADDBARSP</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Status Code</p></td><td class="code"><div class="highlight"><pre>		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;=====&gt;to send ADDBARSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">StatusCode</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>BA Parameter Set</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">shortData</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>BA Timeout Value</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaTimeoutValue</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACT_ADDBAREQ</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>BA Start SeqCtrl</p></td><td class="code"><div class="highlight"><pre>		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaStartSeqCtrl</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IEEE80211_DEBUG_DATA</span><span class="p">(</span><span class="n">IEEE80211_DL_DATA</span><span class="o">|</span><span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>return NULL;</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function:  construct DELBA frame</span>
<span class="cm"> *   input:  u8* 		dst 	//DELBA frame&#39;s destination</span>
<span class="cm"> *   	     PBA_RECORD 	pBA	//BA_RECORD entry which stores the necessary information for BA</span>
<span class="cm"> *   	     TR_SELECT	        TxRxSelect  //TX RX direction</span>
<span class="cm"> *   	     u16 		ReasonCode  //status code.</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  return:  sk_buff* 		skb     //return constructed skb to xmit</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="nf">ieee80211_DELBA</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span>
	<span class="n">u8</span><span class="o">*</span>		         <span class="n">dst</span><span class="p">,</span>
	<span class="n">PBA_RECORD</span>		 <span class="n">pBA</span><span class="p">,</span>
	<span class="n">TR_SELECT</span>		 <span class="n">TxRxSelect</span><span class="p">,</span>
	<span class="n">u16</span>			 <span class="n">ReasonCode</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="n">DELBA_PARAM_SET</span>	<span class="n">DelbaParamSet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	 <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span> <span class="n">Delba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">tag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>len = head len + DELBA Parameter Set(2) + Reason Code(2)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
	<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_TRACE</span> <span class="o">|</span> <span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="s">&quot;========&gt;%s(), ReasonCode(%d) sentd to:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">ReasonCode</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DelbaParamSet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">DelbaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">Initiator</span>	<span class="o">=</span> <span class="p">(</span><span class="n">TxRxSelect</span><span class="o">==</span><span class="n">TX_DIR</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">DelbaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">TID</span>	<span class="o">=</span> <span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">TID</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span> <span class="c1">//need to add something others? FIXME</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc skb for ADDBA_REQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>memset(skb->data, 0, len+sizeof( struct ieee80211<em>hdr</em>3addr));</p></td><td class="code"><div class="highlight"><pre>	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">Delba</span> <span class="o">=</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">Delba</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">Delba</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">Delba</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">Delba</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_MANAGE_ACT</span><span class="p">);</span> <span class="c1">//action frame</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="o">*</span><span class="n">tag</span> <span class="o">++=</span> <span class="n">ACT_CAT_BA</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">++=</span> <span class="n">ACT_DELBA</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>DELBA Parameter Set</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">DelbaParamSet</span><span class="p">.</span><span class="n">shortData</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Reason Code</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ReasonCode</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">IEEE80211_DEBUG_DATA</span><span class="p">(</span><span class="n">IEEE80211_DL_DATA</span><span class="o">|</span><span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
	<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_TRACE</span> <span class="o">|</span> <span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="s">&quot;&lt;=====%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: send ADDBAReq frame out</span>
<span class="cm"> *   input:  u8* 		dst 	//ADDBAReq frame&#39;s destination</span>
<span class="cm"> *   	     PBA_RECORD 	pBA	//BA_RECORD entry which stores the necessary information for BA</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  notice: If any possible, please hide pBA in ieee. And temporarily use Manage Queue as softmac_mgmt_xmit() usually does</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">void</span> <span class="nf">ieee80211_send_ADDBAReq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span>	<span class="n">dst</span><span class="p">,</span> <span class="n">PBA_RECORD</span>	<span class="n">pBA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_ADDBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">pBA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ACT_ADDBAREQ</span><span class="p">);</span> <span class="c1">//construct ACT_ADDBAREQ frames so set statuscode zero.</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>add statistic needed here.
and skb will be freed in softmac<em>mgmt</em>xmit(), so omit all dev<em>kfree</em>skb<em>any() outside softmac</em>mgmt_xmit()
WB</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;alloc skb error in function %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: send ADDBARSP frame out</span>
<span class="cm"> *   input:  u8* 		dst 	//DELBA frame&#39;s destination</span>
<span class="cm"> *   	     PBA_RECORD 	pBA	//BA_RECORD entry which stores the necessary information for BA</span>
<span class="cm"> *   	     u16		StatusCode //RSP StatusCode</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  notice: If any possible, please hide pBA in ieee. And temporarily use Manage Queue as softmac_mgmt_xmit() usually does</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">void</span> <span class="nf">ieee80211_send_ADDBARsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="n">PBA_RECORD</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">u16</span> <span class="n">StatusCode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_ADDBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">StatusCode</span><span class="p">,</span> <span class="n">ACT_ADDBARSP</span><span class="p">);</span> <span class="c1">//construct ACT_ADDBARSP frames</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>same above</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;alloc skb error in function %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: send ADDBARSP frame out</span>
<span class="cm"> *   input:  u8* 		dst 	//DELBA frame&#39;s destination</span>
<span class="cm"> *   	     PBA_RECORD 	pBA	//BA_RECORD entry which stores the necessary information for BA</span>
<span class="cm"> *   	     TR_SELECT          TxRxSelect //TX or RX</span>
<span class="cm"> *   	     u16		ReasonCode //DEL ReasonCode</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  notice: If any possible, please hide pBA in ieee. And temporarily use Manage Queue as softmac_mgmt_xmit() usually does</span>
<span class="cm">********************************************************************************************************************/</span>

<span class="kt">void</span> <span class="nf">ieee80211_send_DELBA</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="n">PBA_RECORD</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">TR_SELECT</span> <span class="n">TxRxSelect</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ReasonCode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_DELBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">TxRxSelect</span><span class="p">,</span> <span class="n">ReasonCode</span><span class="p">);</span> <span class="c1">//construct ACT_ADDBARSP frames</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>same above</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;alloc skb error in function %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: RX ADDBAReq</span>
<span class="cm"> *   input:  struct sk_buff *   skb	//incoming ADDBAReq skb.</span>
<span class="cm"> *  return:  0(pass), other(fail)</span>
<span class="cm"> *  notice:  As this function need support of QOS, I comment some code out. And when qos is ready, this code need to be support.</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ieee80211_rx_ADDBAReq</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span> <span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pDialogToken</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PBA_RECORD</span> <span class="n">pBA</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PBA_PARAM_SET</span>	<span class="n">pBaParamSet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span><span class="o">*</span> <span class="n">pBaTimeoutVal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PSEQUENCE_CONTROL</span> <span class="n">pBaStartSeqCtrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PRX_TS_RECORD</span>	<span class="n">pTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot; Invalid skb len in BAREQ(%d / %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> 	<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IEEE80211_DEBUG_DATA</span><span class="p">(</span><span class="n">IEEE80211_DL_DATA</span><span class="o">|</span><span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">);</span>
	<span class="n">pDialogToken</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>  <span class="c1">//category+action</span>
	<span class="n">pBaParamSet</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBA_PARAM_SET</span><span class="p">)(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>   <span class="c1">//+DialogToken</span>
	<span class="n">pBaTimeoutVal</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">pBaStartSeqCtrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSEQUENCE_CONTROL</span><span class="p">)(</span><span class="n">req</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;====================&gt;rx ADDBAREQ from :%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>some other capability is not ready now.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span>	<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">==</span> <span class="nb">false</span><span class="p">))</span> <span class="c1">//||</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>(ieee->pStaQos->bEnableRxImmBA == false)    )</p></td><td class="code"><div class="highlight"><pre>	<span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ADDBA_STATUS_REFUSED</span><span class="p">;</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to reply on ADDBA_REQ as some capability is not ready(%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">OnADDBAReq_Fail</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Search for related traffic stream.
If there is no matched TS, reject the ADDBA request.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span>	<span class="o">!</span><span class="n">GetTs</span><span class="p">(</span>
			<span class="n">ieee</span><span class="p">,</span>
			<span class="p">(</span><span class="n">PTS_COMMON_INFO</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTS</span><span class="p">),</span>
			<span class="n">dst</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pBaParamSet</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">TID</span><span class="p">),</span>
			<span class="n">RX_DIR</span><span class="p">,</span>
			<span class="nb">true</span><span class="p">)</span>	<span class="p">)</span>
	<span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ADDBA_STATUS_REFUSED</span><span class="p">;</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t get TS in %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">OnADDBAReq_Fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pBA</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">RxAdmittedBARecord</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>To Determine the ADDBA Req content
We can do much more check here, including BufferSize, AMSDU_Support, Policy, StartSeqCtrl...
I want to check StartSeqCtrl to make sure when we start aggregation!!!</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">pBaParamSet</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">BAPolicy</span> <span class="o">==</span> <span class="n">BA_POLICY_DELAYED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ADDBA_STATUS_INVALID_PARAM</span><span class="p">;</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;BA Policy is not correct in %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">OnADDBAReq_Fail</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Admit the ADDBA Request</p></td><td class="code"><div class="highlight"><pre>	<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pBA</span><span class="p">);</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">DialogToken</span> <span class="o">=</span> <span class="o">*</span><span class="n">pDialogToken</span><span class="p">;</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaParamSet</span><span class="p">;</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaTimeoutValue</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaTimeoutVal</span><span class="p">;</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaStartSeqCtrl</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaStartSeqCtrl</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>for half N mode we only aggregate 1 frame</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">GetHalfNmodeSupportByAPsHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">BufferSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">BufferSize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaTimeoutValue</span><span class="p">);</span>
	<span class="n">ieee80211_send_ADDBARsp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">ADDBA_STATUS_SUCCESS</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>End of procedure.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">OnADDBAReq_Fail:</span>
	<span class="p">{</span>
		<span class="n">BA_RECORD</span>	<span class="n">BA</span><span class="p">;</span>
		<span class="n">BA</span><span class="p">.</span><span class="n">BaParamSet</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaParamSet</span><span class="p">;</span>
		<span class="n">BA</span><span class="p">.</span><span class="n">BaTimeoutValue</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaTimeoutVal</span><span class="p">;</span>
		<span class="n">BA</span><span class="p">.</span><span class="n">DialogToken</span> <span class="o">=</span> <span class="o">*</span><span class="n">pDialogToken</span><span class="p">;</span>
		<span class="n">BA</span><span class="p">.</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">BAPolicy</span> <span class="o">=</span> <span class="n">BA_POLICY_IMMEDIATE</span><span class="p">;</span>
		<span class="n">ieee80211_send_ADDBARsp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BA</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//we send RSP out.</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: RX ADDBARSP</span>
<span class="cm"> *   input:  struct sk_buff *   skb	//incoming ADDBAReq skb.</span>
<span class="cm"> *  return:  0(pass), other(fail)</span>
<span class="cm"> *  notice:  As this function need support of QOS, I comment some code out. And when qos is ready, this code need to be support.</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ieee80211_rx_ADDBARsp</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span> <span class="n">rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PBA_RECORD</span>		<span class="n">pPendingBA</span><span class="p">,</span> <span class="n">pAdmittedBA</span><span class="p">;</span>
	<span class="n">PTX_TS_RECORD</span>		<span class="n">pTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pDialogToken</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span><span class="o">*</span> <span class="n">pStatusCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pBaTimeoutVal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PBA_PARAM_SET</span>		<span class="n">pBaParamSet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">ReasonCode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot; Invalid skb len in BARSP(%d / %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> 	<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">rsp</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">);</span>
	<span class="n">pDialogToken</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pStatusCode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pBaParamSet</span> <span class="o">=</span> <span class="p">(</span><span class="n">PBA_PARAM_SET</span><span class="p">)(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">pBaTimeoutVal</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Check the capability
Since we can always receive A-MPDU, we just check if it is under HT mode.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span>     <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">||</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">||</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentAMPDUEnable</span> <span class="o">==</span> <span class="nb">false</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;reject to ADDBA_RSP as some capability is not ready(%d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentAMPDUEnable</span><span class="p">);</span>
		<span class="n">ReasonCode</span> <span class="o">=</span> <span class="n">DELBA_REASON_UNKNOWN_BA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">OnADDBARsp_Reject</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Search for related TS.
If there is no TS found, we wil reject ADDBA Rsp by sending DELBA frame.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetTs</span><span class="p">(</span>
			<span class="n">ieee</span><span class="p">,</span>
			<span class="p">(</span><span class="n">PTS_COMMON_INFO</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTS</span><span class="p">),</span>
			<span class="n">dst</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pBaParamSet</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">TID</span><span class="p">),</span>
			<span class="n">TX_DIR</span><span class="p">,</span>
			<span class="nb">false</span><span class="p">)</span>	<span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t get TS in %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="n">ReasonCode</span> <span class="o">=</span> <span class="n">DELBA_REASON_UNKNOWN_BA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">OnADDBARsp_Reject</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">bAddBaReqInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pPendingBA</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TxPendingBARecord</span><span class="p">;</span>
	<span class="n">pAdmittedBA</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TxAdmittedBARecord</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Check if related BA is waiting for setup.
If not, reject by sending DELBA frame.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">pAdmittedBA</span><span class="o">-&gt;</span><span class="n">bValid</span><span class="o">==</span><span class="nb">true</span><span class="p">))</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Since BA is already setup, we ignore all other ADDBA Response.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="s">&quot;OnADDBARsp(): Recv ADDBA Rsp. Drop because already admit it! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">pPendingBA</span><span class="o">-&gt;</span><span class="n">bValid</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">||</span><span class="p">(</span><span class="o">*</span><span class="n">pDialogToken</span> <span class="o">!=</span> <span class="n">pPendingBA</span><span class="o">-&gt;</span><span class="n">DialogToken</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span>  <span class="s">&quot;OnADDBARsp(): Recv ADDBA Rsp. BA invalid, DELBA! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ReasonCode</span> <span class="o">=</span> <span class="n">DELBA_REASON_UNKNOWN_BA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">OnADDBARsp_Reject</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="s">&quot;OnADDBARsp(): Recv ADDBA Rsp. BA is admitted! Status code:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pStatusCode</span><span class="p">);</span>
		<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pPendingBA</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">pStatusCode</span> <span class="o">==</span> <span class="n">ADDBA_STATUS_SUCCESS</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Determine ADDBA Rsp content here.
We can compare the value of BA parameter set that Peer returned and Self sent.
If it is OK, then admitted. Or we can send DELBA to cancel BA mechanism.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">pBaParamSet</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">BAPolicy</span> <span class="o">==</span> <span class="n">BA_POLICY_DELAYED</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Since this is a kind of ADDBA failed, we delay next ADDBA process.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">bAddBaReqDelayed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pAdmittedBA</span><span class="p">);</span>
			<span class="n">ReasonCode</span> <span class="o">=</span> <span class="n">DELBA_REASON_END_BA</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">OnADDBARsp_Reject</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Admitted condition</p></td><td class="code"><div class="highlight"><pre>		<span class="n">pAdmittedBA</span><span class="o">-&gt;</span><span class="n">DialogToken</span> <span class="o">=</span> <span class="o">*</span><span class="n">pDialogToken</span><span class="p">;</span>
		<span class="n">pAdmittedBA</span><span class="o">-&gt;</span><span class="n">BaTimeoutValue</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaTimeoutVal</span><span class="p">;</span>
		<span class="n">pAdmittedBA</span><span class="o">-&gt;</span><span class="n">BaStartSeqCtrl</span> <span class="o">=</span> <span class="n">pPendingBA</span><span class="o">-&gt;</span><span class="n">BaStartSeqCtrl</span><span class="p">;</span>
		<span class="n">pAdmittedBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaParamSet</span><span class="p">;</span>
		<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pAdmittedBA</span><span class="p">);</span>
		<span class="n">ActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pAdmittedBA</span><span class="p">,</span> <span class="o">*</span><span class="n">pBaTimeoutVal</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Delay next ADDBA process.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">bAddBaReqDelayed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>End of procedure</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">OnADDBARsp_Reject:</span>
	<span class="p">{</span>
		<span class="n">BA_RECORD</span>	<span class="n">BA</span><span class="p">;</span>
		<span class="n">BA</span><span class="p">.</span><span class="n">BaParamSet</span> <span class="o">=</span> <span class="o">*</span><span class="n">pBaParamSet</span><span class="p">;</span>
		<span class="n">ieee80211_send_DELBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BA</span><span class="p">,</span> <span class="n">TX_DIR</span><span class="p">,</span> <span class="n">ReasonCode</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function: RX DELBA</span>
<span class="cm"> *   input:  struct sk_buff *   skb	//incoming ADDBAReq skb.</span>
<span class="cm"> *  return:  0(pass), other(fail)</span>
<span class="cm"> *  notice:  As this function need support of QOS, I comment some code out. And when qos is ready, this code need to be support.</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ieee80211_rx_DELBA</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span> <span class="n">delba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">PDELBA_PARAM_SET</span>	<span class="n">pDelBaParamSet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span><span class="o">*</span>			<span class="n">pReasonCode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span>			<span class="n">dst</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot; Invalid skb len in DELBA(%d / %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> 	<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">==</span> <span class="nb">false</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span> <span class="s">&quot;received DELBA while QOS or HT is not supported(%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IEEE80211_DEBUG_DATA</span><span class="p">(</span><span class="n">IEEE80211_DL_DATA</span><span class="o">|</span><span class="n">IEEE80211_DL_BA</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">delba</span> <span class="o">=</span> <span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">delba</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">delba</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">);</span>
	<span class="n">pDelBaParamSet</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDELBA_PARAM_SET</span><span class="p">)(</span><span class="n">delba</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">pReasonCode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">delba</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pDelBaParamSet</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">Initiator</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">PRX_TS_RECORD</span> 	<span class="n">pRxTs</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">GetTs</span><span class="p">(</span>
				<span class="n">ieee</span><span class="p">,</span>
				<span class="p">(</span><span class="n">PTS_COMMON_INFO</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pRxTs</span><span class="p">,</span>
				<span class="n">dst</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pDelBaParamSet</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">TID</span><span class="p">,</span>
				<span class="n">RX_DIR</span><span class="p">,</span>
				<span class="nb">false</span><span class="p">)</span>	<span class="p">)</span>
		<span class="p">{</span>
			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span>  <span class="s">&quot;can&#39;t get TS for RXTS in %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">RxTsDeleteBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pRxTs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">PTX_TS_RECORD</span>	<span class="n">pTxTs</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">GetTs</span><span class="p">(</span>
			<span class="n">ieee</span><span class="p">,</span>
			<span class="p">(</span><span class="n">PTS_COMMON_INFO</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pTxTs</span><span class="p">,</span>
			<span class="n">dst</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pDelBaParamSet</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">.</span><span class="n">TID</span><span class="p">,</span>
			<span class="n">TX_DIR</span><span class="p">,</span>
			<span class="nb">false</span><span class="p">)</span>	<span class="p">)</span>
		<span class="p">{</span>
			<span class="n">IEEE80211_DEBUG</span><span class="p">(</span><span class="n">IEEE80211_DL_ERR</span><span class="p">,</span>  <span class="s">&quot;can&#39;t get TS for TXTS in %s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bUsingBa</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bAddBaReqInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bAddBaReqDelayed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TsAddBaTimer</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>PlatformCancelTimer(Adapter, &amp;pTxTs->TsAddBaTimer);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">TxTsDeleteBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pTxTs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>ADDBA initiate. This can only be called by TX side.</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span>
<span class="nf">TsInitAddBA</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span>
	<span class="n">PTX_TS_RECORD</span>	<span class="n">pTS</span><span class="p">,</span>
	<span class="n">u8</span>		<span class="n">Policy</span><span class="p">,</span>
	<span class="n">u8</span>		<span class="n">bOverwritePending</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="n">PBA_RECORD</span>			<span class="n">pBA</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TxPendingBARecord</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pBA</span><span class="o">-&gt;</span><span class="n">bValid</span><span class="o">==</span><span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">bOverwritePending</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Set parameters to "Pending" variable set</p></td><td class="code"><div class="highlight"><pre>	<span class="n">DeActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pBA</span><span class="p">);</span>

	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">DialogToken</span><span class="o">++</span><span class="p">;</span>						<span class="c1">// DialogToken: Only keep the latest dialog token</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">AMSDU_Support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// Do not support A-MSDU with A-MPDU now!!</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">BAPolicy</span> <span class="o">=</span> <span class="n">Policy</span><span class="p">;</span>	<span class="c1">// Policy: Delayed or Immediate</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">TID</span> <span class="o">=</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TsCommonInfo</span><span class="p">.</span><span class="n">TSpec</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">TSInfo</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">ucTSID</span><span class="p">;</span>	<span class="c1">// TID</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>BufferSize: This need to be set according to A-MPDU vector</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaParamSet</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">BufferSize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>		<span class="c1">// BufferSize: This need to be set according to A-MPDU vector</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaTimeoutValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>					<span class="c1">// Timeout value: Set 0 to disable Timer</span>
	<span class="n">pBA</span><span class="o">-&gt;</span><span class="n">BaStartSeqCtrl</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">SeqNum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TxCurSeq</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4096</span><span class="p">;</span> 	<span class="c1">// Block Ack will start after 3 packets later.</span>

	<span class="n">ActivateBAEntry</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pBA</span><span class="p">,</span> <span class="n">BA_SETUP_TIMEOUT</span><span class="p">);</span>

	<span class="n">ieee80211_send_ADDBAReq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TsCommonInfo</span><span class="p">.</span><span class="n">Addr</span><span class="p">,</span> <span class="n">pBA</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">TsInitDelBA</span><span class="p">(</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">PTS_COMMON_INFO</span> <span class="n">pTsCommonInfo</span><span class="p">,</span> <span class="n">TR_SELECT</span> <span class="n">TxRxSelect</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span><span class="p">(</span><span class="n">TxRxSelect</span> <span class="o">==</span> <span class="n">TX_DIR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">PTX_TS_RECORD</span>	<span class="n">pTxTs</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_TS_RECORD</span><span class="p">)</span><span class="n">pTsCommonInfo</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">TxTsDeleteBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pTxTs</span><span class="p">))</span>
			<span class="n">ieee80211_send_DELBA</span><span class="p">(</span>
				<span class="n">ieee</span><span class="p">,</span>
				<span class="n">pTsCommonInfo</span><span class="o">-&gt;</span><span class="n">Addr</span><span class="p">,</span>
				<span class="p">(</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxAdmittedBARecord</span><span class="p">.</span><span class="n">bValid</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxAdmittedBARecord</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxPendingBARecord</span><span class="p">),</span>
				<span class="n">TxRxSelect</span><span class="p">,</span>
				<span class="n">DELBA_REASON_END_BA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">TxRxSelect</span> <span class="o">==</span> <span class="n">RX_DIR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">PRX_TS_RECORD</span>	<span class="n">pRxTs</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRX_TS_RECORD</span><span class="p">)</span><span class="n">pTsCommonInfo</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">RxTsDeleteBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pRxTs</span><span class="p">))</span>
			<span class="n">ieee80211_send_DELBA</span><span class="p">(</span>
				<span class="n">ieee</span><span class="p">,</span>
				<span class="n">pTsCommonInfo</span><span class="o">-&gt;</span><span class="n">Addr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pRxTs</span><span class="o">-&gt;</span><span class="n">RxAdmittedBARecord</span><span class="p">,</span>
				<span class="n">TxRxSelect</span><span class="p">,</span>
				<span class="n">DELBA_REASON_END_BA</span>	<span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/********************************************************************************************************************</span>
<span class="cm"> *function:  BA setup timer</span>
<span class="cm"> *   input:  unsigned long	 data		//acturally we send TX_TS_RECORD or RX_TS_RECORD to these timer</span>
<span class="cm"> *  return:  NULL</span>
<span class="cm"> *  notice:</span>
<span class="cm">********************************************************************************************************************/</span>
<span class="kt">void</span> <span class="nf">BaSetupTimeOut</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PTX_TS_RECORD</span>	<span class="n">pTxTs</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_TS_RECORD</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bAddBaReqInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bAddBaReqDelayed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxPendingBARecord</span><span class="p">.</span><span class="n">bValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TxBaInactTimeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PTX_TS_RECORD</span>	<span class="n">pTxTs</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTX_TS_RECORD</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pTxTs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">TxTsRecord</span><span class="p">[</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]);</span>
	<span class="n">TxTsDeleteBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pTxTs</span><span class="p">);</span>
	<span class="n">ieee80211_send_DELBA</span><span class="p">(</span>
		<span class="n">ieee</span><span class="p">,</span>
		<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TsCommonInfo</span><span class="p">.</span><span class="n">Addr</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxAdmittedBARecord</span><span class="p">,</span>
		<span class="n">TX_DIR</span><span class="p">,</span>
		<span class="n">DELBA_REASON_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">RxBaInactTimeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PRX_TS_RECORD</span>	<span class="n">pRxTs</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRX_TS_RECORD</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pRxTs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="p">,</span> <span class="n">RxTsRecord</span><span class="p">[</span><span class="n">pRxTs</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]);</span>

	<span class="n">RxTsDeleteBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pRxTs</span><span class="p">);</span>
	<span class="n">ieee80211_send_DELBA</span><span class="p">(</span>
		<span class="n">ieee</span><span class="p">,</span>
		<span class="n">pRxTs</span><span class="o">-&gt;</span><span class="n">TsCommonInfo</span><span class="p">.</span><span class="n">Addr</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">pRxTs</span><span class="o">-&gt;</span><span class="n">RxAdmittedBARecord</span><span class="p">,</span>
		<span class="n">RX_DIR</span><span class="p">,</span>
		<span class="n">DELBA_REASON_TIMEOUT</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
