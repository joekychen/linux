<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8192u › r8192U_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>r8192U_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * Copyright(c) 2008 - 2010 Realtek Corporation. All rights reserved.</span>
<span class="cm"> * Linux device driver for RTL8192U</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the r8187 driver, which is:</span>
<span class="cm"> * Copyright 2004-2005 Andrea Merello &lt;andreamrl@tiscali.it&gt;, et al.</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * Jerry chuang &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CONFIG_FORCE_HARD_FLOAT</span>
<span class="kt">double</span> <span class="nf">__floatsidf</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__fixunsdfsi</span> <span class="p">(</span><span class="kt">double</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">d</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">double</span> <span class="nf">__adddf3</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">double</span> <span class="nf">__addsf3</span><span class="p">(</span><span class="kt">float</span> <span class="n">a</span><span class="p">,</span> <span class="kt">float</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">double</span> <span class="nf">__subdf3</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">double</span> <span class="nf">__extendsfdf2</span><span class="p">(</span><span class="kt">float</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="n">a</span><span class="p">;}</span>
<span class="cp">#endif</span>

<span class="cp">#undef LOOP_TEST</span>
<span class="cp">#undef DUMP_RX</span>
<span class="cp">#undef DUMP_TX</span>
<span class="cp">#undef DEBUG_TX_DESC2</span>
<span class="cp">#undef RX_DONT_PASS_UL</span>
<span class="cp">#undef DEBUG_EPROM</span>
<span class="cp">#undef DEBUG_RX_VERBOSE</span>
<span class="cp">#undef DUMMY_RX</span>
<span class="cp">#undef DEBUG_ZERO_RX</span>
<span class="cp">#undef DEBUG_RX_SKB</span>
<span class="cp">#undef DEBUG_TX_FRAG</span>
<span class="cp">#undef DEBUG_RX_FRAG</span>
<span class="cp">#undef DEBUG_TX_FILLDESC</span>
<span class="cp">#undef DEBUG_TX</span>
<span class="cp">#undef DEBUG_IRQ</span>
<span class="cp">#undef DEBUG_RX</span>
<span class="cp">#undef DEBUG_RXALLOC</span>
<span class="cp">#undef DEBUG_REGISTERS</span>
<span class="cp">#undef DEBUG_RING</span>
<span class="cp">#undef DEBUG_IRQ_TASKLET</span>
<span class="cp">#undef DEBUG_TX_ALLOC</span>
<span class="cp">#undef DEBUG_TX_DESC</span>

<span class="cp">#define CONFIG_RTL8192_IO_MAP</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &quot;r8192U_hw.h&quot;</span>
<span class="cp">#include &quot;r8192U.h&quot;</span>
<span class="cp">#include &quot;r8190_rtl8256.h&quot; </span><span class="cm">/* RTL8225 Radio frontend */</span><span class="cp"></span>
<span class="cp">#include &quot;r8180_93cx6.h&quot;   </span><span class="cm">/* Card EEPROM */</span><span class="cp"></span>
<span class="cp">#include &quot;r8192U_wx.h&quot;</span>
<span class="cp">#include &quot;r819xU_phy.h&quot; </span><span class="c1">//added by WB 4.30.2008</span>
<span class="cp">#include &quot;r819xU_phyreg.h&quot;</span>
<span class="cp">#include &quot;r819xU_cmdpkt.h&quot;</span>
<span class="cp">#include &quot;r8192U_dm.h&quot;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>include "r8192xU_phyreg.h"</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>FIXME: check if 2.6.7 is ok</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef CONFIG_RTL8192_PM</span>
<span class="cp">#include &quot;r8192_pm.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;dot11d.h&quot;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>set here to open your trace code. //WB</p></td><td class="code"><div class="highlight"><pre><span class="n">u32</span> <span class="n">rt_global_debug_component</span> <span class="o">=</span> \</pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>COMP<em>INIT        |
            COMP</em>DBG    |
COMP<em>EPROM       |
            COMP</em>PHY    |
COMP<em>RF        |
            COMP</em>FIRMWARE   |
            COMP<em>CH     |
COMP</em>POWER<em>TRACKING |
            COMP</em>RATE   |
COMP<em>TXAGC    |
    COMP</em>TRACE  |</p></td><td class="code"><div class="highlight"><pre>				<span class="n">COMP_DOWN</span>	<span class="o">|</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><pre><code>COMP_RECV   |
         COMP_SWBW    |
</code></pre></td><td class="code"><div class="highlight"><pre>				<span class="n">COMP_SEC</span>	<span class="o">|</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><pre><code>    COMP_RESET  |
COMP_SEND   |
</code></pre>

<p>COMP_EVENTS    |</p></td><td class="code"><div class="highlight"><pre>				<span class="n">COMP_ERR</span> <span class="p">;</span> <span class="c1">//always open err flags on</span>

<span class="cp">#define TOTAL_CAM_ENTRY 32</span>
<span class="cp">#define CAM_CONTENT_COUNT 8</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">rtl8192_usb_id_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Realtek */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0bda</span><span class="p">,</span> <span class="mh">0x8709</span><span class="p">)},</span>
	<span class="cm">/* Corega */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">)},</span>
	<span class="cm">/* Belkin */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x050d</span><span class="p">,</span> <span class="mh">0x805E</span><span class="p">)},</span>
	<span class="cm">/* Sitecom */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0df6</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">)},</span>
	<span class="cm">/* EnGenius */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1740</span><span class="p">,</span> <span class="mh">0x9201</span><span class="p">)},</span>
	<span class="cm">/* Dlink */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x2001</span><span class="p">,</span> <span class="mh">0x3301</span><span class="p">)},</span>
	<span class="cm">/* Zinwell */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x5a57</span><span class="p">,</span> <span class="mh">0x0290</span><span class="p">)},</span>
	<span class="cm">/* LG */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x043e</span><span class="p">,</span> <span class="mh">0x7a01</span><span class="p">)},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;V 1.1&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">rtl8192_usb_id_tbl</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux driver for Realtek RTL8192 USB WiFi cards&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ifname</span> <span class="o">=</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwwep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">//default use hw. set 0 to use software security</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>



<span class="n">module_param</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span> <span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>module<em>param(hwseqnum,int, S</em>IRUGO|S_IWUSR);</p></td><td class="code"><div class="highlight"><pre><span class="n">module_param</span><span class="p">(</span><span class="n">hwwep</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span><span class="s">&quot; Net interface name, wlan%d=default&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>MODULE<em>PARM</em>DESC(hwseqnum," Try to use hardware 802.11 header sequence numbers. Zero=default");</p></td><td class="code"><div class="highlight"><pre><span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwwep</span><span class="p">,</span><span class="s">&quot; Try to use hardware security support. &quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span><span class="s">&quot; Channel bitmask for specific locales. NYI&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">rtl8192_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">rtl8192_usb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">rtl8192_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">RTL819xU_MODULE_NAME</span><span class="p">,</span>		  <span class="cm">/* Driver name   */</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rtl8192_usb_id_tbl</span><span class="p">,</span>		  <span class="cm">/* PCI_ID table  */</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rtl8192_usb_probe</span><span class="p">,</span>		  <span class="cm">/* probe fn      */</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">rtl8192_usb_disconnect</span><span class="p">,</span>	  <span class="cm">/* remove fn     */</span>
<span class="cp">#ifdef CONFIG_RTL8192_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">rtl8192_suspend</span><span class="p">,</span>		  <span class="cm">/* PM suspend fn */</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">rtl8192_resume</span><span class="p">,</span>                 <span class="cm">/* PM resume fn  */</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>				  <span class="cm">/* PM suspend fn */</span>
	<span class="p">.</span><span class="n">resume</span>      	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>				  <span class="cm">/* PM resume fn  */</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_CHANNEL_LIST</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">Channel</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">Len</span><span class="p">;</span>
<span class="p">}</span><span class="n">CHANNEL_LIST</span><span class="p">,</span> <span class="o">*</span><span class="n">PCHANNEL_LIST</span><span class="p">;</span>

<span class="k">static</span> <span class="n">CHANNEL_LIST</span> <span class="n">ChannelPlan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">149</span><span class="p">,</span><span class="mi">153</span><span class="p">,</span><span class="mi">157</span><span class="p">,</span><span class="mi">161</span><span class="p">,</span><span class="mi">165</span><span class="p">},</span><span class="mi">24</span><span class="p">},</span>  		<span class="c1">//FCC</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">},</span><span class="mi">11</span><span class="p">},</span>                    				<span class="c1">//IC</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">21</span><span class="p">},</span>  	<span class="c1">//ETSI</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">},</span><span class="mi">13</span><span class="p">},</span>    <span class="c1">//Spain. Change to ETSI.</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">},</span><span class="mi">13</span><span class="p">},</span>  	<span class="c1">//France. Change to ETSI.</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">22</span><span class="p">},</span>	<span class="c1">//MKK					//MKK</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">22</span><span class="p">},</span><span class="c1">//MKK1</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">},</span><span class="mi">13</span><span class="p">},</span>	<span class="c1">//Israel.</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span><span class="mi">22</span><span class="p">},</span>			<span class="c1">// For 11a , TELEC</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">44</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">64</span><span class="p">},</span> <span class="mi">22</span><span class="p">},</span>    <span class="c1">//MIC</span>
	<span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">},</span><span class="mi">14</span><span class="p">}</span>					<span class="c1">//For Global Domain. 1-11:active scan, 12-14 passive scan. //+YJ, 080626</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl819x_set_channel_map</span><span class="p">(</span><span class="n">u8</span> <span class="n">channel_plan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_chan</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_chan</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel_plan</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">COUNTRY_CODE_FCC</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_IC</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_ETSI</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_SPAIN</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_FRANCE</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_MKK</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_MKK1</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_ISRAEL</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_TELEC</span>:
		<span class="k">case</span> <span class="n">COUNTRY_CODE_MIC</span>:
		<span class="p">{</span>
			<span class="n">Dot11d_Init</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>actually 8225 &amp; 8256 rf chips only support B,G,24N mode</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span> <span class="o">==</span> <span class="n">RF_8225</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span> <span class="o">==</span> <span class="n">RF_8256</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">min_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">max_chan</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;unknown rf chip, can&#39;t set channel map in function:%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Clear old channel map</p></td><td class="code"><div class="highlight"><pre>				<span class="n">memset</span><span class="p">(</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Set new channel map</p></td><td class="code"><div class="highlight"><pre>				<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Channel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_chan</span> <span class="o">||</span> <span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Channel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_chan</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
					<span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">ChannelPlan</span><span class="p">[</span><span class="n">channel_plan</span><span class="p">].</span><span class="n">Channel</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">COUNTRY_CODE_GLOBAL_DOMAIN</span>:
		<span class="p">{</span>
			<span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bEnabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//this flag enabled to follow 11d country IE setting, otherwise, it shall follow global domain settings.</span>
			<span class="n">Dot11d_Reset</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define 	rx_hal_is_cck_rate(_pdrvinfo)\</span>
<span class="cp">			(_pdrvinfo-&gt;RxRate == DESC90_RATE1M ||\</span>
<span class="cp">			_pdrvinfo-&gt;RxRate == DESC90_RATE2M ||\</span>
<span class="cp">			_pdrvinfo-&gt;RxRate == DESC90_RATE5_5M ||\</span>
<span class="cp">			_pdrvinfo-&gt;RxRate == DESC90_RATE11M) &amp;&amp;\</span>
<span class="cp">			!_pdrvinfo-&gt;RxHT\</span>


<span class="kt">void</span> <span class="nf">CamResetAllEntry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ulcommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>2004/02/11  In static WEP, OID<em>ADD</em>KEY or OID<em>ADD</em>WEP are set before STA associate to AP.
However, ResetKey is called on OID<em>802</em>11<em>INFRASTRUCTURE</em>MODE and MlmeAssociateRequest
In this condition, Cam can not be reset because upper layer will not set this static key again.
if(Adapter->EncAlgorithm == WEP_Encryption)
     return;
debug
DbgPrint("========================================\n");
DbgPrint("                            Call ResetAllEntry                                              \n");
DbgPrint("========================================\n\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ulcommand</span> <span class="o">|=</span> <span class="n">BIT31</span><span class="o">|</span><span class="n">BIT30</span><span class="p">;</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">,</span> <span class="n">ulcommand</span><span class="p">);</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">write_cam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WCAMI</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">,</span> <span class="n">BIT31</span><span class="o">|</span><span class="n">BIT16</span><span class="o">|</span><span class="p">(</span><span class="n">addr</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">read_cam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="o">|</span><span class="p">(</span><span class="n">addr</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_byte_E</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">RTL8187_REQ_SET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_WRITE</span><span class="p">,</span>
			       <span class="n">indx</span><span class="o">|</span><span class="mh">0xfe00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;write_nic_byte_E TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">read_nic_byte_E</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">RTL8187_REQ_GET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_READ</span><span class="p">,</span>
			       <span class="n">indx</span><span class="o">|</span><span class="mh">0xfe00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;read_nic_byte_E TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>as 92U has extend page from 4 to 16, so modify functions below.</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">write_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">RTL8187_REQ_SET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_WRITE</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">indx</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">|</span><span class="mh">0xff00</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;write_nic_byte TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>


<span class="p">}</span>


<span class="kt">void</span> <span class="nf">write_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">RTL8187_REQ_SET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_WRITE</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">indx</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">|</span><span class="mh">0xff00</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;write_nic_word TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">write_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">RTL8187_REQ_SET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_WRITE</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">indx</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">|</span><span class="mh">0xff00</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;write_nic_dword TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>



<span class="n">u8</span> <span class="nf">read_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">RTL8187_REQ_GET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_READ</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">indx</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">|</span><span class="mh">0xff00</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;read_nic_byte TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>



<span class="n">u16</span> <span class="nf">read_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				       <span class="n">RTL8187_REQ_GET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_READ</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">indx</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">|</span><span class="mh">0xff00</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;read_nic_word TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">read_nic_word_E</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">RTL8187_REQ_GET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_READ</span><span class="p">,</span>
				       <span class="n">indx</span><span class="o">|</span><span class="mh">0xfe00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;read_nic_word TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">read_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">indx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* int result; */</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				       <span class="n">RTL8187_REQ_GET_REGS</span><span class="p">,</span> <span class="n">RTL8187_REQT_READ</span><span class="p">,</span>
					<span class="p">(</span><span class="n">indx</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">|</span><span class="mh">0xff00</span><span class="p">,</span> <span class="p">(</span><span class="n">indx</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* if(0 != result) {</span>
<span class="cm">	 *	printk(KERN_WARNING &quot;read size of data = %d\, date = %d\n&quot;,</span>
<span class="cm">	 *							 result, data);</span>
<span class="cm">	 * }</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;read_nic_dword TimeOut! status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* u8 read_phy_cck(struct net_device *dev, u8 adr); */</span>
<span class="cm">/* u8 read_phy_ofdm(struct net_device *dev, u8 adr); */</span>
<span class="cm">/* this might still called in what was the PHY rtl8185/rtl8192 common code</span>
<span class="cm"> * plans are to possibility turn it again in one common code...</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">force_pci_posting</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">rtl8192_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rtl8192_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cm">/* void rtl8192_restart(struct net_device *dev); */</span>
<span class="kt">void</span> <span class="n">rtl8192_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="cm">/* void rtl8192_rq_tx_ack(struct work_struct *work); */</span>
<span class="kt">void</span> <span class="n">watch_dog_timer_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> *   -----------------------------PROCFS STUFF-------------------------</span>
<span class="cm">*****************************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">rtl8192_proc</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_stats_ap</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
							<span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;WPA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;non_WPA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_registers</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
			  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>struct r8192<em>priv *priv = (struct r8192</em>priv *)ieee80211_priv(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">max</span><span class="o">=</span><span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* This dump the current register page */</span>
<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">####################page 0##################</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>printk( "\nD: %2x> ", n);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">D:  %2x &gt; &quot;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%2x &quot;</span><span class="p">,</span><span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mh">0x000</span><span class="o">|</span><span class="n">n</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>printk("%2x ",read<em>nic</em>byte(dev,n));</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">####################page 1##################</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>printk( "\nD: %2x> ", n);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">D:  %2x &gt; &quot;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%2x &quot;</span><span class="p">,</span><span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mh">0x100</span><span class="o">|</span><span class="n">n</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><pre><code> printk("%2x ",read_nic_byte(dev,n));
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">####################page 3##################</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>printk( "\nD: %2x> ", n);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">D:  %2x &gt; &quot;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%2x &quot;</span><span class="p">,</span><span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mh">0x300</span><span class="o">|</span><span class="n">n</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><pre><code> printk("%2x ",read_nic_byte(dev,n));
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>


	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

<span class="p">}</span>





<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_stats_tx</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
			  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;TX VI priority ok int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX VI priority error int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX VO priority ok int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX VO priority error int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BE priority ok int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BE priority error int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BK priority ok int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BK priority error int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX MANAGE priority ok int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX MANAGE priority error int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BEACON priority ok int: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BEACON priority error int: %lu</span><span class="se">\n</span><span class="s">&quot;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><pre><code>"TX high priority ok int: %lu\n"
"TX high priority failed error int: %lu\n"
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="s">&quot;TX queue resume: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX queue stopped?: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX fifo overflow: %lu</span><span class="se">\n</span><span class="s">&quot;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><pre><code>"TX beacon: %lu\n"
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="s">&quot;TX VI queue: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX VO queue: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BE queue: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BK queue: %d</span><span class="se">\n</span><span class="s">&quot;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><pre><code>"TX HW queue: %d\n"
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="s">&quot;TX VI dropped: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX VO dropped: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BE dropped: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX BK dropped: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;TX total data packets %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><pre><code>"TX beacon aborted: %lu\n",
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txviokint</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txvierr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txvookint</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txvoerr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeokint</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeerr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbkokint</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbkerr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txmanageokint</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txmanageerr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeaconokint</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeaconerr</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><pre><code>priv-&gt;stats.txhpokint,
priv-&gt;stats.txhperr,
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txresumed</span><span class="p">,</span>
		<span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txoverflow</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><pre><code>priv-&gt;stats.txbeacon,
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">VI_PRIORITY</span><span class="p">])),</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">VO_PRIORITY</span><span class="p">])),</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">BE_PRIORITY</span><span class="p">])),</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">BK_PRIORITY</span><span class="p">])),</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><pre><code>read_nic_byte(dev, TXFIFOCOUNT),
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txvidrop</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txvodrop</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbedrop</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbkdrop</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txdatapkt</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><pre><code>priv-&gt;stats.txbeaconerr
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">);</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_get_stats_rx</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span>
			  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;RX packets: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;RX urb status error: %lu</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;RX invalid urb error: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxoktotal</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxstaterr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxurberr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">rtl8192_proc_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Initializing proc filesystem&quot;</span><span class="p">);</span>
	<span class="n">rtl8192_proc</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">RTL819xU_MODULE_NAME</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_proc_module_remove</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">RTL819xU_MODULE_NAME</span><span class="p">,</span> <span class="n">init_net</span><span class="p">.</span><span class="n">proc_net</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_proc_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>remove<em>proc</em>entry("stats-hw", priv->dir_dev);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;stats-tx&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;stats-rx&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>remove<em>proc</em>entry("stats-ieee", priv->dir_dev);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;stats-ap&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>remove<em>proc</em>entry("cck-registers",priv->dir<em>dev);
remove</em>proc<em>entry("ofdm-registers",priv->dir</em>dev);
remove<em>proc</em>entry(dev->name, rtl8192_proc);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;wlan0&quot;</span><span class="p">,</span> <span class="n">rtl8192_proc</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_proc_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rtl8192_proc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Unable to initialize /proc/net/rtl8192/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;stats-rx&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_stats_rx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span><span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/rtl8192/%s/stats-rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;stats-tx&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_stats_tx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/rtl8192/%s/stats-tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;stats-ap&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_stats_ap</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/rtl8192/%s/stats-ap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dir_dev</span><span class="p">,</span> <span class="n">proc_get_registers</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Unable to initialize &quot;</span>
		      <span class="s">&quot;/proc/net/rtl8192/%s/registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************</span>
<span class="cm">   -----------------------------MISC STUFF-------------------------</span>
<span class="cm">*****************************************************************************/</span>

<span class="cm">/* this is only for debugging */</span>
<span class="kt">void</span> <span class="nf">print_buffer</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span><span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ASCII BUFFER DUMP (len: %x):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">BINARY BUFFER DUMP (len: %x):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>short check<em>nic</em>enough<em>desc(struct net</em>device *dev, priority_t priority)</p></td><td class="code"><div class="highlight"><pre><span class="kt">short</span> <span class="nf">check_nic_enough_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">queue_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">used</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">used</span> <span class="o">&lt;</span> <span class="n">MAX_TX_URB</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>rtl8192_commit(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>DMESG("TXTIMEOUT");</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="cm">/* this is only for debug */</span>
<span class="kt">void</span> <span class="nf">dump_eprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">63</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;EEPROM addr %x : %x&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* this is only for debug */</span>
<span class="kt">void</span> <span class="nf">rtl8192_dump_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="o">=</span><span class="mh">0x1ff</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_PHY</span><span class="p">,</span> <span class="s">&quot;Dumping NIC register map&quot;</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">D: %2x&gt; &quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&lt;=</span><span class="n">max</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%2x &quot;</span><span class="p">,</span><span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">n</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">      ------------------------------HW STUFF---------------------------</span>
<span class="cm">*****************************************************************************/</span>


<span class="kt">void</span> <span class="nf">rtl8192_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ecmd</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">=</span><span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">=</span><span class="n">ecmd</span> <span class="o">&amp;~</span> <span class="n">EPROM_CMD_OPERATING_MODE_MASK</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">=</span><span class="n">ecmd</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">&lt;&lt;</span><span class="n">EPROM_CMD_OPERATING_MODE_SHIFT</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">=</span><span class="n">ecmd</span> <span class="o">&amp;~</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EPROM_CS_SHIFT</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">=</span><span class="n">ecmd</span> <span class="o">&amp;~</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">EPROM_CK_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_update_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">msr</span><span class="p">;</span>

	<span class="n">msr</span>  <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">);</span>
	<span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">MSR_LINK_MASK</span><span class="p">;</span>

	<span class="cm">/* do not change in link_state != WLAN_LINK_ASSOCIATED.</span>
<span class="cm">	 * msr must be updated if the state is ASSOCIATING.</span>
<span class="cm">	 * this is intentional and make sense for ad-hoc and</span>
<span class="cm">	 * master (see the create BSS/IBSS func)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">){</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
			<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_MANAGED</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_ADHOC</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
			<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_MASTER</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>

	<span class="p">}</span><span class="k">else</span>
		<span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MSR_LINK_NONE</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">);</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_set_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">short</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>u32 tx;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_CH</span><span class="p">,</span> <span class="s">&quot;=====&gt;%s()====ch:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">=</span><span class="n">ch</span><span class="p">;</span>

	<span class="cm">/* this hack should avoid frame TX during channel setting*/</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>tx = read<em>nic</em>dword(dev,TX<em>CONF);
tx &amp;= ~TX</em>LOOPBACK_MASK;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef LOOP_TEST</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>write<em>nic</em>dword(dev,TX<em>CONF, tx |( TX</em>LOOPBACK<em>MAC&lt;<TX</em>LOOPBACK_SHIFT));</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>need to implement rf set channel here WB</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span><span class="p">)</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>write<em>nic</em>dword(dev,TX<em>CONF,tx | (TX</em>LOOPBACK<em>NONE&lt;<TX</em>LOOPBACK_SHIFT));</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8192_rx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>static void rtl8192<em>rx</em>isr(struct urb *rx_urb);</p></td><td class="code"><div class="highlight"><pre><span class="n">u32</span> <span class="nf">get_rxpacket_shiftbytes_819xusb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">pstats</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bisrxaggrsubframe</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">)</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span>
			<span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">)</span> <span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span>
				<span class="o">+</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span><span class="p">);</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_rx_initiate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/* nomal packet rx procedure */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_RX_URB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">RX_URB_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><pre><code>printk("nomal packet IN request!\n");
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				  <span class="n">RX_URB_SIZE</span><span class="p">,</span> <span class="n">rtl8192_rx_isr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">out_pipe</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">//denote rx normal packet queue</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* command packet rx procedure */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_RX_URB</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><pre><code>printk("command packet IN request!\n");
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">RX_URB_SIZE</span> <span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				  <span class="n">RX_URB_SIZE</span><span class="p">,</span> <span class="n">rtl8192_rx_isr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		   <span class="n">info</span><span class="o">-&gt;</span><span class="n">out_pipe</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="c1">//denote rx cmd packet queue</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_set_rxconf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rxconf</span><span class="p">;</span>

	<span class="n">rxconf</span><span class="o">=</span><span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">RCR</span><span class="p">);</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">&amp;~</span> <span class="n">MAC_FILTER_MASK</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_AMF</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_ADF</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_AB</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_AM</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>rxconf = rxconf | RCR_ACF;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span><span class="n">DMESG</span> <span class="p">(</span><span class="s">&quot;NIC in promisc mode&quot;</span><span class="p">);}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span> <span class="o">||</span> \
	   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">){</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_AAP</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/*else if(priv-&gt;ieee80211-&gt;iw_mode == IW_MODE_MASTER){</span>
<span class="cm">		rxconf = rxconf | (1&lt;&lt;ACCEPT_ALLMAC_FRAME_SHIFT);</span>
<span class="cm">		rxconf = rxconf | (1&lt;&lt;RX_CHECK_BSSID_SHIFT);</span>
<span class="cm">	}*/</span><span class="k">else</span><span class="p">{</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_APM</span><span class="p">;</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_CBSSID</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">){</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_AICV</span><span class="p">;</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_APWRMGT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">crcmon</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_ACRC32</span><span class="p">;</span>


	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">&amp;~</span> <span class="n">RX_FIFO_THRESHOLD_MASK</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">(</span><span class="n">RX_FIFO_THRESHOLD_NONE</span><span class="o">&lt;&lt;</span><span class="n">RX_FIFO_THRESHOLD_SHIFT</span><span class="p">);</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">&amp;~</span> <span class="n">MAX_RX_DMA_MASK</span><span class="p">;</span>
	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="n">RCR_MXDMA_OFFSET</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>rxconf = rxconf | (1&lt;<RX<em>AUTORESETPHY</em>SHIFT);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rxconf</span> <span class="o">=</span> <span class="n">rxconf</span> <span class="o">|</span> <span class="n">RCR_ONLYERLPKT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>rxconf = rxconf &amp;~ RCR<em>CS</em>MASK;
rxconf = rxconf | (1&lt;<RCR<em>CS</em>SHIFT);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">rxconf</span><span class="p">);</span>

	<span class="cp">#ifdef DEBUG_RX</span>
	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;rxconf: %x %x&quot;</span><span class="p">,</span><span class="n">rxconf</span> <span class="p">,</span><span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">RCR</span><span class="p">));</span>
	<span class="cp">#endif</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>wait to be removed</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">rtl8192_rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>u8 cmd;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>struct r8192<em>priv *priv = (struct r8192</em>priv *)ieee80211_priv(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_rx_initiate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>rtl8192<em>set</em>rxconf(dev);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">rtl8192_rtx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">=</span><span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">CMDR</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;~</span> \
		<span class="p">(</span><span class="n">CR_TE</span><span class="o">|</span><span class="n">CR_RE</span><span class="p">));</span>
	<span class="n">force_pci_posting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;skb_queue not empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">alloc_tx_beacon_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">u16</span> <span class="nf">ieeerate2rtlrate</span><span class="p">(</span><span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">rate</span><span class="p">){</span>
	<span class="k">case</span> <span class="mi">10</span>:
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">20</span>:
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">55</span>:
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">110</span>:
	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">60</span>:
	<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">90</span>:
	<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
	<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">180</span>:
	<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">240</span>:
	<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">360</span>:
	<span class="k">return</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">480</span>:
	<span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">540</span>:
	<span class="k">return</span> <span class="mi">11</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">rtl_rate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">240</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="mi">480</span><span class="p">,</span><span class="mi">540</span><span class="p">};</span>
<span class="kr">inline</span> <span class="n">u16</span> <span class="nf">rtl8192_rate2rate</span><span class="p">(</span><span class="kt">short</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span><span class="mi">11</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rtl_rate</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/* The prototype of rx_isr has changed since one version of Linux Kernel */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_rx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">out_pipe</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">out_pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxstaterr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>printk("%s():rx status err\n",<strong>FUNCTION</strong>);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">RX_URB_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s():can,t alloc skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="cm">/* TODO check rx queue length and refill *somewhere* */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">out_pipe</span><span class="p">),</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
			<span class="n">RX_URB_SIZE</span><span class="p">,</span> <span class="n">rtl8192_rx_isr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">out_pipe</span> <span class="o">=</span> <span class="n">out_pipe</span><span class="p">;</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">EPERM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;can not submit rxurb, err is %x,URB status is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span>
<span class="nf">rtl819xusb_rx_command_packet</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">pstats</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">status</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>RT<em>TRACE(COMP</em>RECV, DBG_TRACE, ("---> RxCommandPacketHandle819xUsb()\n"));</p></td><td class="code"><div class="highlight"><pre>	<span class="n">status</span> <span class="o">=</span> <span class="n">cmpk_message_handle_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pstats</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;rxcommandpackethandle819xusb: It is a command packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>RT<em>TRACE(COMP</em>RECV, DBG_TRACE, ("RxCommandPacketHandle819xUsb: It is not a command packet\n"));</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>RT<em>TRACE(COMP</em>RECV, DBG_TRACE, ("&lt;--- RxCommandPacketHandle819xUsb()\n"));</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_data_hard_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>FIXME !!</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_data_hard_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>FIXME !!</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="cm">/* this function TX data frames when the ieee80211 stack requires this.</span>
<span class="cm"> * It checks also if we need to stop the ieee tx queue, eventually do it</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtl8192_hard_data_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">queue_index</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span>

	<span class="cm">/* shall not be referred by command packet */</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">TXCMD_QUEUE</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>tcb<em>desc->RATRIndex = 7;
tcb</em>desc->bTxDisableRateFallBack = 1;
tcb_desc->bTxUseDriverAssingedRate = 1;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxEnableFwCalcDur</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>priv->ieee80211->stats.tx<em>bytes+=(skb->len - priv->ieee80211->tx</em>headroom);
priv->ieee80211->stats.tx_packets++;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>return ret;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is a rough attempt to TX a frame</span>
<span class="cm"> * This is called by the ieee 80211 stack to TX management frames.</span>
<span class="cm"> * If the ring is full packet are dropped (for data frame the queue</span>
<span class="cm"> * is stopped before this can happen).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rtl8192_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">queue_index</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">queue_index</span> <span class="o">==</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">USB_HWDESC_HEADER_LEN</span><span class="p">);</span>
		<span class="n">rtl819xU_tx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">rtl8192_try_wake_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">);</span>

<span class="cp">#ifdef USB_TX_DRIVER_AGGREGATION_ENABLE</span>
<span class="n">u16</span> <span class="nf">DrvAggr_PaddingAdd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>     <span class="n">PaddingNum</span> <span class="o">=</span>  <span class="mi">256</span> <span class="o">-</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">TX_PACKET_DRVAGGR_SUBFRAME_SHIFT_BYTES</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
	<span class="k">return</span>  <span class="p">(</span><span class="n">PaddingNum</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="n">MRateToHwRate8190Pci</span><span class="p">(</span><span class="n">u8</span> <span class="n">rate</span><span class="p">);</span>
<span class="n">u8</span> <span class="n">QueryIsShort</span><span class="p">(</span><span class="n">u8</span> <span class="n">TxHT</span><span class="p">,</span> <span class="n">u8</span> <span class="n">TxRate</span><span class="p">,</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">);</span>
<span class="n">u8</span> <span class="n">MapHwQueueToFirmwareQueue</span><span class="p">(</span><span class="n">u8</span> <span class="n">QueueID</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">DrvAggr_Aggregation</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_drv_agg_txb</span> <span class="o">*</span><span class="n">pSendList</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cb_desc</span> 	<span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> 		<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">TotalLength</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">agg_skb</span><span class="p">;</span>
	<span class="n">tx_desc_819x_usb_aggr_subframe</span> <span class="o">*</span><span class="n">tx_agg_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tx_fwinfo_819x_usb</span>	       <span class="o">*</span><span class="n">tx_fwinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Local variable initialization.</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* first skb initialization */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">tx_agg_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">TotalLength</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Get the total aggregation length including the padding space and</span>
<span class="cm">	 * sub frame header.</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TotalLength</span> <span class="o">+=</span> <span class="n">DrvAggr_PaddingAdd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">tx_agg_frames</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">TotalLength</span> <span class="o">+=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">TX_PACKET_DRVAGGR_SUBFRAME_SHIFT_BYTES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* allocate skb to contain the aggregated packets */</span>
	<span class="n">agg_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">TotalLength</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>RT<em>DEBUG</em>DATA(COMP_SEND, skb->cb, sizeof(skb->cb));</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* reserve info for first subframe Tx descriptor to be set in the tx function */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">tx_agg_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">drv_agg_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">DrvAggrNum</span> <span class="o">=</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DrvAggNum = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">DrvAggrNum</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>RT<em>DEBUG</em>DATA(COMP<em>SEND, skb->cb, sizeof(skb->cb));
printk("========>skb->data ======> \n");
RT</em>DEBUG<em>DATA(COMP</em>SEND, skb->data, skb->len);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memcpy</span><span class="p">(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* push the next sub frame to be 256 byte aline */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span><span class="n">DrvAggr_PaddingAdd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">skb</span><span class="p">));</span>

		<span class="cm">/* Subframe drv Tx descriptor and firmware info setting */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">tx_agg_frames</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
		<span class="n">tx_agg_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_desc_819x_usb_aggr_subframe</span> <span class="o">*</span><span class="p">)</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span> <span class="o">*</span><span class="p">)(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_desc_819x_usb_aggr_subframe</span><span class="p">));</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">tx_fwinfo</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span><span class="p">));</span>
		<span class="cm">/* DWORD 0 */</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxHT</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxRate</span> <span class="o">=</span> <span class="n">MRateToHwRate8190Pci</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">);</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">EnableCPUDur</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxEnableFwCalcDur</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">Short</span> <span class="o">=</span> <span class="n">QueryIsShort</span><span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxHT</span><span class="p">,</span> <span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxRate</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bAMPDUEnable</span><span class="p">)</span> <span class="p">{</span><span class="c1">//AMPDU enabled</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">AllowAggregation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* DWORD 1 */</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxMF</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span><span class="p">;</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxAMD</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_density</span><span class="o">&amp;</span><span class="mh">0x07</span><span class="p">;</span><span class="c1">//ampdudensity</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">AllowAggregation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* DWORD 1 */</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxMF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxAMD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Protection mode related */</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">CtsEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCTSEnable</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsSTBC</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSSTBC</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsRate</span> <span class="o">=</span>  <span class="n">MRateToHwRate8190Pci</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span><span class="p">);</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsSubcarrier</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RTSSC</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsBandwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="p">((</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSBW</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsShort</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSUseShortPreamble</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span>\
				      <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSUseShortGI</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Set Bandwidth and sub-channel settings. */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentChannelBW</span> <span class="o">==</span> <span class="n">HT_CHANNEL_WIDTH_20_40</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bPacketBW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxBandwidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxSubCarrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">//By SD3&#39;s Jerry suggestion, use duplicated mode</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxBandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxSubCarrier</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nCur40MhzPrimeSC</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxBandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxSubCarrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Fill Tx descriptor */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tx_agg_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_desc_819x_usb_aggr_subframe</span><span class="p">));</span>
		<span class="cm">/* DWORD 0 */</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>tx<em>agg</em>desc->LINIP = 0;
tx<em>agg</em>desc->CmdInit = 1;</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="cm">/* already raw data, need not to subtract header length */</span>
		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">PktSize</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="cm">/*DWORD 1*/</span>
		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">SecCAMID</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">RATid</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span><span class="p">;</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>MPDUOverhead = 0;</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bHwSec</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">case</span> <span class="n">KEY_TYPE_WEP40</span>:
				<span class="k">case</span> <span class="n">KEY_TYPE_WEP104</span>:
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">KEY_TYPE_TKIP</span>:
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">KEY_TYPE_CCMP</span>:
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">KEY_TYPE_NA</span>:
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
					<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">MapHwQueueToFirmwareQueue</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">TxFWInfoSize</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span><span class="p">);</span>

		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">DISFB</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span><span class="p">;</span>
		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">USERATE</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span><span class="p">;</span>

		<span class="n">tx_agg_desc</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>DWORD 2</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* According windows driver, it seems that there no need to fill this field */</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>tx<em>agg</em>desc->TxBufferSize= (u32)(skb->len - USB<em>HWDESC</em>HEADER_LEN);</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* to fill next packet */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span><span class="n">TX_PACKET_DRVAGGR_SUBFRAME_SHIFT_BYTES</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">tx_agg_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">agg_skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NOTE:</span>
<span class="cm">	This function return a list of PTCB which is proper to be aggregate with the input TCB.</span>
<span class="cm">	If no proper TCB is found to do aggregation, SendList will only contain the input TCB.</span>
<span class="cm">*/</span>
<span class="n">u8</span> <span class="nf">DrvAggr_GetAggregatibleList</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_drv_agg_txb</span> <span class="o">*</span><span class="n">pSendList</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">PRT_HIGH_THROUGHPUT</span>	<span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">nMaxAggrNum</span> <span class="o">=</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">UsbTxAggrNum</span><span class="p">;</span>
	<span class="n">cb_desc</span> 	<span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">u8</span>		<span class="n">QueueID</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">tx_agg_frames</span><span class="p">[</span><span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span> <span class="o">&gt;=</span> <span class="n">nMaxAggrNum</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span><span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">skb_drv_aggQ</span><span class="p">[</span><span class="n">QueueID</span><span class="p">])));</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_AMSDU</span><span class="p">,</span> <span class="s">&quot;DrvAggr_GetAggregatibleList, nAggrTcbNum = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pSendList</span><span class="o">-&gt;</span><span class="n">nr_drv_agg_frames</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_tx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">tx_urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span><span class="p">)</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">u8</span>  <span class="n">queue_index</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>bool bToSend0Byte;
u16 BufLen = skb->len;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span><span class="p">));</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Act as station mode, destination shall be unicast address.
priv->ieee80211->stats.tx<em>bytes+=(skb->len - priv->ieee80211->tx</em>headroom);
priv->ieee80211->stats.tx_packets++;</p></td><td class="code"><div class="highlight"><pre>			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txoktotal</span><span class="o">++</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesunicast</span> <span class="o">+=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>priv->stats.txmanageerr++;</p></td><td class="code"><div class="highlight"><pre>			<span class="cm">/* TODO */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* free skb and tx_urb */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">tx_urb</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="p">{</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Handle HW Beacon:
We had transfer our beacon frame to host controller at this moment.</p>

<p>Caution:
Handling the wait queue of command packets.
For Tx command packets, we must not do TCB fragment because it is not handled right now.
We must cut the packets to match the size of TX<em>CMD</em>PKT before we send it.</p></td><td class="code"><div class="highlight"><pre>		<span class="cm">/* Handle MPDU in wait queue. */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t send data frame during scanning.*/</span>
			<span class="k">if</span><span class="p">((</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span>\
					<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]))))</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

				<span class="k">return</span><span class="p">;</span> <span class="c1">//modified by david to avoid further processing AMSDU</span>
			<span class="p">}</span>
<span class="cp">#ifdef USB_TX_DRIVER_AGGREGATION_ENABLE</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_drv_aggQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">])</span><span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span>\
				<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Tx Driver Aggregation process</p></td><td class="code"><div class="highlight"><pre>				<span class="cm">/* The driver will aggregation the packets according to the following stats</span>
<span class="cm">				 * 1. check whether there&#39;s tx irq available, for it&#39;s a completion return</span>
<span class="cm">				 *    function, it should contain enough tx irq;</span>
<span class="cm">				 * 2. check packet type;</span>
<span class="cm">				 * 3. initialize sendlist, check whether the to-be send packet no greater than 1</span>
<span class="cm">				 * 4. aggregates the packets, and fill firmware info and tx desc into it, etc.</span>
<span class="cm">				 * 5. check whether the packet could be sent, otherwise just insert into wait head</span>
<span class="cm">				 * */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_drv_aggQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]);</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">check_nic_enough_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">queue_index</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_drv_aggQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]),</span> <span class="n">skb</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="p">{</span>
					<span class="cm">/*TODO*/</span>
					<span class="cm">/*</span>
<span class="cm">					u8* pHeader = skb-&gt;data;</span>

<span class="cm">					if(IsMgntQosData(pHeader) ||</span>
<span class="cm">					    IsMgntQData_Ack(pHeader) ||</span>
<span class="cm">					    IsMgntQData_Poll(pHeader) ||</span>
<span class="cm">					    IsMgntQData_Poll_Ack(pHeader)</span>
<span class="cm">					  )</span>
<span class="cm">					*/</span>
					<span class="p">{</span>
						<span class="k">struct</span> <span class="n">ieee80211_drv_agg_txb</span> <span class="n">SendList</span><span class="p">;</span>

						<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SendList</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_drv_agg_txb</span><span class="p">));</span>
						<span class="k">if</span><span class="p">(</span><span class="n">DrvAggr_GetAggregatibleList</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SendList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">skb</span> <span class="o">=</span> <span class="n">DrvAggr_Aggregation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SendList</span><span class="p">);</span>

						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_beacon_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">msr</span><span class="p">,</span> <span class="n">msrm</span><span class="p">,</span> <span class="n">msr2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">msr</span>  <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">);</span>
	<span class="n">msrm</span> <span class="o">=</span> <span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_LINK_MASK</span><span class="p">;</span>
	<span class="n">msr2</span> <span class="o">=</span> <span class="n">msr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSR_LINK_MASK</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">NIC_8192U</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_8192</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">MAX_RX_URB</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msrm</span> <span class="o">==</span> <span class="p">(</span><span class="n">MSR_LINK_ADHOC</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">msrm</span> <span class="o">==</span> <span class="p">(</span><span class="n">MSR_LINK_MASTER</span><span class="o">&lt;&lt;</span><span class="n">MSR_LINK_SHIFT</span><span class="p">)))){</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">,</span> <span class="n">msr2</span> <span class="o">|</span> <span class="n">MSR_LINK_NONE</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MSR</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_config_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">rate_config</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	 <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">basic_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	 <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	 <span class="p">{</span>
		 <span class="n">basic_rate</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">;</span>
		 <span class="k">switch</span><span class="p">(</span><span class="n">basic_rate</span><span class="p">)</span>
		 <span class="p">{</span>
			 <span class="k">case</span> <span class="n">MGN_1M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_1M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_2M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_2M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_5_5M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_5_5M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_11M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_11M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_6M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_6M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_9M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_9M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_12M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_12M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_18M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_18M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_24M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_24M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_36M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_36M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_48M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_48M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_54M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_54M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		 <span class="p">}</span>
	 <span class="p">}</span>
	 <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	 <span class="p">{</span>
		 <span class="n">basic_rate</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">;</span>
		 <span class="k">switch</span><span class="p">(</span><span class="n">basic_rate</span><span class="p">)</span>
		 <span class="p">{</span>
			 <span class="k">case</span> <span class="n">MGN_1M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_1M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_2M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_2M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_5_5M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_5_5M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_11M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_11M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_6M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_6M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_9M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_9M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_12M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_12M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_18M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_18M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_24M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_24M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_36M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_36M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_48M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_48M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MGN_54M</span>:	<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_54M</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		 <span class="p">}</span>
	 <span class="p">}</span>
<span class="p">}</span>


<span class="cp">#define SHORT_SLOT_TIME 9</span>
<span class="cp">#define NON_SHORT_SLOT_TIME 20</span>

<span class="kt">void</span> <span class="nf">rtl8192_update_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_preamble</span> <span class="o">=</span> <span class="n">cap</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_preamble</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">BRSR_AckShortPmb</span><span class="p">;</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RRSR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE_G</span><span class="o">|</span><span class="n">IEEE_N_24G</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">slot_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentRT2RTLongSlotTime</span><span class="p">))</span>
		<span class="p">{</span><span class="c1">//short slot time</span>
			<span class="n">slot_time</span> <span class="o">=</span> <span class="n">SHORT_SLOT_TIME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="c1">//long slot time</span>
			<span class="n">slot_time</span> <span class="o">=</span> <span class="n">NON_SHORT_SLOT_TIME</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">slot_time</span> <span class="o">=</span> <span class="n">slot_time</span><span class="p">;</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SLOT_TIME</span><span class="p">,</span> <span class="n">slot_time</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="kt">void</span> <span class="nf">rtl8192_net_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">BcnTimeCfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BcnCW</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">BcnIFS</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rate_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="n">rtl8192_config_rate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate_config</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span> <span class="n">rate_config</span> <span class="o">&amp;=</span> <span class="mh">0x15f</span><span class="p">;</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">BSSIDR</span><span class="p">,((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">BSSIDR</span><span class="o">+</span><span class="mi">4</span><span class="p">,((</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)[</span><span class="mi">2</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>for(i=0;i<ETH_ALEN;i++)
write_nic_byte(dev,BSSID+i,net->bssid[i]);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_update_msr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>rtl8192<em>update</em>cap(dev, net->capability);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ATIMWND</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCN_DMATIME</span><span class="p">,</span> <span class="mi">1023</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCN_INTERVAL</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>write<em>nic</em>word(dev, BcnIntTime, 100);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCN_DRV_EARLY_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCN_ERR_THRESH</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="n">BcnTimeCfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BcnCW</span><span class="o">&lt;&lt;</span><span class="n">BCN_TCFG_CW_SHIFT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>TODO: BcnIFS may required to be changed on ASIC</p></td><td class="code"><div class="highlight"><pre>		<span class="n">BcnTimeCfg</span> <span class="o">|=</span> <span class="n">BcnIFS</span><span class="o">&lt;&lt;</span><span class="n">BCN_TCFG_IFS</span><span class="p">;</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCN_TCFG</span><span class="p">,</span> <span class="n">BcnTimeCfg</span><span class="p">);</span>
	<span class="p">}</span>



<span class="p">}</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>temporary hw beacon is not used any more.
open it when necessary</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">rtl819xusb_beacon_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="n">u16</span>  <span class="n">tx_rate</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>
<span class="kr">inline</span> <span class="n">u8</span> <span class="nf">rtl8192_IsWirelessBMode</span><span class="p">(</span><span class="n">u16</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">110</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">90</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">220</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="n">N_DBPSOfRate</span><span class="p">(</span><span class="n">u16</span> <span class="n">DataRate</span><span class="p">);</span>

<span class="n">u16</span> <span class="nf">ComputeTxTime</span><span class="p">(</span>
	<span class="n">u16</span>		<span class="n">FrameLength</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">DataRate</span><span class="p">,</span>
	<span class="n">u8</span>		<span class="n">bManagementFrame</span><span class="p">,</span>
	<span class="n">u8</span>		<span class="n">bShortPreamble</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">FrameTime</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">N_DBPS</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">Ceiling</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">rtl8192_IsWirelessBMode</span><span class="p">(</span><span class="n">DataRate</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">bManagementFrame</span> <span class="o">||</span> <span class="o">!</span><span class="n">bShortPreamble</span> <span class="o">||</span> <span class="n">DataRate</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">)</span>
		<span class="p">{</span>	<span class="c1">// long preamble</span>
			<span class="n">FrameTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mi">144</span><span class="o">+</span><span class="mi">48</span><span class="o">+</span><span class="p">(</span><span class="n">FrameLength</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">DataRate</span><span class="o">/</span><span class="mi">10</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>	<span class="c1">// Short preamble</span>
			<span class="n">FrameTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mi">72</span><span class="o">+</span><span class="mi">24</span><span class="o">+</span><span class="p">(</span><span class="n">FrameLength</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">DataRate</span><span class="o">/</span><span class="mi">10</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">FrameLength</span><span class="o">*</span><span class="mi">8</span> <span class="o">%</span> <span class="p">(</span><span class="n">DataRate</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="c1">//Get the Ceilling</span>
				<span class="n">FrameTime</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">//802.11g DSSS-OFDM PLCP length field calculation.</span>
		<span class="n">N_DBPS</span> <span class="o">=</span> <span class="n">N_DBPSOfRate</span><span class="p">(</span><span class="n">DataRate</span><span class="p">);</span>
		<span class="n">Ceiling</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">FrameLength</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_DBPS</span>
				<span class="o">+</span> <span class="p">(((</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">FrameLength</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="n">N_DBPS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">FrameTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">Ceiling</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FrameTime</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">N_DBPSOfRate</span><span class="p">(</span><span class="n">u16</span> <span class="n">DataRate</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="n">u16</span> <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

	 <span class="k">switch</span><span class="p">(</span><span class="n">DataRate</span><span class="p">)</span>
	 <span class="p">{</span>
	 <span class="k">case</span> <span class="mi">60</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="mi">90</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="mi">120</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="mi">180</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="mi">240</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="mi">360</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">144</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="mi">480</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="mi">540</span>:
	  <span class="n">N_DBPS</span> <span class="o">=</span> <span class="mi">216</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>

	 <span class="nl">default:</span>
	  <span class="k">break</span><span class="p">;</span>
	 <span class="p">}</span>

	 <span class="k">return</span> <span class="n">N_DBPS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl819xU_cmd_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">tx_cmd_urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">tx_cmd_urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">txqueue2outpipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_queue</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tx_queue</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span><span class="s">&quot;%s():Unknown queue ID!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txqueue_to_outpipemap</span><span class="p">[</span><span class="n">tx_queue</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl819xU_tx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>u8            *tx;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">tx_urb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>int            urb<em>buf</em>len;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">int</span> 		<span class="n">idx_pipe</span><span class="p">;</span>
	<span class="n">tx_desc_cmd_819x_usb</span> <span class="o">*</span><span class="n">pdesc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_desc_cmd_819x_usb</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">queue_index</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>printk("\n %s::queue<em>index = %d\n",<strong>FUNCTION</strong>, queue</em>index);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]);</span>
	<span class="n">tx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tx_urb</span><span class="p">){</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pdesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USB_HWDESC_HEADER_LEN</span><span class="p">);</span>
	<span class="cm">/* Tx descriptor ought to be set according to the skb-&gt;cb */</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">FirstSeg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//bFirstSeg;</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">LastSeg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//bLastSeg;</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">CmdInit</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCmdOrInit</span><span class="p">;</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">TxBufferSize</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">txbuf_size</span><span class="p">;</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">LINIP</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bLastIniPkt</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><hr />

<h2>Fill up USB<em>OUT</em>CONTEXT.</h2>

<p>Get index to out pipe from specified QueueID.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef USE_ONE_PIPE</span>
	<span class="n">idx_pipe</span> <span class="o">=</span> <span class="n">txqueue2outpipe</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span><span class="n">queue_index</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">idx_pipe</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef JOHN_DUMP_TXDESC</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;Tx descriptor&gt;--rate %x---&quot;</span><span class="p">,</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%8x &quot;</span><span class="p">,</span> <span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">tx_urb</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span><span class="n">idx_pipe</span><span class="p">),</span> \
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">rtl8192_tx_isr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">){</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Error TX CMD URB, error %d&quot;</span><span class="p">,</span>
				<span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mapping Software/Hardware descriptor queue id to &quot;Queue Select Field&quot;</span>
<span class="cm"> * in TxFwInfo data structure</span>
<span class="cm"> * 2006.10.30 by Emily</span>
<span class="cm"> *</span>
<span class="cm"> * \param QUEUEID       Software Queue</span>
<span class="cm">*/</span>
<span class="n">u8</span> <span class="nf">MapHwQueueToFirmwareQueue</span><span class="p">(</span><span class="n">u8</span> <span class="n">QueueID</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">QueueSelect</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>       <span class="c1">//defualt set to</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">QueueID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BE_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_BE</span><span class="p">;</span>  <span class="c1">//or QSelect = pTcb-&gt;priority;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BK_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_BK</span><span class="p">;</span>  <span class="c1">//or QSelect = pTcb-&gt;priority;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">VO_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_VO</span><span class="p">;</span>  <span class="c1">//or QSelect = pTcb-&gt;priority;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">VI_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_VI</span><span class="p">;</span>  <span class="c1">//or QSelect = pTcb-&gt;priority;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGNT_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_MGNT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BEACON_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_BEACON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>TODO: 2006.10.30 mark other queue selection until we verify it is OK
TODO: Remove Assertions</p>

<h1>if (RTL819X<em>FPGA</em>VER &amp; RTL819X<em>FPGA</em>GUANGAN_070502)</h1></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">TXCMD_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_CMD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><h1>endif</h1></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">HIGH_QUEUE</span>:
			<span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">QSLT_HIGH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;TransmitTCB(): Impossible Queue Selection: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QueueID</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QueueSelect</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">MRateToHwRate8190Pci</span><span class="p">(</span><span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE1M</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MGN_1M</span>:    <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE1M</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_2M</span>:    <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE2M</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_5_5M</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE5_5M</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_11M</span>:   <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE11M</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_6M</span>:    <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE6M</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_9M</span>:    <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE9M</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_12M</span>:   <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE12M</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_18M</span>:   <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE18M</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_24M</span>:   <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE24M</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_36M</span>:   <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE36M</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_48M</span>:   <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE48M</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_54M</span>:   <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATE54M</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>HT rate since here</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">MGN_MCS0</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS0</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS1</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS2</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS2</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS3</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS3</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS4</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS4</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS5</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS5</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS6</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS6</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS7</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS7</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS8</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS8</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS9</span>:  <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS9</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS10</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS11</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS12</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS13</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS14</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS14</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS15</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS15</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="mh">0x20</span><span class="p">)</span>: <span class="n">ret</span> <span class="o">=</span> <span class="n">DESC90_RATEMCS32</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>       <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">u8</span> <span class="nf">QueryIsShort</span><span class="p">(</span><span class="n">u8</span> <span class="n">TxHT</span><span class="p">,</span> <span class="n">u8</span> <span class="n">TxRate</span><span class="p">,</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>   <span class="n">tmp_Short</span><span class="p">;</span>

	<span class="n">tmp_Short</span> <span class="o">=</span> <span class="p">(</span><span class="n">TxHT</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="p">((</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortGI</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="p">((</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortPreamble</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">TxHT</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">TxRate</span> <span class="o">!=</span> <span class="n">DESC90_RATEMCS15</span><span class="p">)</span>
		<span class="n">tmp_Short</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tmp_Short</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_zero_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">tx_urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The tx procedure is just as following,</span>
<span class="cm"> * skb-&gt;cb will contain all the following information,</span>
<span class="cm"> * priority, morefrag, rate, &amp;dev.</span>
<span class="cm"> * */</span>
<span class="kt">short</span> <span class="nf">rtl8192_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">tx_desc_819x_usb</span> <span class="o">*</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_desc_819x_usb</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">tx_fwinfo_819x_usb</span> <span class="o">*</span><span class="n">tx_fwinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">USB_HWDESC_HEADER_LEN</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">tx_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_urb_zero</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>int urb_len;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx_pipe</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>RT<em>DEBUG</em>DATA(COMP<em>SEND, tcb</em>desc, sizeof(cb_desc));
printk("=============> %s\n", <strong>FUNCTION</strong>);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pend</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">]);</span>
	<span class="cm">/* we are locked here so the two atomic_read and inc are executed</span>
<span class="cm">	 * without interleaves</span>
<span class="cm">	 * !!! For debug purpose</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">pend</span> <span class="o">&gt;</span> <span class="n">MAX_TX_URB</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;To discard skb packet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tx_urb</span><span class="p">){</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill Tx firmware info */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_fwinfo</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span><span class="p">));</span>
	<span class="cm">/* DWORD 0 */</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxHT</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxRate</span> <span class="o">=</span> <span class="n">MRateToHwRate8190Pci</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">);</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">EnableCPUDur</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxEnableFwCalcDur</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">Short</span> <span class="o">=</span> <span class="n">QueryIsShort</span><span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxHT</span><span class="p">,</span> <span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxRate</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bAMPDUEnable</span><span class="p">)</span> <span class="p">{</span><span class="c1">//AMPDU enabled</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">AllowAggregation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* DWORD 1 */</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxMF</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxAMD</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_density</span><span class="o">&amp;</span><span class="mh">0x07</span><span class="p">;</span><span class="c1">//ampdudensity</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">AllowAggregation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* DWORD 1 */</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxMF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RxAMD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Protection mode related */</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">CtsEnable</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCTSEnable</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsSTBC</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSSTBC</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsRate</span> <span class="o">=</span>  <span class="n">MRateToHwRate8190Pci</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span><span class="p">);</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsSubcarrier</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RTSSC</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsBandwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="p">((</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSBW</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsShort</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">RtsHT</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSUseShortPreamble</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span>\
				<span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSUseShortGI</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set Bandwidth and sub-channel settings. */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentChannelBW</span> <span class="o">==</span> <span class="n">HT_CHANNEL_WIDTH_20_40</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bPacketBW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxBandwidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxSubCarrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">//By SD3&#39;s Jerry suggestion, use duplicated mode</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxBandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxSubCarrier</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nCur40MhzPrimeSC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxBandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">TxSubCarrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef USB_TX_DRIVER_AGGREGATION_ENABLE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">drv_agg_enable</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">tx_fwinfo</span><span class="o">-&gt;</span><span class="n">Tx_INFO_RSVD</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">DrvAggrNum</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Fill Tx descriptor */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_desc_819x_usb</span><span class="p">));</span>
	<span class="cm">/* DWORD 0 */</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">LINIP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">CmdInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">Offset</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="cp">#ifdef USB_TX_DRIVER_AGGREGATION_ENABLE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">drv_agg_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">PktSize</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">pkt_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">PktSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">TX_PACKET_SHIFT_BYTES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*DWORD 1*/</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">SecCAMID</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">RATid</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span><span class="p">;</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>MPDUOverhead = 0;</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bHwSec</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">case</span> <span class="n">KEY_TYPE_WEP40</span>:
					<span class="k">case</span> <span class="n">KEY_TYPE_WEP104</span>:
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						 <span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">KEY_TYPE_TKIP</span>:
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						 <span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">KEY_TYPE_CCMP</span>:
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						 <span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">KEY_TYPE_NA</span>:
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">SecType</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
						 <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">NoEnc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						 <span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">QueueSelect</span> <span class="o">=</span> <span class="n">MapHwQueueToFirmwareQueue</span><span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">TxFWInfoSize</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span><span class="p">);</span>

	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">DISFB</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">USERATE</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span><span class="p">;</span>

	<span class="cm">/* Fill fields that are required to be initialized in all of the descriptors */</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>DWORD 0</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">FirstSeg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">LastSeg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef USB_TX_DRIVER_AGGREGATION_ENABLE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">drv_agg_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">TxBufferSize</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">pkt_size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_fwinfo_819x_usb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>DWORD 2</p></td><td class="code"><div class="highlight"><pre>		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">TxBufferSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">USB_HWDESC_HEADER_LEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Get index to out pipe from specified QueueID */</span>
<span class="cp">#ifndef USE_ONE_PIPE</span>
	<span class="n">idx_pipe</span> <span class="o">=</span> <span class="n">txqueue2outpipe</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">idx_pipe</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>RT<em>DEBUG</em>DATA(COMP<em>SEND,tx</em>fwinfo,sizeof(tx<em>fwinfo</em>819x<em>usb));
RT</em>DEBUG<em>DATA(COMP</em>SEND,tx<em>desc,sizeof(tx</em>desc<em>819x</em>usb));</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* To submit bulk urb */</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">tx_urb</span><span class="p">,</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span><span class="n">idx_pipe</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">rtl8192_tx_isr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>we need to send 0 byte packet whenever 512N bytes/64N(HIGN SPEED/NORMAL SPEED) bytes packet has been transmitted. Otherwise, it will be halt to wait for another packet. WB. 2008.08.27</p></td><td class="code"><div class="highlight"><pre>		<span class="n">bool</span> <span class="n">bSend0Byte</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">%</span> <span class="mi">512</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">bSend0Byte</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">bSend0Byte</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bSend0Byte</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">tx_urb_zero</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tx_urb_zero</span><span class="p">){</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc urb for zero byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">tx_urb_zero</span><span class="p">,</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span><span class="n">idx_pipe</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">tx_zero_isr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">tx_urb_zero</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">){</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Error TX URB for zero byte %d, error %d&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">]),</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Error TX URB %d, error %d&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">]),</span>
				<span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl8192_usb_initendpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX_RX_URB</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#ifndef JACKSON_NEW_RX</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">MAX_RX_URB</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RX_URB_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">RX_URB_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef THOMAS_BEACON</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">oldaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">newaddr</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldaddr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">oldaddr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldaddr</span><span class="p">;</span>
	<span class="n">align</span> <span class="o">=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">oldaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">align</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newaddr</span> <span class="o">=</span> <span class="n">oldaddr</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">align</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">newaddr</span> <span class="o">=</span> <span class="n">oldaddr</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">newaddr</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_RX_URB</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">MAX_RX_URB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">destroy</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">_middle</span><span class="p">;</span>


<span class="nl">destroy:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DMESGE</span><span class="p">(</span><span class="s">&quot;Endpoint Alloc Failure&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


<span class="nl">_middle:</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;End of initendpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cp">#ifdef THOMAS_BEACON</span>
<span class="kt">void</span> <span class="nf">rtl8192_usb_deleteendpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">){</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">MAX_RX_URB</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldaddr</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="nf">rtl8192_usb_deleteendpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifndef JACKSON_NEW_RX</span>

	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">){</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">MAX_RX_URB</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldaddr</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">oldaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pp_rxskb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtl8192_update_ratr_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">rtl8192_link_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>int i;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>write<em>nic</em>word(dev, BCN<em>INTR</em>ITV, net->beacon_interval);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">rtl8192_net_update</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8192_update_ratr_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>add this as in pure N mode, wep encryption will use software way, but there is no chance to set this as wep will not set group key in wext. WB.2008.07.08</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">KEY_TYPE_WEP40</span> <span class="o">==</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">KEY_TYPE_WEP104</span> <span class="o">==</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">))</span>
		<span class="n">EnableHWSecurityConfig8192</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*update timing params*/</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>RT<em>TRACE(COMP</em>CH, "========>%s(), chan:%d\n", <strong>FUNCTION</strong>, priv->chan);
rtl8192<em>set</em>chan(dev, priv->chan);</p></td><td class="code"><div class="highlight"><pre>	 <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCR</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
                        <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">RCR_CBSSID</span><span class="p">;</span>
                <span class="k">else</span>
                        <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RCR_CBSSID</span><span class="p">;</span>
                <span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>rtl8192<em>set</em>rxconf(dev);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_qos_parameters</span> <span class="n">def_qos_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span><span class="cm">/* cw_min */</span>
        <span class="p">{</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">},</span><span class="cm">/* cw_max */</span>
        <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span><span class="cm">/* aifs */</span>
        <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span><span class="cm">/* flags */</span>
        <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="cm">/* tx_op_limit */</span>
<span class="p">};</span>


<span class="kt">void</span> <span class="nf">rtl8192_update_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span> <span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span> <span class="n">update_beacon_wq</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
 	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span><span class="o">*</span> <span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">)</span>
		<span class="n">HTUpdateSelfAndPeerSetting</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentRT2RTLongSlotTime</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTLongSlotTime</span><span class="p">;</span>
	<span class="n">rtl8192_update_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">* background support to run QoS activate functionality</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="n">WDCAPARA_ADD</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">EDCAPARA_BE</span><span class="p">,</span><span class="n">EDCAPARA_BK</span><span class="p">,</span><span class="n">EDCAPARA_VI</span><span class="p">,</span><span class="n">EDCAPARA_VO</span><span class="p">};</span>
<span class="kt">void</span> <span class="nf">rtl8192_qos_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span> <span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span> <span class="n">qos_activate</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_qos_parameters</span> <span class="o">*</span><span class="n">qos_parameters</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>u32 size = sizeof(struct ieee80211<em>qos</em>parameters);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span>  <span class="n">u1bAIFS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u4bAcParam</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

       <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span><span class="s">&quot;qos active process with associate response received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* It better set slot time at first */</span>
	<span class="cm">/* For we just support b/g mode at present, let the slot time at 9/20 selection */</span>
	<span class="cm">/* update the ac parameter to related registers */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>Mode G/A: slotTimeTimer = 9; Mode B: 20</p></td><td class="code"><div class="highlight"><pre>		<span class="n">u1bAIFS</span> <span class="o">=</span> <span class="n">qos_parameters</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">mode</span><span class="o">&amp;</span><span class="p">(</span><span class="n">IEEE_G</span><span class="o">|</span><span class="n">IEEE_N_24G</span><span class="p">))</span> <span class="o">?</span><span class="mi">9</span><span class="o">:</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">aSifsTime</span><span class="p">;</span>
		<span class="n">u4bAcParam</span> <span class="o">=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)(</span><span class="n">qos_parameters</span><span class="o">-&gt;</span><span class="n">tx_op_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_TXOP_LIMIT_OFFSET</span><span class="p">)</span><span class="o">|</span>
				<span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">qos_parameters</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_ECW_MAX_OFFSET</span><span class="p">)</span><span class="o">|</span>
				<span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">qos_parameters</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_ECW_MIN_OFFSET</span><span class="p">)</span><span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">u1bAIFS</span> <span class="o">&lt;&lt;</span> <span class="n">AC_PARAM_AIFS_OFFSET</span><span class="p">));</span>

		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WDCAPARA_ADD</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">u4bAcParam</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>write<em>nic</em>dword(dev, WDCAPARA_ADD[i], 0x005e4332);</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

<span class="nl">success:</span>
       <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_qos_handle_probe_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">active_network</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_parameters</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span><span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">))</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">!=</span>
				 <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
			<span class="n">RT_TRACE</span> <span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span> <span class="s">&quot;QoS parameters change call &quot;</span>
					<span class="s">&quot;qos_activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>\
		       <span class="o">&amp;</span><span class="n">def_qos_parameters</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span> <span class="s">&quot;QoS was disabled call qos_activate </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* handle and manage frame from beacon and probe response */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_handle_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_beacon</span> <span class="o">*</span> <span class="n">beacon</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span> <span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8192_qos_handle_probe_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">network</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_beacon_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* handling the beaconing responses. if we get different QoS setting</span>
<span class="cm">* off the network from the associated setting, adjust the QoS</span>
<span class="cm">* setting</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_qos_association_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_parameters</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">network</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span><span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>\
			 <span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>\
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_qos_parameters</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		 <span class="p">{</span>
			<span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* update qos parameter for current network */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span> \
				 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span> <span class="o">=</span> \
				 <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>\
		       <span class="o">&amp;</span><span class="n">def_qos_parameters</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span> <span class="s">&quot;%s: network-&gt;flags = %d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_qos_param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_handle_assoc_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_assoc_response_frame</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_qos_association_resp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_update_ratr_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>POCTET<em>STRING    posLegacyRate,
u8*            pMcsRate)
PRT</em>WLAN_STA    pEntry)</p></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">pMcsRate</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dot11HTOperationalRateSet</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>struct ieee80211<em>network *net = &amp;ieee->current</em>network;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u32</span> <span class="n">ratr_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rtl8192_config_rate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">ratr_value</span><span class="p">));</span>
	<span class="n">ratr_value</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">pMcsRate</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>switch (net->mode)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">IEEE_A</span>:
			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x00000FF0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE_B</span>:
			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0000000F</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE_G</span>:
			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x00000FF7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE_N_24G</span>:
		<span class="k">case</span> <span class="n">IEEE_N_5G</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">PeerMimoPs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//MIMO_PS_STATIC</span>
				<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0007F007</span><span class="p">;</span>
			<span class="k">else</span><span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span>
					<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x000FF007</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0F81F007</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="mh">0x0FFFFFFF</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurTxBW40MHz</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurShortGI40MHz</span><span class="p">){</span>
		<span class="n">ratr_value</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurTxBW40MHz</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurShortGI20MHz</span><span class="p">){</span>
		<span class="n">ratr_value</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RATR0</span><span class="o">+</span><span class="n">rate_index</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">ratr_value</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UFWP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">ccmp_ie</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0xf2</span><span class="p">,</span><span class="mh">0x04</span><span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">ccmp_rsn_ie</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">};</span>
<span class="n">bool</span> <span class="nf">GetNmodeSupportBySecCfg8192</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_network</span> <span class="o">*</span> <span class="n">network</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wpa_ie_len</span><span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_crypt_data</span><span class="o">*</span> <span class="n">crypt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_keyidx</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>we use connecting AP's capability instead of only security config on our driver to distinguish whether it should use N mode or G mode</p></td><td class="code"><div class="highlight"><pre>	<span class="n">encrypt</span> <span class="o">=</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;WEP&quot;</span><span class="p">)));</span>

	<span class="cm">/* simply judge  */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">encrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wpa_ie_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* wep encryption, no N mode setting */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>} else if((wpa<em>ie</em>len != 0)&amp;&amp;(memcmp(&amp;(ieee->wpa<em>ie[14]),ccmp</em>ie,4))) {</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">wpa_ie_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* parse pairwise key type */</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>if((pairwisekey = WEP40)||(pairwisekey = WEP104)||(pairwisekey = TKIP))</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xdd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">14</span><span class="p">]),</span><span class="n">ccmp_ie</span><span class="p">,</span><span class="mi">4</span><span class="p">)))</span> <span class="o">||</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">ccmp_rsn_ie</span><span class="p">,</span> <span class="mi">4</span><span class="p">))))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">GetHalfNmodeSupportByAPs819xUsb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span>			<span class="n">Reval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bHalfWirelessN24GMode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">Reval</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">Reval</span> <span class="o">=</span>  <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">Reval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_refresh_supportrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>we do not consider set support rate for ABG mode, only HT MCS rate is set here.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_24G</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11HTOperationalRateSet</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">RegHTSuppRateSet</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>RT<em>DEBUG</em>DATA(COMP<em>INIT, ieee->RegHTSuppRateSet, 16);
RT</em>DEBUG<em>DATA(COMP</em>INIT, ieee->Regdot11HTOperationalRateSet, 16);</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11HTOperationalRateSet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">rtl8192_getSupportedWireleeMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">RF_8225</span>:
		<span class="k">case</span> <span class="n">RF_8256</span>:
		<span class="k">case</span> <span class="n">RF_PSEUDO_11N</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIRELESS_MODE_N_24G</span><span class="o">|</span><span class="n">WIRELESS_MODE_G</span><span class="o">|</span><span class="n">WIRELESS_MODE_B</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RF_8258</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIRELESS_MODE_A</span><span class="o">|</span><span class="n">WIRELESS_MODE_N_5G</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">rtl8192_SetWirelessMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">wireless_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">bSupportMode</span> <span class="o">=</span> <span class="n">rtl8192_getSupportedWireleeMode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wireless_mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">wireless_mode</span><span class="o">&amp;</span><span class="n">bSupportMode</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_A</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_A</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_G</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_B</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;%s(), No valid wireless mode supported, SupportedWirelessMode(%x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">bSupportMode</span><span class="p">);</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef TO_DO_LIST </span><span class="c1">//// TODO: this function doesn&#39;t work well at this time, we should wait for FPGA</span>
	<span class="n">ActUpdateChannelAccessSetting</span><span class="p">(</span> <span class="n">pAdapter</span><span class="p">,</span> <span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">CurrentWirelessMode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pAdapter</span><span class="o">-&gt;</span><span class="n">MgntInfo</span><span class="p">.</span><span class="n">Info8185</span><span class="p">.</span><span class="n">ChannelAccessSetting</span> <span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">wireless_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wireless_mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">)</span> <span class="o">||</span>  <span class="p">(</span><span class="n">wireless_mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Current Wireless Mode is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wireless_mode</span><span class="p">);</span>
	<span class="n">rtl8192_refresh_supportrate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>init priv variables here. only non_zero value should be initialized here.</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_variable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_8192</span> <span class="o">=</span> <span class="n">NIC_8192U</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//set to channel 1</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">;</span> <span class="c1">//SET AUTO</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ieee_up</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_rts</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_RTS</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_data</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_DATA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rts</span> <span class="o">=</span> <span class="n">DEFAULT_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span> <span class="c1">//11 mbps</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">short_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CckPwEnl</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>for silent reset</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">IrpPendingCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDisableNormalResetCheck</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">FwRWRF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 	<span class="c1">//we don&#39;t use FW read/write RF until stable firmware is available.</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">DEFAULT_BEACONINTERVAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_features</span>  <span class="o">=</span> <span class="n">IEEE_SOFTMAC_SCAN</span> <span class="o">|</span>
		<span class="n">IEEE_SOFTMAC_ASSOCIATE</span> <span class="o">|</span> <span class="n">IEEE_SOFTMAC_PROBERQ</span> <span class="o">|</span>
		<span class="n">IEEE_SOFTMAC_PROBERS</span> <span class="o">|</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span> <span class="o">|</span>
		<span class="n">IEEE_SOFTMAC_BEACONS</span><span class="p">;</span><span class="c1">//added by amy 080604 //|  //IEEE_SOFTMAC_SINGLE_QUEUE;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">IEEE80211_CCK_MODULATION</span> <span class="o">|</span> <span class="n">IEEE80211_OFDM_MODULATION</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">start_send_beacons</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//rtl819xusb_beacon_tx;//-by amy 080604</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stop_send_beacons</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//rtl8192_beacon_stop;//-by amy 080604</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span> <span class="o">=</span> <span class="n">rtl8192_hard_start_xmit</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">set_chan</span> <span class="o">=</span> <span class="n">rtl8192_set_chan</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">link_change</span> <span class="o">=</span> <span class="n">rtl8192_link_change</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span> <span class="o">=</span> <span class="n">rtl8192_hard_data_xmit</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span> <span class="o">=</span> <span class="n">rtl8192_data_hard_stop</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span> <span class="o">=</span> <span class="n">rtl8192_data_hard_resume</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">init_wmmparam_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">DEFAULT_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">check_nic_enough_desc</span> <span class="o">=</span> <span class="n">check_nic_enough_desc</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">=</span> <span class="n">TX_PACKET_SHIFT_BYTES</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">qos_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>added by WB
priv->ieee80211->SwChnlByTimerHandler = rtl8192<em>phy</em>SwChnl;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">SetBWModeHandler</span> <span class="o">=</span> <span class="n">rtl8192_SetBWMode</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">handle_assoc_response</span> <span class="o">=</span> <span class="n">rtl8192_handle_assoc_response</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">handle_beacon</span> <span class="o">=</span> <span class="n">rtl8192_handle_beacon</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>added by david</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">GetNmodeSupportBySecCfg</span> <span class="o">=</span> <span class="n">GetNmodeSupportBySecCfg8192</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">GetHalfNmodeSupportByAPsHandler</span> <span class="o">=</span> <span class="n">GetHalfNmodeSupportByAPs819xUsb</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span> <span class="o">=</span> <span class="n">rtl8192_SetWirelessMode</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>added by amy</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">InitialGainHandler</span> <span class="o">=</span> <span class="n">InitialGain819xUsb</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">USB</span><span class="p">;</span>
<span class="cp">#ifdef TO_DO_LIST</span>
	<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bInHctTest</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">ShortRetryLimit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">LongRetryLimit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ShortRetryLimit</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LongRetryLimit</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">enable_gpio0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TransmitConfig</span> <span class="o">=</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>TCR<em>DurProcMode |    //for RTL8185B, duration setting by HW
?    TCR</em>DISReqQsize |</p></td><td class="code"><div class="highlight"><pre>		<span class="p">(</span><span class="n">TCR_MXDMA_2048</span><span class="o">&lt;&lt;</span><span class="n">TCR_MXDMA_OFFSET</span><span class="p">)</span><span class="o">|</span>  <span class="c1">// Max DMA Burst Size per Tx DMA Burst, 7: reserved.</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ShortRetryLimit</span><span class="o">&lt;&lt;</span><span class="n">TCR_SRL_OFFSET</span><span class="p">)</span><span class="o">|</span>	<span class="c1">// Short retry limit</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LongRetryLimit</span><span class="o">&lt;&lt;</span><span class="n">TCR_LRL_OFFSET</span><span class="p">)</span> <span class="o">|</span>	<span class="c1">// Long retry limit</span>
		<span class="p">(</span><span class="nb">false</span> <span class="o">?</span> <span class="n">TCR_SAT</span><span class="o">:</span> <span class="mi">0</span><span class="p">);</span>	<span class="c1">// FALSE: HW provides PLCP length and LENGEXT, TRUE: SW provides them</span>
<span class="cp">#ifdef TO_DO_LIST</span>
	<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bInHctTest</span><span class="p">)</span>
		<span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span>	<span class="o">=</span>	<span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">CSMethod</span> <span class="o">|</span>
						<span class="n">RCR_AMF</span> <span class="o">|</span> <span class="n">RCR_ADF</span> <span class="o">|</span>	<span class="c1">//RCR_AAP | 	//accept management/data</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>guangan200710</p></td><td class="code"><div class="highlight"><pre>						<span class="n">RCR_ACF</span> <span class="o">|</span>	<span class="c1">//accept control frame for SW AP needs PS-poll, 2005.07.07, by rcnjko.</span>
						<span class="n">RCR_AB</span> <span class="o">|</span> <span class="n">RCR_AM</span> <span class="o">|</span> <span class="n">RCR_APM</span> <span class="o">|</span>		<span class="c1">//accept BC/MC/UC</span>
						<span class="n">RCR_AICV</span> <span class="o">|</span> <span class="n">RCR_ACRC32</span> <span class="o">|</span> 		<span class="c1">//accept ICV/CRC error packet</span>
						<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="n">RCR_MXDMA_OFFSET</span><span class="p">)</span> <span class="o">|</span> <span class="c1">// Max DMA Burst Size per Rx DMA Burst, 7: unlimited.</span>
						<span class="p">(</span><span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span><span class="o">&lt;&lt;</span><span class="n">RCR_FIFO_OFFSET</span><span class="p">)</span> <span class="o">|</span> <span class="c1">// Rx FIFO Threshold, 7: No Rx threshold.</span>
						<span class="p">(</span><span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">?</span> <span class="n">RCR_OnlyErlPkt</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>

<span class="cp">#endif</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span>	<span class="o">=</span>
		<span class="n">RCR_AMF</span> <span class="o">|</span> <span class="n">RCR_ADF</span> <span class="o">|</span>		<span class="c1">//accept management/data</span>
		<span class="n">RCR_ACF</span> <span class="o">|</span>			<span class="c1">//accept control frame for SW AP needs PS-poll, 2005.07.07, by rcnjko.</span>
		<span class="n">RCR_AB</span> <span class="o">|</span> <span class="n">RCR_AM</span> <span class="o">|</span> <span class="n">RCR_APM</span> <span class="o">|</span>	<span class="c1">//accept BC/MC/UC</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>RCR<em>AICV | RCR</em>ACRC32 |     //accept ICV/CRC error packet</p></td><td class="code"><div class="highlight"><pre>		<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="n">RCR_MXDMA_OFFSET</span><span class="p">)</span><span class="o">|</span> <span class="c1">// Max DMA Burst Size per Rx DMA Burst, 7: unlimited.</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span><span class="o">&lt;&lt;</span><span class="n">RX_FIFO_THRESHOLD_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="c1">// Rx FIFO Threshold, 7: No Rx threshold.</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EarlyRxThreshold</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">?</span> <span class="n">RCR_ONLYERLPKT</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AcmControl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rt_firmware</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="p">)</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rt_firmware</span><span class="p">));</span>

	<span class="cm">/* rx related queue */</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">);</span>

	<span class="cm">/* Tx related queue */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_aggQ</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_drv_aggQ</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span> <span class="o">=</span> <span class="n">rtl8192_phy_SwChnl</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>init lock here</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span><span class="c1">//added by thomas</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>spin<em>lock</em>init(&amp;priv->rf_lock);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_sem</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span>  <span class="kt">void</span>    <span class="n">rtl819x_watchdog_wqcallback</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">rtl8192_irq_rx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>init tasklet and wait_queue here. only 2.6 above kernel is considered</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DRV_NAME &quot;wlan0&quot;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span> <span class="o">=</span> <span class="n">create_workqueue</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">,</span> <span class="n">rtl8192_restart</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>INIT<em>DELAYED</em>WORK(&amp;priv->watch<em>dog</em>wq, hal<em>dm</em>watchdog);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_wq</span><span class="p">,</span> <span class="n">rtl819x_watchdog_wqcallback</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpower_tracking_wq</span><span class="p">,</span>  <span class="n">dm_txpower_trackingcallback</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>INIT<em>DELAYED</em>WORK(&amp;priv->gpio<em>change</em>rf<em>wq,  dm</em>gpio<em>change</em>rf_callback);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfpath_check_wq</span><span class="p">,</span>  <span class="n">dm_rf_pathcheck_workitemcallback</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_beacon_wq</span><span class="p">,</span> <span class="n">rtl8192_update_beacon</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">initialgain_operate_wq</span><span class="p">,</span> <span class="n">InitialGainOperateWorkItemCallBack</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>INIT<em>WORK(&amp;priv->SwChnlWorkItem,  rtl8192</em>SwChnl<em>WorkItem);
INIT</em>WORK(&amp;priv->SetBWModeWorkItem,  rtl8192_SetBWModeWorkItem);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">,</span> <span class="n">rtl8192_qos_activate</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">rtl8192_irq_rx_tasklet</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_get_eeprom_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">curCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;===========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="n">curCR</span> <span class="o">=</span> <span class="n">read_nic_word_E</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">EPROM_CMD</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;read from Reg EPROM_CMD(%x):%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">EPROM_CMD</span><span class="p">,</span> <span class="n">curCR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>whether need I consider BIT5?</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">epromtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">curCR</span> <span class="o">&amp;</span> <span class="n">Cmd9346CR_9356SEL</span><span class="p">)</span> <span class="o">?</span> <span class="n">EPROM_93c56</span> <span class="o">:</span> <span class="n">EPROM_93c46</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;&lt;===========%s(), epromtype:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">epromtype</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>used to swap endian. as ntohl &amp; htonl are not necessary to swap endian, so use this instead.</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">endian_swap</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_read_eeprom_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">wEPROM_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bMac_Tmp_Addr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">bLoad_From_EEPOM</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tmpValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;===========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="n">wEPROM_ID</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//first read EEPROM ID out;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;EEPROM ID is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wEPROM_ID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wEPROM_ID</span> <span class="o">!=</span> <span class="n">RTL8190_EEPROM_ID</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;EEPROM ID is invalid(is 0x%x(should be 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wEPROM_ID</span><span class="p">,</span> <span class="n">RTL8190_EEPROM_ID</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">bLoad_From_EEPOM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_VID</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_vid</span> <span class="o">=</span> <span class="n">endian_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmpValue</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_pid</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_PID</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_ChannelPlan</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_ChannelPlan</span> <span class="o">=</span><span class="p">((</span><span class="n">tmpValue</span><span class="o">&amp;</span><span class="mh">0xff00</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">btxpowerdata_readfromEEPORM</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_CustomerID</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_Customer_ID</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_vid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_8192_version</span> <span class="o">=</span> <span class="n">VERSION_819xU_B</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_ChannelPlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_CustomerID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;vid:0x%4x, pid:0x%4x, CustomID:0x%2x, ChanPlan:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_vid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_pid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_CustomerID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_ChannelPlan</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>set channelplan from eeprom</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_ChannelPlan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">EEPROM_NODE_ADDRESS_BYTE_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">bMac_Tmp_Addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>should I set IDR0 here?</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;MAC addr:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">=</span> <span class="n">RTL819X_DEFAULT_RF_TYPE</span><span class="p">;</span> <span class="c1">//default 1T2R</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span> <span class="o">=</span> <span class="n">RF_8256</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_8192_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">VERSION_819xU_A</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>read Tx power gain offset of legacy OFDM to HT rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerDiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPowerDiff</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerDiff</span> <span class="o">=</span> <span class="n">EEPROM_Default_TxPower</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;TxPowerDiff:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerDiff</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>read ThermalMeter from EEPROM</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMThermalMeter</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_ThermalMeter</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0x00ff</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMThermalMeter</span> <span class="o">=</span> <span class="n">EEPROM_Default_ThermalMeter</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;ThermalMeter:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMThermalMeter</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>vivi, for tx power track</p></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TSSI_13dBm</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMThermalMeter</span> <span class="o">*</span><span class="mi">100</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>read antenna tx power offset of B/C/D to A from EEPROM</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMPwDiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_PwDiff</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0x0f00</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMPwDiff</span> <span class="o">=</span> <span class="n">EEPROM_Default_PwDiff</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;TxPwDiff:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMPwDiff</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>Read CrystalCap from EEPROM</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMCrystalCap</span> <span class="o">=</span> <span class="p">(</span><span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_CrystalCap</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMCrystalCap</span> <span class="o">=</span> <span class="n">EEPROM_Default_CrystalCap</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;CrystalCap = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMCrystalCap</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>get per-channel Tx power level</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROM_Def_Ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPwIndex_Ver</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff00</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROM_Def_Ver</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;EEPROM_DEF_VER:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROM_Def_Ver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROM_Def_Ver</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//old eeprom definition</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK</span> <span class="o">=</span> <span class="p">(</span><span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPwIndex_CCK</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;CCK Tx Power Levl: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPwIndex_OFDM_24G</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">EEPROM_TxPwIndex_OFDM_24G</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">tmpValue</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">tmpValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmpValue</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">tmpValue</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmpValue</span><span class="p">;</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;OFDM 2.4G Tx Power Level, Index %d = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span><span class="c1">//end if EEPROM_DEF_VER == 0</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROM_Def_Ver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPwIndex_CCK_V1</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmpValue</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK_V1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmpValue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPwIndex_CCK_V1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="mh">0x1010</span><span class="p">;</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK_V1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">=</span> <span class="n">tmpValue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPwIndex_OFDM_24G_V1</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="mh">0x1010</span><span class="p">;</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">=</span> <span class="n">tmpValue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bLoad_From_EEPOM</span><span class="p">)</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="n">eprom_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">EEPROM_TxPwIndex_OFDM_24G_V1</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tmpValue</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmpValue</span><span class="p">;</span>
		<span class="p">}</span><span class="c1">//endif EEPROM_Def_Ver == 1</span></pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>update HAL variables</p></td><td class="code"><div class="highlight"><pre>		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelOFDM24G</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">9</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelOFDM24G</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelOFDM24G</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROM_Def_Ver</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">)</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelCCK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">9</span><span class="p">)</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelCCK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelCCK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelOFDM24G</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROM_Def_Ver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">)</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelCCK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK_V1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">9</span><span class="p">)</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelCCK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK_V1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="k">else</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerLevelCCK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerLevelCCK_V1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span><span class="c1">//end update HAL variables</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxPowerDiff</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMPwDiff</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>Antenna B gain offset to antenna A, bit0~3</p></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AntennaTxPwDiff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerDiff</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>Antenna C gain offset to antenna A, bit4~7</p></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AntennaTxPwDiff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMTxPowerDiff</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>CrystalCap, bit12~15</p></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CrystalCap</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMCrystalCap</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>ThermalMeter, bit0~3 for RFIC1, bit4~7 for RFIC2
92U does not enable TX power tracking.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ThermalMeter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">EEPROMThermalMeter</span><span class="p">;</span>
	<span class="p">}</span><span class="c1">//end if VersionID == VERSION_819xU_A</span></pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>added by vivi, for dlink led, 20080416</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_CustomerID</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">EEPROM_CID_RUNTOP</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CustomerID</span> <span class="o">=</span> <span class="n">RT_CID_819x_RUNTOP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EEPROM_CID_DLINK</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CustomerID</span> <span class="o">=</span> <span class="n">RT_CID_DLINK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CustomerID</span> <span class="o">=</span> <span class="n">RT_CID_DEFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CustomerID</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">RT_CID_819x_RUNTOP</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LedStrategy</span> <span class="o">=</span> <span class="n">SW_LED_MODE2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RT_CID_DLINK</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LedStrategy</span> <span class="o">=</span> <span class="n">SW_LED_MODE4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LedStrategy</span> <span class="o">=</span> <span class="n">SW_LED_MODE0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>


	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">1T2R config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">2T4R config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>2008/01/16 MH We can only know RF type in the function. So we have to init
DIG RATR table again.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">init_rate_adaptive</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>we need init DIG RATR table here again.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_EPROM</span><span class="p">,</span> <span class="s">&quot;&lt;===========%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl8192_get_channel_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span> <span class="o">&gt;</span> <span class="n">COUNTRY_CODE_GLOBAL_DOMAIN</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rtl8180_init:Error channel plan! Set to default.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Channel plan is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span><span class="p">);</span>

	<span class="n">rtl819x_set_channel_map</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl8192_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Stats</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txqueue_to_outpipemap</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span>
<span class="cp">#ifdef PIPE12</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">queuetopipe</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txqueue_to_outpipemap</span><span class="p">,</span><span class="n">queuetopipe</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span>
<span class="cm">/*		for(i=0;i&lt;9;i++)</span>
<span class="cm">			printk(&quot;%d &quot;,priv-&gt;txqueue_to_outpipemap[i]);</span>
<span class="cm">		printk(&quot;\n&quot;);*/</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">queuetopipe</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">};</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txqueue_to_outpipemap</span><span class="p">,</span><span class="n">queuetopipe</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span>
<span class="cm">/*		for(i=0;i&lt;9;i++)</span>
<span class="cm">			printk(&quot;%d &quot;,priv-&gt;txqueue_to_outpipemap[i]);</span>
<span class="cm">		printk(&quot;\n&quot;);*/</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">rtl8192_init_priv_variable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_init_priv_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">rtl8192_init_priv_task</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_get_eeprom_size</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_read_eeprom_info</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_get_channel_map</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_hal_dm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">watch_dog_timer_callback</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rtl8192_usb_initendpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;Endopoints initialization failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>rtl8192<em>adapter</em>start(dev);</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef DEBUG_EPROM</span>
	<span class="n">dump_eprom</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *function:  This function actually only set RRSR, RATR and BW_OPMODE registers</span>
<span class="cm"> *	     not to do all the hw config as its name says</span>
<span class="cm"> *   input:  net_device dev</span>
<span class="cm"> *  output:  none</span>
<span class="cm"> *  return:  none</span>
<span class="cm"> *  notice:  This part need to modified according to the rate set we filtered</span>
<span class="cm"> * ****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">rtl8192_hwconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regRATR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">regRRSR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regBwOpMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">regTmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>Set RRSR, RATR, and BW_OPMODE registers</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_B</span>:
		<span class="n">regBwOpMode</span> <span class="o">=</span> <span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
		<span class="n">regRATR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span><span class="p">;</span>
		<span class="n">regRRSR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_A</span>:
		<span class="n">regBwOpMode</span> <span class="o">=</span> <span class="n">BW_OPMODE_5G</span> <span class="o">|</span><span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
		<span class="n">regRATR</span> <span class="o">=</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="n">regRRSR</span> <span class="o">=</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_G</span>:
		<span class="n">regBwOpMode</span> <span class="o">=</span> <span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
		<span class="n">regRATR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="n">regRRSR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_AUTO</span>:
<span class="cp">#ifdef TO_DO_LIST</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bInHctTest</span><span class="p">)</span>
		<span class="p">{</span>
		    <span class="n">regBwOpMode</span> <span class="o">=</span> <span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
		    <span class="n">regRATR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		    <span class="n">regRRSR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
		    <span class="n">regBwOpMode</span> <span class="o">=</span> <span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
		    <span class="n">regRATR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_1SS</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_2SS</span><span class="p">;</span>
		    <span class="n">regRRSR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_N_24G</span>:</pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>It support CCK rate by default.
CCK rate will be filtered out only when associated AP does not support it.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">regBwOpMode</span> <span class="o">=</span> <span class="n">BW_OPMODE_20MHZ</span><span class="p">;</span>
			<span class="n">regRATR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_1SS</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_2SS</span><span class="p">;</span>
			<span class="n">regRRSR</span> <span class="o">=</span> <span class="n">RATE_ALL_CCK</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WIRELESS_MODE_N_5G</span>:
		<span class="n">regBwOpMode</span> <span class="o">=</span> <span class="n">BW_OPMODE_5G</span><span class="p">;</span>
		<span class="n">regRATR</span> <span class="o">=</span> <span class="n">RATE_ALL_OFDM_AG</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_1SS</span> <span class="o">|</span> <span class="n">RATE_ALL_OFDM_2SS</span><span class="p">;</span>
		<span class="n">regRRSR</span> <span class="o">=</span> <span class="n">RATE_ALL_OFDM_AG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BW_OPMODE</span><span class="p">,</span> <span class="n">regBwOpMode</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">ratr_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ratr_value</span> <span class="o">=</span> <span class="n">regRATR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">==</span> <span class="n">RF_1T2R</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ratr_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RATE_ALL_OFDM_2SS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RATR0</span><span class="p">,</span> <span class="n">ratr_value</span><span class="p">);</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UFWP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">regTmp</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x313</span><span class="p">);</span>
	<span class="n">regRRSR</span> <span class="o">=</span> <span class="p">((</span><span class="n">regTmp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regRRSR</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RRSR</span><span class="p">,</span> <span class="n">regRRSR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>Set Retry Limit here</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RETRY_LIMIT</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ShortRetryLimit</span> <span class="o">&lt;&lt;</span> <span class="n">RETRY_LIMIT_SHORT_SHIFT</span> <span class="o">|</span> \
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LongRetryLimit</span> <span class="o">&lt;&lt;</span> <span class="n">RETRY_LIMIT_LONG_SHIFT</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>Set Contention Window here</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>Set Tx AGC</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>Set Tx Antenna including Feedback control</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>Set Auto Rate fallback control</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span></pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>InitializeAdapter and PhyCfg</p></td><td class="code"><div class="highlight"><pre><span class="n">bool</span> <span class="nf">rtl8192_adapter_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dwRegRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">init_status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;====&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Rf_Mode</span> <span class="o">=</span> <span class="n">RF_OP_By_SW_3wire</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>for ASIC power on sequence</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_byte_E</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">write_nic_byte_E</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">write_nic_byte_E</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">write_nic_byte_E</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><h1>ifdef TO<em>DO</em>LIST</h1></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="o">-&gt;</span><span class="n">firmware_status</span> <span class="o">=</span> <span class="n">FW_STATUS_0_INIT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>config CPUReset Register
Firmware Reset or not?</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dwRegRead</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CPU_GEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="o">-&gt;</span><span class="n">firmware_status</span> <span class="o">==</span> <span class="n">FW_STATUS_0_INIT</span><span class="p">)</span>
		<span class="n">dwRegRead</span> <span class="o">|=</span> <span class="n">CPU_GEN_SYSTEM_RESET</span><span class="p">;</span> <span class="c1">//do nothing here?</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="o">-&gt;</span><span class="n">firmware_status</span> <span class="o">==</span> <span class="n">FW_STATUS_5_READY</span><span class="p">)</span>
		<span class="n">dwRegRead</span> <span class="o">|=</span> <span class="n">CPU_GEN_FIRMWARE_RESET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;ERROR in %s(): undefined firmware state(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span>   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="o">-&gt;</span><span class="n">firmware_status</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CPU_GEN</span><span class="p">,</span> <span class="n">dwRegRead</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><p>mdelay(30);
config BB.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_BBConfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>Loopback mode or not</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LoopbackMode</span> <span class="o">=</span> <span class="n">RTL819xU_NO_LOOPBACK</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>priv->LoopbackMode = RTL819xU<em>MAC</em>LOOPBACK;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dwRegRead</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CPU_GEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LoopbackMode</span> <span class="o">==</span> <span class="n">RTL819xU_NO_LOOPBACK</span><span class="p">)</span>
		<span class="n">dwRegRead</span> <span class="o">=</span> <span class="p">((</span><span class="n">dwRegRead</span> <span class="o">&amp;</span> <span class="n">CPU_GEN_NO_LOOPBACK_MSK</span><span class="p">)</span> <span class="o">|</span> <span class="n">CPU_GEN_NO_LOOPBACK_SET</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">LoopbackMode</span> <span class="o">==</span> <span class="n">RTL819xU_MAC_LOOPBACK</span><span class="p">)</span>
		<span class="n">dwRegRead</span> <span class="o">|=</span> <span class="n">CPU_CCK_LOOPBACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Serious error in %s(): wrong loopback mode setting(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span>  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LoopbackMode</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CPU_GEN</span><span class="p">,</span> <span class="n">dwRegRead</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><p>after reset cpu, we need wait for a seconds to write in register.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-155"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-155">&#182;</a></div><p>xiong add for new bitfile:usb suspend reset pin set to 1. //do we need?</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_byte_E</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="p">(</span><span class="n">read_nic_byte_E</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">)</span><span class="o">|</span><span class="mh">0x20</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-156"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-156">&#182;</a></div><p>Set Hardware</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_hwconfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-157"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-157">&#182;</a></div><p>turn on Tx/Rx</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">,</span> <span class="n">CR_RE</span><span class="o">|</span><span class="n">CR_TE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-158"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-158">&#182;</a></div><p>set IDR0 here</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MAC0</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MAC4</span><span class="p">,</span> <span class="p">((</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-159"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-159">&#182;</a></div><p>set RCR</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCR</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReceiveConfig</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-160"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-160">&#182;</a></div><p>Initialize Number of Reserved Pages in Firmware Queue</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RQPN1</span><span class="p">,</span>  <span class="n">NUM_OF_PAGE_IN_FW_QUEUE_BK</span> <span class="o">&lt;&lt;</span> <span class="n">RSVD_FW_QUEUE_PAGE_BK_SHIFT</span> <span class="o">|</span>\
						<span class="n">NUM_OF_PAGE_IN_FW_QUEUE_BE</span> <span class="o">&lt;&lt;</span> <span class="n">RSVD_FW_QUEUE_PAGE_BE_SHIFT</span> <span class="o">|</span> \
						<span class="n">NUM_OF_PAGE_IN_FW_QUEUE_VI</span> <span class="o">&lt;&lt;</span> <span class="n">RSVD_FW_QUEUE_PAGE_VI_SHIFT</span> <span class="o">|</span> \
						<span class="n">NUM_OF_PAGE_IN_FW_QUEUE_VO</span> <span class="o">&lt;&lt;</span><span class="n">RSVD_FW_QUEUE_PAGE_VO_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RQPN2</span><span class="p">,</span> <span class="n">NUM_OF_PAGE_IN_FW_QUEUE_MGNT</span> <span class="o">&lt;&lt;</span> <span class="n">RSVD_FW_QUEUE_PAGE_MGNT_SHIFT</span> <span class="o">|</span>\
						<span class="n">NUM_OF_PAGE_IN_FW_QUEUE_CMD</span> <span class="o">&lt;&lt;</span> <span class="n">RSVD_FW_QUEUE_PAGE_CMD_SHIFT</span><span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RQPN3</span><span class="p">,</span> <span class="n">APPLIED_RESERVED_QUEUE_IN_FW</span><span class="o">|</span> \
						<span class="n">NUM_OF_PAGE_IN_FW_QUEUE_BCN</span><span class="o">&lt;&lt;</span><span class="n">RSVD_FW_QUEUE_PAGE_BCN_SHIFT</span></pre></div></td></tr>


<tr id="section-161"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-161">&#182;</a></div><pre><code>                | NUM_OF_PAGE_IN_FW_QUEUE_PUB&lt;&lt;RSVD_FW_QUEUE_PAGE_PUB_SHIFT
</code></pre></td><td class="code"><div class="highlight"><pre>						<span class="p">);</span>
	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RATR0</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">7</span><span class="p">,</span> <span class="p">(</span><span class="n">RATE_ALL_OFDM_AG</span> <span class="o">|</span> <span class="n">RATE_ALL_CCK</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-162"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-162">&#182;</a></div><p>Set AckTimeout
TODO: (it value is only for FPGA version). need to be changed!!2006.12.18, by Emily</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ACK_TIMEOUT</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-163"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-163">&#182;</a></div><p>RT<em>TRACE(COMP</em>INIT, "%s():priv->ResetProgress is %d\n", <strong>FUNCTION</strong>,priv->ResetProgress);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">)</span>
	<span class="n">rtl8192_SetWirelessMode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">){</span>
	<span class="n">CamResetAllEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">SECR_value</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">SECR_value</span> <span class="o">|=</span> <span class="n">SCR_TxEncEnable</span><span class="p">;</span>
		<span class="n">SECR_value</span> <span class="o">|=</span> <span class="n">SCR_RxDecEnable</span><span class="p">;</span>
		<span class="n">SECR_value</span> <span class="o">|=</span> <span class="n">SCR_NoSKMC</span><span class="p">;</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SECR</span><span class="p">,</span> <span class="n">SECR_value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-164"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-164">&#182;</a></div><p>Beacon related</p></td><td class="code"><div class="highlight"><pre>	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ATIMWND</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BCN_INTERVAL</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="p">{</span>
<span class="cp">#define DEFAULT_EDCA 0x005e4332</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WDCAPARA_ADD</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DEFAULT_EDCA</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span></pre></div></td></tr>


<tr id="section-165"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-165">&#182;</a></div><p>3 For usb rx firmware aggregation control</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">ulValue</span><span class="p">;</span>
		<span class="n">PRT_HIGH_THROUGHPUT</span>	<span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>
		<span class="n">ulValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">UsbRxFwAggrEn</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">UsbRxFwAggrPageNum</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">UsbRxFwAggrPacketNum</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">UsbRxFwAggrTimeout</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If usb rx firmware aggregation is enabled,</span>
<span class="cm">		 * when anyone of three threshold conditions above is reached,</span>
<span class="cm">		 * firmware will send aggregated packet to driver.</span>
<span class="cm">		 */</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1a8</span><span class="p">,</span> <span class="n">ulValue</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bCurrentRxAggrEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">rtl8192_phy_configmac</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_8192_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">VERSION_819xU_A</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">rtl8192_phy_getTxPower</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8192_phy_setTxPower</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-166"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-166">&#182;</a></div><p>Firmware download</p></td><td class="code"><div class="highlight"><pre>	<span class="n">init_status</span> <span class="o">=</span> <span class="n">init_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">init_status</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span><span class="s">&quot;ERR!!! %s(): Firmware download is failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">init_status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;%s():after firmware download</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-167"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-167">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef TO_DO_LIST</span>
<span class="k">if</span><span class="p">(</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pMgntInfo</span><span class="o">-&gt;</span><span class="n">RegRfOff</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
		<span class="p">{</span> <span class="c1">// User disable RF via registry.</span>
			<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_INIT</span><span class="o">|</span><span class="n">COMP_RF</span><span class="p">),</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;InitializeAdapter819xUsb(): Turn off RF for RegRfOff ----------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">eRfOff</span><span class="p">,</span> <span class="n">RF_CHANGE_BY_SW</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-168"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-168">&#182;</a></div><p>Those actions will be discard in MgntActSet<em>RF</em>State because of the same state</p></td><td class="code"><div class="highlight"><pre>			<span class="k">for</span><span class="p">(</span><span class="n">eRFPath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eRFPath</span> <span class="o">&lt;</span><span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">NumTotalRFPath</span><span class="p">;</span> <span class="n">eRFPath</span><span class="o">++</span><span class="p">)</span>
				<span class="n">PHY_SetRFReg</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">RF90_RADIO_PATH_E</span><span class="p">)</span><span class="n">eRFPath</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xC00</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pMgntInfo</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">&gt;</span> <span class="n">RF_CHANGE_BY_PS</span><span class="p">)</span>
		<span class="p">{</span> <span class="c1">// H/W or S/W RF OFF before sleep.</span>
			<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_INIT</span><span class="o">|</span><span class="n">COMP_RF</span><span class="p">),</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;InitializeAdapter819xUsb(): Turn off RF for RfOffReason(%d) ----------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pMgntInfo</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">));</span>
			<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">eRfOff</span><span class="p">,</span> <span class="n">pMgntInfo</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">=</span> <span class="n">eRfOn</span><span class="p">;</span>
			<span class="n">pMgntInfo</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_INIT</span><span class="o">|</span><span class="n">COMP_RF</span><span class="p">),</span> <span class="n">DBG_LOUD</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;InitializeAdapter819xUsb(): RF is on ----------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">MgntActSet_RF_State</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">eRfOff</span><span class="p">,</span> <span class="n">pMgntInfo</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-169"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-169">&#182;</a></div><p>Those actions will be discard in MgntActSet<em>RF</em>State because of the same state</p></td><td class="code"><div class="highlight"><pre>			<span class="k">for</span><span class="p">(</span><span class="n">eRFPath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eRFPath</span> <span class="o">&lt;</span><span class="n">pHalData</span><span class="o">-&gt;</span><span class="n">NumTotalRFPath</span><span class="p">;</span> <span class="n">eRFPath</span><span class="o">++</span><span class="p">)</span>
				<span class="n">PHY_SetRFReg</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="p">(</span><span class="n">RF90_RADIO_PATH_E</span><span class="p">)</span><span class="n">eRFPath</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0xC00</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-170"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-170">&#182;</a></div><p>config RF.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">){</span>
	<span class="n">rtl8192_phy_RFConfig</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;%s():after phy RF config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">FwRWRF</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-171"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-171">&#182;</a></div><p>We can force firmware to do RF-R/W</p></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Rf_Mode</span> <span class="o">=</span> <span class="n">RF_OP_By_FW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">Rf_Mode</span> <span class="o">=</span> <span class="n">RF_OP_By_SW_3wire</span><span class="p">;</span>


	<span class="n">rtl8192_phy_updateInitGain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*--set CCK and OFDM Block &quot;ON&quot;--*/</span>
	<span class="n">rtl8192_setBBreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rFPGA0_RFMOD</span><span class="p">,</span> <span class="n">bCCKEn</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">rtl8192_setBBreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rFPGA0_RFMOD</span><span class="p">,</span> <span class="n">bOFDMEn</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-172"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-172">&#182;</a></div><p>if D or C cut</p></td><td class="code"><div class="highlight"><pre>		<span class="n">u8</span> <span class="n">tmpvalue</span> <span class="o">=</span> <span class="n">read_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">tmpvalue</span> <span class="o">==</span><span class="mh">0x03</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDcut</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="s">&quot;D-cut</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDcut</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_POWER_TRACKING</span><span class="p">,</span> <span class="s">&quot;C-cut</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dm_initialize_txpower_tracking</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDcut</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">TempCCk</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">tmpRegA</span><span class="o">=</span> <span class="n">rtl8192_QueryBBReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">rOFDM0_XATxIQImbalance</span><span class="p">,</span><span class="n">bMaskDWord</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-173"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-173">&#182;</a></div><p>u32 tmpRegC= rtl8192<em>QueryBBReg(dev,rOFDM0</em>XCTxIQImbalance,bMaskDWord);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">TxBBGainTableLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">tmpRegA</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txbbgain_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txbbgain_value</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfa_txpowertrackingindex</span><span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfa_txpowertrackingindex_real</span><span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfa_txpowertracking_default</span><span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfa_txpowertrackingindex</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">TempCCk</span> <span class="o">=</span> <span class="n">rtl8192_QueryBBReg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rCCK0_TxFilter1</span><span class="p">,</span> <span class="n">bMaskByte2</span><span class="p">);</span>

			<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CCKTxBBGainTableLength</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>

				<span class="k">if</span><span class="p">(</span><span class="n">TempCCk</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cck_txbbgain_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ccktxbb_valuearray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cck_present_attentuation_20Mdefault</span><span class="o">=</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cck_present_attentuation_40Mdefault</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cck_present_attentuation_difference</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cck_present_attentuation</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cck_present_attentuation_20Mdefault</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-174"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-174">&#182;</a></div><pre><code>pMgntInfo-&gt;bTXPowerTracking = FALSE;//TEMPLY DISABLE
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">init_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this configures registers for beacon tx and enables it via</span>
<span class="cm"> * rtl8192_beacon_tx_enable(). rtl8192_beacon_tx_disable() might</span>
<span class="cm"> * be used to stop beacon transmission</span>
<span class="cm"> */</span>
<span class="cm">/***************************************************************************</span>
<span class="cm">    -------------------------------NET STUFF---------------------------</span>
<span class="cm">***************************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">rtl8192_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span>
<span class="nf">HalTxCheckStuck819xUsb</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> 		<span class="n">RegTxCounter</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x128</span><span class="p">);</span>
	<span class="n">bool</span>		<span class="n">bStuck</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s():RegTxCounter is %d,TxCounter is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">RegTxCounter</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxCounter</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxCounter</span><span class="o">==</span><span class="n">RegTxCounter</span><span class="p">)</span>
		<span class="n">bStuck</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">TxCounter</span> <span class="o">=</span> <span class="n">RegTxCounter</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bStuck</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">*	&lt;Assumption: RT_TX_SPINLOCK is acquired.&gt;</span>
<span class="cm">*	First added: 2006.11.19 by emily</span>
<span class="cm">*/</span>
<span class="n">RESET_TYPE</span>
<span class="nf">TxCheckStuck</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>			<span class="n">QueueID</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-175"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-175">&#182;</a></div><p>PRT_TCB            pTcb;
u8            ResetThreshold;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">bool</span>			<span class="n">bCheckFwTxCnt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-176"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-176">&#182;</a></div><p>unsigned long flags;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-177"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-177">&#182;</a></div><p>Decide such threshold according to current power save mode</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-178"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-178">&#182;</a></div><pre><code>RT_TRACE(COMP_RESET, " ==&gt; TxCheckStuck()\n");
 PlatformAcquireSpinLock(Adapter, RT_TX_SPINLOCK);
 spin_lock_irqsave(&amp;priv-&gt;ieee80211-&gt;lock,flags);
</code></pre></td><td class="code"><div class="highlight"><pre>	     <span class="k">for</span> <span class="p">(</span><span class="n">QueueID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">QueueID</span><span class="o">&lt;=</span><span class="n">BEACON_QUEUE</span><span class="p">;</span><span class="n">QueueID</span> <span class="o">++</span><span class="p">)</span>
	     <span class="p">{</span>
	     		<span class="k">if</span><span class="p">(</span><span class="n">QueueID</span> <span class="o">==</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span>
		         <span class="k">continue</span><span class="p">;</span>
<span class="cp">#ifdef USB_TX_DRIVER_AGGREGATION_ENABLE</span>
			<span class="k">if</span><span class="p">((</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">QueueID</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_aggQ</span><span class="p">[</span><span class="n">QueueID</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_drv_aggQ</span><span class="p">[</span><span class="n">QueueID</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<span class="cp">#else</span>
		     	<span class="k">if</span><span class="p">((</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">QueueID</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_aggQ</span><span class="p">[</span><span class="n">QueueID</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<span class="cp">#endif</span>
			 	<span class="k">continue</span><span class="p">;</span>

	             <span class="n">bCheckFwTxCnt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	     <span class="p">}</span></pre></div></td></tr>


<tr id="section-179"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-179">&#182;</a></div><pre><code> PlatformReleaseSpinLock(Adapter, RT_TX_SPINLOCK);
</code></pre>

<p>spin<em>unlock</em>irqrestore(&amp;priv->ieee80211->lock,flags);
RT<em>TRACE(COMP</em>RESET,"bCheckFwTxCnt is %d\n",bCheckFwTxCnt);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">bCheckFwTxCnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">HalTxCheckStuck819xUsb</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;TxCheckStuck(): Fw indicates no Tx condition! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span>
<span class="nf">HalRxCheckStuck819xUsb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> 	<span class="n">RegRxCounter</span> <span class="o">=</span> <span class="n">read_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x130</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">bStuck</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span>	<span class="n">rx_chk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s(): RegRxCounter is %d,RxCounter is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">RegRxCounter</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RxCounter</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-180"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-180">&#182;</a></div><p>If rssi is small, we should check rx for long time because of bad rx.
or maybe it will continuous silent reset every 2 seconds.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rx_chk_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">RateAdaptiveTH_High</span><span class="o">+</span><span class="mi">5</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">rx_chk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">//high rssi, check rx stuck right now.</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">RateAdaptiveTH_High</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentChannelBW</span><span class="o">!=</span><span class="n">HT_CHANNEL_WIDTH_20</span><span class="o">&amp;&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span><span class="o">&gt;=</span><span class="n">RateAdaptiveTH_Low_40M</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentChannelBW</span><span class="o">==</span><span class="n">HT_CHANNEL_WIDTH_20</span><span class="o">&amp;&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span><span class="o">&gt;=</span><span class="n">RateAdaptiveTH_Low_20M</span><span class="p">))</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rx_chk_cnt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">bStuck</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">rx_chk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentChannelBW</span><span class="o">!=</span><span class="n">HT_CHANNEL_WIDTH_20</span><span class="o">&amp;&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span><span class="o">&lt;</span><span class="n">RateAdaptiveTH_Low_40M</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentChannelBW</span><span class="o">==</span><span class="n">HT_CHANNEL_WIDTH_20</span><span class="o">&amp;&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span><span class="o">&lt;</span><span class="n">RateAdaptiveTH_Low_20M</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&gt;=</span> <span class="n">VeryLowRSSI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rx_chk_cnt</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-181"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-181">&#182;</a></div><p>DbgPrint("RSSI &lt; %d &amp;&amp; RSSI >= %d, no check this time \n", RateAdaptiveTH_Low, VeryLowRSSI);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span> <span class="n">bStuck</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">rx_chk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-182"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-182">&#182;</a></div><p>DbgPrint("RSSI &lt; %d &amp;&amp; RSSI >= %d, check this time \n", RateAdaptiveTH_Low, VeryLowRSSI);</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rx_chk_cnt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-183"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-183">&#182;</a></div><p>DbgPrint("RSSI &lt;= %d, no check this time \n", VeryLowRSSI);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span> <span class="n">bStuck</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">rx_chk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-184"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-184">&#182;</a></div><p>DbgPrint("RSSI &lt;= %d, check this time \n", VeryLowRSSI);</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RxCounter</span><span class="o">==</span><span class="n">RegRxCounter</span><span class="p">)</span>
		<span class="n">bStuck</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RxCounter</span> <span class="o">=</span> <span class="n">RegRxCounter</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bStuck</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">RESET_TYPE</span>
<span class="nf">RxCheckStuck</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-185"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-185">&#182;</a></div><p>int                     i;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">bool</span>        <span class="n">bRxCheck</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-186"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-186">&#182;</a></div><pre><code>  RT_TRACE(COMP_RESET," ==&gt; RxCheckStuck()\n");
</code></pre>

<p>PlatformAcquireSpinLock(Adapter, RT<em>RX</em>SPINLOCK);</p></td><td class="code"><div class="highlight"><pre>	 <span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">IrpPendingCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">bRxCheck</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-187"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-187">&#182;</a></div><p>PlatformReleaseSpinLock(Adapter, RT<em>RX</em>SPINLOCK);</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-188"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-188">&#182;</a></div><pre><code>  RT_TRACE(COMP_RESET,"bRxCheck is %d \n",bRxCheck);
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">bRxCheck</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">HalRxCheckStuck819xUsb</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;RxStuck Condition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm">*	This function is called by Checkforhang to check whether we should ask OS to reset driver</span>
<span class="cm">*</span>
<span class="cm">*	\param pAdapter	The adapter context for this miniport</span>
<span class="cm">*</span>
<span class="cm">*	Note:NIC with USB interface sholud not call this function because we cannot scan descriptor</span>
<span class="cm">*	to judge whether there is tx stuck.</span>
<span class="cm">*	Note: This function may be required to be rewrite for Vista OS.</span>
<span class="cm">*	&lt;&lt;&lt;Assumption: Tx spinlock has been acquired &gt;&gt;&gt;</span>
<span class="cm">*</span>
<span class="cm">*	8185 and 8185b does not implement this function. This is added by Emily at 2006.11.24</span>
<span class="cm">*/</span>
<span class="n">RESET_TYPE</span>
<span class="nf">rtl819x_ifcheck_resetornot</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RESET_TYPE</span>	<span class="n">TxResetType</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="n">RESET_TYPE</span>	<span class="n">RxResetType</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="n">RT_RF_POWER_STATE</span> 	<span class="n">rfState</span><span class="p">;</span>

	<span class="n">rfState</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">;</span>

	<span class="n">TxResetType</span> <span class="o">=</span> <span class="n">TxCheckStuck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">rfState</span> <span class="o">!=</span> <span class="n">eRfOff</span> <span class="o">||</span>
		<span class="cm">/*ADAPTER_TEST_STATUS_FLAG(Adapter, ADAPTER_STATUS_FW_DOWNLOAD_FAILURE)) &amp;&amp;*/</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">))</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-189"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-189">&#182;</a></div><p>If driver is in the status of firmware download failure , driver skips RF initialization and RF is
in turned off state. Driver should check whether Rx stuck and do silent reset. And
if driver is in firmware download failure status, driver should initialize RF in the following
silent reset procedure Emily, 2008.01.21</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-190"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-190">&#182;</a></div><p>Driver should not check RX stuck in IBSS mode because it is required to
set Check BSSID in order to send beacon, however, if check BSSID is
set, STA cannot hear any packet at all. Emily, 2008.04.12</p></td><td class="code"><div class="highlight"><pre>		<span class="n">RxResetType</span> <span class="o">=</span> <span class="n">RxCheckStuck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">TxResetType</span><span class="o">==</span><span class="n">RESET_TYPE_NORMAL</span> <span class="o">||</span> <span class="n">RxResetType</span><span class="o">==</span><span class="n">RESET_TYPE_NORMAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESET_TYPE_NORMAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">TxResetType</span><span class="o">==</span><span class="n">RESET_TYPE_SILENT</span> <span class="o">||</span> <span class="n">RxResetType</span><span class="o">==</span><span class="n">RESET_TYPE_SILENT</span><span class="p">){</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s():silent reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">_rtl8192_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rtl8192_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>



<span class="kt">void</span>
<span class="nf">CamRestoreAllEntry</span><span class="p">(</span>	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">EntryId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span><span class="o">*</span>	<span class="n">MacAddr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">;</span>

	<span class="k">static</span> <span class="n">u8</span>	<span class="n">CAM_CONST_ADDR</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">}};</span>
	<span class="k">static</span> <span class="n">u8</span>	<span class="n">CAM_CONST_BROAD</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_SEC</span><span class="p">,</span> <span class="s">&quot;CamRestoreAllEntry: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_WEP40</span><span class="p">)</span><span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_WEP104</span><span class="p">))</span>
	<span class="p">{</span>

		<span class="k">for</span><span class="p">(</span><span class="n">EntryId</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">EntryId</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">EntryId</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="p">{</span>
				<span class="n">MacAddr</span> <span class="o">=</span> <span class="n">CAM_CONST_ADDR</span><span class="p">[</span><span class="n">EntryId</span><span class="p">];</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">EntryId</span> <span class="p">,</span>
						<span class="n">EntryId</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
						<span class="n">MacAddr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_TKIP</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="mi">4</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="mi">4</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
						<span class="n">MacAddr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="mi">4</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="mi">4</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
						<span class="n">MacAddr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>



	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_TKIP</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">MacAddr</span> <span class="o">=</span> <span class="n">CAM_CONST_BROAD</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">EntryId</span><span class="o">=</span><span class="mi">1</span> <span class="p">;</span> <span class="n">EntryId</span><span class="o">&lt;</span><span class="mi">4</span> <span class="p">;</span> <span class="n">EntryId</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="p">{</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">EntryId</span><span class="p">,</span>
						<span class="n">EntryId</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">,</span>
						<span class="n">MacAddr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">,</span>
						<span class="n">CAM_CONST_ADDR</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">MacAddr</span> <span class="o">=</span> <span class="n">CAM_CONST_BROAD</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">EntryId</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">EntryId</span><span class="o">&lt;</span><span class="mi">4</span> <span class="p">;</span> <span class="n">EntryId</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="p">{</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">EntryId</span> <span class="p">,</span>
						<span class="n">EntryId</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">,</span>
						<span class="n">MacAddr</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
				<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="mi">0</span> <span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">,</span>
						<span class="n">CAM_CONST_ADDR</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-191"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-191">&#182;</a></div><p>////////////////////////////////////////////////////////////
This function is used to fix Tx/Rx stop bug temporarily.
This function will do "system reset" to NIC when Tx or Rx is stuck.
The method checking Tx/Rx stuck of this function is supported by FW,
which reports Tx and Rx counter to register 0x128 and 0x130.
////////////////////////////////////////////////////////////</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span>
<span class="nf">rtl819x_ifsilentreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-192"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-192">&#182;</a></div><p>OCTET_STRING asocpdu;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>	<span class="n">reset_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-193"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-193">&#182;</a></div><p>2007.07.20. If we need to check CCK stop, please uncomment this line.
bStuck = Adapter->HalFunc.CheckHWStopHandler(Adapter);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span><span class="o">==</span><span class="n">RESET_TYPE_NORESET</span><span class="p">)</span>
	<span class="p">{</span>
<span class="nl">RESET_START:</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;=========&gt;Reset progress!! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-194"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-194">&#182;</a></div><p>Set the variable for reset.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">=</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-195"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-195">&#182;</a></div><pre><code>rtl8192_close(dev);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span><span class="s">&quot;%s():the driver is not up! return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s():======&gt;start to down the driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-196"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-196">&#182;</a></div><pre><code>if(!netif_queue_stopped(dev))
    netif_stop_queue(dev);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">rtl8192_rtx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">deinit_hal_dm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ieee-&gt;state is IEEE80211_LINKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ieee80211_stop_send_beacons</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">);</span>
			<span class="n">ieee80211_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ieee-&gt;state is NOT LINKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ieee80211_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>			<span class="p">}</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s():&lt;==========down process is finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-197"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-197">&#182;</a></div><p>rtl8192<em>irq</em>disable(dev);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s():===========&gt;start up the driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="n">reset_status</span> <span class="o">=</span> <span class="n">_rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s():&lt;===========up process is finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">reset_status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">reset_times</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">reset_times</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">RESET_START</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span><span class="s">&quot; ERR!!! %s():  Reset Failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_silent_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">EnableHWSecurityConfig8192</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

			<span class="n">queue_work</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_complete_wq</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-198"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-198">&#182;</a></div><p>notify<em>wx</em>assoc_event(ieee);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ieee80211_start_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">CamRestoreAllEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span> <span class="o">=</span><span class="nb">false</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bResetInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-199"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-199">&#182;</a></div><p>For test --> force write UFWP.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UFWP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;Reset finished!! ====&gt;[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">CAM_read_entry</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u32</span>	 		<span class="n">iIndex</span>
<span class="p">)</span>
<span class="p">{</span>
 	<span class="n">u32</span> <span class="n">target_command</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	 <span class="n">u32</span> <span class="n">target_content</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	 <span class="n">u8</span> <span class="n">entry_i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	 <span class="n">u32</span> <span class="n">ulStatus</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-200"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-200">&#182;</a></div><p>printk("=======>start read CAM\n");</p></td><td class="code"><div class="highlight"><pre> 	<span class="k">for</span><span class="p">(</span><span class="n">entry_i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">entry_i</span><span class="o">&lt;</span><span class="n">CAM_CONTENT_COUNT</span><span class="p">;</span><span class="n">entry_i</span><span class="o">++</span><span class="p">)</span>
 	<span class="p">{</span></pre></div></td></tr>


<tr id="section-201"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-201">&#182;</a></div><p>polling bit, and No Write enable, and address</p></td><td class="code"><div class="highlight"><pre>		<span class="n">target_command</span><span class="o">=</span> <span class="n">entry_i</span><span class="o">+</span><span class="n">CAM_CONTENT_COUNT</span><span class="o">*</span><span class="n">iIndex</span><span class="p">;</span>
		<span class="n">target_command</span><span class="o">=</span> <span class="n">target_command</span> <span class="o">|</span> <span class="n">BIT31</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-202"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-202">&#182;</a></div><p>Check polling bit is clear
mdelay(1);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">while</span><span class="p">((</span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ulStatus</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ulStatus</span> <span class="o">&amp;</span> <span class="n">BIT31</span><span class="p">){</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span><span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">,</span> <span class="n">target_command</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_SEC</span><span class="p">,</span><span class="s">&quot;CAM_read_entry(): WRITE A0: %x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">target_command</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-203"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-203">&#182;</a></div><p>printk("CAM<em>read</em>entry(): WRITE A0: %lx \n",target_command);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">target_content</span> <span class="o">=</span> <span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RCAMO</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_SEC</span><span class="p">,</span> <span class="s">&quot;CAM_read_entry(): WRITE A8: %x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">target_content</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-204"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-204">&#182;</a></div><p>printk("CAM<em>read</em>entry(): WRITE A8: %lx \n",target_content);</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl819x_update_rxcounts</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="n">u32</span><span class="o">*</span> <span class="n">TotalRxBcnNum</span><span class="p">,</span>
	<span class="n">u32</span><span class="o">*</span> <span class="n">TotalRxDataNum</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> 			<span class="n">SlotIndex</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">TotalRxBcnNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TotalRxDataNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SlotIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotIndex</span><span class="o">++</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotNum</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxBcnNum</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxDataNum</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">){</span>
		<span class="o">*</span><span class="n">TotalRxBcnNum</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxBcnNum</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">TotalRxDataNum</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxDataNum</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">extern</span>	<span class="kt">void</span>	<span class="nf">rtl819x_watchdog_wqcallback</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="k">struct</span> <span class="n">delayed_work</span><span class="p">,</span><span class="n">work</span><span class="p">);</span>
       <span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span><span class="n">watch_dog_wq</span><span class="p">);</span>
       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="n">RESET_TYPE</span>	<span class="n">ResetType</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span>	<span class="n">check_reset_cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">hal_dm_watchdog</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">{</span><span class="c1">//to get busy traffic condition</span>
		<span class="k">if</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span><span class="o">&gt;</span> <span class="mi">666</span> <span class="o">||</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">&gt;</span> <span class="mi">666</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="n">bBusyTraffic</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-205"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-205">&#182;</a></div><p>added by amy for AP roaming</p></td><td class="code"><div class="highlight"><pre>	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IEEE80211_LINKED</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">u32</span>	<span class="n">TotalRxBcnNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">TotalRxDataNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">rtl819x_update_rxcounts</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TotalRxBcnNum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TotalRxDataNum</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">TotalRxBcnNum</span><span class="o">+</span><span class="n">TotalRxDataNum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="cp">#ifdef TODO</span>
				<span class="k">if</span><span class="p">(</span><span class="n">rfState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span>
					<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span><span class="s">&quot;========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
				<span class="cp">#endif</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;===&gt;%s(): AP is power off,connect another one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-206"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-206">&#182;</a></div><p>Dot11d_Reset(dev);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IEEE80211_ASSOCIATING</span><span class="p">;</span>
				<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
				<span class="n">RemovePeerTS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                                <span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-207"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-207">&#182;</a></div><p>CAM<em>read</em>entry(dev,4);
check if reset the driver</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">check_reset_cnt</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
	<span class="p">{</span>
    		<span class="n">ResetType</span> <span class="o">=</span> <span class="n">rtl819x_ifcheck_resetornot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">check_reset_cnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-208"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-208">&#182;</a></div><p>DbgPrint("Start to check silent reset\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span></pre></div></td></tr>


<tr id="section-209"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-209">&#182;</a></div><p>RT<em>TRACE(COMP</em>RESET,"%s():priv->force<em>reset is %d,priv->ResetProgress is %d, priv->bForcedSilentReset is %d,priv->bDisableNormalResetCheck is %d,ResetType is %d\n",<strong>FUNCTION</strong>,priv->force</em>reset,priv->ResetProgress,priv->bForcedSilentReset,priv->bDisableNormalResetCheck,ResetType);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_reset</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span><span class="o">==</span><span class="n">RESET_TYPE_NORESET</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDisableNormalResetCheck</span> <span class="o">&amp;&amp;</span> <span class="n">ResetType</span><span class="o">==</span><span class="n">RESET_TYPE_SILENT</span><span class="p">))))</span> <span class="c1">// This is control by OID set in Pomelo</span>
	<span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span><span class="s">&quot;%s():priv-&gt;force_reset is %d,priv-&gt;ResetProgress is %d, priv-&gt;bForcedSilentReset is %d,priv-&gt;bDisableNormalResetCheck is %d,ResetType is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_reset</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span><span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDisableNormalResetCheck</span><span class="p">,</span><span class="n">ResetType</span><span class="p">);</span>
		<span class="n">rtl819x_ifsilentreset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bResetInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_TRACE</span><span class="p">,</span> <span class="s">&quot; &lt;==RtUsbCheckForHangWorkItemCallback()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">watch_dog_timer_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-210"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-210">&#182;</a></div><p>printk("===============>watch_dog timer\n");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">IEEE80211_WATCH_DOG_TIME</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">_rtl8192_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-211"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-211">&#182;</a></div><p>int i;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">init_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ieee_up</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Bringing up iface&quot;</span><span class="p">);</span>
	<span class="n">init_status</span> <span class="o">=</span> <span class="n">rtl8192_adapter_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">init_status</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span><span class="s">&quot;ERR!!! %s(): initialization failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">=</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ieee_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;start adapter finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rtl8192_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-212"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-212">&#182;</a></div><p>rtl8192<em>tx</em>enable(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IEEE80211_LINKED</span><span class="p">)</span>
	<span class="n">ieee80211_softmac_start_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="n">ieee80211_reset_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="n">watch_dog_timer_callback</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">rtl8192_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>


<span class="kt">int</span> <span class="nf">rtl8192_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">_rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">rtl8192_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl8192_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">ieee_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;==========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
<span class="cm">/* FIXME */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8192_rtx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-213"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-213">&#182;</a></div><p>rtl8192<em>irq</em>disable(dev);</p></td><td class="code"><div class="highlight"><pre> <span class="cm">/* Tx related queue release */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_aggQ</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">skb_drv_aggQ</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-214"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-214">&#182;</a></div><p>as cancel<em>delayed</em>work will del work->timer, so if work is not defined as struct delayed<em>work, it will corrupt
flush</em>scheduled_work();</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">deinit_hal_dm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>


	<span class="n">ieee80211_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_network</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;&lt;==========%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reset_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-215"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-215">&#182;</a></div><p>u8 reset_times = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-216"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-216">&#182;</a></div><p>cancel<em>delayed</em>work(&amp;priv->SwChnlWorkItem);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee80211_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-217"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-217">&#182;</a></div><p>rtl8192<em>irq</em>disable(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_rtx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">reset_status</span> <span class="o">=</span> <span class="n">_rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">void rtl8192_restart(struct net_device *dev)</span>
<span class="cm">{</span>
<span class="cm">	struct r8192_priv *priv = ieee80211_priv(dev);</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">rtl8192_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span> <span class="n">reset_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">rtl8192_commit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8192_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">promisc</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-218"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-218">&#182;</a></div><p>down(&amp;priv->wx_sem);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* FIXME FIXME */</span>

	<span class="n">promisc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">promisc</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-219"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-219">&#182;</a></div><p>rtl8192_commit(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="n">promisc</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-220"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-220">&#182;</a></div><p>schedule<em>work(&amp;priv->reset</em>wq);
up(&amp;priv->wx_sem);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="kt">int</span> <span class="nf">r8192_set_mac_adr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mac</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* based on ipw2200 driver */</span>
<span class="kt">int</span> <span class="nf">rtl8192_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">broadcast_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">ipw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//(struct ieee_param *)wrq-&gt;u.data.pointer;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>


     <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">){</span>
	     <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	     <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

     <span class="n">ipw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">ipw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
	     <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	     <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ipw</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipw</span><span class="p">);</span>
	    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">RTL_IOCTL_WPA_SUPPLICANT</span>:</pre></div></td></tr>


<tr id="section-221"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-221">&#182;</a></div><p>parse here for HW security</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">IEEE_CMD_SET_ENCRYPTION</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_TKIP</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
							<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_WEP104</span><span class="p">;</span>
						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
							<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_WEP40</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_NA</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">EnableHWSecurityConfig8192</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-222"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-222">&#182;</a></div><p>we fill both index entry and 4th entry for pairwise key as in IPW interface, adhoc will only get here, so we need index entry for its default key serching!
added by WB.</p></td><td class="code"><div class="highlight"><pre>						<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
						<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="c1">//if (ipw-&gt;u.crypt.idx) //group key use idx &gt; 0</span>
				<span class="p">{</span>
					<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="o">=</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_TKIP</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
							<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_WEP104</span><span class="p">;</span>
						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
							<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_WEP40</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_NA</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">)</span>
					<span class="p">{</span>
							<span class="n">setKey</span><span class="p">(</span>	<span class="n">dev</span><span class="p">,</span>
								<span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
								<span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>		<span class="c1">//KeyIndex</span>
						     		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">,</span>	<span class="c1">//KeyType</span>
						            	<span class="n">broadcast_addr</span><span class="p">,</span>	<span class="c1">//MacAddr</span>
								<span class="mi">0</span><span class="p">,</span>		<span class="c1">//DefaultKey</span>
							      	<span class="n">key</span><span class="p">);</span>		<span class="c1">//KeyContent</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#ifdef JOHN_HWSEC_DEBUG</span></pre></div></td></tr>


<tr id="section-223"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-223">&#182;</a></div><p>john's test 0711</p></td><td class="code"><div class="highlight"><pre>		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;@@ wrq-&gt;u pointer = &quot;</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">10</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%8x|&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*JOHN_HWSEC_DEBUG*/</span><span class="cp"></span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_wpa_supplicant_ioctl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	    <span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ipw</span><span class="p">);</span>
	<span class="n">ipw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">HwRateToMRate90</span><span class="p">(</span><span class="n">bool</span> <span class="n">bIsHT</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>  <span class="n">ret_rate</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bIsHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DESC90_RATE1M</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_1M</span><span class="p">;</span>         <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE2M</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_2M</span><span class="p">;</span>         <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE5_5M</span>: <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_5_5M</span><span class="p">;</span>       <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE11M</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_11M</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE6M</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_6M</span><span class="p">;</span>         <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE9M</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_9M</span><span class="p">;</span>         <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE12M</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_12M</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE18M</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_18M</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE24M</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_24M</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE36M</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_36M</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE48M</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_48M</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATE54M</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_54M</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">ret_rate</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RECV</span><span class="p">,</span> <span class="s">&quot;HwRateToMRate90(): Non supported Rate [%x], bIsHT = %d!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">bIsHT</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS0</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS0</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS1</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS1</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS2</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS2</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS3</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS3</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS4</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS4</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS5</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS5</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS6</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS6</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS7</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS7</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS8</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS8</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS9</span>:   <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS9</span><span class="p">;</span>    <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS10</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS10</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS11</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS11</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS12</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS12</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS13</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS13</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS14</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS14</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS15</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="n">MGN_MCS15</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DESC90_RATEMCS32</span>:  <span class="n">ret_rate</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="mh">0x20</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">ret_rate</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RECV</span><span class="p">,</span> <span class="s">&quot;HwRateToMRate90(): Non supported Rate [%x], bIsHT = %d!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">rate</span><span class="p">,</span> <span class="n">bIsHT</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Function:     UpdateRxPktTimeStamp</span>
<span class="cm"> * Overview:     Record the TSF time stamp when receiving a packet</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *       PADAPTER        Adapter</span>
<span class="cm"> *       PRT_RFD         pRfd,</span>
<span class="cm"> *</span>
<span class="cm"> * Output:</span>
<span class="cm"> *       PRT_RFD         pRfd</span>
<span class="cm"> *                               (pRfd-&gt;Status.TimeStampHigh is updated)</span>
<span class="cm"> *                               (pRfd-&gt;Status.TimeStampLow is updated)</span>
<span class="cm"> * Return:</span>
<span class="cm"> *               None</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">UpdateRxPktTimeStamp8190</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bFirstMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxDescTSFLow</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxDescTSFHigh</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxDescTSFLow</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxDescTSFHigh</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-224"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-224">&#182;</a></div><p>by amy 080606</p></td><td class="code"><div class="highlight"><pre><span class="kt">long</span> <span class="nf">rtl819x_translate_todbm</span><span class="p">(</span><span class="n">u8</span> <span class="n">signal_strength_index</span>	<span class="p">)</span><span class="c1">// 0-100 index.</span>
<span class="p">{</span>
	<span class="kt">long</span>	<span class="n">signal_power</span><span class="p">;</span> <span class="c1">// in dBm.</span></pre></div></td></tr>


<tr id="section-225"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-225">&#182;</a></div><p>Translate to dBm (x=0.5y-95).</p></td><td class="code"><div class="highlight"><pre>	<span class="n">signal_power</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)((</span><span class="n">signal_strength_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">signal_power</span> <span class="o">-=</span> <span class="mi">95</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">signal_power</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* 2008/01/22 MH We can not declare RSSI/EVM total value of sliding window to</span>
<span class="cm">    be a local static. Otherwise, it may increase when we return from S3/S4. The</span>
<span class="cm">    value will be kept in memory or disk. Declare the value in the adaptor</span>
<span class="cm">    and it will be reinitialized when returned from S3/S4. */</span>
<span class="kt">void</span> <span class="nf">rtl8192_process_phyinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span> <span class="n">priv</span><span class="p">,</span><span class="n">u8</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span> <span class="n">pprevious_stats</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span> <span class="n">pcurrent_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">bcheck</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rfpath</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">nspatial_stream</span><span class="p">,</span> <span class="n">tmp_val</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-226"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-226">&#182;</a></div><p>u8    i;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">static</span> <span class="n">u32</span> <span class="n">slide_rssi_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">slide_rssi_statistics</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">slide_evm_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">slide_evm_statistics</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">last_rssi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last_evm</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">static</span> <span class="n">u32</span> <span class="n">slide_beacon_adc_pwdb_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">slide_beacon_adc_pwdb_statistics</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">last_beacon_adc_pwdb</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sc</span> <span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_FRAG</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">WLAN_GET_SEQ_SEQ</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-227"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-227">&#182;</a></div><p>cosa add 04292008 to record the sequence number</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pcurrent_stats</span><span class="o">-&gt;</span><span class="n">Seq_Num</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-228"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-228">&#182;</a></div><p>Check whether we should take the previous packet into accounting</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-229"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-229">&#182;</a></div><p>if previous packet is not aggregated packet</p></td><td class="code"><div class="highlight"><pre>		<span class="n">bcheck</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span>
	<span class="p">{</span>
	<span class="p">}</span>


	<span class="k">if</span><span class="p">(</span><span class="n">slide_rssi_statistics</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">PHY_RSSI_SLID_WIN_MAX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">slide_rssi_statistics</span> <span class="o">=</span> <span class="n">PHY_RSSI_SLID_WIN_MAX</span><span class="p">;</span>
		<span class="n">last_rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_signal_strength</span><span class="p">[</span><span class="n">slide_rssi_index</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_rssi_total</span> <span class="o">-=</span> <span class="n">last_rssi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_rssi_total</span> <span class="o">+=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">SignalStrength</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_signal_strength</span><span class="p">[</span><span class="n">slide_rssi_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">SignalStrength</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">slide_rssi_index</span> <span class="o">&gt;=</span> <span class="n">PHY_RSSI_SLID_WIN_MAX</span><span class="p">)</span>
		<span class="n">slide_rssi_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-230"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-230">&#182;</a></div><p>&lt;1> Showed on UI for user, in dbm</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp_val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_rssi_total</span><span class="o">/</span><span class="n">slide_rssi_statistics</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signal_strength</span> <span class="o">=</span> <span class="n">rtl819x_translate_todbm</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp_val</span><span class="p">);</span>
	<span class="n">pcurrent_stats</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signal_strength</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-231"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-231">&#182;</a></div><p>If the previous packet does not match the criteria, neglect it</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketMatchBSSID</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bToSelfBA</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bcheck</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-232"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-232">&#182;</a></div><p>rtl8190<em>process</em>cck<em>rxpathsel(priv,pprevious</em>stats);//only rtl8190 supported</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-233"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-233">&#182;</a></div><p>Check RSSI</p></td><td class="code"><div class="highlight"><pre>	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">num_process_phyinfo</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* record the general signal strength to the sliding window. */</span></pre></div></td></tr>


<tr id="section-234"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-234">&#182;</a></div><p>&lt;2> Showed on UI for engineering
hardware does not provide rssi information for each rf path in CCK</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bIsCCK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketToSelf</span> <span class="o">||</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bToSelfBA</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rfpath</span> <span class="o">=</span> <span class="n">RF90_PATH_A</span><span class="p">;</span> <span class="n">rfpath</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTotalRFPath</span><span class="p">;</span> <span class="n">rfpath</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
		     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl8192_phy_CheckIsLegalRFPath</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">))</span>
				 <span class="k">continue</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-235"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-235">&#182;</a></div><p>Fixed by Jacken 2008-03-20</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalStrength</span><span class="p">[</span><span class="n">rfpath</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-236"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-236">&#182;</a></div><p>DbgPrint("MIMO RSSI initialize \n");</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalStrength</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span>  <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalStrength</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]))</span> <span class="o">/</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalStrength</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]))</span> <span class="o">/</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span><span class="s">&quot;priv-&gt;stats.rx_rssi_percentage[rfPath]  = %d </span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">,</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_rssi_percentage</span><span class="p">[</span><span class="n">rfpath</span><span class="p">]</span> <span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-237"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-237">&#182;</a></div><p>Check PWDB.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RXDESC</span><span class="p">,</span> <span class="s">&quot;Smooth %s PWDB = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bIsCCK</span><span class="o">?</span> <span class="s">&quot;CCK&quot;</span><span class="o">:</span> <span class="s">&quot;OFDM&quot;</span><span class="p">,</span>
				<span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketBeacon</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cm">/* record the beacon pwdb to the sliding window. */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">slide_beacon_adc_pwdb_statistics</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">PHY_Beacon_RSSI_SLID_WIN_MAX</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">slide_beacon_adc_pwdb_statistics</span> <span class="o">=</span> <span class="n">PHY_Beacon_RSSI_SLID_WIN_MAX</span><span class="p">;</span>
			<span class="n">last_beacon_adc_pwdb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">Slide_Beacon_pwdb</span><span class="p">[</span><span class="n">slide_beacon_adc_pwdb_index</span><span class="p">];</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">Slide_Beacon_Total</span> <span class="o">-=</span> <span class="n">last_beacon_adc_pwdb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-238"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-238">&#182;</a></div><p>DbgPrint("slide<em>beacon</em>adc<em>pwdb</em>index = %d, last<em>beacon</em>adc<em>pwdb = %d, Adapter->RxStats.Slide</em>Beacon<em>Total = %d\n",
slide</em>beacon<em>adc</em>pwdb<em>index, last</em>beacon<em>adc</em>pwdb, Adapter->RxStats.Slide<em>Beacon</em>Total);</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">Slide_Beacon_Total</span> <span class="o">+=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">Slide_Beacon_pwdb</span><span class="p">[</span><span class="n">slide_beacon_adc_pwdb_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-239"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-239">&#182;</a></div><p>DbgPrint("slide<em>beacon</em>adc<em>pwdb</em>index = %d, pPreviousRfd->Status.RxPWDBAll = %d\n", slide<em>beacon</em>adc<em>pwdb</em>index, pPreviousRfd->Status.RxPWDBAll);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">slide_beacon_adc_pwdb_index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">slide_beacon_adc_pwdb_index</span> <span class="o">&gt;=</span> <span class="n">PHY_Beacon_RSSI_SLID_WIN_MAX</span><span class="p">)</span>
			<span class="n">slide_beacon_adc_pwdb_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">Slide_Beacon_Total</span><span class="o">/</span><span class="n">slide_beacon_adc_pwdb_statistics</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RXDESC</span><span class="p">,</span> <span class="s">&quot;Smooth %s PWDB = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bIsCCK</span><span class="o">?</span> <span class="s">&quot;CCK&quot;</span><span class="o">:</span> <span class="s">&quot;OFDM&quot;</span><span class="p">,</span>
				<span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span><span class="p">);</span>


	<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketToSelf</span> <span class="o">||</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketBeacon</span> <span class="o">||</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bToSelfBA</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="c1">// initialize</span>
		<span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-240"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-240">&#182;</a></div><p>DbgPrint("First pwdb initialize \n");</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
					<span class="p">(</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span><span class="p">))</span> <span class="o">/</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span> <span class="o">=</span>
					<span class="p">(</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">undecorated_smoothed_pwdb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span><span class="p">))</span> <span class="o">/</span><span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span></pre></div></td></tr>


<tr id="section-241"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-241">&#182;</a></div><p>Check EVM</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* record the general EVM to the sliding window. */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketToSelf</span> <span class="o">||</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketBeacon</span> <span class="o">||</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bToSelfBA</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">slide_evm_statistics</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">PHY_RSSI_SLID_WIN_MAX</span><span class="p">){</span>
				<span class="n">slide_evm_statistics</span> <span class="o">=</span> <span class="n">PHY_RSSI_SLID_WIN_MAX</span><span class="p">;</span>
				<span class="n">last_evm</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_evm</span><span class="p">[</span><span class="n">slide_evm_index</span><span class="p">];</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_evm_total</span> <span class="o">-=</span> <span class="n">last_evm</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_evm_total</span> <span class="o">+=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">SignalQuality</span><span class="p">;</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_evm</span><span class="p">[</span><span class="n">slide_evm_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">SignalQuality</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">slide_evm_index</span> <span class="o">&gt;=</span> <span class="n">PHY_RSSI_SLID_WIN_MAX</span><span class="p">)</span>
				<span class="n">slide_evm_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-242"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-242">&#182;</a></div><p>&lt;1> Showed on UI for user, in percentage.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tmp_val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">slide_evm_total</span><span class="o">/</span><span class="n">slide_evm_statistics</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">signal_quality</span> <span class="o">=</span> <span class="n">tmp_val</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-243"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-243">&#182;</a></div><p>cosa add 10/11/2007, Showed on UI for user in Windows Vista, for Link quality.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">last_signal_strength_inpercent</span> <span class="o">=</span> <span class="n">tmp_val</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-244"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-244">&#182;</a></div><p>&lt;2> Showed on UI for engineering</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketToSelf</span> <span class="o">||</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bPacketBeacon</span> <span class="o">||</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">bToSelfBA</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="n">nspatial_stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nspatial_stream</span><span class="o">&lt;</span><span class="mi">2</span> <span class="p">;</span> <span class="n">nspatial_stream</span><span class="o">++</span><span class="p">)</span> <span class="c1">// 2 spatial stream</span>
			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="n">nspatial_stream</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_evm_percentage</span><span class="p">[</span><span class="n">nspatial_stream</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="c1">// initialize</span>
					<span class="p">{</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_evm_percentage</span><span class="p">[</span><span class="n">nspatial_stream</span><span class="p">]</span> <span class="o">=</span> <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="n">nspatial_stream</span><span class="p">];</span>
					<span class="p">}</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_evm_percentage</span><span class="p">[</span><span class="n">nspatial_stream</span><span class="p">]</span> <span class="o">=</span>
						<span class="p">(</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_evm_percentage</span><span class="p">[</span><span class="n">nspatial_stream</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="n">nspatial_stream</span><span class="p">]</span><span class="o">*</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">Rx_Smooth_Factor</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>


<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------------------</span>
<span class="cm"> * Function:	rtl819x_query_rxpwrpercentage()</span>
<span class="cm"> *</span>
<span class="cm"> * Overview:</span>
<span class="cm"> *</span>
<span class="cm"> * Input:		char		antpower</span>
<span class="cm"> *</span>
<span class="cm"> * Output:		NONE</span>
<span class="cm"> *</span>
<span class="cm"> * Return:		0-100 percentage</span>
<span class="cm"> *</span>
<span class="cm"> * Revised History:</span>
<span class="cm"> *	When		Who		Remark</span>
<span class="cm"> *	05/26/2008	amy		Create Version 0 porting from windows code.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">rtl819x_query_rxpwrpercentage</span><span class="p">(</span>
	<span class="kt">char</span>		<span class="n">antpower</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">antpower</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">antpower</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">return</span>	<span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antpower</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span>	<span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span>	<span class="p">(</span><span class="mi">100</span><span class="o">+</span><span class="n">antpower</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>	<span class="cm">/* QueryRxPwrPercentage */</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">rtl819x_evm_dbtopercentage</span><span class="p">(</span>
    <span class="kt">char</span> <span class="n">value</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">ret_val</span><span class="p">;</span>

    <span class="n">ret_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ret_val</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">33</span><span class="p">)</span>
        <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">33</span><span class="p">;</span>
    <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ret_val</span><span class="p">;</span>
    <span class="n">ret_val</span><span class="o">*=</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ret_val</span> <span class="o">==</span> <span class="mi">99</span><span class="p">)</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ret_val</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-245"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-245">&#182;</a></div><p>Description:
    We want good-looking for signal strength/quality
2007/7/19 01:09, by cosa.</p></td><td class="code"><div class="highlight"><pre><span class="kt">long</span>
<span class="nf">rtl819x_signal_scale_mapping</span><span class="p">(</span>
	<span class="kt">long</span> <span class="n">currsig</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">retsig</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-246"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-246">&#182;</a></div><p>Step 1. Scale mapping.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">&gt;=</span> <span class="mi">61</span> <span class="o">&amp;&amp;</span> <span class="n">currsig</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">+</span> <span class="p">((</span><span class="n">currsig</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">&gt;=</span> <span class="mi">41</span> <span class="o">&amp;&amp;</span> <span class="n">currsig</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">78</span> <span class="o">+</span> <span class="p">((</span><span class="n">currsig</span> <span class="o">-</span> <span class="mi">40</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">&gt;=</span> <span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">currsig</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">66</span> <span class="o">+</span> <span class="p">(</span><span class="n">currsig</span> <span class="o">-</span> <span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">&gt;=</span> <span class="mi">21</span> <span class="o">&amp;&amp;</span> <span class="n">currsig</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">54</span> <span class="o">+</span> <span class="p">(</span><span class="n">currsig</span> <span class="o">-</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">currsig</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="p">(((</span><span class="n">currsig</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">currsig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">retsig</span> <span class="o">=</span> <span class="n">currsig</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retsig</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_query_rxphystatus</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span> <span class="n">priv</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span> <span class="n">pstats</span><span class="p">,</span>
	<span class="n">rx_drvinfo_819x_usb</span>  <span class="o">*</span> <span class="n">pdrvinfo</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span> <span class="n">precord_stats</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">bpacket_match_bssid</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">bpacket_toself</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">bPacketBeacon</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">bToSelfBA</span>
	<span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-247"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-247">&#182;</a></div><p>PRT<em>RFD</em>STATUS        pRtRfdStatus = &amp;(pRfd->Status);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">phy_sts_ofdm_819xusb_t</span><span class="o">*</span>	<span class="n">pofdm_buf</span><span class="p">;</span>
	<span class="n">phy_sts_cck_819xusb_t</span>	<span class="o">*</span>	<span class="n">pcck_buf</span><span class="p">;</span>
	<span class="n">phy_ofdm_rx_status_rxsc_sgien_exintfflag</span><span class="o">*</span> <span class="n">prxsc</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="o">*</span><span class="n">prxpkt</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">i</span><span class="p">,</span> <span class="n">max_spatial_stream</span><span class="p">,</span> <span class="n">tmp_rxsnr</span><span class="p">,</span> <span class="n">tmp_rxevm</span><span class="p">,</span> <span class="n">rxsc_sgien_exflg</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="n">rx_pwr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rx_pwr_all</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-248"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-248">&#182;</a></div><p>long                rx<em>avg</em>pwr = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">char</span>				<span class="n">rx_snrX</span><span class="p">,</span> <span class="n">rx_evmX</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">evm</span><span class="p">,</span> <span class="n">pwdb_all</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">RSSI</span><span class="p">,</span> <span class="n">total_rssi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="c1">//, total_evm=0;</span></pre></div></td></tr>


<tr id="section-249"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-249">&#182;</a></div><p>long                signal<em>strength</em>index = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span>				<span class="n">is_cck_rate</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>				<span class="n">rf_rx_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">numqry_phystatus</span><span class="o">++</span><span class="p">;</span>

	<span class="n">is_cck_rate</span> <span class="o">=</span> <span class="n">rx_hal_is_cck_rate</span><span class="p">(</span><span class="n">pdrvinfo</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-250"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-250">&#182;</a></div><p>Record it for next packet processing</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span><span class="n">precord_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_stats</span><span class="p">));</span>
	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bPacketMatchBSSID</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">bPacketMatchBSSID</span> <span class="o">=</span> <span class="n">bpacket_match_bssid</span><span class="p">;</span>
	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bPacketToSelf</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">bPacketToSelf</span> <span class="o">=</span> <span class="n">bpacket_toself</span><span class="p">;</span>
	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bIsCCK</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">bIsCCK</span> <span class="o">=</span> <span class="n">is_cck_rate</span><span class="p">;</span><span class="c1">//RX_HAL_IS_CCK_RATE(pDrvInfo);</span>
	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bPacketBeacon</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">bPacketBeacon</span> <span class="o">=</span> <span class="n">bPacketBeacon</span><span class="p">;</span>
	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bToSelfBA</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">bToSelfBA</span> <span class="o">=</span> <span class="n">bToSelfBA</span><span class="p">;</span>

	<span class="n">prxpkt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">pdrvinfo</span><span class="p">;</span>

	<span class="cm">/* Move pointer to the 16th bytes. Phy status start address. */</span>
	<span class="n">prxpkt</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_drvinfo_819x_usb</span><span class="p">);</span>

	<span class="cm">/* Initial the cck and ofdm buffer pointer */</span>
	<span class="n">pcck_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_sts_cck_819xusb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">prxpkt</span><span class="p">;</span>
	<span class="n">pofdm_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_sts_ofdm_819xusb_t</span> <span class="o">*</span><span class="p">)</span><span class="n">prxpkt</span><span class="p">;</span>

	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">is_cck_rate</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-251"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-251">&#182;</a></div><p>(1)Hardware does not provide RSSI for CCK</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-252"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-252">&#182;</a></div><p>(2)PWDB, Average PWDB cacluated by hardware (for rate adaptive)</p></td><td class="code"><div class="highlight"><pre>		<span class="n">u8</span> <span class="n">report</span><span class="p">;</span><span class="c1">//, cck_agc_rpt;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">numqry_phystatusCCK</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bCckHighPower</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">report</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-253"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-253">&#182;</a></div><p>Fixed by Jacken from Bryant 2008-03-20
Original value is -38 , -26 , -14 , -2
Fixed value is -35 , -23 , -11 , 6</p></td><td class="code"><div class="highlight"><pre>				<span class="k">case</span> <span class="mh">0x3</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="o">-</span><span class="mi">35</span> <span class="o">-</span> <span class="p">(</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x2</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="o">-</span><span class="mi">23</span> <span class="o">-</span> <span class="p">(</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x1</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="o">-</span><span class="mi">11</span> <span class="o">-</span> <span class="p">(</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="p">(</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">;</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">report</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x3</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="o">-</span><span class="mi">35</span> <span class="o">-</span> <span class="p">((</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x2</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="o">-</span><span class="mi">23</span> <span class="o">-</span> <span class="p">((</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x1</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="o">-</span><span class="mi">11</span> <span class="o">-</span> <span class="p">((</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0</span>:
					<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="p">((</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">cck_agc_rpt</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">pwdb_all</span> <span class="o">=</span> <span class="n">rtl819x_query_rxpwrpercentage</span><span class="p">(</span><span class="n">rx_pwr_all</span><span class="p">);</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">=</span> <span class="n">pwdb_all</span><span class="p">;</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span> <span class="o">=</span> <span class="n">pwdb_all</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-254"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-254">&#182;</a></div><p>(3) Get Signal Quality (EVM)</p>

<p>if(bpacket<em>match</em>bssid)</p></td><td class="code"><div class="highlight"><pre>		<span class="p">{</span>
			<span class="n">u8</span>	<span class="n">sq</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">sq</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span>
			<span class="p">{</span>
				<span class="n">sq</span> <span class="o">=</span> <span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">sq_rpt</span><span class="p">;</span>

				<span class="k">if</span><span class="p">(</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">sq_rpt</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
					<span class="n">sq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pcck_buf</span><span class="o">-&gt;</span><span class="n">sq_rpt</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
					<span class="n">sq</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">sq</span> <span class="o">=</span> <span class="p">((</span><span class="mi">64</span><span class="o">-</span><span class="n">sq</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">44</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">=</span> <span class="n">sq</span><span class="p">;</span>
			<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sq</span><span class="p">;</span>
			<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">numqry_phystatusHT</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-255"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-255">&#182;</a></div><p>(1)Get RSSI for HT rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">RF90_PATH_A</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">NumTotalRFPath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-256"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-256">&#182;</a></div><p>2008/01/30 MH we will judge RF RX path now.</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">brfpath_rxenable</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">rf_rx_num</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl8192_phy_CheckIsLegalRFPath</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-257"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-257">&#182;</a></div><p>Fixed by Jacken from Bryant 2008-03-20
Original value is 106</p></td><td class="code"><div class="highlight"><pre>			<span class="n">rx_pwr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pofdm_buf</span><span class="o">-&gt;</span><span class="n">trsw_gain_X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x3F</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">106</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-258"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-258">&#182;</a></div><p>Get Rx snr value in DB</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tmp_rxsnr</span> <span class="o">=</span>	<span class="n">pofdm_buf</span><span class="o">-&gt;</span><span class="n">rxsnr_X</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">rx_snrX</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">tmp_rxsnr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-259"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-259">&#182;</a></div><p>rx_snrX >>= 1;</p></td><td class="code"><div class="highlight"><pre>			<span class="n">rx_snrX</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxSNRdB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">rx_snrX</span><span class="p">;</span>

			<span class="cm">/* Translate DBM to percentage. */</span>
			<span class="n">RSSI</span> <span class="o">=</span> <span class="n">rtl819x_query_rxpwrpercentage</span><span class="p">(</span><span class="n">rx_pwr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">total_rssi</span> <span class="o">+=</span> <span class="n">RSSI</span><span class="p">;</span>

			<span class="cm">/* Record Signal Strength for next packet */</span></pre></div></td></tr>


<tr id="section-260"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-260">&#182;</a></div><p>if(bpacket<em>match</em>bssid)</p></td><td class="code"><div class="highlight"><pre>			<span class="p">{</span>
				<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalStrength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">RSSI</span><span class="p">;</span>
				<span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalStrength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">RSSI</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-261"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-261">&#182;</a></div><p>(2)PWDB, Average PWDB cacluated by hardware (for rate adaptive)</p>

<p>Fixed by Jacken from Bryant 2008-03-20
Original value is 106</p></td><td class="code"><div class="highlight"><pre>		<span class="n">rx_pwr_all</span> <span class="o">=</span> <span class="p">(((</span><span class="n">pofdm_buf</span><span class="o">-&gt;</span><span class="n">pwdb_all</span> <span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="p">)</span><span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">-</span><span class="mi">106</span><span class="p">;</span>
		<span class="n">pwdb_all</span> <span class="o">=</span> <span class="n">rtl819x_query_rxpwrpercentage</span><span class="p">(</span><span class="n">rx_pwr_all</span><span class="p">);</span>

		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxPWDBAll</span> <span class="o">=</span> <span class="n">pwdb_all</span><span class="p">;</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxPower</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxPower</span> <span class="o">=</span>  <span class="n">rx_pwr_all</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-262"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-262">&#182;</a></div><p>(3)EVM of HT rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">pdrvinfo</span><span class="o">-&gt;</span><span class="n">RxHT</span> <span class="o">&amp;&amp;</span> <span class="n">pdrvinfo</span><span class="o">-&gt;</span><span class="n">RxRate</span><span class="o">&gt;=</span><span class="n">DESC90_RATEMCS8</span> <span class="o">&amp;&amp;</span>
			<span class="n">pdrvinfo</span><span class="o">-&gt;</span><span class="n">RxRate</span><span class="o">&lt;=</span><span class="n">DESC90_RATEMCS15</span><span class="p">)</span>
			<span class="n">max_spatial_stream</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//both spatial stream make sense</span>
		<span class="k">else</span>
			<span class="n">max_spatial_stream</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//only spatial stream 1 makes sense</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">max_spatial_stream</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">tmp_rxevm</span> <span class="o">=</span>	<span class="n">pofdm_buf</span><span class="o">-&gt;</span><span class="n">rxevm_X</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">rx_evmX</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">tmp_rxevm</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-263"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-263">&#182;</a></div><p>Do not use shift operation like "rx_evmX >>= 1" because the compiler of free build environment
will set the most significant bit to "zero" when doing shifting operation which may change a negative
value to positive one, then the dbm value (which is supposed to be negative)  is not correct anymore.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">rx_evmX</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>	<span class="c1">//dbm</span>

			<span class="n">evm</span> <span class="o">=</span> <span class="n">rtl819x_evm_dbtopercentage</span><span class="p">(</span><span class="n">rx_evmX</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-264"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-264">&#182;</a></div><p>if(bpacket<em>match</em>bssid)</p></td><td class="code"><div class="highlight"><pre>			<span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// Fill value in RFD, Get the first spatial stream only</span>
					<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">SignalQuality</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evm</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">RxMIMOSignalQuality</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evm</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>


		<span class="cm">/* record rx statistics for debug */</span>
		<span class="n">rxsc_sgien_exflg</span> <span class="o">=</span> <span class="n">pofdm_buf</span><span class="o">-&gt;</span><span class="n">rxsc_sgien_exflg</span><span class="p">;</span>
		<span class="n">prxsc</span> <span class="o">=</span>	<span class="p">(</span><span class="n">phy_ofdm_rx_status_rxsc_sgien_exintfflag</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rxsc_sgien_exflg</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">pdrvinfo</span><span class="o">-&gt;</span><span class="n">BW</span><span class="p">)</span>	<span class="c1">//40M channel</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">received_bwtype</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">prxsc</span><span class="o">-&gt;</span><span class="n">rxsc</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>				<span class="c1">//20M channel</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">received_bwtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-265"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-265">&#182;</a></div><p>UI BSS List signal strength(in percentage), make it good looking, from 0~100.
It is assigned to the BSS List in GetValueFromBeaconOrProbeRsp().</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="n">is_cck_rate</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">rtl819x_signal_scale_mapping</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">pwdb_all</span><span class="p">));</span><span class="c1">//PWDB_ALL;</span>

	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-266"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-266">&#182;</a></div><p>pRfd->Status.SignalStrength = pRecordRfd->Status.SignalStrength = (u8)(SignalScaleMapping(total<em>rssi/=RF90</em>PATH<em>MAX));//(u8)(total</em>rssi/=RF90<em>PATH</em>MAX);
We can judge RX path number now.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">rf_rx_num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">=</span> <span class="n">precord_stats</span><span class="o">-&gt;</span><span class="n">SignalStrength</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">rtl819x_signal_scale_mapping</span><span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">total_rssi</span><span class="o">/=</span><span class="n">rf_rx_num</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>	<span class="cm">/* QueryRxPhyStatus8190Pci */</span>

<span class="kt">void</span>
<span class="nf">rtl8192_record_rxdesc_forlateruse</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span>	<span class="n">psrc_stats</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span>	<span class="n">ptarget_stats</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptarget_stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span> <span class="o">=</span> <span class="n">psrc_stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span><span class="p">;</span>
	<span class="n">ptarget_stats</span><span class="o">-&gt;</span><span class="n">bFirstMPDU</span> <span class="o">=</span> <span class="n">psrc_stats</span><span class="o">-&gt;</span><span class="n">bFirstMPDU</span><span class="p">;</span>
	<span class="n">ptarget_stats</span><span class="o">-&gt;</span><span class="n">Seq_Num</span> <span class="o">=</span> <span class="n">psrc_stats</span><span class="o">-&gt;</span><span class="n">Seq_Num</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">TranslateRxSignalStuff819xUsb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span> <span class="n">pstats</span><span class="p">,</span>
				   <span class="n">rx_drvinfo_819x_usb</span>  <span class="o">*</span><span class="n">pdrvinfo</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-267"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-267">&#182;</a></div><p>TODO: We must only check packet for current MAC address. Not finish</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">bpacket_match_bssid</span><span class="p">,</span> <span class="n">bpacket_toself</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bPacketBeacon</span><span class="o">=</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">bToSelfBA</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span>  <span class="n">previous_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span><span class="c1">//by amy</span>
       <span class="n">u16</span> <span class="n">fc</span><span class="p">,</span><span class="n">type</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-268"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-268">&#182;</a></div><p>Get Signal Quality for only RX data queue (but not command queue)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span><span class="o">*</span> <span class="n">tmp_buf</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-269"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-269">&#182;</a></div><p>u16 tmp<em>buf</em>len = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span>  <span class="o">*</span><span class="n">praddr</span><span class="p">;</span>

	<span class="cm">/* Get MAC frame start address. */</span>
	<span class="n">tmp_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span><span class="c1">// + get_rxpacket_shiftbytes_819xusb(pstats);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp_buf</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">praddr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">;</span>

	<span class="cm">/* Check if the received packet is acceptable. */</span>
	<span class="n">bpacket_match_bssid</span> <span class="o">=</span> <span class="p">((</span><span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
							<span class="p">(</span><span class="n">eqMacAddr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>  <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span><span class="o">?</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span> <span class="o">:</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="p">)</span><span class="o">?</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span> <span class="o">:</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">))</span>
								 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bHwError</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bCRC</span><span class="p">)</span><span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pstats</span><span class="o">-&gt;</span><span class="n">bICV</span><span class="p">));</span>
	<span class="n">bpacket_toself</span> <span class="o">=</span>  <span class="n">bpacket_match_bssid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">eqMacAddr</span><span class="p">(</span><span class="n">praddr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">));</span>

		<span class="k">if</span><span class="p">(</span><span class="n">WLAN_FC_GET_FRAMETYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span><span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">bPacketBeacon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-270"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-270">&#182;</a></div><p>DbgPrint("Beacon 2, MatchBSSID = %d, ToSelf = %d \n", bPacketMatchBSSID, bPacketToSelf);</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">WLAN_FC_GET_FRAMETYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BLOCKACK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">eqMacAddr</span><span class="p">(</span><span class="n">praddr</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)))</span>
				<span class="n">bToSelfBA</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-271"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-271">&#182;</a></div><p>DbgPrint("BlockAck, MatchBSSID = %d, ToSelf = %d \n", bPacketMatchBSSID, bPacketToSelf);</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>



	<span class="k">if</span><span class="p">(</span><span class="n">bpacket_match_bssid</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">numpacket_matchbssid</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bpacket_toself</span><span class="p">){</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">numpacket_toself</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-272"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-272">&#182;</a></div><p>Process PHY information for previous packet (RSSI/PWDB/EVM)</p>

<p>Because phy information is contained in the last packet of AMPDU only, so driver
should process phy information of previous packet</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rtl8192_process_phyinfo</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tmp_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">previous_stats</span><span class="p">,</span> <span class="n">pstats</span><span class="p">);</span>
	<span class="n">rtl8192_query_rxphystatus</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pstats</span><span class="p">,</span> <span class="n">pdrvinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">previous_stats</span><span class="p">,</span> <span class="n">bpacket_match_bssid</span><span class="p">,</span><span class="n">bpacket_toself</span><span class="p">,</span><span class="n">bPacketBeacon</span><span class="p">,</span><span class="n">bToSelfBA</span><span class="p">);</span>
	<span class="n">rtl8192_record_rxdesc_forlateruse</span><span class="p">(</span><span class="n">pstats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">previous_stats</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* Function:	UpdateReceivedRateHistogramStatistics</span>
<span class="cm">* Overview:	Record the received data rate</span>
<span class="cm">*</span>
<span class="cm">* Input:</span>
<span class="cm">* 	struct net_device *dev</span>
<span class="cm">*	struct ieee80211_rx_stats *stats</span>
<span class="cm">*</span>
<span class="cm">* Output:</span>
<span class="cm">*</span>
<span class="cm">*			(priv-&gt;stats.ReceivedRateHistogram[] is updated)</span>
<span class="cm">* Return:</span>
<span class="cm">*		None</span>
<span class="cm">*/</span>
<span class="kt">void</span>
<span class="nf">UpdateReceivedRateHistogramStatistics8190</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rcvType</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>   <span class="c1">//0: Total, 1:OK, 2:CRC, 3:ICV</span>
	<span class="n">u32</span> <span class="n">rateIndex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">preamble_guardinterval</span><span class="p">;</span>  <span class="c1">//1: short preamble/GI, 0: long preamble/GI</span>


	<span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bCRC</span><span class="p">)</span>
	<span class="n">rcvType</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bICV</span><span class="p">)</span>
	<span class="n">rcvType</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bShortPreamble</span><span class="p">)</span>
	<span class="n">preamble_guardinterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">// short</span>
	<span class="k">else</span>
	<span class="n">preamble_guardinterval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// long</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span>
	<span class="p">{</span></pre></div></td></tr>


<tr id="section-273"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-273">&#182;</a></div><p>CCK rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">MGN_1M</span>:    <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_2M</span>:    <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_5_5M</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_11M</span>:   <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-274"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-274">&#182;</a></div><p>Legacy OFDM rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">MGN_6M</span>:    <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_9M</span>:    <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_12M</span>:   <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_18M</span>:   <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_24M</span>:   <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_36M</span>:   <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_48M</span>:   <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_54M</span>:   <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-275"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-275">&#182;</a></div><p>11n High throughput rate</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">MGN_MCS0</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS1</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS2</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS3</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS4</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS5</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS6</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS7</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS8</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS9</span>:  <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS10</span>: <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS11</span>: <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS12</span>: <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS13</span>: <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS14</span>: <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_MCS15</span>: <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>        <span class="n">rateIndex</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">received_preamble_GI</span><span class="p">[</span><span class="n">preamble_guardinterval</span><span class="p">][</span><span class="n">rateIndex</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">received_rate_histogram</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">rateIndex</span><span class="p">]</span><span class="o">++</span><span class="p">;</span> <span class="c1">//total</span>
    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">received_rate_histogram</span><span class="p">[</span><span class="n">rcvType</span><span class="p">][</span><span class="n">rateIndex</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">query_rxdesc_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bIsRxAggrSubframe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-276"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-276">&#182;</a></div><p>rx<em>desc</em>819x<em>usb *desc = (rx</em>desc<em>819x</em>usb *)skb->data;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rx_drvinfo_819x_usb</span>  <span class="o">*</span><span class="n">driver_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-277"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-277">&#182;</a></div><p>Get Rx Descriptor Information</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bIsRxAggrSubframe</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">rx_desc_819x_usb_aggr_subframe</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_desc_819x_usb_aggr_subframe</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//RxBufShift = 2 in RxDesc, but usb didn&#39;t shift bytes in fact.</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bICV</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">ICV</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bCRC</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">CRC32</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bHwError</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bCRC</span><span class="o">|</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bICV</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">Decrypted</span> <span class="o">=</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">SWDec</span><span class="p">;</span><span class="c1">//RTL8190 set this bit to indicate that Hw does not decrypt packet</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">rx_desc_819x_usb</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_desc_819x_usb</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//desc-&gt;Shift&amp;0x03;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bICV</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">ICV</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bCRC</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">CRC32</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bHwError</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bCRC</span><span class="o">|</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bICV</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-278"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-278">&#182;</a></div><p>RTL8190 set this bit to indicate that Hw does not decrypt packet</p></td><td class="code"><div class="highlight"><pre>		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">Decrypted</span> <span class="o">=</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">SWDec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bHwError</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bHwError</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bCRC</span><span class="o">|</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bICV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">||</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">&gt;</span> <span class="n">MAX_8192U_RX_SIZE</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bHwError</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-279"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-279">&#182;</a></div><p>Get Driver Info</p>

<p>TODO: Need to verify it on FGPA platform
Driver info are written to the RxBuffer following rx desc</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_drvinfo_819x_usb</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">)</span> <span class="o">+</span> \
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span><span class="p">);</span>
		<span class="cm">/* unit: 0.5M */</span>
		<span class="cm">/* TODO */</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bHwError</span><span class="p">){</span>
			<span class="n">u8</span>	<span class="n">ret_rate</span><span class="p">;</span>
			<span class="n">ret_rate</span> <span class="o">=</span> <span class="n">HwRateToMRate90</span><span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">RxHT</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">RxRate</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ret_rate</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="p">{</span></pre></div></td></tr>


<tr id="section-280"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-280">&#182;</a></div><p>Abnormal Case: Receive CRC OK packet with Rx descriptor indicating non supported rate.
Special Error Handling here, 2008.05.16, by Emily</p></td><td class="code"><div class="highlight"><pre>				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bHwError</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">MGN_1M</span><span class="p">;</span>	<span class="c1">//Set 1M rate by default</span>
			<span class="p">}</span><span class="k">else</span>
			<span class="p">{</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">ret_rate</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>

		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bShortPreamble</span> <span class="o">=</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">SPLCP</span><span class="p">;</span>


		<span class="n">UpdateReceivedRateHistogramStatistics8190</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>

		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span> <span class="o">=</span> <span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">PartAggr</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bFirstMPDU</span> <span class="o">=</span> <span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">PartAggr</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">FirstAGGR</span><span class="o">==</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">TimeStampLow</span> <span class="o">=</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">TSFL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-281"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-281">&#182;</a></div><p>xiong mask it, 070514
pRfd->Status.TimeStampHigh = PlatformEFIORead4Byte(Adapter, TSFR+4);
stats->TimeStampHigh = read<em>nic</em>dword(dev,  TSFR+4);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">UpdateRxPktTimeStamp8190</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-282"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-282">&#182;</a></div><p>Rx A-MPDU</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">FirstAGGR</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">PartAggr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RXDESC</span><span class="p">,</span> <span class="s">&quot;driver_info-&gt;FirstAGGR = %d, driver_info-&gt;PartAggr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">FirstAGGR</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">PartAggr</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-283"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-283">&#182;</a></div><p>Get Total offset of MPDU Frame Body</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span><span class="p">((</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span> <span class="o">+</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">bShift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span> <span class="o">+</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
	<span class="cm">/* for the rx aggregated sub frame, the redundant space truly contained in the packet */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bIsRxAggrSubframe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* for debug 2008.5.29 */</span></pre></div></td></tr>


<tr id="section-284"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-284">&#182;</a></div><p>added by vivi, for MP, 20080108</p></td><td class="code"><div class="highlight"><pre>	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxIs40MHzPacket</span> <span class="o">=</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">BW</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">TranslateRxSignalStuff819xUsb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">driver_info</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">u32</span> <span class="nf">GetRxPacketShiftBytes819xUsb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_stats</span>  <span class="o">*</span><span class="n">Status</span><span class="p">,</span> <span class="n">bool</span> <span class="n">bIsRxAggrSubframe</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bIsRxAggrSubframe</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">)</span> <span class="o">+</span> <span class="n">Status</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span>
			<span class="o">+</span> <span class="n">Status</span><span class="o">-&gt;</span><span class="n">RxBufShift</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">)</span> <span class="o">+</span> <span class="n">Status</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span>
				<span class="o">+</span> <span class="n">Status</span><span class="o">-&gt;</span><span class="n">RxBufShift</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_rx_nomal</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">98</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-285"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-285">&#182;</a></div><pre><code> .mac_time = jiffies,
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">IEEE80211_24GHZ_BAND</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">rx_pkt_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_1addr</span> <span class="o">*</span><span class="n">ieee80211_hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">unicast_packet</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">agg_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">TotalLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">TempDWord</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">PacketLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">PacketOccupiedLendth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="n">TempByte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">PacketShiftBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_desc_819x_usb_aggr_subframe</span> <span class="o">*</span><span class="n">RxDescr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">PaddingBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-286"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-286">&#182;</a></div><p>add just for testing</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span>   <span class="n">testing</span><span class="p">;</span>

<span class="cp">#endif</span>

	<span class="cm">/* 20 is for ps-poll */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span><span class="p">(</span><span class="mi">20</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">RX_URB_SIZE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
		<span class="n">TempByte</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="cm">/* first packet should not contain Rx aggregation header */</span>
		<span class="n">query_rxdesc_status</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="cm">/* TODO */</span>
		<span class="cm">/* hardware related info */</span>
<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TempByte</span> <span class="o">&amp;</span> <span class="n">BIT0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">agg_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-287"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-287">&#182;</a></div><p>TotalLength = agg_skb->len - 4; /<em>sCrcLng</em>/</p></td><td class="code"><div class="highlight"><pre>			<span class="n">TotalLength</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">Length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/*sCrcLng*/</span></pre></div></td></tr>


<tr id="section-288"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-288">&#182;</a></div><p>RT<em>TRACE(COMP</em>RECV, "%s:first aggregated packet!Length=%d\n",<strong>FUNCTION</strong>,TotalLength);</p></td><td class="code"><div class="highlight"><pre>			<span class="cm">/* though the head pointer has passed this position  */</span>
			<span class="n">TempDWord</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">PacketLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">TempDWord</span> <span class="o">&amp;</span> <span class="mh">0x3FFF</span><span class="p">);</span> <span class="cm">/*sCrcLng*/</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">PacketLength</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">PacketLength</span><span class="p">),</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">PacketLength</span><span class="p">);</span>
			<span class="n">PacketShiftBytes</span> <span class="o">=</span> <span class="n">GetRxPacketShiftBytes819xUsb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* Process the MPDU received */</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="cm">/*sCrcLng*/</span><span class="p">);</span>

		<span class="n">rx_pkt_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">ieee80211_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_1addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">unicast_packet</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">ieee80211_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-289"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-289">&#182;</a></div><p>TODO</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">ieee80211_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)){</span></pre></div></td></tr>


<tr id="section-290"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-290">&#182;</a></div><p>TODO</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* unicast packet */</span>
			<span class="n">unicast_packet</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxoktotal</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">unicast_packet</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span> <span class="o">+=</span> <span class="n">rx_pkt_len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef USB_RX_AGGREGATION_SUPPORT</span>
		<span class="n">testing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-291"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-291">&#182;</a></div><p>(PipeIndex == 0) &amp;&amp; (TempByte &amp; BIT0) => TotalLength > 0.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">TotalLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PacketOccupiedLendth</span> <span class="o">=</span> <span class="n">PacketLength</span> <span class="o">+</span> <span class="p">(</span><span class="n">PacketShiftBytes</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">PacketOccupiedLendth</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">PacketOccupiedLendth</span> <span class="o">=</span> <span class="p">(</span><span class="n">PacketOccupiedLendth</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">)</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
			<span class="n">PacketOccupiedLendth</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">TempDWord</span> <span class="o">=</span> <span class="n">PacketOccupiedLendth</span> <span class="o">-</span> <span class="n">PacketShiftBytes</span><span class="p">;</span> <span class="cm">/*- PacketLength */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">TempDWord</span><span class="p">)</span>
				<span class="n">skb_pull</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span> <span class="n">TempDWord</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">&gt;=</span><span class="n">GetRxPacketShiftBytes819xUsb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">tmpCRC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmpICV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-292"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-292">&#182;</a></div><p>RT<em>TRACE(COMP</em>RECV,"%s:aggred pkt,total<em>len = %d\n",<strong>FUNCTION</strong>,agg</em>skb->len);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">RxDescr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_desc_819x_usb_aggr_subframe</span> <span class="o">*</span><span class="p">)(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
				<span class="n">tmpCRC</span> <span class="o">=</span> <span class="n">RxDescr</span><span class="o">-&gt;</span><span class="n">CRC32</span><span class="p">;</span>
				<span class="n">tmpICV</span> <span class="o">=</span> <span class="n">RxDescr</span><span class="o">-&gt;</span><span class="n">ICV</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">44</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">RxDescr</span><span class="o">-&gt;</span><span class="n">CRC32</span> <span class="o">=</span> <span class="n">tmpCRC</span><span class="p">;</span>
				<span class="n">RxDescr</span><span class="o">-&gt;</span><span class="n">ICV</span> <span class="o">=</span> <span class="n">tmpICV</span><span class="p">;</span>

				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_stats</span><span class="p">));</span>
				<span class="n">stats</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">stats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">98</span><span class="p">;</span>
				<span class="n">stats</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">stats</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">IEEE80211_24GHZ_BAND</span><span class="p">;</span>
				<span class="n">query_rxdesc_status</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="n">PacketLength</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

				<span class="k">if</span><span class="p">(</span><span class="n">PacketLength</span> <span class="o">&gt;</span> <span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Process the MPDU received */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">PacketLength</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">PacketLength</span><span class="p">),</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PacketLength</span><span class="p">);</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="cm">/*sCrcLng*/</span><span class="p">);</span>

				<span class="n">rx_pkt_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">ieee80211_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_1addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="n">unicast_packet</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">ieee80211_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-293"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-293">&#182;</a></div><p>TODO</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">ieee80211_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)){</span></pre></div></td></tr>


<tr id="section-294"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-294">&#182;</a></div><p>TODO</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* unicast packet */</span>
					<span class="n">unicast_packet</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">,</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxoktotal</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span><span class="p">(</span><span class="n">unicast_packet</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span> <span class="o">+=</span> <span class="n">rx_pkt_len</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="cm">/* should trim the packet which has been copied to target skb */</span>
				<span class="n">skb_pull</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span> <span class="n">PacketLength</span><span class="p">);</span>
				<span class="n">PacketShiftBytes</span> <span class="o">=</span> <span class="n">GetRxPacketShiftBytes819xUsb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="n">PacketOccupiedLendth</span> <span class="o">=</span> <span class="n">PacketLength</span> <span class="o">+</span> <span class="n">PacketShiftBytes</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">PacketOccupiedLendth</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">PaddingBytes</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="p">(</span><span class="n">PacketOccupiedLendth</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PaddingBytes</span><span class="p">)</span>
						<span class="n">skb_pull</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">,</span> <span class="n">PaddingBytes</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">agg_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">agg_skb</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxurberr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;actual_length:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">rtl819xusb_process_received_packet</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">pstats</span>
	<span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-295"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-295">&#182;</a></div><p>bool bfreerfd=false, bqueued=false;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">u8</span><span class="o">*</span> 	<span class="n">frame</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">frame_len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-296"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-296">&#182;</a></div><p>u8            index = 0;
u8            TID = 0;
u16            seqnum = 0;
PRX<em>TS</em>RECORD    pts = NULL;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-297"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-297">&#182;</a></div><p>Get shifted bytes of Starting address of 802.11 header. 2006.09.28, by Emily
porting by amy 080508</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pstats</span><span class="o">-&gt;</span><span class="n">virtual_address</span> <span class="o">+=</span> <span class="n">get_rxpacket_shiftbytes_819xusb</span><span class="p">(</span><span class="n">pstats</span><span class="p">);</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">virtual_address</span><span class="p">;</span>
	<span class="n">frame_len</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">-&gt;</span><span class="n">packetlength</span><span class="p">;</span>
<span class="cp">#ifdef TODO	</span><span class="c1">// by amy about HCT</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">bInHctTest</span><span class="p">)</span>
		<span class="n">CountRxErrStatistics</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pRfd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
	<span class="cp">#ifdef ENABLE_PS  </span><span class="c1">//by amy for adding ps function in future</span>
		<span class="n">RT_RF_POWER_STATE</span> <span class="n">rtState</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-298"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-298">&#182;</a></div><p>When RF is off, we should not count the packet for hw/sw synchronize
reason, ie. there may be a duration while sw switch is changed and hw
switch is being changed. 2006.12.04, by shien chang.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">Adapter</span><span class="o">-&gt;</span><span class="n">HalFunc</span><span class="p">.</span><span class="n">GetHwRegHandler</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">HW_VAR_RF_STATE</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span> <span class="p">)(</span><span class="o">&amp;</span><span class="n">rtState</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cp">#endif</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxframgment</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>
<span class="cp">#ifdef TODO</span>
	<span class="n">RmMonitorSignalStrength</span><span class="p">(</span><span class="n">Adapter</span><span class="p">,</span> <span class="n">pRfd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* 2007/01/16 MH Add RX command packet handle here. */</span>
	<span class="cm">/* 2007/03/01 MH We have to release RFD and return if rx pkt is cmd pkt. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl819xusb_rx_command_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pstats</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef SW_CRC_CHECK</span>
	<span class="n">SwCrcCheck</span><span class="p">();</span>
<span class="cp">#endif</span>


<span class="p">}</span>

<span class="kt">void</span> <span class="nf">query_rx_cmdpkt_desc_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-299"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-299">&#182;</a></div><p>rtl8192<em>rx</em>info *info = (struct rtl8192<em>rx</em>info *)skb->cb;
struct net<em>device *dev=info->dev;
struct r8192</em>priv *priv = (struct r8192<em>priv *)ieee80211</em>priv(dev);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">rx_desc_819x_usb</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_desc_819x_usb</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-300"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-300">&#182;</a></div><p>rx<em>drvinfo</em>819x<em>usb  *driver</em>info;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-301"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-301">&#182;</a></div><p>Get Rx Descriptor Information</p></td><td class="code"><div class="highlight"><pre>	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">virtual_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxDrvInfoSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxBufShift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">packetlength</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">Length</span><span class="o">-</span><span class="n">scrclng</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">fraglength</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">packetlength</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">fragoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">ntotalfrag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_rx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-302"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-302">&#182;</a></div><p>int ret;
struct urb *rx_urb = info->urb;</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* TODO */</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">98</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-303"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-303">&#182;</a></div><pre><code> .mac_time = jiffies,
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">IEEE80211_24GHZ_BAND</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span><span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span><span class="p">(</span><span class="mi">20</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_desc_819x_usb</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">RX_URB_SIZE</span><span class="p">))</span>
	<span class="p">{</span>

		<span class="n">query_rx_cmdpkt_desc_status</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-304"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-304">&#182;</a></div><p>this is to be done by amy 080508     prfd->queue_id = 1;</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-305"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-305">&#182;</a></div><p>Process the command packet received.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">rtl819xusb_process_received_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>

		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="p">;</span>


<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_irq_rx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8192_rx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">out_pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Nomal packet pipe */</span>
			<span class="k">case</span> <span class="mi">3</span>:</pre></div></td></tr>


<tr id="section-306"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-306">&#182;</a></div><p>RT<em>TRACE(COMP</em>RECV, "normal in-pipe index(%d)\n",info->out_pipe);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">IrpPendingCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">rtl8192_rx_nomal</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

				<span class="cm">/* Command packet pipe */</span>
			<span class="k">case</span> <span class="mi">9</span>:
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RECV</span><span class="p">,</span> <span class="s">&quot;command in-pipe index(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">out_pipe</span><span class="p">);</span>

				<span class="n">rtl8192_rx_cmd</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span> <span class="cm">/* should never get here! */</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Unknown in-pipe index(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>\
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">out_pipe</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rtl8192_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>               <span class="o">=</span> <span class="n">rtl8192_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>               <span class="o">=</span> <span class="n">rtl8192_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>          <span class="o">=</span> <span class="n">rtl8192_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>         <span class="o">=</span> <span class="n">tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>           <span class="o">=</span> <span class="n">rtl8192_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">r8192_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>    <span class="o">=</span> <span class="n">r8192_set_mac_adr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>      <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>         <span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>         <span class="o">=</span> <span class="n">ieee80211_xmit</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/****************************************************************************</span>
<span class="cm">     ---------------------------- USB_STUFF---------------------------</span>
<span class="cm">*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rtl8192_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-307"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-307">&#182;</a></div><p>unsigned long ioaddr = 0;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Oops: i&#39;m coming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_ieee80211</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">=</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl8192_netdev_ops</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-308"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-308">&#182;</a></div><p>DMESG("Oops: i'm coming\n");</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if WIRELESS_EXT &gt;= 12</span>
<span class="cp">#if WIRELESS_EXT &lt; 17</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">r8192_get_wireless_stats</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">r8192_wx_handlers_def</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">=</span><span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>	<span class="c1">//modified by john, 0805</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Oops: devname already taken! Trying wlan%%d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ifname</span> <span class="o">=</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">;</span>
		<span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Driver probe completed1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rtl8192_init</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Initialization failed&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;dev name=======&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">rtl8192_proc_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Driver probe completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail2:</span>
	<span class="n">rtl8192_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rtl8192_usb_deleteendpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">free_ieee80211</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;wlan driver load failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-309"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-309">&#182;</a></div><p>detach all the work and timer structure declared or inititialize in r8192U_init function.</p></td><td class="code"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="o">*</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_beacon_wq</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-310"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-310">&#182;</a></div><p>cancel<em>work</em>sync(&amp;priv->SetBWModeWorkItem);
cancel<em>work</em>sync(&amp;priv->SwChnlWorkItem);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">rtl8192_usb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="p">){</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;=============&gt;wlan driver to be removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl8192_proc_remove_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">rtl8192_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-311"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-311">&#182;</a></div><p>priv->rf<em>close(dev);
    rtl8192</em>SetRFPowerState(dev, eRfOff);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">rtl8192_usb_deleteendpoints</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-312"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-312">&#182;</a></div><p>rtl8192<em>irq</em>disable(dev);
rtl8192_reset(dev);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">free_ieee80211</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;wlan driver removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* fun with the built-in ieee80211 stack... */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_debug_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_deinit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_tkip_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_tkip_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_ccmp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_ccmp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">ieee80211_crypto_wep_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ieee80211_crypto_wep_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rtl8192_usb_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IEEE80211_DEBUG</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_debug_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_debug_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_tkip_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_tkip_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_ccmp_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_ccmp_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_crypto_wep_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ieee80211_crypto_wep_init() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Linux kernel driver for RTL8192 based WLAN cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Copyright (c) 2007-2008, Realsil Wlan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Initializing module&quot;</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Wireless extensions version %d&quot;</span><span class="p">,</span> <span class="n">WIRELESS_EXT</span><span class="p">);</span>
	<span class="n">rtl8192_proc_module_init</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8192_usb_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rtl8192_usb_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8192_usb_driver</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;Exiting&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-313"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-313">&#182;</a></div><p>rtl8192<em>proc</em>module_remove();</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_try_wake_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">enough_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">enough_desc</span> <span class="o">=</span> <span class="n">check_nic_enough_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">pri</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">enough_desc</span><span class="p">)</span>
		<span class="n">ieee80211_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">EnableHWSecurityConfig8192</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">SECR_value</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	 <span class="k">struct</span> <span class="n">ieee80211_device</span><span class="o">*</span> <span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="p">;</span>
	<span class="n">SECR_value</span> <span class="o">=</span> <span class="n">SCR_TxEncEnable</span> <span class="o">|</span> <span class="n">SCR_RxDecEnable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">KEY_TYPE_WEP40</span> <span class="o">==</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">KEY_TYPE_WEP104</span> <span class="o">==</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ieee80211</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">SECR_value</span> <span class="o">|=</span> <span class="n">SCR_RxUseDK</span><span class="p">;</span>
		<span class="n">SECR_value</span> <span class="o">|=</span> <span class="n">SCR_TxUseDK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">KEY_TYPE_CCMP</span> <span class="o">|</span> <span class="n">KEY_TYPE_TKIP</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">SECR_value</span> <span class="o">|=</span> <span class="n">SCR_RxUseDK</span><span class="p">;</span>
		<span class="n">SECR_value</span> <span class="o">|=</span> <span class="n">SCR_TxUseDK</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-314"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-314">&#182;</a></div><p>add HWSec active enable here.
default using hwsec. when peer AP is in N mode only and pairwise<em>key</em>type is none<em>aes(which HT</em>IOT<em>ACT</em>PURE<em>N</em>MODE indicates it), use software security. when peer AP is in b,g,n mode mixed and pairwise<em>key</em>type is none_aes, use g mode hw security. WB on 2008.7.4</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hwsec_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span><span class="o">&amp;</span><span class="n">HT_IOT_ACT_PURE_N_MODE</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">hwwep</span><span class="p">)</span><span class="c1">//!ieee-&gt;hwsec_support) //add hwsec_support flag to totol control hw_sec on/off</span>
	<span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hwsec_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SECR_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCR_RxDecEnable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_SEC</span><span class="p">,</span><span class="s">&quot;%s:, hwsec:%d, pairwise_key:%d, SECR_value:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> \
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hwsec_active</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span> <span class="n">SECR_value</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SECR</span><span class="p">,</span>  <span class="n">SECR_value</span><span class="p">);</span><span class="c1">//SECR_value |  SCR_UseDK );</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">setKey</span><span class="p">(</span>	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">EntryNo</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">KeyIndex</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">KeyType</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">MacAddr</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">DefaultKey</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">KeyContent</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">TargetCommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">TargetContent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">usConfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EntryNo</span> <span class="o">&gt;=</span> <span class="n">TOTAL_CAM_ENTRY</span><span class="p">)</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;cam entry exceeds in setKey()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_SEC</span><span class="p">,</span> <span class="s">&quot;====&gt;to setKey(), dev:%p, EntryNo:%d, KeyIndex:%d, KeyType:%d, MacAddr%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span><span class="n">EntryNo</span><span class="p">,</span> <span class="n">KeyIndex</span><span class="p">,</span> <span class="n">KeyType</span><span class="p">,</span> <span class="n">MacAddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DefaultKey</span><span class="p">)</span>
		<span class="n">usConfig</span> <span class="o">|=</span> <span class="n">BIT15</span> <span class="o">|</span> <span class="p">(</span><span class="n">KeyType</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usConfig</span> <span class="o">|=</span> <span class="n">BIT15</span> <span class="o">|</span> <span class="p">(</span><span class="n">KeyType</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">KeyIndex</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-315"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-315">&#182;</a></div><p>usConfig |= BIT15 | (KeyType&lt;&lt;2) | (DefaultKey&lt;&lt;5) | KeyIndex;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CAM_CONTENT_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">TargetCommand</span>  <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">CAM_CONTENT_COUNT</span><span class="o">*</span><span class="n">EntryNo</span><span class="p">;</span>
		<span class="n">TargetCommand</span> <span class="o">|=</span> <span class="n">BIT31</span><span class="o">|</span><span class="n">BIT16</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="c1">//MAC|Config</span>
			<span class="n">TargetContent</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">MacAddr</span><span class="o">+</span><span class="mi">0</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="o">|</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">MacAddr</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="o">|</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">usConfig</span><span class="p">;</span>

			<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WCAMI</span><span class="p">,</span> <span class="n">TargetContent</span><span class="p">);</span>
			<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">,</span> <span class="n">TargetCommand</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-316"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-316">&#182;</a></div><pre><code>printk("setkey cam =%8x\n", read_cam(dev, i+6*EntryNo));
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span><span class="c1">//MAC</span>
			<span class="n">TargetContent</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">MacAddr</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> 	 <span class="o">|</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">MacAddr</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="o">|</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">MacAddr</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="o">|</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">MacAddr</span><span class="o">+</span><span class="mi">5</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WCAMI</span><span class="p">,</span> <span class="n">TargetContent</span><span class="p">);</span>
			<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">,</span> <span class="n">TargetCommand</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-317"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-317">&#182;</a></div><p>Key Material</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="n">KeyContent</span> <span class="o">!=</span><span class="nb">NULL</span><span class="p">){</span>
			<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WCAMI</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">KeyContent</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="p">);</span>
			<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RWCAM</span><span class="p">,</span> <span class="n">TargetCommand</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">     ------------------- module init / exit stubs ----------------</span>
<span class="cm">****************************************************************************/</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">rtl8192_usb_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rtl8192_usb_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
