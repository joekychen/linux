<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › omapdrm › omap_dmm_tiler.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omap_dmm_tiler.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * DMM IOMMU driver support functions for TI OMAP processors.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Rob Clark &lt;rob@ti.com&gt;</span>
<span class="cm"> *         Andy Gross &lt;andy.gross@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed &quot;as is&quot; WITHOUT ANY WARRANTY of any</span>
<span class="cm"> * kind, whether express or implied; without even the implied warranty</span>
<span class="cm"> * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt; </span><span class="cm">/* platform_device() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>

<span class="cp">#include &quot;omap_dmm_tiler.h&quot;</span>
<span class="cp">#include &quot;omap_dmm_priv.h&quot;</span>

<span class="cp">#define DMM_DRIVER_NAME &quot;dmm&quot;</span>

<span class="cm">/* mappings for associating views to luts */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tcm</span> <span class="o">*</span><span class="n">containers</span><span class="p">[</span><span class="n">TILFMT_NFORMATS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dmm</span> <span class="o">*</span><span class="n">omap_dmm</span><span class="p">;</span>

<span class="cm">/* Geometry table */</span>
<span class="cp">#define GEOM(xshift, yshift, bytes_per_pixel) { \</span>
<span class="cp">		.x_shft = (xshift), \</span>
<span class="cp">		.y_shft = (yshift), \</span>
<span class="cp">		.cpp    = (bytes_per_pixel), \</span>
<span class="cp">		.slot_w = 1 &lt;&lt; (SLOT_WIDTH_BITS - (xshift)), \</span>
<span class="cp">		.slot_h = 1 &lt;&lt; (SLOT_HEIGHT_BITS - (yshift)), \</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">x_shft</span><span class="p">;</span>	<span class="cm">/* unused X-bits (as part of bpp) */</span>
	<span class="kt">uint32_t</span> <span class="n">y_shft</span><span class="p">;</span>	<span class="cm">/* unused Y-bits (as part of bpp) */</span>
	<span class="kt">uint32_t</span> <span class="n">cpp</span><span class="p">;</span>		<span class="cm">/* bytes/chars per pixel */</span>
	<span class="kt">uint32_t</span> <span class="n">slot_w</span><span class="p">;</span>	<span class="cm">/* width of each slot (in pixels) */</span>
	<span class="kt">uint32_t</span> <span class="n">slot_h</span><span class="p">;</span>	<span class="cm">/* height of each slot (in pixels) */</span>
<span class="p">}</span> <span class="n">geom</span><span class="p">[</span><span class="n">TILFMT_NFORMATS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">TILFMT_8BIT</span><span class="p">]</span>  <span class="o">=</span> <span class="n">GEOM</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		<span class="p">[</span><span class="n">TILFMT_16BIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">GEOM</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">[</span><span class="n">TILFMT_32BIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">GEOM</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
		<span class="p">[</span><span class="n">TILFMT_PAGE</span><span class="p">]</span>  <span class="o">=</span> <span class="n">GEOM</span><span class="p">(</span><span class="n">SLOT_WIDTH_BITS</span><span class="p">,</span> <span class="n">SLOT_HEIGHT_BITS</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/* lookup table for registers w/ per-engine instances */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">[][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">PAT_STATUS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">DMM_PAT_STATUS__0</span><span class="p">,</span> <span class="n">DMM_PAT_STATUS__1</span><span class="p">,</span>
				<span class="n">DMM_PAT_STATUS__2</span><span class="p">,</span> <span class="n">DMM_PAT_STATUS__3</span><span class="p">},</span>
		<span class="p">[</span><span class="n">PAT_DESCR</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span><span class="n">DMM_PAT_DESCR__0</span><span class="p">,</span> <span class="n">DMM_PAT_DESCR__1</span><span class="p">,</span>
				<span class="n">DMM_PAT_DESCR__2</span><span class="p">,</span> <span class="n">DMM_PAT_DESCR__3</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* simple allocator to grab next 16 byte aligned memory from txn */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmm_txn</span> <span class="o">*</span><span class="n">txn</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">refill_engine</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">engine_handle</span><span class="p">;</span>

	<span class="cm">/* dmm programming requires 16 byte aligned addresses */</span>
	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_pa</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_pa</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">round_up</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_va</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_va</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_pa</span><span class="p">;</span>

	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_pa</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_va</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_va</span> <span class="o">-</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">refill_va</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">REFILL_BUFFER_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check status and spin until wait_mask comes true */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">refill_engine</span> <span class="o">*</span><span class="n">engine</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">wait_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmm</span> <span class="o">*</span><span class="n">dmm</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">dmm</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">DMM_FIXED_RETRY_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[</span><span class="n">PAT_STATUS</span><span class="p">][</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="n">DMM_PATSTATUS_ERR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">wait_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">wait_mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">omap_dmm_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmm</span> <span class="o">*</span><span class="n">dmm</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_IRQSTATUS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* ack IRQ */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_IRQSTATUS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dmm</span><span class="o">-&gt;</span><span class="n">num_engines</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DMM_IRQSTAT_LST</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_for_refill</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get a handle for a DMM transaction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dmm_txn</span> <span class="o">*</span><span class="nf">dmm_txn_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmm</span> <span class="o">*</span><span class="n">dmm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcm</span> <span class="o">*</span><span class="n">tcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmm_txn</span> <span class="o">*</span><span class="n">txn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">refill_engine</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">engine_sem</span><span class="p">);</span>

	<span class="cm">/* grab an idle engine */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">idle_head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">engine</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">idle_head</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">refill_engine</span><span class="p">,</span>
					<span class="n">idle_node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">idle_node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">engine</span><span class="p">);</span>

	<span class="n">txn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">txn</span><span class="p">;</span>
	<span class="n">engine</span><span class="o">-&gt;</span><span class="n">tcm</span> <span class="o">=</span> <span class="n">tcm</span><span class="p">;</span>
	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">engine_handle</span> <span class="o">=</span> <span class="n">engine</span><span class="p">;</span>
	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">last_pat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_va</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">refill_va</span><span class="p">;</span>
	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">current_pa</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">refill_pa</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">txn</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Add region to DMM transaction.  If pages or pages[i] is NULL, then the</span>
<span class="cm"> * corresponding slot is cleared (ie. dummy_pa is programmed)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmm_txn_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmm_txn</span> <span class="o">*</span><span class="n">txn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pat_area</span> <span class="o">*</span><span class="n">area</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">npages</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">roll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">pat_pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pat</span> <span class="o">*</span><span class="n">pat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">refill_engine</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">engine_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">-</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">-</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">y0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">columns</span><span class="o">*</span><span class="n">rows</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">lut</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut</span> <span class="o">+</span> <span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="o">-&gt;</span><span class="n">lut_id</span> <span class="o">*</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_width</span> <span class="o">*</span>
			<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_height</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">y0</span> <span class="o">*</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">x0</span><span class="p">;</span>

	<span class="n">pat</span> <span class="o">=</span> <span class="n">alloc_dma</span><span class="p">(</span><span class="n">txn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pat</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pat_pa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txn</span><span class="o">-&gt;</span><span class="n">last_pat</span><span class="p">)</span>
		<span class="n">txn</span><span class="o">-&gt;</span><span class="n">last_pat</span><span class="o">-&gt;</span><span class="n">next_pa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">pat_pa</span><span class="p">;</span>

	<span class="n">pat</span><span class="o">-&gt;</span><span class="n">area</span> <span class="o">=</span> <span class="o">*</span><span class="n">area</span><span class="p">;</span>
	<span class="n">pat</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pat_ctrl</span><span class="p">){</span>
			<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">lut_id</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="o">-&gt;</span><span class="n">lut_id</span><span class="p">,</span>
		<span class="p">};</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">alloc_dma</span><span class="p">(</span><span class="n">txn</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pat</span><span class="o">-&gt;</span><span class="n">data_pa</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">roll</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">npages</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="n">npages</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pages</span> <span class="o">&amp;&amp;</span> <span class="n">pages</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">?</span>
			<span class="n">page_to_phys</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">:</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">dummy_pa</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill in lut with new addresses */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">lut</span> <span class="o">+=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_width</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">columns</span><span class="p">],</span> <span class="n">columns</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">last_pat</span> <span class="o">=</span> <span class="n">pat</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Commit the DMM transaction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmm_txn_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmm_txn</span> <span class="o">*</span><span class="n">txn</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">refill_engine</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">engine_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmm</span> <span class="o">*</span><span class="n">dmm</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">dmm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txn</span><span class="o">-&gt;</span><span class="n">last_pat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;need at least one txn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txn</span><span class="o">-&gt;</span><span class="n">last_pat</span><span class="o">-&gt;</span><span class="n">next_pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* write to PAT_DESCR to clear out any pending transaction */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[</span><span class="n">PAT_DESCR</span><span class="p">][</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>

	<span class="cm">/* wait for engine ready: */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_status</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">DMM_PATSTATUS_READY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* kick reload */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">refill_pa</span><span class="p">,</span>
		<span class="n">dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[</span><span class="n">PAT_DESCR</span><span class="p">][</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">wait_for_refill</span><span class="p">,</span>
				<span class="n">wait_status</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">DMM_PATSTATUS_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timed out waiting for done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">cleanup:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="o">-&gt;</span><span class="n">idle_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">idle_head</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engine_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DMM programming</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcm_area</span> <span class="o">*</span><span class="n">area</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">npages</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">roll</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_area</span> <span class="n">slice</span><span class="p">,</span> <span class="n">area_s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmm_txn</span> <span class="o">*</span><span class="n">txn</span><span class="p">;</span>

	<span class="n">txn</span> <span class="o">=</span> <span class="n">dmm_txn_init</span><span class="p">(</span><span class="n">omap_dmm</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">txn</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">txn</span><span class="p">);</span>

	<span class="n">tcm_for_each_slice</span><span class="p">(</span><span class="n">slice</span><span class="p">,</span> <span class="o">*</span><span class="n">area</span><span class="p">,</span> <span class="n">area_s</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pat_area</span> <span class="n">p_area</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">slice</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>  <span class="p">.</span><span class="n">y0</span> <span class="o">=</span> <span class="n">slice</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
				<span class="p">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">slice</span><span class="p">.</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>  <span class="p">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">slice</span><span class="p">.</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dmm_txn_append</span><span class="p">(</span><span class="n">txn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_area</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">roll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">roll</span> <span class="o">+=</span> <span class="n">tcm_sizeof</span><span class="p">(</span><span class="n">slice</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dmm_txn_commit</span><span class="p">(</span><span class="n">txn</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pin/unpin</span>
<span class="cm"> */</span>

<span class="cm">/* note: slots for which pages[i] == NULL are filled w/ dummy page</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tiler_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">npages</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">roll</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">npages</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">tiler_unpin</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tiler_unpin</span><span class="p">(</span><span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reserve/release</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="nf">tiler_reserve_2d</span><span class="p">(</span><span class="k">enum</span> <span class="n">tiler_fmt</span> <span class="n">fmt</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">w</span><span class="p">,</span>
		<span class="kt">uint16_t</span> <span class="n">h</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">min_align</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">validfmt</span><span class="p">(</span><span class="n">fmt</span><span class="p">));</span>

	<span class="cm">/* convert width/height to slots */</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_w</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_h</span><span class="p">);</span>

	<span class="cm">/* convert alignment to slots */</span>
	<span class="n">min_align</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">min_align</span><span class="p">,</span> <span class="p">(</span><span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_w</span> <span class="o">*</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">cpp</span><span class="p">));</span>
	<span class="n">align</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">align</span><span class="p">,</span> <span class="n">min_align</span><span class="p">);</span>
	<span class="n">align</span> <span class="o">/=</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_w</span> <span class="o">*</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">cpp</span><span class="p">;</span>

	<span class="n">block</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tcm_reserve_2d</span><span class="p">(</span><span class="n">containers</span><span class="p">[</span><span class="n">fmt</span><span class="p">],</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* add to allocation list */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">alloc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">alloc_head</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">block</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="nf">tiler_reserve_1d</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">block</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">TILFMT_PAGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcm_reserve_1d</span><span class="p">(</span><span class="n">containers</span><span class="p">[</span><span class="n">TILFMT_PAGE</span><span class="p">],</span> <span class="n">num_pages</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">alloc_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">alloc_head</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">block</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* note: if you have pin&#39;d pages, you should have already unpin&#39;d first! */</span>
<span class="kt">int</span> <span class="nf">tiler_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">tcm_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tcm</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to release block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">alloc_node</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Utils</span>
<span class="cm"> */</span>

<span class="cm">/* calculate the tiler space address of a pixel in a view orientation */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tiler_get_address</span><span class="p">(</span><span class="n">u32</span> <span class="n">orient</span><span class="p">,</span> <span class="k">enum</span> <span class="n">tiler_fmt</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">x_bits</span><span class="p">,</span> <span class="n">y_bits</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">x_mask</span><span class="p">,</span> <span class="n">y_mask</span><span class="p">,</span> <span class="n">alignment</span><span class="p">;</span>

	<span class="n">x_bits</span> <span class="o">=</span> <span class="n">CONT_WIDTH_BITS</span> <span class="o">-</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">x_shft</span><span class="p">;</span>
	<span class="n">y_bits</span> <span class="o">=</span> <span class="n">CONT_HEIGHT_BITS</span> <span class="o">-</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">y_shft</span><span class="p">;</span>
	<span class="n">alignment</span> <span class="o">=</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">x_shft</span> <span class="o">+</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">y_shft</span><span class="p">;</span>

	<span class="cm">/* validate coordinate */</span>
	<span class="n">x_mask</span> <span class="o">=</span> <span class="n">MASK</span><span class="p">(</span><span class="n">x_bits</span><span class="p">);</span>
	<span class="n">y_mask</span> <span class="o">=</span> <span class="n">MASK</span><span class="p">(</span><span class="n">y_bits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_mask</span> <span class="o">||</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">y_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* account for mirroring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orient</span> <span class="o">&amp;</span> <span class="n">MASK_X_INVERT</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">^=</span> <span class="n">x_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orient</span> <span class="o">&amp;</span> <span class="n">MASK_Y_INVERT</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">^=</span> <span class="n">y_mask</span><span class="p">;</span>

	<span class="cm">/* get coordinate address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orient</span> <span class="o">&amp;</span> <span class="n">MASK_XY_FLIP</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">y_bits</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="n">x_bits</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TIL_ADDR</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="n">alignment</span><span class="p">),</span> <span class="n">orient</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dma_addr_t</span> <span class="nf">tiler_ssptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">validfmt</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TILVIEW_8BIT</span> <span class="o">+</span> <span class="n">tiler_get_address</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span>
			<span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">geom</span><span class="p">[</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_w</span><span class="p">,</span>
			<span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">geom</span><span class="p">[</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_h</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tiler_align</span><span class="p">(</span><span class="k">enum</span> <span class="n">tiler_fmt</span> <span class="n">fmt</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">validfmt</span><span class="p">(</span><span class="n">fmt</span><span class="p">));</span>
	<span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_w</span><span class="p">);</span>
	<span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">slot_h</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">tiler_stride</span><span class="p">(</span><span class="k">enum</span> <span class="n">tiler_fmt</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">validfmt</span><span class="p">(</span><span class="n">fmt</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">CONT_WIDTH_BITS</span> <span class="o">+</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">y_shft</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">tiler_size</span><span class="p">(</span><span class="k">enum</span> <span class="n">tiler_fmt</span> <span class="n">fmt</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">w</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tiler_align</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">cpp</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">tiler_vsize</span><span class="p">(</span><span class="k">enum</span> <span class="n">tiler_fmt</span> <span class="n">fmt</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">w</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">validfmt</span><span class="p">(</span><span class="n">fmt</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">round_up</span><span class="p">(</span><span class="n">geom</span><span class="p">[</span><span class="n">fmt</span><span class="p">].</span><span class="n">cpp</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">dmm_is_initialized</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap_dmm</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_dmm_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="o">*</span><span class="n">_block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_dmm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* free all area regions */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">_block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">alloc_head</span><span class="p">,</span>
					<span class="n">alloc_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">alloc_node</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_lut</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span> <span class="o">&amp;&amp;</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">deinit</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_va</span><span class="p">)</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">REFILL_BUFFER_SIZE</span> <span class="o">*</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_engines</span><span class="p">,</span>
				<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_va</span><span class="p">,</span>
				<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_pa</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dummy_page</span><span class="p">)</span>
			<span class="n">__free_page</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dummy_page</span><span class="p">);</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">omap_dmm</span><span class="p">);</span>
		<span class="n">omap_dmm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_dmm_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_area</span> <span class="n">area</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">hwinfo</span><span class="p">,</span> <span class="n">pat_geom</span><span class="p">,</span> <span class="n">lut_table_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="n">omap_dmm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">omap_dmm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate driver data section</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* lookup hwmod data - base address and irq */</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get base address resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">SZ_2K</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get dmm base address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get IRQ resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">hwinfo</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_HWINFO</span><span class="p">);</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_engines</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwinfo</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_lut</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwinfo</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">container_width</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">container_height</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="cm">/* read out actual LUT width and height */</span>
	<span class="n">pat_geom</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_GEOMETRY</span><span class="p">);</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_width</span> <span class="o">=</span> <span class="p">((</span><span class="n">pat_geom</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_height</span> <span class="o">=</span> <span class="p">((</span><span class="n">pat_geom</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* initialize DMM registers */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x88888888</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_VIEW__0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x88888888</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_VIEW__1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x80808080</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_VIEW_MAP__0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_VIEW_MAP_BASE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x88888888</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_TILER_OR__0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x88888888</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_TILER_OR__1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">omap_dmm_irq_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				<span class="s">&quot;omap_dmm_irq_handler&quot;</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t register IRQ %d, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable all interrupts for each refill engine except</span>
<span class="cm">	 * ERR_LUT_MISS&lt;n&gt; (which is just advisory, and we don&#39;t care</span>
<span class="cm">	 * about because we want to be able to refill live scanout</span>
<span class="cm">	 * buffers for accelerated pan/scroll) and FILL_DSC&lt;n&gt; which</span>
<span class="cm">	 * we just generally don&#39;t care about.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x7e7e7e7e</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DMM_PAT_IRQENABLE_SET</span><span class="p">);</span>

	<span class="n">lut_table_size</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_width</span> <span class="o">*</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_height</span> <span class="o">*</span>
			<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_lut</span><span class="p">;</span>

	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">lut_table_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate lut table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dummy_page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_DMA32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dummy_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate dummy page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set dma mask for device */</span>
	<span class="cm">/* NOTE: this is a workaround for the hwmod not initializing properly */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dummy_pa</span> <span class="o">=</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dummy_page</span><span class="p">);</span>

	<span class="cm">/* alloc refill memory */</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_va</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">REFILL_BUFFER_SIZE</span> <span class="o">*</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_engines</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_pa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_va</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate refill memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* alloc engines */</span>
	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
			<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_engines</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">refill_engine</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate engines</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engine_sem</span><span class="p">,</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_engines</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">idle_head</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_engines</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dmm</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="p">;</span>
		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refill_va</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_va</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">REFILL_BUFFER_SIZE</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">refill_pa</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">refill_pa</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">REFILL_BUFFER_SIZE</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_for_refill</span><span class="p">);</span>

		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">engines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idle_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">idle_head</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_lut</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate lut ptrs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init containers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_lut</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sita_init</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">container_width</span><span class="p">,</span>
						<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">container_height</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate container</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lut_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* assign access mode containers to applicable tcm container */</span>
	<span class="cm">/* OMAP 4 has 1 container for all 4 views */</span>
	<span class="n">containers</span><span class="p">[</span><span class="n">TILFMT_8BIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">containers</span><span class="p">[</span><span class="n">TILFMT_16BIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">containers</span><span class="p">[</span><span class="n">TILFMT_32BIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">containers</span><span class="p">[</span><span class="n">TILFMT_PAGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">alloc_head</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcm_area</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">is2d</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">container_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">container_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lut_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dummy_pa</span><span class="p">;</span>

	<span class="cm">/* initialize all LUTs to dummy page entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">num_lut</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">area</span><span class="p">.</span><span class="n">tcm</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">tcm</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">area</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;refill failed&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialized all PAT entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">omap_dmm_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debugfs support</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alphabet</span> <span class="o">=</span> <span class="s">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
				<span class="s">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">special</span> <span class="o">=</span> <span class="s">&quot;.,:;&#39;</span><span class="se">\&quot;</span><span class="s">`~!^-+&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_map</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xdiv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ydiv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcm_area</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
							<span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ovw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">ovw</span><span class="p">)</span>
				<span class="n">map</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_map_pt</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xdiv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ydiv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcm_pt</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
									<span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">map</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">][</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="nf">read_map_pt</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xdiv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ydiv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcm_pt</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">map</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">][</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_width</span><span class="p">(</span><span class="kt">int</span> <span class="n">xdiv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">x1</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x0</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">text_map</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xdiv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">yd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">yd</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x0</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_width</span><span class="p">(</span><span class="n">xdiv</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">nice</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">w</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">nice</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">nice</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">map_1d_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xdiv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ydiv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nice</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">tcm_area</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">nice</span><span class="p">,</span> <span class="s">&quot;%dK&quot;</span><span class="p">,</span> <span class="n">tcm_sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">text_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">map_width</span><span class="p">(</span><span class="n">xdiv</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">text_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">,</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">xdiv</span><span class="p">,</span>	<span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">map_width</span><span class="p">(</span><span class="n">xdiv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">))</span>
			<span class="n">text_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">xdiv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">map_width</span><span class="p">(</span><span class="n">xdiv</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">text_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">map_2d_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xdiv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ydiv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nice</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">tcm_area</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">nice</span><span class="p">,</span> <span class="s">&quot;(%d*%d)&quot;</span><span class="p">,</span> <span class="n">tcm_awidth</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">),</span> <span class="n">tcm_aheight</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">map_width</span><span class="p">(</span><span class="n">xdiv</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">))</span>
		<span class="n">text_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">,</span>
							<span class="n">a</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">tiler_map_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xdiv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ydiv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">global_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tiler_block</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm_area</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">m2d</span> <span class="o">=</span> <span class="n">alphabet</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a2d</span> <span class="o">=</span> <span class="n">special</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">m2dp</span> <span class="o">=</span> <span class="n">m2d</span><span class="p">,</span> <span class="o">*</span><span class="n">a2dp</span> <span class="o">=</span> <span class="n">a2d</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nice</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">h_adj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">w_adj</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dmm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* early return if dmm/tiler device is not initialized */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h_adj</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_height</span> <span class="o">/</span> <span class="n">ydiv</span><span class="p">;</span>
	<span class="n">w_adj</span> <span class="o">=</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_width</span> <span class="o">/</span> <span class="n">xdiv</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">h_adj</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">global_map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">w_adj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h_adj</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span> <span class="o">||</span> <span class="o">!</span><span class="n">global_map</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">global_map</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">w_adj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h_adj</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">lut_height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_map</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">w_adj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">w_adj</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">alloc_head</span><span class="p">,</span> <span class="n">alloc_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">!=</span> <span class="n">TILFMT_PAGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fill_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">,</span> <span class="o">*</span><span class="n">m2dp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*++</span><span class="n">a2dp</span><span class="p">)</span>
				<span class="n">a2dp</span> <span class="o">=</span> <span class="n">a2d</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*++</span><span class="n">m2dp</span><span class="p">)</span>
				<span class="n">m2dp</span> <span class="o">=</span> <span class="n">m2d</span><span class="p">;</span>
			<span class="n">map_2d_info</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">start</span> <span class="o">=</span> <span class="n">read_map_pt</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">p0</span><span class="p">)</span>
									<span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="n">bool</span> <span class="n">end</span> <span class="o">=</span> <span class="n">read_map_pt</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">p1</span><span class="p">)</span>
									<span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="n">tcm_for_each_slice</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">fill_map</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">fill_map_pt</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">p0</span><span class="p">,</span>
							<span class="n">start</span> <span class="o">?</span> <span class="sc">&#39;&lt;&#39;</span> <span class="o">:</span> <span class="sc">&#39;X&#39;</span><span class="p">);</span>
			<span class="n">fill_map_pt</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">p1</span><span class="p">,</span>
							<span class="n">end</span> <span class="o">?</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">:</span> <span class="sc">&#39;X&#39;</span><span class="p">);</span>
			<span class="n">map_1d_info</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">ydiv</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;BEGIN DMM TILER MAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%03d:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;END TILER MAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BEGIN DMM TILER MAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%03d:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">omap_dmm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;END TILER MAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">global_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_dmm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">omap_dmm_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">omap_dmm_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DMM_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andy Gross &lt;andy.gross@ti.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP DMM/Tiler Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">DMM_DRIVER_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
