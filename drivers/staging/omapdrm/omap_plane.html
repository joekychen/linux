<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › omapdrm › omap_plane.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omap_plane.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/staging/omapdrm/omap_plane.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Texas Instruments</span>
<span class="cm"> * Author: Rob Clark &lt;rob.clark@linaro.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kfifo.h&gt;</span>

<span class="cp">#include &quot;omap_drv.h&quot;</span>

<span class="cm">/* some hackery because omapdss has an &#39;enum omap_plane&#39; (which would be</span>
<span class="cm"> * better named omap_plane_id).. and compiler seems unhappy about having</span>
<span class="cm"> * both a &#39;struct omap_plane&#39; and &#39;enum omap_plane&#39;</span>
<span class="cm"> */</span>
<span class="cp">#define omap_plane _omap_plane</span>

<span class="cm">/*</span>
<span class="cm"> * plane funcs</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">callback</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fxn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define to_omap_plane(x) container_of(x, struct omap_plane, base)</span>

<span class="k">struct</span> <span class="n">omap_plane</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="cm">/* Source values, converted to integers because we don&#39;t support</span>
<span class="cm">	 * fractional positions:</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_x</span><span class="p">,</span> <span class="n">src_y</span><span class="p">;</span>

	<span class="cm">/* last fb that we pinned: */</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">pinned_fb</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">nformats</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">formats</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* for synchronizing access to unpins fifo */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">unpin_mutex</span><span class="p">;</span>

	<span class="cm">/* set of bo&#39;s pending unpin until next END_WIN irq */</span>
	<span class="n">DECLARE_KFIFO_PTR</span><span class="p">(</span><span class="n">unpin_fifo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_unpins</span><span class="p">,</span> <span class="n">pending_num_unpins</span><span class="p">;</span>

	<span class="cm">/* for deferred unpin when we need to wait for scanout complete irq */</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>

	<span class="cm">/* callback on next endwin irq */</span>
	<span class="k">struct</span> <span class="n">callback</span> <span class="n">endwin</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* map from ovl-&gt;id to the irq we are interested in for scanout-done */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">id2irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">OMAP_DSS_GFX</span><span class="p">]</span>    <span class="o">=</span> <span class="n">DISPC_IRQ_GFX_END_WIN</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_VIDEO1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VID1_END_WIN</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_VIDEO2</span><span class="p">]</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VID2_END_WIN</span><span class="p">,</span>
		<span class="p">[</span><span class="n">OMAP_DSS_VIDEO3</span><span class="p">]</span> <span class="o">=</span> <span class="n">DISPC_IRQ_VID3_END_WIN</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispc_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_drm_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">omap_dispc_unregister_isr</span><span class="p">(</span><span class="n">dispc_isr</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span>
			<span class="n">id2irq</span><span class="p">[</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unpin_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_plane</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">callback</span> <span class="n">endwin</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;unpinning %d of %d&quot;</span><span class="p">,</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">num_unpins</span><span class="p">,</span>
			<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">num_unpins</span> <span class="o">+</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pending_num_unpins</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">num_unpins</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">kfifo_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_fifo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bo</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">omap_gem_put_paddr</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>
		<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>
		<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">num_unpins</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">endwin</span> <span class="o">=</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">endwin</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">endwin</span><span class="p">.</span><span class="n">fxn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endwin</span><span class="p">.</span><span class="n">fxn</span><span class="p">)</span>
		<span class="n">endwin</span><span class="p">.</span><span class="n">fxn</span><span class="p">(</span><span class="n">endwin</span><span class="p">.</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">install_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_dispc_register_isr</span><span class="p">(</span><span class="n">dispc_isr</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">id2irq</span><span class="p">[</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * omapdss has upper limit on # of registered irq handlers,</span>
<span class="cm">	 * which we shouldn&#39;t hit.. but if we do the limit should</span>
<span class="cm">	 * be raised or bad things happen:</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* push changes down to dss2 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%dx%d -&gt; %dx%d (%d)&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">out_width</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">out_height</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_width</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%d,%d %08x %08x&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">p_uv_addr</span><span class="p">);</span>

	<span class="cm">/* NOTE: do we want to do this at all here, or just wait</span>
<span class="cm">	 * for dpms(ON) since other CRTC&#39;s may not have their mode</span>
<span class="cm">	 * set yet, so fb dimensions may still change..</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">set_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not set overlay info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">num_unpins</span> <span class="o">+=</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pending_num_unpins</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pending_num_unpins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>

	<span class="cm">/* our encoder doesn&#39;t necessarily get a commit() after this, in</span>
<span class="cm">	 * particular in the dpms() and mode_set_base() cases, so force the</span>
<span class="cm">	 * manager to update:</span>
<span class="cm">	 *</span>
<span class="cm">	 * could this be in the encoder somehow?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">apply</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not apply settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * NOTE: really this should be atomic w/ mgr-&gt;apply() but</span>
<span class="cm">		 * omapdss does not expose such an API</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">num_unpins</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">install_irq</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_drm_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">ovl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">omap_framebuffer_flush</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">out_width</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">out_height</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* when CRTC that we are attached to has potentially changed, this checks</span>
<span class="cm"> * if we are attached to proper manager, and if necessary updates.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_drm_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_overlay_manager</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_encoders</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encoders</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mgr</span> <span class="o">=</span> <span class="n">omap_encoder_get_manager</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">!=</span> <span class="n">mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>

		<span class="cm">/* don&#39;t switch things around with enabled overlays: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
			<span class="n">omap_plane_dpms</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;disconnecting %s from %s&quot;</span><span class="p">,</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">unset_manager</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;connecting %s to %s&quot;</span><span class="p">,</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">set_manager</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="n">mgr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">mgr</span><span class="p">)</span>
			<span class="n">omap_plane_dpms</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unpin</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_fifo</span><span class="p">,</span>
			<span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pending_num_unpins</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* also hold a ref so it isn&#39;t free&#39;d while pinned */</span>
		<span class="n">drm_gem_object_reference</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unpin fifo full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">omap_gem_put_paddr</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* update which fb (if any) is pinned for scanout */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">pinned_fb</span> <span class="o">=</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pinned_fb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pinned_fb</span> <span class="o">!=</span> <span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%p -&gt; %p&quot;</span><span class="p">,</span> <span class="n">pinned_fb</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_framebuffer_replace</span><span class="p">(</span><span class="n">pinned_fb</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">unpin</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not swap %p -&gt; %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pinned_fb</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>
			<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pinned_fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pinned_fb</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* update parameters that are dependent on the framebuffer dimensions and</span>
<span class="cm"> * position within the fb that this plane scans out from. This is called</span>
<span class="cm"> * when framebuffer or x,y base may have changed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_scanout</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_overlay_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">update_pin</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;could not pin fb: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">omap_plane_dpms</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_framebuffer_update_scanout</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span>
			<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">src_x</span><span class="p">,</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">src_y</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: %d,%d: %08x %08x (%d)&quot;</span><span class="p">,</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">src_x</span><span class="p">,</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">src_y</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">p_uv_addr</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_width</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_plane_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">crtc_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc_y</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crtc_w</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crtc_h</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">src_x</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">src_y</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">src_w</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">src_h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="cm">/* src values are in Q16 fixed point, convert to integer: */</span>
	<span class="n">src_x</span> <span class="o">=</span> <span class="n">src_x</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">src_y</span> <span class="o">=</span> <span class="n">src_y</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">src_w</span> <span class="o">=</span> <span class="n">src_w</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">src_h</span> <span class="o">=</span> <span class="n">src_h</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pos_x</span> <span class="o">=</span> <span class="n">crtc_x</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pos_y</span> <span class="o">=</span> <span class="n">crtc_y</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">out_width</span> <span class="o">=</span> <span class="n">crtc_w</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">out_height</span> <span class="o">=</span> <span class="n">crtc_h</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">src_w</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">src_h</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">src_x</span> <span class="o">=</span> <span class="n">src_x</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">src_y</span> <span class="o">=</span> <span class="n">src_y</span><span class="p">;</span>

	<span class="cm">/* note: this is done after this fxn returns.. but if we need</span>
<span class="cm">	 * to do a commit/update_scanout, etc before this returns we</span>
<span class="cm">	 * need the current value.</span>
<span class="cm">	 */</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>

	<span class="n">update_scanout</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">update_manager</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_plane_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">crtc_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc_y</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crtc_w</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crtc_h</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">src_x</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">src_y</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">src_w</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">src_h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_plane_mode_set</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">crtc_x</span><span class="p">,</span> <span class="n">crtc_y</span><span class="p">,</span> <span class="n">crtc_w</span><span class="p">,</span> <span class="n">crtc_h</span><span class="p">,</span>
			<span class="n">src_x</span><span class="p">,</span> <span class="n">src_y</span><span class="p">,</span> <span class="n">src_w</span><span class="p">,</span> <span class="n">src_h</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">omap_plane_dpms</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_plane_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap_plane_dpms</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_plane_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">omap_plane_disable</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">drm_plane_cleanup</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">pending_num_unpins</span> <span class="o">+</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">num_unpins</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_fifo</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">omap_plane</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_plane_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: %d&quot;</span><span class="p">,</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_scanout</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">commit</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">omap_drm_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>
		<span class="n">update_pin</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_plane_on_endwin</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fxn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span> <span class="o">=</span> <span class="n">to_omap_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">endwin</span><span class="p">.</span><span class="n">fxn</span> <span class="o">=</span> <span class="n">fxn</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">endwin</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>

	<span class="n">install_irq</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_plane_funcs</span> <span class="n">omap_plane_funcs</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">update_plane</span> <span class="o">=</span> <span class="n">omap_plane_update</span><span class="p">,</span>
		<span class="p">.</span><span class="n">disable_plane</span> <span class="o">=</span> <span class="n">omap_plane_disable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">omap_plane_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* initialize plane */</span>
<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="nf">omap_plane_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">omap_overlay</span> <span class="o">*</span><span class="n">ovl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">possible_crtcs</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_plane</span> <span class="o">*</span><span class="n">omap_plane</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: possible_crtcs=%08x, priv=%d&quot;</span><span class="p">,</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">possible_crtcs</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* friendly reminder to update table for future hw: */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">id2irq</span><span class="p">));</span>

	<span class="n">omap_plane</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">omap_plane</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_plane</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate plane</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">unpin_fifo</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate unpin FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">unpin_worker</span><span class="p">);</span>

	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">nformats</span> <span class="o">=</span> <span class="n">omap_framebuffer_get_formats</span><span class="p">(</span>
			<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">),</span>
			<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">supported_modes</span><span class="p">);</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">ovl</span><span class="p">;</span>
	<span class="n">plane</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="n">drm_plane_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">possible_crtcs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_plane_funcs</span><span class="p">,</span>
			<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">,</span> <span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">nformats</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* get our starting configuration, set defaults for parameters</span>
<span class="cm">	 * we don&#39;t currently use, etc:</span>
<span class="cm">	 */</span>
	<span class="n">ovl</span><span class="o">-&gt;</span><span class="n">get_overlay_info</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rotation_type</span> <span class="o">=</span> <span class="n">OMAP_DSS_ROT_DMA</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">OMAP_DSS_ROT_0</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set defaults depending on whether we are a CRTC or overlay</span>
<span class="cm">	 * layer.</span>
<span class="cm">	 * TODO add ioctl to give userspace an API to change this.. this</span>
<span class="cm">	 * will come in a subsequent patch.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">zorder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">omap_plane</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">zorder</span> <span class="o">=</span> <span class="n">ovl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">update_manager</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">plane</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_plane_destroy</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
