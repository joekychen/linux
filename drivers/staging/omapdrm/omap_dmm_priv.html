<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › omapdrm › omap_dmm_priv.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omap_dmm_priv.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> * Author: Rob Clark &lt;rob@ti.com&gt;</span>
<span class="cm"> *         Andy Gross &lt;andy.gross@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed &quot;as is&quot; WITHOUT ANY WARRANTY of any</span>
<span class="cm"> * kind, whether express or implied; without even the implied warranty</span>
<span class="cm"> * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef OMAP_DMM_PRIV_H</span>
<span class="cp">#define OMAP_DMM_PRIV_H</span>

<span class="cp">#define DMM_REVISION          0x000</span>
<span class="cp">#define DMM_HWINFO            0x004</span>
<span class="cp">#define DMM_LISA_HWINFO       0x008</span>
<span class="cp">#define DMM_DMM_SYSCONFIG     0x010</span>
<span class="cp">#define DMM_LISA_LOCK         0x01C</span>
<span class="cp">#define DMM_LISA_MAP__0       0x040</span>
<span class="cp">#define DMM_LISA_MAP__1       0x044</span>
<span class="cp">#define DMM_TILER_HWINFO      0x208</span>
<span class="cp">#define DMM_TILER_OR__0       0x220</span>
<span class="cp">#define DMM_TILER_OR__1       0x224</span>
<span class="cp">#define DMM_PAT_HWINFO        0x408</span>
<span class="cp">#define DMM_PAT_GEOMETRY      0x40C</span>
<span class="cp">#define DMM_PAT_CONFIG        0x410</span>
<span class="cp">#define DMM_PAT_VIEW__0       0x420</span>
<span class="cp">#define DMM_PAT_VIEW__1       0x424</span>
<span class="cp">#define DMM_PAT_VIEW_MAP__0   0x440</span>
<span class="cp">#define DMM_PAT_VIEW_MAP_BASE 0x460</span>
<span class="cp">#define DMM_PAT_IRQ_EOI       0x478</span>
<span class="cp">#define DMM_PAT_IRQSTATUS_RAW 0x480</span>
<span class="cp">#define DMM_PAT_IRQSTATUS     0x490</span>
<span class="cp">#define DMM_PAT_IRQENABLE_SET 0x4A0</span>
<span class="cp">#define DMM_PAT_IRQENABLE_CLR 0x4B0</span>
<span class="cp">#define DMM_PAT_STATUS__0     0x4C0</span>
<span class="cp">#define DMM_PAT_STATUS__1     0x4C4</span>
<span class="cp">#define DMM_PAT_STATUS__2     0x4C8</span>
<span class="cp">#define DMM_PAT_STATUS__3     0x4CC</span>
<span class="cp">#define DMM_PAT_DESCR__0      0x500</span>
<span class="cp">#define DMM_PAT_DESCR__1      0x510</span>
<span class="cp">#define DMM_PAT_DESCR__2      0x520</span>
<span class="cp">#define DMM_PAT_DESCR__3      0x530</span>
<span class="cp">#define DMM_PEG_HWINFO        0x608</span>
<span class="cp">#define DMM_PEG_PRIO          0x620</span>
<span class="cp">#define DMM_PEG_PRIO_PAT      0x640</span>

<span class="cp">#define DMM_IRQSTAT_DST			(1&lt;&lt;0)</span>
<span class="cp">#define DMM_IRQSTAT_LST			(1&lt;&lt;1)</span>
<span class="cp">#define DMM_IRQSTAT_ERR_INV_DSC		(1&lt;&lt;2)</span>
<span class="cp">#define DMM_IRQSTAT_ERR_INV_DATA	(1&lt;&lt;3)</span>
<span class="cp">#define DMM_IRQSTAT_ERR_UPD_AREA	(1&lt;&lt;4)</span>
<span class="cp">#define DMM_IRQSTAT_ERR_UPD_CTRL	(1&lt;&lt;5)</span>
<span class="cp">#define DMM_IRQSTAT_ERR_UPD_DATA	(1&lt;&lt;6)</span>
<span class="cp">#define DMM_IRQSTAT_ERR_LUT_MISS	(1&lt;&lt;7)</span>

<span class="cp">#define DMM_IRQSTAT_ERR_MASK	(DMM_IRQ_STAT_ERR_INV_DSC | \</span>
<span class="cp">				DMM_IRQ_STAT_ERR_INV_DATA | \</span>
<span class="cp">				DMM_IRQ_STAT_ERR_UPD_AREA | \</span>
<span class="cp">				DMM_IRQ_STAT_ERR_UPD_CTRL | \</span>
<span class="cp">				DMM_IRQ_STAT_ERR_UPD_DATA | \</span>
<span class="cp">				DMM_IRQ_STAT_ERR_LUT_MISS)</span>

<span class="cp">#define DMM_PATSTATUS_READY		(1&lt;&lt;0)</span>
<span class="cp">#define DMM_PATSTATUS_VALID		(1&lt;&lt;1)</span>
<span class="cp">#define DMM_PATSTATUS_RUN		(1&lt;&lt;2)</span>
<span class="cp">#define DMM_PATSTATUS_DONE		(1&lt;&lt;3)</span>
<span class="cp">#define DMM_PATSTATUS_LINKED		(1&lt;&lt;4)</span>
<span class="cp">#define DMM_PATSTATUS_BYPASSED		(1&lt;&lt;7)</span>
<span class="cp">#define DMM_PATSTATUS_ERR_INV_DESCR	(1&lt;&lt;10)</span>
<span class="cp">#define DMM_PATSTATUS_ERR_INV_DATA	(1&lt;&lt;11)</span>
<span class="cp">#define DMM_PATSTATUS_ERR_UPD_AREA	(1&lt;&lt;12)</span>
<span class="cp">#define DMM_PATSTATUS_ERR_UPD_CTRL	(1&lt;&lt;13)</span>
<span class="cp">#define DMM_PATSTATUS_ERR_UPD_DATA	(1&lt;&lt;14)</span>
<span class="cp">#define DMM_PATSTATUS_ERR_ACCESS	(1&lt;&lt;15)</span>

<span class="cm">/* note: don&#39;t treat DMM_PATSTATUS_ERR_ACCESS as an error */</span>
<span class="cp">#define DMM_PATSTATUS_ERR	(DMM_PATSTATUS_ERR_INV_DESCR | \</span>
<span class="cp">				DMM_PATSTATUS_ERR_INV_DATA | \</span>
<span class="cp">				DMM_PATSTATUS_ERR_UPD_AREA | \</span>
<span class="cp">				DMM_PATSTATUS_ERR_UPD_CTRL | \</span>
<span class="cp">				DMM_PATSTATUS_ERR_UPD_DATA)</span>



<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PAT_STATUS</span><span class="p">,</span>
	<span class="n">PAT_DESCR</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pat_ctrl</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">start</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dir</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lut_id</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sync</span><span class="o">:</span><span class="mi">12</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ini</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pat</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">next_pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pat_area</span> <span class="n">area</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pat_ctrl</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">data_pa</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DMM_FIXED_RETRY_COUNT 1000</span>

<span class="cm">/* create refill buffer big enough to refill all slots, plus 3 descriptors..</span>
<span class="cm"> * 3 descriptors is probably the worst-case for # of 2d-slices in a 1d area,</span>
<span class="cm"> * but I guess you don&#39;t hit that worst case at the same time as full area</span>
<span class="cm"> * refill</span>
<span class="cm"> */</span>
<span class="cp">#define DESCR_SIZE 128</span>
<span class="cp">#define REFILL_BUFFER_SIZE ((4 * 128 * 256) + (3 * DESCR_SIZE))</span>

<span class="k">struct</span> <span class="n">dmm</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dmm_txn</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">engine_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm</span> <span class="o">*</span><span class="n">tcm</span><span class="p">;</span>

	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">current_va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">current_pa</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pat</span> <span class="o">*</span><span class="n">last_pat</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">refill_engine</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dmm</span> <span class="o">*</span><span class="n">dmm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcm</span> <span class="o">*</span><span class="n">tcm</span><span class="p">;</span>

	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">refill_va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">refill_pa</span><span class="p">;</span>

	<span class="cm">/* only one trans per engine for now */</span>
	<span class="k">struct</span> <span class="n">dmm_txn</span> <span class="n">txn</span><span class="p">;</span>

	<span class="cm">/* offset to lut associated with container */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">lut_offset</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span> <span class="n">wait_for_refill</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">idle_node</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dmm</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">dummy_page</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dummy_pa</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">refill_va</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">refill_pa</span><span class="p">;</span>

	<span class="cm">/* refill engines */</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">engine_sem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">idle_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">refill_engine</span> <span class="o">*</span><span class="n">engines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_engines</span><span class="p">;</span>

	<span class="cm">/* container information */</span>
	<span class="kt">int</span> <span class="n">container_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">container_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lut_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lut_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_lut</span><span class="p">;</span>

	<span class="cm">/* array of LUT - TCM containers */</span>
	<span class="k">struct</span> <span class="n">tcm</span> <span class="o">**</span><span class="n">tcm</span><span class="p">;</span>

	<span class="cm">/* LUT table storage */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">lut</span><span class="p">;</span>

	<span class="cm">/* allocation list and lock */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">alloc_head</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">list_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
