<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › ccg › ccg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ccg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Configurable Composite Gadget</span>
<span class="cm"> *</span>
<span class="cm"> * Initially contributed as &quot;Android Composite Gdaget&quot; by:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Google, Inc.</span>
<span class="cm"> * Author: Mike Lockwood &lt;lockwood@android.com&gt;</span>
<span class="cm"> *         Benoit Goby &lt;benoit@android.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Tailoring it to become a generic Configurable Composite Gadget is</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2012 Samsung Electronics</span>
<span class="cm"> * Author: Andrzej Pietrasiewicz &lt;andrzej.p@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/composite.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>

<span class="cp">#include &quot;gadget_chips.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Kbuild is not very cooperative with respect to linking separately</span>
<span class="cm"> * compiled library objects into one module.  So for now we won&#39;t use</span>
<span class="cm"> * separate compilation ... ensuring init/exit sections work to shrink</span>
<span class="cm"> * the runtime footprint, and giving us at least some parts of what</span>
<span class="cm"> * a &quot;gcc --combine ... part1.c part2.c part3.c ... &quot; build would.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;../../usb/gadget/usbstring.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/config.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/epautoconf.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/composite.c&quot;</span>

<span class="cp">#include &quot;../../usb/gadget/f_mass_storage.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/u_serial.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/f_acm.c&quot;</span>
<span class="cp">#define USB_ETH_RNDIS y</span>
<span class="cp">#include &quot;../../usb/gadget/f_rndis.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/rndis.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/u_ether.c&quot;</span>
<span class="cp">#include &quot;../../usb/gadget/f_fs.c&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mike Lockwood, Andrzej Pietrasiewicz&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Configurable Composite USB Gadget&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.0&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">longname</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Configurable Composite Gadget&quot;</span><span class="p">;</span>

<span class="cm">/* Default vendor and product IDs, overridden by userspace */</span>
<span class="cp">#define VENDOR_ID		0x1d6b </span><span class="cm">/* Linux Foundation */</span><span class="cp"></span>
<span class="cp">#define PRODUCT_ID		0x0107</span>
<span class="cp">#define GFS_MAX_DEVS		10</span>

<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">**</span><span class="n">attributes</span><span class="p">;</span>

	<span class="cm">/* for ccg_dev.enabled_functions */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">enabled_list</span><span class="p">;</span>

	<span class="cm">/* Optional: initialization during gadget bind */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="cm">/* Optional: cleanup during gadget unbind */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cleanup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="p">);</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bind_config</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="p">);</span>

	<span class="cm">/* Optional: called when the configuration is removed */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unbind_config</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="p">);</span>
	<span class="cm">/* Optional: handle ctrl requests before the device is configured */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrlrequest</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ffs_obj</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mounted</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">desc_ready</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffs_data</span> <span class="o">*</span><span class="n">ffs_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">**</span><span class="n">functions</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">enabled_functions</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">connected</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sw_connected</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_func_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ffs_obj</span> <span class="n">ffs_tab</span><span class="p">[</span><span class="n">GFS_MAX_DEVS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">ccg_class</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">_ccg_dev</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ccg_bind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ccg_unbind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">func_names_buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_descriptor</span> <span class="n">device_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span>              <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">device_desc</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDescriptorType</span>      <span class="o">=</span> <span class="n">USB_DT_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bcdUSB</span>               <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0x0200</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bDeviceClass</span>         <span class="o">=</span> <span class="n">USB_CLASS_PER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>             <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">VENDOR_ID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">idProduct</span>            <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">PRODUCT_ID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bcdDevice</span>            <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bNumConfigurations</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="n">ccg_config_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">label</span>		<span class="o">=</span> <span class="s">&quot;ccg&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span>		<span class="o">=</span> <span class="n">ccg_unbind_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bConfigurationValue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span>	<span class="o">=</span> <span class="n">USB_CONFIG_ATT_ONE</span> <span class="o">|</span> <span class="n">USB_CONFIG_ATT_SELFPOWER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bMaxPower</span>	<span class="o">=</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="cm">/* 500ma */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccg_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ccg_dev</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">disconnected</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;USB_STATE=DISCONNECTED&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">connected</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;USB_STATE=CONNECTED&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">configured</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;USB_STATE=CONFIGURED&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">uevent_envp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
		<span class="n">uevent_envp</span> <span class="o">=</span> <span class="n">configured</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sw_connected</span><span class="p">)</span>
		<span class="n">uevent_envp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">?</span> <span class="n">connected</span> <span class="o">:</span> <span class="n">disconnected</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sw_connected</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uevent_envp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobject_uevent_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">uevent_envp</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: sent uevent %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">uevent_envp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: did not send uevent (%d %d %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sw_connected</span><span class="p">,</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* Supported functions initialization */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ffs_obj</span> <span class="o">*</span><span class="nf">functionfs_find_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">functionfs_all_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">used</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_ready</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">functionfs_ready_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffs_data</span> <span class="o">*</span><span class="n">ffs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffs_obj</span> <span class="o">*</span><span class="n">ffs_obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ffs_obj</span> <span class="o">=</span> <span class="n">ffs</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ffs_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">ffs_obj</span><span class="o">-&gt;</span><span class="n">desc_ready</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ffs_obj</span><span class="o">-&gt;</span><span class="n">ffs_data</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">functionfs_all_ready</span><span class="p">(</span><span class="n">_ccg_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ffs_obj</span><span class="o">-&gt;</span><span class="n">desc_ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Cancel pending control requests */</span>
	<span class="n">usb_ep_dequeue</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
	<span class="n">usb_remove_config</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccg_config_driver</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">usb_gadget_disconnect</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">functionfs_closed_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffs_data</span> <span class="o">*</span><span class="n">ffs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffs_obj</span> <span class="o">*</span><span class="n">ffs_obj</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ffs_obj</span> <span class="o">=</span> <span class="n">ffs</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ffs_obj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ffs_obj</span><span class="o">-&gt;</span><span class="n">desc_ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">reset_usb</span><span class="p">(</span><span class="n">_ccg_dev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">functionfs_acquire_dev_callback</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffs_obj</span> <span class="o">*</span><span class="n">ffs_dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ffs_dev</span> <span class="o">=</span> <span class="n">functionfs_find_dev</span><span class="p">(</span><span class="n">_ccg_dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ffs_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ffs_dev</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ffs_dev</span><span class="o">-&gt;</span><span class="n">mounted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ffs_dev</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ffs_dev</span><span class="o">-&gt;</span><span class="n">mounted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ffs_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">functionfs_release_dev_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ffs_data</span> <span class="o">*</span><span class="n">ffs_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ffs_obj</span> <span class="o">*</span><span class="n">ffs_dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ffs_dev</span> <span class="o">=</span> <span class="n">ffs_data</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ffs_dev</span><span class="p">)</span>
		<span class="n">ffs_dev</span><span class="o">-&gt;</span><span class="n">mounted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_ccg_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">functionfs_function_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">functionfs_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">functionfs_function_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">functionfs_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">functionfs_function_bind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">used</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">functionfs_bind</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ffs_data</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">)</span>
				<span class="n">functionfs_unbind</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ffs_data</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">used</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">functionfs_bind_config</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
					     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ffs_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">functionfs_function_unbind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ffs_data</span><span class="p">)</span>
			<span class="n">functionfs_unbind</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ffs_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">functionfs_user_functions_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buff</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">buf</span> <span class="o">-</span> <span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s,&quot;</span><span class="p">,</span>
				 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buff</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buff</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">functionfs_user_functions_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mounted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">func_names_buf</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">func_names_buf</span><span class="p">));</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">strim</span><span class="p">(</span><span class="n">func_names_buf</span><span class="p">);</span>

	<span class="cm">/* replace the list of functions */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span> <span class="o">==</span> <span class="n">GFS_MAX_DEVS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">functionfs_find_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="o">++</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">user_functions</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">functionfs_user_functions_show</span><span class="p">,</span>
		   <span class="n">functionfs_user_functions_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">functionfs_max_user_functions_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">GFS_MAX_DEVS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_user_functions</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">functionfs_max_user_functions_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">functionfs_function_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_user_functions</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_max_user_functions</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="n">functionfs_function</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;fs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">functionfs_function_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>	<span class="o">=</span> <span class="n">functionfs_function_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_config</span>	<span class="o">=</span> <span class="n">functionfs_function_bind_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind_config</span>  <span class="o">=</span> <span class="n">functionfs_function_unbind_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attributes</span>	<span class="o">=</span> <span class="n">functionfs_function_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define MAX_ACM_INSTANCES 4</span>
<span class="k">struct</span> <span class="n">acm_function_config</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">instances</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acm_function_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acm_function_config</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gserial_setup</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">MAX_ACM_INSTANCES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acm_function_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gserial_cleanup</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">acm_function_bind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acm_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">acm_bind_config</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not bind acm%u config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">acm_instances_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acm_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">acm_instances_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">acm_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_ACM_INSTANCES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">instances</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">acm_instances_show</span><span class="p">,</span>
						 <span class="n">acm_instances_store</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">acm_function_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_instances</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="n">acm_function</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;acm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">acm_function_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>	<span class="o">=</span> <span class="n">acm_function_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_config</span>	<span class="o">=</span> <span class="n">acm_function_bind_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attributes</span>	<span class="o">=</span> <span class="n">acm_function_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="p">{</span>
	<span class="n">u8</span>      <span class="n">ethaddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u32</span>     <span class="n">vendorID</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">manufacturer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="cm">/* &quot;Wireless&quot; RNDIS; auto-detected by Windows */</span>
	<span class="n">bool</span>	<span class="n">wceis</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_function_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_function_config</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_function_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_function_bind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">rndis</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rndis</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: rndis_pdata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s MAC: %02X:%02X:%02X:%02X:%02X:%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		<span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gether_setup_name</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">,</span> <span class="s">&quot;rndis&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: gether_setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rndis</span><span class="o">-&gt;</span><span class="n">wceis</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &quot;Wireless&quot; RNDIS; auto-detected by Windows */</span>
		<span class="n">rndis_iad_descriptor</span><span class="p">.</span><span class="n">bFunctionClass</span> <span class="o">=</span>
						<span class="n">USB_CLASS_WIRELESS_CONTROLLER</span><span class="p">;</span>
		<span class="n">rndis_iad_descriptor</span><span class="p">.</span><span class="n">bFunctionSubClass</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">rndis_iad_descriptor</span><span class="p">.</span><span class="n">bFunctionProtocol</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">rndis_control_intf</span><span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span>
						<span class="n">USB_CLASS_WIRELESS_CONTROLLER</span><span class="p">;</span>
		<span class="n">rndis_control_intf</span><span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span>	 <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">rndis_control_intf</span><span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span>	 <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rndis_bind_config_vendor</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">,</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">vendorID</span><span class="p">,</span>
					   <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_function_unbind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gether_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_manufacturer_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_manufacturer_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">rndis_manufacturer_show</span><span class="p">,</span>
						    <span class="n">rndis_manufacturer_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_wceis_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">wceis</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_wceis_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">wceis</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wceis</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">rndis_wceis_show</span><span class="p">,</span>
					     <span class="n">rndis_wceis_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_ethaddr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">rndis</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%02x:%02x:%02x:%02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		<span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_ethaddr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">rndis</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hhx:%hhx:%hhx:%hhx:%hhx:%hhx&quot;</span><span class="p">,</span>
		   <span class="n">tmp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">ETH_ALEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rndis</span><span class="o">-&gt;</span><span class="n">ethaddr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ETH_ALEN</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ethaddr</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">rndis_ethaddr_show</span><span class="p">,</span>
					       <span class="n">rndis_ethaddr_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_vendorID_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vendorID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">rndis_vendorID_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_function_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtou32</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">vendorID</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vendorID</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">rndis_vendorID_show</span><span class="p">,</span>
						<span class="n">rndis_vendorID_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">rndis_function_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_manufacturer</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wceis</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ethaddr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vendorID</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="n">rndis_function</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rndis&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">rndis_function_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>	<span class="o">=</span> <span class="n">rndis_function_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_config</span>	<span class="o">=</span> <span class="n">rndis_function_bind_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind_config</span>	<span class="o">=</span> <span class="n">rndis_function_unbind_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attributes</span>	<span class="o">=</span> <span class="n">rndis_function_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mass_storage_function_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsg_config</span> <span class="n">fsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsg_common</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">fsg</span><span class="p">);</span>
	<span class="n">fsg</span><span class="p">.</span><span class="n">nluns</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fsg</span><span class="p">.</span><span class="n">luns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">removable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fsg</span><span class="p">.</span><span class="n">vendor_name</span> <span class="o">=</span> <span class="n">iManufacturer</span><span class="p">;</span>
	<span class="n">fsg</span><span class="p">.</span><span class="n">product_name</span> <span class="o">=</span> <span class="n">iProduct</span><span class="p">;</span>

	<span class="n">common</span> <span class="o">=</span> <span class="n">fsg_common_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">common</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">luns</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="s">&quot;lun&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fsg_common_put</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">common</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mass_storage_function_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fsg_common_put</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mass_storage_function_bind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsg_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fsg_bind_config</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">common</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="n">mass_storage_function</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mass_storage&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">mass_storage_function_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>	<span class="o">=</span> <span class="n">mass_storage_function_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_config</span>	<span class="o">=</span> <span class="n">mass_storage_function_bind_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">supported_functions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">functionfs_function</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">acm_function</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">rndis_function</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mass_storage_function</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_init_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">**</span><span class="n">functions</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">**</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="o">*</span><span class="n">functions</span><span class="o">++</span><span class="p">);</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;f_%s&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Failed to alloc name %s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Failed to create dev %s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
							<span class="n">f</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_create</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Failed to init %s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
								<span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">attrs</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">attr</span> <span class="o">=</span> <span class="o">*</span><span class="n">attrs</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Failed to create function %s attributes&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_uninit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_uninit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">device_destroy</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devt</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_create:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
<span class="nl">err_alloc:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccg_cleanup_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">**</span><span class="n">functions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">functions</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span> <span class="o">=</span> <span class="o">*</span><span class="n">functions</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
			<span class="n">device_destroy</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devt</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_bind_enabled_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled_functions</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">bind_config</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccg_unbind_enabled_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled_functions</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">unbind_config</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">unbind_config</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_enable_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">**</span><span class="n">functions</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">f</span> <span class="o">=</span> <span class="o">*</span><span class="n">functions</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">enabled_list</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled_functions</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* /sys/class/ccg_usb/ccg%d/ interface */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">functions_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled_functions</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">)</span>
		<span class="n">buff</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s,&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">used</span><span class="p">)</span>
			<span class="n">buff</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buff</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">functions_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">functionfs_enabled</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled_functions</span><span class="p">);</span>
	<span class="n">functionfs_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_func_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffs_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">used</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">strim</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ffs_obj</span> <span class="o">*</span><span class="n">user_func</span><span class="p">;</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="cm">/* handle FunctionFS implicitly */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">functionfs_function</span><span class="p">.</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ccg_usb: Cannot explicitly enable &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">user_func</span> <span class="o">=</span> <span class="n">functionfs_find_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_func</span><span class="p">)</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">functionfs_function</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_func</span> <span class="o">||</span> <span class="o">!</span><span class="n">functionfs_enabled</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ccg_enable_function</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ccg_usb: Cannot enable &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">user_func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">user_func</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">func_num</span><span class="o">++</span><span class="p">;</span>
			<span class="n">functionfs_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enabled</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">functionfs_all_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">next_string_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Update values in composite driver&#39;s copy of</span>
<span class="cm">		 * device descriptor.</span>
<span class="cm">		 */</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">=</span> <span class="n">device_desc</span><span class="p">.</span><span class="n">bDeviceClass</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDeviceSubClass</span> <span class="o">=</span> <span class="n">device_desc</span><span class="p">.</span><span class="n">bDeviceSubClass</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bDeviceProtocol</span> <span class="o">=</span> <span class="n">device_desc</span><span class="p">.</span><span class="n">bDeviceProtocol</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">idVendor</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">idProduct</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bcdDevice</span> <span class="o">=</span> <span class="n">bcdDevice</span><span class="p">;</span>

		<span class="n">usb_add_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccg_config_driver</span><span class="p">,</span> <span class="n">ccg_bind_config</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_gadget_connect</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">usb_remove_config</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccg_config_driver</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_usb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ccg_usb: already %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="s">&quot;DISCONNECTED&quot;</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;CONFIGURED&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;CONNECTED&quot;</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DESCRIPTOR_ATTR(field, format_string)				\</span>
<span class="cp">static ssize_t								\</span>
<span class="cp">field ## _show(struct device *dev, struct device_attribute *attr,	\</span>
<span class="cp">		char *buf)						\</span>
<span class="cp">{									\</span>
<span class="cp">	return sprintf(buf, format_string, device_desc.field);		\</span>
<span class="cp">}									\</span>
<span class="cp">static ssize_t								\</span>
<span class="cp">field ## _store(struct device *dev, struct device_attribute *attr,	\</span>
<span class="cp">		const char *buf, size_t size)				\</span>
<span class="cp">{									\</span>
<span class="cp">	int value;							\</span>
<span class="cp">	if (sscanf(buf, format_string, &amp;value) == 1) {			\</span>
<span class="cp">		device_desc.field = value;				\</span>
<span class="cp">		return size;						\</span>
<span class="cp">	}								\</span>
<span class="cp">	return -1;							\</span>
<span class="cp">}									\</span>
<span class="cp">static DEVICE_ATTR(field, S_IRUGO | S_IWUSR, field ## _show, field ## _store);</span>

<span class="n">DESCRIPTOR_ATTR</span><span class="p">(</span><span class="n">bDeviceClass</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">DESCRIPTOR_ATTR</span><span class="p">(</span><span class="n">bDeviceSubClass</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">DESCRIPTOR_ATTR</span><span class="p">(</span><span class="n">bDeviceProtocol</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">functions_show</span><span class="p">,</span>
						 <span class="n">functions_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">enable_show</span><span class="p">,</span> <span class="n">enable_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">state_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">ccg_usb_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bDeviceClass</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bDeviceSubClass</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bDeviceProtocol</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_functions</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_enable</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_state</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* Composite driver */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_bind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccg_bind_enabled_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccg_unbind_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_configuration</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>

	<span class="n">ccg_unbind_enabled_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="n">usb_ep_autoconfig_reset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_gadget</span>	<span class="o">*</span><span class="n">gadget</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">gcnum</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start disconnected. Userspace will connect the gadget once</span>
<span class="cm">	 * it is done configuring the functions.</span>
<span class="cm">	 */</span>
	<span class="n">usb_gadget_disconnect</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccg_init_functions</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">gcnum</span> <span class="o">=</span> <span class="n">usb_gadget_controller_number</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gcnum</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">device_desc</span><span class="p">.</span><span class="n">bcdDevice</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0200</span> <span class="o">+</span> <span class="n">gcnum</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: controller &#39;%s&#39; not recognized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">longname</span><span class="p">,</span> <span class="n">gadget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">device_desc</span><span class="p">.</span><span class="n">bcdDevice</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0x9999</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usb_gadget_set_selfpowered</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_usb_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">ccg_cleanup_functions</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_composite_driver</span> <span class="n">ccg_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;configurable_usb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">device_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span>		<span class="o">=</span> <span class="n">ccg_usb_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">needs_serial</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iManufacturer</span>	<span class="o">=</span> <span class="s">&quot;Linux Foundation&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iProduct</span>	<span class="o">=</span> <span class="n">longname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iSerialNumber</span>	<span class="o">=</span> <span class="s">&quot;1234567890123456&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span>	<span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_request</span>		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccg_usb_function</span>	<span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">composite_setup_complete</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gadget</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">cdev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled_functions</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">ctrlrequest</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">ctrlrequest</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">composite_setup</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">==</span> <span class="n">USB_REQ_SET_CONFIGURATION</span> <span class="o">&amp;&amp;</span>
						<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccg_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">_ccg_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_composite_dev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">get_gadget_data</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">composite_disconnect</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccg_create_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">**</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ccg_usb_attributes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ccg0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">attr</span> <span class="o">=</span> <span class="o">*</span><span class="n">attrs</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device_destroy</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devt</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccg_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ccg_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;ccg_usb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span> <span class="o">=</span> <span class="n">supported_functions</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enabled_functions</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">ccg_work</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ccg_create_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">class_destroy</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_ccg_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Override composite driver functions */</span>
	<span class="n">composite_driver</span><span class="p">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">ccg_setup</span><span class="p">;</span>
	<span class="n">composite_driver</span><span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">ccg_disconnect</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_composite_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccg_usb_driver</span><span class="p">,</span> <span class="n">ccg_bind</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">class_destroy</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_composite_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccg_usb_driver</span><span class="p">);</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">ccg_class</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">_ccg_dev</span><span class="p">);</span>
	<span class="n">_ccg_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
