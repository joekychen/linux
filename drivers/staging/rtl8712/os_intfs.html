<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8712 › os_intfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>os_intfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * os_intfs.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2007 - 2010 Realtek Corporation. All rights reserved.</span>
<span class="cm"> * Linux device driver for RTL8192SU</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * Modifications for inclusion into the Linux staging tree are</span>
<span class="cm"> * Copyright(c) 2010 Larry Finger. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact information:</span>
<span class="cm"> * WLAN FAE &lt;wlanfae@realtek.com&gt;.</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#define _OS_INTFS_C_</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &quot;osdep_service.h&quot;</span>
<span class="cp">#include &quot;drv_types.h&quot;</span>
<span class="cp">#include &quot;xmit_osdep.h&quot;</span>
<span class="cp">#include &quot;recv_osdep.h&quot;</span>
<span class="cp">#include &quot;rtl871x_ioctl.h&quot;</span>
<span class="cp">#include &quot;usb_osintf.h&quot;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;rtl871x wireless lan driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Larry Finger&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">ifname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">;</span>

<span class="cm">/* module param defaults */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">chip_version</span> <span class="o">=</span> <span class="n">RTL8712_2ndCUT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rfintfs</span> <span class="o">=</span> <span class="n">HWPI</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lbkmode</span> <span class="o">=</span> <span class="n">RTL8712_AIR_TRX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hci</span> <span class="o">=</span> <span class="n">RTL8712_USB</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ampdu_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="cm">/*for enable tx_ampdu*/</span>

<span class="cm">/* The video_mode variable is for video mode.*/</span>
<span class="cm">/* It may be specify when inserting module with video_mode=1 parameter.*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* enable video mode*/</span>

<span class="cm">/*Ndis802_11Infrastructure; infra, ad-hoc, auto*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">network_mode</span> <span class="o">=</span> <span class="n">Ndis802_11IBSS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="cm">/*ad-hoc support requirement*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_11BG</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vrtl_carrier_sense</span> <span class="o">=</span> <span class="n">AUTO_VCS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vcs_type</span> <span class="o">=</span> <span class="n">RTS_CTS</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">frag_thresh</span> <span class="o">=</span> <span class="mi">2346</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">PREAMBLE_LONG</span><span class="p">;</span><span class="cm">/*long, short, auto*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scan_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="cm">/*active, passive*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">adhoc_tx_pwr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">soft_ap</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">smart_ps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">power_mgnt</span> <span class="o">=</span> <span class="n">PS_MODE_ACTIVE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">radio_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">long_retry_lmt</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">short_retry_lmt</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">busy_thresh</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ack_policy</span> <span class="o">=</span> <span class="n">NORMAL_ACK</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mp_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">software_encrypt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">software_decrypt</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wmm_enable</span><span class="p">;</span><span class="cm">/* default is set to disable the wmm.*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">uapsd_enable</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">uapsd_max_sp</span> <span class="o">=</span> <span class="n">NO_LIMIT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">uapsd_acbk_en</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">uapsd_acbe_en</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">uapsd_acvi_en</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">uapsd_acvo_en</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ht_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cbw40_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rf_config</span> <span class="o">=</span> <span class="n">RTL8712_RF_1T2R</span><span class="p">;</span>  <span class="cm">/* 1T2R*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">low_power</span><span class="p">;</span>
<span class="cm">/* mac address to use instead of the one stored in Efuse */</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">r8712_initmac</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">initmac</span><span class="p">;</span>
<span class="cm">/* if wifi_test = 1, driver will disable the turbo mode and pass it to</span>
<span class="cm"> * firmware private.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wifi_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">module_param_string</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifname</span><span class="p">),</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wifi_test</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">initmac</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">chip_version</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rfintfs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lbkmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hci</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">network_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mp_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wmm_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vrtl_carrier_sense</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vcs_type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">busy_thresh</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ht_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cbw40_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ampdu_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rf_config</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">power_mgnt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">low_power</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="s">&quot; Net interface name, wlan%d=default&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">initmac</span><span class="p">,</span> <span class="s">&quot;MAC-Address, default: use FUSE&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">uint</span> <span class="n">loadparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="k">struct</span>  <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">);</span>

<span class="k">static</span> <span class="n">uint</span> <span class="nf">loadparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="k">struct</span>  <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">status</span> <span class="o">=</span> <span class="n">_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">registry_priv</span>  <span class="o">*</span><span class="n">registry_par</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">;</span>

	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">chip_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">chip_version</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">rfintfs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rfintfs</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">lbkmode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">lbkmode</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">hci</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">hci</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">network_mode</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">network_mode</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">,</span> <span class="s">&quot;ANY&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">SsidLength</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">wireless_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">wireless_mode</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">vrtl_carrier_sense</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">vrtl_carrier_sense</span> <span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">vcs_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">vcs_type</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">frag_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">frag_thresh</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">preamble</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">scan_mode</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">adhoc_tx_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">adhoc_tx_pwr</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">soft_ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">soft_ap</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">smart_ps</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">smart_ps</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">power_mgnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">power_mgnt</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">radio_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">radio_enable</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">long_retry_lmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">long_retry_lmt</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">short_retry_lmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">short_retry_lmt</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">busy_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">busy_thresh</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">ack_policy</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ack_policy</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">mp_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">mp_mode</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">software_encrypt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">software_encrypt</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">software_decrypt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">software_decrypt</span><span class="p">;</span>
	<span class="cm">/*UAPSD*/</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">wmm_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">wmm_enable</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">uapsd_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">uapsd_enable</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">uapsd_max_sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">uapsd_max_sp</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">uapsd_acbk_en</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">uapsd_acbk_en</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">uapsd_acbe_en</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">uapsd_acbe_en</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">uapsd_acvi_en</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">uapsd_acvi_en</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">uapsd_acvo_en</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">uapsd_acvo_en</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">ht_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ht_enable</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">cbw40_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">cbw40_enable</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">ampdu_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ampdu_enable</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">rf_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rf_config</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">low_power</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">low_power</span><span class="p">;</span>
	<span class="n">registry_par</span><span class="o">-&gt;</span><span class="n">wifi_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">wifi_test</span><span class="p">;</span>
	<span class="n">r8712_initmac</span> <span class="o">=</span> <span class="n">initmac</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_net_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bup</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">r871x_net_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xmit_priv</span> <span class="o">*</span><span class="n">pxmitpriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">recv_priv</span> <span class="o">*</span><span class="n">precvpriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">recvpriv</span><span class="p">);</span>

	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">tx_pkts</span><span class="p">;</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">precvpriv</span><span class="o">-&gt;</span><span class="n">rx_pkts</span><span class="p">;</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">tx_drop</span><span class="p">;</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">precvpriv</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">;</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">precvpriv</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rtl8712_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">netdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">netdev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">r8712_xmit_entry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">r871x_net_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> <span class="o">=</span> <span class="n">r871x_net_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> <span class="o">=</span> <span class="n">r871x_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">r8712_init_netdev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">;</span>

	<span class="n">pnetdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnetdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">);</span>
		<span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pnetdev</span> <span class="o">=</span> <span class="n">pnetdev</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: register rtl8712_netdev_ops to&quot;</span>
	       <span class="s">&quot; netdev_ops</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl8712_netdev_ops</span><span class="p">;</span>
	<span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span> <span class="cm">/* 1 second timeout */</span>
	<span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="o">*</span><span class="p">)</span>
				     <span class="o">&amp;</span><span class="n">r871x_handlers_def</span><span class="p">;</span>
	<span class="cm">/*step 2.*/</span>
	<span class="n">loadparam</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">pnetdev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Initial the PID value used for HW PBC.*/</span>
	<span class="k">return</span> <span class="n">pnetdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">start_drv_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdThread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">r8712_cmd_thread</span><span class="p">,</span> <span class="n">padapter</span><span class="p">,</span>
			      <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdThread</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_stop_drv_threads</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*Below is to terminate r8712_cmd_thread &amp; event_thread...*/</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdpriv</span><span class="p">.</span><span class="n">cmd_queue_sema</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdThread</span><span class="p">)</span>
		<span class="n">_down_sema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdpriv</span><span class="p">.</span><span class="n">terminate_cmdthread_sema</span><span class="p">);</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdpriv</span><span class="p">.</span><span class="n">cmd_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_drv_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_set_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">sitesurveyctrl</span><span class="p">.</span><span class="n">sitesurvey_ctrl_timer</span><span class="p">,</span>
		   <span class="mi">5000</span><span class="p">);</span>
	<span class="n">_set_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">wdg_timer</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_stop_drv_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_cancel_timer_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">assoc_timer</span><span class="p">);</span>
	<span class="n">_cancel_timer_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">tkip_timer</span><span class="p">);</span>
	<span class="n">_cancel_timer_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">scan_to_timer</span><span class="p">);</span>
	<span class="n">_cancel_timer_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">dhcp_timer</span><span class="p">);</span>
	<span class="n">_cancel_timer_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">wdg_timer</span><span class="p">);</span>
	<span class="n">_cancel_timer_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">sitesurveyctrl</span><span class="p">.</span>
			 <span class="n">sitesurvey_ctrl_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">init_default_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ret</span>  <span class="o">=</span> <span class="n">_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">registry_priv</span> <span class="o">*</span><span class="n">pregistrypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xmit_priv</span> <span class="o">*</span><span class="n">pxmitpriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">security_priv</span> <span class="o">*</span><span class="n">psecuritypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">;</span>

	<span class="cm">/*xmit_priv*/</span>
	<span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">vcs_setting</span> <span class="o">=</span> <span class="n">pregistrypriv</span><span class="o">-&gt;</span><span class="n">vrtl_carrier_sense</span><span class="p">;</span>
	<span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">pregistrypriv</span><span class="o">-&gt;</span><span class="n">vcs_type</span><span class="p">;</span>
	<span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">vcs_type</span> <span class="o">=</span> <span class="n">pregistrypriv</span><span class="o">-&gt;</span><span class="n">vcs_type</span><span class="p">;</span>
	<span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">rts_thresh</span> <span class="o">=</span> <span class="n">pregistrypriv</span><span class="o">-&gt;</span><span class="n">rts_thresh</span><span class="p">;</span>
	<span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">=</span> <span class="n">pregistrypriv</span><span class="o">-&gt;</span><span class="n">frag_thresh</span><span class="p">;</span>
	<span class="cm">/* mlme_priv */</span>
	<span class="cm">/* Maybe someday we should rename this variable to &quot;active_mode&quot;(Jeff)*/</span>
	<span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">passive_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 1: active, 0: passive. */</span>
	<span class="cm">/*ht_priv*/</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ht_priv</span>	 <span class="o">*</span><span class="n">phtpriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">htpriv</span><span class="p">;</span>

		<span class="n">phtpriv</span><span class="o">-&gt;</span><span class="n">ampdu_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="cm">/*set to disabled*/</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">phtpriv</span><span class="o">-&gt;</span><span class="n">baddbareq_issued</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*security_priv*/</span>
	<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">sw_encrypt</span> <span class="o">=</span> <span class="n">pregistrypriv</span><span class="o">-&gt;</span><span class="n">software_encrypt</span><span class="p">;</span>
	<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">sw_decrypt</span> <span class="o">=</span> <span class="n">pregistrypriv</span><span class="o">-&gt;</span><span class="n">software_decrypt</span><span class="p">;</span>
	<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">binstallGrpkey</span> <span class="o">=</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="cm">/*pwrctrl_priv*/</span>
	<span class="cm">/*registry_priv*/</span>
	<span class="n">r8712_init_registrypriv_dev_network</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="n">r8712_update_registrypriv_dev_network</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="cm">/*misc.*/</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">r8712_init_drv_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r8712_init_cmd_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdpriv</span><span class="p">))</span> <span class="o">==</span> <span class="n">_FAIL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdpriv</span><span class="p">.</span><span class="n">padapter</span> <span class="o">=</span> <span class="n">padapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r8712_init_evt_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">evtpriv</span><span class="p">))</span> <span class="o">==</span> <span class="n">_FAIL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8712_init_mlme_priv</span><span class="p">(</span><span class="n">padapter</span><span class="p">)</span> <span class="o">==</span> <span class="n">_FAIL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="n">_r8712_init_xmit_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">,</span> <span class="n">padapter</span><span class="p">);</span>
	<span class="n">_r8712_init_recv_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">recvpriv</span><span class="p">,</span> <span class="n">padapter</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">security_priv</span><span class="p">));</span>
	<span class="n">_init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">tkip_timer</span><span class="p">),</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pnetdev</span><span class="p">,</span>
		    <span class="n">r8712_use_tkipkey_handler</span><span class="p">,</span> <span class="n">padapter</span><span class="p">);</span>
	<span class="n">_r8712_init_sta_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">);</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">.</span><span class="n">padapter</span> <span class="o">=</span> <span class="n">padapter</span><span class="p">;</span>
	<span class="n">r8712_init_bcmc_stainfo</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="n">r8712_init_pwrctrl_priv</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="n">mp871xinit</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_default_value</span><span class="p">(</span><span class="n">padapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="n">r8712_InitSwLeds</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">r8712_free_drv_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pnetdev</span><span class="p">;</span>

	<span class="n">r8712_free_cmd_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">cmdpriv</span><span class="p">);</span>
	<span class="n">r8712_free_evt_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">evtpriv</span><span class="p">);</span>
	<span class="n">r8712_DeInitSwLeds</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="n">r8712_free_mlme_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">);</span>
	<span class="n">r8712_free_io_queue</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="n">_free_xmit_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">fw_found</span><span class="p">)</span>
		<span class="n">_r8712_free_sta_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">);</span>
	<span class="n">_r8712_free_recv_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">recvpriv</span><span class="p">);</span>
	<span class="n">mp871xdeinit</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnetdev</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_video_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cbw40_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*   bit 8:</span>
<span class="cm">	 *   1 -&gt; enable video mode to 96B AP</span>
<span class="cm">	 *   0 -&gt; disable video mode to 96B AP</span>
<span class="cm">	 *   bit 9:</span>
<span class="cm">	 *   1 -&gt; enable 40MHz mode</span>
<span class="cm">	 *   0 -&gt; disable 40MHz mode</span>
<span class="cm">	 *   bit 10:</span>
<span class="cm">	 *   1 -&gt; enable STBC</span>
<span class="cm">	 *   0 -&gt; disable STBC</span>
<span class="cm">	 */</span>
	<span class="n">u32</span>  <span class="n">intcmd</span> <span class="o">=</span> <span class="mh">0xf4000500</span><span class="p">;</span>   <span class="cm">/* enable bit8, bit10*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cbw40_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the driver supports the 40M bandwidth,</span>
<span class="cm">		 * we can enable the bit 9.*/</span>
		<span class="n">intcmd</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r8712_fw_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">intcmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * This function intends to handle the activation of an interface</span>
<span class="cm"> * i.e. when it is brought Up/Active from a Down state.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mutex_start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bup</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bSurpriseRemoved</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtl871x_hal_init</span><span class="p">(</span><span class="n">padapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_SUCCESS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">netdev_open_error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8712_initmac</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="cm">/* Use the mac address stored in the Efuse */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
				<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">eeprompriv</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* We have to inform f/w to use user-supplied MAC</span>
<span class="cm">			 * address.</span>
<span class="cm">			 */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="n">r8712_setMacAddr_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The &quot;myid&quot; function will get the wifi mac address</span>
<span class="cm">			 * from eeprompriv structure instead of netdev</span>
<span class="cm">			 * structure. So, we have to overwrite the mac_addr</span>
<span class="cm">			 * stored in the eeprompriv structure. In this case,</span>
<span class="cm">			 * the real mac address won&#39;t be used anymore. So that,</span>
<span class="cm">			 * the eeprompriv.mac_addr should store the mac which</span>
<span class="cm">			 * users specify.</span>
<span class="cm">			 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">eeprompriv</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span>
				<span class="n">pnetdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_drv_threads</span><span class="p">(</span><span class="n">padapter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_SUCCESS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">netdev_open_error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">dvobjpriv</span><span class="p">.</span><span class="n">inirp_init</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">netdev_open_error</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">dvobjpriv</span><span class="p">.</span><span class="n">inirp_init</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
		<span class="n">r8712_set_ps_mode</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">.</span><span class="n">power_mgnt</span><span class="p">,</span>
				  <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">.</span><span class="n">smart_ps</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">))</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>

	 <span class="k">if</span> <span class="p">(</span><span class="n">video_mode</span><span class="p">)</span>
		<span class="n">enable_video_mode</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">cbw40_enable</span><span class="p">);</span>
	<span class="cm">/* start driver mlme relation timer */</span>
	<span class="n">start_drv_timers</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">ledpriv</span><span class="p">.</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">LED_CTL_NO_LINK</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mutex_start</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">netdev_open_error:</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mutex_start</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * This function intends to handle the shutdown of an interface</span>
<span class="cm"> * i.e. when it is brought Down from an Up/Active state.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">pnetdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>

	<span class="cm">/* Close LED*/</span>
	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">ledpriv</span><span class="p">.</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">LED_CTL_POWER_OFF</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/*s1.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnetdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">))</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">pnetdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*s2.*/</span>
	<span class="cm">/*s2-1.  issue disassoc_cmd to fw*/</span>
	<span class="n">r8712_disassoc_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="cm">/*s2-2.  indicate disconnect to os*/</span>
	<span class="n">r8712_ind_disconnect</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="cm">/*s2-3.*/</span>
	<span class="n">r8712_free_assoc_resources</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="cm">/*s2-4.*/</span>
	<span class="n">r8712_free_network_queue</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#include &quot;mlme_osdep.h&quot;</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
