<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8712 › rtl871x_security.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rtl871x_security.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * rtl871x_security.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2007 - 2010 Realtek Corporation. All rights reserved.</span>
<span class="cm"> * Linux device driver for RTL8192SU</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * Modifications for inclusion into the Linux staging tree are</span>
<span class="cm"> * Copyright(c) 2010 Larry Finger. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact information:</span>
<span class="cm"> * WLAN FAE &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#define  _RTL871X_SECURITY_C_</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>

<span class="cp">#include &quot;osdep_service.h&quot;</span>
<span class="cp">#include &quot;drv_types.h&quot;</span>
<span class="cp">#include &quot;wifi.h&quot;</span>
<span class="cp">#include &quot;osdep_intf.h&quot;</span>

<span class="cm">/* =====WEP related===== */</span>

<span class="cp">#define CRC32_POLY 0x04c11db7</span>

<span class="k">struct</span> <span class="n">arc4context</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcfour_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">arc4context</span> <span class="o">*</span><span class="n">parc4ctx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">key_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">keyindex</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">stateindex</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">counter</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span>
		<span class="n">state</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">counter</span><span class="p">;</span>
	<span class="n">keyindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stateindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">counter</span><span class="p">];</span>
		<span class="n">stateindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">stateindex</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">keyindex</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">u</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">stateindex</span><span class="p">];</span>
		<span class="n">state</span><span class="p">[</span><span class="n">stateindex</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">t</span><span class="p">;</span>
		<span class="n">state</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">keyindex</span> <span class="o">&gt;=</span> <span class="n">key_len</span><span class="p">)</span>
			<span class="n">keyindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">arcfour_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">arc4context</span> <span class="o">*</span><span class="n">parc4ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sx</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
	<span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sy</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">y</span><span class="p">];</span>
	<span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">parc4ctx</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">state</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">sx</span><span class="p">;</span>
	<span class="n">state</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">sy</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">[(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">sy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcfour_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">arc4context</span>	<span class="o">*</span><span class="n">parc4ctx</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">arcfour_byte</span><span class="p">(</span><span class="n">parc4ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sint</span> <span class="n">bcrc32initialized</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">crc32_table</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">crc32_reverseBit</span><span class="p">(</span><span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crc32_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcrc32initialized</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sint</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">p1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">k</span><span class="p">;</span>

		<span class="n">c</span> <span class="o">=</span> <span class="mh">0x12340000</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">crc32_reverseBit</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">k</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">j</span><span class="p">)</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span> <span class="o">?</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">CRC32_POLY</span> <span class="o">:</span>
				    <span class="p">(</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">crc32_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc32_reverseBit</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc32_reverseBit</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">p1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc32_reverseBit</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">p1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc32_reverseBit</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">bcrc32initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">getcrc32</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">crc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcrc32initialized</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">crc32_init</span><span class="p">();</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="cm">/* preload shift register, per CRC-32 spec */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">,</span> <span class="o">--</span><span class="n">len</span><span class="p">)</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_table</span><span class="p">[(</span><span class="n">crc</span> <span class="o">^</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">~</span><span class="n">crc</span><span class="p">;</span>    <span class="cm">/* transmit complement, per CRC-32 spec */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	Need to consider the fragment  situation</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">r8712_wep_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pxmitframe</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* exclude ICV */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">crc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">arc4context</span>  <span class="n">mycontext</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">curfragnum</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">keylength</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">iv</span><span class="p">;</span>    <span class="cm">/*,*wepkey*/</span>
	<span class="n">u8</span> <span class="n">wepkey</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span>	<span class="n">pkt_attrib</span>  <span class="o">*</span><span class="n">pattrib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span>
				       <span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">security_priv</span> <span class="o">*</span><span class="n">psecuritypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">xmit_priv</span> <span class="o">*</span><span class="n">pxmitpriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pframe</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="o">+</span><span class="n">TXDESC_OFFSET</span><span class="p">;</span>
	<span class="cm">/*start to encrypt each fragment*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span> <span class="n">_WEP40_</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span> <span class="n">_WEP104_</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">keylength</span> <span class="o">=</span> <span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">DefKeylen</span><span class="p">[</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span>
			    <span class="n">PrivacyKeyIndex</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">curfragnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">curfragnum</span> <span class="o">&lt;</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
		     <span class="n">curfragnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iv</span> <span class="o">=</span> <span class="n">pframe</span><span class="o">+</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wepkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iv</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wepkey</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">DefKey</span><span class="p">[</span>
				<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PrivacyKeyIndex</span><span class="p">].</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">keylength</span><span class="p">);</span>
			<span class="n">payload</span> <span class="o">=</span> <span class="n">pframe</span><span class="o">+</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span><span class="o">+</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">curfragnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">length</span> <span class="o">=</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">last_txcmdsz</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span>
					 <span class="n">hdrlen</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span> <span class="o">-</span>
					 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>
				<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">crc</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">getcrc32</span><span class="p">(</span>
						<span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
				<span class="n">arcfour_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">wepkey</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">keylength</span><span class="p">);</span>
				<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
						<span class="n">length</span><span class="p">);</span>
				<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">length</span><span class="p">,</span>
						<span class="n">crc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">length</span> <span class="o">=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span> <span class="o">-</span>
					 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>
				<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">crc</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">getcrc32</span><span class="p">(</span>
						<span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
				<span class="n">arcfour_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">wepkey</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">keylength</span><span class="p">);</span>
				<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
						<span class="n">length</span><span class="p">);</span>
				<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span><span class="o">+</span><span class="n">length</span><span class="p">,</span>
						<span class="n">crc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">pframe</span> <span class="o">+=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">;</span>
				<span class="n">pframe</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">RND4</span><span class="p">((</span><span class="n">addr_t</span><span class="p">)(</span><span class="n">pframe</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_wep_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span>  <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">precvframe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* exclude ICV */</span>
	<span class="n">u8</span> <span class="n">crc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">arc4context</span>  <span class="n">mycontext</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">keylength</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span> <span class="n">wepkey</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">keyindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_pkt_attrib</span>  <span class="o">*</span><span class="n">prxattrib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span>
					  <span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">attrib</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">security_priv</span> <span class="o">*</span><span class="n">psecuritypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">;</span>

	<span class="n">pframe</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span>
		  <span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rx_data</span><span class="p">;</span>
	<span class="cm">/* start to decrypt recvframe */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span> <span class="n">_WEP40_</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span>
	     <span class="n">_WEP104_</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iv</span> <span class="o">=</span> <span class="n">pframe</span> <span class="o">+</span> <span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
		<span class="n">keyindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">keylength</span> <span class="o">=</span> <span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">DefKeylen</span><span class="p">[</span><span class="n">keyindex</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wepkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iv</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wepkey</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">DefKey</span><span class="p">[</span>
			<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PrivacyKeyIndex</span><span class="p">].</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">keylength</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="p">((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span>
			   <span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="o">-</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="o">-</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span><span class="p">;</span>
		<span class="n">payload</span> <span class="o">=</span> <span class="n">pframe</span><span class="o">+</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span><span class="o">+</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
		<span class="cm">/* decrypt payload include icv */</span>
		<span class="n">arcfour_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">wepkey</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">keylength</span><span class="p">);</span>
		<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>  <span class="n">length</span><span class="p">);</span>
		<span class="cm">/* calculate icv and compare the icv */</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">crc</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">getcrc32</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 3 =====TKIP related===== */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">secmicgetuint32</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="cm">/* Convert from Byte[] to Us4Byte32 in a portable way */</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">secmicputuint32</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="cm">/* Convert from Us4Byte32 to Byte[] in a portable way */</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">secmicclear</span><span class="p">(</span><span class="k">struct</span> <span class="n">mic_data</span> <span class="o">*</span><span class="n">pmicdata</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* Reset the state to the empty message. */</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">=</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">K0</span><span class="p">;</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span> <span class="o">=</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">K1</span><span class="p">;</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">nBytesInM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">M</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_secmicsetkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">mic_data</span> <span class="o">*</span><span class="n">pmicdata</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set the key */</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">K0</span> <span class="o">=</span> <span class="n">secmicgetuint32</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">K1</span> <span class="o">=</span> <span class="n">secmicgetuint32</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* and reset the message */</span>
	<span class="n">secmicclear</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">secmicappendbyte</span><span class="p">(</span><span class="k">struct</span> <span class="n">mic_data</span> <span class="o">*</span><span class="n">pmicdata</span><span class="p">,</span> <span class="n">u8</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Append the byte to our word-sized buffer */</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">M</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">nBytesInM</span><span class="p">);</span>
	<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">nBytesInM</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Process the word if it is full. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">nBytesInM</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">^=</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">M</span><span class="p">;</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span> <span class="o">^=</span> <span class="n">ROL32</span><span class="p">(</span><span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">+=</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">;</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span> <span class="o">^=</span> <span class="p">((</span><span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">&amp;</span> <span class="mh">0xff00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">((</span><span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">&amp;</span> <span class="mh">0x00ff00ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">+=</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">;</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span> <span class="o">^=</span> <span class="n">ROL32</span><span class="p">(</span><span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">+=</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">;</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span> <span class="o">^=</span> <span class="n">ROR32</span><span class="p">(</span><span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span> <span class="o">+=</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">;</span>
		<span class="cm">/* Clear the buffer */</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">M</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">nBytesInM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_secmicappend</span><span class="p">(</span><span class="k">struct</span> <span class="n">mic_data</span> <span class="o">*</span><span class="n">pmicdata</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is simple */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">secmicappendbyte</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>
		<span class="n">nbytes</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_secgetmic</span><span class="p">(</span><span class="k">struct</span> <span class="n">mic_data</span> <span class="o">*</span><span class="n">pmicdata</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Append the minimum padding */</span>
	<span class="n">secmicappendbyte</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">);</span>
	<span class="n">secmicappendbyte</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">secmicappendbyte</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">secmicappendbyte</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">secmicappendbyte</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* and then zeroes until the length is a multiple of 4 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">nBytesInM</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">secmicappendbyte</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* The appendByte function has already computed the result. */</span>
	<span class="n">secmicputuint32</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">);</span>
	<span class="n">secmicputuint32</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pmicdata</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">);</span>
	<span class="cm">/* Reset to the empty message. */</span>
	<span class="n">secmicclear</span><span class="p">(</span><span class="n">pmicdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">seccalctkipmic</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mic_code</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">mic_data</span>	<span class="n">micdata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">priority</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">};</span>

	<span class="n">r8712_secmicsetkey</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="n">priority</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pri</span><span class="p">;</span>
	<span class="cm">/* Michael MIC pseudo header: DA, SA, 3 x 0, Priority */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* ToDS==1 */</span>
		<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>  <span class="cm">/* DA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>  <span class="cm">/* From Ds==1 */</span>
			<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* ToDS==0 */</span>
		<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>   <span class="cm">/* DA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>  <span class="cm">/* From Ds==1 */</span>
			<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priority</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">r8712_secmicappend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">r8712_secgetmic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micdata</span><span class="p">,</span> <span class="n">mic_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* macros for extraction/creation of unsigned char/unsigned short values  */</span>
<span class="cp">#define RotR1(v16)   ((((v16) &gt;&gt; 1) &amp; 0x7FFF) ^ (((v16) &amp; 1) &lt;&lt; 15))</span>
<span class="cp">#define   Lo8(v16)   ((u8)((v16) &amp; 0x00FF))</span>
<span class="cp">#define   Hi8(v16)   ((u8)(((v16) &gt;&gt; 8) &amp; 0x00FF))</span>
<span class="cp">#define  Lo16(v32)   ((u16)((v32) &amp; 0xFFFF))</span>
<span class="cp">#define  Hi16(v32)   ((u16)(((v32) &gt;&gt; 16) &amp; 0xFFFF))</span>
<span class="cp">#define  Mk16(hi, lo) ((lo) ^ (((u16)(hi)) &lt;&lt; 8))</span>

<span class="cm">/* select the Nth 16-bit word of the temporal key unsigned char array TK[]   */</span>
<span class="cp">#define  TK16(N)  Mk16(tk[2 * (N) + 1], tk[2 * (N)])</span>

<span class="cm">/* S-box lookup: 16 bits --&gt; 16 bits */</span>
<span class="cp">#define _S_(v16)  (Sbox1[0][Lo8(v16)] ^ Sbox1[1][Hi8(v16)])</span>

<span class="cm">/* fixed algorithm &quot;parameters&quot; */</span>
<span class="cp">#define PHASE1_LOOP_CNT   8    </span><span class="cm">/* this needs to be &quot;big enough&quot;     */</span><span class="cp"></span>
<span class="cp">#define TA_SIZE           6    </span><span class="cm">/*  48-bit transmitter address       */</span><span class="cp"></span>
<span class="cp">#define TK_SIZE          16    </span><span class="cm">/* 128-bit temporal key              */</span><span class="cp"></span>
<span class="cp">#define P1K_SIZE         10    </span><span class="cm">/*  80-bit Phase1 key                */</span><span class="cp"></span>
<span class="cp">#define RC4_KEY_SIZE     16    </span><span class="cm">/* 128-bit RC4KEY (104 bits unknown) */</span><span class="cp"></span>


<span class="cm">/* 2-unsigned char by 2-unsigned char subset of the full AES S-box table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Sbox1</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="cm">/* Sbox for hash (can be in ROM) */</span>
	<span class="p">{</span>
	<span class="mh">0xC6A5</span><span class="p">,</span> <span class="mh">0xF884</span><span class="p">,</span> <span class="mh">0xEE99</span><span class="p">,</span> <span class="mh">0xF68D</span><span class="p">,</span> <span class="mh">0xFF0D</span><span class="p">,</span> <span class="mh">0xD6BD</span><span class="p">,</span> <span class="mh">0xDEB1</span><span class="p">,</span> <span class="mh">0x9154</span><span class="p">,</span>
	<span class="mh">0x6050</span><span class="p">,</span> <span class="mh">0x0203</span><span class="p">,</span> <span class="mh">0xCEA9</span><span class="p">,</span> <span class="mh">0x567D</span><span class="p">,</span> <span class="mh">0xE719</span><span class="p">,</span> <span class="mh">0xB562</span><span class="p">,</span> <span class="mh">0x4DE6</span><span class="p">,</span> <span class="mh">0xEC9A</span><span class="p">,</span>
	<span class="mh">0x8F45</span><span class="p">,</span> <span class="mh">0x1F9D</span><span class="p">,</span> <span class="mh">0x8940</span><span class="p">,</span> <span class="mh">0xFA87</span><span class="p">,</span> <span class="mh">0xEF15</span><span class="p">,</span> <span class="mh">0xB2EB</span><span class="p">,</span> <span class="mh">0x8EC9</span><span class="p">,</span> <span class="mh">0xFB0B</span><span class="p">,</span>
	<span class="mh">0x41EC</span><span class="p">,</span> <span class="mh">0xB367</span><span class="p">,</span> <span class="mh">0x5FFD</span><span class="p">,</span> <span class="mh">0x45EA</span><span class="p">,</span> <span class="mh">0x23BF</span><span class="p">,</span> <span class="mh">0x53F7</span><span class="p">,</span> <span class="mh">0xE496</span><span class="p">,</span> <span class="mh">0x9B5B</span><span class="p">,</span>
	<span class="mh">0x75C2</span><span class="p">,</span> <span class="mh">0xE11C</span><span class="p">,</span> <span class="mh">0x3DAE</span><span class="p">,</span> <span class="mh">0x4C6A</span><span class="p">,</span> <span class="mh">0x6C5A</span><span class="p">,</span> <span class="mh">0x7E41</span><span class="p">,</span> <span class="mh">0xF502</span><span class="p">,</span> <span class="mh">0x834F</span><span class="p">,</span>
	<span class="mh">0x685C</span><span class="p">,</span> <span class="mh">0x51F4</span><span class="p">,</span> <span class="mh">0xD134</span><span class="p">,</span> <span class="mh">0xF908</span><span class="p">,</span> <span class="mh">0xE293</span><span class="p">,</span> <span class="mh">0xAB73</span><span class="p">,</span> <span class="mh">0x6253</span><span class="p">,</span> <span class="mh">0x2A3F</span><span class="p">,</span>
	<span class="mh">0x080C</span><span class="p">,</span> <span class="mh">0x9552</span><span class="p">,</span> <span class="mh">0x4665</span><span class="p">,</span> <span class="mh">0x9D5E</span><span class="p">,</span> <span class="mh">0x3028</span><span class="p">,</span> <span class="mh">0x37A1</span><span class="p">,</span> <span class="mh">0x0A0F</span><span class="p">,</span> <span class="mh">0x2FB5</span><span class="p">,</span>
	<span class="mh">0x0E09</span><span class="p">,</span> <span class="mh">0x2436</span><span class="p">,</span> <span class="mh">0x1B9B</span><span class="p">,</span> <span class="mh">0xDF3D</span><span class="p">,</span> <span class="mh">0xCD26</span><span class="p">,</span> <span class="mh">0x4E69</span><span class="p">,</span> <span class="mh">0x7FCD</span><span class="p">,</span> <span class="mh">0xEA9F</span><span class="p">,</span>
	<span class="mh">0x121B</span><span class="p">,</span> <span class="mh">0x1D9E</span><span class="p">,</span> <span class="mh">0x5874</span><span class="p">,</span> <span class="mh">0x342E</span><span class="p">,</span> <span class="mh">0x362D</span><span class="p">,</span> <span class="mh">0xDCB2</span><span class="p">,</span> <span class="mh">0xB4EE</span><span class="p">,</span> <span class="mh">0x5BFB</span><span class="p">,</span>
	<span class="mh">0xA4F6</span><span class="p">,</span> <span class="mh">0x764D</span><span class="p">,</span> <span class="mh">0xB761</span><span class="p">,</span> <span class="mh">0x7DCE</span><span class="p">,</span> <span class="mh">0x527B</span><span class="p">,</span> <span class="mh">0xDD3E</span><span class="p">,</span> <span class="mh">0x5E71</span><span class="p">,</span> <span class="mh">0x1397</span><span class="p">,</span>
	<span class="mh">0xA6F5</span><span class="p">,</span> <span class="mh">0xB968</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xC12C</span><span class="p">,</span> <span class="mh">0x4060</span><span class="p">,</span> <span class="mh">0xE31F</span><span class="p">,</span> <span class="mh">0x79C8</span><span class="p">,</span> <span class="mh">0xB6ED</span><span class="p">,</span>
	<span class="mh">0xD4BE</span><span class="p">,</span> <span class="mh">0x8D46</span><span class="p">,</span> <span class="mh">0x67D9</span><span class="p">,</span> <span class="mh">0x724B</span><span class="p">,</span> <span class="mh">0x94DE</span><span class="p">,</span> <span class="mh">0x98D4</span><span class="p">,</span> <span class="mh">0xB0E8</span><span class="p">,</span> <span class="mh">0x854A</span><span class="p">,</span>
	<span class="mh">0xBB6B</span><span class="p">,</span> <span class="mh">0xC52A</span><span class="p">,</span> <span class="mh">0x4FE5</span><span class="p">,</span> <span class="mh">0xED16</span><span class="p">,</span> <span class="mh">0x86C5</span><span class="p">,</span> <span class="mh">0x9AD7</span><span class="p">,</span> <span class="mh">0x6655</span><span class="p">,</span> <span class="mh">0x1194</span><span class="p">,</span>
	<span class="mh">0x8ACF</span><span class="p">,</span> <span class="mh">0xE910</span><span class="p">,</span> <span class="mh">0x0406</span><span class="p">,</span> <span class="mh">0xFE81</span><span class="p">,</span> <span class="mh">0xA0F0</span><span class="p">,</span> <span class="mh">0x7844</span><span class="p">,</span> <span class="mh">0x25BA</span><span class="p">,</span> <span class="mh">0x4BE3</span><span class="p">,</span>
	<span class="mh">0xA2F3</span><span class="p">,</span> <span class="mh">0x5DFE</span><span class="p">,</span> <span class="mh">0x80C0</span><span class="p">,</span> <span class="mh">0x058A</span><span class="p">,</span> <span class="mh">0x3FAD</span><span class="p">,</span> <span class="mh">0x21BC</span><span class="p">,</span> <span class="mh">0x7048</span><span class="p">,</span> <span class="mh">0xF104</span><span class="p">,</span>
	<span class="mh">0x63DF</span><span class="p">,</span> <span class="mh">0x77C1</span><span class="p">,</span> <span class="mh">0xAF75</span><span class="p">,</span> <span class="mh">0x4263</span><span class="p">,</span> <span class="mh">0x2030</span><span class="p">,</span> <span class="mh">0xE51A</span><span class="p">,</span> <span class="mh">0xFD0E</span><span class="p">,</span> <span class="mh">0xBF6D</span><span class="p">,</span>
	<span class="mh">0x814C</span><span class="p">,</span> <span class="mh">0x1814</span><span class="p">,</span> <span class="mh">0x2635</span><span class="p">,</span> <span class="mh">0xC32F</span><span class="p">,</span> <span class="mh">0xBEE1</span><span class="p">,</span> <span class="mh">0x35A2</span><span class="p">,</span> <span class="mh">0x88CC</span><span class="p">,</span> <span class="mh">0x2E39</span><span class="p">,</span>
	<span class="mh">0x9357</span><span class="p">,</span> <span class="mh">0x55F2</span><span class="p">,</span> <span class="mh">0xFC82</span><span class="p">,</span> <span class="mh">0x7A47</span><span class="p">,</span> <span class="mh">0xC8AC</span><span class="p">,</span> <span class="mh">0xBAE7</span><span class="p">,</span> <span class="mh">0x322B</span><span class="p">,</span> <span class="mh">0xE695</span><span class="p">,</span>
	<span class="mh">0xC0A0</span><span class="p">,</span> <span class="mh">0x1998</span><span class="p">,</span> <span class="mh">0x9ED1</span><span class="p">,</span> <span class="mh">0xA37F</span><span class="p">,</span> <span class="mh">0x4466</span><span class="p">,</span> <span class="mh">0x547E</span><span class="p">,</span> <span class="mh">0x3BAB</span><span class="p">,</span> <span class="mh">0x0B83</span><span class="p">,</span>
	<span class="mh">0x8CCA</span><span class="p">,</span> <span class="mh">0xC729</span><span class="p">,</span> <span class="mh">0x6BD3</span><span class="p">,</span> <span class="mh">0x283C</span><span class="p">,</span> <span class="mh">0xA779</span><span class="p">,</span> <span class="mh">0xBCE2</span><span class="p">,</span> <span class="mh">0x161D</span><span class="p">,</span> <span class="mh">0xAD76</span><span class="p">,</span>
	<span class="mh">0xDB3B</span><span class="p">,</span> <span class="mh">0x6456</span><span class="p">,</span> <span class="mh">0x744E</span><span class="p">,</span> <span class="mh">0x141E</span><span class="p">,</span> <span class="mh">0x92DB</span><span class="p">,</span> <span class="mh">0x0C0A</span><span class="p">,</span> <span class="mh">0x486C</span><span class="p">,</span> <span class="mh">0xB8E4</span><span class="p">,</span>
	<span class="mh">0x9F5D</span><span class="p">,</span> <span class="mh">0xBD6E</span><span class="p">,</span> <span class="mh">0x43EF</span><span class="p">,</span> <span class="mh">0xC4A6</span><span class="p">,</span> <span class="mh">0x39A8</span><span class="p">,</span> <span class="mh">0x31A4</span><span class="p">,</span> <span class="mh">0xD337</span><span class="p">,</span> <span class="mh">0xF28B</span><span class="p">,</span>
	<span class="mh">0xD532</span><span class="p">,</span> <span class="mh">0x8B43</span><span class="p">,</span> <span class="mh">0x6E59</span><span class="p">,</span> <span class="mh">0xDAB7</span><span class="p">,</span> <span class="mh">0x018C</span><span class="p">,</span> <span class="mh">0xB164</span><span class="p">,</span> <span class="mh">0x9CD2</span><span class="p">,</span> <span class="mh">0x49E0</span><span class="p">,</span>
	<span class="mh">0xD8B4</span><span class="p">,</span> <span class="mh">0xACFA</span><span class="p">,</span> <span class="mh">0xF307</span><span class="p">,</span> <span class="mh">0xCF25</span><span class="p">,</span> <span class="mh">0xCAAF</span><span class="p">,</span> <span class="mh">0xF48E</span><span class="p">,</span> <span class="mh">0x47E9</span><span class="p">,</span> <span class="mh">0x1018</span><span class="p">,</span>
	<span class="mh">0x6FD5</span><span class="p">,</span> <span class="mh">0xF088</span><span class="p">,</span> <span class="mh">0x4A6F</span><span class="p">,</span> <span class="mh">0x5C72</span><span class="p">,</span> <span class="mh">0x3824</span><span class="p">,</span> <span class="mh">0x57F1</span><span class="p">,</span> <span class="mh">0x73C7</span><span class="p">,</span> <span class="mh">0x9751</span><span class="p">,</span>
	<span class="mh">0xCB23</span><span class="p">,</span> <span class="mh">0xA17C</span><span class="p">,</span> <span class="mh">0xE89C</span><span class="p">,</span> <span class="mh">0x3E21</span><span class="p">,</span> <span class="mh">0x96DD</span><span class="p">,</span> <span class="mh">0x61DC</span><span class="p">,</span> <span class="mh">0x0D86</span><span class="p">,</span> <span class="mh">0x0F85</span><span class="p">,</span>
	<span class="mh">0xE090</span><span class="p">,</span> <span class="mh">0x7C42</span><span class="p">,</span> <span class="mh">0x71C4</span><span class="p">,</span> <span class="mh">0xCCAA</span><span class="p">,</span> <span class="mh">0x90D8</span><span class="p">,</span> <span class="mh">0x0605</span><span class="p">,</span> <span class="mh">0xF701</span><span class="p">,</span> <span class="mh">0x1C12</span><span class="p">,</span>
	<span class="mh">0xC2A3</span><span class="p">,</span> <span class="mh">0x6A5F</span><span class="p">,</span> <span class="mh">0xAEF9</span><span class="p">,</span> <span class="mh">0x69D0</span><span class="p">,</span> <span class="mh">0x1791</span><span class="p">,</span> <span class="mh">0x9958</span><span class="p">,</span> <span class="mh">0x3A27</span><span class="p">,</span> <span class="mh">0x27B9</span><span class="p">,</span>
	<span class="mh">0xD938</span><span class="p">,</span> <span class="mh">0xEB13</span><span class="p">,</span> <span class="mh">0x2BB3</span><span class="p">,</span> <span class="mh">0x2233</span><span class="p">,</span> <span class="mh">0xD2BB</span><span class="p">,</span> <span class="mh">0xA970</span><span class="p">,</span> <span class="mh">0x0789</span><span class="p">,</span> <span class="mh">0x33A7</span><span class="p">,</span>
	<span class="mh">0x2DB6</span><span class="p">,</span> <span class="mh">0x3C22</span><span class="p">,</span> <span class="mh">0x1592</span><span class="p">,</span> <span class="mh">0xC920</span><span class="p">,</span> <span class="mh">0x8749</span><span class="p">,</span> <span class="mh">0xAAFF</span><span class="p">,</span> <span class="mh">0x5078</span><span class="p">,</span> <span class="mh">0xA57A</span><span class="p">,</span>
	<span class="mh">0x038F</span><span class="p">,</span> <span class="mh">0x59F8</span><span class="p">,</span> <span class="mh">0x0980</span><span class="p">,</span> <span class="mh">0x1A17</span><span class="p">,</span> <span class="mh">0x65DA</span><span class="p">,</span> <span class="mh">0xD731</span><span class="p">,</span> <span class="mh">0x84C6</span><span class="p">,</span> <span class="mh">0xD0B8</span><span class="p">,</span>
	<span class="mh">0x82C3</span><span class="p">,</span> <span class="mh">0x29B0</span><span class="p">,</span> <span class="mh">0x5A77</span><span class="p">,</span> <span class="mh">0x1E11</span><span class="p">,</span> <span class="mh">0x7BCB</span><span class="p">,</span> <span class="mh">0xA8FC</span><span class="p">,</span> <span class="mh">0x6DD6</span><span class="p">,</span> <span class="mh">0x2C3A</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>  <span class="cm">/* second half is unsigned char-reversed version of first! */</span>
	<span class="mh">0xA5C6</span><span class="p">,</span> <span class="mh">0x84F8</span><span class="p">,</span> <span class="mh">0x99EE</span><span class="p">,</span> <span class="mh">0x8DF6</span><span class="p">,</span> <span class="mh">0x0DFF</span><span class="p">,</span> <span class="mh">0xBDD6</span><span class="p">,</span> <span class="mh">0xB1DE</span><span class="p">,</span> <span class="mh">0x5491</span><span class="p">,</span>
	<span class="mh">0x5060</span><span class="p">,</span> <span class="mh">0x0302</span><span class="p">,</span> <span class="mh">0xA9CE</span><span class="p">,</span> <span class="mh">0x7D56</span><span class="p">,</span> <span class="mh">0x19E7</span><span class="p">,</span> <span class="mh">0x62B5</span><span class="p">,</span> <span class="mh">0xE64D</span><span class="p">,</span> <span class="mh">0x9AEC</span><span class="p">,</span>
	<span class="mh">0x458F</span><span class="p">,</span> <span class="mh">0x9D1F</span><span class="p">,</span> <span class="mh">0x4089</span><span class="p">,</span> <span class="mh">0x87FA</span><span class="p">,</span> <span class="mh">0x15EF</span><span class="p">,</span> <span class="mh">0xEBB2</span><span class="p">,</span> <span class="mh">0xC98E</span><span class="p">,</span> <span class="mh">0x0BFB</span><span class="p">,</span>
	<span class="mh">0xEC41</span><span class="p">,</span> <span class="mh">0x67B3</span><span class="p">,</span> <span class="mh">0xFD5F</span><span class="p">,</span> <span class="mh">0xEA45</span><span class="p">,</span> <span class="mh">0xBF23</span><span class="p">,</span> <span class="mh">0xF753</span><span class="p">,</span> <span class="mh">0x96E4</span><span class="p">,</span> <span class="mh">0x5B9B</span><span class="p">,</span>
	<span class="mh">0xC275</span><span class="p">,</span> <span class="mh">0x1CE1</span><span class="p">,</span> <span class="mh">0xAE3D</span><span class="p">,</span> <span class="mh">0x6A4C</span><span class="p">,</span> <span class="mh">0x5A6C</span><span class="p">,</span> <span class="mh">0x417E</span><span class="p">,</span> <span class="mh">0x02F5</span><span class="p">,</span> <span class="mh">0x4F83</span><span class="p">,</span>
	<span class="mh">0x5C68</span><span class="p">,</span> <span class="mh">0xF451</span><span class="p">,</span> <span class="mh">0x34D1</span><span class="p">,</span> <span class="mh">0x08F9</span><span class="p">,</span> <span class="mh">0x93E2</span><span class="p">,</span> <span class="mh">0x73AB</span><span class="p">,</span> <span class="mh">0x5362</span><span class="p">,</span> <span class="mh">0x3F2A</span><span class="p">,</span>
	<span class="mh">0x0C08</span><span class="p">,</span> <span class="mh">0x5295</span><span class="p">,</span> <span class="mh">0x6546</span><span class="p">,</span> <span class="mh">0x5E9D</span><span class="p">,</span> <span class="mh">0x2830</span><span class="p">,</span> <span class="mh">0xA137</span><span class="p">,</span> <span class="mh">0x0F0A</span><span class="p">,</span> <span class="mh">0xB52F</span><span class="p">,</span>
	<span class="mh">0x090E</span><span class="p">,</span> <span class="mh">0x3624</span><span class="p">,</span> <span class="mh">0x9B1B</span><span class="p">,</span> <span class="mh">0x3DDF</span><span class="p">,</span> <span class="mh">0x26CD</span><span class="p">,</span> <span class="mh">0x694E</span><span class="p">,</span> <span class="mh">0xCD7F</span><span class="p">,</span> <span class="mh">0x9FEA</span><span class="p">,</span>
	<span class="mh">0x1B12</span><span class="p">,</span> <span class="mh">0x9E1D</span><span class="p">,</span> <span class="mh">0x7458</span><span class="p">,</span> <span class="mh">0x2E34</span><span class="p">,</span> <span class="mh">0x2D36</span><span class="p">,</span> <span class="mh">0xB2DC</span><span class="p">,</span> <span class="mh">0xEEB4</span><span class="p">,</span> <span class="mh">0xFB5B</span><span class="p">,</span>
	<span class="mh">0xF6A4</span><span class="p">,</span> <span class="mh">0x4D76</span><span class="p">,</span> <span class="mh">0x61B7</span><span class="p">,</span> <span class="mh">0xCE7D</span><span class="p">,</span> <span class="mh">0x7B52</span><span class="p">,</span> <span class="mh">0x3EDD</span><span class="p">,</span> <span class="mh">0x715E</span><span class="p">,</span> <span class="mh">0x9713</span><span class="p">,</span>
	<span class="mh">0xF5A6</span><span class="p">,</span> <span class="mh">0x68B9</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x2CC1</span><span class="p">,</span> <span class="mh">0x6040</span><span class="p">,</span> <span class="mh">0x1FE3</span><span class="p">,</span> <span class="mh">0xC879</span><span class="p">,</span> <span class="mh">0xEDB6</span><span class="p">,</span>
	<span class="mh">0xBED4</span><span class="p">,</span> <span class="mh">0x468D</span><span class="p">,</span> <span class="mh">0xD967</span><span class="p">,</span> <span class="mh">0x4B72</span><span class="p">,</span> <span class="mh">0xDE94</span><span class="p">,</span> <span class="mh">0xD498</span><span class="p">,</span> <span class="mh">0xE8B0</span><span class="p">,</span> <span class="mh">0x4A85</span><span class="p">,</span>
	<span class="mh">0x6BBB</span><span class="p">,</span> <span class="mh">0x2AC5</span><span class="p">,</span> <span class="mh">0xE54F</span><span class="p">,</span> <span class="mh">0x16ED</span><span class="p">,</span> <span class="mh">0xC586</span><span class="p">,</span> <span class="mh">0xD79A</span><span class="p">,</span> <span class="mh">0x5566</span><span class="p">,</span> <span class="mh">0x9411</span><span class="p">,</span>
	<span class="mh">0xCF8A</span><span class="p">,</span> <span class="mh">0x10E9</span><span class="p">,</span> <span class="mh">0x0604</span><span class="p">,</span> <span class="mh">0x81FE</span><span class="p">,</span> <span class="mh">0xF0A0</span><span class="p">,</span> <span class="mh">0x4478</span><span class="p">,</span> <span class="mh">0xBA25</span><span class="p">,</span> <span class="mh">0xE34B</span><span class="p">,</span>
	<span class="mh">0xF3A2</span><span class="p">,</span> <span class="mh">0xFE5D</span><span class="p">,</span> <span class="mh">0xC080</span><span class="p">,</span> <span class="mh">0x8A05</span><span class="p">,</span> <span class="mh">0xAD3F</span><span class="p">,</span> <span class="mh">0xBC21</span><span class="p">,</span> <span class="mh">0x4870</span><span class="p">,</span> <span class="mh">0x04F1</span><span class="p">,</span>
	<span class="mh">0xDF63</span><span class="p">,</span> <span class="mh">0xC177</span><span class="p">,</span> <span class="mh">0x75AF</span><span class="p">,</span> <span class="mh">0x6342</span><span class="p">,</span> <span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0x1AE5</span><span class="p">,</span> <span class="mh">0x0EFD</span><span class="p">,</span> <span class="mh">0x6DBF</span><span class="p">,</span>
	<span class="mh">0x4C81</span><span class="p">,</span> <span class="mh">0x1418</span><span class="p">,</span> <span class="mh">0x3526</span><span class="p">,</span> <span class="mh">0x2FC3</span><span class="p">,</span> <span class="mh">0xE1BE</span><span class="p">,</span> <span class="mh">0xA235</span><span class="p">,</span> <span class="mh">0xCC88</span><span class="p">,</span> <span class="mh">0x392E</span><span class="p">,</span>
	<span class="mh">0x5793</span><span class="p">,</span> <span class="mh">0xF255</span><span class="p">,</span> <span class="mh">0x82FC</span><span class="p">,</span> <span class="mh">0x477A</span><span class="p">,</span> <span class="mh">0xACC8</span><span class="p">,</span> <span class="mh">0xE7BA</span><span class="p">,</span> <span class="mh">0x2B32</span><span class="p">,</span> <span class="mh">0x95E6</span><span class="p">,</span>
	<span class="mh">0xA0C0</span><span class="p">,</span> <span class="mh">0x9819</span><span class="p">,</span> <span class="mh">0xD19E</span><span class="p">,</span> <span class="mh">0x7FA3</span><span class="p">,</span> <span class="mh">0x6644</span><span class="p">,</span> <span class="mh">0x7E54</span><span class="p">,</span> <span class="mh">0xAB3B</span><span class="p">,</span> <span class="mh">0x830B</span><span class="p">,</span>
	<span class="mh">0xCA8C</span><span class="p">,</span> <span class="mh">0x29C7</span><span class="p">,</span> <span class="mh">0xD36B</span><span class="p">,</span> <span class="mh">0x3C28</span><span class="p">,</span> <span class="mh">0x79A7</span><span class="p">,</span> <span class="mh">0xE2BC</span><span class="p">,</span> <span class="mh">0x1D16</span><span class="p">,</span> <span class="mh">0x76AD</span><span class="p">,</span>
	<span class="mh">0x3BDB</span><span class="p">,</span> <span class="mh">0x5664</span><span class="p">,</span> <span class="mh">0x4E74</span><span class="p">,</span> <span class="mh">0x1E14</span><span class="p">,</span> <span class="mh">0xDB92</span><span class="p">,</span> <span class="mh">0x0A0C</span><span class="p">,</span> <span class="mh">0x6C48</span><span class="p">,</span> <span class="mh">0xE4B8</span><span class="p">,</span>
	<span class="mh">0x5D9F</span><span class="p">,</span> <span class="mh">0x6EBD</span><span class="p">,</span> <span class="mh">0xEF43</span><span class="p">,</span> <span class="mh">0xA6C4</span><span class="p">,</span> <span class="mh">0xA839</span><span class="p">,</span> <span class="mh">0xA431</span><span class="p">,</span> <span class="mh">0x37D3</span><span class="p">,</span> <span class="mh">0x8BF2</span><span class="p">,</span>
	<span class="mh">0x32D5</span><span class="p">,</span> <span class="mh">0x438B</span><span class="p">,</span> <span class="mh">0x596E</span><span class="p">,</span> <span class="mh">0xB7DA</span><span class="p">,</span> <span class="mh">0x8C01</span><span class="p">,</span> <span class="mh">0x64B1</span><span class="p">,</span> <span class="mh">0xD29C</span><span class="p">,</span> <span class="mh">0xE049</span><span class="p">,</span>
	<span class="mh">0xB4D8</span><span class="p">,</span> <span class="mh">0xFAAC</span><span class="p">,</span> <span class="mh">0x07F3</span><span class="p">,</span> <span class="mh">0x25CF</span><span class="p">,</span> <span class="mh">0xAFCA</span><span class="p">,</span> <span class="mh">0x8EF4</span><span class="p">,</span> <span class="mh">0xE947</span><span class="p">,</span> <span class="mh">0x1810</span><span class="p">,</span>
	<span class="mh">0xD56F</span><span class="p">,</span> <span class="mh">0x88F0</span><span class="p">,</span> <span class="mh">0x6F4A</span><span class="p">,</span> <span class="mh">0x725C</span><span class="p">,</span> <span class="mh">0x2438</span><span class="p">,</span> <span class="mh">0xF157</span><span class="p">,</span> <span class="mh">0xC773</span><span class="p">,</span> <span class="mh">0x5197</span><span class="p">,</span>
	<span class="mh">0x23CB</span><span class="p">,</span> <span class="mh">0x7CA1</span><span class="p">,</span> <span class="mh">0x9CE8</span><span class="p">,</span> <span class="mh">0x213E</span><span class="p">,</span> <span class="mh">0xDD96</span><span class="p">,</span> <span class="mh">0xDC61</span><span class="p">,</span> <span class="mh">0x860D</span><span class="p">,</span> <span class="mh">0x850F</span><span class="p">,</span>
	<span class="mh">0x90E0</span><span class="p">,</span> <span class="mh">0x427C</span><span class="p">,</span> <span class="mh">0xC471</span><span class="p">,</span> <span class="mh">0xAACC</span><span class="p">,</span> <span class="mh">0xD890</span><span class="p">,</span> <span class="mh">0x0506</span><span class="p">,</span> <span class="mh">0x01F7</span><span class="p">,</span> <span class="mh">0x121C</span><span class="p">,</span>
	<span class="mh">0xA3C2</span><span class="p">,</span> <span class="mh">0x5F6A</span><span class="p">,</span> <span class="mh">0xF9AE</span><span class="p">,</span> <span class="mh">0xD069</span><span class="p">,</span> <span class="mh">0x9117</span><span class="p">,</span> <span class="mh">0x5899</span><span class="p">,</span> <span class="mh">0x273A</span><span class="p">,</span> <span class="mh">0xB927</span><span class="p">,</span>
	<span class="mh">0x38D9</span><span class="p">,</span> <span class="mh">0x13EB</span><span class="p">,</span> <span class="mh">0xB32B</span><span class="p">,</span> <span class="mh">0x3322</span><span class="p">,</span> <span class="mh">0xBBD2</span><span class="p">,</span> <span class="mh">0x70A9</span><span class="p">,</span> <span class="mh">0x8907</span><span class="p">,</span> <span class="mh">0xA733</span><span class="p">,</span>
	<span class="mh">0xB62D</span><span class="p">,</span> <span class="mh">0x223C</span><span class="p">,</span> <span class="mh">0x9215</span><span class="p">,</span> <span class="mh">0x20C9</span><span class="p">,</span> <span class="mh">0x4987</span><span class="p">,</span> <span class="mh">0xFFAA</span><span class="p">,</span> <span class="mh">0x7850</span><span class="p">,</span> <span class="mh">0x7AA5</span><span class="p">,</span>
	<span class="mh">0x8F03</span><span class="p">,</span> <span class="mh">0xF859</span><span class="p">,</span> <span class="mh">0x8009</span><span class="p">,</span> <span class="mh">0x171A</span><span class="p">,</span> <span class="mh">0xDA65</span><span class="p">,</span> <span class="mh">0x31D7</span><span class="p">,</span> <span class="mh">0xC684</span><span class="p">,</span> <span class="mh">0xB8D0</span><span class="p">,</span>
	<span class="mh">0xC382</span><span class="p">,</span> <span class="mh">0xB029</span><span class="p">,</span> <span class="mh">0x775A</span><span class="p">,</span> <span class="mh">0x111E</span><span class="p">,</span> <span class="mh">0xCB7B</span><span class="p">,</span> <span class="mh">0xFCA8</span><span class="p">,</span> <span class="mh">0xD66D</span><span class="p">,</span> <span class="mh">0x3A2C</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">**********************************************************************</span>
<span class="cm">* Routine: Phase 1 -- generate P1K, given TA, TK, IV32</span>
<span class="cm">*</span>
<span class="cm">* Inputs:</span>
<span class="cm">*     tk[]      = temporal key                         [128 bits]</span>
<span class="cm">*     ta[]      = transmitter&#39;s MAC address            [ 48 bits]</span>
<span class="cm">*     iv32      = upper 32 bits of IV                  [ 32 bits]</span>
<span class="cm">* Output:</span>
<span class="cm">*     p1k[]     = Phase 1 key                          [ 80 bits]</span>
<span class="cm">*</span>
<span class="cm">* Note:</span>
<span class="cm">*     This function only needs to be called every 2**16 packets,</span>
<span class="cm">*     although in theory it could be called every packet.</span>
<span class="cm">*</span>
<span class="cm">**********************************************************************</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">phase1</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">p1k</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iv32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span>  <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Initialize the 80 bits of P1K[] from IV32 and TA[0..5]     */</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lo16</span><span class="p">(</span><span class="n">iv32</span><span class="p">);</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hi16</span><span class="p">(</span><span class="n">iv32</span><span class="p">);</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">ta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ta</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="cm">/* use TA[] as little-endian */</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">ta</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ta</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mk16</span><span class="p">(</span><span class="n">ta</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ta</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="cm">/* Now compute an unbalanced Feistel cipher with 80-bit block */</span>
	<span class="cm">/* size on the 80-bit block P1K[], using the 128-bit key TK[] */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHASE1_LOOP_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* Each add is mod 2**16 */</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">((</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">((</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">((</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">((</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">((</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span>  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>	<span class="cm">/* avoid &quot;slide attacks&quot; */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">**********************************************************************</span>
<span class="cm">* Routine: Phase 2 -- generate RC4KEY, given TK, P1K, IV16</span>
<span class="cm">*</span>
<span class="cm">* Inputs:</span>
<span class="cm">*     tk[]      = Temporal key                         [128 bits]</span>
<span class="cm">*     p1k[]     = Phase 1 output key                   [ 80 bits]</span>
<span class="cm">*     iv16      = low 16 bits of IV counter            [ 16 bits]</span>
<span class="cm">* Output:</span>
<span class="cm">*     rc4key[]  = the key used to encrypt the packet   [128 bits]</span>
<span class="cm">*</span>
<span class="cm">* Note:</span>
<span class="cm">*     The value {TA,IV32,IV16} for Phase1/Phase2 must be unique</span>
<span class="cm">*     across all packets using the same key TK value. Then, for a</span>
<span class="cm">*     given value of TK[], this TKIP48 construction guarantees that</span>
<span class="cm">*     the final RC4KEY value is unique across all packets.</span>
<span class="cm">*</span>
<span class="cm">* Suggested implementation optimization: if PPK[] is &quot;overlaid&quot;</span>
<span class="cm">*     appropriately on RC4KEY[], there is no need for the final</span>
<span class="cm">*     for loop below that copies the PPK[] result into RC4KEY[].</span>
<span class="cm">*</span>
<span class="cm">**********************************************************************</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">phase2</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">rc4key</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tk</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">p1k</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iv16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span>  <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">PPK</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>			<span class="cm">/* temporary key for mixing    */</span>

	<span class="cm">/* Note: all adds in the PPK[] equations below are mod 2**16 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">PPK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p1k</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="cm">/* first, copy P1K to PPK */</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">p1k</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">iv16</span><span class="p">;</span> <span class="cm">/* next,  add in IV16 */</span>
	<span class="cm">/* Bijective non-linear mixing of the 96 bits of PPK[0..5] */</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>   <span class="cm">/* Mix key in each &quot;round&quot; */</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_S_</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>   <span class="cm">/* Total # S-box lookups == 6  */</span>
	<span class="cm">/* Final sweep: bijective, &quot;linear&quot;. Rotates kill LSB correlations   */</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>   <span class="cm">/* Use all of TK[] in Phase2   */</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span>  <span class="n">RotR1</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="cm">/* Note: At this point, for a given key TK[0..15], the 96-bit output */</span>
	<span class="cm">/* value PPK[0..5] is guaranteed to be unique, as a function   */</span>
	<span class="cm">/* of the 96-bit &quot;input&quot; value   {TA,IV32,IV16}. That is, P1K  */</span>
	<span class="cm">/* is now a keyed permutation of {TA,IV32,IV16}. */</span>
	<span class="cm">/* Set RC4KEY[0..3], which includes &quot;cleartext&quot; portion of RC4 key   */</span>
	<span class="n">rc4key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hi8</span><span class="p">(</span><span class="n">iv16</span><span class="p">);</span> <span class="cm">/* RC4KEY[0..2] is the WEP IV  */</span>
	<span class="n">rc4key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Hi8</span><span class="p">(</span><span class="n">iv16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="cm">/* Help avoid weak (FMS) keys  */</span>
	<span class="n">rc4key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lo8</span><span class="p">(</span><span class="n">iv16</span><span class="p">);</span>
	<span class="n">rc4key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lo8</span><span class="p">((</span><span class="n">PPK</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">^</span> <span class="n">TK16</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Copy 96 bits of PPK[0..5] to RC4KEY[4..15]  (little-endian) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc4key</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lo8</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">rc4key</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hi8</span><span class="p">(</span><span class="n">PPK</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*The hlen isn&#39;t include the IV*/</span>
<span class="n">u32</span> <span class="nf">r8712_tkip_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pxmitframe</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/*  exclude ICV */</span>
	<span class="n">u16</span> <span class="n">pnl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pnh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc4key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ttkey</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">crc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">arc4context</span> <span class="n">mycontext</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">curfragnum</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">prwskeylen</span><span class="p">;</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span> <span class="o">*</span><span class="n">prwskey</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pn48</span> <span class="n">txpn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">stainfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pkt_attrib</span> <span class="o">*</span><span class="n">pattrib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xmit_priv</span> <span class="o">*</span><span class="n">pxmitpriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res</span> <span class="o">=</span> <span class="n">_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>

	<span class="n">pframe</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="o">+</span><span class="n">TXDESC_OFFSET</span><span class="p">;</span>
	<span class="cm">/* 4 start to encrypt each fragment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span> <span class="n">_TKIP_</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">psta</span><span class="p">)</span>
			<span class="n">stainfo</span> <span class="o">=</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">psta</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">stainfo</span> <span class="o">=</span> <span class="n">r8712_get_stainfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stainfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prwskey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stainfo</span><span class="o">-&gt;</span><span class="n">x_UncstKey</span><span class="p">.</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">prwskeylen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">curfragnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">curfragnum</span> <span class="o">&lt;</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
			     <span class="n">curfragnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iv</span> <span class="o">=</span> <span class="n">pframe</span> <span class="o">+</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
				<span class="n">payload</span> <span class="o">=</span> <span class="n">pframe</span><span class="o">+</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span> <span class="o">+</span>
					  <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
				<span class="n">GET_TKIP_PN</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">txpn</span><span class="p">);</span>
				<span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">txpn</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
				<span class="n">pnh</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">txpn</span><span class="p">.</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">phase1</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ttkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prwskey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pattrib</span><span class="o">-&gt;</span>
				       <span class="n">ta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pnh</span><span class="p">);</span>
				<span class="n">phase2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc4key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prwskey</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ttkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="n">pnl</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">curfragnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* 4 the last fragment */</span>
					<span class="n">length</span> <span class="o">=</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">last_txcmdsz</span> <span class="o">-</span>
					     <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span> <span class="o">-</span>
					     <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>
					<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">crc</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
						<span class="n">getcrc32</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
					<span class="n">arcfour_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
							<span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
					<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span> <span class="o">+</span>
							<span class="n">length</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">length</span> <span class="o">=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span>
						 <span class="n">hdrlen</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span>
						 <span class="n">iv_len</span><span class="o">-</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>
					<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">crc</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">getcrc32</span><span class="p">(</span>
							<span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
					<span class="n">arcfour_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
							 <span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
					<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span>
							<span class="n">payload</span><span class="o">+</span><span class="n">length</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">pframe</span> <span class="o">+=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">;</span>
					<span class="n">pframe</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">RND4</span><span class="p">((</span><span class="n">addr_t</span><span class="p">)(</span><span class="n">pframe</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The hlen doesn&#39;t include the IV */</span>
<span class="n">u32</span> <span class="nf">r8712_tkip_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">precvframe</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* exclude ICV */</span>
	<span class="n">u16</span> <span class="n">pnl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pnh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc4key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ttkey</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">crc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">arc4context</span> <span class="n">mycontext</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="n">prwskeylen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span> <span class="o">*</span><span class="n">prwskey</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pn48</span> <span class="n">txpn</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">sta_info</span> <span class="o">*</span><span class="n">stainfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">rx_pkt_attrib</span> <span class="o">*</span><span class="n">prxattrib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span>
					   <span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">attrib</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">security_priv</span>	<span class="o">*</span><span class="n">psecuritypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">;</span>

	<span class="n">pframe</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span>
				   <span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rx_data</span><span class="p">;</span>
	<span class="cm">/* 4 start to decrypt recvframe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span> <span class="n">_TKIP_</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stainfo</span> <span class="o">=</span> <span class="n">r8712_get_stainfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stainfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iv</span> <span class="o">=</span> <span class="n">pframe</span><span class="o">+</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
			<span class="n">payload</span> <span class="o">=</span> <span class="n">pframe</span><span class="o">+</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span> <span class="o">+</span> <span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">=</span> <span class="p">((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span>
				 <span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span> <span class="o">-</span>
				 <span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_MCAST</span><span class="p">(</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">idx</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="n">prwskey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">XGrpKey</span><span class="p">[</span>
					 <span class="p">((</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">binstallGrpkey</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">prwskey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stainfo</span><span class="o">-&gt;</span><span class="n">x_UncstKey</span><span class="p">.</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">prwskeylen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">GET_TKIP_PN</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">txpn</span><span class="p">);</span>
			<span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">txpn</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">pnh</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">txpn</span><span class="p">.</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">phase1</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ttkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prwskey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">pnh</span><span class="p">);</span>
			<span class="n">phase2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc4key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prwskey</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span>
			       <span class="o">&amp;</span><span class="n">ttkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pnl</span><span class="p">);</span>
			<span class="cm">/* 4 decrypt payload include icv */</span>
			<span class="n">arcfour_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">rc4key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">arcfour_encrypt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycontext</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">crc</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">getcrc32</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span>
					<span class="n">length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">payload</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
			    <span class="n">crc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">payload</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">||</span>
			    <span class="n">crc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">payload</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">||</span>
			    <span class="n">crc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">payload</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">])</span>
				<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 3 =====AES related===== */</span>

<span class="cp">#define MAX_MSG_SIZE	2048</span>
<span class="cm">/*****************************/</span>
<span class="cm">/******** SBOX Table *********/</span>
<span class="cm">/*****************************/</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">sbox_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span>
	<span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
	<span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span>
	<span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span>
	<span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
	<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span>
	<span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span>
	<span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span>
	<span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span>
	<span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span>
	<span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span>
	<span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span>
	<span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span>
	<span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span>
	<span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span>
	<span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span>
	<span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span>
	<span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span>
	<span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span>
	<span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span>
	<span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span>
	<span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span>
	<span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x16</span>
<span class="p">};</span>

<span class="cm">/****************************************/</span>
<span class="cm">/* aes128k128d()                        */</span>
<span class="cm">/* Performs a 128 bit AES encrypt with  */</span>
<span class="cm">/* 128 bit data.                        */</span>
<span class="cm">/****************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xor_128</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xor_32</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">sbox</span><span class="p">(</span><span class="n">u8</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sbox_table</span><span class="p">[(</span><span class="n">sint</span><span class="p">)</span><span class="n">a</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">next_key</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">sint</span> <span class="n">round</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rcon</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sbox_key</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rcon_table</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x36</span>
	<span class="p">};</span>

	<span class="n">sbox_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
	<span class="n">sbox_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">sbox_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">sbox_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">rcon</span> <span class="o">=</span> <span class="n">rcon_table</span><span class="p">[</span><span class="n">round</span><span class="p">];</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sbox_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">rcon</span><span class="p">;</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">byte_sub</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shift_row</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span>  <span class="n">in</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mix_column</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">add1b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">add1bf7</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rotl</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">swap_halfs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">andf7</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rotr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">tempb</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">add1b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1b</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">add1b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">swap_halfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>    <span class="cm">/* Swap halves */</span>
	<span class="n">swap_halfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">swap_halfs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">swap_halfs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">rotl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>        <span class="cm">/* Rotate left 8 bits */</span>
	<span class="n">rotl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rotl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">rotl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">andf7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">andf7</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">andf7</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">andf7</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* logical shift left 1 bit */</span>
		<span class="n">andf7</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">andf7</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">andf7</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">andf7</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">andf7</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">andf7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">andf7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">andf7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">andf7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="n">add1b</span><span class="p">,</span> <span class="n">andf7</span><span class="p">,</span> <span class="n">add1bf7</span><span class="p">);</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">add1bf7</span><span class="p">,</span> <span class="n">rotr</span><span class="p">);</span>
	<span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>         <span class="cm">/* Rotate right 8 bits */</span>
	<span class="n">rotr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">rotr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">rotr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">rotr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="n">add1bf7</span><span class="p">,</span> <span class="n">rotr</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="n">swap_halfs</span><span class="p">,</span> <span class="n">rotl</span><span class="p">,</span> <span class="n">tempb</span><span class="p">);</span>
	<span class="n">xor_32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">tempb</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aes128k128d</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ciphertext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">round</span><span class="p">;</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">intermediatea</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">intermediateb</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">round_key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">round_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">round</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">round</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="n">round</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">round</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xor_128</span><span class="p">(</span><span class="n">round_key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">);</span>
			<span class="n">next_key</span><span class="p">(</span><span class="n">round_key</span><span class="p">,</span> <span class="n">round</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">round</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">byte_sub</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">intermediatea</span><span class="p">);</span>
			<span class="n">shift_row</span><span class="p">(</span><span class="n">intermediatea</span><span class="p">,</span> <span class="n">intermediateb</span><span class="p">);</span>
			<span class="n">xor_128</span><span class="p">(</span><span class="n">intermediateb</span><span class="p">,</span> <span class="n">round_key</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>   <span class="cm">/* 1 - 9 */</span>
			<span class="n">byte_sub</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">intermediatea</span><span class="p">);</span>
			<span class="n">shift_row</span><span class="p">(</span><span class="n">intermediatea</span><span class="p">,</span> <span class="n">intermediateb</span><span class="p">);</span>
			<span class="n">mix_column</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intermediateb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">intermediatea</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">mix_column</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intermediateb</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">intermediatea</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">mix_column</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intermediateb</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">intermediatea</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
			<span class="n">mix_column</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intermediateb</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">intermediatea</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
			<span class="n">xor_128</span><span class="p">(</span><span class="n">intermediatea</span><span class="p">,</span> <span class="n">round_key</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">);</span>
			<span class="n">next_key</span><span class="p">(</span><span class="n">round_key</span><span class="p">,</span> <span class="n">round</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************************************/</span>
<span class="cm">/* construct_mic_iv()                           */</span>
<span class="cm">/* Builds the MIC IV from header fields and PN  */</span>
<span class="cm">/************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">construct_mic_iv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">mic_iv</span><span class="p">,</span> <span class="n">sint</span> <span class="n">qc_exists</span><span class="p">,</span> <span class="n">sint</span> <span class="n">a4_exists</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="o">*</span><span class="n">mpdu</span><span class="p">,</span> <span class="n">uint</span> <span class="n">payload_length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pn_vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mic_iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x59</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc_exists</span> <span class="o">&amp;&amp;</span> <span class="n">a4_exists</span><span class="p">)</span>
		<span class="n">mic_iv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>    <span class="cm">/* QoS_TC           */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc_exists</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a4_exists</span><span class="p">)</span>
		<span class="n">mic_iv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>   <span class="cm">/* mute bits 7-4    */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qc_exists</span><span class="p">)</span>
		<span class="n">mic_iv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mic_iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mic_iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn_vector</span><span class="p">[</span><span class="mi">13</span> <span class="o">-</span> <span class="n">i</span><span class="p">];</span> <span class="cm">/* mic_iv[8:13] = PN[5:0] */</span>
	<span class="n">mic_iv</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">payload_length</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">mic_iv</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">payload_length</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************/</span>
<span class="cm">/* construct_mic_header1()                      */</span>
<span class="cm">/* Builds the first MIC header block from       */</span>
<span class="cm">/* header fields.                               */</span>
<span class="cm">/************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">construct_mic_header1</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">mic_header1</span><span class="p">,</span> <span class="n">sint</span> <span class="n">header_length</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mpdu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">header_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">header_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xcf</span><span class="p">;</span>    <span class="cm">/* Mute CF poll &amp; CF ack bits */</span>
	<span class="cm">/* Mute retry, more data and pwr mgt bits */</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc7</span><span class="p">;</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>       <span class="cm">/* A1 */</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>     <span class="cm">/* A2 */</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="n">mic_header1</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/************************************************/</span>
<span class="cm">/* construct_mic_header2()                      */</span>
<span class="cm">/* Builds the last MIC header block from        */</span>
<span class="cm">/* header fields.                               */</span>
<span class="cm">/************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">construct_mic_header2</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">mic_header2</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mpdu</span><span class="p">,</span> <span class="n">sint</span> <span class="n">a4_exists</span><span class="p">,</span>
			   <span class="n">sint</span> <span class="n">qc_exists</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mic_header2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>    <span class="cm">/* A3 */</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">mic_header2</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* mpdu[23]; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qc_exists</span> <span class="o">&amp;&amp;</span> <span class="n">a4_exists</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mic_header2</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">24</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>   <span class="cm">/* A4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc_exists</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a4_exists</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mic_header2</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span> <span class="cm">/* mute bits 15 - 4 */</span>
		<span class="n">mic_header2</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc_exists</span> <span class="o">&amp;&amp;</span> <span class="n">a4_exists</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mic_header2</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">24</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>   <span class="cm">/* A4 */</span>
		<span class="n">mic_header2</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">mic_header2</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************************************/</span>
<span class="cm">/* construct_mic_header2()                      */</span>
<span class="cm">/* Builds the last MIC header block from        */</span>
<span class="cm">/* header fields.                               */</span>
<span class="cm">/************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">construct_ctr_preload</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">sint</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">sint</span> <span class="n">qc_exists</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">mpdu</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pn_vector</span><span class="p">,</span> <span class="n">sint</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctr_preload</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctr_preload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>    <span class="cm">/* flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc_exists</span> <span class="o">&amp;&amp;</span> <span class="n">a4_exists</span><span class="p">)</span>
		<span class="n">ctr_preload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc_exists</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a4_exists</span><span class="p">)</span>
		<span class="n">ctr_preload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctr_preload</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdu</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctr_preload</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn_vector</span><span class="p">[</span><span class="mi">13</span> <span class="o">-</span> <span class="n">i</span><span class="p">];</span>
	<span class="n">ctr_preload</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span> <span class="cm">/* Ctr */</span>
	<span class="n">ctr_preload</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">%</span> <span class="mi">256</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************/</span>
<span class="cm">/* bitwise_xor()                    */</span>
<span class="cm">/* A 128 bit, bitwise exclusive or  */</span>
<span class="cm">/************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bitwise_xor</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">ina</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">inb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sint</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ina</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">inb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sint</span> <span class="nf">aes_cipher</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">uint</span>	<span class="n">hdrlen</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="n">uint</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">qc_exists</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">payload_remainder</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">payload_index</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">pn_vector</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic_iv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic_header1</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic_header2</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ctr_preload</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* Intermediate Buffers */</span>
	<span class="n">u8</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">aes_out</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">padded_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">uint</span>	<span class="n">frtype</span>  <span class="o">=</span> <span class="n">GetFrameType</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>
	<span class="n">uint</span>	<span class="n">frsubtype</span>  <span class="o">=</span> <span class="n">GetFrameSubType</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>

	<span class="n">frsubtype</span> <span class="o">=</span> <span class="n">frsubtype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mic_iv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mic_header1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mic_header2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chain_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">aes_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">padded_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hdrlen</span> <span class="o">==</span> <span class="n">WLAN_HDR_A3_LEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">==</span>  <span class="n">WLAN_HDR_A3_QOS_LEN</span><span class="p">))</span>
		<span class="n">a4_exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">a4_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">frtype</span> <span class="o">==</span> <span class="n">WIFI_DATA_CFACK</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">frtype</span> <span class="o">==</span> <span class="n">WIFI_DATA_CFPOLL</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">frtype</span> <span class="o">==</span> <span class="n">WIFI_DATA_CFACKPOLL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qc_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span>  <span class="n">WLAN_HDR_A3_QOS_LEN</span><span class="p">)</span>
				<span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x0b</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span>  <span class="n">WLAN_HDR_A3_QOS_LEN</span><span class="p">)</span>
				<span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">qc_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qc_exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">construct_mic_iv</span><span class="p">(</span><span class="n">mic_iv</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">pframe</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">);</span>
	<span class="n">construct_mic_header1</span><span class="p">(</span><span class="n">mic_header1</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">pframe</span><span class="p">);</span>
	<span class="n">construct_mic_header2</span><span class="p">(</span><span class="n">mic_header2</span><span class="p">,</span> <span class="n">pframe</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">);</span>
	<span class="n">payload_remainder</span> <span class="o">=</span> <span class="n">plen</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">num_blocks</span> <span class="o">=</span> <span class="n">plen</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/* Find start of payload */</span>
	<span class="n">payload_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* Calculate MIC */</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mic_iv</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">mic_header1</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">mic_header2</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="p">],</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="n">payload_index</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Add on the final payload block if it needs padding */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload_remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">];</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">padded_buffer</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mic</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aes_out</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="cm">/* Insert MIC into payload */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mic</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="n">payload_index</span> <span class="o">=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span>
				      <span class="n">pframe</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="p">],</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload_remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* If short final block, then pad it,*/</span>
				      <span class="cm">/* encrypt and copy unpadded part back */</span>
		<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span>
				      <span class="n">pframe</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">,</span> <span class="n">num_blocks</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">padded_buffer</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/* Encrypt the MIC */</span>
	<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span>
			      <span class="n">pframe</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="n">plen</span><span class="p">];</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">padded_buffer</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">r8712_aes_encrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pxmitframe</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* exclude ICV */</span>
	<span class="cm">/* Intermediate Buffers */</span>
	<span class="n">sint</span>	<span class="n">curfragnum</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">prwskeylen</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="o">*</span><span class="n">prwskey</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">sta_info</span> <span class="o">*</span><span class="n">stainfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">pkt_attrib</span>  <span class="o">*</span><span class="n">pattrib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span>
				       <span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">attrib</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">xmit_priv</span> <span class="o">*</span><span class="n">pxmitpriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">res</span> <span class="o">=</span> <span class="n">_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="n">pframe</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">xmit_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">pxmitframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf_addr</span> <span class="o">+</span> <span class="n">TXDESC_OFFSET</span><span class="p">;</span>
	<span class="cm">/* 4 start to encrypt each fragment */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span> <span class="n">_AES_</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">psta</span><span class="p">)</span>
			<span class="n">stainfo</span> <span class="o">=</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">psta</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">stainfo</span> <span class="o">=</span> <span class="n">r8712_get_stainfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stainfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prwskey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stainfo</span><span class="o">-&gt;</span><span class="n">x_UncstKey</span><span class="p">.</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">prwskeylen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">curfragnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">curfragnum</span> <span class="o">&lt;</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
			     <span class="n">curfragnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">curfragnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>\
					<span class="n">length</span> <span class="o">=</span> <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">last_txcmdsz</span> <span class="o">-</span>
						 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span> <span class="o">-</span>
						 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span> <span class="o">-</span>
						 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>
					<span class="n">aes_cipher</span><span class="p">(</span><span class="n">prwskey</span><span class="p">,</span> <span class="n">pattrib</span><span class="o">-&gt;</span>
						  <span class="n">hdrlen</span><span class="p">,</span> <span class="n">pframe</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">length</span> <span class="o">=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">-</span>
						 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span> <span class="o">-</span>
						 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span> <span class="o">-</span>
						 <span class="n">pattrib</span><span class="o">-&gt;</span><span class="n">icv_len</span> <span class="p">;</span>
					<span class="n">aes_cipher</span><span class="p">(</span><span class="n">prwskey</span><span class="p">,</span> <span class="n">pattrib</span><span class="o">-&gt;</span>
						   <span class="n">hdrlen</span><span class="p">,</span> <span class="n">pframe</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
					<span class="n">pframe</span> <span class="o">+=</span> <span class="n">pxmitpriv</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">;</span>
					<span class="n">pframe</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">RND4</span><span class="p">((</span><span class="n">addr_t</span><span class="p">)(</span><span class="n">pframe</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">sint</span> <span class="nf">aes_decipher</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">uint</span>	<span class="n">hdrlen</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="n">uint</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">message</span><span class="p">[</span><span class="n">MAX_MSG_SIZE</span><span class="p">];</span>
	<span class="n">uint</span> <span class="n">qc_exists</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">payload_remainder</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">payload_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pn_vector</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic_iv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic_header1</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic_header2</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ctr_preload</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="cm">/* Intermediate Buffers */</span>
	<span class="n">u8</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">aes_out</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">padded_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mic</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">uint</span> <span class="n">frtype</span>  <span class="o">=</span> <span class="n">GetFrameType</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>
	<span class="n">uint</span> <span class="n">frsubtype</span>  <span class="o">=</span> <span class="n">GetFrameSubType</span><span class="p">(</span><span class="n">pframe</span><span class="p">);</span>

	<span class="n">frsubtype</span> <span class="o">=</span> <span class="n">frsubtype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mic_iv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mic_header1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mic_header2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chain_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">aes_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">padded_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="cm">/* start to decrypt the payload */</span>
	<span class="cm">/*(plen including llc, payload and mic) */</span>
	<span class="n">num_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">plen</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">payload_remainder</span> <span class="o">=</span> <span class="p">(</span><span class="n">plen</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdrlen</span> <span class="o">==</span> <span class="n">WLAN_HDR_A3_LEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">==</span>  <span class="n">WLAN_HDR_A3_QOS_LEN</span><span class="p">))</span>
		<span class="n">a4_exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">a4_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">frtype</span> <span class="o">==</span> <span class="n">WIFI_DATA_CFACK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">frtype</span> <span class="o">==</span> <span class="n">WIFI_DATA_CFPOLL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">frtype</span> <span class="o">==</span> <span class="n">WIFI_DATA_CFACKPOLL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qc_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span>  <span class="n">WLAN_HDR_A3_QOS_LEN</span><span class="p">)</span>
			<span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">frsubtype</span> <span class="o">==</span> <span class="mh">0x0b</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span>  <span class="n">WLAN_HDR_A3_QOS_LEN</span><span class="p">)</span>
				<span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">qc_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qc_exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* now, decrypt pframe with hdrlen offset and plen long */</span>
	<span class="n">payload_index</span> <span class="o">=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 8 is for extiv */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span>
				      <span class="n">pframe</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="p">],</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload_remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* If short final block, pad it,*/</span>
		<span class="cm">/* encrypt it and copy the unpadded part back   */</span>
		<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span>
				      <span class="n">pframe</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">,</span> <span class="n">num_blocks</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">padded_buffer</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pframe</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/* start to calculate the mic */</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">message</span><span class="p">,</span> <span class="n">pframe</span><span class="p">,</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="n">plen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">pn_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pframe</span><span class="p">[</span><span class="n">hdrlen</span><span class="o">+</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">construct_mic_iv</span><span class="p">(</span><span class="n">mic_iv</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">plen</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span>
			 <span class="n">pn_vector</span><span class="p">);</span>
	<span class="n">construct_mic_header1</span><span class="p">(</span><span class="n">mic_header1</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
	<span class="n">construct_mic_header2</span><span class="p">(</span><span class="n">mic_header2</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">);</span>
	<span class="n">payload_remainder</span> <span class="o">=</span> <span class="p">(</span><span class="n">plen</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">num_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">plen</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/* Find start of payload */</span>
	<span class="n">payload_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* Calculate MIC */</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mic_iv</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">mic_header1</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">mic_header2</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">payload_index</span><span class="p">],</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="n">payload_index</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Add on the final payload block if it needs padding */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload_remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">];</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">padded_buffer</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mic</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aes_out</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="cm">/* Insert MIC into payload */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">message</span><span class="p">[</span><span class="n">payload_index</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mic</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="n">payload_index</span> <span class="o">=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span>
				      <span class="n">message</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="n">payload_index</span><span class="p">],</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">message</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload_remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* If short final block, pad it,*/</span>
				     <span class="cm">/* encrypt and copy unpadded part back */</span>
		<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span>
				      <span class="n">message</span><span class="p">,</span> <span class="n">pn_vector</span><span class="p">,</span> <span class="n">num_blocks</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="n">payload_index</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
		<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
		<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">padded_buffer</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">payload_remainder</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">message</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/* Encrypt the MIC */</span>
	<span class="n">construct_ctr_preload</span><span class="p">(</span><span class="n">ctr_preload</span><span class="p">,</span> <span class="n">a4_exists</span><span class="p">,</span> <span class="n">qc_exists</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span>
			      <span class="n">pn_vector</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">padded_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">plen</span><span class="p">];</span>
	<span class="n">aes128k128d</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctr_preload</span><span class="p">,</span> <span class="n">aes_out</span><span class="p">);</span>
	<span class="n">bitwise_xor</span><span class="p">(</span><span class="n">aes_out</span><span class="p">,</span> <span class="n">padded_buffer</span><span class="p">,</span> <span class="n">chain_buffer</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">message</span><span class="p">[</span><span class="n">payload_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="cm">/* compare the mic */</span>
	<span class="k">return</span> <span class="n">_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">r8712_aes_decrypt</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">precvframe</span><span class="p">)</span>
<span class="p">{</span>	<span class="cm">/* exclude ICV */</span>
	<span class="cm">/* Intermediate Buffers */</span>
	<span class="n">sint</span>		<span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">prwskeylen</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">pframe</span><span class="p">,</span> <span class="o">*</span><span class="n">prwskey</span><span class="p">,</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">sta_info</span> <span class="o">*</span><span class="n">stainfo</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">rx_pkt_attrib</span> <span class="o">*</span><span class="n">prxattrib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span>
					   <span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">attrib</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">security_priv</span> <span class="o">*</span><span class="n">psecuritypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">;</span>

	<span class="n">pframe</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)((</span><span class="k">union</span> <span class="n">recv_frame</span><span class="o">*</span><span class="p">)</span><span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span>
		 <span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rx_data</span><span class="p">;</span>
	<span class="cm">/* 4 start to encrypt each fragment */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">encrypt</span> <span class="o">==</span> <span class="n">_AES_</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stainfo</span> <span class="o">=</span> <span class="n">r8712_get_stainfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stainfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_MCAST</span><span class="p">(</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">ra</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">iv</span> <span class="o">=</span> <span class="n">pframe</span><span class="o">+</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">;</span>
				<span class="n">idx</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="n">prwskey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">XGrpKey</span><span class="p">[</span>
					  <span class="p">((</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">binstallGrpkey</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span>
				<span class="n">prwskey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stainfo</span><span class="o">-&gt;</span><span class="n">x_UncstKey</span><span class="p">.</span><span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">prwskeylen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">=</span> <span class="p">((</span><span class="k">union</span> <span class="n">recv_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">precvframe</span><span class="p">)</span><span class="o">-&gt;</span>
				 <span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="o">-</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="o">-</span><span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">iv_len</span><span class="p">;</span>
			<span class="n">aes_decipher</span><span class="p">(</span><span class="n">prwskey</span><span class="p">,</span> <span class="n">prxattrib</span><span class="o">-&gt;</span><span class="n">hdrlen</span><span class="p">,</span> <span class="n">pframe</span><span class="p">,</span>
				     <span class="n">length</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">_FAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_use_tkipkey_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">FunctionContext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">FunctionContext</span><span class="p">;</span>

	<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">busetkipkey</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
