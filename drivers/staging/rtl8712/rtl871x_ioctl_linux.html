<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8712 › rtl871x_ioctl_linux.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rtl871x_ioctl_linux.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * rtl871x_ioctl_linux.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2007 - 2010 Realtek Corporation. All rights reserved.</span>
<span class="cm"> * Linux device driver for RTL8192SU</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * Modifications for inclusion into the Linux staging tree are</span>
<span class="cm"> * Copyright(c) 2010 Larry Finger. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact information:</span>
<span class="cm"> * WLAN FAE &lt;wlanfae@realtek.com&gt;</span>
<span class="cm"> * Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#define _RTL871X_IOCTL_LINUX_C_</span>
<span class="cp">#define _RTL871X_MP_IOCTL_C_</span>

<span class="cp">#include &quot;osdep_service.h&quot;</span>
<span class="cp">#include &quot;drv_types.h&quot;</span>
<span class="cp">#include &quot;wlan_bssdef.h&quot;</span>
<span class="cp">#include &quot;rtl871x_debug.h&quot;</span>
<span class="cp">#include &quot;wifi.h&quot;</span>
<span class="cp">#include &quot;rtl871x_mlme.h&quot;</span>
<span class="cp">#include &quot;rtl871x_ioctl.h&quot;</span>
<span class="cp">#include &quot;rtl871x_ioctl_set.h&quot;</span>
<span class="cp">#include &quot;rtl871x_mp_ioctl.h&quot;</span>
<span class="cp">#include &quot;mlme_osdep.h&quot;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>

<span class="cp">#define RTL_IOCTL_WPA_SUPPLICANT	(SIOCIWFIRSTPRIV + 0x1E)</span>

<span class="cp">#define SCAN_ITEM_SIZE 768</span>
<span class="cp">#define MAX_CUSTOM_LEN 64</span>
<span class="cp">#define RATE_COUNT 4</span>


<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">rtl8180_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">,</span> <span class="mi">5500000</span><span class="p">,</span> <span class="mi">11000000</span><span class="p">,</span>
		       <span class="mi">6000000</span><span class="p">,</span> <span class="mi">9000000</span><span class="p">,</span> <span class="mi">12000000</span><span class="p">,</span> <span class="mi">18000000</span><span class="p">,</span>
		       <span class="mi">24000000</span><span class="p">,</span> <span class="mi">36000000</span><span class="p">,</span> <span class="mi">48000000</span><span class="p">,</span> <span class="mi">54000000</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">ieee80211_wlan_frequencies</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2412</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span>
	<span class="mi">2432</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span>
	<span class="mi">2452</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span>
	<span class="mi">2472</span><span class="p">,</span> <span class="mi">2484</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">iw_operation_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Auto&quot;</span><span class="p">,</span> <span class="s">&quot;Ad-Hoc&quot;</span><span class="p">,</span> <span class="s">&quot;Managed&quot;</span><span class="p">,</span>  <span class="s">&quot;Master&quot;</span><span class="p">,</span> <span class="s">&quot;Repeater&quot;</span><span class="p">,</span> <span class="s">&quot;Secondary&quot;</span><span class="p">,</span>
	 <span class="s">&quot;Monitor&quot;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * hwaddr_aton - Convert ASCII string to MAC address</span>
<span class="cm"> * @txt: MAC address as a string (e.g., &quot;00:11:22:33:44:55&quot;)</span>
<span class="cm"> * @addr: Buffer for the MAC address (ETH_ALEN = 6 bytes)</span>
<span class="cm"> * Returns: 0 on success, -1 on failure (e.g., string not a MAC address)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwaddr_aton_i</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">txt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

		<span class="n">a</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="o">*</span><span class="n">txt</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="o">*</span><span class="n">txt</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">addr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">txt</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_indicate_wx_assoc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">cur_network</span><span class="p">.</span><span class="n">network</span><span class="p">.</span><span class="n">MacAddress</span><span class="p">,</span>
		<span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pnetdev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r8712_indicate_wx_disassoc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pnetdev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">handle_pairwise_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">psta</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pairwise key */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">psta</span><span class="o">-&gt;</span><span class="n">x_UncstKey</span><span class="p">.</span><span class="n">skey</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span> <span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* set mic key */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">psta</span><span class="o">-&gt;</span><span class="n">tkiptxmickey</span><span class="p">.</span> <span class="n">skey</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span>
			<span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">psta</span><span class="o">-&gt;</span><span class="n">tkiprxmickey</span><span class="p">.</span> <span class="n">skey</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span>
			<span class="n">key</span><span class="p">[</span><span class="mi">24</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span> <span class="n">busetkipkey</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">_set_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">tkip_timer</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r8712_setstakey_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psta</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">handle_group_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* group key idx is 1 or 2 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpKey</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span>
			<span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">skey</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span>
			<span class="o">&gt;</span> <span class="mi">16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrptxmickey</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">skey</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span> <span class="n">XGrprxmickey</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span>
			<span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">skey</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">24</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">binstallGrpkey</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">r8712_set_key</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">,</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">.</span><span class="n">power_mgnt</span> <span class="o">&gt;</span> <span class="n">PS_MODE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">.</span><span class="n">power_mgnt</span> <span class="o">!=</span> <span class="n">padapter</span><span class="o">-&gt;</span>
			    <span class="n">pwrctrlpriv</span><span class="p">.</span><span class="n">pwr_mode</span><span class="p">)</span>
				<span class="n">_set_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span><span class="n">dhcp_timer</span><span class="p">),</span>
					   <span class="mi">60000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">translate_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">wlan_network</span> <span class="o">*</span><span class="n">pnetwork</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_event</span> <span class="n">iwe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="n">pht_capie</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_val</span><span class="p">;</span>
	<span class="n">s8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ht_ielen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">cap</span><span class="p">,</span> <span class="n">ht_cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">mcs_rate</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rssi</span><span class="p">,</span> <span class="n">bw_40MHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">short_GI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* AP MAC address */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">MacAddress</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>
	<span class="cm">/* Add the ESSID */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">min</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Ssid</span><span class="p">.</span><span class="n">SsidLength</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
				     <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">);</span>
	<span class="cm">/* parsing HT_CAP_IE */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">r8712_get_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IEs</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">_HT_CAPABILITY_IE_</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">ht_ielen</span><span class="p">,</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IELength</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">ht_ielen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ht_cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pht_capie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcs_rate</span> <span class="p">,</span> <span class="n">pht_capie</span><span class="o">-&gt;</span><span class="n">supp_mcs_set</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">bw_40MHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">pht_capie</span><span class="o">-&gt;</span><span class="n">cap_info</span><span class="o">&amp;</span><span class="n">IEEE80211_HT_CAP_SUP_WIDTH</span><span class="p">)</span>
			   <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">short_GI</span> <span class="o">=</span> <span class="p">(</span><span class="n">pht_capie</span><span class="o">-&gt;</span><span class="n">cap_info</span><span class="o">&amp;</span><span class="p">(</span><span class="n">IEEE80211_HT_CAP_SGI_20</span> <span class="o">|</span>
			    <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Add the protocol name */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWNAME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r8712_is_cckratesonly_included</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span>
	     <span class="n">SupportedRates</span><span class="p">))</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11bn&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11b&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">r8712_is_cckrates_included</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span>
		    <span class="n">SupportedRates</span><span class="p">))</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11bgn&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11bg&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11gn&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11g&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_CHAR_LEN</span><span class="p">);</span>
	<span class="cm">/* Add mode */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cap</span><span class="p">,</span> <span class="n">r8712_get_capability_from_ie</span><span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IEs</span><span class="p">),</span>
		<span class="mi">2</span><span class="p">);</span>
	<span class="n">cap</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WLAN_CAPABILITY_IBSS</span><span class="o">|</span><span class="n">WLAN_CAPABILITY_BSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_BSS</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">IW_MODE_MASTER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
			<span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Add frequency/channel */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
	<span class="p">{</span>
		<span class="cm">/*  check legal index */</span>
		<span class="n">u8</span> <span class="n">dsconfig</span> <span class="o">=</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsconfig</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dsconfig</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span>
		    <span class="n">ieee80211_wlan_frequencies</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">ieee80211_wlan_frequencies</span><span class="p">[</span>
				       <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span>
				       <span class="n">DSConfig</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
		<span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>
	<span class="cm">/* Add encryption capability */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span>
				    <span class="n">IW_ENCODE_NOKEY</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">IW_ENCODE_DISABLED</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
		<span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">);</span>
	<span class="cm">/*Add basic and extended rates */</span>
	<span class="n">current_val</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWRATE</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">SupportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bit rate given in 500 kb/s units */</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">SupportedRates</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">&amp;</span>
				      <span class="mh">0x7F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
		<span class="n">current_val</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">current_val</span><span class="p">,</span>
			      <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Check if we added any event */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">current_val</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">current_val</span><span class="p">;</span>
	<span class="cm">/* parsing WPA/WPA2 IE */</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_WPA_IE_LEN</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">wpa_ie</span><span class="p">[</span><span class="mi">255</span><span class="p">],</span> <span class="n">rsn_ie</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
		<span class="n">u16</span> <span class="n">wpa_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsn_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">sint</span> <span class="n">out_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">out_len</span> <span class="o">=</span> <span class="n">r8712_get_sec_ie</span><span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IEs</span><span class="p">,</span>
					   <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span>
					   <span class="n">IELength</span><span class="p">,</span> <span class="n">rsn_ie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsn_len</span><span class="p">,</span>
					   <span class="n">wpa_ie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wpa_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wpa_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;wpa_ie=&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wpa_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">n</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">MAX_WPA_IE_LEN</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span>
							<span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">wpa_len</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsn_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rsn_ie=&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rsn_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">n</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">MAX_WPA_IE_LEN</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span>
							<span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">rsn_ie</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">rsn_len</span><span class="p">;</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
				<span class="n">rsn_ie</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="p">{</span> <span class="cm">/* parsing WPS IE */</span>
		<span class="n">u8</span> <span class="n">wps_ie</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
		<span class="n">uint</span> <span class="n">wps_ielen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r8712_get_wps_ie</span><span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IEs</span><span class="p">,</span>
		    <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IELength</span><span class="p">,</span>
		    <span class="n">wps_ie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wps_ielen</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wps_ielen</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">wps_ielen</span><span class="p">;</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">wps_ie</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Add quality statistics */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
	<span class="n">rssi</span> <span class="o">=</span> <span class="n">r8712_signal_scale_mapping</span><span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Rssi</span><span class="p">);</span>
	<span class="cm">/* we only update signal_level (signal strength) that is rssi. */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">IW_QUAL_QUAL_INVALID</span> <span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span> <span class="o">|</span>
				  <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>  <span class="cm">/* signal strength */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* signal quality */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* noise level */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span>
	<span class="cm">/* how to translate rssi to ?% */</span>
	<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wpa_set_auth_algs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_OPEN_SYSTEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
						 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span>
						 <span class="n">Ndis802_11AuthModeAutoSwitch</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
						 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span> <span class="n">Ndis802_11AuthModeShared</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">&lt;</span>
						 <span class="n">Ndis802_11AuthModeWPAPSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span>
						 <span class="n">Ndis802_11AuthModeOpen</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wpa_set_encryption</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wep_key_idx</span><span class="p">,</span> <span class="n">wep_key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span>	 <span class="o">*</span><span class="n">pwep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">security_priv</span> <span class="o">*</span><span class="n">psecuritypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">[</span><span class="n">IEEE_CRYPT_ALG_NAME_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param_len</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">)</span> <span class="o">+</span>
			 <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* for large key indices, set the default (0) */</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: wpa_set_encryption, crypt.alg =&quot;</span>
		       <span class="s">&quot; WEP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
			     <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_WEP40_</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_WEP40_</span><span class="p">;</span>
		<span class="n">wep_key_idx</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">wep_key_len</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wep_key_idx</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
			<span class="n">wep_key_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wep_key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wep_key_len</span> <span class="o">=</span> <span class="n">wep_key_len</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>
			<span class="n">pwep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span> <span class="o">*</span><span class="p">)</span><span class="n">_malloc</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span>
			       <span class="p">(</span><span class="n">wep_key_len</span> <span class="o">+</span>
			       <span class="n">FIELD_OFFSET</span><span class="p">(</span><span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span><span class="p">,</span>
			       <span class="n">KeyMaterial</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pwep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">pwep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span><span class="p">));</span>
			<span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyLength</span> <span class="o">=</span> <span class="n">wep_key_len</span><span class="p">;</span>
			<span class="n">pwep</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">wep_key_len</span> <span class="o">+</span>
				 <span class="n">FIELD_OFFSET</span><span class="p">(</span><span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span><span class="p">,</span>
				 <span class="n">KeyMaterial</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wep_key_len</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span>
					 <span class="n">_WEP104_</span><span class="p">;</span>
				<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span>
					 <span class="n">_WEP104_</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyIndex</span> <span class="o">=</span> <span class="n">wep_key_idx</span><span class="p">;</span>
		<span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyIndex</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyMaterial</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyLength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r8712_set_802_11_add_wep</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">pwep</span><span class="p">)</span> <span class="o">==</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">_FAIL</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* don&#39;t update &quot;psecuritypriv-&gt;PrivacyAlgrthm&quot; and</span>
<span class="cm">			 * &quot;psecuritypriv-&gt;PrivacyKeyIndex=keyid&quot;, but can</span>
<span class="cm">			 * r8712_set_key to fw/cam</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wep_key_idx</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">DefKey</span><span class="p">[</span><span class="n">wep_key_idx</span><span class="p">].</span>
				<span class="n">skey</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyMaterial</span><span class="p">,</span>
				<span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyLength</span><span class="p">);</span>
			<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">DefKeylen</span><span class="p">[</span><span class="n">wep_key_idx</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">pwep</span><span class="o">-&gt;</span><span class="n">KeyLength</span><span class="p">;</span>
			<span class="n">r8712_set_key</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">psecuritypriv</span><span class="p">,</span> <span class="n">wep_key_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 802_1x */</span>
		<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">psta</span><span class="p">,</span> <span class="o">*</span><span class="n">pbcmc_sta</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sta_priv</span> <span class="o">*</span><span class="n">pstapriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">stapriv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">WIFI_STATION_STATE</span> <span class="o">|</span>
		    <span class="n">WIFI_MP_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* sta mode */</span>
			<span class="n">psta</span> <span class="o">=</span> <span class="n">r8712_get_stainfo</span><span class="p">(</span><span class="n">pstapriv</span><span class="p">,</span>
						 <span class="n">get_bssid</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">psta</span><span class="o">-&gt;</span><span class="n">ieee8021x_blocked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">==</span>
				    <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">==</span>
				    <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">))</span>
					<span class="n">psta</span><span class="o">-&gt;</span><span class="n">XPrivacy</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span>
					    <span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">handle_pairwise_key</span><span class="p">(</span><span class="n">psta</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span>
							    <span class="n">padapter</span><span class="p">);</span>
				<span class="k">else</span> <span class="cm">/* group key */</span>
					<span class="n">handle_group_key</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">padapter</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pbcmc_sta</span> <span class="o">=</span> <span class="n">r8712_get_bcmc_stainfo</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pbcmc_sta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pbcmc_sta</span><span class="o">-&gt;</span><span class="n">ieee8021x_blocked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">==</span>
				    <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">==</span>
				    <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">))</span>
					<span class="n">pbcmc_sta</span><span class="o">-&gt;</span><span class="n">XPrivacy</span> <span class="o">=</span>
					  <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span>
					  <span class="n">PrivacyAlgrthm</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pwep</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_set_wpa_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pie</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ielen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">group_cipher</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pairwise_cipher</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ielen</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ielen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">_malloc</span><span class="p">(</span><span class="n">ielen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pie</span> <span class="p">,</span> <span class="n">ielen</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ielen</span> <span class="o">&lt;</span> <span class="n">RSN_HEADER_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8712_parse_wpa_ie</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ielen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group_cipher</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">pairwise_cipher</span><span class="p">)</span> <span class="o">==</span> <span class="n">_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span>
				  <span class="n">Ndis802_11AuthModeWPAPSK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8712_parse_wpa2_ie</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ielen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group_cipher</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">pairwise_cipher</span><span class="p">)</span> <span class="o">==</span> <span class="n">_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span>
				  <span class="n">Ndis802_11AuthModeWPA2PSK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">group_cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_NONE</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span>
				 <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_WEP40</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_WEP40_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_TKIP</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_TKIP_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_CCMP</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_AES_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_WEP104</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_WEP104_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pairwise_cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_NONE</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span>
				 <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_WEP40</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_WEP40_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_TKIP</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_TKIP_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption2Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_CCMP</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_AES_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption3Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WPA_CIPHER_WEP104</span>:
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_WEP104_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">wps_phase</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">{</span><span class="cm">/* set wps_ie */</span>
			<span class="n">u16</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">eid</span><span class="p">,</span> <span class="n">wps_oui</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">};</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ielen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">eid</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">eid</span> <span class="o">==</span> <span class="n">_VENDOR_SPECIFIC_IE_</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">wps_oui</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: &quot;</span>
					       <span class="s">&quot;SET WPS_IE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">wps_ie_len</span> <span class="o">=</span>
					    <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span>
					    <span class="p">(</span><span class="n">MAX_WPA_IE_LEN</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">?</span>
					    <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span>
					    <span class="p">(</span><span class="n">MAX_WPA_IE_LEN</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">wps_ie</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span>
					    <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">wps_ie_len</span><span class="p">);</span>
					<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">wps_phase</span> <span class="o">=</span>
								 <span class="nb">true</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: SET WPS_IE,&quot;</span>
					    <span class="s">&quot; wps_phase==true</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">cnt</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">cnt</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ht_ielen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ht_cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">mlme_priv</span>	<span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ndis_wlan_bssid_ex</span>  <span class="o">*</span><span class="n">pcur_bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">cur_network</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>
	<span class="n">NDIS_802_11_RATES_EX</span> <span class="o">*</span><span class="n">prates</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span><span class="o">|</span><span class="n">WIFI_ADHOC_MASTER_STATE</span><span class="p">)</span> <span class="o">==</span>
	    <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* parsing HT_CAP_IE */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">r8712_get_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">IEs</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">_HT_CAPABILITY_IE_</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ht_ielen</span><span class="p">,</span> <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">IELength</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">ht_ielen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ht_cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">prates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">SupportedRates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8712_is_cckratesonly_included</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">prates</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span>
					 <span class="s">&quot;IEEE 802.11bn&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span>
					 <span class="s">&quot;IEEE 802.11b&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">r8712_is_cckrates_included</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">prates</span><span class="p">))</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span>
					 <span class="s">&quot;IEEE 802.11bgn&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span>
					 <span class="s">&quot;IEEE 802.11bg&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span>
					 <span class="s">&quot;IEEE 802.11gn&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span>
					 <span class="s">&quot;IEEE 802.11g&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;unassociated&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">long</span> <span class="n">frequency_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2412</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span>
	<span class="mi">2467</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">2484</span><span class="p">,</span> <span class="mi">4915</span><span class="p">,</span> <span class="mi">4920</span><span class="p">,</span> <span class="mi">4925</span><span class="p">,</span> <span class="mi">4935</span><span class="p">,</span> <span class="mi">4940</span><span class="p">,</span> <span class="mi">4945</span><span class="p">,</span> <span class="mi">4960</span><span class="p">,</span> <span class="mi">4980</span><span class="p">,</span>
	<span class="mi">5035</span><span class="p">,</span> <span class="mi">5040</span><span class="p">,</span> <span class="mi">5045</span><span class="p">,</span> <span class="mi">5055</span><span class="p">,</span> <span class="mi">5060</span><span class="p">,</span> <span class="mi">5080</span><span class="p">,</span> <span class="mi">5170</span><span class="p">,</span> <span class="mi">5180</span><span class="p">,</span> <span class="mi">5190</span><span class="p">,</span> <span class="mi">5200</span><span class="p">,</span> <span class="mi">5210</span><span class="p">,</span>
	<span class="mi">5220</span><span class="p">,</span> <span class="mi">5230</span><span class="p">,</span> <span class="mi">5240</span><span class="p">,</span> <span class="mi">5260</span><span class="p">,</span> <span class="mi">5280</span><span class="p">,</span> <span class="mi">5300</span><span class="p">,</span> <span class="mi">5320</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5520</span><span class="p">,</span> <span class="mi">5540</span><span class="p">,</span> <span class="mi">5560</span><span class="p">,</span>
	<span class="mi">5580</span><span class="p">,</span> <span class="mi">5600</span><span class="p">,</span> <span class="mi">5620</span><span class="p">,</span> <span class="mi">5640</span><span class="p">,</span> <span class="mi">5660</span><span class="p">,</span> <span class="mi">5680</span><span class="p">,</span> <span class="mi">5700</span><span class="p">,</span> <span class="mi">5745</span><span class="p">,</span> <span class="mi">5765</span><span class="p">,</span> <span class="mi">5785</span><span class="p">,</span> <span class="mi">5805</span><span class="p">,</span>
	<span class="mi">5825</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* If setting by frequency, convert to a channel */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="mf">2.412e8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="mf">2.487e8</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">frequency_list</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
			<span class="n">c</span><span class="o">++</span><span class="p">;</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Setting by channel number */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Yes ! We can set it !!! */</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_wlan_bssid_ex</span> <span class="o">*</span><span class="n">pcur_bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">cur_network</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_wlan_frequencies</span><span class="p">[</span>
			       <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">Configuration</span><span class="p">.</span><span class="n">DSConfig</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">NDIS_802_11_NETWORK_INFRASTRUCTURE</span> <span class="n">networkType</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_AUTO</span>:
		<span class="n">networkType</span> <span class="o">=</span> <span class="n">Ndis802_11AutoUnknown</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">networkType</span> <span class="o">=</span> <span class="n">Ndis802_11IBSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_MASTER</span>:
		<span class="n">networkType</span> <span class="o">=</span> <span class="n">Ndis802_11APMode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">networkType</span> <span class="o">=</span> <span class="n">Ndis802_11Infrastructure</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Ndis802_11APMode</span> <span class="o">==</span> <span class="n">networkType</span><span class="p">)</span>
		<span class="n">r8712_setopmode_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">networkType</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r8712_setopmode_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">Ndis802_11AutoUnknown</span><span class="p">);</span>

	<span class="n">r8712_set_802_11_infrastructure_mode</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">networkType</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">WIFI_STATION_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span>
		 <span class="n">WIFI_ADHOC_MASTER_STATE</span><span class="o">|</span><span class="n">WIFI_ADHOC_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">WIFI_AP_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_AUTO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wx_set_pmkid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">security_priv</span> <span class="o">*</span><span class="n">psecuritypriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_pmksa</span> <span class="o">*</span><span class="n">pPMK</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_pmksa</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">strZeroMacAddress</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">strIssueBssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">j</span><span class="p">,</span> <span class="n">blInserted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intReturn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">	There are the BSSID information in the bssid.sa_data array.</span>
<span class="cm">	If cmd is IW_PMKSA_FLUSH, it means the wpa_supplicant wants to clear</span>
<span class="cm">	all the PMKID information. If cmd is IW_PMKSA_ADD, it means the</span>
<span class="cm">	wpa_supplicant wants to add a PMKID/BSSID to driver.</span>
<span class="cm">	If cmd is IW_PMKSA_REMOVE, it means the wpa_supplicant wants to</span>
<span class="cm">	remove a PMKID/BSSID from driver.</span>
<span class="cm">*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pPMK</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">strIssueBssid</span><span class="p">,</span> <span class="n">pPMK</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pPMK</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_PMKSA_ADD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">strIssueBssid</span><span class="p">,</span> <span class="n">strZeroMacAddress</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">intReturn</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">intReturn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">blInserted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* overwrite PMKID */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_PMKID_CACHE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Bssid</span><span class="p">,</span>
			    <span class="n">strIssueBssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* BSSID is matched, the same AP =&gt; rewrite</span>
<span class="cm">				 * with new PMKID. */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r871x_wx_set_pmkid:&quot;</span>
				    <span class="s">&quot; BSSID exists in the PMKList.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span>
					<span class="n">pPMK</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">IW_PMKID_LEN</span><span class="p">);</span>
				<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bUsed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDIndex</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">blInserted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blInserted</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Find a new entry */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r871x_wx_set_pmkid: Use the&quot;</span>
			    <span class="s">&quot; new entry index = %d for this PMKID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDIndex</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span>
				<span class="n">PMKIDIndex</span><span class="p">].</span><span class="n">Bssid</span><span class="p">,</span> <span class="n">strIssueBssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span>
				<span class="n">PMKIDIndex</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span> <span class="n">pPMK</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">IW_PMKID_LEN</span><span class="p">);</span>
			<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDIndex</span><span class="p">].</span>
				<span class="n">bUsed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDIndex</span><span class="o">++</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDIndex</span> <span class="o">==</span> <span class="n">NUM_PMKID_CACHE</span><span class="p">)</span>
				<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_PMKSA_REMOVE</span>:
		<span class="n">intReturn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_PMKID_CACHE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Bssid</span><span class="p">,</span>
			    <span class="n">strIssueBssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* BSSID is matched, the same AP =&gt; Remove</span>
<span class="cm">				 * this PMKID information and reset it. */</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Bssid</span><span class="p">,</span>
					<span class="mh">0x00</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bUsed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_PMKSA_FLUSH</span>:
		<span class="n">memset</span><span class="p">(</span><span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RT_PMKID_LIST</span><span class="p">)</span> <span class="o">*</span> <span class="n">NUM_PMKID_CACHE</span><span class="p">);</span>
		<span class="n">psecuritypriv</span><span class="o">-&gt;</span><span class="n">PMKIDIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">intReturn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r871x_wx_set_pmkid: &quot;</span>
		       <span class="s">&quot;unknown Command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intReturn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">intReturn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">));</span>
	<span class="cm">/* Let&#39;s try to keep this struct in the same order as in</span>
<span class="cm">	 * linux/include/wireless.h</span>
<span class="cm">	 */</span>

	<span class="cm">/* TODO: See what values we can set, and remove the ones we can&#39;t</span>
<span class="cm">	 * set, or fill them with some default data.</span>
<span class="cm">	 */</span>
	<span class="cm">/* ~5 Mb/s real (802.11b) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="cm">/* TODO: 8711 sensitivity ? */</span>
	<span class="cm">/* signal level threshold range */</span>
	<span class="cm">/* percent values between 0 and 100. */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* Updated all three */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">92</span><span class="p">;</span> <span class="cm">/* &gt; 8% missed beacons is &#39;bad&#39; */</span>
	<span class="cm">/* TODO: Find real &#39;good&#39; to &#39;bad&#39; threshold value for RSSI */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="o">-</span><span class="mi">98</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* Updated all three */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">RATE_COUNT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_BITRATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtl8180_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="n">MIN_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pm_capa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Include only legal frequencies for some countries */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_wlan_frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">val</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IW_MAX_FREQUENCIES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span>
			  <span class="n">IW_ENC_CAPA_WPA2</span> <span class="o">|</span>
			  <span class="n">IW_ENC_CAPA_CIPHER_TKIP</span> <span class="o">|</span>
			  <span class="n">IW_ENC_CAPA_CIPHER_CCMP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">r8711_wx_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wx_set_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="p">)</span><span class="n">awrq</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">ext</span> <span class="o">=</span> <span class="n">_malloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;RSSI&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Return received signal strength indicator in -db for */</span>
		<span class="cm">/* current AP */</span>
		<span class="cm">/*&lt;ssid&gt; Rssi xx */</span>
		<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">wlan_network</span> <span class="o">*</span><span class="n">pcur_network</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">cur_network</span><span class="p">;</span>
		<span class="cm">/*static u8 xxxx; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;%s rssi %d&quot;</span><span class="p">,</span>
				<span class="n">pcur_network</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">,</span>
				<span class="cm">/*(xxxx=xxxx+10) */</span>
				<span class="p">((</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">recvpriv</span><span class="p">.</span><span class="n">fw_rssi</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">95</span>
				<span class="cm">/*pcur_network-&gt;network.Rssi */</span>
				<span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;LINKSPEED&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Return link speed in MBPS */</span>
		<span class="cm">/*LinkSpeed xx */</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqd</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret_inner</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mbps</span><span class="p">;</span>

		<span class="n">ret_inner</span> <span class="o">=</span> <span class="n">r8711_wx_get_rate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqd</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret_inner</span><span class="p">)</span>
			<span class="n">mbps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mbps</span> <span class="o">=</span> <span class="n">wrqd</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;LINKSPEED %d&quot;</span><span class="p">,</span> <span class="n">mbps</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;MACADDR&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Return mac address of the station */</span>
		<span class="cm">/*Macaddr = xx.xx.xx.xx.xx.xx */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span>
			<span class="s">&quot;MACADDR = %02x.%02x.%02x.%02x.%02x.%02x&quot;</span><span class="p">,</span>
			<span class="o">*</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
			<span class="o">*</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
			<span class="o">*</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="o">+</span><span class="mi">5</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;SCAN-ACTIVE&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Set scan type to active */</span>
		<span class="cm">/*OK if successful */</span>
		<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
		<span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">passive_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;SCAN-PASSIVE&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Set scan type to passive */</span>
		<span class="cm">/*OK if successful */</span>
		<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
		<span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">passive_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;DCE-E&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Set scan type to passive */</span>
		<span class="cm">/*OK if successful */</span>
		<span class="n">r8712_disconnectCtrlEx_cmd</span><span class="p">(</span><span class="n">padapter</span>
			<span class="p">,</span> <span class="mi">1</span> <span class="cm">/*u32 enableDrvCtrl */</span>
			<span class="p">,</span> <span class="mi">5</span> <span class="cm">/*u32 tryPktCnt */</span>
			<span class="p">,</span> <span class="mi">100</span> <span class="cm">/*u32 tryPktInterval */</span>
			<span class="p">,</span> <span class="mi">5000</span> <span class="cm">/*u32 firstStageTO */</span>
		<span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;DCE-D&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*Set scan type to passive */</span>
		<span class="cm">/*OK if successfu */</span>
		<span class="n">r8712_disconnectCtrlEx_cmd</span><span class="p">(</span><span class="n">padapter</span>
			<span class="p">,</span> <span class="mi">0</span> <span class="cm">/*u32 enableDrvCtrl */</span>
			<span class="p">,</span> <span class="mi">5</span> <span class="cm">/*u32 tryPktCnt */</span>
			<span class="p">,</span> <span class="mi">100</span> <span class="cm">/*u32 tryPktInterval */</span>
			<span class="p">,</span> <span class="mi">5000</span> <span class="cm">/*u32 firstStageTO */</span>
		<span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r871x_wx_set_priv: unknown Command&quot;</span>
		       <span class="s">&quot; %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">FREE_EXT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span>
				<span class="n">min</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">FREE_EXT:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set bssid flow</span>
<span class="cm"> * s1. set_802_11_infrastructure_mode()</span>
<span class="cm"> * s2. set_802_11_authentication_mode()</span>
<span class="cm"> * s3. set_802_11_encryption_mode()</span>
<span class="cm"> * s4. set_802_11_bssid()</span>
<span class="cm"> *</span>
<span class="cm"> * This function intends to handle the Set AP command, which specifies the</span>
<span class="cm"> * MAC# of a preferred Access Point.</span>
<span class="cm"> * Currently, the request comes via Wireless Extensions&#39; SIOCSIWAP ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * For this operation to succeed, there is no need for the interface to be up.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">__queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">scanned_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">awrq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">phead</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst_bssid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wlan_network</span> <span class="o">*</span><span class="n">pnetwork</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">NDIS_802_11_AUTHENTICATION_MODE</span>	<span class="n">authmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_SURVEY</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_LINKING</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">authmode</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqL</span><span class="p">);</span>
	<span class="n">phead</span> <span class="o">=</span> <span class="n">get_list_head</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">phead</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end_of_queue_search</span><span class="p">(</span><span class="n">phead</span><span class="p">,</span> <span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pnetwork</span> <span class="o">=</span> <span class="n">LIST_CONTAINOR</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">wlan_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span><span class="p">);</span>
		<span class="n">dst_bssid</span> <span class="o">=</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">MacAddress</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dst_bssid</span><span class="p">,</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r8712_set_802_11_infrastructure_mode</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span>
			    <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">InfrastructureMode</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r8712_set_802_11_authentication_mode</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">authmode</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r8712_set_802_11_bssid</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_wlan_bssid_ex</span> <span class="o">*</span><span class="n">pcur_bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">cur_network</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span> <span class="o">|</span>
	    <span class="n">WIFI_ADHOC_MASTER_STATE</span><span class="o">|</span><span class="n">WIFI_AP_STATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">MacAddress</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wx_set_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlme</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MLME_DEAUTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r8712_set_802_11_disassociate</span><span class="p">(</span><span class="n">padapter</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MLME_DISASSOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r8712_set_802_11_disassociate</span><span class="p">(</span><span class="n">padapter</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * This function intends to handle the Set Scan command.</span>
<span class="cm"> * Currently, the request comes via Wireless Extensions&#39; SIOCSIWSCAN ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * For this operation to succeed, the interface is brought Up beforehand.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;r8712u: in r8711_wx_set_scan: &quot;</span>
		    <span class="s">&quot;bDriverStopped=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bup</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">hw_init_completed</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_SURVEY</span><span class="o">|</span><span class="n">_FW_UNDER_LINKING</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">sitesurveyctrl</span><span class="p">.</span><span class="n">traffic_busy</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_SCAN_THIS_ESSID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ndis_802_11_ssid</span> <span class="n">ssid</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqL</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">min</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_802_11_ssid</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ssid</span><span class="p">.</span><span class="n">SsidLength</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_SURVEY</span> <span class="o">|</span>
			     <span class="n">_FW_UNDER_LINKING</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">sitesurveyctrl</span><span class="p">.</span><span class="n">traffic_busy</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_LINKING</span><span class="p">))</span>
					<span class="n">status</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">r8712_sitesurvey_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">r8712_set_802_11_bssid_list_scan</span><span class="p">(</span><span class="n">padapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">__queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">scanned_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wlan_network</span> <span class="o">*</span><span class="n">pnetwork</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist</span><span class="p">,</span> <span class="o">*</span><span class="n">phead</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">ev</span> <span class="o">+</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_SURVEY</span><span class="o">|</span><span class="n">_FW_UNDER_LINKING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqL</span><span class="p">);</span>
	<span class="n">phead</span> <span class="o">=</span> <span class="n">get_list_head</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">plist</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">phead</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end_of_queue_search</span><span class="p">(</span><span class="n">phead</span><span class="p">,</span> <span class="n">plist</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">ev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SCAN_ITEM_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pnetwork</span> <span class="o">=</span> <span class="n">LIST_CONTAINOR</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wlan_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">translate_scan</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">pnetwork</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
		<span class="n">plist</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">plist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqL</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ev</span> <span class="o">-</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set ssid flow</span>
<span class="cm"> * s1. set_802_11_infrastructure_mode()</span>
<span class="cm"> * s2. set_802_11_authenticaion_mode()</span>
<span class="cm"> * s3. set_802_11_encryption_mode()</span>
<span class="cm"> * s4. set_802_11_ssid()</span>
<span class="cm"> *</span>
<span class="cm"> * This function intends to handle the Set ESSID command.</span>
<span class="cm"> * Currently, the request comes via the Wireless Extensions&#39; SIOCSIWESSID ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * For this operation to succeed, there is no need for the interface to be Up.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">__queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">scanned_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wlan_network</span> <span class="o">*</span><span class="n">pnetwork</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">NDIS_802_11_AUTHENTICATION_MODE</span>	<span class="n">authmode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_802_11_ssid</span> <span class="n">ndis_ssid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dst_ssid</span><span class="p">,</span> <span class="o">*</span><span class="n">src_ssid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">phead</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_SURVEY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_LINKING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="n">authmode</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span> <span class="o">?</span>
		       <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">:</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndis_ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_802_11_ssid</span><span class="p">));</span>
		<span class="n">ndis_ssid</span><span class="p">.</span><span class="n">SsidLength</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndis_ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">src_ssid</span> <span class="o">=</span> <span class="n">ndis_ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">;</span>
		<span class="n">phead</span> <span class="o">=</span> <span class="n">get_list_head</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">phead</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end_of_queue_search</span><span class="p">(</span><span class="n">phead</span><span class="p">,</span> <span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">pnetwork</span> <span class="o">=</span> <span class="n">LIST_CONTAINOR</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">wlan_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">pscanned</span><span class="p">);</span>
			<span class="n">dst_ssid</span> <span class="o">=</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dst_ssid</span><span class="p">,</span> <span class="n">src_ssid</span><span class="p">,</span> <span class="n">ndis_ssid</span><span class="p">.</span><span class="n">SsidLength</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">Ssid</span><span class="p">.</span><span class="n">SsidLength</span> <span class="o">==</span>
			     <span class="n">ndis_ssid</span><span class="p">.</span><span class="n">SsidLength</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span>
							<span class="n">WIFI_ADHOC_STATE</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span>
						<span class="n">InfrastructureMode</span>
						<span class="o">!=</span>
						<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">.</span>
						<span class="n">cur_network</span><span class="p">.</span><span class="n">network</span><span class="p">.</span>
						<span class="n">InfrastructureMode</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">r8712_set_802_11_infrastructure_mode</span><span class="p">(</span>
				     <span class="n">padapter</span><span class="p">,</span>
				     <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">InfrastructureMode</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">r8712_set_802_11_authentication_mode</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">authmode</span><span class="p">);</span>
		<span class="n">r8712_set_802_11_ssid</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ndis_ssid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_wlan_bssid_ex</span> <span class="o">*</span><span class="n">pcur_bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">cur_network</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span><span class="o">|</span><span class="n">WIFI_ADHOC_MASTER_STATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">Ssid</span><span class="p">.</span><span class="n">SsidLength</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">Ssid</span><span class="p">.</span><span class="n">Ssid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">target_rate</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fixed</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">datarates</span><span class="p">[</span><span class="n">NumRates</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mpdatarate</span><span class="p">[</span><span class="n">NumRates</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_rate</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">target_rate</span> <span class="o">=</span> <span class="n">target_rate</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">target_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">20</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">55</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">60</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">90</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">110</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">180</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">240</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">360</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">480</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">540</span>:
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ratevalue</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">set_rate:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NumRates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ratevalue</span> <span class="o">==</span> <span class="n">mpdatarate</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">datarates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpdatarate</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">datarates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8712_setdatarate_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">datarates</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_SUCCESS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_wlan_bssid_ex</span> <span class="o">*</span><span class="n">pcur_bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">cur_network</span><span class="p">.</span><span class="n">network</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="n">pht_capie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rf_type</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">.</span><span class="n">rf_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rate</span><span class="p">,</span> <span class="n">max_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ht_cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ht_ielen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bw_40MHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">short_GI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mcs_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span><span class="o">|</span><span class="n">WIFI_ADHOC_MASTER_STATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">r8712_get_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">IEs</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
				 <span class="n">_HT_CAPABILITY_IE_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ht_ielen</span><span class="p">,</span>
		    <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">IELength</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">ht_ielen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ht_cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">pht_capie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcs_rate</span> <span class="p">,</span> <span class="n">pht_capie</span><span class="o">-&gt;</span><span class="n">supp_mcs_set</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">bw_40MHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">pht_capie</span><span class="o">-&gt;</span><span class="n">cap_info</span> <span class="o">&amp;</span>
				    <span class="n">IEEE80211_HT_CAP_SUP_WIDTH</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">short_GI</span> <span class="o">=</span> <span class="p">(</span><span class="n">pht_capie</span><span class="o">-&gt;</span><span class="n">cap_info</span> <span class="o">&amp;</span>
				    <span class="p">(</span><span class="n">IEEE80211_HT_CAP_SGI_20</span> <span class="o">|</span>
				    <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">SupportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">SupportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">pcur_bss</span><span class="o">-&gt;</span><span class="n">SupportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">max_rate</span><span class="p">)</span>
				<span class="n">max_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
			<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
			<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">rate</span><span class="o">*</span><span class="mi">500000</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mcs_rate</span> <span class="o">&amp;</span> <span class="mh">0x8000</span> <span class="cm">/* MCS15 */</span>
				<span class="o">&amp;&amp;</span>
				<span class="n">RTL8712_RF_2T2R</span> <span class="o">==</span> <span class="n">rf_type</span><span class="p">)</span>
				<span class="n">max_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bw_40MHz</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">short_GI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">300</span> <span class="o">:</span>
					    <span class="mi">270</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">short_GI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">144</span> <span class="o">:</span> <span class="mi">130</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mcs_rate</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="cm">/* MCS7 */</span>
				<span class="n">max_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bw_40MHz</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">short_GI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">150</span> <span class="o">:</span>
					    <span class="mi">135</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">short_GI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">72</span> <span class="o">:</span> <span class="mi">65</span><span class="p">);</span>
			<span class="k">else</span> <span class="cm">/* default MCS7 */</span>
				<span class="n">max_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bw_40MHz</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">short_GI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">150</span> <span class="o">:</span>
					    <span class="mi">135</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">short_GI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">72</span> <span class="o">:</span> <span class="mi">65</span><span class="p">);</span>
			<span class="n">max_rate</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Mbps/2 */</span>
			<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">max_rate</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">max_rate</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">registrypriv</span><span class="p">.</span><span class="n">rts_thresh</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">.</span><span class="n">frag_len</span> <span class="o">=</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">MIN_FRAG_THRESHOLD</span> <span class="o">||</span>
		    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">.</span><span class="n">frag_len</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">xmitpriv</span><span class="p">.</span><span class="n">frag_len</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_set_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keybuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">keyindex_provided</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span>	 <span class="n">wep</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">NDIS_802_11_AUTHENTICATION_MODE</span> <span class="n">authmode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r8711_wx_set_enc: &quot;</span>
		       <span class="s">&quot;EncryptionDisabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* open system */</span>
		<span class="n">authmode</span> <span class="o">=</span> <span class="n">Ndis802_11AuthModeOpen</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span> <span class="n">authmode</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&gt;</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">key</span><span class="o">--</span><span class="p">;</span>
		<span class="n">keyindex_provided</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">keyindex_provided</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyKeyIndex</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set authentication mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r8711_wx_set_enc: &quot;</span>
		       <span class="s">&quot;IW_ENCODE_OPEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* open system */</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
		<span class="n">authmode</span> <span class="o">=</span> <span class="n">Ndis802_11AuthModeOpen</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span> <span class="n">authmode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r8711_wx_set_enc: &quot;</span>
		       <span class="s">&quot;IW_ENCODE_RESTRICTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* shared system */</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_WEP40_</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_WEP40_</span><span class="p">;</span>
		<span class="n">authmode</span> <span class="o">=</span> <span class="n">Ndis802_11AuthModeShared</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span> <span class="n">authmode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				 <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* open system */</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span> <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span> <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
		<span class="n">authmode</span> <span class="o">=</span> <span class="n">Ndis802_11AuthModeOpen</span><span class="p">;</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span> <span class="n">authmode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wep</span><span class="p">.</span><span class="n">KeyIndex</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wep</span><span class="p">.</span><span class="n">KeyLength</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>
		<span class="n">wep</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">wep</span><span class="p">.</span><span class="n">KeyLength</span> <span class="o">+</span>
			     <span class="n">FIELD_OFFSET</span><span class="p">(</span><span class="k">struct</span> <span class="n">NDIS_802_11_WEP</span><span class="p">,</span> <span class="n">KeyMaterial</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wep</span><span class="p">.</span><span class="n">KeyLength</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keyindex_provided</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* set key_id only, no given</span>
<span class="cm">					       * KeyMaterial(erq-&gt;length==0).*/</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyKeyIndex</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">DefKeylen</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span>
						 <span class="n">_WEP40_</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">13</span>:
				<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span>
						 <span class="n">_WEP104_</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span>
						 <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wep</span><span class="p">.</span><span class="n">KeyIndex</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>	<span class="cm">/* transmit key */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wep</span><span class="p">.</span><span class="n">KeyMaterial</span><span class="p">,</span> <span class="n">keybuf</span><span class="p">,</span> <span class="n">wep</span><span class="p">.</span><span class="n">KeyLength</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8712_set_802_11_add_wep</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wep</span><span class="p">)</span> <span class="o">==</span> <span class="n">_FAIL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keybuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">key</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">);</span>
	<span class="k">struct</span>	<span class="n">mlme_priv</span>	<span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">WIFI_ADHOC_MASTER_STATE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&gt;</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">key</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyKeyIndex</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Ndis802_11EncryptionNotSupported</span>:
	<span class="k">case</span> <span class="n">Ndis802_11EncryptionDisabled</span>:
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Ndis802_11Encryption1Enabled</span>:
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">DefKeylen</span><span class="p">[</span><span class="n">key</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">keybuf</span><span class="p">,</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">DefKey</span><span class="p">[</span>
				<span class="n">key</span><span class="p">].</span><span class="n">skey</span><span class="p">,</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span>
				<span class="n">DefKeylen</span><span class="p">[</span><span class="n">key</span><span class="p">]);</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">==</span>
			    <span class="n">Ndis802_11AuthModeOpen</span><span class="p">)</span>
				<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">==</span>
				 <span class="n">Ndis802_11AuthModeShared</span><span class="p">)</span>
				<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Ndis802_11Encryption2Enabled</span>:
	<span class="k">case</span> <span class="n">Ndis802_11Encryption3Enabled</span>:
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_OPEN</span> <span class="o">|</span>
			       <span class="n">IW_ENCODE_NOKEY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no auto select */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wx_set_gen_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r871x_set_wpa_ie</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wx_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">paramid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">paramval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">paramid</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">;</span>
	<span class="n">paramval</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">paramid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 *  ??? does not use these parameters</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">paramval</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wpa_supplicant is enabling tkip countermeasure. */</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">btkip_countermeasure</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* wpa_supplicant is disabling tkip countermeasure. */</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">btkip_countermeasure</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="cm">/* HACK:</span>
<span class="cm">		 *</span>
<span class="cm">		 * wpa_supplicant calls set_wpa_enabled when the driver</span>
<span class="cm">		 * is loaded and unloaded, regardless of if WPA is being</span>
<span class="cm">		 * used.  No other calls are made which can be used to</span>
<span class="cm">		 * determine if encryption will be used or not prior to</span>
<span class="cm">		 * association being expected.  If encryption is not being</span>
<span class="cm">		 * used, drop_unencrypted is set to false, else true -- we</span>
<span class="cm">		 * can use this to determine if the CAP_PRIVACY_ON bit should</span>
<span class="cm">		 * be set.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">==</span>
		    <span class="n">Ndis802_11Encryption1Enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* it means init value, or using wep,</span>
<span class="cm">				 * ndisencryptstatus =</span>
<span class="cm">				 *	Ndis802_11Encryption1Enabled,</span>
<span class="cm">				 * then it needn&#39;t reset it;</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">paramval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				   <span class="n">Ndis802_11EncryptionDisabled</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">PrivacyAlgrthm</span> <span class="o">=</span>
				  <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">XGrpPrivacy</span> <span class="o">=</span>
				  <span class="n">_NO_PRIVACY_</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span>
				  <span class="n">Ndis802_11AuthModeOpen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wpa_set_auth_algs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">paramval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wx_set_enc_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">pencoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">pext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">alg_name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">param_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">param_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span><span class="p">)</span> <span class="o">+</span> <span class="n">pext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="p">)</span><span class="n">_malloc</span><span class="p">(</span><span class="n">param_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">param_len</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IEEE_CMD_SET_ENCRYPTION</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_ENCODE_ALG_NONE</span>:
		<span class="n">alg_name</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_ENCODE_ALG_WEP</span>:
		<span class="n">alg_name</span> <span class="o">=</span> <span class="s">&quot;WEP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_ENCODE_ALG_TKIP</span>:
		<span class="n">alg_name</span> <span class="o">=</span> <span class="s">&quot;TKIP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_ENCODE_ALG_CCMP</span>:
		<span class="n">alg_name</span> <span class="o">=</span> <span class="s">&quot;CCMP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="n">alg_name</span><span class="p">,</span> <span class="n">IEEE_CRYPT_ALG_NAME_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_GROUP_KEY</span><span class="p">)</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pencoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_RX_SEQ_VALID</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">pext</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">pext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">param</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pext</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wpa_set_encryption</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wx_get_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;rtl_wifi&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keybuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data32</span><span class="p">;</span>

	<span class="n">get_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">data32</span> <span class="o">=</span> <span class="n">r8712_read32</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">put_user</span><span class="p">(</span><span class="n">data32</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data32</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">data32</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">get_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_wx_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keybuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data32</span><span class="p">;</span>

	<span class="n">get_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">data32</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="p">;</span>
	<span class="n">r8712_write32</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data32</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8711_drvext_hdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_mp_ioctl_hdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">oid_par_priv</span> <span class="n">oid_par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mp_ioctl_handler</span> <span class="o">*</span><span class="n">phandler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mp_ioctl_param</span> <span class="o">*</span><span class="n">poidparam</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BytesRead</span><span class="p">,</span> <span class="n">BytesWritten</span><span class="p">,</span> <span class="n">BytesNeeded</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pparmbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_r871x_mp_ioctl_hdl_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">pparmbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pparmbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">_malloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pparmbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_r871x_mp_ioctl_hdl_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">pparmbuf</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_r871x_mp_ioctl_hdl_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">poidparam</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mp_ioctl_param</span> <span class="o">*</span><span class="p">)</span><span class="n">pparmbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poidparam</span><span class="o">-&gt;</span><span class="n">subcode</span> <span class="o">&gt;=</span> <span class="n">MAX_MP_IOCTL_SUBCODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_r871x_mp_ioctl_hdl_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phandler</span> <span class="o">=</span> <span class="n">mp_ioctl_hdl</span> <span class="o">+</span> <span class="n">poidparam</span><span class="o">-&gt;</span><span class="n">subcode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phandler</span><span class="o">-&gt;</span><span class="n">paramsize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">poidparam</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">phandler</span><span class="o">-&gt;</span><span class="n">paramsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_r871x_mp_ioctl_hdl_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phandler</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">phandler</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">phandler</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oid_par</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phandler</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oid_par</span><span class="p">.</span><span class="n">adapter_context</span> <span class="o">=</span> <span class="n">padapter</span><span class="p">;</span>
		<span class="n">oid_par</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">phandler</span><span class="o">-&gt;</span><span class="n">oid</span><span class="p">;</span>
		<span class="n">oid_par</span><span class="p">.</span><span class="n">information_buf</span> <span class="o">=</span> <span class="n">poidparam</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">oid_par</span><span class="p">.</span><span class="n">information_buf_len</span> <span class="o">=</span> <span class="n">poidparam</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">oid_par</span><span class="p">.</span><span class="n">dbg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BytesWritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BytesNeeded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">oid_par</span><span class="p">.</span><span class="n">bytes_rw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BytesRead</span><span class="p">;</span>
			<span class="n">oid_par</span><span class="p">.</span><span class="n">bytes_needed</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BytesNeeded</span><span class="p">;</span>
			<span class="n">oid_par</span><span class="p">.</span><span class="n">type_of_oid</span> <span class="o">=</span> <span class="n">SET_OID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">oid_par</span><span class="p">.</span><span class="n">bytes_rw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BytesWritten</span><span class="p">;</span>
			<span class="n">oid_par</span><span class="p">.</span><span class="n">bytes_needed</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BytesNeeded</span><span class="p">;</span>
			<span class="n">oid_par</span><span class="p">.</span><span class="n">type_of_oid</span> <span class="o">=</span> <span class="n">QUERY_OID</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">phandler</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oid_par</span><span class="p">);</span>
		<span class="cm">/* todo:check status, BytesNeeded, etc. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: r871x_mp_ioctl_hdl(): err!,&quot;</span>
		    <span class="s">&quot; subcode=%d, oid=%d, handler=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">poidparam</span><span class="o">-&gt;</span><span class="n">subcode</span><span class="p">,</span> <span class="n">phandler</span><span class="o">-&gt;</span><span class="n">oid</span><span class="p">,</span> <span class="n">phandler</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_r871x_mp_ioctl_hdl_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bset</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* query info */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">pparmbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_r871x_mp_ioctl_hdl_exit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">_r871x_mp_ioctl_hdl_exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pparmbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_get_ap_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mlme_priv</span> <span class="o">*</span><span class="n">pmlmepriv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">__queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">scanned_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wlan_network</span> <span class="o">*</span><span class="n">pnetwork</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wpa_ielen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist</span><span class="p">,</span> <span class="o">*</span><span class="n">phead</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="p">,</span> <span class="n">_FW_UNDER_SURVEY</span><span class="o">|</span><span class="n">_FW_UNDER_LINKING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">scanned_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span> <span class="n">irqL</span><span class="p">);</span>
	<span class="n">phead</span> <span class="o">=</span> <span class="n">get_list_head</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">plist</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">phead</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end_of_queue_search</span><span class="p">(</span><span class="n">phead</span><span class="p">,</span> <span class="n">plist</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pnetwork</span> <span class="o">=</span> <span class="n">LIST_CONTAINOR</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wlan_network</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwaddr_aton_i</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: Invalid BSSID &#39;%s&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">scanned_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
									<span class="n">irqL</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;r8712u: BSSID:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">MacAddress</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* BSSID match, then check if supporting wpa/wpa2 */</span>
			<span class="n">pbuf</span> <span class="o">=</span> <span class="n">r8712_get_wpa_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IEs</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
			       <span class="o">&amp;</span><span class="n">wpa_ielen</span><span class="p">,</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IELength</span><span class="o">-</span><span class="mi">12</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wpa_ielen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pbuf</span> <span class="o">=</span> <span class="n">r8712_get_wpa2_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IEs</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
			       <span class="o">&amp;</span><span class="n">wpa_ielen</span><span class="p">,</span> <span class="n">pnetwork</span><span class="o">-&gt;</span><span class="n">network</span><span class="p">.</span><span class="n">IELength</span><span class="o">-</span><span class="mi">12</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wpa_ielen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">plist</span> <span class="o">=</span> <span class="n">get_next</span><span class="p">(</span><span class="n">plist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pmlmepriv</span><span class="o">-&gt;</span><span class="n">scanned_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span> <span class="n">irqL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_set_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_set_chplan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_plan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch_plan</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">r8712_set_chplan_cmd</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="n">ch_plan</span><span class="p">);</span>

<span class="nl">exit:</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r871x_wps_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span>   <span class="n">u32wps_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">u32wps_start</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">bDriverStopped</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u32wps_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">u32wps_start</span> <span class="o">=</span> <span class="o">*</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u32wps_start</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* WPS Start */</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">ledpriv</span><span class="p">.</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span>
			   <span class="n">LED_CTL_START_WPS</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u32wps_start</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* WPS Stop because of wps success */</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">ledpriv</span><span class="p">.</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span>
			   <span class="n">LED_CTL_STOP_WPS</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u32wps_start</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="cm">/* WPS Stop because of wps fail */</span>
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">ledpriv</span><span class="p">.</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span>
			   <span class="n">LED_CTL_STOP_WPS_FAIL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wpa_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_WPA_ENABLED</span>:
		<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">AuthAlgrthm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 802.1x */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">value</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* WPA */</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span>
				<span class="n">Ndis802_11AuthModeWPAPSK</span><span class="p">;</span> <span class="cm">/* WPA_PSK */</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				<span class="n">Ndis802_11Encryption2Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* WPA2 */</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisauthtype</span> <span class="o">=</span>
				<span class="n">Ndis802_11AuthModeWPA2PSK</span><span class="p">;</span> <span class="cm">/* WPA2_PSK */</span>
			<span class="n">padapter</span><span class="o">-&gt;</span><span class="n">securitypriv</span><span class="p">.</span><span class="n">ndisencryptstatus</span> <span class="o">=</span>
				<span class="n">Ndis802_11Encryption3Enabled</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_TKIP_COUNTERMEASURES</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_DROP_UNENCRYPTED</span>:
		<span class="cm">/* HACK:</span>
<span class="cm">		 *</span>
<span class="cm">		 * wpa_supplicant calls set_wpa_enabled when the driver</span>
<span class="cm">		 * is loaded and unloaded, regardless of if WPA is being</span>
<span class="cm">		 * used.  No other calls are made which can be used to</span>
<span class="cm">		 * determine if encryption will be used or not prior to</span>
<span class="cm">		 * association being expected.  If encryption is not being</span>
<span class="cm">		 * used, drop_unencrypted is set to false, else true -- we</span>
<span class="cm">		 * can use this to determine if the CAP_PRIVACY_ON bit should</span>
<span class="cm">		 * be set.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_PRIVACY_INVOKED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_AUTH_ALGS</span>:
		<span class="k">return</span> <span class="n">wpa_set_auth_algs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_IEEE_802_1X</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_WPAX_SELECT</span>:
		<span class="cm">/* added for WPA2 mixed mode */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wpa_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">command</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_MLME_STA_DEAUTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r8712_set_802_11_disassociate</span><span class="p">(</span><span class="n">padapter</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_MLME_STA_DISASSOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r8712_set_802_11_disassociate</span><span class="p">(</span><span class="n">padapter</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wpa_supplicant_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="p">)</span><span class="n">_malloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_CMD_SET_WPA_PARAM</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wpa_set_param</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_param</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		      <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_param</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_CMD_SET_WPA_IE</span>:
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">r871x_set_wpa_ie</span><span class="p">(</span><span class="n">padapter</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_CMD_SET_ENCRYPTION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wpa_set_encryption</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_CMD_MLME</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wpa_mlme</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
		      <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* based on &quot;driver_ipw&quot; and for hostapd */</span>
<span class="kt">int</span> <span class="nf">r871x_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span><span class="n">rq</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_IOCTL_WPA_SUPPLICANT</span>:
		<span class="k">return</span> <span class="n">wpa_supplicant_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">r8711_handlers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCSIWCOMMIT */</span>
	<span class="n">r8711_wx_get_name</span><span class="p">,</span>		<span class="cm">/* SIOCGIWNAME */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWNWID */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCGIWNWID */</span>
	<span class="n">r8711_wx_set_freq</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFREQ */</span>
	<span class="n">r8711_wx_get_freq</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFREQ */</span>
	<span class="n">r8711_wx_set_mode</span><span class="p">,</span>		<span class="cm">/* SIOCSIWMODE */</span>
	<span class="n">r8711_wx_get_mode</span><span class="p">,</span>		<span class="cm">/* SIOCGIWMODE */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWSENS */</span>
	<span class="n">r8711_wx_get_sens</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSENS */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCSIWRANGE */</span>
	<span class="n">r8711_wx_get_range</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRANGE */</span>
	<span class="n">r871x_wx_set_priv</span><span class="p">,</span>		<span class="cm">/* SIOCSIWPRIV */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCGIWPRIV */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCSIWSTATS */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCGIWSTATS */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWSPY */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCGIWSPY */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCGIWTHRSPY */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCWIWTHRSPY */</span>
	<span class="n">r8711_wx_set_wap</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAP */</span>
	<span class="n">r8711_wx_get_wap</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAP */</span>
	<span class="n">r871x_wx_set_mlme</span><span class="p">,</span>		<span class="cm">/* request MLME operation;</span>
<span class="cm">					 *  uses struct iw_mlme */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCGIWAPLIST -- deprecated */</span>
	<span class="n">r8711_wx_set_scan</span><span class="p">,</span>		<span class="cm">/* SIOCSIWSCAN */</span>
	<span class="n">r8711_wx_get_scan</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSCAN */</span>
	<span class="n">r8711_wx_set_essid</span><span class="p">,</span>		<span class="cm">/* SIOCSIWESSID */</span>
	<span class="n">r8711_wx_get_essid</span><span class="p">,</span>		<span class="cm">/* SIOCGIWESSID */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWNICKN */</span>
	<span class="n">r871x_wx_get_nick</span><span class="p">,</span>		<span class="cm">/* SIOCGIWNICKN */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* -- hole -- */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* -- hole -- */</span>
	<span class="n">r8711_wx_set_rate</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRATE */</span>
	<span class="n">r8711_wx_get_rate</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRATE */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWRTS */</span>
	<span class="n">r8711_wx_get_rts</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRTS */</span>
	<span class="n">r8711_wx_set_frag</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFRAG */</span>
	<span class="n">r8711_wx_get_frag</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFRAG */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWTXPOW */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCGIWTXPOW */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWRETRY */</span>
	<span class="n">r8711_wx_get_retry</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRETRY */</span>
	<span class="n">r8711_wx_set_enc</span><span class="p">,</span>		<span class="cm">/* SIOCSIWENCODE */</span>
	<span class="n">r8711_wx_get_enc</span><span class="p">,</span>		<span class="cm">/* SIOCGIWENCODE */</span>
	<span class="n">dummy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWPOWER */</span>
	<span class="n">r8711_wx_get_power</span><span class="p">,</span>		<span class="cm">/* SIOCGIWPOWER */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/*---hole---*/</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/*---hole---*/</span>
	<span class="n">r871x_wx_set_gen_ie</span><span class="p">,</span>		<span class="cm">/* SIOCSIWGENIE */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCGIWGENIE */</span>
	<span class="n">r871x_wx_set_auth</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAUTH */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCGIWAUTH */</span>
	<span class="n">r871x_wx_set_enc_ext</span><span class="p">,</span>		<span class="cm">/* SIOCSIWENCODEEXT */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCGIWENCODEEXT */</span>
	<span class="n">r871x_wx_set_pmkid</span><span class="p">,</span>		<span class="cm">/* SIOCSIWPMKSA */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/*---hole---*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">r8711_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;read32&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;write32&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;driver_ext&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;mp_ioctl&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;apinfo&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;setpid&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wps_start&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">SIOCIWFIRSTPRIV</span> <span class="o">+</span> <span class="mh">0x7</span><span class="p">,</span>
		<span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;chplan&quot;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">iw_handler</span> <span class="n">r8711_private_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">r8711_wx_read32</span><span class="p">,</span>
	<span class="n">r8711_wx_write32</span><span class="p">,</span>
	<span class="n">r8711_drvext_hdl</span><span class="p">,</span>
	<span class="n">r871x_mp_ioctl_hdl</span><span class="p">,</span>
	<span class="n">r871x_get_ap_info</span><span class="p">,</span> <span class="cm">/*for MM DTV platform*/</span>
	<span class="n">r871x_set_pid</span><span class="p">,</span>
	<span class="n">r871x_wps_start</span><span class="p">,</span>
	<span class="n">r871x_set_chplan</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">r871x_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="n">padapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">piwstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">iwstats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_fwstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">mlmepriv</span><span class="p">,</span> <span class="n">_FW_LINKED</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">piwstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">piwstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">piwstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* show percentage, we need transfer dbm to orignal value. */</span>
		<span class="n">tmp_level</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">recvpriv</span><span class="p">.</span><span class="n">fw_rssi</span><span class="p">;</span>
		<span class="n">tmp_qual</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">recvpriv</span><span class="p">.</span><span class="n">signal</span><span class="p">;</span>
		<span class="n">tmp_noise</span> <span class="o">=</span> <span class="n">padapter</span><span class="o">-&gt;</span><span class="n">recvpriv</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>
		<span class="n">piwstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">tmp_level</span><span class="p">;</span>
		<span class="n">piwstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">tmp_qual</span><span class="p">;</span>
		<span class="n">piwstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">tmp_noise</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">piwstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">padapter</span><span class="o">-&gt;</span><span class="n">iwstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">r871x_handlers_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">r8711_handlers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_standard</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">r8711_handlers</span><span class="p">),</span>
	<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">r8711_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="o">*</span><span class="p">)</span><span class="n">r8711_private_args</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_private</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">r8711_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r8711_private_args</span><span class="p">)</span> <span class="o">/</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">r871x_get_wireless_stats</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
