<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › ipack › bridges › tpci200.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tpci200.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * tpci200.c</span>
<span class="cm"> *</span>
<span class="cm"> * driver for the TEWS TPCI-200 device</span>
<span class="cm"> * Copyright (c) 2009 Nicolas Serafini, EIC2 SA</span>
<span class="cm"> * Copyright (c) 2010,2011 Samuel Iglesias Gonsalvez &lt;siglesia@cern.ch&gt;, CERN</span>
<span class="cm"> * Copyright (c) 2012 Samuel Iglesias Gonsalvez &lt;siglesias@igalia.com&gt;, Igalia</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; version 2 of the License.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;tpci200.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipack_bus_ops</span> <span class="n">tpci200_bus_ops</span><span class="p">;</span>

<span class="cm">/* TPCI200 controls registers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">control_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TPCI200_CONTROL_A_REG</span><span class="p">,</span>
	<span class="n">TPCI200_CONTROL_B_REG</span><span class="p">,</span>
	<span class="n">TPCI200_CONTROL_C_REG</span><span class="p">,</span>
	<span class="n">TPCI200_CONTROL_D_REG</span>
<span class="p">};</span>

<span class="cm">/* Linked list to save the registered devices */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tpci200_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tpci200_slot_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="nf">check_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot doesn&#39;t exist.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tpci200</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpci200_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Carrier not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">TPCI200_NB_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] doesn&#39;t exist! Last tpci200 slot is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">TPCI200_NB_SLOT</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] is not registered !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tpci200</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">__tpci200_read8</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span><span class="o">^</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">__tpci200_read16</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__tpci200_read32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">swahw32</span><span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__tpci200_write8</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="n">offset</span><span class="o">^</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__tpci200_write16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">address</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__tpci200_write32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">swahw32</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">address</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="nf">get_slot_address_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						       <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">space</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPACK_IO_SPACE</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPACK_ID_SPACE</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id_space</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPACK_MEM_SPACE</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] space number %d doesn&#39;t exist !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error, slot space not mapped !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_read8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">get_slot_address_space</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error, slot space offset error !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">__tpci200_read8</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">get_slot_address_space</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error, slot space offset error !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">__tpci200_read16</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">get_slot_address_space</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error, slot space offset error !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">__tpci200_read32</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_write8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">get_slot_address_space</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error, slot space offset error !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__tpci200_write8</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">get_slot_address_space</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error, slot space offset error !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__tpci200_write16</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">get_slot_address_space</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error, slot space offset error !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__tpci200_write32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpci200_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tpci200</span><span class="p">);</span>

	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioidint_space</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mem8_space</span><span class="p">);</span>

	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TPCI200_IP_INTERFACE_BAR</span><span class="p">);</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TPCI200_IO_ID_INT_SPACES_BAR</span><span class="p">);</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TPCI200_MEM8_SPACE_BAR</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPCI200_NB_SLOT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io_phys</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io_phys</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_phys</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_phys</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_phys</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_phys</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tpci200_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status_reg</span><span class="p">,</span> <span class="n">reg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">unhandled_ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Read status register */</span>
	<span class="n">status_reg</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span> <span class="o">+</span>
			   <span class="n">TPCI200_STATUS_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">TPCI200_SLOT_INT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unhandled_ints</span> <span class="o">=</span> <span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">TPCI200_SLOT_INT_MASK</span><span class="p">;</span>
		<span class="cm">/* callback to the IRQ handler for the corresponding slot */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPCI200_NB_SLOT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">TPCI200_A_INT0</span> <span class="o">|</span> <span class="n">TPCI200_A_INT1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">))))</span> <span class="p">{</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>

				<span class="cm">/* Dummy reads */</span>
				<span class="n">readw</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span>
				      <span class="mh">0xC0</span><span class="p">);</span>
				<span class="n">readw</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span>
				      <span class="mh">0xC2</span><span class="p">);</span>

				<span class="n">unhandled_ints</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(((</span><span class="n">TPCI200_A_INT0</span> <span class="o">|</span> <span class="n">TPCI200_A_INT1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Interrupt not handled are disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unhandled_ints</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPCI200_NB_SLOT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unhandled_ints</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">TPCI200_INT0_EN</span> <span class="o">|</span> <span class="n">TPCI200_INT1_EN</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;No registered ISR for slot [%d:%d]!. IRQ will be disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">reg_value</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span>
					<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span> <span class="o">+</span>
					<span class="n">control_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">reg_value</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="n">TPCI200_INT0_EN</span> <span class="o">|</span> <span class="n">TPCI200_INT1_EN</span><span class="p">);</span>
				<span class="n">writew</span><span class="p">(</span><span class="n">reg_value</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span> <span class="o">+</span>
					<span class="n">control_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="nf">tpci200_slot_register</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tpci200_number</span><span class="p">,</span>
						  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot_position</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipack_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tpci200</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpci200_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">tpci200_number</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;carrier board not found for the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot_position</span> <span class="o">&gt;=</span> <span class="n">TPCI200_NB_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] doesn&#39;t exist!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpci200_number</span><span class="p">,</span>
			<span class="n">slot_position</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_position</span><span class="p">].</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] already installed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpci200_number</span><span class="p">,</span>
		       <span class="n">slot_position</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give the same IRQ number as the slot number.</span>
<span class="cm">	 * The TPCI200 has assigned his own two IRQ by PCI bus driver</span>
<span class="cm">	 */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ipack_device_register</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ipack_bus</span><span class="p">,</span>
				    <span class="n">slot_position</span><span class="p">,</span> <span class="n">slot_position</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] Unable to register an ipack device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpci200_number</span><span class="p">,</span> <span class="n">slot_position</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot_position</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_store_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">tpci200_slot_register</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_show_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_show_description</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="s">&quot;TEWS tpci200 carrier PCI for Industry-pack mezzanines.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_show_board_slot0</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_show_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_store_board_slot0</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_store_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_show_board_slot1</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_show_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_store_board_slot1</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_store_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_show_board_slot2</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_show_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_store_board_slot2</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_store_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_show_board_slot3</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_show_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpci200_store_board_slot3</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpci200_store_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Declaration of the device attributes for the TPCI200 */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">tpci200_show_description</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_slot0</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">tpci200_show_board_slot0</span><span class="p">,</span> <span class="n">tpci200_store_board_slot0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_slot1</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">tpci200_show_board_slot1</span><span class="p">,</span> <span class="n">tpci200_store_board_slot1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_slot2</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">tpci200_show_board_slot2</span><span class="p">,</span> <span class="n">tpci200_store_board_slot2</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_slot3</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">tpci200_show_board_slot3</span><span class="p">,</span> <span class="n">tpci200_store_board_slot3</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">tpci200_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_description</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_slot0</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_slot1</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_slot2</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_slot3</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">tpci200_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">tpci200_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_create_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">tpci200_attr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpci200_remove_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpci200_attr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_create_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpci200_remove_sysfs_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSFS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioidint_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">slot_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200_create_sysfs_files</span><span class="p">(</span><span class="n">tpci200</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed creating sysfs files</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable_pci</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request IP interface register (Bar 2) */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TPCI200_IP_INTERFACE_BAR</span><span class="p">,</span>
				 <span class="s">&quot;Carrier IP interface registers&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;(bn 0x%X, sn 0x%X) failed to allocate PCI resource for BAR 2 !&quot;</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_remove_sysfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request IO ID INT space (Bar 3) */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">TPCI200_IO_ID_INT_SPACES_BAR</span><span class="p">,</span>
				 <span class="s">&quot;Carrier IO ID INT space&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;(bn 0x%X, sn 0x%X) failed to allocate PCI resource for BAR 3 !&quot;</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_ip_space</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request MEM space (Bar 4) */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TPCI200_MEM8_SPACE_BAR</span><span class="p">,</span>
				 <span class="s">&quot;Carrier MEM space&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;(bn 0x%X, sn 0x%X) failed to allocate PCI resource for BAR 4!&quot;</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_ioid_int_space</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Map internal tpci200 driver user space */</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span> <span class="o">=</span>
		<span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="n">TPCI200_IP_INTERFACE_BAR</span><span class="p">),</span>
			<span class="n">TPCI200_IFACE_SIZE</span><span class="p">);</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ioidint_space</span> <span class="o">=</span>
		<span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="n">TPCI200_IO_ID_INT_SPACES_BAR</span><span class="p">),</span>
			<span class="n">TPCI200_IOIDINT_SIZE</span><span class="p">);</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mem8_space</span> <span class="o">=</span>
		<span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="n">TPCI200_MEM8_SPACE_BAR</span><span class="p">),</span>
			<span class="n">TPCI200_MEM8_SIZE</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>
	<span class="n">ioidint_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					  <span class="n">TPCI200_IO_ID_INT_SPACES_BAR</span><span class="p">);</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">TPCI200_MEM8_SPACE_BAR</span><span class="p">);</span>

	<span class="cm">/* Set the default parameters of the slot</span>
<span class="cm">	 * INT0 disabled, level sensitive</span>
<span class="cm">	 * INT1 disabled, level sensitive</span>
<span class="cm">	 * error interrupt disabled</span>
<span class="cm">	 * timeout interrupt disabled</span>
<span class="cm">	 * recover time disabled</span>
<span class="cm">	 * clock rate 8 MHz</span>
<span class="cm">	 */</span>
	<span class="n">slot_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set all slot physical address space */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPCI200_NB_SLOT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io_phys</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioidint_base</span> <span class="o">+</span>
			<span class="n">TPCI200_IO_SPACE_OFF</span> <span class="o">+</span> <span class="n">TPCI200_IO_SPACE_GAP</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io_phys</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TPCI200_IO_SPACE_SIZE</span><span class="p">;</span>

		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_phys</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioidint_base</span> <span class="o">+</span>
			<span class="n">TPCI200_ID_SPACE_OFF</span> <span class="o">+</span> <span class="n">TPCI200_ID_SPACE_GAP</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_phys</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TPCI200_ID_SPACE_SIZE</span><span class="p">;</span>

		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_phys</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">TPCI200_MEM8_GAP</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
		<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_phys</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TPCI200_MEM8_SIZE</span><span class="p">;</span>

		<span class="n">writew</span><span class="p">(</span><span class="n">slot_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span> <span class="o">+</span>
				   <span class="n">control_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			  <span class="n">tpci200_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tpci200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;(bn 0x%X, sn 0x%X) unable to register IRQ !&quot;</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="n">tpci200_unregister</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_release_ioid_int_space:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TPCI200_IO_ID_INT_SPACES_BAR</span><span class="p">);</span>
<span class="nl">out_release_ip_space:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TPCI200_IP_INTERFACE_BAR</span><span class="p">);</span>
<span class="nl">out_remove_sysfs:</span>
	<span class="n">tpci200_remove_sysfs_files</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
<span class="nl">out_disable_pci:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__tpci200_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">slot_ctrl</span><span class="p">;</span>

	<span class="cm">/* Set the default parameters of the slot</span>
<span class="cm">	 * INT0 enabled, level sensitive</span>
<span class="cm">	 * INT1 enabled, level sensitive</span>
<span class="cm">	 * error interrupt disabled</span>
<span class="cm">	 * timeout interrupt disabled</span>
<span class="cm">	 * recover time disabled</span>
<span class="cm">	 * clock rate 8 MHz</span>
<span class="cm">	 */</span>
	<span class="n">slot_ctrl</span> <span class="o">=</span> <span class="n">TPCI200_INT0_EN</span> <span class="o">|</span> <span class="n">TPCI200_INT1_EN</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">slot_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span> <span class="o">+</span>
			   <span class="n">control_reg</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">]));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tpci200_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">slot_ctrl</span><span class="p">;</span>

	<span class="cm">/* Set the default parameters of the slot</span>
<span class="cm">	 * INT0 disabled, level sensitive</span>
<span class="cm">	 * INT1 disabled, level sensitive</span>
<span class="cm">	 * error interrupt disabled</span>
<span class="cm">	 * timeout interrupt disabled</span>
<span class="cm">	 * recover time disabled</span>
<span class="cm">	 * clock rate 8 MHz</span>
<span class="cm">	 */</span>
	<span class="n">slot_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">slot_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interface_regs</span> <span class="o">+</span>
			   <span class="n">control_reg</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot_irq</span> <span class="o">*</span><span class="n">slot_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">irq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__tpci200_free_irq</span><span class="p">(</span><span class="n">tpci200</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">slot_irq</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">slot_irq</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_slot_unmap_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">virt_addr_space</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">space</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPACK_IO_SPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">.</span><span class="n">address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] IO space not mapped !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">virt_addr_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPACK_ID_SPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id_space</span><span class="p">.</span><span class="n">address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] ID space not mapped !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">virt_addr_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id_space</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPACK_MEM_SPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="p">.</span><span class="n">address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] MEM space not mapped !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">virt_addr_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] space number %d doesn&#39;t exist !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">virt_addr_space</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>

	<span class="n">virt_addr_space</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">virt_addr_space</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_slot_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tpci200_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ipack_device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_slot_map_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">memory_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size_to_map</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">phys_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipack_addr_space</span> <span class="o">*</span><span class="n">virt_addr_space</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">space</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPACK_IO_SPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">.</span><span class="n">address</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] IO space already mapped !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">virt_addr_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">;</span>

		<span class="n">phys_address</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">io_phys</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
		<span class="n">size_to_map</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">io_phys</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPACK_ID_SPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id_space</span><span class="p">.</span><span class="n">address</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] ID space already mapped !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">virt_addr_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id_space</span><span class="p">;</span>

		<span class="n">phys_address</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">id_phys</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
		<span class="n">size_to_map</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">id_phys</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPACK_MEM_SPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="p">.</span><span class="n">address</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] MEM space already mapped !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">virt_addr_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memory_size</span> <span class="o">&gt;</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">mem_phys</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] request is 0x%X memory, only 0x%X available !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">memory_size</span><span class="p">,</span>
			       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">mem_phys</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">phys_address</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">mem_phys</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>
		<span class="n">size_to_map</span> <span class="o">=</span> <span class="n">memory_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] space %d doesn&#39;t exist !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">virt_addr_space</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size_to_map</span><span class="p">;</span>
	<span class="n">virt_addr_space</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span>
		<span class="n">ioremap</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">phys_address</span><span class="p">,</span> <span class="n">size_to_map</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipack_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vector</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot_irq</span> <span class="o">*</span><span class="n">slot_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">check_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">irq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] IRQ already registered !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slot_irq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot_irq</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot_irq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Slot [%d:%d] unable to allocate memory for IRQ !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * WARNING: Setup Interrupt Vector in the IndustryPack device</span>
<span class="cm">	 * before an IRQ request.</span>
<span class="cm">	 * Read the User Manual of your IndustryPack device to know</span>
<span class="cm">	 * where to write the vector in memory.</span>
<span class="cm">	 */</span>
	<span class="n">slot_irq</span><span class="o">-&gt;</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span><span class="p">;</span>
	<span class="n">slot_irq</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
	<span class="n">slot_irq</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">slot_irq</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">slot_irq</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">__tpci200_request_irq</span><span class="p">(</span><span class="n">tpci200</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpci200_slot_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">remove</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpci200_uninstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPCI200_NB_SLOT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tpci200_slot_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">tpci200_unregister</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ipack_bus_ops</span> <span class="n">tpci200_bus_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">map_space</span> <span class="o">=</span> <span class="n">tpci200_slot_map_space</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_space</span> <span class="o">=</span> <span class="n">tpci200_slot_unmap_space</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_irq</span> <span class="o">=</span> <span class="n">tpci200_request_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_irq</span> <span class="o">=</span> <span class="n">tpci200_free_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read8</span> <span class="o">=</span> <span class="n">tpci200_read8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read16</span> <span class="o">=</span> <span class="n">tpci200_read16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read32</span> <span class="o">=</span> <span class="n">tpci200_read32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write8</span> <span class="o">=</span> <span class="n">tpci200_write8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write16</span> <span class="o">=</span> <span class="n">tpci200_write16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write32</span> <span class="o">=</span> <span class="n">tpci200_write32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_device</span> <span class="o">=</span> <span class="n">tpci200_slot_unregister</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_install</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
		<span class="n">TPCI200_NB_SLOT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_slot</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">tpci200_register</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">);</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpci200_pciprobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">;</span>

	<span class="n">tpci200</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpci200</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_infos</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save struct pci_dev pointer */</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">id_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="p">)</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* register the device and initialize it */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tpci200_install</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error during tpci200 install !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register the carrier in the industry pack bus driver */</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ipack_bus</span> <span class="o">=</span> <span class="n">ipack_bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						      <span class="n">TPCI200_NB_SLOT</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">tpci200_bus_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ipack_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error registering the carrier on ipack driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tpci200_uninstall</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save the bus number given by ipack to logging purpose */</span>
	<span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ipack_bus</span><span class="o">-&gt;</span><span class="n">bus_nr</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tpci200</span><span class="p">);</span>
	<span class="cm">/* add the registered device in an internal linked list */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpci200_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tpci200_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpci200_uninstall</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
	<span class="n">tpci200_remove_sysfs_files</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">ipack_bus_unregister</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ipack_bus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">tpci200_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* Search the registered device to uninstall it */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tpci200</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpci200_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpci200</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__tpci200_pci_remove</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">tpci200_idtable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TPCI200_VENDOR_ID</span><span class="p">,</span> <span class="n">TPCI200_DEVICE_ID</span><span class="p">,</span> <span class="n">TPCI200_SUBVENDOR_ID</span><span class="p">,</span>
	  <span class="n">TPCI200_SUBDEVICE_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tpci200_pci_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tpci200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tpci200_idtable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tpci200_pciprobe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tpci200_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tpci200_drvr_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200_pci_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tpci200_drvr_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpci200_board</span> <span class="o">*</span><span class="n">tpci200</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tpci200</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpci200_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">__tpci200_pci_remove</span><span class="p">(</span><span class="n">tpci200</span><span class="p">);</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpci200_pci_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TEWS TPCI-200 device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">tpci200_drvr_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tpci200_drvr_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
