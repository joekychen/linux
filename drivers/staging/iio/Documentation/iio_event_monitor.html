<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › iio › Documentation › iio_event_monitor.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iio_event_monitor.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Industrialio event test code.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011-2012 Lars-Peter Clausen &lt;lars@metafoo.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is primarily intended as an example application.</span>
<span class="cm"> * Reads the current buffer setup from sysfs and starts a short capture</span>
<span class="cm"> * from the specified device, pretty printing the result after appropriate</span>
<span class="cm"> * conversion.</span>
<span class="cm"> *</span>
<span class="cm"> * Usage:</span>
<span class="cm"> *	iio_event_monitor &lt;device_name&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define _GNU_SOURCE</span>

<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdbool.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;poll.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;sys/ioctl.h&gt;</span>
<span class="cp">#include &quot;iio_utils.h&quot;</span>
<span class="cp">#include &lt;linux/iio/events.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">iio_chan_type_name_spec</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IIO_VOLTAGE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;voltage&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_CURRENT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;current&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_POWER</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;power&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_ACCEL</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;accel&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_ANGL_VEL</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;anglvel&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_MAGN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;magn&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_LIGHT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;illuminance&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_INTENSITY</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;intensity&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_PROXIMITY</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;proximity&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_TEMP</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;temp&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_INCLI</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;incli&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_ROT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;rot&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_ANGL</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;angl&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_TIMESTAMP</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;timestamp&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_CAPACITANCE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;capacitance&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">iio_ev_type_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IIO_EV_TYPE_THRESH</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;thresh&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_EV_TYPE_MAG</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;mag&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_EV_TYPE_ROC</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;roc&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;thresh_adaptive&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;mag_adaptive&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">iio_ev_dir_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IIO_EV_DIR_EITHER</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;either&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_EV_DIR_RISING</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;rising&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_EV_DIR_FALLING</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;falling&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">iio_modifier_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IIO_MOD_X</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;x&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_MOD_Y</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;y&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_MOD_Z</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;z&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_MOD_LIGHT_BOTH</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;both&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IIO_MOD_LIGHT_IR</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ir&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">event_is_known</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_event_data</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">iio_chan_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN_TYPE</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">iio_modifier</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_MODIFIER</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">iio_event_type</span> <span class="n">ev_type</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">iio_event_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_VOLTAGE</span>:
	<span class="k">case</span> <span class="n">IIO_CURRENT</span>:
	<span class="k">case</span> <span class="n">IIO_POWER</span>:
	<span class="k">case</span> <span class="n">IIO_ACCEL</span>:
	<span class="k">case</span> <span class="n">IIO_ANGL_VEL</span>:
	<span class="k">case</span> <span class="n">IIO_MAGN</span>:
	<span class="k">case</span> <span class="n">IIO_LIGHT</span>:
	<span class="k">case</span> <span class="n">IIO_INTENSITY</span>:
	<span class="k">case</span> <span class="n">IIO_PROXIMITY</span>:
	<span class="k">case</span> <span class="n">IIO_TEMP</span>:
	<span class="k">case</span> <span class="n">IIO_INCLI</span>:
	<span class="k">case</span> <span class="n">IIO_ROT</span>:
	<span class="k">case</span> <span class="n">IIO_ANGL</span>:
	<span class="k">case</span> <span class="n">IIO_TIMESTAMP</span>:
	<span class="k">case</span> <span class="n">IIO_CAPACITANCE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_NO_MOD</span>:
	<span class="k">case</span> <span class="n">IIO_MOD_X</span>:
	<span class="k">case</span> <span class="n">IIO_MOD_Y</span>:
	<span class="k">case</span> <span class="n">IIO_MOD_Z</span>:
	<span class="k">case</span> <span class="n">IIO_MOD_LIGHT_BOTH</span>:
	<span class="k">case</span> <span class="n">IIO_MOD_LIGHT_IR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ev_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH</span>:
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG</span>:
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_ROC</span>:
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_DIR_EITHER</span>:
	<span class="k">case</span> <span class="n">IIO_EV_DIR_RISING</span>:
	<span class="k">case</span> <span class="n">IIO_EV_DIR_FALLING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_event_data</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">iio_chan_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN_TYPE</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">iio_modifier</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_MODIFIER</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">iio_event_type</span> <span class="n">ev_type</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">iio_event_direction</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chan2</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN2</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_DIFF</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event_is_known</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unknown event: time: %lld, id: %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Event: time: %lld, &quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mod</span> <span class="o">!=</span> <span class="n">IIO_NO_MOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;type: %s(%s), &quot;</span><span class="p">,</span>
			<span class="n">iio_chan_type_name_spec</span><span class="p">[</span><span class="n">type</span><span class="p">],</span>
			<span class="n">iio_modifier_names</span><span class="p">[</span><span class="n">mod</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;type: %s, &quot;</span><span class="p">,</span>
			<span class="n">iio_chan_type_name_spec</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">chan2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;channel: %d-%d, &quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">chan2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;channel: %d, &quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;evtype: %s, direction: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">iio_ev_type_text</span><span class="p">[</span><span class="n">ev_type</span><span class="p">],</span>
		<span class="n">iio_ev_dir_text</span><span class="p">[</span><span class="n">dir</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iio_event_data</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">chrdev_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">event_fd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: %s &lt;device_name&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">dev_num</span> <span class="o">=</span> <span class="n">find_type_by_name</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="s">&quot;iio:device&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Found IIO device with name %s with device number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">device_name</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chrdev_name</span><span class="p">,</span> <span class="s">&quot;/dev/iio:device%d&quot;</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If we can&#39;t find a IIO device by name assume device_name is a</span>
<span class="cm">		   IIO chrdev */</span>
		<span class="n">chrdev_name</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">device_name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">chrdev_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Failed to open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chrdev_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_chrdev_name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">IIO_GET_EVENT_FD_IOCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_fd</span><span class="p">);</span>

	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">event_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;Failed to retrieve event fd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_chrdev_name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">event_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;nothing available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Failed to read event from device&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">print_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">close</span><span class="p">(</span><span class="n">event_fd</span><span class="p">);</span>
<span class="nl">error_free_chrdev_name:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">chrdev_name</span><span class="p">);</span>
<span class="nl">error_ret:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
