<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › iio › Documentation › generic_buffer.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>generic_buffer.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Industrialio buffer test code.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 Jonathan Cameron</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is primarily intended as an example application.</span>
<span class="cm"> * Reads the current buffer setup from sysfs and starts a short capture</span>
<span class="cm"> * from the specified device, pretty printing the result after appropriate</span>
<span class="cm"> * conversion.</span>
<span class="cm"> *</span>
<span class="cm"> * Command line parameters</span>
<span class="cm"> * generic_buffer -n &lt;device_name&gt; -t &lt;trigger_name&gt;</span>
<span class="cm"> * If trigger name is not specified the program assumes you want a dataready</span>
<span class="cm"> * trigger associated with the device and goes looking for it.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;dirent.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;sys/dir.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;poll.h&gt;</span>
<span class="cp">#include &lt;endian.h&gt;</span>
<span class="cp">#include &quot;iio_utils.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * size_from_channelarray() - calculate the storage size of a scan</span>
<span class="cm"> * @channels: the channel info array</span>
<span class="cm"> * @num_channels: size of the channel info array</span>
<span class="cm"> *</span>
<span class="cm"> * Has the side effect of filling the channels[i].location values used</span>
<span class="cm"> * in processing the buffer output.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">size_from_channelarray</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_channel_info</span> <span class="o">*</span><span class="n">channels</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">%</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">location</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">location</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">bytes</span><span class="o">%</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes</span>
				<span class="o">+</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">location</span> <span class="o">+</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print2byte</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iio_channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* First swap if incorrect endian */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">be</span><span class="p">)</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">be16toh</span><span class="p">((</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">input</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">input</span> <span class="o">=</span> <span class="n">le16toh</span><span class="p">((</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">input</span><span class="p">);</span>

	<span class="cm">/* shift before conversion to avoid sign extension</span>
<span class="cm">	   of left aligned data */</span>
	<span class="n">input</span> <span class="o">=</span> <span class="n">input</span> <span class="o">&gt;&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_signed</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int16_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bits_used</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bits_used</span><span class="p">))</span> <span class="o">&gt;&gt;</span>
			<span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bits_used</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%05f  &quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">val</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">val</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bits_used</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%05f &quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">val</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * process_scan() - print out the values in SI units</span>
<span class="cm"> * @data:		pointer to the start of the scan</span>
<span class="cm"> * @infoarray:		information about the channels. Note</span>
<span class="cm"> *  size_from_channelarray must have been called first to fill the</span>
<span class="cm"> *  location offsets.</span>
<span class="cm"> * @num_channels:	the number of active channels</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">process_scan</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">iio_channel_info</span> <span class="o">*</span><span class="n">infoarray</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">num_channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_channels</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* only a few cases implemented so far */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">print2byte</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">location</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">is_signed</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int64_t</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int64_t</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="n">data</span> <span class="o">+</span>
					 <span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">location</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">bits_used</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span>
						<span class="o">~</span><span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
				<span class="cm">/* special case for timestamp */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">scale</span> <span class="o">==</span> <span class="mf">1.0f</span> <span class="o">&amp;&amp;</span>
				    <span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span> <span class="o">==</span> <span class="mf">0.0f</span><span class="p">)</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %lld&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%05f &quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">val</span> <span class="o">+</span>
							 <span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span><span class="p">)</span><span class="o">*</span>
					       <span class="n">infoarray</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">scale</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_loops</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timedelay</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>


	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">toread</span><span class="p">;</span>

	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp_ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fp</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">num_channels</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">trigger_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">device_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dev_dir_name</span><span class="p">,</span> <span class="o">*</span><span class="n">buf_dir_name</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">datardytrigger</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">read_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">trig_num</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer_access</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scan_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">noevents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dummy</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">iio_channel_info</span> <span class="o">*</span><span class="n">infoarray</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;l:w:c:et:n:&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
			<span class="n">device_name</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
			<span class="n">trigger_name</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="n">datardytrigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
			<span class="n">noevents</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="n">num_loops</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
			<span class="n">timedelay</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
			<span class="n">buf_len</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Find the device requested */</span>
	<span class="n">dev_num</span> <span class="o">=</span> <span class="n">find_type_by_name</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="s">&quot;iio:device&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to find the %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;iio device number being used is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>

	<span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_dir_name</span><span class="p">,</span> <span class="s">&quot;%siio:device%d&quot;</span><span class="p">,</span> <span class="n">iio_dir</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trigger_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Build the trigger name. If it is device associated it&#39;s</span>
<span class="cm">		 * name is &lt;device_name&gt;_dev[n] where n matches the device</span>
<span class="cm">		 * number found above</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trigger_name</span><span class="p">,</span>
			       <span class="s">&quot;%s-dev%d&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Verify the trigger exists */</span>
	<span class="n">trig_num</span> <span class="o">=</span> <span class="n">find_type_by_name</span><span class="p">(</span><span class="n">trigger_name</span><span class="p">,</span> <span class="s">&quot;trigger&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trig_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to find the trigger %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trigger_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_triggername</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;iio trigger number being used is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">trig_num</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Parse the files in scan_elements to identify what channels are</span>
<span class="cm">	 * present</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">build_channel_array</span><span class="p">(</span><span class="n">dev_dir_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">infoarray</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_channels</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Problem reading scan element information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;diag %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_dir_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free_triggername</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Construct the directory name for the associated buffer.</span>
<span class="cm">	 * As we know that the lis3l02dq has only one buffer this may</span>
<span class="cm">	 * be built rather than found.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_dir_name</span><span class="p">,</span>
		       <span class="s">&quot;%siio:device%d/buffer&quot;</span><span class="p">,</span> <span class="n">iio_dir</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_triggername</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_dir_name</span><span class="p">,</span> <span class="n">trigger_name</span><span class="p">);</span>
	<span class="cm">/* Set the device trigger to be the data rdy trigger found above */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_sysfs_string_and_verify</span><span class="p">(</span><span class="s">&quot;trigger/current_trigger&quot;</span><span class="p">,</span>
					<span class="n">dev_dir_name</span><span class="p">,</span>
					<span class="n">trigger_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to write current_trigger file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free_buf_dir_name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup ring buffer parameters */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_sysfs_int</span><span class="p">(</span><span class="s">&quot;length&quot;</span><span class="p">,</span> <span class="n">buf_dir_name</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free_buf_dir_name</span><span class="p">;</span>

	<span class="cm">/* Enable the buffer */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_sysfs_int</span><span class="p">(</span><span class="s">&quot;enable&quot;</span><span class="p">,</span> <span class="n">buf_dir_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free_buf_dir_name</span><span class="p">;</span>
	<span class="n">scan_size</span> <span class="o">=</span> <span class="n">size_from_channelarray</span><span class="p">(</span><span class="n">infoarray</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">scan_size</span><span class="o">*</span><span class="n">buf_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_buf_dir_name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_access</span><span class="p">,</span> <span class="s">&quot;/dev/iio:device%d&quot;</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Attempt to open non blocking the access dev */</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">buffer_access</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*If it isn&#39;t there make the node */</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_access</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_buffer_access</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for events 10 times */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_loops</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">noevents</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pfd</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fp</span><span class="p">,</span>
				<span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">,</span>
			<span class="p">};</span>

			<span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">toread</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">usleep</span><span class="p">(</span><span class="n">timedelay</span><span class="p">);</span>
			<span class="n">toread</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">read_size</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span>
				 <span class="n">data</span><span class="p">,</span>
				 <span class="n">toread</span><span class="o">*</span><span class="n">scan_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_size</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;nothing available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">read_size</span><span class="o">/</span><span class="n">scan_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">process_scan</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">scan_size</span><span class="o">*</span><span class="n">i</span><span class="p">,</span>
				     <span class="n">infoarray</span><span class="p">,</span>
				     <span class="n">num_channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Stop the ring buffer */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_sysfs_int</span><span class="p">(</span><span class="s">&quot;enable&quot;</span><span class="p">,</span> <span class="n">buf_dir_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_close_buffer_access</span><span class="p">;</span>

	<span class="cm">/* Disconnect from the trigger - just write a dummy name.*/</span>
	<span class="n">write_sysfs_string</span><span class="p">(</span><span class="s">&quot;trigger/current_trigger&quot;</span><span class="p">,</span>
			<span class="n">dev_dir_name</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">);</span>

<span class="nl">error_close_buffer_access:</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="nl">error_free_data:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">error_free_buffer_access:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buffer_access</span><span class="p">);</span>
<span class="nl">error_free_buf_dir_name:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">buf_dir_name</span><span class="p">);</span>
<span class="nl">error_free_triggername:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datardytrigger</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">trigger_name</span><span class="p">);</span>
<span class="nl">error_ret:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
