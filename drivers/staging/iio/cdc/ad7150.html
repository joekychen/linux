<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › iio › cdc › ad7150.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ad7150.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * AD7150 capacitive sensor driver supporting AD7150/1/6</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2010-2011 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/iio/iio.h&gt;</span>
<span class="cp">#include &lt;linux/iio/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/iio/events.h&gt;</span>
<span class="cm">/*</span>
<span class="cm"> * AD7150 registers definition</span>
<span class="cm"> */</span>

<span class="cp">#define AD7150_STATUS              0</span>
<span class="cp">#define AD7150_STATUS_OUT1         (1 &lt;&lt; 3)</span>
<span class="cp">#define AD7150_STATUS_OUT2         (1 &lt;&lt; 5)</span>
<span class="cp">#define AD7150_CH1_DATA_HIGH       1</span>
<span class="cp">#define AD7150_CH2_DATA_HIGH       3</span>
<span class="cp">#define AD7150_CH1_AVG_HIGH        5</span>
<span class="cp">#define AD7150_CH2_AVG_HIGH        7</span>
<span class="cp">#define AD7150_CH1_SENSITIVITY     9</span>
<span class="cp">#define AD7150_CH1_THR_HOLD_H      9</span>
<span class="cp">#define AD7150_CH1_TIMEOUT         10</span>
<span class="cp">#define AD7150_CH1_SETUP           11</span>
<span class="cp">#define AD7150_CH2_SENSITIVITY     12</span>
<span class="cp">#define AD7150_CH2_THR_HOLD_H      12</span>
<span class="cp">#define AD7150_CH2_TIMEOUT         13</span>
<span class="cp">#define AD7150_CH2_SETUP           14</span>
<span class="cp">#define AD7150_CFG                 15</span>
<span class="cp">#define AD7150_CFG_FIX             (1 &lt;&lt; 7)</span>
<span class="cp">#define AD7150_PD_TIMER            16</span>
<span class="cp">#define AD7150_CH1_CAPDAC          17</span>
<span class="cp">#define AD7150_CH2_CAPDAC          18</span>
<span class="cp">#define AD7150_SN3                 19</span>
<span class="cp">#define AD7150_SN2                 20</span>
<span class="cp">#define AD7150_SN1                 21</span>
<span class="cp">#define AD7150_SN0                 22</span>
<span class="cp">#define AD7150_ID                  23</span>

<span class="cm">/**</span>
<span class="cm"> * struct ad7150_chip_info - instance specific chip data</span>
<span class="cm"> * @client: i2c client for this device</span>
<span class="cm"> * @current_event: device always has one type of event enabled.</span>
<span class="cm"> *	This element stores the event code of the current one.</span>
<span class="cm"> * @threshold: thresholds for simple capacitance value events</span>
<span class="cm"> * @thresh_sensitivity: threshold for simple capacitance offset</span>
<span class="cm"> *	from &#39;average&#39; value.</span>
<span class="cm"> * @mag_sensitity: threshold for magnitude of capacitance offset from</span>
<span class="cm"> *	from &#39;average&#39; value.</span>
<span class="cm"> * @thresh_timeout: a timeout, in samples from the moment an</span>
<span class="cm"> *	adaptive threshold event occurs to when the average</span>
<span class="cm"> *	value jumps to current value.</span>
<span class="cm"> * @mag_timeout: a timeout, in sample from the moment an</span>
<span class="cm"> *	adaptive magnitude event occurs to when the average</span>
<span class="cm"> *	value jumps to the current value.</span>
<span class="cm"> * @old_state: store state from previous event, allowing confirmation</span>
<span class="cm"> *	of new condition.</span>
<span class="cm"> * @conversion_mode: the current conversion mode.</span>
<span class="cm"> * @state_lock: ensure consistent state of this structure wrt the</span>
<span class="cm"> *	hardware.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">current_event</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">thresh_sensitivity</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mag_sensitivity</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">thresh_timeout</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mag_timeout</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">old_state</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">conversion_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">state_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * sysfs nodes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ad7150_addresses</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AD7150_CH1_DATA_HIGH</span><span class="p">,</span> <span class="n">AD7150_CH1_AVG_HIGH</span><span class="p">,</span>
	  <span class="n">AD7150_CH1_SETUP</span><span class="p">,</span> <span class="n">AD7150_CH1_THR_HOLD_H</span><span class="p">,</span>
	  <span class="n">AD7150_CH1_SENSITIVITY</span><span class="p">,</span> <span class="n">AD7150_CH1_TIMEOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AD7150_CH2_DATA_HIGH</span><span class="p">,</span> <span class="n">AD7150_CH2_AVG_HIGH</span><span class="p">,</span>
	  <span class="n">AD7150_CH2_SETUP</span><span class="p">,</span> <span class="n">AD7150_CH2_THR_HOLD_H</span><span class="p">,</span>
	  <span class="n">AD7150_CH2_SENSITIVITY</span><span class="p">,</span> <span class="n">AD7150_CH2_TIMEOUT</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad7150_read_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iio_chan_spec</span> <span class="k">const</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="o">*</span><span class="n">val2</span><span class="p">,</span>
			   <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_CHAN_INFO_RAW</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_word_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">ad7150_addresses</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IIO_VAL_INT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_CHAN_INFO_AVERAGE_RAW</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_word_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">ad7150_addresses</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IIO_VAL_INT</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad7150_read_event_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">event_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">threshtype</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">adaptive</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rising</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IIO_EV_DIR_RISING</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">AD7150_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">threshtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">adaptive</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">event_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rising</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">adaptive</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">threshtype</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">adaptive</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">threshtype</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rising</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">adaptive</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">threshtype</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">adaptive</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">threshtype</span> <span class="o">==</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rising</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">adaptive</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">threshtype</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">adaptive</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">threshtype</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* lock should be held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad7150_write_event_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">event_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sens</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN</span><span class="p">(</span><span class="n">event_code</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rising</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IIO_EV_DIR_RISING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_code</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_event</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">event_code</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Note completely different from the adaptive versions */</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">threshold</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_word_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
						<span class="n">ad7150_addresses</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
						<span class="n">swab16</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="n">sens</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mag_sensitivity</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mag_timeout</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
		<span class="n">sens</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">thresh_sensitivity</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">thresh_timeout</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">ad7150_addresses</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
					<span class="n">sens</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">ad7150_addresses</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span>
					<span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad7150_write_event_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="n">event_code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">thresh_type</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">adaptive</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rising</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IIO_EV_DIR_RISING</span><span class="p">);</span>

	<span class="cm">/* Something must always be turned on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_code</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_event</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">AD7150_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">event_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="n">adaptive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rising</span><span class="p">)</span>
			<span class="n">thresh_type</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">thresh_type</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
		<span class="n">adaptive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rising</span><span class="p">)</span>
			<span class="n">thresh_type</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">thresh_type</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH</span>:
		<span class="n">adaptive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rising</span><span class="p">)</span>
			<span class="n">thresh_type</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">thresh_type</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="o">!</span><span class="n">adaptive</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">thresh_type</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">AD7150_CFG</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">current_event</span> <span class="o">=</span> <span class="n">event_code</span><span class="p">;</span>

	<span class="cm">/* update control attributes */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ad7150_write_event_params</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">,</span> <span class="n">event_code</span><span class="p">);</span>
<span class="nl">error_ret:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad7150_read_event_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">event_code</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN</span><span class="p">(</span><span class="n">event_code</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rising</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IIO_EV_DIR_RISING</span><span class="p">);</span>

	<span class="cm">/* Complex register sharing going on here */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">event_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mag_sensitivity</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">thresh_sensitivity</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">threshold</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad7150_write_event_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">event_code</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN</span><span class="p">(</span><span class="n">event_code</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rising</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">event_code</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IIO_EV_DIR_RISING</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">event_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mag_sensitivity</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">thresh_sensitivity</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">threshold</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* write back if active */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ad7150_write_event_params</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">,</span> <span class="n">event_code</span><span class="p">);</span>

<span class="nl">error_ret:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ad7150_show_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span> <span class="o">=</span> <span class="n">dev_to_iio_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iio_dev_attr</span> <span class="o">*</span><span class="n">this_attr</span> <span class="o">=</span> <span class="n">to_iio_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* use the event code for consistency reasons */</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN</span><span class="p">(</span><span class="n">this_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rising</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">this_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span>
			<span class="o">==</span> <span class="n">IIO_EV_DIR_RISING</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">this_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mag_timeout</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">thresh_timeout</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ad7150_store_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span> <span class="o">=</span> <span class="n">dev_to_iio_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iio_dev_attr</span> <span class="o">*</span><span class="n">this_attr</span> <span class="o">=</span> <span class="n">to_iio_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">IIO_EVENT_CODE_EXTRACT_CHAN</span><span class="p">(</span><span class="n">this_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rising</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_DIR</span><span class="p">(</span><span class="n">this_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">IIO_EV_DIR_RISING</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtou8</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">IIO_EVENT_CODE_EXTRACT_TYPE</span><span class="p">(</span><span class="n">this_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mag_timeout</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">thresh_timeout</span><span class="p">[</span><span class="n">rising</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ad7150_write_event_params</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">,</span> <span class="n">this_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
<span class="nl">error_ret:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AD7150_TIMEOUT(chan, type, dir, ev_type, ev_dir)		\</span>
<span class="cp">	IIO_DEVICE_ATTR(in_capacitance##chan##_##type##_##dir##_timeout, \</span>
<span class="cp">		S_IRUGO | S_IWUSR,					\</span>
<span class="cp">		&amp;ad7150_show_timeout,					\</span>
<span class="cp">		&amp;ad7150_store_timeout,					\</span>
<span class="cp">		IIO_UNMOD_EVENT_CODE(IIO_CAPACITANCE,			\</span>
<span class="cp">				     chan,				\</span>
<span class="cp">				     IIO_EV_TYPE_##ev_type,		\</span>
<span class="cp">				     IIO_EV_DIR_##ev_dir))</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mag_adaptive</span><span class="p">,</span> <span class="n">rising</span><span class="p">,</span> <span class="n">MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">RISING</span><span class="p">);</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mag_adaptive</span><span class="p">,</span> <span class="n">falling</span><span class="p">,</span> <span class="n">MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mag_adaptive</span><span class="p">,</span> <span class="n">rising</span><span class="p">,</span> <span class="n">MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">RISING</span><span class="p">);</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mag_adaptive</span><span class="p">,</span> <span class="n">falling</span><span class="p">,</span> <span class="n">MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">thresh_adaptive</span><span class="p">,</span> <span class="n">rising</span><span class="p">,</span> <span class="n">THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">RISING</span><span class="p">);</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">thresh_adaptive</span><span class="p">,</span> <span class="n">falling</span><span class="p">,</span> <span class="n">THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">thresh_adaptive</span><span class="p">,</span> <span class="n">rising</span><span class="p">,</span> <span class="n">THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">RISING</span><span class="p">);</span>
<span class="k">static</span> <span class="n">AD7150_TIMEOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">thresh_adaptive</span><span class="p">,</span> <span class="n">falling</span><span class="p">,</span> <span class="n">THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iio_chan_spec</span> <span class="n">ad7150_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IIO_CAPACITANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">indexed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info_mask</span> <span class="o">=</span> <span class="n">IIO_CHAN_INFO_RAW_SEPARATE_BIT</span> <span class="o">|</span>
		<span class="n">IIO_CHAN_INFO_AVERAGE_RAW_SEPARATE_BIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">event_mask</span> <span class="o">=</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span> <span class="n">IIO_EV_DIR_RISING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span> <span class="n">IIO_EV_DIR_FALLING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_RISING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_FALLING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_RISING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_FALLING</span><span class="p">)</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IIO_CAPACITANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">indexed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info_mask</span> <span class="o">=</span> <span class="n">IIO_CHAN_INFO_RAW_SEPARATE_BIT</span> <span class="o">|</span>
		<span class="n">IIO_CHAN_INFO_AVERAGE_RAW_SEPARATE_BIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">event_mask</span> <span class="o">=</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span> <span class="n">IIO_EV_DIR_RISING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span> <span class="n">IIO_EV_DIR_FALLING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_RISING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_THRESH_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_FALLING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_RISING</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IIO_EV_BIT</span><span class="p">(</span><span class="n">IIO_EV_TYPE_MAG_ADAPTIVE</span><span class="p">,</span> <span class="n">IIO_EV_DIR_FALLING</span><span class="p">)</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * threshold events</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ad7150_event_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span> <span class="o">=</span> <span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">int_status</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">iio_get_time_ns</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">AD7150_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">int_status</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_state</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT1</span><span class="p">))</span>
		<span class="n">iio_push_event</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">,</span>
			       <span class="n">IIO_UNMOD_EVENT_CODE</span><span class="p">(</span><span class="n">IIO_CAPACITANCE</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span>
						    <span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span>
						    <span class="n">IIO_EV_DIR_RISING</span><span class="p">),</span>
				<span class="n">timestamp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_state</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT1</span><span class="p">))</span>
		<span class="n">iio_push_event</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">,</span>
			       <span class="n">IIO_UNMOD_EVENT_CODE</span><span class="p">(</span><span class="n">IIO_CAPACITANCE</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span>
						    <span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span>
						    <span class="n">IIO_EV_DIR_FALLING</span><span class="p">),</span>
			       <span class="n">timestamp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_state</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT2</span><span class="p">))</span>
		<span class="n">iio_push_event</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">,</span>
			       <span class="n">IIO_UNMOD_EVENT_CODE</span><span class="p">(</span><span class="n">IIO_CAPACITANCE</span><span class="p">,</span>
						    <span class="mi">1</span><span class="p">,</span>
						    <span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span>
						    <span class="n">IIO_EV_DIR_RISING</span><span class="p">),</span>
			       <span class="n">timestamp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_state</span> <span class="o">&amp;</span> <span class="n">AD7150_STATUS_OUT2</span><span class="p">))</span>
		<span class="n">iio_push_event</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">,</span>
			       <span class="n">IIO_UNMOD_EVENT_CODE</span><span class="p">(</span><span class="n">IIO_CAPACITANCE</span><span class="p">,</span>
						    <span class="mi">1</span><span class="p">,</span>
						    <span class="n">IIO_EV_TYPE_THRESH</span><span class="p">,</span>
						    <span class="n">IIO_EV_DIR_FALLING</span><span class="p">),</span>
			       <span class="n">timestamp</span><span class="p">);</span>
	<span class="cm">/* store the status to avoid repushing same events */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_state</span> <span class="o">=</span> <span class="n">int_status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Timeouts not currently handled by core */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ad7150_event_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance0_mag_adaptive_rising_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance0_mag_adaptive_falling_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance1_mag_adaptive_rising_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance1_mag_adaptive_falling_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance0_thresh_adaptive_rising_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance0_thresh_adaptive_falling_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance1_thresh_adaptive_rising_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">iio_dev_attr_in_capacitance1_thresh_adaptive_falling_timeout</span>
	<span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">ad7150_event_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ad7150_event_attributes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;events&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iio_info</span> <span class="n">ad7150_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">event_attrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad7150_event_attribute_group</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_raw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad7150_read_raw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_event_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad7150_read_event_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_event_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad7150_write_event_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_event_value</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad7150_read_event_value</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_event_value</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad7150_write_event_value</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * device probe and remove</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ad7150_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad7150_chip_info</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span><span class="p">;</span>

	<span class="n">indio_dev</span> <span class="o">=</span> <span class="n">iio_device_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">indio_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="n">iio_priv</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>
	<span class="cm">/* this is only used for device removal purposes */</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">indio_dev</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">indio_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">indio_dev</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ad7150_channels</span><span class="p">;</span>
	<span class="n">indio_dev</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ad7150_channels</span><span class="p">);</span>
	<span class="cm">/* Establish that the iio_dev is a child of the i2c device */</span>
	<span class="n">indio_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">indio_dev</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad7150_info</span><span class="p">;</span>

	<span class="n">indio_dev</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">=</span> <span class="n">INDIO_DIRECT_MODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
					   <span class="nb">NULL</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">ad7150_event_handler</span><span class="p">,</span>
					   <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span>
					   <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
					   <span class="s">&quot;ad7150_irq1&quot;</span><span class="p">,</span>
					   <span class="n">indio_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span>
					   <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">,</span>
					   <span class="nb">NULL</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">ad7150_event_handler</span><span class="p">,</span>
					   <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span>
					   <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
					   <span class="s">&quot;ad7150_irq2&quot;</span><span class="p">,</span>
					   <span class="n">indio_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iio_device_register</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_free_irq2</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s capacitive sensor registered,irq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error_free_irq2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">,</span>
			 <span class="n">indio_dev</span><span class="p">);</span>
<span class="nl">error_free_irq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">indio_dev</span><span class="p">);</span>
<span class="nl">error_free_dev:</span>
	<span class="n">iio_device_free</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
<span class="nl">error_ret:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ad7150_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iio_dev</span> <span class="o">*</span><span class="n">indio_dev</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">iio_device_unregister</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">indio_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">,</span> <span class="n">indio_dev</span><span class="p">);</span>

	<span class="n">iio_device_free</span><span class="p">(</span><span class="n">indio_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ad7150_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ad7150&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ad7151&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ad7156&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ad7150_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ad7150_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ad7150&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ad7150_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ad7150_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ad7150_id</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">ad7150_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Barry Song &lt;21cnbao@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Analog Devices AD7150/1/6 capacitive sensor driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
