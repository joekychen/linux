<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8192e › rtllib_tx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rtllib_tx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>

<span class="cm">  Copyright(c) 2003 - 2004 Intel Corporation. All rights reserved.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms of version 2 of the GNU General Public License as</span>
<span class="cm">  published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm">  Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in the</span>
<span class="cm">  file called LICENSE.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  James P. Ketrenos &lt;ipw2100-admin@linux.intel.com&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">******************************************************************************</span>

<span class="cm">  Few modifications for Realtek&#39;s Wi-Fi drivers by</span>
<span class="cm">  Andrea Merello &lt;andreamrl@tiscali.it&gt;</span>

<span class="cm">  A special thanks goes to Realtek for their support !</span>

<span class="cm">******************************************************************************/</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/in6.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &quot;rtllib.h&quot;</span>

<span class="cm">/*</span>


<span class="cm">802.11 Data Frame</span>


<span class="cm">802.11 frame_control for data frames - 2 bytes</span>
<span class="cm">     ,-----------------------------------------------------------------------------------------.</span>
<span class="cm">bits | 0  |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  |  a  |  b  |  c  |  d  |  e   |</span>
<span class="cm">     |----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|------|</span>
<span class="cm">val  | 0  |  0  |  0  |  1  |  x  |  0  |  0  |  0  |  1  |  0  |  x  |  x  |  x  |  x  |  x   |</span>
<span class="cm">     |----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|------|</span>
<span class="cm">desc | ^-ver-^  |  ^type-^  |  ^-----subtype-----^  | to  |from |more |retry| pwr |more |wep   |</span>
<span class="cm">     |	  |	   | x=0 data,x=1 data+ack | DS  | DS  |frag |     | mgm |data |      |</span>
<span class="cm">     &#39;-----------------------------------------------------------------------------------------&#39;</span>
<span class="cm">						    /\</span>
<span class="cm">						    |</span>
<span class="cm">802.11 Data Frame				   |</span>
<span class="cm">	   ,--------- &#39;ctrl&#39; expands to &gt;-----------&#39;</span>
<span class="cm">	  |</span>
<span class="cm">      ,--&#39;---,-------------------------------------------------------------.</span>
<span class="cm">Bytes |  2   |  2   |    6    |    6    |    6    |  2   | 0..2312 |   4  |</span>
<span class="cm">      |------|------|---------|---------|---------|------|---------|------|</span>
<span class="cm">Desc. | ctrl | dura |  DA/RA  |   TA    |    SA   | Sequ |  Frame  |  fcs |</span>
<span class="cm">      |      | tion | (BSSID) |	 |	 | ence |  data   |      |</span>
<span class="cm">      `--------------------------------------------------|	 |------&#39;</span>
<span class="cm">Total: 28 non-data bytes				 `----.----&#39;</span>
<span class="cm">							      |</span>
<span class="cm">       .- &#39;Frame data&#39; expands to &lt;---------------------------&#39;</span>
<span class="cm">       |</span>
<span class="cm">       V</span>
<span class="cm">      ,---------------------------------------------------.</span>
<span class="cm">Bytes |  1   |  1   |    1    |    3     |  2   |  0-2304 |</span>
<span class="cm">      |------|------|---------|----------|------|---------|</span>
<span class="cm">Desc. | SNAP | SNAP | Control |Eth Tunnel| Type | IP      |</span>
<span class="cm">      | DSAP | SSAP |	 |	  |      | Packet  |</span>
<span class="cm">      | 0xAA | 0xAA |0x03 (UI)|0x00-00-F8|      |	 |</span>
<span class="cm">      `-----------------------------------------|	 |</span>
<span class="cm">Total: 8 non-data bytes			 `----.----&#39;</span>
<span class="cm">						     |</span>
<span class="cm">       .- &#39;IP Packet&#39; expands, if WEP enabled, to &lt;--&#39;</span>
<span class="cm">       |</span>
<span class="cm">       V</span>
<span class="cm">      ,-----------------------.</span>
<span class="cm">Bytes |  4  |   0-2296  |  4  |</span>
<span class="cm">      |-----|-----------|-----|</span>
<span class="cm">Desc. | IV  | Encrypted | ICV |</span>
<span class="cm">      |     | IP Packet |     |</span>
<span class="cm">      `-----------------------&#39;</span>
<span class="cm">Total: 8 non-data bytes</span>


<span class="cm">802.3 Ethernet Data Frame</span>

<span class="cm">      ,-----------------------------------------.</span>
<span class="cm">Bytes |   6   |   6   |  2   |  Variable |   4  |</span>
<span class="cm">      |-------|-------|------|-----------|------|</span>
<span class="cm">Desc. | Dest. | Source| Type | IP Packet |  fcs |</span>
<span class="cm">      |  MAC  |  MAC  |      |	   |      |</span>
<span class="cm">      `-----------------------------------------&#39;</span>
<span class="cm">Total: 18 non-data bytes</span>

<span class="cm">In the event that fragmentation is required, the incoming payload is split into</span>
<span class="cm">N parts of size ieee-&gt;fts.  The first fragment contains the SNAP header and the</span>
<span class="cm">remaining packets are just data.</span>

<span class="cm">If encryption is enabled, each fragment payload size is reduced by enough space</span>
<span class="cm">to add the prefix and postfix (IV and ICV totalling 8 bytes in the case of WEP)</span>
<span class="cm">So if you have 1500 bytes of payload with ieee-&gt;fts set to 500 without</span>
<span class="cm">encryption it will take 3 frames.  With WEP it will take 4 frames as the</span>
<span class="cm">payload of each frame is reduced to 492 bytes.</span>

<span class="cm">* SKB visualization</span>
<span class="cm">*</span>
<span class="cm">*  ,- skb-&gt;data</span>
<span class="cm">* |</span>
<span class="cm">* |    ETHERNET HEADER	,-&lt;-- PAYLOAD</span>
<span class="cm">* |			   |     14 bytes from skb-&gt;data</span>
<span class="cm">* |  2 bytes for Type --&gt; ,T. |     (sizeof ethhdr)</span>
<span class="cm">* |		       | | |</span>
<span class="cm">* |,-Dest.--. ,--Src.---. | | |</span>
<span class="cm">* |  6 bytes| | 6 bytes | | | |</span>
<span class="cm">* v	 | |	 | | | |</span>
<span class="cm">* 0	 | v       1 | v | v	   2</span>
<span class="cm">* 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5</span>
<span class="cm">*     ^     | ^	 | ^ |</span>
<span class="cm">*     |     | |	 | | |</span>
<span class="cm">*     |     | |	 | `T&#39; &lt;---- 2 bytes for Type</span>
<span class="cm">*     |     | |	 |</span>
<span class="cm">*     |     | &#39;---SNAP--&#39; &lt;-------- 6 bytes for SNAP</span>
<span class="cm">*     |     |</span>
<span class="cm">*     `-IV--&#39; &lt;-------------------- 4 bytes for IV (WEP)</span>
<span class="cm">*</span>
<span class="cm">*      SNAP HEADER</span>
<span class="cm">*</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">P802_1H_OUI</span><span class="p">[</span><span class="n">P80211_OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">RFC1042_OUI</span><span class="p">[</span><span class="n">P80211_OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rtllib_put_snap</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">h_proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_snap_hdr</span> <span class="o">*</span><span class="n">snap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">oui</span><span class="p">;</span>

	<span class="n">snap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_snap_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">ssap</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h_proto</span> <span class="o">==</span> <span class="mh">0x8137</span> <span class="o">||</span> <span class="n">h_proto</span> <span class="o">==</span> <span class="mh">0x80f3</span><span class="p">)</span>
		<span class="n">oui</span> <span class="o">=</span> <span class="n">P802_1H_OUI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oui</span> <span class="o">=</span> <span class="n">RFC1042_OUI</span><span class="p">;</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">oui</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">oui</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">snap</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">oui</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="n">SNAP_SIZE</span><span class="p">)</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">h_proto</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtllib_encrypt_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;=========&gt;%s(), crypt is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* To encrypt, frame format is:</span>
<span class="cm">	 * IV (4 bytes), clear payload (including SNAP), ICV (4 bytes) */</span>

	<span class="cm">/* Host-based IEEE 802.11 fragmentation for TX is not yet supported, so</span>
<span class="cm">	 * call both MSDU and MPDU encryption functions from here. */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_msdu</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_msdu</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_mpdu</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">encrypt_mpdu</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Encryption failed: len=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">.</span><span class="n">tx_discards</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtllib_txb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtllib_txb</span> <span class="o">*</span><span class="nf">rtllib_alloc_txb</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr_frags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txb_size</span><span class="p">,</span>
					   <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">txb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_txb</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_frags</span><span class="p">),</span>
		      <span class="n">gfp_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">txb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_txb</span><span class="p">));</span>
	<span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">txb</span><span class="o">-&gt;</span><span class="n">frag_size</span> <span class="o">=</span> <span class="n">txb_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">txb_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">nr_frags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="o">--</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">txb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtllib_classify</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bIsAmsdu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>

	<span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTLLIB_DEBUG_DATA</span><span class="p">(</span><span class="n">RTLLIB_DL_DATA</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x20</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x40</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x60</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x80</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xa0</span>:
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xc0</span>:
		<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xe0</span>:
		<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_tx_query_agg_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_hi_throughput</span> <span class="o">*</span><span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ts_record</span> <span class="o">*</span><span class="n">pTxTs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_1addr</span><span class="o">*</span> <span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_1addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtllib_act_scanning</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">||</span> <span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsQoSDataFrame</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bdhcp</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">CntAfterLink</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span> <span class="n">HT_IOT_ACT_TX_NO_AGGREGATION</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">GetNmodeSupportBySecCfg</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentAMPDUEnable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetTs</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ts_common_info</span> <span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTxTs</span><span class="p">),</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">,</span> <span class="n">TX_DIR</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: can&#39;t get TS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxAdmittedBARecord</span><span class="p">.</span><span class="n">bValid</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">==</span>
			    <span class="n">KEY_TYPE_NA</span><span class="p">))</span> <span class="p">{</span>
				<span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bdhcp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bDisable_AddBa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TsStartAddBaProcess</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pTxTs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">FORCED_AGG_SETTING</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bUsingBa</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SN_LESS</span><span class="p">(</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxAdmittedBARecord</span><span class="p">.</span><span class="n">BaStartSeqCtrl</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">SeqNum</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">TxCurSeq</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4096</span><span class="p">))</span>
				<span class="n">pTxTs</span><span class="o">-&gt;</span><span class="n">bUsingBa</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">FORCED_AGG_SETTING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bAMPDUEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">CurrentAMPDUFactor</span><span class="p">;</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">CurrentMPDUDensity</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">FORCED_AGG_SETTING:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">ForcedAMPDUMode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HT_AGG_AUTO</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HT_AGG_FORCE_ENABLE</span>:
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bAMPDUEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">ForcedMPDUDensity</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">ForcedAMPDUFactor</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HT_AGG_FORCE_DISABLE</span>:
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bAMPDUEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_qurey_ShortPreambleMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortPreamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span>
		 <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortPreamble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_query_HTCapShortGI</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_hi_throughput</span> <span class="o">*</span><span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>

	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortGI</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">||</span> <span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bForcedShortGI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortGI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurBW40MHz</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurShortGI40MHz</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortGI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurBW40MHz</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurShortGI20MHz</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortGI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_query_BandwidthMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_hi_throughput</span> <span class="o">*</span><span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>

	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bPacketBW</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">||</span> <span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bMulticast</span> <span class="o">||</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bBroadcast</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurBW40MHz</span> <span class="o">&amp;&amp;</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurTxBW40MHz</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bandwidth_auto_switch</span><span class="p">.</span><span class="n">bforced_tx20Mhz</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bPacketBW</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_query_protectionmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSSTBC</span>			<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSUseShortGI</span>		<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCTSEnable</span>			<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RTSSC</span>				<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSBW</span>			<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bBroadcast</span> <span class="o">||</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bMulticast</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">16</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="n">IEEE_N_24G</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span> <span class="o">=</span> <span class="n">MGN_24M</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">buseprotection</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span> <span class="o">=</span> <span class="n">MGN_24M</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rt_hi_throughput</span> <span class="o">*</span><span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span> <span class="n">HT_IOT_ACT_FORCED_CTS2SELF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCTSEnable</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span>  <span class="o">=</span>	<span class="n">MGN_24M</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HT_IOT_ACT_FORCED_RTS</span> <span class="o">|</span>
				   <span class="n">HT_IOT_ACT_PURE_N_MODE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span>  <span class="o">=</span>	<span class="n">MGN_24M</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">buseprotection</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span> <span class="o">=</span> <span class="n">MGN_24M</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span>  <span class="o">&amp;&amp;</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">HTOpMode</span> <span class="o">=</span> <span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">CurrentOpMode</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurBW40MHz</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">HTOpMode</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span>
				     <span class="n">HTOpMode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="o">||</span>
				     <span class="p">(</span><span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurBW40MHz</span> <span class="o">&amp;&amp;</span> <span class="n">HTOpMode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span> <span class="o">=</span> <span class="n">MGN_24M</span><span class="p">;</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span> <span class="o">=</span> <span class="n">MGN_24M</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bAMPDUEnable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span> <span class="o">=</span> <span class="n">MGN_24M</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">NO_PROTECTION</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bUseShortPreamble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">NO_PROTECTION</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">NO_PROTECTION:</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSEnable</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bCTSEnable</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">rts_rate</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RTSSC</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bRTSBW</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_txrate_selectmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span>
		    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">rtllib_query_seqnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">seqnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IsQoSDataFrame</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_ts_record</span> <span class="o">*</span><span class="n">pTS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetTs</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ts_common_info</span> <span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">pTS</span><span class="p">),</span> <span class="n">dst</span><span class="p">,</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">,</span> <span class="n">TX_DIR</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">seqnum</span> <span class="o">=</span> <span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TxCurSeq</span><span class="p">;</span>
		<span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TxCurSeq</span> <span class="o">=</span> <span class="p">(</span><span class="n">pTS</span><span class="o">-&gt;</span><span class="n">TxCurSeq</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">4096</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">seqnum</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wme_downgrade_ac</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">6</span>:
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* VO -&gt; VI */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* VI -&gt; BE */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* BE -&gt; BK */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtllib_xmit_inter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="p">)</span>
				     <span class="n">netdev_priv_rsl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtllib_txb</span> <span class="o">*</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addrqos</span> <span class="o">*</span><span class="n">frag_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bytes_per_frag</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">,</span> <span class="n">bytes_last_frag</span><span class="p">,</span> <span class="n">frag_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ether_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">qos_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_frag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addrqos</span> <span class="n">header</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* Ensure zero initialized */</span>
		<span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">qos_ctl</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">qos_actived</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bIsMulticast</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">IsAmsdu</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bdhcp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* If there is no driver handler to take the TXB, don&#39;t bother</span>
<span class="cm">	 * creating it... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hard_start_xmit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span>
	   <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">))</span> <span class="o">||</span>
	   <span class="p">((</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: No xmit handler.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">raw_tx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too small (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Save source and destination addresses */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
		<span class="n">ether_type</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txb</span> <span class="o">=</span> <span class="n">rtllib_alloc_txb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not allocate &quot;</span>
				       <span class="s">&quot;TXB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">txb</span><span class="o">-&gt;</span><span class="n">encrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">282</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ETH_P_IP</span> <span class="o">==</span> <span class="n">ether_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="mi">14</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IPPROTO_UDP</span> <span class="o">==</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="n">udp</span><span class="p">;</span>

					<span class="n">udp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span> <span class="o">+</span>
					      <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(((((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">udp</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">68</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					   <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">udp</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">67</span><span class="p">))</span> <span class="o">||</span>
					   <span class="p">((((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">udp</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">67</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					   <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">udp</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">68</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">bdhcp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LPSDelayCnt</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ETH_P_ARP</span> <span class="o">==</span> <span class="n">ether_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;=================&gt;DHCP &quot;</span>
				       <span class="s">&quot;Protocol start tx ARP pkt!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bdhcp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LPSDelayCnt</span> <span class="o">=</span>
					 <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">tim</span><span class="p">.</span><span class="n">tim_count</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">rtllib_classify</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IsAmsdu</span><span class="p">);</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
		<span class="n">encrypt</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ether_type</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">&amp;&amp;</span> <span class="n">ether_type</span> <span class="o">!=</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">ether_type</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="n">eap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eapol</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">)</span> <span class="o">-</span> <span class="n">SNAP_SIZE</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
			<span class="n">RTLLIB_DEBUG_EAP</span><span class="p">(</span><span class="s">&quot;TX: IEEE 802.11 EAPOL frame: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">eap_get_type</span><span class="p">(</span><span class="n">eap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Advance the SKB to the start of the payload */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">));</span>

		<span class="cm">/* Determine total amount of storage required for TXB packets */</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
			<span class="n">fc</span> <span class="o">=</span> <span class="n">RTLLIB_FTYPE_DATA</span> <span class="o">|</span> <span class="n">RTLLIB_FCTL_WEP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fc</span> <span class="o">=</span> <span class="n">RTLLIB_FTYPE_DATA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qos_actived</span><span class="p">)</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">RTLLIB_STYPE_QOS_DATA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">RTLLIB_STYPE_DATA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fc</span> <span class="o">|=</span> <span class="n">RTLLIB_FCTL_TODS</span><span class="p">;</span>
			<span class="cm">/* To DS: Addr1 = BSSID, Addr2 = SA,</span>
<span class="cm">			Addr3 = DA */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
			       <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IsAmsdu</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span>
				       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not From/To DS: Addr1 = DA, Addr2 = SA,</span>
<span class="cm">			Addr3 = BSSID */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
			       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bIsMulticast</span> <span class="o">=</span> <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">);</span>

		<span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

		<span class="cm">/* Determine fragmentation size based on destination (multicast</span>
<span class="cm">		* and broadcast are not fragmented) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bIsMulticast</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frag_size</span> <span class="o">=</span> <span class="n">MAX_FRAG_THRESHOLD</span><span class="p">;</span>
			<span class="n">qos_ctl</span> <span class="o">|=</span> <span class="n">QOS_CTL_NOTCONTAIN_ACK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">frag_size</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">fts</span><span class="p">;</span>
			<span class="n">qos_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qos_actived</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">RTLLIB_3ADDR_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* in case we are a client verify acm is not set for this ac */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wmm_acm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;skb-&gt;priority = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wme_downgrade_ac</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;converted skb-&gt;priority = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
		 <span class="p">}</span>
			<span class="n">qos_ctl</span> <span class="o">|=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
			<span class="n">header</span><span class="p">.</span><span class="n">qos_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qos_ctl</span> <span class="o">&amp;</span> <span class="n">RTLLIB_QOS_TID</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">RTLLIB_3ADDR_LEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Determine amount of payload per fragment.  Regardless of if</span>
<span class="cm">		 * this stack is providing the full 802.11 header, one will</span>
<span class="cm">		 * eventually be affixed to this fragment -- so we must account</span>
<span class="cm">		 * for it when determining the amount of payload space. */</span>
		<span class="n">bytes_per_frag</span> <span class="o">=</span> <span class="n">frag_size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">CFG_RTLLIB_COMPUTE_FCS</span> <span class="o">|</span> <span class="n">CFG_RTLLIB_RESERVE_FCS</span><span class="p">))</span>
			<span class="n">bytes_per_frag</span> <span class="o">-=</span> <span class="n">RTLLIB_FCS_LEN</span><span class="p">;</span>

		<span class="cm">/* Each fragment may need to have room for encrypting</span>
<span class="cm">		 * pre/postfix */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes_per_frag</span> <span class="o">-=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_mpdu_prefix_len</span> <span class="o">+</span>
				<span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_mpdu_postfix_len</span> <span class="o">+</span>
				<span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_msdu_prefix_len</span> <span class="o">+</span>
				<span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_msdu_postfix_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Number of fragments is the total bytes_per_frag /</span>
<span class="cm">		* payload_per_fragment */</span>
		<span class="n">nr_frags</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="n">bytes_per_frag</span><span class="p">;</span>
		<span class="n">bytes_last_frag</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">%</span> <span class="n">bytes_per_frag</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_last_frag</span><span class="p">)</span>
			<span class="n">nr_frags</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bytes_last_frag</span> <span class="o">=</span> <span class="n">bytes_per_frag</span><span class="p">;</span>

		<span class="cm">/* When we allocate the TXB we allocate enough space for the</span>
<span class="cm">		 * reserve and full fragment bytes (bytes_per_frag doesn&#39;t</span>
<span class="cm">		 * include prefix, postfix, header, FCS, etc.) */</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="n">rtllib_alloc_txb</span><span class="p">(</span><span class="n">nr_frags</span><span class="p">,</span> <span class="n">frag_size</span> <span class="o">+</span>
				       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not allocate TXB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">encrypted</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">;</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qos_actived</span><span class="p">)</span>
			<span class="n">txb</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">txb</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">WME_AC_BE</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_frag</span> <span class="o">=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb_frag</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span>
				    <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qos_actived</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_frag</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span>  <span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb_frag</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">WME_AC_BE</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">WME_AC_BE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hwsec_active</span><span class="p">)</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bHwSec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bHwSec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span>
					    <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_mpdu_prefix_len</span> <span class="o">+</span>
					    <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_msdu_prefix_len</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bHwSec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">frag_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addrqos</span> <span class="o">*</span><span class="p">)</span>
				   <span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">frag_hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

			<span class="cm">/* If this is not the last fragment, then add the</span>
<span class="cm">			 * MOREFRAGS bit to the frame control */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
					<span class="n">fc</span> <span class="o">|</span> <span class="n">RTLLIB_FCTL_MOREFRAGS</span><span class="p">);</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes_per_frag</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* The last fragment has the remaining length */</span>
				<span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes_last_frag</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">qos_actived</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">bIsMulticast</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span>
					 <span class="n">rtllib_query_seqnum</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb_frag</span><span class="p">,</span>
							     <span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">);</span>
				<span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span>
					 <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="o">&lt;&lt;</span><span class="mi">4</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">frag_hdr</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span>
					 <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">4</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Put a SNAP header on the first fragment */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtllib_put_snap</span><span class="p">(</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)),</span> <span class="n">ether_type</span><span class="p">);</span>
				<span class="n">bytes</span> <span class="o">-=</span> <span class="n">SNAP_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="n">bytes</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

			<span class="cm">/* Advance the SKB... */</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

			<span class="cm">/* Encryption routine will move the header forward in</span>
<span class="cm">			 * order to insert the IV between the header and the</span>
<span class="cm">			 * payload */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
				<span class="n">rtllib_encrypt_fragment</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb_frag</span><span class="p">,</span>
							<span class="n">hdr_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">&amp;</span>
			   <span class="p">(</span><span class="n">CFG_RTLLIB_COMPUTE_FCS</span> <span class="o">|</span> <span class="n">CFG_RTLLIB_RESERVE_FCS</span><span class="p">))</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb_frag</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">qos_actived</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">bIsMulticast</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">UP2AC</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too small (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txb</span> <span class="o">=</span> <span class="n">rtllib_alloc_txb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could not allocate TXB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">encrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">success:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxEnableFwCalcDur</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ether_type</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span>
			    <span class="n">HT_IOT_ACT_WA_IOT_Broadcom</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span>
					 <span class="n">MgntQuery_TxRateExcludeCCKRates</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>


			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">))</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bMulticast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">))</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bBroadcast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rtllib_txrate_selectmode</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bMulticast</span> <span class="o">||</span>  <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bBroadcast</span><span class="p">)</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">CURRENT_RATE</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">HTCurrentOperaRate</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bdhcp</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span>
				    <span class="n">HT_IOT_ACT_WA_IOT_Broadcom</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span>
					   <span class="n">MgntQuery_TxRateExcludeCCKRates</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">MGN_1M</span><span class="p">;</span>
					<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>


				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bdhcp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rtllib_qurey_ShortPreambleMode</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">);</span>
			<span class="n">rtllib_tx_query_agg_cap</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="n">tcb_desc</span><span class="p">);</span>
			<span class="n">rtllib_query_HTCapShortGI</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">);</span>
			<span class="n">rtllib_query_BandwidthMode</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">);</span>
			<span class="n">rtllib_query_protectionmode</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">,</span>
						    <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span><span class="p">;</span>
			<span class="n">rtllib_softmac_xmit</span><span class="p">(</span><span class="n">txb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hard_start_xmit</span><span class="p">)(</span><span class="n">txb</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">payload_size</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rtllib_txb_free</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">failed:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>
<span class="kt">int</span> <span class="nf">rtllib_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rtllib_xmit_inter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_xmit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
