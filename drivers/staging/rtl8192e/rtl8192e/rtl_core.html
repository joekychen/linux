<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8192e › rtl8192e › rtl_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rtl_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * Copyright(c) 2008 - 2010 Realtek Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the r8180 driver, which is:</span>
<span class="cm"> * Copyright 2004-2005 Andrea Merello &lt;andreamrl@tiscali.it&gt;, et al.</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * wlanfae &lt;wlanfae@realtek.com&gt;</span>
<span class="cm">******************************************************************************/</span>
<span class="cp">#undef RX_DONT_PASS_UL</span>
<span class="cp">#undef DEBUG_EPROM</span>
<span class="cp">#undef DEBUG_RX_VERBOSE</span>
<span class="cp">#undef DUMMY_RX</span>
<span class="cp">#undef DEBUG_ZERO_RX</span>
<span class="cp">#undef DEBUG_RX_SKB</span>
<span class="cp">#undef DEBUG_TX_FRAG</span>
<span class="cp">#undef DEBUG_RX_FRAG</span>
<span class="cp">#undef DEBUG_TX_FILLDESC</span>
<span class="cp">#undef DEBUG_TX</span>
<span class="cp">#undef DEBUG_IRQ</span>
<span class="cp">#undef DEBUG_RX</span>
<span class="cp">#undef DEBUG_RXALLOC</span>
<span class="cp">#undef DEBUG_REGISTERS</span>
<span class="cp">#undef DEBUG_RING</span>
<span class="cp">#undef DEBUG_IRQ_TASKLET</span>
<span class="cp">#undef DEBUG_TX_ALLOC</span>
<span class="cp">#undef DEBUG_TX_DESC</span>

<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &quot;rtl_core.h&quot;</span>
<span class="cp">#include &quot;r8192E_phy.h&quot;</span>
<span class="cp">#include &quot;r8192E_phyreg.h&quot;</span>
<span class="cp">#include &quot;r8190P_rtl8256.h&quot;</span>
<span class="cp">#include &quot;r8192E_cmdpkt.h&quot;</span>

<span class="cp">#include &quot;rtl_wx.h&quot;</span>
<span class="cp">#include &quot;rtl_dm.h&quot;</span>

<span class="cp">#include &quot;rtl_pm.h&quot;</span>

<span class="kt">int</span> <span class="n">hwwep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">channels</span> <span class="o">=</span> <span class="mh">0x3fff</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span> <span class="o">=</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">;</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">rtl819x_ops</span> <span class="n">rtl819xp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nic_type</span>			<span class="o">=</span> <span class="n">NIC_8192E</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_size</span>		<span class="o">=</span> <span class="n">rtl8192_get_eeprom_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_adapter_variable</span>		<span class="o">=</span> <span class="n">rtl8192_InitializeVariables</span><span class="p">,</span>
	<span class="p">.</span><span class="n">initialize_adapter</span>		<span class="o">=</span> <span class="n">rtl8192_adapter_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_change</span>			<span class="o">=</span> <span class="n">rtl8192_link_change</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fill_descriptor</span>		<span class="o">=</span> <span class="n">rtl8192_tx_fill_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fill_cmd_descriptor</span>		<span class="o">=</span> <span class="n">rtl8192_tx_fill_cmd_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_query_status_descriptor</span>	<span class="o">=</span> <span class="n">rtl8192_rx_query_status_desc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_command_packet_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_adapter</span>			<span class="o">=</span> <span class="n">rtl8192_halt_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_ratr_table</span>		<span class="o">=</span> <span class="n">rtl8192_update_ratr_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_enable</span>			<span class="o">=</span> <span class="n">rtl8192_EnableInterrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span>			<span class="o">=</span> <span class="n">rtl8192_DisableInterrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_clear</span>			<span class="o">=</span> <span class="n">rtl8192_ClearInterrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_enable</span>			<span class="o">=</span> <span class="n">rtl8192_enable_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_enable</span>			<span class="o">=</span> <span class="n">rtl8192_enable_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_recognized</span>		<span class="o">=</span> <span class="n">rtl8192_interrupt_recognized</span><span class="p">,</span>
	<span class="p">.</span><span class="n">TxCheckStuckHandler</span>		<span class="o">=</span> <span class="n">rtl8192_HalTxCheckStuck</span><span class="p">,</span>
	<span class="p">.</span><span class="n">RxCheckStuckHandler</span>		<span class="o">=</span> <span class="n">rtl8192_HalRxCheckStuck</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">rtl8192_pci_id_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">RTL_PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10ec</span><span class="p">,</span> <span class="mh">0x8192</span><span class="p">,</span> <span class="n">rtl819xp_ops</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">RTL_PCI_DEVICE</span><span class="p">(</span><span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span> <span class="n">rtl819xp_ops</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">RTL_PCI_DEVICE</span><span class="p">(</span><span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x0047</span><span class="p">,</span> <span class="n">rtl819xp_ops</span><span class="p">)},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">rtl8192_pci_id_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">rtl8192_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">rtl8192_pci_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">rtl8192_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>	<span class="cm">/* Driver name   */</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">rtl8192_pci_id_tbl</span><span class="p">,</span>	<span class="cm">/* PCI_ID table  */</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">rtl8192_pci_probe</span><span class="p">,</span>	<span class="cm">/* probe fn      */</span>
	<span class="p">.</span><span class="n">remove</span>	 <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">rtl8192_pci_disconnect</span><span class="p">),</span>	<span class="cm">/* remove fn */</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">rtl8192E_suspend</span><span class="p">,</span>	<span class="cm">/* PM suspend fn */</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">rtl8192E_resume</span><span class="p">,</span>                 <span class="cm">/* PM resume fn  */</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">   -----------------------------IO STUFF-------------------------</span>
<span class="cm">*****************************************************************************/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">PlatformIOCheckPageLegalAndGetRegMask</span><span class="p">(</span><span class="n">u32</span> <span class="n">u4bPage</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pu1bPageMask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span>		<span class="n">bReturn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pu1bPageMask</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">u4bPage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="k">case</span> <span class="mi">2</span>: <span class="k">case</span> <span class="mi">3</span>: <span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">8</span>: <span class="k">case</span> <span class="mi">9</span>: <span class="k">case</span> <span class="mi">10</span>: <span class="k">case</span> <span class="mi">12</span>: <span class="k">case</span> <span class="mi">13</span>:
		<span class="n">bReturn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pu1bPageMask</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bReturn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bReturn</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_io_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u8</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">u4bPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1PageMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u4bPage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">y</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="n">PlatformIOCheckPageLegalAndGetRegMask</span><span class="p">(</span><span class="n">u4bPage</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">u1PageMask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bIsLegalPage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">u1bPsr</span> <span class="o">=</span> <span class="n">read_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>

			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">((</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u4bPage</span><span class="p">));</span>
			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">y</span><span class="p">);</span>
			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_io_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">u4bPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1PageMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u4bPage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="n">PlatformIOCheckPageLegalAndGetRegMask</span><span class="p">(</span><span class="n">u4bPage</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">u1PageMask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bIsLegalPage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">u1bPsr</span> <span class="o">=</span> <span class="n">read_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>

			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">((</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u4bPage</span><span class="p">));</span>
			<span class="n">write_nic_io_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">y</span><span class="p">);</span>
			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">));</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_io_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">u4bPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1PageMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u4bPage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="n">PlatformIOCheckPageLegalAndGetRegMask</span><span class="p">(</span><span class="n">u4bPage</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">u1PageMask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bIsLegalPage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">u1bPsr</span> <span class="o">=</span> <span class="n">read_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>

			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">((</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u4bPage</span><span class="p">));</span>
			<span class="n">write_nic_io_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">y</span><span class="p">);</span>
			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">read_nic_io_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">u4bPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1PageMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">Data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u4bPage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mh">0xff</span><span class="o">&amp;</span><span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="n">PlatformIOCheckPageLegalAndGetRegMask</span><span class="p">(</span><span class="n">u4bPage</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">u1PageMask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bIsLegalPage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">u1bPsr</span> <span class="o">=</span> <span class="n">read_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>

			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">((</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u4bPage</span><span class="p">));</span>
			<span class="n">Data</span> <span class="o">=</span> <span class="n">read_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">Data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">read_nic_io_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">u4bPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1PageMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">Data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u4bPage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="n">PlatformIOCheckPageLegalAndGetRegMask</span><span class="p">(</span><span class="n">u4bPage</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">u1PageMask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bIsLegalPage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">u1bPsr</span> <span class="o">=</span> <span class="n">read_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>

			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">((</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u4bPage</span><span class="p">));</span>
			<span class="n">Data</span> <span class="o">=</span> <span class="n">read_nic_io_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">));</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">Data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">read_nic_io_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">u4bPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">u1PageMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">Data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u4bPage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bIsLegalPage</span> <span class="o">=</span> <span class="n">PlatformIOCheckPageLegalAndGetRegMask</span><span class="p">(</span><span class="n">u4bPage</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">u1PageMask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bIsLegalPage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">u1bPsr</span> <span class="o">=</span> <span class="n">read_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>

			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">((</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">u4bPage</span><span class="p">));</span>
			<span class="n">Data</span> <span class="o">=</span> <span class="n">read_nic_io_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
			<span class="n">write_nic_io_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PSR</span><span class="p">,</span> <span class="p">(</span><span class="n">u1bPsr</span> <span class="o">&amp;</span> <span class="n">u1PageMask</span><span class="p">));</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">Data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">read_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">readb</span><span class="p">((</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">read_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">((</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">read_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">((</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u8</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u32</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_nic_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">x</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">   -----------------------------GENERAL FUNCTION-------------------------</span>
<span class="cm">*****************************************************************************/</span>
<span class="n">bool</span> <span class="nf">MgntActSet_RF_State</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">rt_rf_power_state</span> <span class="n">StateToSet</span><span class="p">,</span>
			 <span class="n">RT_RF_CHANGE_SOURCE</span> <span class="n">ChangeSource</span><span class="p">,</span>
			 <span class="n">bool</span>	<span class="n">ProtectOrNot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">bConnectBySSID</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">rt_rf_power_state</span> <span class="n">rtState</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">RFWaitCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_PS</span> <span class="o">|</span> <span class="n">COMP_RF</span><span class="p">),</span> <span class="s">&quot;===&gt;MgntActSet_RF_State(): &quot;</span>
		 <span class="s">&quot;StateToSet(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">StateToSet</span><span class="p">);</span>

	<span class="n">ProtectOrNot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ProtectOrNot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
				<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_PS</span> <span class="o">|</span> <span class="n">COMP_RF</span><span class="p">),</span>
					 <span class="s">&quot;MgntActSet_RF_State(): RF Change in &quot;</span>
					 <span class="s">&quot;progress! Wait to set..StateToSet&quot;</span>
					 <span class="s">&quot;(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">StateToSet</span><span class="p">);</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RFWaitCounter</span><span class="o">++</span><span class="p">;</span>
					<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_PS</span> <span class="o">|</span> <span class="n">COMP_RF</span><span class="p">),</span>
						 <span class="s">&quot;MgntActSet_RF_State(): Wait 1&quot;</span>
						 <span class="s">&quot; ms (%d times)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">RFWaitCounter</span><span class="p">);</span>
					<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">RFWaitCounter</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;MgntActSet_&quot;</span>
							 <span class="s">&quot;RF_State(): Wait too &quot;</span>
							 <span class="s">&quot;logn to set RF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtState</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">StateToSet</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eRfOn</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">ChangeSource</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ChangeSource</span> <span class="o">==</span> <span class="n">RF_CHANGE_BY_HW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">rtState</span> <span class="o">==</span> <span class="n">eRfOff</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ChangeSource</span> <span class="o">&gt;=</span> <span class="n">RF_CHANGE_BY_HW</span><span class="p">)</span>
				<span class="n">bConnectBySSID</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_PS</span> <span class="o">|</span> <span class="n">COMP_RF</span><span class="p">),</span> <span class="s">&quot;MgntActSet_RF_State - &quot;</span>
				 <span class="s">&quot;eRfon reject pMgntInfo-&gt;RfOffReason= 0x%x,&quot;</span>
				 <span class="s">&quot; ChangeSource=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">,</span> <span class="n">ChangeSource</span><span class="p">);</span>
	<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">eRfOff</span>:

		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">&gt;</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">ChangeSource</span> <span class="o">&gt;</span> <span class="n">RF_CHANGE_BY_IPS</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">blinked_ingpio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">blinked_ingpio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">rtllib_MgntDisconnect</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span>
						      <span class="n">disas_lv_ss</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ChangeSource</span> <span class="o">==</span> <span class="n">RF_CHANGE_BY_HW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">==</span> <span class="nb">false</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">|=</span> <span class="n">ChangeSource</span><span class="p">;</span>
		<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">eRfSleep</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">|=</span> <span class="n">ChangeSource</span><span class="p">;</span>
		<span class="n">bActionAllowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bActionAllowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_PS</span> <span class="o">|</span> <span class="n">COMP_RF</span><span class="p">),</span> <span class="s">&quot;MgntActSet_RF_State(): Action is&quot;</span>
			 <span class="s">&quot; allowed.... StateToSet(%d), RfOffReason(%#X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">StateToSet</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">);</span>
		<span class="n">PHY_SetRFPowerState</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">StateToSet</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">StateToSet</span> <span class="o">==</span> <span class="n">eRfOn</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bConnectBySSID</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">blinked_ingpio</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">blinked_ingpio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_PS</span> <span class="o">|</span> <span class="n">COMP_RF</span><span class="p">),</span> <span class="s">&quot;MgntActSet_RF_State(): &quot;</span>
			 <span class="s">&quot;Action is rejected.... StateToSet(%d), ChangeSource&quot;</span>
			 <span class="s">&quot;(%#X), RfOffReason(%#X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">StateToSet</span><span class="p">,</span> <span class="n">ChangeSource</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ProtectOrNot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">((</span><span class="n">COMP_PS</span> <span class="o">|</span> <span class="n">COMP_RF</span><span class="p">),</span> <span class="s">&quot;&lt;===MgntActSet_RF_State()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bActionAllowed</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">short</span> <span class="nf">rtl8192_get_nic_desc_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>

	<span class="cm">/* For now, we reserved two free descriptor as a safety boundary</span>
<span class="cm">	* between the tail and the head</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">prio</span> <span class="o">==</span> <span class="n">MGNT_QUEUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;-----[%d]---------ring-&gt;idx=%d &quot;</span>
			 <span class="s">&quot;queue_len=%d---------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
			 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">rtl8192_check_nic_enough_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">-</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;TXTIMEOUT&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_set_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_CH</span><span class="p">,</span> <span class="s">&quot;=====&gt;%s()====ch:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan_forced</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_update_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">ShortPreamble</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dot11CurrentPreambleMode</span> <span class="o">!=</span> <span class="n">PREAMBLE_SHORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ShortPreamble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dot11CurrentPreambleMode</span> <span class="o">=</span> <span class="n">PREAMBLE_SHORT</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;%s(): WLAN_CAPABILITY_SHORT_&quot;</span>
				 <span class="s">&quot;PREAMBLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_ACK_PREAMBLE</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ShortPreamble</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dot11CurrentPreambleMode</span> <span class="o">!=</span> <span class="n">PREAMBLE_LONG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ShortPreamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dot11CurrentPreambleMode</span> <span class="o">=</span> <span class="n">PREAMBLE_LONG</span><span class="p">;</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;%s(): WLAN_CAPABILITY_LONG_&quot;</span>
				 <span class="s">&quot;PREAMBLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_ACK_PREAMBLE</span><span class="p">,</span>
					      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ShortPreamble</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE_G</span><span class="o">|</span><span class="n">IEEE_N_24G</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span>	<span class="n">slot_time_val</span><span class="p">;</span>
		<span class="n">u8</span>	<span class="n">CurSlotTime</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">slot_time</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentRT2RTLongSlotTime</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CurSlotTime</span> <span class="o">!=</span> <span class="n">SHORT_SLOT_TIME</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slot_time_val</span> <span class="o">=</span> <span class="n">SHORT_SLOT_TIME</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">HW_VAR_SLOT_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot_time_val</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CurSlotTime</span> <span class="o">!=</span> <span class="n">NON_SHORT_SLOT_TIME</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slot_time_val</span> <span class="o">=</span> <span class="n">NON_SHORT_SLOT_TIME</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">HW_VAR_SLOT_TIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot_time_val</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtllib_qos_parameters</span> <span class="n">def_qos_parameters</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_update_beacon</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of_work_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span>
				  <span class="n">update_beacon_wq</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">)</span>
		<span class="n">HT_update_self_and_peer_setting</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">net</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentRT2RTLongSlotTime</span> <span class="o">=</span>
		 <span class="n">net</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdRT2RTLongSlotTime</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">RT2RT_HT_Mode</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">RT2RT_HT_Mode</span><span class="p">;</span>
	<span class="n">rtl8192_update_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WDCAPARA_ADD</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">EDCAPARA_BE</span><span class="p">,</span> <span class="n">EDCAPARA_BK</span><span class="p">,</span> <span class="n">EDCAPARA_VI</span><span class="p">,</span> <span class="n">EDCAPARA_VO</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_qos_activate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of_work_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span>
				  <span class="n">qos_activate</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">success</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span> <span class="s">&quot;qos active process with associate response &quot;</span>
		 <span class="s">&quot;received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_AC_PARAM</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

<span class="nl">success:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_qos_handle_probe_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">active_network</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_qos_parameters</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">))</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">!=</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span>
				<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">wmm_acm</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">wmm_acm</span><span class="p">;</span>
			<span class="n">queue_work_rsl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span> <span class="s">&quot;QoS parameters change call &quot;</span>
					<span class="s">&quot;qos_activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">def_qos_parameters</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_network</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">queue_work_rsl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span> <span class="s">&quot;QoS was disabled call qos_&quot;</span>
				 <span class="s">&quot;activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_handle_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rtllib_beacon</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8192_qos_handle_probe_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>

	<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_beacon_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_qos_association_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_qos_parameters</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">network</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETWORK_HAS_QOS_PARAMETERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_qos_parameters</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">wmm_acm</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">wmm_acm</span><span class="p">;</span>
		<span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">old_param_count</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span> <span class="o">=</span>
			<span class="n">network</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">param_count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">parameters</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">def_qos_parameters</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_qos_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_QOS</span><span class="p">,</span> <span class="s">&quot;%s: network-&gt;flags = %d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">network</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_qos_param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dm_init_edca_turbo</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">queue_work_rsl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_handle_assoc_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_qos_association_resp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_prepare_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">pskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pnewskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">pdesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">BEACON_QUEUE</span><span class="p">];</span>
	<span class="n">pskb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pskb</span><span class="p">)</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">pskb</span><span class="p">);</span>

	<span class="n">pnewskb</span> <span class="o">=</span> <span class="n">rtllib_get_beacon</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnewskb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">pnewskb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">BEACON_QUEUE</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">pnewskb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">pdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_fill_descriptor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdesc</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">,</span> <span class="n">pnewskb</span><span class="p">);</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">pnewskb</span><span class="p">);</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_stop_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_config_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rate_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">basic_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">net</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">basic_rate</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">basic_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MGN_1M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_1M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_2M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_2M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_5_5M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_5_5M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_11M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_11M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_6M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_6M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_9M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_9M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_12M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_12M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_18M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_18M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_24M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_24M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_36M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_36M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_48M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_48M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_54M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_54M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">basic_rate</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">basic_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MGN_1M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_1M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_2M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_2M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_5_5M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_5_5M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_11M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_11M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_6M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_6M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_9M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_9M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_12M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_12M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_18M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_18M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_24M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_24M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_36M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_36M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_48M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_48M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MGN_54M</span>:
			<span class="o">*</span><span class="n">rate_config</span> <span class="o">|=</span> <span class="n">RRSR_54M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_refresh_supportrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_24G</span> <span class="o">||</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11HTOperationalRateSet</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">RegHTSuppRateSet</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11TxHTOperationalRateSet</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">RegHTSuppRateSet</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11HTOperationalRateSet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">rtl8192_getSupportedWireleeMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RF_8225</span>:
	<span class="k">case</span> <span class="n">RF_8256</span>:
	<span class="k">case</span> <span class="n">RF_6052</span>:
	<span class="k">case</span> <span class="n">RF_PSEUDO_11N</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIRELESS_MODE_N_24G</span><span class="o">|</span><span class="n">WIRELESS_MODE_G</span> <span class="o">|</span> <span class="n">WIRELESS_MODE_B</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF_8258</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIRELESS_MODE_A</span> <span class="o">|</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_SetWirelessMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">wireless_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">bSupportMode</span> <span class="o">=</span> <span class="n">rtl8192_getSupportedWireleeMode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wireless_mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">wireless_mode</span> <span class="o">&amp;</span> <span class="n">bSupportMode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_A</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_G</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bSupportMode</span> <span class="o">&amp;</span> <span class="n">WIRELESS_MODE_B</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;%s(), No valid wireless mode &quot;</span>
				 <span class="s">&quot;supported (%x)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bSupportMode</span><span class="p">);</span>
			<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_B</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wireless_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WIRELESS_MODE_B</span> <span class="o">|</span> <span class="n">WIRELESS_MODE_G</span><span class="p">))</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">WIRELESS_MODE_G</span> <span class="o">|</span> <span class="n">WIRELESS_MODE_B</span><span class="p">))</span>
		<span class="n">wireless_mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">wireless_mode</span><span class="p">;</span>

	<span class="n">ActUpdateChannelAccessSetting</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wireless_mode</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelAccessSetting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wireless_mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_24G</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wireless_mode</span> <span class="o">==</span> <span class="n">WIRELESS_MODE_N_5G</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;%s(), wireless_mode:%x, bEnableHT = 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">wireless_mode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;%s(), wireless_mode:%x, bEnableHT = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">wireless_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Current Wireless Mode is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wireless_mode</span><span class="p">);</span>
	<span class="n">rtl8192_refresh_supportrate</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_rtl8192_sta_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_silent_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="n">pPSC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">));</span>
	<span class="n">bool</span> <span class="n">init_status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDriverIsGoingToUnload</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdisable_nic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ieee_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up_first_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Bringing up iface&quot;</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfirst_init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">init_status</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">initialize_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_status</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;ERR!!! %s(): initialization is failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfirst_init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;start adapter finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RT_CLEAR_PS_LEVEL</span><span class="p">(</span><span class="n">pPSC</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfirst_init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">polling_timer_on</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">check_rfctrl_gpio_timer</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
		<span class="n">rtllib_softmac_start_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtllib_reset_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">);</span>
	<span class="n">watch_dog_timer_callback</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_sta_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">shutdownrf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">RFInProgressTimeOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
		<span class="n">LeisurePSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDriverIsGoingToUnload</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ieee_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfirst_after_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;==========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">CamResetAllEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">swcamtable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw_cam_table</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">rtl8192_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
	<span class="n">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">hw_wakeup_wq</span><span class="p">);</span>

	<span class="n">rtllib_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RFInProgressTimeOut</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;===&gt;%s():RF is in progress, need to wait &quot;</span>
			 <span class="s">&quot;until rf change is done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">RFInProgressTimeOut</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">stop_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;&lt;==========%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span>	<span class="o">=</span> <span class="n">rtl8192_hard_start_xmit</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">set_chan</span>			<span class="o">=</span> <span class="n">rtl8192_set_chan</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">link_change</span>		<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span> <span class="o">=</span> <span class="n">rtl8192_hard_data_xmit</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span>		<span class="o">=</span> <span class="n">rtl8192_data_hard_stop</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span>		<span class="o">=</span> <span class="n">rtl8192_data_hard_resume</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">check_nic_enough_desc</span>	<span class="o">=</span> <span class="n">rtl8192_check_nic_enough_desc</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">get_nic_desc_num</span>		<span class="o">=</span> <span class="n">rtl8192_get_nic_desc_num</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">handle_assoc_response</span>	<span class="o">=</span> <span class="n">rtl8192_handle_assoc_response</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">handle_beacon</span>		<span class="o">=</span> <span class="n">rtl8192_handle_beacon</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span>		<span class="o">=</span> <span class="n">rtl8192_SetWirelessMode</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LeisurePSLeave</span>		<span class="o">=</span> <span class="n">LeisurePSLeave</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetBWModeHandler</span>		<span class="o">=</span> <span class="n">rtl8192_SetBWMode</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_set_chan</span>			<span class="o">=</span> <span class="n">rtl8192_phy_SwChnl</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">start_send_beacons</span> <span class="o">=</span> <span class="n">rtl8192e_start_beacon</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">stop_send_beacons</span> <span class="o">=</span> <span class="n">rtl8192_stop_beacon</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">sta_wake_up</span> <span class="o">=</span> <span class="n">rtl8192_hw_wakeup</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">enter_sleep_state</span> <span class="o">=</span> <span class="n">rtl8192_hw_to_sleep</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ps_is_queue_empty</span> <span class="o">=</span> <span class="n">rtl8192_is_tx_queue_empty</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">GetNmodeSupportBySecCfg</span> <span class="o">=</span> <span class="n">rtl8192_GetNmodeSupportBySecCfg</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">GetHalfNmodeSupportByAPsHandler</span> <span class="o">=</span>
					 <span class="n">rtl8192_GetHalfNmodeSupportByAPs</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span> <span class="o">=</span> <span class="n">rtl8192e_SetHwReg</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">AllowAllDestAddrHandler</span> <span class="o">=</span> <span class="n">rtl8192_AllowAllDestAddr</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetFwCmdHandler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">InitialGainHandler</span> <span class="o">=</span> <span class="n">InitialGain819xPci</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave_wq</span> <span class="o">=</span> <span class="n">rtllib_ips_leave_wq</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave</span> <span class="o">=</span> <span class="n">rtllib_ips_leave</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">UpdateBeaconInterruptHandler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ScanOperationBackupHandler</span> <span class="o">=</span> <span class="n">PHY_ScanOperationBackup8192</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">rtllib_rfkill_poll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_constant</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="n">pPSC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">);</span>

	<span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">RegMaxLPSAwakeIntvl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegPciASPM</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegDevicePciASPMSetting</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegHostPciASPMSetting</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegHwSwRfOffD3</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegSupportPciASPM</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_variable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AcmMethod</span> <span class="o">=</span> <span class="n">eAcmWay2_SW</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dot11CurrentPreambleMode</span> <span class="o">=</span> <span class="n">PREAMBLE_AUTO</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">hwscan_sem_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">H2CTxCmdSeq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDisableFrameBursting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDMInitialGainEnable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">polling_timer_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up_first_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">blinked_ingpio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDriverIsGoingToUnload</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">being_init_adapter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">initialized_at_probe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sw_radio_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdisable_nic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfirst_init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span> <span class="o">=</span> <span class="mi">9100</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span> <span class="o">=</span> <span class="n">MAX_RX_COUNT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegWirelessMode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegChannelPlan</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nrxAMPDU_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nrxAMPDU_aggr_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rxdesc_tsf_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_rxdesc_tsf_low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_AUTO</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">bNetPromiscuousMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">IntelPromiscuousModeInfo</span><span class="p">.</span><span class="n">bPromiscuousOn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">IntelPromiscuousModeInfo</span><span class="p">.</span><span class="n">bFilterSourceStationFrame</span> <span class="o">=</span>
								 <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ieee_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_rts</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_RTS</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">retry_data</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_DATA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">rts</span> <span class="o">=</span> <span class="n">DEFAULT_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">short_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcck_in_ch14</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfsync_processing</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CCKPresentAttentuation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfa_txpowertrackingindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfc_txpowertrackingindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CckPwEnl</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ScanDelay</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDisableNormalResetCheck</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">swcamtable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw_cam_table</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">InterruptLog</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">log_int_8190</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RxCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">wx_set_enc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RegRfOff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">isRFOff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bInPowerSaveMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">RfOffReason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHwRfOffAction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SetRFPowerStateInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">.</span><span class="n">bInactivePs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">.</span><span class="n">bIPSModeBackup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">.</span><span class="n">bLeisurePs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">.</span><span class="n">bFwCtrlLPS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LPSDelayCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="n">LPS_IS_WAKE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">=</span> <span class="n">eRfOn</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpower_checkcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">thermal_readback_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpower_tracking_callback_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ccktxpower_adjustcnt_ch14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ccktxpower_adjustcnt_not_ch14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">DEFAULT_BEACONINTERVAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">be_scan_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">RTLLIB_CCK_MODULATION</span> <span class="o">|</span>
				   <span class="n">RTLLIB_OFDM_MODULATION</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dot11PowerSaveMode</span> <span class="o">=</span> <span class="n">eActive</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">fts</span> <span class="o">=</span> <span class="n">DEFAULT_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">MaxMssDensity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">MinSpaceCfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">PCI</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AcmControl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_firmware</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;rtl8192e: Unable to allocate space &quot;</span>
		       <span class="s">&quot;for firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_queue</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">skb_aggQ</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_scan_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rt_h2c_lock</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_init_priv_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span> <span class="o">=</span> <span class="n">create_workqueue</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">INIT_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8192_restart</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ips_leave_wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">IPSLeave_wq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl819x_watchdog_wqcallback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpower_tracking_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dm_txpower_trackingcallback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rfpath_check_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dm_rf_pathcheck_workitemcallback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_beacon_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8192_update_beacon</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8192_qos_activate</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">hw_wakeup_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">rtl8192_hw_wakeup_wq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">hw_sleep_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">rtl8192_hw_sleep_wq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">rtl8192_irq_rx_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tx_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">rtl8192_irq_tx_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_prepare_beacon_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">rtl8192_prepare_beacon</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">rtl8192_get_channel_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span> <span class="o">!=</span> <span class="n">RF_8225</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span> <span class="o">!=</span> <span class="n">RF_8256</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_chip</span> <span class="o">!=</span> <span class="n">RF_6052</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;%s: unknown rf chip, can&#39;t set channel &quot;</span>
			 <span class="s">&quot;map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span> <span class="o">&gt;=</span> <span class="n">COUNTRY_CODE_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rtl819x_init:Error channel plan! Set to &quot;</span>
		       <span class="s">&quot;default.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span> <span class="o">=</span> <span class="n">COUNTRY_CODE_FCC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Channel plan is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span><span class="p">);</span>
	<span class="n">dot11d_init</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">);</span>
	<span class="n">Dot11d_Channelmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ChannelPlan</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">)[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">)[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">rtl8192_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_stats</span><span class="p">));</span>

	<span class="n">rtl8192_init_priv_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_init_priv_constant</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_init_priv_variable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_init_priv_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">rtl8192_init_priv_task</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_eeprom_size</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_adapter_variable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8192_get_channel_map</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">init_hal_dm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">,</span>
		    <span class="n">watch_dog_timer_callback</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio_polling_timer</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio_polling_timer</span><span class="p">,</span>
		    <span class="n">check_rfctrl_gpio_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8192_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtl8192_interrupt_rsl</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error allocating IRQ %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8192_pci_initdescring</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Endopoints initialization failed&quot;</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">	-------------------------------WATCHDOG STUFF---------------------------</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">short</span> <span class="nf">rtl8192_is_tx_queue_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MGNT_QUEUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HCCA_QUEUE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;===&gt;tx queue is not empty:%d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">reset_type</span> <span class="nf">rtl819x_TxCheckStuck</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>	<span class="n">QueueID</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">ResetThreshold</span> <span class="o">=</span> <span class="n">NIC_SEND_HANG_THRESHOLD_POWERSAVE</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bCheckFwTxCnt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span>  <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTLLIB_PS_DISABLED</span>:
		<span class="n">ResetThreshold</span> <span class="o">=</span> <span class="n">NIC_SEND_HANG_THRESHOLD_NORMAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">RTLLIB_PS_MBCAST</span><span class="o">|</span><span class="n">RTLLIB_PS_UNICAST</span><span class="p">)</span>:
		<span class="n">ResetThreshold</span> <span class="o">=</span> <span class="n">NIC_SEND_HANG_THRESHOLD_POWERSAVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ResetThreshold</span> <span class="o">=</span> <span class="n">NIC_SEND_HANG_THRESHOLD_POWERSAVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">QueueID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">QueueID</span> <span class="o">&lt;</span> <span class="n">MAX_TX_QUEUE</span><span class="p">;</span> <span class="n">QueueID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">QueueID</span> <span class="o">==</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">QueueID</span> <span class="o">==</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">QueueID</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span>
				    <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
			<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">nStuckCount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bCheckFwTxCnt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">nStuckCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: QueueID=%d tcb_desc-&gt;n&quot;</span>
				       <span class="s">&quot;StuckCount=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">QueueID</span><span class="p">,</span>
				       <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">nStuckCount</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bCheckFwTxCnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">TxCheckStuckHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;TxCheckStuck(): Fw indicates no&quot;</span>
				 <span class="s">&quot; Tx condition!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">reset_type</span> <span class="nf">rtl819x_RxCheckStuck</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">RxCheckStuckHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;RxStuck Condition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">reset_type</span> <span class="nf">rtl819x_ifcheck_resetornot</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">reset_type</span> <span class="n">TxResetType</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">reset_type</span> <span class="n">RxResetType</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">rt_rf_power_state</span> <span class="n">rfState</span><span class="p">;</span>

	<span class="n">rfState</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfState</span> <span class="o">==</span> <span class="n">eRfOn</span><span class="p">)</span>
		<span class="n">TxResetType</span> <span class="o">=</span> <span class="n">rtl819x_TxCheckStuck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfState</span> <span class="o">==</span> <span class="n">eRfOn</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">))</span>
		<span class="n">RxResetType</span> <span class="o">=</span> <span class="n">rtl819x_RxCheckStuck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TxResetType</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORMAL</span> <span class="o">||</span>
	    <span class="n">RxResetType</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s(): TxResetType is %d, RxResetType is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">TxResetType</span><span class="p">,</span> <span class="n">RxResetType</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RESET_TYPE_NORMAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TxResetType</span> <span class="o">==</span> <span class="n">RESET_TYPE_SILENT</span> <span class="o">||</span>
		   <span class="n">RxResetType</span> <span class="o">==</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s(): TxResetType is %d, RxResetType is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">TxResetType</span><span class="p">,</span> <span class="n">RxResetType</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl819x_silentreset_mesh_bk</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">IsPortal</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl819x_ifsilentreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span>	<span class="n">reset_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">IsPortal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;=========&gt;Reset progress!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">=</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">END</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bResetInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

<span class="nl">RESET_START:</span>

		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
			<span class="n">LeisurePSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_NIC_DOWN</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;%s():the driver is not up! &quot;</span>
				 <span class="s">&quot;return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;%s():======&gt;start to down the driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;%s():111111111111111111111111======&gt;start&quot;</span>
			 <span class="s">&quot; to down the driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">rtl8192_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">);</span>
		<span class="n">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">deinit_hal_dm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtllib_stop_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SEM_DOWN_IEEE_WX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ieee-&gt;state is RTLLIB_LINKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rtllib_stop_send_beacons</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">);</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">);</span>
			<span class="n">rtllib_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">SEM_UP_IEEE_WX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ieee-&gt;state is NOT LINKED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rtllib_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dm_backup_dynamic_mechanism_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;%s():&lt;==========down process is &quot;</span>
			 <span class="s">&quot;finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;%s():&lt;===========up process start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">);</span>
		<span class="n">reset_status</span> <span class="o">=</span> <span class="n">_rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;%s():&lt;===========up process is &quot;</span>
			 <span class="s">&quot;finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset_status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reset_times</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reset_times</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">RESET_START</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot; ERR!!! %s():  Reset &quot;</span>
					 <span class="s">&quot;Failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_silent_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rf_ps_lock</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

		<span class="n">EnableHWSecurityConfig8192</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span>
		    <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

			<span class="n">queue_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_complete_wq</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span>
			   <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

			<span class="n">rtllib_start_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MESH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl819x_silentreset_mesh_bk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IsPortal</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">CamRestoreAllEntry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dm_restore_dynamic_mechanism_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">END:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bResetInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UFWP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;Reset finished!! ====&gt;[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl819x_update_rxcounts</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">TotalRxBcnNum</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="o">*</span><span class="n">TotalRxDataNum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">SlotIndex</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">TotalRxBcnNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">TotalRxDataNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SlotIndex</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotIndex</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotNum</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxBcnNum</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxDataNum</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">TotalRxBcnNum</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxBcnNum</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">TotalRxDataNum</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">RxDataNum</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span>	<span class="nf">rtl819x_watchdog_wqcallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of_dwork_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span> <span class="n">watch_dog_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">reset_type</span> <span class="n">ResetType</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORESET</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">check_reset_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="n">pPSC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">));</span>
	<span class="n">bool</span> <span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bHigherBusyTraffic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bHigherBusyRxTraffic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bEnterPS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NIC_DOWN</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bHwRadioOff</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">CntAfterLink</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">CntAfterLink</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">CntAfterLink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hal_dm_watchdog</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtllib_act_scanning</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span>
		     <span class="n">RTLLIB_NOLINK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOn</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_set_key</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_stoppping</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_set_enc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">.</span><span class="n">ReturnPoint</span> <span class="o">==</span>
			     <span class="n">IPS_CALLBACK_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bNetPromiscuousMode</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_PS</span><span class="p">,</span> <span class="s">&quot;====================&gt;haha: &quot;</span>
					 <span class="s">&quot;IPSEnter()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">IPSEnter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span>
	     <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bNetPromiscuousMode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">||</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">4000</span> <span class="o">||</span>
		    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bHigherBusyTraffic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span>
				<span class="n">bHigherBusyRxTraffic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bHigherBusyRxTraffic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxUnicastOkInPeriod</span> <span class="o">+</span>
		    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxUnicastOkInPeriod</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">bEnterPS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bEnterPS</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">&lt;</span> <span class="mi">95</span><span class="p">)</span>
			<span class="n">bEnterPS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bEnterPS</span><span class="p">)</span>
			<span class="n">LeisurePSEnter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">LeisurePSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_LPS</span><span class="p">,</span> <span class="s">&quot;====&gt;no link LPS leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">LeisurePSLeave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxUnicastOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="n">bBusyTraffic</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">bHigherBusyTraffic</span> <span class="o">=</span> <span class="n">bHigherBusyTraffic</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">bHigherBusyRxTraffic</span> <span class="o">=</span> <span class="n">bHigherBusyRxTraffic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">TotalRxBcnNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">TotalRxDataNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rtl819x_update_rxcounts</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TotalRxBcnNum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TotalRxDataNum</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">TotalRxBcnNum</span><span class="o">+</span><span class="n">TotalRxDataNum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">check_roaming_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">check_roaming_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">check_roaming_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span>
				<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;===&gt;%s(): AP is power off, chan:%d,&quot;</span>
			       <span class="s">&quot; connect another one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_ASSOCIATING</span><span class="p">;</span>

			<span class="n">RemovePeerTS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span>
				     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_roaming</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_set_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">LED_CTL_START_TO_LINK</span><span class="p">);</span>

			<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ap_sec_type</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">SEC_ALG_CCMP</span><span class="o">|</span><span class="n">SEC_ALG_TKIP</span><span class="p">)))</span>
				<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">check_roaming_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">check_reset_cnt</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_roaming</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">RFChangeInProgress</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">bSwRfProcessing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ResetType</span> <span class="o">=</span> <span class="n">rtl819x_ifcheck_resetornot</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">check_reset_cnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDisableNormalResetCheck</span> <span class="o">&amp;&amp;</span> <span class="n">ResetType</span> <span class="o">==</span> <span class="n">RESET_TYPE_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ResetProgress</span> <span class="o">=</span> <span class="n">RESET_TYPE_NORMAL</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_RESET</span><span class="p">,</span> <span class="s">&quot;%s(): NOMAL RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_reset</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bDisableNormalResetCheck</span> <span class="o">&amp;&amp;</span>
	      <span class="n">ResetType</span> <span class="o">==</span> <span class="n">RESET_TYPE_SILENT</span><span class="p">)))</span>
		<span class="n">rtl819x_ifsilentreset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bForcedSilentReset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bResetInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_TRACE</span><span class="p">,</span> <span class="s">&quot; &lt;==RtUsbCheckForHangWorkItemCallback()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">watch_dog_timer_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		  <span class="n">MSECS</span><span class="p">(</span><span class="n">RTLLIB_WATCH_DOG_TIME</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> ---------------------------- NIC TX/RX STUFF---------------------------</span>
<span class="cm">*****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">rtl8192_rx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_tx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtllib_reset_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_free_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_queue_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_queue_idx</span> <span class="o">&lt;</span> <span class="n">MAX_RX_QUEUE</span><span class="p">;</span>
	     <span class="n">rx_queue_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">])</span> <span class="o">*</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">],</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_free_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">TxBuffAddr</span><span class="p">),</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span><span class="o">*</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_data_hard_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtl8192_data_hard_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_hard_data_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span>
				    <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">queue_index</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_NIC_DOWN</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bResetInProgress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">TXCMD_QUEUE</span><span class="p">);</span>


	<span class="n">memcpy</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">MGNT_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span>
						 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl8192_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span>
				    <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">queue_index</span> <span class="o">=</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">IS_NIC_DOWN</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bResetInProgress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_index</span> <span class="o">==</span> <span class="n">TXCMD_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl8192_tx_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxEnableFwCalcDur</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">};</span>
	<span class="p">}</span>



	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_tx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prio</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">OWN</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">TxBuffAddr</span><span class="p">),</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prio</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tx_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_tx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_desc_cmd</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">TXCMD_QUEUE</span><span class="p">];</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_fill_cmd_descriptor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtl8192_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span>  <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span>
				    <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">pdesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_1addr</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span>  <span class="n">multi_addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">broad_addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">uni_addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pda_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>   <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fwinfo_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdisable_nic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;%s: ERR!! Nic is disabled! Can&#39;t tx packet&quot;</span>
			 <span class="s">&quot; len=%d qidx=%d!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			 <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">bAwakePktSent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">fwinfo_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_fwinfo_8190pci</span><span class="p">);</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_1addr</span> <span class="o">*</span><span class="p">)(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">fwinfo_size</span><span class="p">);</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">stype</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">pda_addr</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">pda_addr</span><span class="p">))</span>
		<span class="n">broad_addr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">pda_addr</span><span class="p">))</span>
		<span class="n">multi_addr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uni_addr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uni_addr</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesunicast</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">fwinfo_size</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">multi_addr</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesmulticast</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">fwinfo_size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytesbroadcast</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">fwinfo_size</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">!=</span> <span class="n">BEACON_QUEUE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;No more TX desc@%d, ring-&gt;idx = %d, idx = &quot;</span>
			 <span class="s">&quot;%d, skblen = 0x%x queuelen=%d&quot;</span><span class="p">,</span>
			 <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			 <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTLLIB_FTYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">LED_CTL_TX</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_fill_descriptor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdesc</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">write_nic_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TPPoll</span><span class="p">,</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">rtl8192_alloc_rx_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_queue_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_queue_idx</span> <span class="o">&lt;</span> <span class="n">MAX_RX_QUEUE</span><span class="p">;</span> <span class="n">rx_queue_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">])</span> <span class="o">*</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">||</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot allocate RX ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">])</span> <span class="o">*</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">);</span>
			<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">mapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
			<span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="n">skb_tail_pointer_rsl</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
						  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span>
						  <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">BufferAddress</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="n">mapping</span><span class="p">);</span>

			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">;</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">EOR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_alloc_tx_desc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="p">)</span> <span class="o">*</span> <span class="n">entries</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span> <span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ring</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot allocate TX ring (prio = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">prio</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="p">)</span><span class="o">*</span><span class="n">entries</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ring</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NextDescAddress</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">dma</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">entries</span><span class="p">)</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">short</span> <span class="nf">rtl8192_pci_initdescring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_alloc_rx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_alloc_tx_desc_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txringcount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_rings</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_rings:</span>
	<span class="n">rtl8192_free_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">rtl8192_free_tx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_pci_resetdescring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_queue_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_queue_idx</span> <span class="o">&lt;</span> <span class="n">MAX_RX_QUEUE</span><span class="p">;</span> <span class="n">rx_queue_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtl8192_tx_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span>
						 <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">TxBuffAddr</span><span class="p">),</span>
						 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl819x_UpdateRxPktTimeStamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">bFirstMPDU</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxDescTSF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">LastRxDescTSF</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">rtl819x_translate_todbm</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">signal_strength_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span>	<span class="n">signal_power</span><span class="p">;</span>

	<span class="n">signal_power</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)((</span><span class="n">signal_strength_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">signal_power</span> <span class="o">-=</span> <span class="mi">95</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">signal_power</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="nf">rtl819x_update_rxsignalstatistics8190pci</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">pprevious_stats</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">weighting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_signal_power</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_signal_power</span> <span class="o">=</span>
					 <span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_signal_power</span><span class="p">)</span>
		<span class="n">weighting</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span> <span class="o">&lt;</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_signal_power</span><span class="p">)</span>
		<span class="n">weighting</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_signal_power</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">recv_signal_power</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span>
					<span class="n">pprevious_stats</span><span class="o">-&gt;</span><span class="n">RecvSignalPower</span> <span class="o">+</span>
					<span class="n">weighting</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl819x_process_cck_rxpathsel</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">pprevious_stats</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="n">u8</span> <span class="nf">rtl819x_query_rxpwrpercentage</span><span class="p">(</span><span class="kt">char</span> <span class="n">antpower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">antpower</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">antpower</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">))</span>
		<span class="k">return</span>	<span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antpower</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span>	<span class="mi">100</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span>	<span class="mi">100</span> <span class="o">+</span> <span class="n">antpower</span><span class="p">;</span>

<span class="p">}</span>	<span class="cm">/* QueryRxPwrPercentage */</span>

<span class="n">u8</span>
<span class="nf">rtl819x_evm_dbtopercentage</span><span class="p">(</span>
	<span class="kt">char</span> <span class="n">value</span>
	<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">33</span><span class="p">)</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">33</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">==</span> <span class="mi">99</span><span class="p">)</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">rtl8192_record_rxdesc_forlateruse</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">psrc_stats</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">ptarget_stats</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptarget_stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span> <span class="o">=</span> <span class="n">psrc_stats</span><span class="o">-&gt;</span><span class="n">bIsAMPDU</span><span class="p">;</span>
	<span class="n">ptarget_stats</span><span class="o">-&gt;</span><span class="n">bFirstMPDU</span> <span class="o">=</span> <span class="n">psrc_stats</span><span class="o">-&gt;</span><span class="n">bFirstMPDU</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_rx_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_1addr</span> <span class="o">*</span><span class="n">rtllib_hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">unicast_packet</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bLedBlinking</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">skb_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_queue_idx</span> <span class="o">=</span> <span class="n">RX_MPDU_QUEUE</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">98</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">RTLLIB_24GHZ_BAND</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span>

	<span class="n">stats</span><span class="p">.</span><span class="n">nic_type</span> <span class="o">=</span> <span class="n">NIC_8192E</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">pdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span>
					<span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span>
				      <span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">OWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">rx_query_status_descriptor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span>
			<span class="n">pdesc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="n">new_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">);</span>
			<span class="cm">/* if allocation of new skb failed - drop current packet</span>
<span class="cm">			* and reuse skb */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span>
					<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">RxDrvInfoSize</span> <span class="o">+</span>
				<span class="n">stats</span><span class="p">.</span><span class="n">RxBufShift</span><span class="p">);</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="cm">/*sCrcLng*/</span><span class="p">);</span>
			<span class="n">rtllib_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_1addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">rtllib_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* unicast packet */</span>
				<span class="n">unicast_packet</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rtllib_hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">);</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RTLLIB_FTYPE_MGMT</span><span class="p">)</span>
				<span class="n">bLedBlinking</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bLedBlinking</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">LED_CTL_RX</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">bCRC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">RTLLIB_FTYPE_MGMT</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxdatacrcerr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxmgmtcrcerr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtllib_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxok</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unicast_packet</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytesunicast</span> <span class="o">+=</span> <span class="n">skb_len</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">][</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]]</span> <span class="o">=</span>
									 <span class="n">skb</span><span class="p">;</span>
			<span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						    <span class="n">skb_tail_pointer_rsl</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
						    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">,</span>
						    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="p">}</span>
<span class="nl">done:</span>
		<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">BufferAddress</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">dma_addr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
		<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">OWN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxbuffersize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">pdesc</span><span class="o">-&gt;</span><span class="n">EOR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">[</span><span class="n">rx_queue_idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
					      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxringcount</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_rx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8192_tx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">BK_QUEUE</span><span class="p">;</span>
	     <span class="n">queue_index</span> <span class="o">&lt;</span> <span class="n">MAX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">queue_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">check_nic_enough_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">queue_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_irq_tx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8192_tx_resume</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_irq_rx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8192_rx_normal</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MAX_RX_QUEUE</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">rtl8192_rx_cmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">INTA_MASK</span><span class="p">,</span>
			<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">INTA_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">IMR_RDU</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> ---------------------------- NIC START/CLOSE STUFF---------------------------</span>
<span class="cm">*****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watch_dog_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_beacon_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">hw_sleep_wq</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_activate</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">_rtl8192_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_silent_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_rtl8192_sta_up</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">is_silent_reset</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>


<span class="kt">int</span> <span class="nf">rtl8192_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rtllib_act_scanning</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtllib_stop_scan</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8192_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtl8192_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">shutdownrf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8192_sta_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">shutdownrf</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rtllib_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">rtl8192_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">stop_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">_rtl8192_up</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtl8192_restart</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of_work_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">,</span>
				  <span class="n">reset_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">rtl8192_commit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8192_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">promisc</span><span class="p">;</span>

	<span class="n">promisc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="n">promisc</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8192_set_mac_adr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mac</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_wq</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* based on ipw2200 driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8192_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">broadcast_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">zero_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">ipw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_IOCTL_WPA_SUPPLICANT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ipw</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ipw</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">IEEE_CMD_SET_ENCRYPTION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_TKIP</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span>
							 <span class="n">KEY_TYPE_WEP104</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span>
							 <span class="n">KEY_TYPE_WEP40</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_NA</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span> <span class="n">zero_addr</span><span class="p">,</span>
					    <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">EnableHWSecurityConfig8192</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">set_swcam</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
						  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
						  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
					       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">set_swcam</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
							<span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
							<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
							<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
						       <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
						       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span><span class="p">,</span>
						       <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span>
						       <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pairwise_key_type</span> <span class="o">==</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">)</span>
				     <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">write_nic_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x173</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_CCMP</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_TKIP</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span>
							 <span class="n">KEY_TYPE_WEP104</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span>
							 <span class="n">KEY_TYPE_WEP40</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span> <span class="o">=</span> <span class="n">KEY_TYPE_NA</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_swcam</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
						  <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
						  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">,</span>
						  <span class="n">broadcast_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">setKey</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
					       <span class="n">ipw</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span>
					       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">group_key_type</span><span class="p">,</span>
					       <span class="n">broadcast_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtllib_wpa_supplicant_ioctl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ipw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">irqreturn_type</span> <span class="nf">rtl8192_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intb</span><span class="p">;</span>
	<span class="n">intb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">interrupt_recognized</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">shints</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ints</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_TBDOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;beacon ok interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeaconokint</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_TBDER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;beacon ok interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeaconerr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_BDOK</span><span class="p">)</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;beacon interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span>  <span class="o">&amp;</span> <span class="n">IMR_MGNTDOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;Manage ok interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txmanageokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8192_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MGNT_QUEUE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rtl8192_is_tx_queue_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rtllib_ps_tx_ack</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_COMDOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txcmdpktokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8192_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TXCMD_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_HIGHDOK</span><span class="p">)</span>
		<span class="n">rtl8192_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HIGH_QUEUE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_ROK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">InterruptLog</span><span class="p">.</span><span class="n">nIMR_ROK</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_BcnInt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;prepare beacon for interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_prepare_beacon_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_RDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;rx descriptor unavailable!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxrdu</span><span class="o">++</span><span class="p">;</span>
		<span class="n">write_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INTA_MASK</span><span class="p">,</span>
				<span class="n">read_nic_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">INTA_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IMR_RDU</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_RXFOVW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;rx overflow !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxoverflow</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_TXFOVW</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txoverflow</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_BKDOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;BK Tx OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbkokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8192_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BK_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_BEDOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;BE TX OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbeokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8192_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BE_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_VIDOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;VI TX OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txviokint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8192_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VI_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">IMR_VODOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txvookint</span><span class="o">++</span><span class="p">;</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INTR</span><span class="p">,</span> <span class="s">&quot;Vo TX OK interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtl8192_tx_isr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">VO_QUEUE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_th_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">done:</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/****************************************************************************</span>
<span class="cm">	---------------------------- PCI_STUFF---------------------------</span>
<span class="cm">*****************************************************************************/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rtl8192_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">rtl8192_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">rtl8192_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">rtl8192_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> <span class="o">=</span> <span class="n">rtl8192_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span> <span class="o">=</span> <span class="n">r8192_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">r8192_set_mac_adr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span> <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">rtllib_xmit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rtl8192_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl819x_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl819x_ops</span> <span class="o">*</span><span class="p">)(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">,</span> <span class="n">pmem_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bdma64</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">revision_id</span><span class="p">;</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Configuring chip resources&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to enable PCI device&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unable to obtain 32bit DMA for consistent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_pci_disable</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_rtllib</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8192_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci_disable</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdma64</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv_rsl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x3304</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">bSupportRemoteWakeUp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">bSupportRemoteWakeUp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pmem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pmem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pmem_flags</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmem_flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;region #1 not a MMIO resource, aborting&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_rel_rtllib</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Memory mapped space start: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmem_start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;request_mem_region failed!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_rel_rtllib</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">ioaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;ioremap failed!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_rel_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revision_id</span><span class="p">);</span>
	<span class="cm">/* If the revisionid is 0x10, the device uses rtl8192se. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x8192</span> <span class="o">&amp;&amp;</span> <span class="n">revision_id</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rel_mem</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8192_pci_findadapter</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rel_mem</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl8192_netdev_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="o">*</span><span class="p">)</span>
				 <span class="o">&amp;</span><span class="n">r8192_wx_handlers_def</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl819x_ethtool_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Oops: devname already taken! Trying &quot;</span>
			 <span class="s">&quot;wlan%%d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Driver probe completed1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8192_init</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;Initialization failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;dev name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">rtl8192_proc_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">polling_timer_on</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">check_rfctrl_gpio_timer</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;Driver probe completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_rel_mem:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pmem_start</span><span class="p">,</span> <span class="n">pmem_len</span><span class="p">);</span>
<span class="nl">err_rel_rtllib:</span>
	<span class="n">free_rtllib</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;wlan driver load failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">err_pci_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">rtl8192_pci_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio_polling_timer</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio_change_rf_wq</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">polling_timer_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rtl8192_proc_remove_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">rtl8192_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">deinit_hal_dm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pFirmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">);</span>
		<span class="n">rtl8192_free_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TX_QUEUE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rtl8192_free_tx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Freeing irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free_rtllib</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
					<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;wlan driver removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">NicIFEnableNIC</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">init_status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="n">pPSC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_NIC_DOWN</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;ERR!!! %s(): Driver is already down!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdisable_nic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RT_STATUS_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_PS</span><span class="p">,</span> <span class="s">&quot;===========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfirst_init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">init_status</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">initialize_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_status</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_ERR</span><span class="p">,</span> <span class="s">&quot;ERR!!! %s(): initialization is failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdisable_nic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_INIT</span><span class="p">,</span> <span class="s">&quot;start adapter finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RT_CLEAR_PS_LEVEL</span><span class="p">(</span><span class="n">pPSC</span><span class="p">,</span> <span class="n">RT_RF_OFF_LEVL_HALT_NIC</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bfirst_init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rtl8192_irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdisable_nic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_PS</span><span class="p">,</span> <span class="s">&quot;&lt;===========%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">init_status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">bool</span> <span class="nf">NicIFDisableNIC</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span>	<span class="n">status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tmp_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_PS</span><span class="p">,</span> <span class="s">&quot;=========&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bdisable_nic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">tmp_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">rtllib_softmac_stop_protocol</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">tmp_state</span><span class="p">;</span>
	<span class="n">rtl8192_cancel_deferred_work</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">rtl8192_irq_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">stop_adapter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_PS</span><span class="p">,</span> <span class="s">&quot;&lt;=========%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rtl8192_pci_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Linux kernel driver for RTL8192E WLAN cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Copyright (c) 2007-2008, Realsil Wlan Driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rtl8192_proc_module_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8192_pci_driver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DMESG</span><span class="p">(</span><span class="s">&quot;No device found&quot;</span><span class="p">);</span>
		<span class="cm">/*pci_unregister_driver (&amp;rtl8192_pci_driver);*/</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rtl8192_pci_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8192_pci_driver</span><span class="p">);</span>

	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DOWN</span><span class="p">,</span> <span class="s">&quot;Exiting&quot;</span><span class="p">);</span>
	<span class="n">rtl8192_proc_module_remove</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">check_rfctrl_gpio_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8192_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rtllib_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">polling_timer_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio_change_rf_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio_polling_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		  <span class="n">MSECS</span><span class="p">(</span><span class="n">RTLLIB_WATCH_DOG_TIME</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">	------------------- module init / exit stubs ----------------</span>
<span class="cm">****************************************************************************/</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">rtl8192_pci_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rtl8192_pci_module_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux driver for Realtek RTL819x WiFi cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hwwep</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="s">&quot; Net interface name, wlan%d=default&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwwep</span><span class="p">,</span> <span class="s">&quot; Try to use hardware WEP support(default use hw. set 0 to use software security)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="s">&quot; Channel bitmask for specific locales. NYI&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
