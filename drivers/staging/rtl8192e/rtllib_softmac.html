<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rtl8192e › rtllib_softmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rtllib_softmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* IEEE 802.11 SoftMAC layer</span>
<span class="cm"> * Copyright (c) 2005 Andrea Merello &lt;andreamrl@tiscali.it&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Mostly extracted from the rtl8180-sa2400 driver for the</span>
<span class="cm"> * in-kernel generic ieee802.11 stack.</span>
<span class="cm"> *</span>
<span class="cm"> * Few lines might be stolen from other part of the rtllib</span>
<span class="cm"> * stack. Copyright who own it&#39;s copyright</span>
<span class="cm"> *</span>
<span class="cm"> * WPA code stolen from the ipw2200 driver.</span>
<span class="cm"> * Copyright who own it&#39;s copyright.</span>
<span class="cm"> *</span>
<span class="cm"> * released under the GPL</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;rtllib.h&quot;</span>

<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &quot;dot11d.h&quot;</span>

<span class="kt">short</span> <span class="nf">rtllib_is_54g</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">short</span> <span class="nf">rtllib_is_shortslot</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns the total length needed for placing the RATE MFIE</span>
<span class="cm"> * tag and the EXTENDED RATE MFIE tag if needed.</span>
<span class="cm"> * It encludes two bytes per tag for the tag itself and its len</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rtllib_MFIE_rate_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_CCK_MODULATION</span><span class="p">)</span>
		<span class="n">rate_len</span> <span class="o">=</span> <span class="n">RTLLIB_CCK_RATE_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_OFDM_MODULATION</span><span class="p">)</span>

		<span class="n">rate_len</span> <span class="o">+=</span> <span class="n">RTLLIB_OFDM_RATE_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rate_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* place the MFIE rate, tag to the memory (double) pointed.</span>
<span class="cm"> * Then it updates the pointer so that</span>
<span class="cm"> * it points after the new MFIE tag added.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_MFIE_Brate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_CCK_MODULATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_1MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_2MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_5MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_11MB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We may add an option for custom rates that specific HW</span>
<span class="cm">	 * might support */</span>
	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_MFIE_Grate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_OFDM_MODULATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES_EX</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_6MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_9MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_12MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_18MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_24MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_36MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_48MB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_OFDM_RATE_54MB</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We may add an option for custom rates that specific HW might</span>
<span class="cm">	 * support */</span>
	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_WMM_Info</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xf2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MAX_SP_Len</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_TURBO_Info</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">tag_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">tag_p</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tag_p</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;This is enable turbo mode IE process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enqueue_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nh</span><span class="p">;</span>
	<span class="n">nh</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MGMT_QUEUE_NUM</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * if the queue is full but we have newer frames then</span>
<span class="cm"> * just overwrites the oldest.</span>
<span class="cm"> *</span>
<span class="cm"> * if (nh == ieee-&gt;mgmt_queue_tail)</span>
<span class="cm"> *		return -1;</span>
<span class="cm"> */</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span> <span class="o">=</span> <span class="n">nh</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_ring</span><span class="p">[</span><span class="n">nh</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">dequeue_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">==</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_ring</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span><span class="p">];</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MGMT_QUEUE_NUM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_mgmt_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">u8</span>
<span class="nf">MgntQuery_TxRateExcludeCCKRates</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>	<span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">QueryRate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">BasicRate</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BasicRate</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtllib_is_cck_rate</span><span class="p">(</span><span class="n">BasicRate</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">QueryRate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">QueryRate</span> <span class="o">=</span> <span class="n">BasicRate</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">BasicRate</span> <span class="o">&lt;</span> <span class="n">QueryRate</span><span class="p">)</span>
					<span class="n">QueryRate</span> <span class="o">=</span> <span class="n">BasicRate</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">QueryRate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QueryRate</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;No BasicRate found!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QueryRate</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">MgntQuery_MgntFrameTxRate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt_hi_throughput</span> <span class="o">*</span><span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span> <span class="n">HT_IOT_ACT_MGNT_USE_CCK_6M</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_A</span> <span class="o">||</span>
		   <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_N_5G</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_N_24G</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurSuppCCK</span><span class="p">))</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">softmac_mgmt_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">single</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>  <span class="o">*</span><span class="n">header</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>  <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* called with 2nd param 0, no mgmt lock required */</span>
	<span class="n">rtllib_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">==</span> <span class="n">RTLLIB_STYPE_BEACON</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">BEACON_QUEUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">MGNT_QUEUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">disable_mgnt_queue</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">HIGH_QUEUE</span><span class="p">;</span>

	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">MgntQuery_MgntFrameTxRate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enqueue_mgmt</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* avoid watchdog triggers */</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* check wether the managed packet queued greater than 5 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">check_nic_enough_desc</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* insert the skb packet to the management queue */</span>
			<span class="cm">/* as for the completion function, it does not need</span>
<span class="cm">			 * to check it any more.</span>
<span class="cm">			 * */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s():insert to waitqueue, queue_index&quot;</span>
			       <span class="s">&quot;:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">],</span>
				       <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">softmac_ps_mgmt_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">single</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>  <span class="o">*</span><span class="n">header</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>  <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">;</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_TYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">stype</span> <span class="o">=</span> <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">RTLLIB_STYPE_PSPOLL</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">MGNT_QUEUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">HIGH_QUEUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">disable_mgnt_queue</span><span class="p">)</span>
		<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">queue_index</span> <span class="o">=</span> <span class="n">HIGH_QUEUE</span><span class="p">;</span>


	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">MgntQuery_MgntFrameTxRate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">RATRIndex</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxDisableRateFallBack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bTxUseDriverAssingedRate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">RTLLIB_FTYPE_CTL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="cm">/* avoid watchdog triggers */</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">RTLLIB_FTYPE_CTL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">rate_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_probe_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span>

	<span class="n">rate_len</span> <span class="o">=</span> <span class="n">rtllib_MFIE_rate_len</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_probe_request</span><span class="p">)</span> <span class="o">+</span>
			    <span class="mi">2</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="n">rate_len</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_probe_request</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
	      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_probe_request</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_STYPE_PROBE_REQ</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">rate_len</span><span class="p">);</span>

	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_SSID</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rtllib_MFIE_Brate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">rtllib_MFIE_Grate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rtllib_get_beacon_</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_send_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_get_beacon_</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_beacons</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_txing</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_up</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">MSECS</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_send_beacon_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">_ieee</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rtllib_send_beacon</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *	      Enable network monitor mode, all rx packets will be received.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtllib_EnableNetMonitorMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">bInitState</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv_rsl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;========&gt;Enter Monitor Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AllowAllDestAddrHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">!</span><span class="n">bInitState</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *      Description:</span>
<span class="cm"> *	      Disable network network monitor mode, only packets destinated to</span>
<span class="cm"> *	      us will be received.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtllib_DisableNetMonitorMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">bInitState</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv_rsl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;========&gt;Exit Monitor Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AllowAllDestAddrHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">!</span><span class="n">bInitState</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This enables the specialized promiscuous mode required by Intel.</span>
<span class="cm"> * In this mode, Intel intends to hear traffics from/to other STAs in the</span>
<span class="cm"> * same BSS. Therefore we don&#39;t have to disable checking BSSID and we only need</span>
<span class="cm"> * to allow all dest. BUT: if we enable checking BSSID then we can&#39;t recv</span>
<span class="cm"> * packets from other STA.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtllib_EnableIntelPromiscuousMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">bInitState</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">bFilterOutNonAssociatedBSSID</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv_rsl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;========&gt;Enter Intel Promiscuous Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AllowAllDestAddrHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">!</span><span class="n">bInitState</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_CECHK_BSSID</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bFilterOutNonAssociatedBSSID</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bNetPromiscuousMode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_EnableIntelPromiscuousMode</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Description:</span>
<span class="cm"> *	      This disables the specialized promiscuous mode required by Intel.</span>
<span class="cm"> *	      See MgntEnableIntelPromiscuousMode for detail.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtllib_DisableIntelPromiscuousMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">bInitState</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">bFilterOutNonAssociatedBSSID</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">netdev_priv_rsl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;========&gt;Exit Intel Promiscuous Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AllowAllDestAddrHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">!</span><span class="n">bInitState</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_CECHK_BSSID</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bFilterOutNonAssociatedBSSID</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bNetPromiscuousMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_DisableIntelPromiscuousMode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_send_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_mesh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_probe_req</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_probe_rq</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtllib_send_probe_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_mesh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_scan</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span>
	    <span class="n">IEEE_SOFTMAC_PROBERQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtllib_send_probe</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtllib_send_probe</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_softmac_hint11d_wq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_update_active_chan_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">,</span> <span class="n">GET_DOT11D_INFO</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">,</span>
	       <span class="n">MAX_CHANNEL_NUMBER</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this performs syncro scan blocking the caller until all channels</span>
<span class="cm"> * in the allowed channel map has been checked.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtllib_softmac_scan_syncro</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_mesh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtllib_update_active_chan_map</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">be_scan_inprogress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* scan completed */</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>

		<span class="cm">/* this fuction can be called in two situations</span>
<span class="cm">		 * 1- We have switched to ad-hoc mode and we are</span>
<span class="cm">		 *    performing a complete syncro scan before conclude</span>
<span class="cm">		 *    there are no interesting cell and to create a</span>
<span class="cm">		 *    new one. In this case the link state is</span>
<span class="cm">		 *    RTLLIB_NOLINK until we found an interesting cell.</span>
<span class="cm">		 *    If so the ieee8021_new_net, called by the RX path</span>
<span class="cm">		 *    will set the state to RTLLIB_LINKED, so we stop</span>
<span class="cm">		 *    scanning</span>
<span class="cm">		 * 2- We are linked and the root uses run iwlist scan.</span>
<span class="cm">		 *    So we switch to RTLLIB_LINKED_SCANNING to remember</span>
<span class="cm">		 *    that we are still logically linked (not interested in</span>
<span class="cm">		 *    new network events, despite for updating the net list,</span>
<span class="cm">		 *    but we are temporarly &#39;unlinked&#39; as the driver shall</span>
<span class="cm">		 *    not filter RX frames and the channel is changing.</span>
<span class="cm">		 * So the only situation in which are interested is to check</span>
<span class="cm">		 * if the state become LINKED because of the #1 situation</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;============&gt;sync_scan_hurryup out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rtllib_send_probe_requests</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* this prevent excessive time wait when we</span>
<span class="cm">		 * need to wait for a syncro scan to end..</span>
<span class="cm">		 */</span>
		<span class="n">msleep_interruptible_rsl</span><span class="p">(</span><span class="n">RTLLIB_SOFTMAC_SCAN_TIME</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
			<span class="n">DOT11D_ScanComplete</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">be_scan_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_softmac_scan_wq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of_dwork_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rtllib_device</span><span class="p">,</span> <span class="n">softmac_scan_wq</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">last_channel</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">rtllib_update_active_chan_map</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee_up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtllib_act_scanning</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;======&gt;%s():rf state is eRfOff, return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
			<span class="n">MAX_CHANNEL_NUMBER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_watch_dog</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">])</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* no good chans */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning_continue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">rtllib_send_probe_requests</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">,</span>
			       <span class="n">MSECS</span><span class="p">(</span><span class="n">RTLLIB_SOFTMAC_SCAN_TIME</span><span class="p">));</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="n">DOT11D_ScanComplete</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">last_channel</span><span class="p">;</span>

<span class="nl">out1:</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_watch_dog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning_continue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_beacons_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_txing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rtllib_send_beacon</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_beacons_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_txing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtllib_stop_send_beacons</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stop_send_beacons</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stop_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_BEACONS</span><span class="p">)</span>
		<span class="n">rtllib_beacons_stop</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_stop_send_beacons</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">rtllib_start_send_beacons</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_send_beacons</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_BEACONS</span><span class="p">)</span>
		<span class="n">rtllib_beacons_start</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_start_send_beacons</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_softmac_stop_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_watch_dog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning_continue</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning_continue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_stop_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtllib_softmac_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_stop_hw_scan</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_stop_hw_scan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_stop_scan</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtllib_stop_scan_syncro</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_stop_hw_scan</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_stop_hw_scan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_stop_scan_syncro</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">rtllib_act_scanning</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sync_scan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sync_scan</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">be_scan_inprogress</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">be_scan_inprogress</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_act_scanning</span><span class="p">);</span>

<span class="cm">/* called with ieee-&gt;lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_start_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;===&gt;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave_wq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave_wq</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
			<span class="n">RESET_CIE_WATCHDOG</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning_continue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning_continue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_start_hw_scan</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_start_hw_scan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called with wx_sem held */</span>
<span class="kt">void</span> <span class="nf">rtllib_start_scan_syncro</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_mesh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
			<span class="n">RESET_CIE_WATCHDOG</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sync_scan_hurryup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtllib_softmac_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">is_mesh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_start_hw_scan</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_start_hw_scan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_start_scan_syncro</span><span class="p">);</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_authentication_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">challengelen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">)</span> <span class="o">+</span> <span class="n">challengelen</span> <span class="o">+</span>
		     <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">));</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">RTLLIB_STYPE_AUTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">challengelen</span><span class="p">)</span>
		<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">|=</span> <span class="n">RTLLIB_FCTL_WEP</span><span class="p">;</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mh">0x013a</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">auth</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">auth</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">auth</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_STATUS_SUCCESS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_probe_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">beacon_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_probe_response</span> <span class="o">*</span><span class="n">beacon_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encrypt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">atim_len</span><span class="p">,</span> <span class="n">erp_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_ex_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">erpinfo_content</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp_ht_cap_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_ht_cap_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp_ht_info_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_ht_info_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt_hi_throughput</span> <span class="o">*</span><span class="n">pHTInfo</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp_generic_ie_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp_generic_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_ex_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rate_ex_len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span>
		<span class="n">atim_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">atim_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_G</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_N_24G</span> <span class="o">&amp;&amp;</span>
	   <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurSuppCCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erp_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">erpinfo_content</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">buseprotection</span><span class="p">)</span>
			<span class="n">erpinfo_content</span> <span class="o">|=</span> <span class="n">ERP_UseProtection</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">erp_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
	<span class="n">encrypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;R-WEP&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">wpa_ie_len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_ht_cap_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">SelfHTCap</span><span class="p">);</span>
		<span class="n">tmp_ht_cap_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">SelfHTCap</span><span class="p">);</span>
		<span class="n">tmp_ht_info_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">SelfHTInfo</span><span class="p">);</span>
		<span class="n">tmp_ht_info_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">SelfHTInfo</span><span class="p">);</span>
		<span class="n">HTConstructCapabilityElement</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tmp_ht_cap_buf</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">tmp_ht_cap_len</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">HTConstructInfoElement</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tmp_ht_info_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_ht_info_len</span><span class="p">,</span>
				       <span class="n">encrypt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bRegRT2RTAggregation</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_generic_ie_buf</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">szRT2RTAggBuffer</span><span class="p">;</span>
			<span class="n">tmp_generic_ie_len</span> <span class="o">=</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">szRT2RTAggBuffer</span><span class="p">);</span>
			<span class="n">HTConstructRT2RTAggElement</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">tmp_generic_ie_buf</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">tmp_generic_ie_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">beacon_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_probe_response</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span>
		<span class="n">ssid_len</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">rate_len</span> <span class="o">+</span> <span class="n">rate_ex_len</span> <span class="o">+</span> <span class="n">atim_len</span> <span class="o">+</span> <span class="n">erp_len</span>
		<span class="o">+</span> <span class="n">wpa_ie_len</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">beacon_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">beacon_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_probe_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">beacon_size</span> <span class="o">-</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span>
		<span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">);</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span>
		<span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">short_slot</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span>
	    <span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">))</span>
		<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span>
				 <span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">));</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
		<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">);</span>


	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_STYPE_PROBE_RESP</span><span class="p">);</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">MFIE_TYPE_SSID</span><span class="p">;</span>
	<span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">beacon_buf</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">+=</span> <span class="n">ssid_len</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">rate_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="n">rate_len</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">+=</span> <span class="n">rate_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_DS_SET</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atim_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_IBSS_SET</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		 <span class="n">val16</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">atim_window</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tag</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val16</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erp_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_ERP</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">erpinfo_content</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_ex_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES_EX</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">rate_ex_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">,</span> <span class="n">rate_ex_len</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="n">rate_ex_len</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wpa_ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_assoc_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="n">assoc</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="n">rtllib_MFIE_rate_len</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span><span class="p">)</span> <span class="o">+</span> <span class="n">rate_len</span> <span class="o">+</span>
		  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">assoc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span><span class="p">));</span>

	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_STYPE_ASSOC_RESP</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">?</span>
		<span class="n">WLAN_CAPABILITY_ESS</span> <span class="o">:</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">short_slot</span><span class="p">)</span>
		<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span>
				 <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span><span class="p">)</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">encrypt</span> <span class="o">=</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span><span class="p">)</span>
		<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">);</span>

	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">==</span> <span class="mh">0x2007</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rate_len</span><span class="p">);</span>
	<span class="n">rtllib_MFIE_Brate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">rtllib_MFIE_Grate</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_auth_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">);</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">));</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_AUTH_OPEN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_STYPE_AUTH</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>


<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_null_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">pwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span><span class="p">)</span><span class="o">+</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
	      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_FTYPE_DATA</span> <span class="o">|</span>
		<span class="n">RTLLIB_STYPE_NULLFUNC</span> <span class="o">|</span> <span class="n">RTLLIB_FCTL_TODS</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">pwr</span> <span class="o">?</span> <span class="n">RTLLIB_FCTL_PM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>


<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_pspoll_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_pspoll_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_pspoll_hdr</span><span class="p">)</span><span class="o">+</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_pspoll_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
	      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_pspoll_hdr</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">|</span> <span class="mh">0xc000</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_FTYPE_CTL</span> <span class="o">|</span> <span class="n">RTLLIB_STYPE_PSPOLL</span> <span class="o">|</span>
			 <span class="n">RTLLIB_FCTL_PM</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_resp_to_assoc_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rtllib_assoc_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_resp_to_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rtllib_auth_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_resp_to_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rtllib_probe_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>


<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">SecIsInPMKIDList</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bUsed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PMKID_CACHE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_PMKID_CACHE</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_association_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_assoc_request_frame</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="o">*</span><span class="n">ies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ht_cap_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ht_cap_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">realtek_ie_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">realtek_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wps_ie_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ckip_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccxrm_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cxvernum_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encrypt</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">PMKCacheIdx</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">?</span>
				<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span> <span class="o">?</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">)</span> <span class="o">+</span>
				<span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wmm_info_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">?</span> <span class="mi">9</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">turbo_info_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">Turbo_Enable</span> <span class="o">?</span> <span class="mi">9</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">encrypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span>
			  <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;R-WEP&quot;</span><span class="p">)</span> <span class="o">||</span>
			  <span class="n">wpa_ie_len</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">encrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ap_sec_type</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ap_sec_type</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEC_ALG_TKIP</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bForcedBgMode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WIRELESS_MODE_G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ht_cap_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">SelfHTCap</span><span class="p">);</span>
		<span class="n">ht_cap_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">SelfHTCap</span><span class="p">);</span>
		<span class="n">HTConstructCapabilityElement</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">ht_cap_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ht_cap_len</span><span class="p">,</span>
					     <span class="n">encrypt</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentRT2RTAggregation</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">realtek_ie_buf</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">szRT2RTAggBuffer</span><span class="p">;</span>
			<span class="n">realtek_ie_len</span> <span class="o">=</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">szRT2RTAggBuffer</span><span class="p">);</span>
			<span class="n">HTConstructRT2RTAggElement</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">realtek_ie_buf</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">realtek_ie_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bCkipSupported</span><span class="p">)</span>
		<span class="n">ckip_ie_len</span> <span class="o">=</span> <span class="mi">30</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bCcxRmEnable</span><span class="p">)</span>
		<span class="n">ccxrm_ie_len</span> <span class="o">=</span> <span class="mi">6</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">BssCcxVerNumber</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">cxvernum_ie_len</span> <span class="o">=</span> <span class="mi">5</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">PMKCacheIdx</span> <span class="o">=</span> <span class="n">SecIsInPMKIDList</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PMKCacheIdx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wpa_ie_len</span> <span class="o">+=</span> <span class="mi">18</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;[PMK cache]: WPA2 IE length: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_request_frame</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
		<span class="o">+</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span>
		<span class="o">+</span> <span class="n">rate_len</span>
		<span class="o">+</span> <span class="n">wpa_ie_len</span>
		<span class="o">+</span> <span class="n">wps_ie_len</span>
		<span class="o">+</span> <span class="n">wmm_info_len</span>
		<span class="o">+</span> <span class="n">turbo_info_len</span>
		<span class="o">+</span> <span class="n">ht_cap_len</span>
		<span class="o">+</span> <span class="n">realtek_ie_len</span>
		<span class="o">+</span> <span class="n">ckip_ie_len</span>
		<span class="o">+</span> <span class="n">ccxrm_ie_len</span>
		<span class="o">+</span> <span class="n">cxvernum_ie_len</span>
		<span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_request_frame</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_request_frame</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>


	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">RTLLIB_STYPE_ASSOC_REQ</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">37</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_ESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">short_slot</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span><span class="o">&amp;</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">))</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">);</span>


	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">MFIE_TYPE_SSID</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rate_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_RATES_EX</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_ex_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_ex</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bCkipSupported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="n">u8</span>	<span class="n">AironetIeOui</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">};</span>
		<span class="n">u8</span>	<span class="n">CcxAironetBuf</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">octet_string</span> <span class="n">osCcxAironetIE</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">CcxAironetBuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Octet</span> <span class="o">=</span> <span class="n">CcxAironetBuf</span><span class="p">;</span>
		<span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CcxAironetBuf</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Octet</span><span class="p">,</span> <span class="n">AironetIeOui</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">AironetIeOui</span><span class="p">));</span>

		<span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Octet</span><span class="p">[</span><span class="n">IE_CISCO_FLAG_POSITION</span><span class="p">]</span> <span class="o">|=</span>
					 <span class="p">(</span><span class="n">SUPPORT_CKIP_PK</span><span class="o">|</span><span class="n">SUPPORT_CKIP_MIC</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ckip_ie_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_AIRONET</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Octet</span><span class="p">,</span> <span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="n">osCcxAironetIE</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bCcxRmEnable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="n">u8</span> <span class="n">CcxRmCapBuf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
		<span class="k">struct</span> <span class="n">octet_string</span> <span class="n">osCcxRmCap</span><span class="p">;</span>

		<span class="n">osCcxRmCap</span><span class="p">.</span><span class="n">Octet</span> <span class="o">=</span> <span class="n">CcxRmCapBuf</span><span class="p">;</span>
		<span class="n">osCcxRmCap</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CcxRmCapBuf</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ccxrm_ie_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">osCcxRmCap</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">osCcxRmCap</span><span class="p">.</span><span class="n">Octet</span><span class="p">,</span> <span class="n">osCcxRmCap</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="n">osCcxRmCap</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">BssCcxVerNumber</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">CcxVerNumBuf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
		<span class="k">struct</span> <span class="n">octet_string</span> <span class="n">osCcxVerNum</span><span class="p">;</span>
		<span class="n">CcxVerNumBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">BssCcxVerNumber</span><span class="p">;</span>
		<span class="n">osCcxVerNum</span><span class="p">.</span><span class="n">Octet</span> <span class="o">=</span> <span class="n">CcxVerNumBuf</span><span class="p">;</span>
		<span class="n">osCcxVerNum</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CcxVerNumBuf</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cxvernum_ie_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">osCcxVerNum</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">osCcxVerNum</span><span class="p">.</span><span class="n">Octet</span><span class="p">,</span> <span class="n">osCcxVerNum</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">+=</span> <span class="n">osCcxVerNum</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">ePeerHTSpecVer</span> <span class="o">!=</span> <span class="n">HT_SPEC_VER_EWC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ht_cap_len</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_HT_CAP</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">ht_cap_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ht_cap_buf</span><span class="p">,</span> <span class="n">ht_cap_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">tag</span> <span class="o">+=</span> <span class="n">ht_cap_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wpa_ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">PMKCacheIdx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">PMKIDList</span><span class="p">[</span><span class="n">PMKCacheIdx</span><span class="p">].</span><span class="n">PMKID</span><span class="p">,</span>
			       <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wmm_info_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wmm_info_len</span><span class="p">);</span>
		<span class="n">rtllib_WMM_Info</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wps_ie_len</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wps_ie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">wps_ie_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wps_ie</span><span class="p">,</span> <span class="n">wps_ie_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">turbo_info_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">turbo_info_len</span><span class="p">)</span>
		<span class="n">rtllib_TURBO_Info</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">ePeerHTSpecVer</span> <span class="o">==</span> <span class="n">HT_SPEC_VER_EWC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ht_cap_len</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">ht_cap_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">ht_cap_buf</span><span class="p">,</span> <span class="n">ht_cap_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">tag</span> <span class="o">+=</span> <span class="n">ht_cap_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentRT2RTAggregation</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">realtek_ie_len</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">MFIE_TYPE_GENERIC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tag</span><span class="o">++</span> <span class="o">=</span> <span class="n">realtek_ie_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">realtek_ie_buf</span><span class="p">,</span> <span class="n">realtek_ie_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ies</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="n">ies</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies</span><span class="p">,</span> <span class="n">ies</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies_len</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s()Warning: can&#39;t alloc memory for assocreq&quot;</span>
		       <span class="s">&quot;_ies</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_associate_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* don&#39;t scan, and avoid to have the RX path possibily</span>
<span class="cm">	 * try again to associate. Even do not react to AUTH or</span>
<span class="cm">	 * ASSOC response. Just wait for the retry wq to be scheduled.</span>
<span class="cm">	 * Here we will check if there are good nets to associate</span>
<span class="cm">	 * with, so we retry or just get back to NO_LINK and scanning</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_ASSOCIATING_AUTHENTICATING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Authentication failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">no_auth_rs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Association failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">no_ass_rs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_ASSOCIATING_RETRY</span><span class="p">;</span>

	<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">,</span>
			   <span class="n">RTLLIB_SOFTMAC_ASSOC_RETRY_TIME</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_associate_abort_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtllib_associate_abort</span><span class="p">((</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_associate_step1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Stopping scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_auth_rq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_authentication_req</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">daddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">rtllib_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_ASSOCIATING_AUTHENTICATING</span> <span class="p">;</span>
		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Sending authentication request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_auth_challenge</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">challenge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_auth_rq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_authentication_req</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">chlen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">rtllib_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">chlen</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">MFIE_TYPE_CHALLENGE</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">chlen</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span> <span class="n">chlen</span><span class="p">);</span>

		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Sending authentication challenge &quot;</span>
				  <span class="s">&quot;response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">rtllib_encrypt_fragment</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span><span class="p">));</span>

		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">challenge</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_associate_step2</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>

	<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Sending association request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_ass_rq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_association_req</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">rtllib_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define CANCELLED  2</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_associate_complete_wq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="p">)</span>
				     <span class="n">container_of_work_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rtllib_device</span><span class="p">,</span>
				     <span class="n">associate_complete_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="n">pPSC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Associated successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_silent_reset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;normal associate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_roaming</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtllib_is_54g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_OFDM_MODULATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using G rates:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE_B</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using B rates:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Successfully associated, ht enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">HTOnAssocRsp</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Successfully associated, ht not &quot;</span>
		       <span class="s">&quot;enabled(%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span><span class="p">,</span>
		       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dot11HTOperationalRateSet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotNum</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span>
				       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">/</span>
				       <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LpsIdleCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_silent_reset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;silent reset associate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_silent_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_sta_send_associnfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_associate_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_LINKED</span><span class="p">;</span>
	<span class="n">rtllib_sta_send_associnfo</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">queue_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_complete_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_associate_procedure_wq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of_dwork_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rtllib_device</span><span class="p">,</span>
				     <span class="n">associate_procedure_wq</span><span class="p">);</span>
	<span class="n">rtllib_stop_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtllib_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;===&gt;%s(), chan:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">HTSetConnectBwMode</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">HT_CHANNEL_WIDTH_20</span><span class="p">,</span> <span class="n">HT_EXTCHNL_OFFSET_NO_EXT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">eRFPowerState</span> <span class="o">==</span> <span class="n">eRfOff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;=============&gt;%s():Rf state is eRfOff,&quot;</span>
			 <span class="s">&quot; schedule ipsleave wq again,return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave_wq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave_wq</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rtllib_associate_step1</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtllib_softmac_new_net</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">net</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp_ssid</span><span class="p">[</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tmp_ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">short</span> <span class="n">apset</span><span class="p">,</span> <span class="n">ssidset</span><span class="p">,</span> <span class="n">ssidbroad</span><span class="p">,</span> <span class="n">apmatch</span><span class="p">,</span> <span class="n">ssidmatch</span><span class="p">;</span>

	<span class="cm">/* we are interested in new new only if we are not associated</span>
<span class="cm">	 * and we are not associating / authenticating</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span>
	    <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span>
	     <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ibss_maxjoin_chal</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the user specified the AP MAC, we need also the essid</span>
<span class="cm">		 * This could be obtained by beacons or, if the network does not</span>
<span class="cm">		 * broadcast it, it can be put manually.</span>
<span class="cm">		 */</span>
		<span class="n">apset</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wap_set</span><span class="p">;</span>
		<span class="n">ssidset</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span><span class="p">;</span>
		<span class="n">ssidbroad</span> <span class="o">=</span>  <span class="o">!</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
		<span class="n">apmatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				  <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssidbroad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssidmatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span>
				    <span class="n">net</span><span class="o">-&gt;</span><span class="n">hidden_ssid_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
				    <span class="n">net</span><span class="o">-&gt;</span><span class="n">hidden_ssid</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">hidden_ssid_len</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">hidden_ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">hidden_ssid</span><span class="p">,</span>
					<span class="n">net</span><span class="o">-&gt;</span><span class="n">hidden_ssid_len</span><span class="p">);</span>
				<span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">hidden_ssid_len</span><span class="p">;</span>
				<span class="n">ssidbroad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ssidmatch</span> <span class="o">=</span>
			   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
			   <span class="n">net</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">));</span>

		<span class="cm">/* if the user set the AP check if match.</span>
<span class="cm">		 * if the network does not broadcast essid we check the</span>
<span class="cm">		 *	 user supplied ANY essid</span>
<span class="cm">		 * if the network does broadcast and the user does not set</span>
<span class="cm">		 *	 essid it is OK</span>
<span class="cm">		 * if the network does broadcast and the user did set essid</span>
<span class="cm">		 * check if essid match</span>
<span class="cm">		 * if the ap is not set, check that the user set the bssid</span>
<span class="cm">		 * and the network does bradcast and that those two bssid match</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">apset</span> <span class="o">&amp;&amp;</span> <span class="n">apmatch</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">ssidset</span> <span class="o">&amp;&amp;</span> <span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="n">ssidmatch</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ssidset</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="n">ssidset</span><span class="p">)))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="o">!</span><span class="n">apset</span> <span class="o">&amp;&amp;</span> <span class="n">ssidset</span> <span class="o">&amp;&amp;</span> <span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="n">ssidmatch</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_roaming</span> <span class="o">&amp;&amp;</span> <span class="n">ssidset</span> <span class="o">&amp;&amp;</span> <span class="n">ssidbroad</span> <span class="o">&amp;&amp;</span> <span class="n">ssidmatch</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* if the essid is hidden replace it with the</span>
<span class="cm">			* essid provided by the user.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssidbroad</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">tmp_ssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
					<span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
				<span class="n">tmp_ssid_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssidbroad</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">tmp_ssid</span><span class="p">,</span>
					<span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">tmp_ssid_len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Linking with %s,channel:%d, qos:%d, &quot;</span>
			       <span class="s">&quot;myHT:%d, networkHT:%d, mode:%x cur_net.flags&quot;</span>
			       <span class="s">&quot;:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bEnableHT</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span>
			       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rtllib_act_scanning</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SCAN</span><span class="p">))</span>
				<span class="n">rtllib_stop_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">hwscan_ch_bk</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">HTResetIOTSetting</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wmm_acm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Join the network for the first time */</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AsocRetryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdSupportHT</span><span class="p">)</span>
					<span class="n">HTResetSelfAndSavePeerSetting</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">=</span>
								 <span class="nb">false</span><span class="p">;</span>

				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_ASSOCIATING</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">LED_CTL_START_TO_LINK</span><span class="p">);</span>
				<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rtllib_is_54g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_OFDM_MODULATION</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE_G</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using G rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE_B</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;Using B rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dot11HTOperationalRateSet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_LINKED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_softmac_check_all_nets</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* if the state become different that NOLINK means</span>
<span class="cm">		 * we had found what we are searching for</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">time_after</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span>
		    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
			<span class="n">rtllib_softmac_new_net</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">auth_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span><span class="o">**</span> <span class="n">challenge</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">)</span> <span class="o">-</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_info_element</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth resp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xcafe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">challenge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="o">==</span> <span class="n">MFIE_TYPE_CHALLENGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">chlen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">++</span><span class="p">);</span>
			<span class="o">*</span><span class="n">challenge</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="o">*</span><span class="n">chlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">challenge</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">chlen</span><span class="p">);</span>	<span class="cm">/*TODO - check here*/</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">auth_rq_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span><span class="p">)</span> <span class="o">-</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_info_element</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth request: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_authentication</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">)</span>
		<span class="k">return</span>  <span class="n">WLAN_STATUS_NOT_SUPPORTED_AUTH_ALG</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">probe_rq_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">skbend</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ssidlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>   <span class="o">*</span><span class="n">header</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>   <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bssid_match</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* corrupted */</span>

	<span class="n">bssid_match</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\xff\xff\xff\xff\xff\xff</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bssid_match</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">skbend</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">skbend</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssid</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">ssidlen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tag</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* point to the len field */</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span> <span class="cm">/* point to the last data byte of the tag */</span>
		<span class="n">tag</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* point to the next tag */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssidlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* ssid not found in tagged param */</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssidlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">assoc_rq_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_assoc_request_frame</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_request_frame</span><span class="p">)</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_info_element</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth request:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_request_frame</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">assoc_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">aid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="n">response_head</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span>  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;invalid len in auth resp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xcafe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">response_head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">response_head</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">;</span>

	<span class="n">status_code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">response_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">WLAN_STATUS_ASSOC_DENIED_RATES</span> <span class="o">||</span>
	   <span class="n">status_code</span> <span class="o">==</span> <span class="n">WLAN_STATUS_CAPS_UNSUPPORTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_N_24G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AsocRetryCount</span><span class="o">++</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">RT_ASOC_RETRY_LIMIT</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">|=</span> <span class="n">HT_IOT_ACT_PURE_N_MODE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AsocRetryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">response_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_rx_probe_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_probe_rq</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probe_rq_parse</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">tx_probe_rs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rtllib_resp_to_probe</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtllib_rx_auth_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_auth_rq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">auth_rq_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">rtllib_resp_to_auth</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtllib_rx_assoc_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u8</span> <span class="n">dest</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_ass_rq</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">assoc_rq_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">rtllib_resp_to_assoc_rq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;New client associated: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_sta_ps_send_null_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">pwr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rtllib_null_func</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">pwr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">softmac_ps_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_sta_ps_send_null_frame</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtllib_sta_ps_send_pspoll_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rtllib_pspoll_func</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">softmac_ps_mgmt_xmit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">rtllib_sta_ps_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_timeout</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dtim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="n">pPSC</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt_pwr_save_ctrl</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">PowerSaveControl</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LPSDelayCnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LPSDelayCnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtim</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">dtim_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dtim</span> <span class="o">&amp;</span> <span class="n">RTLLIB_DTIM_VALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">dtim_data</span> <span class="o">=</span> <span class="n">RTLLIB_DTIM_INVALID</span><span class="p">;</span>
	<span class="cm">/* there&#39;s no need to nofity AP that I find you buffered</span>
<span class="cm">	 * with broadcast packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtim</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RTLLIB_DTIM_UCAST</span> <span class="o">&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">timeout</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rx_ps_time</span> <span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">timeout</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_tail</span> <span class="o">!=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_queue_head</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bAwakePktSent</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u8</span>		<span class="n">MaxPeriod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">RegMaxLPSAwakeIntvl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">MaxPeriod</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">RegMaxLPSAwakeIntvl</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="n">MaxPeriod</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">dtim_period</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">MaxPeriod</span> <span class="o">=</span> <span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">RegMaxLPSAwakeIntvl</span><span class="p">;</span>
			<span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">=</span> <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">&gt;=</span>
					       <span class="n">MaxPeriod</span><span class="p">)</span> <span class="o">?</span> <span class="n">MaxPeriod</span> <span class="o">:</span>
					       <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">{</span>
			<span class="n">u8</span> <span class="n">LPSAwakeIntvl_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">period</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">dtim_period</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">tim</span><span class="p">.</span><span class="n">tim_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">&gt;</span> <span class="n">period</span><span class="p">)</span>
					<span class="n">LPSAwakeIntvl_tmp</span> <span class="o">=</span> <span class="n">period</span> <span class="o">+</span>
						 <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">-</span>
						 <span class="n">period</span><span class="p">)</span> <span class="o">-</span>
						 <span class="p">((</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span><span class="o">-</span><span class="n">period</span><span class="p">)</span> <span class="o">%</span>
						 <span class="n">period</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">LPSAwakeIntvl_tmp</span> <span class="o">=</span> <span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">&gt;</span>
				    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">tim</span><span class="p">.</span><span class="n">tim_count</span><span class="p">)</span>
					<span class="n">LPSAwakeIntvl_tmp</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span> <span class="o">-</span> <span class="n">count</span><span class="p">)</span> <span class="o">-</span>
					<span class="p">((</span><span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span><span class="o">-</span><span class="n">count</span><span class="p">)</span><span class="o">%</span><span class="n">period</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">LPSAwakeIntvl_tmp</span> <span class="o">=</span> <span class="n">pPSC</span><span class="o">-&gt;</span><span class="n">LPSAwakeIntvl</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="o">*</span><span class="n">time</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">last_dtim_sta_time</span>
			<span class="o">+</span> <span class="n">MSECS</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">*</span>
			<span class="n">LPSAwakeIntvl_tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>


<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtllib_sta_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">sleep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags2</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">==</span> <span class="n">RTLLIB_PS_DISABLED</span> <span class="o">||</span>
	     <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span>
	     <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_LINKED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RT_TRACE</span><span class="p">(</span><span class="n">COMP_DBG</span><span class="p">,</span> <span class="s">&quot;=====&gt;%s(): no need to ps,wake up!! &quot;</span>
			 <span class="s">&quot;ieee-&gt;ps is %d, ieee-&gt;iw_mode is %d, ieee-&gt;state&quot;</span>
			 <span class="s">&quot; is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">,</span>
			  <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
		<span class="n">rtllib_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sleep</span> <span class="o">=</span> <span class="n">rtllib_sta_ps_sleep</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>
	<span class="cm">/* 2 wake, 1 sleep, 0 do nothing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="n">LPS_IS_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">enter_sleep_state</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="n">LPS_IS_WAKE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_is_queue_empty</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="n">LPS_WAIT_NULL_DATA_SEND</span><span class="p">;</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rtllib_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bAwakePktSent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sleep</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

		<span class="n">rtllib_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_sta_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">nl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="n">LPS_IS_WAKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span>
			    <span class="n">HT_IOT_ACT_NULL_DATA_POWER_SAVING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rtllib_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rtllib_sta_ps_send_pspoll_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="n">LPS_IS_SLEEP</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_wake_up</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span>
		    <span class="n">HT_IOT_ACT_NULL_DATA_POWER_SAVING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rtllib_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ack_tx_to_ieee</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">rtllib_sta_ps_send_pspoll_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="n">LPS_IS_WAKE</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_ps_tx_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">short</span> <span class="n">success</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags2</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="n">LPS_WAIT_NULL_DATA_SEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Null frame with PS bit set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="n">LPS_IS_SLEEP</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">enter_sleep_state</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_time</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* if the card report not success we can&#39;t be sure the AP</span>
<span class="cm">		 * has not RXed so we can&#39;t assume the AP believe us awake</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* 21112005 - tx again null without PS bit if lost */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">==</span> <span class="n">LPS_IS_WAKE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span>
			    <span class="n">HT_IOT_ACT_NULL_DATA_POWER_SAVING</span><span class="p">)</span>
				<span class="n">rtllib_sta_ps_send_null_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rtllib_sta_ps_send_pspoll_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_ps_tx_ack</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_process_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">act</span> <span class="o">=</span> <span class="n">rtllib_get_payload</span><span class="p">((</span><span class="k">struct</span> <span class="n">rtllib_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">category</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTLLIB_DEBUG</span><span class="p">(</span><span class="n">RTLLIB_DL_ERR</span><span class="p">,</span> <span class="s">&quot;error to get payload of &quot;</span>
			     <span class="s">&quot;action frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">category</span> <span class="o">=</span> <span class="o">*</span><span class="n">act</span><span class="p">;</span>
	<span class="n">act</span><span class="o">++</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACT_CAT_BA</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">act</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACT_ADDBAREQ</span>:
			<span class="n">rtllib_rx_ADDBAReq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACT_ADDBARSP</span>:
			<span class="n">rtllib_rx_ADDBARsp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACT_DELBA</span>:
			<span class="n">rtllib_rx_DELBA</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rtllib_rx_assoc_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">errcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="n">assoc_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;received [RE]ASSOCIATION RESPONSE (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_ASSOCIATING_AUTHENTICATED</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">errcode</span> <span class="o">=</span> <span class="n">assoc_parse</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errcode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">network</span> <span class="o">=</span>
				 <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span><span class="p">),</span>
				 <span class="n">GFP_ATOMIC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">network</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_LINKED</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="n">aid</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_ass_ok</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* station support qos */</span>
			<span class="cm">/* Let the register setting default with Legacy station */</span>
			<span class="n">assoc_resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rtllib_parse_info_param</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">assoc_resp</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">,</span>
							<span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_resp</span><span class="p">),</span>
							<span class="n">network</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">network</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">PeerHTCapBuf</span><span class="p">,</span>
					       <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapBuf</span><span class="p">,</span>
					       <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTCapLen</span><span class="p">);</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">PeerHTInfoBuf</span><span class="p">,</span>
					       <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoBuf</span><span class="p">,</span>
					       <span class="n">network</span><span class="o">-&gt;</span><span class="n">bssht</span><span class="p">.</span><span class="n">bdHTInfoLen</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">handle_assoc_response</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">handle_assoc_response</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_assoc_response_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span>
						 <span class="n">network</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">network</span><span class="p">);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ies</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">assoc_resp</span><span class="o">-&gt;</span><span class="n">info_element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="n">ies</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies_len</span><span class="p">,</span>
						      <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span><span class="p">,</span> <span class="n">ies</span><span class="p">,</span>
				       <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies_len</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s()Warning: can&#39;t alloc &quot;</span>
				       <span class="s">&quot;memory for assocresp_ies</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rtllib_associate_complete</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* aid could not been allocated */</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_ass_err</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Association response status code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">errcode</span><span class="p">);</span>
			<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span>
				<span class="s">&quot;Association response status code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">errcode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">AsocRetryCount</span> <span class="o">&lt;</span> <span class="n">RT_ASOC_RETRY_LIMIT</span><span class="p">)</span>
				<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rtllib_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rtllib_rx_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">errcode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">challenge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bSupportNmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="n">bHalfSupportNmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_ASSOCIATING_AUTHENTICATING</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Received authentication response&quot;</span><span class="p">);</span>

			<span class="n">errcode</span> <span class="o">=</span> <span class="n">auth_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">challenge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">errcode</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">||</span> <span class="o">!</span><span class="n">challenge</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_ASSOCIATING_AUTHENTICATED</span><span class="p">;</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_auth_rs_ok</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">IOTAction</span> <span class="o">&amp;</span>
					    <span class="n">HT_IOT_ACT_PURE_N_MODE</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">GetNmodeSupportBySecCfg</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">IsHTHalfNmodeAPs</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">bSupportNmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
								<span class="n">bHalfSupportNmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">bSupportNmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
								<span class="n">bHalfSupportNmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="cm">/* Dummy wirless mode setting to avoid</span>
<span class="cm">					 * encryption issue */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bSupportNmode</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/*TODO*/</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
								      <span class="n">IEEE_G</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span>
					    <span class="n">IEEE_N_24G</span> <span class="o">&amp;&amp;</span>
					    <span class="n">bHalfSupportNmode</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;======&gt;enter &quot;</span>
						       <span class="s">&quot;half N mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bHalfWirelessN24GMode</span> <span class="o">=</span>
									 <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bHalfWirelessN24GMode</span> <span class="o">=</span>
									 <span class="nb">false</span><span class="p">;</span>

					<span class="n">rtllib_associate_step2</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rtllib_auth_challenge</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span>
							      <span class="n">chlen</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">rx_auth_rs_err</span><span class="o">++</span><span class="p">;</span>
				<span class="n">RTLLIB_DEBUG_MGMT</span><span class="p">(</span><span class="s">&quot;Authentication respose&quot;</span>
						  <span class="s">&quot; status code 0x%x&quot;</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>

				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Authentication respose &quot;</span>
				       <span class="s">&quot;status code 0x%x&quot;</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>
				<span class="n">rtllib_associate_abort</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtllib_rx_auth_rq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rtllib_rx_deauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FIXME for now repeat all the association procedure</span>
<span class="cm">	* both for disassociation and deauthentication</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;==========&gt;received disassoc/deauth(%x) &quot;</span>
		       <span class="s">&quot;frame, reason code:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">),</span>
		       <span class="p">((</span><span class="k">struct</span> <span class="n">rtllib_disassoc</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_ASSOCIATING</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">reassoc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_roaming</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">bBusyTraffic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">rtllib_disassociate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="n">RemovePeerTS</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">LED_CTL_START_TO_LINK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ap_sec_type</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">SEC_ALG_CCMP</span><span class="o">|</span><span class="n">SEC_ALG_TKIP</span><span class="p">)))</span>
			<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rtllib_rx_frame_softmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rtllib_rx_stats</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">stype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">WLAN_FC_GET_STYPE</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_ctl</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_ASSOC_RESP</span>:
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_REASSOC_RESP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rtllib_rx_assoc_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_ASSOC_REQ</span>:
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_REASSOC_REQ</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_ASSOCIATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
			<span class="n">rtllib_rx_assoc_rq</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_AUTH</span>:
		<span class="n">rtllib_rx_auth</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_DISASSOC</span>:
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_DEAUTH</span>:
		<span class="n">rtllib_rx_deauth</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTLLIB_STYPE_MANAGE_ACT</span>:
		<span class="n">rtllib_process_action</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* following are for a simplier TX queue management.</span>
<span class="cm"> * Instead of using netif_[stop/wake]_queue the driver</span>
<span class="cm"> * will use these two functions (plus a reset one), that</span>
<span class="cm"> * will internally use the kernel netif_* and takes</span>
<span class="cm"> * care of the ieee802.11 fragmentation.</span>
<span class="cm"> * So the driver receives a fragment per time and might</span>
<span class="cm"> * call the stop function when it wants to not</span>
<span class="cm"> * have enough room to TX an entire packet.</span>
<span class="cm"> * This might be useful if each fragment needs it&#39;s own</span>
<span class="cm"> * descriptor, thus just keep a total free memory &gt; than</span>
<span class="cm"> * the max fragmentation threshold is not enough.. If the</span>
<span class="cm"> * ieee802.11 stack passed a TXB struct then you need</span>
<span class="cm"> * to keep N free descriptors where</span>
<span class="cm"> * N = MAX_PACKET_SIZE / MIN_FRAG_TRESHOLD</span>
<span class="cm"> * In this way you need just one and the 802.11 stack</span>
<span class="cm"> * will take care of buffering fragments and pass them to</span>
<span class="cm"> * to the driver later, when it wakes the queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtllib_softmac_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_txb</span> <span class="o">*</span><span class="n">txb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue_index</span> <span class="o">=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">queue_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="n">tcb_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* called with 2nd parm 0, no tx mgmt lock required */</span>
	<span class="n">rtllib_sta_wakeup</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* update the tx status */</span>
	<span class="n">tcb_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cb_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">+</span>
		   <span class="n">MAX_DEV_ADDR_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcb_desc</span><span class="o">-&gt;</span><span class="n">bMulticast</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* if xmit available, just xmit it immediately, else just insert it to</span>
<span class="cm">	 * the wait queue */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_len</span> <span class="o">=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">queue_len</span>  <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>\
		    <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">check_nic_enough_desc</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">queue_index</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* insert the skb packet to the wait queue */</span>
			<span class="cm">/* as for the completion function, it does not need</span>
<span class="cm">			 * to check it any more.</span>
<span class="cm">			 * */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue_len</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">skb_waitQ</span><span class="p">[</span><span class="n">queue_index</span><span class="p">],</span>
					       <span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span>
					<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtllib_txb_free</span><span class="p">(</span><span class="n">txb</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* called with ieee-&gt;lock acquired */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_resume_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">frag</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtllib_txb_free</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtllib_reset_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">init_mgmt_queue</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtllib_txb_free</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_reset_queue</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtllib_wake_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>  <span class="o">*</span><span class="n">header</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_SINGLE_QUEUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dequeue_mgmt</span><span class="p">(</span><span class="n">ieee</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_hdr_3addr</span>  <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="n">header</span><span class="o">-&gt;</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_data_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">&amp;&amp;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span><span class="p">)</span>
		<span class="n">rtllib_resume_tx</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">&amp;&amp;</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">swtxawake</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">rtllib_stop_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_stats</span><span class="p">.</span><span class="n">swtxstop</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_stop_all_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_wake_all_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtllib_randomize_cell</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* an IBSS cell address must have the two less significant</span>
<span class="cm">	 * bits of the first byte = 2</span>
<span class="cm">	 */</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called in user context only */</span>
<span class="kt">void</span> <span class="nf">rtllib_start_master_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
			<span class="n">RTLLIB_DEFAULT_TX_ESSID</span><span class="p">,</span>
			<span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span>
				 <span class="n">strlen</span><span class="p">(</span><span class="n">RTLLIB_DEFAULT_TX_ESSID</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_chan</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_LINKED</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_start_monitor_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset hardware status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">raw_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_start_ibss_wq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of_dwork_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rtllib_device</span><span class="p">,</span> <span class="n">start_ibss_wq</span><span class="p">);</span>
	<span class="cm">/* iwconfig mode ad-hoc will schedule this and return</span>
<span class="cm">	 * on the other hand this will block further iwconfig SET</span>
<span class="cm">	 * operations because of the wx_sem hold.</span>
<span class="cm">	 * Anyway some most set operations set a flag to speed-up</span>
<span class="cm">	 * (abort) this wq (when syncro scanning) before sleeping</span>
<span class="cm">	 * on the semaphore</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;==========oh driver down return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">RTLLIB_DEFAULT_TX_ESSID</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">RTLLIB_DEFAULT_TX_ESSID</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IEEE_G</span><span class="p">;</span>
	<span class="cm">/* check if we have this cell in our network list */</span>
	<span class="n">rtllib_softmac_check_all_nets</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>


	<span class="cm">/* if not then the state is not linked. Maybe the user switched to</span>
<span class="cm">	 * ad-hoc mode just after being in monitor mode, or just after</span>
<span class="cm">	 * being very few time in managed mode (so the card have had no</span>
<span class="cm">	 * time to scan all the chans..) or we have just run up the iface</span>
<span class="cm">	 * after setting ad-hoc mode. So we have to give another try..</span>
<span class="cm">	 * Here, in ibss mode, should be safe to do this without extra care</span>
<span class="cm">	 * (in bss mode we had to make sure no-one tried to associate when</span>
<span class="cm">	 * we had just checked the ieee-&gt;state and we was going to start the</span>
<span class="cm">	 * scan) because in ibss mode the rtllib_new_net function, when</span>
<span class="cm">	 * finds a good net, just set the ieee-&gt;state to RTLLIB_LINKED,</span>
<span class="cm">	 * so, at worst, we waste a bit of time to initiate an unneeded syncro</span>
<span class="cm">	 * scan, that will stop at the first round because it sees the state</span>
<span class="cm">	 * associated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_NOLINK</span><span class="p">)</span>
		<span class="n">rtllib_start_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* the network definitively is not here.. create a new cell */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_NOLINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;creating new IBSS cell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">IbssStartChnl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wap_set</span><span class="p">)</span>
			<span class="n">rtllib_randomize_cell</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_CCK_MODULATION</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				 <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_1MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				 <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_2MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				 <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_5MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				 <span class="n">RTLLIB_BASIC_RATE_MASK</span> <span class="o">|</span> <span class="n">RTLLIB_CCK_RATE_11MB</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">&amp;</span> <span class="n">RTLLIB_OFDM_MODULATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_6MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_9MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_12MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_18MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_24MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_36MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_48MB</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
						 <span class="n">RTLLIB_OFDM_RATE_54MB</span><span class="p">;</span>

			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">rates_ex_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">qos_data</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetWirelessMode</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE_G</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s(): ieee-&gt;mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_N_24G</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IEEE_N_5G</span><span class="p">))</span>
		<span class="n">HTUseDefaultSetting</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pHTInfo</span><span class="o">-&gt;</span><span class="n">bCurrentHTSupport</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_MEDIA_STATUS</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_LINKED</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">HTSetConnectBwMode</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">HT_CHANNEL_WIDTH_20</span><span class="p">,</span> <span class="n">HT_EXTCHNL_OFFSET_NO_EXT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LedControlHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">LED_CTL_LINK</span><span class="p">);</span>

	<span class="n">rtllib_start_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_resume</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtllib_start_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_ibss_wq</span><span class="p">,</span> <span class="n">MSECS</span><span class="p">(</span><span class="mi">150</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* this is called only in user context, with wx_sem held */</span>
<span class="kt">void</span> <span class="nf">rtllib_start_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_COUNTRY_IE_VALID</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bGlobalDomain</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check if we have already found the net we</span>
<span class="cm">	 * are interested in (if any).</span>
<span class="cm">	 * if not (we are disassociated and we are not</span>
<span class="cm">	 * in associating / authenticating phase) start the background scanning.</span>
<span class="cm">	 */</span>
	<span class="n">rtllib_softmac_check_all_nets</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="cm">/* ensure no-one start an associating process (thus setting</span>
<span class="cm">	 * the ieee-&gt;state to rtllib_ASSOCIATING) while we</span>
<span class="cm">	 * have just checked it and we are going to enable scan.</span>
<span class="cm">	 * The rtllib_new_net function is always called with</span>
<span class="cm">	 * lock held (from both rtllib_softmac_check_all_nets and</span>
<span class="cm">	 * the rx path), so we cannot be in the middle of such function</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_NOLINK</span><span class="p">)</span>
		<span class="n">rtllib_start_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_link_change_wq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of_dwork_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rtllib_device</span><span class="p">,</span> <span class="n">link_change_wq</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* called only in userspace context */</span>
<span class="kt">void</span> <span class="nf">rtllib_disassociate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">&amp;</span> <span class="n">IEEE_SOFTMAC_TX_QUEUE</span><span class="p">)</span>
			<span class="n">rtllib_reset_queue</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">data_hard_stop</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DOT11D_ENABLE</span><span class="p">(</span><span class="n">ieee</span><span class="p">))</span>
		<span class="n">Dot11d_Reset</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_set_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wap_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">queue_delayed_work_rsl</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_associate_retry_wq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span> <span class="o">=</span> <span class="n">container_of_dwork_rsl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rtllib_device</span><span class="p">,</span> <span class="n">associate_retry_wq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RTLLIB_ASSOCIATING_RETRY</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* until we do not set the state to RTLLIB_NOLINK</span>
<span class="cm">	* there are no possibility to have someone else trying</span>
<span class="cm">	* to start an association procedure (we get here with</span>
<span class="cm">	* ieee-&gt;state = RTLLIB_ASSOCIATING).</span>
<span class="cm">	* When we set the state to RTLLIB_NOLINK it is possible</span>
<span class="cm">	* that the RX path run an attempt to associate, but</span>
<span class="cm">	* both rtllib_softmac_check_all_nets and the</span>
<span class="cm">	* RX path works with ieee-&gt;lock held so there are no</span>
<span class="cm">	* problems. If we are still disassociated then start a scan.</span>
<span class="cm">	* the lock here is necessary to ensure no one try to start</span>
<span class="cm">	* an association procedure when we have just checked the</span>
<span class="cm">	* state and we are going to start the scan.</span>
<span class="cm">	*/</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>

	<span class="n">rtllib_softmac_check_all_nets</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_NOLINK</span><span class="p">)</span>
		<span class="n">rtllib_start_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_get_beacon_</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">broadcast_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_probe_response</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_probe_resp</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">broadcast_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_probe_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_STYPE_BEACON</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_get_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_probe_response</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_get_beacon_</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_probe_response</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFFF</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_get_beacon</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtllib_softmac_stop_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mesh_flag</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">shutdown</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtllib_stop_scan_syncro</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">rtllib_stop_protocol</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">shutdown</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_softmac_stop_protocol</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">rtllib_stop_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">shutdown</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_stoppping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rtllib_ips_leave</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtllib_stop_send_beacons</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_ibss_wq</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change_wq</span><span class="p">);</span>
	<span class="n">rtllib_stop_scan</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">RTLLIB_ASSOCIATING_AUTHENTICATED</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
			<span class="n">SendDisassociation</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">deauth_lv_ss</span><span class="p">);</span>
		<span class="n">rtllib_disassociate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RemoveAllTS</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_stoppping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocreq_ies_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assocresp_ies_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_softmac_start_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mesh_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">rtllib_start_protocol</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_softmac_start_protocol</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtllib_start_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtllib_update_active_chan_map</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="n">MAX_CHANNEL_NUMBER</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span> <span class="cm">/* no channel found */</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">active_channel_map</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxseq_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_rxfrag_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">last_packet_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">UpdateBeaconInterruptHandler</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">UpdateBeaconInterruptHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wmm_acm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* if the user set the MAC of the ad-hoc cell and then</span>
<span class="cm">	 * switch to managed mode, shall we  make sure that association</span>
<span class="cm">	 * attempts does not fail just because the user provide the essid</span>
<span class="cm">	 * and the nic is still checking for the AP MAC ??</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtllib_start_bss</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">UpdateBeaconInterruptHandler</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">UpdateBeaconInterruptHandler</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="n">rtllib_start_ibss</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtllib_start_master_bss</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtllib_start_monitor_mode</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_softmac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span><span class="p">));</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pDot11dInfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_dot11d_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pDot11dInfo</span><span class="p">)</span>
		<span class="n">RTLLIB_DEBUG</span><span class="p">(</span><span class="n">RTLLIB_DL_ERR</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc memory for DOT11D</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">SlotNum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvBcnInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRecvDataInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumTxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">LinkDetectInfo</span><span class="p">.</span><span class="n">NumRxUnicastOkInPeriod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">bIsAggregateFrame</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">queue_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scanning_continue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wap_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ssid_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">proto_stoppping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span> <span class="n">RTLLIB_DEFAULT_BASIC_RATE</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">=</span> <span class="n">RTLLIB_PS_DISABLED</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_sleep</span> <span class="o">=</span> <span class="n">LPS_IS_WAKE</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11HTOperationalRateSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11HTOperationalRateSet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11HTOperationalRateSet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11TxHTOperationalRateSet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11TxHTOperationalRateSet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">Regdot11TxHTOperationalRateSet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">FirstIe_InScan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">actscanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beinretry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">is_set_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">init_mgmt_queue</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>

	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_edca_param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000A403</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_edca_param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0000A427</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_edca_param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x005E4342</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">sta_edca_param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x002F3262</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">aggregation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">enable_rx_imm_BA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">.</span><span class="n">txb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">_setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">,</span>
		    <span class="n">rtllib_associate_abort_cb</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ieee</span><span class="p">);</span>

	<span class="n">_setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">,</span>
		    <span class="n">rtllib_send_beacon_cb</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ieee</span><span class="p">);</span>


	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">create_workqueue</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">link_change_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_link_change_wq</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">start_ibss_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_start_ibss_wq</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="n">INIT_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_complete_wq</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_associate_complete_wq</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_procedure_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_associate_procedure_wq</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_scan_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_softmac_scan_wq</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">softmac_hint11d_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_softmac_hint11d_wq</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_associate_retry_wq</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
	<span class="n">INIT_WORK_RSL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sync_scan_wq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rtllib_wx_sync_scan_wq</span><span class="p">,</span>
		      <span class="n">ieee</span><span class="p">);</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">scan_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ips_sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">mgmt_tx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ps_task</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">rtllib_sta_ps</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ieee</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_softmac_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pDot11dInfo</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">pDot11dInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_timer</span><span class="p">);</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">associate_retry_wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************</span>
<span class="cm"> * Start of WPA code.				        *</span>
<span class="cm"> * this is stolen from the ipw2200 driver	        *</span>
<span class="cm"> ********************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtllib_wpa_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is called when wpa_supplicant loads and closes the driver</span>
<span class="cm">	 * interface. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s WPA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span> <span class="o">?</span> <span class="s">&quot;enabling&quot;</span> <span class="o">:</span> <span class="s">&quot;disabling&quot;</span><span class="p">);</span>
	<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_enabled</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ap_mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtllib_wpa_assoc_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">wpa_ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* make sure WPA is enabled */</span>
	<span class="n">rtllib_wpa_enable</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rtllib_disassociate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtllib_wpa_mlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_MLME_STA_DEAUTH</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_MLME_STA_DISASSOC</span>:
		<span class="n">rtllib_disassociate</span><span class="p">(</span><span class="n">ieee</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unknown MLME request: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtllib_wpa_set_wpa_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_ie</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtllib_wpa_assoc_frame</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AUTH_ALG_OPEN_SYSTEM			0x1</span>
<span class="cp">#define AUTH_ALG_SHARED_KEY			0x2</span>
<span class="cp">#define AUTH_ALG_LEAP				0x4</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtllib_wpa_set_auth_algs</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">rtllib_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_AUTH_MODE</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AUTH_ALG_LEAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_LEAP</span>  <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtllib_wpa_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u8</span> <span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_WPA_ENABLED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtllib_wpa_enable</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_TKIP_COUNTERMEASURES</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_DROP_UNENCRYPTED</span>:
	<span class="p">{</span>
		<span class="cm">/* HACK:</span>
<span class="cm">		 *</span>
<span class="cm">		 * wpa_supplicant calls set_wpa_enabled when the driver</span>
<span class="cm">		 * is loaded and unloaded, regardless of if WPA is being</span>
<span class="cm">		 * used.  No other calls are made which can be used to</span>
<span class="cm">		 * determine if encryption will be used or not prior to</span>
<span class="cm">		 * association being expected.  If encryption is not being</span>
<span class="cm">		 * used, drop_unencrypted is set to false, else true -- we</span>
<span class="cm">		 * can use this to determine if the CAP_PRIVACY_ON bit should</span>
<span class="cm">		 * be set.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">rtllib_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEC_ENABLED</span><span class="p">,</span>
			<span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="cm">/* We only change SEC_LEVEL for open mode. Others</span>
<span class="cm">		 * are set by ipw_wpa_set_encryption.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
			<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_PRIVACY_INVOKED</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_AUTH_ALGS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtllib_wpa_set_auth_algs</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_PARAM_IEEE_802_1X</span>:
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">ieee802_1x</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE_PARAM_WPAX_SELECT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_suitlist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpax_suitlist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unknown WPA param: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* implementation borrowed from hostap driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtllib_wpa_set_encryption</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param_len</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">is_mesh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtllib_security</span> <span class="n">sec</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">[</span><span class="n">IEEE_CRYPT_ALG_NAME_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param_len</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Len mismatch %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param_len</span><span class="p">,</span>
			       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">NUM_WEP_KEYS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_0</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ENABLED</span> <span class="o">|</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sec</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ENABLED</span><span class="p">;</span>

	<span class="cm">/* IPW HW cannot build TKIP MIC, host decryption still needed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">||</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;R-TKIP&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_host_crypt</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;R-WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;rtllib_crypt_wep&quot;</span><span class="p">);</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;R-TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;rtllib_crypt_tkip&quot;</span><span class="p">);</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;R-CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;rtllib_crypt_ccmp&quot;</span><span class="p">);</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;unknown crypto alg &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_UNKNOWN_ALG</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">new_crypt</span><span class="p">;</span>

		<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>

		<span class="n">new_crypt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_crypt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">new_crypt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lib80211_crypt_data</span><span class="p">));</span>
		<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
			<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span>
				<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_crypt</span><span class="p">);</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_CRYPT_INIT_FAILED</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;key setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_KEY_SET_FAILED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">skip_host_crypt:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">set_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">active_key</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEC_ACTIVE_KEY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sec</span><span class="p">.</span><span class="n">keys</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">],</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">key_sizes</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;R-WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;R-TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;R-CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SEC_LEVEL</span><span class="p">;</span>
			<span class="n">sec</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">SEC_LEVEL_3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">)</span>
		<span class="n">ieee</span><span class="o">-&gt;</span><span class="n">set_security</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec</span><span class="p">);</span>

	<span class="cm">/* Do not reset port if card is in Managed mode since resetting will</span>
<span class="cm">	 * generate new IEEE 802.11 authentication which may end up in looping</span>
<span class="cm">	 * with IEEE 802.1X.  If your hardware requires a reset after WEP</span>
<span class="cm">	 * configuration (for example... Prism2), implement the reset_port in</span>
<span class="cm">	 * the callbacks structures used to initialize the 802.11 stack. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">reset_on_keychange</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">reset_port</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;reset_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">IEEE_CRYPT_ERR_CARD_CONF_FAILED</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_disauth_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u16</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_disauth</span> <span class="o">*</span><span class="n">disauth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_disauth</span><span class="p">)</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">disauth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_disauth</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_disauth</span><span class="p">));</span>
	<span class="n">disauth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_STYPE_DEAUTH</span><span class="p">);</span>
	<span class="n">disauth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">disauth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">disauth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">disauth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">disauth</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">asRsn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtllib_disassociate_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">u16</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtllib_disassoc</span> <span class="o">*</span><span class="n">disass</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_disassoc</span><span class="p">)</span> <span class="o">+</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">tx_headroom</span><span class="p">);</span>

	<span class="n">disass</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_disassoc</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_disassoc</span><span class="p">));</span>
	<span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RTLLIB_STYPE_DISASSOC</span><span class="p">);</span>
	<span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">disass</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">disass</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">asRsn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SendDisassociation</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="n">bool</span> <span class="n">deauth</span><span class="p">,</span> <span class="n">u16</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtllib_network</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deauth</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_disauth_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">asRsn</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rtllib_disassociate_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">ieee</span><span class="p">,</span> <span class="n">asRsn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">softmac_mgmt_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ieee</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">rtllib_ap_sec_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">ccmp_ie</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">ccmp_rsn_ie</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encrypt</span><span class="p">;</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">];</span>
	<span class="n">encrypt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span>
		  <span class="o">||</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;R-WEP&quot;</span><span class="p">)));</span>

	<span class="cm">/* simply judge  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wpa_ie_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">SEC_ALG_WEP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">wpa_ie_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xdd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">14</span><span class="p">]),</span> <span class="n">ccmp_ie</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">ccmp_rsn_ie</span><span class="p">,</span> <span class="mi">4</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">SEC_ALG_CCMP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">SEC_ALG_TKIP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">SEC_ALG_NONE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtllib_wpa_supplicant_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">is_mesh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_param</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE_CMD_SET_WPA_PARAM</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtllib_wpa_set_param</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_param</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
					<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpa_param</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_CMD_SET_WPA_IE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtllib_wpa_set_wpa_ie</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_CMD_SET_ENCRYPTION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtllib_wpa_set_encryption</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE_CMD_MLME</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rtllib_wpa_mlme</span><span class="p">(</span><span class="n">ieee</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
				   <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">reason_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unknown WPA supplicant request: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">wx_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_wpa_supplicant_ioctl</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rtllib_MgntDisconnectIBSS</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">rtllib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">OpMode</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">bFilterOutNonAssociatedBSSID</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>

	<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">OpMode</span> <span class="o">=</span> <span class="n">RT_OP_MODE_NO_LINK</span><span class="p">;</span>
	<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_BSSID</span><span class="p">,</span>
				<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
	<span class="n">OpMode</span> <span class="o">=</span> <span class="n">RT_OP_MODE_NO_LINK</span><span class="p">;</span>
	<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_MEDIA_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">OpMode</span><span class="p">);</span>
	<span class="n">rtllib_stop_send_beacons</span><span class="p">(</span><span class="n">rtllib</span><span class="p">);</span>

	<span class="n">bFilterOutNonAssociatedBSSID</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_CECHK_BSSID</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">bFilterOutNonAssociatedBSSID</span><span class="p">));</span>
	<span class="n">notify_wx_assoc_event</span><span class="p">(</span><span class="n">rtllib</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtllib_MlmeDisassociateRequest</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">rtllib</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">asSta</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">OpMode</span><span class="p">;</span>

	<span class="n">RemovePeerTS</span><span class="p">(</span><span class="n">rtllib</span><span class="p">,</span> <span class="n">asSta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">asSta</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
		<span class="n">OpMode</span> <span class="o">=</span> <span class="n">RT_OP_MODE_NO_LINK</span><span class="p">;</span>
		<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">OpMode</span> <span class="o">=</span> <span class="n">RT_OP_MODE_NO_LINK</span><span class="p">;</span>
		<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_MEDIA_STATUS</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">OpMode</span><span class="p">));</span>
		<span class="n">rtllib_disassociate</span><span class="p">(</span><span class="n">rtllib</span><span class="p">);</span>

		<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_BSSID</span><span class="p">,</span>
					<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>

	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">rtllib_MgntDisconnectAP</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">rtllib</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">asRsn</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">bFilterOutNonAssociatedBSSID</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bFilterOutNonAssociatedBSSID</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">SetHwRegHandler</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HW_VAR_CECHK_BSSID</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">bFilterOutNonAssociatedBSSID</span><span class="p">));</span>
	<span class="n">rtllib_MlmeDisassociateRequest</span><span class="p">(</span><span class="n">rtllib</span><span class="p">,</span> <span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
				       <span class="n">asRsn</span><span class="p">);</span>

	<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RTLLIB_NOLINK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">rtllib_MgntDisconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">rtllib</span><span class="p">,</span> <span class="n">u8</span> <span class="n">asRsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">!=</span> <span class="n">RTLLIB_PS_DISABLED</span><span class="p">)</span>
		<span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">sta_wake_up</span><span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="n">rtllib_MgntDisconnectIBSS</span><span class="p">(</span><span class="n">rtllib</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtllib</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
			<span class="n">rtllib_MgntDisconnectAP</span><span class="p">(</span><span class="n">rtllib</span><span class="p">,</span> <span class="n">asRsn</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rtllib_MgntDisconnect</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">notify_wx_assoc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtllib_device</span> <span class="o">*</span><span class="n">ieee</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">cannot_notify</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RTLLIB_LINKED</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ieee</span><span class="o">-&gt;</span><span class="n">current_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s(): Tell user space disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">ieee</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">notify_wx_assoc_event</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
