<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › media › go7007 › wis-sony-tuner.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>wis-sony-tuner.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005-2006 Micronas USA Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License (Version 2) as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software Foundation,</span>
<span class="cm"> * Inc., 59 Temple Place - Suite 330, Boston MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="cp">#include &quot;wis-i2c.h&quot;</span>

<span class="cm">/* #define MPX_DEBUG */</span>

<span class="cm">/* AS(IF/MPX) pin:      LOW      HIGH/OPEN</span>
<span class="cm"> * IF/MPX address:   0x42/0x40   0x43/0x44</span>
<span class="cm"> */</span>
<span class="cp">#define IF_I2C_ADDR	0x43</span>
<span class="cp">#define MPX_I2C_ADDR	0x44</span>

<span class="k">static</span> <span class="n">v4l2_std_id</span> <span class="n">force_band</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">force_band_str</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">force_band</span><span class="p">,</span> <span class="n">force_band_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">force_band_str</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">force_mpx_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_mpx_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/* Store tuner info in the same format as tuner.c, so maybe we can put the</span>
<span class="cm"> * Sony tuner support in there. */</span>
<span class="k">struct</span> <span class="n">sony_tunertype</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Vendor</span><span class="p">;</span> <span class="cm">/* unused here */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Type</span><span class="p">;</span> <span class="cm">/* unused here */</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">thresh1</span><span class="p">;</span> <span class="cm">/*  band switch VHF_LO &lt;=&gt; VHF_HI */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">thresh2</span><span class="p">;</span> <span class="cm">/*  band switch VHF_HI &lt;=&gt; UHF */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">VHF_L</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">VHF_H</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">UHF</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">IFPCoff</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* This array is indexed by (tuner_type - 200) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sony_tunertype</span> <span class="n">sony_tuners</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;Sony PAL+SECAM (BTF-PG472Z)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="mi">16</span><span class="o">*</span><span class="mf">144.25</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mf">427.25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mi">623</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Sony NTSC_JP (BTF-PK467Z)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="mi">16</span><span class="o">*</span><span class="mf">220.25</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mf">467.25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mi">940</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Sony NTSC (BTF-PB463Z)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="mi">16</span><span class="o">*</span><span class="mf">130.25</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mf">364.25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mi">732</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">wis_sony_tuner</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpxmode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">audmode</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Basically the same as default_set_tv_freq() in tuner.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wis_sony_tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">band_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">band_select</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sony_tunertype</span> <span class="o">*</span><span class="n">tun</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">tun</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sony_tuners</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">-</span> <span class="mi">200</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">thresh1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">band_name</span> <span class="o">=</span> <span class="s">&quot;VHF_L&quot;</span><span class="p">;</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">VHF_L</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">thresh2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">band_name</span> <span class="o">=</span> <span class="s">&quot;VHF_H&quot;</span><span class="p">;</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">VHF_H</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">band_name</span> <span class="o">=</span> <span class="s">&quot;UHF&quot;</span><span class="p">;</span>
		<span class="n">band_select</span> <span class="o">=</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">UHF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;wis-sony-tuner: tuning to frequency %d.%04d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">freq</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="n">freq</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">625</span><span class="p">,</span> <span class="n">band_name</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">+</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">IFPCoff</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_select</span><span class="p">;</span>
	<span class="n">i2c_master_send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpx_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">MPX_I2C_ADDR</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MPX register values for the BTF-PG472Z:</span>
<span class="cm"> *</span>
<span class="cm"> *                                 FM_     NICAM_  SCART_</span>
<span class="cm"> *          MODUS  SOURCE    ACB   PRESCAL PRESCAL PRESCAL SYSTEM  VOLUME</span>
<span class="cm"> *         10/0030 12/0008 12/0013 12/000E 12/0010 12/0000 10/0020 12/0000</span>
<span class="cm"> *         ---------------------------------------------------------------</span>
<span class="cm"> * Auto     1003    0020    0100    2603    5000    XXXX    0001    7500</span>
<span class="cm"> *</span>
<span class="cm"> * B/G</span>
<span class="cm"> *  Mono    1003    0020    0100    2603    5000    XXXX    0003    7500</span>
<span class="cm"> *  A2      1003    0020    0100    2601    5000    XXXX    0003    7500</span>
<span class="cm"> *  NICAM   1003    0120    0100    2603    5000    XXXX    0008    7500</span>
<span class="cm"> *</span>
<span class="cm"> * I</span>
<span class="cm"> *  Mono    1003    0020    0100    2603    7900    XXXX    000A    7500</span>
<span class="cm"> *  NICAM   1003    0120    0100    2603    7900    XXXX    000A    7500</span>
<span class="cm"> *</span>
<span class="cm"> * D/K</span>
<span class="cm"> *  Mono    1003    0020    0100    2603    5000    XXXX    0004    7500</span>
<span class="cm"> *  A2-1    1003    0020    0100    2601    5000    XXXX    0004    7500</span>
<span class="cm"> *  A2-2    1003    0020    0100    2601    5000    XXXX    0005    7500</span>
<span class="cm"> *  A2-3    1003    0020    0100    2601    5000    XXXX    0007    7500</span>
<span class="cm"> *  NICAM   1003    0120    0100    2603    5000    XXXX    000B    7500</span>
<span class="cm"> *</span>
<span class="cm"> * L/L&#39;</span>
<span class="cm"> *  Mono    0003    0200    0100    7C03    5000    2200    0009    7500</span>
<span class="cm"> *  NICAM   0003    0120    0100    7C03    5000    XXXX    0009    7500</span>
<span class="cm"> *</span>
<span class="cm"> * M</span>
<span class="cm"> *  Mono    1003    0200    0100    2B03    5000    2B00    0002    7500</span>
<span class="cm"> *</span>
<span class="cm"> * For Asia, replace the 0x26XX in FM_PRESCALE with 0x14XX.</span>
<span class="cm"> *</span>
<span class="cm"> * Bilingual selection in A2/NICAM:</span>
<span class="cm"> *</span>
<span class="cm"> *         High byte of SOURCE     Left chan   Right chan</span>
<span class="cm"> *                 0x01              MAIN         SUB</span>
<span class="cm"> *                 0x03              MAIN         MAIN</span>
<span class="cm"> *                 0x04              SUB          SUB</span>
<span class="cm"> *</span>
<span class="cm"> * Force mono in NICAM by setting the high byte of SOURCE to 0x02 (L/L&#39;) or</span>
<span class="cm"> * 0x00 (all other bands).  Force mono in A2 with FMONO_A2:</span>
<span class="cm"> *</span>
<span class="cm"> *                      FMONO_A2</span>
<span class="cm"> *                      10/0022</span>
<span class="cm"> *                      --------</span>
<span class="cm"> *     Forced mono ON     07F0</span>
<span class="cm"> *     Forced mono OFF    0190</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span> <span class="n">AUD_MONO</span><span class="p">,</span> <span class="n">AUD_A2</span><span class="p">,</span> <span class="n">AUD_NICAM</span><span class="p">,</span> <span class="n">AUD_NICAM_L</span> <span class="p">}</span> <span class="n">audio_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">modus</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">source</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">acb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fm_prescale</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nicam_prescale</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scart_prescale</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">system</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">volume</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mpx_audio_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Auto */</span>	<span class="p">{</span> <span class="n">AUD_MONO</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2603</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* B/G Mono */</span>	<span class="p">{</span> <span class="n">AUD_MONO</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2603</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* B/G A2 */</span>	<span class="p">{</span> <span class="n">AUD_A2</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2601</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* B/G NICAM */</span> <span class="p">{</span> <span class="n">AUD_NICAM</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2603</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* I Mono */</span>	<span class="p">{</span> <span class="n">AUD_MONO</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2603</span><span class="p">,</span>
					<span class="mh">0x7900</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* I NICAM */</span>	<span class="p">{</span> <span class="n">AUD_NICAM</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2603</span><span class="p">,</span>
					<span class="mh">0x7900</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* D/K Mono */</span>	<span class="p">{</span> <span class="n">AUD_MONO</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2603</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* D/K A2-1 */</span>	<span class="p">{</span> <span class="n">AUD_A2</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2601</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* D/K A2-2 */</span>	<span class="p">{</span> <span class="n">AUD_A2</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2601</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* D/K A2-3 */</span>	<span class="p">{</span> <span class="n">AUD_A2</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2601</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* D/K NICAM */</span>	<span class="p">{</span> <span class="n">AUD_NICAM</span><span class="p">,</span>	<span class="mh">0x1003</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x2603</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x000B</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* L/L&#39; Mono */</span>	<span class="p">{</span> <span class="n">AUD_MONO</span><span class="p">,</span>	<span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x7C03</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x2200</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
	<span class="cm">/* L/L&#39; NICAM */</span><span class="p">{</span> <span class="n">AUD_NICAM_L</span><span class="p">,</span>	<span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x7C03</span><span class="p">,</span>
					<span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x7500</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define MPX_NUM_MODES	ARRAY_SIZE(mpx_audio_modes)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpx_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wis_sony_tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>

	<span class="cm">/* reset MPX */</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">MPX_I2C_ADDR</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">audio_mode</span> <span class="o">!=</span> <span class="n">AUD_MONO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">audio_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AUD_A2</span>:
				<span class="n">source</span> <span class="o">=</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">source</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AUD_NICAM</span>:
				<span class="n">source</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AUD_NICAM_L</span>:
				<span class="n">source</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
			<span class="n">source</span> <span class="o">=</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">source</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
			<span class="n">source</span> <span class="o">=</span> <span class="mh">0x0300</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
			<span class="n">source</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">source</span> <span class="o">|=</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">source</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">source</span> <span class="o">=</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">source</span><span class="p">;</span>

	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">modus</span><span class="p">);</span>
	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">acb</span><span class="p">);</span>
	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span>
			<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">fm_prescale</span><span class="p">);</span>
	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span>
			<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">nicam_prescale</span><span class="p">);</span>
	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span>
			<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">scart_prescale</span><span class="p">);</span>
	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">system</span><span class="p">);</span>
	<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">volume</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">audio_mode</span> <span class="o">==</span> <span class="n">AUD_A2</span><span class="p">)</span>
		<span class="n">mpx_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_MONO</span> <span class="o">?</span>  <span class="mh">0x07f0</span> <span class="o">:</span> <span class="mh">0x0190</span><span class="p">);</span>

<span class="cp">#ifdef MPX_DEBUG</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;wis-sony-tuner: MPX registers: %04x %04x &quot;</span>
				<span class="s">&quot;%04x %04x %04x %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">modus</span><span class="p">,</span>
				<span class="n">source</span><span class="p">,</span>
				<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">acb</span><span class="p">,</span>
				<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">fm_prescale</span><span class="p">,</span>
				<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">nicam_prescale</span><span class="p">,</span>
				<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">scart_prescale</span><span class="p">,</span>
				<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">system</span><span class="p">,</span>
				<span class="n">mpx_audio_modes</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">].</span><span class="n">volume</span><span class="p">);</span>
		<span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="n">buf1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">buf1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">MPX_I2C_ADDR</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf1</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">MPX_I2C_ADDR</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf2</span><span class="p">;</span>
		<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;wis-sony-tuner: MPX system: %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">buf2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">buf1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="n">buf1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">buf1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;wis-sony-tuner: MPX status: %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">buf2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IF configuration values for the BTF-PG472Z:</span>
<span class="cm"> *</span>
<span class="cm"> *	B/G: 0x94 0x70 0x49</span>
<span class="cm"> *	I:   0x14 0x70 0x4a</span>
<span class="cm"> *	D/K: 0x14 0x70 0x4b</span>
<span class="cm"> *	L:   0x04 0x70 0x4b</span>
<span class="cm"> *	L&#39;:  0x44 0x70 0x53</span>
<span class="cm"> *	M:   0x50 0x30 0x4c</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wis_sony_tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_mpx_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* configure IF */</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x94</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x49</span><span class="p">;</span>
		<span class="n">default_mpx_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4a</span><span class="p">;</span>
		<span class="n">default_mpx_mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4b</span><span class="p">;</span>
		<span class="n">default_mpx_mode</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4b</span><span class="p">;</span>
		<span class="n">default_mpx_mode</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">IF_I2C_ADDR</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Select MPX mode if not forced by the user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">force_mpx_mode</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">force_mpx_mode</span> <span class="o">&lt;</span> <span class="n">MPX_NUM_MODES</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span> <span class="o">=</span> <span class="n">force_mpx_mode</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span> <span class="o">=</span> <span class="n">default_mpx_mode</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;wis-sony-tuner: setting MPX to mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span><span class="p">);</span>
	<span class="n">mpx_setup</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tuner_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wis_sony_tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="cp">#ifdef TUNER_SET_TYPE_ADDR</span>
<span class="c">	case TUNER_SET_TYPE_ADDR:</span>
<span class="c">	{</span>
<span class="c">		struct tuner_setup *tun_setup = arg;</span>
<span class="c">		int *type = &amp;tun_setup-&gt;type;</span>
<span class="cp">#else</span>
<span class="c">	case TUNER_SET_TYPE:</span>
<span class="c">	{</span>
<span class="c">		int *type = arg;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wis-sony-tuner: type already &quot;</span>
					<span class="s">&quot;set to %d, ignoring request for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">*</span><span class="n">type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PG472Z</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">force_band_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;B&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;G&#39;</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;wis-sony-tuner: forcing &quot;</span>
						<span class="s">&quot;tuner to PAL-B/G bands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">force_band</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;I&#39;</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;wis-sony-tuner: forcing &quot;</span>
						<span class="s">&quot;tuner to PAL-I band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">force_band</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;wis-sony-tuner: forcing &quot;</span>
						<span class="s">&quot;tuner to PAL-D/K bands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">force_band</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;wis-sony-tuner: forcing &quot;</span>
						<span class="s">&quot;tuner to SECAM-L band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">force_band</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">force_band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">force_band</span><span class="p">)</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">force_band</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">;</span>
			<span class="n">set_if</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PK467Z</span>:
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PB463Z</span>:
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wis-sony-tuner: tuner type %d is not &quot;</span>
					<span class="s">&quot;supported by this module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;wis-sony-tuner: type set to %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">sony_tuners</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">-</span> <span class="mi">200</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_FREQUENCY</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_FREQUENCY</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
		<span class="n">set_freq</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUMSTD</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_standard</span> <span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PG472Z</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">v4l2_video_std_construct</span><span class="p">(</span><span class="n">std</span><span class="p">,</span>
						<span class="n">V4L2_STD_PAL_BG</span><span class="p">,</span> <span class="s">&quot;PAL-B/G&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">v4l2_video_std_construct</span><span class="p">(</span><span class="n">std</span><span class="p">,</span>
						<span class="n">V4L2_STD_PAL_I</span><span class="p">,</span> <span class="s">&quot;PAL-I&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">v4l2_video_std_construct</span><span class="p">(</span><span class="n">std</span><span class="p">,</span>
						<span class="n">V4L2_STD_PAL_DK</span><span class="p">,</span> <span class="s">&quot;PAL-D/K&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">v4l2_video_std_construct</span><span class="p">(</span><span class="n">std</span><span class="p">,</span>
						<span class="n">V4L2_STD_SECAM_L</span><span class="p">,</span> <span class="s">&quot;SECAM-L&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">std</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* hack to indicate EINVAL */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PK467Z</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">std</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* hack to indicate EINVAL */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">v4l2_video_std_construct</span><span class="p">(</span><span class="n">std</span><span class="p">,</span>
					<span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">,</span> <span class="s">&quot;NTSC-J&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PB463Z</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">std</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* hack to indicate EINVAL */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">v4l2_video_std_construct</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">,</span> <span class="s">&quot;NTSC&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_STD</span>:
	<span class="p">{</span>
		<span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_STD</span>:
	<span class="p">{</span>
		<span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">v4l2_std_id</span> <span class="n">old</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PG472Z</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">force_band</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">force_band</span><span class="p">)</span> <span class="o">!=</span> <span class="o">*</span><span class="n">std</span> <span class="o">&amp;&amp;</span>
					<span class="o">*</span><span class="n">std</span> <span class="o">!=</span> <span class="n">V4L2_STD_PAL</span> <span class="o">&amp;&amp;</span>
					<span class="o">*</span><span class="n">std</span> <span class="o">!=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;wis-sony-tuner: ignoring &quot;</span>
						<span class="s">&quot;requested TV standard in &quot;</span>
						<span class="s">&quot;favor of force_band value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">force_band</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* default */</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wis-sony-tuner: TV standard &quot;</span>
						<span class="s">&quot;not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* hack to indicate EINVAL */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">)</span>
				<span class="n">set_if</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PK467Z</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wis-sony-tuner: TV standard &quot;</span>
						<span class="s">&quot;not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* hack to indicate EINVAL */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PB463Z</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;wis-sony-tuner: TV standard &quot;</span>
						<span class="s">&quot;not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* hack to indicate EINVAL */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VIDIOC_QUERYSTD</span>:
	<span class="p">{</span>
		<span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PG472Z</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">force_band</span><span class="p">)</span>
				<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">force_band</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_I</span> <span class="o">|</span>
					<span class="n">V4L2_STD_PAL_DK</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PK467Z</span>:
			<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PB463Z</span>:
			<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_TUNER</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">tun</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">tun</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tun</span><span class="p">));</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Television&quot;</span><span class="p">);</span>
		<span class="n">tun</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
		<span class="n">tun</span><span class="o">-&gt;</span><span class="n">rangelow</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span> <span class="cm">/* does anything use these? */</span>
		<span class="n">tun</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="mh">0xffffffffUL</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PG472Z</span>:
			<span class="n">tun</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_NORM</span> <span class="o">|</span>
				<span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_LANG1</span> <span class="o">|</span>
				<span class="n">V4L2_TUNER_CAP_LANG2</span><span class="p">;</span>
			<span class="n">tun</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span> <span class="o">|</span>
				<span class="n">V4L2_TUNER_SUB_STEREO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span>
				<span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PK467Z</span>:
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PB463Z</span>:
			<span class="n">tun</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_STEREO</span><span class="p">;</span>
			<span class="n">tun</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span> <span class="o">|</span>
						<span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tun</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VIDIOC_S_TUNER</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">tun</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PG472Z</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tun</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">tun</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
				<span class="n">mpx_setup</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PK467Z</span>:
		<span class="k">case</span> <span class="n">TUNER_SONY_BTF_PB463Z</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wis_sony_tuner_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wis_sony_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_I2C_BLOCK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wis_sony_tuner</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">mpxmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		<span class="s">&quot;wis-sony-tuner: initializing tuner at address %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wis_sony_tuner_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wis_sony_tuner</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">wis_sony_tuner_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;wis_sony_tuner&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">wis_sony_tuner_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">wis_sony_tuner_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;WIS Sony TV Tuner I2C driver&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">wis_sony_tuner_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">wis_sony_tuner_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">command</span>	<span class="o">=</span> <span class="n">tuner_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">wis_sony_tuner_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wis_sony_tuner_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wis_sony_tuner_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">wis_sony_tuner_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wis_sony_tuner_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">wis_sony_tuner_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">wis_sony_tuner_cleanup</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
