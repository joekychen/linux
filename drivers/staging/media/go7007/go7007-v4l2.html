<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › media › go7007 › go7007-v4l2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>go7007-v4l2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005-2006 Micronas USA Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License (Version 2) as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software Foundation,</span>
<span class="cm"> * Inc., 59 Temple Place - Suite 330, Boston MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/version.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &quot;go7007.h&quot;</span>
<span class="cp">#include &quot;go7007-priv.h&quot;</span>
<span class="cp">#include &quot;wis-i2c.h&quot;</span>

<span class="cm">/* Temporary defines until accepted in v4l-dvb */</span>
<span class="cp">#ifndef V4L2_MPEG_STREAM_TYPE_MPEG_ELEM</span>
<span class="cp">#define	V4L2_MPEG_STREAM_TYPE_MPEG_ELEM   6 </span><span class="cm">/* MPEG elementary stream */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#ifndef V4L2_MPEG_VIDEO_ENCODING_MPEG_4</span>
<span class="cp">#define	V4L2_MPEG_VIDEO_ENCODING_MPEG_4   3</span>
<span class="cp">#endif</span>

<span class="cp">#define call_all(dev, o, f, args...) \</span>
<span class="cp">	v4l2_device_call_until_err(dev, 0, o, f, ##args)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">deactivate_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUF_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
		<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_IDLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">abort_queued</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">gobuf</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deactivate_buffer</span><span class="p">(</span><span class="n">gobuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">go7007_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go7007_stream_stop</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">abort_queued</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">go7007_reset_encoder</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">go7007_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_ONLINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">gofh</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007_file</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gofh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="o">++</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">;</span>
	<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">=</span> <span class="n">go</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">gofh</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">go7007_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">go7007_streamoff</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">);</span>
		<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gofh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_frame_type_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GO7007_FORMAT_MJPEG</span>:
		<span class="k">return</span> <span class="n">V4L2_BUF_FLAG_KEYFRAME</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_FORMAT_MPEG4</span>:
		<span class="k">switch</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">frame_offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">return</span> <span class="n">V4L2_BUF_FLAG_KEYFRAME</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">return</span> <span class="n">V4L2_BUF_FLAG_PFRAME</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">return</span> <span class="n">V4L2_BUF_FLAG_BFRAME</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">GO7007_FORMAT_MPEG1</span>:
	<span class="k">case</span> <span class="n">GO7007_FORMAT_MPEG2</span>:
		<span class="k">switch</span> <span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">frame_offset</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">return</span> <span class="n">V4L2_BUF_FLAG_KEYFRAME</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">return</span> <span class="n">V4L2_BUF_FLAG_PFRAME</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">return</span> <span class="n">V4L2_BUF_FLAG_BFRAME</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_capture_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">try</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sensor_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sensor_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span> <span class="o">&amp;&amp;</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_MPEG</span> <span class="o">&amp;&amp;</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_MPEG4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">standard</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GO7007_STD_NTSC</span>:
		<span class="n">sensor_width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">sensor_height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_STD_PAL</span>:
		<span class="n">sensor_width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">sensor_height</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_STD_OTHER</span>:
		<span class="n">sensor_width</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_width</span><span class="p">;</span>
		<span class="n">sensor_height</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_height</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">sensor_width</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">sensor_height</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_flags</span> <span class="o">&amp;</span> <span class="n">GO7007_SENSOR_SCALING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">sensor_width</span><span class="p">)</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">sensor_width</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">144</span><span class="p">)</span>
			<span class="n">width</span> <span class="o">=</span> <span class="mi">144</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">sensor_height</span><span class="p">)</span>
			<span class="n">height</span> <span class="o">=</span> <span class="n">sensor_height</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">96</span><span class="p">)</span>
			<span class="n">height</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">height</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">requested_size</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">sensor_size</span> <span class="o">=</span> <span class="n">sensor_width</span> <span class="o">*</span> <span class="n">sensor_height</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">requested_size</span> <span class="o">&lt;</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">sensor_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">sensor_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">height</span> <span class="o">=</span> <span class="n">sensor_height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">requested_size</span> <span class="o">&lt;</span> <span class="mi">36</span> <span class="o">*</span> <span class="n">sensor_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">sensor_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">height</span> <span class="o">=</span> <span class="n">sensor_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">sensor_width</span><span class="p">;</span>
			<span class="n">height</span> <span class="o">=</span> <span class="n">sensor_height</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">width</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pixelformat</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">));</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">pixelformat</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">GO7007_BUF_SIZE</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span> <span class="cm">/* ?? */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">try</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">go</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">go</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_h_offset</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_h_offset</span><span class="p">;</span>
	<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_v_offset</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_v_offset</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">modet</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1624</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">modet_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_flags</span> <span class="o">&amp;</span> <span class="n">GO7007_SENSOR_SCALING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mbus_fmt</span><span class="p">;</span>

		<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_FIXED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">sensor_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_v_halve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_v_halve</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbus_fmt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">sensor_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_h_halve</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_v_halve</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_subsample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">sensor_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_h_halve</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_v_halve</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_subsample</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_h_halve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_v_halve</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">encoder_subsample</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_MPEG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">GO7007_FORMAT_MPEG1</span> <span class="o">||</span>
				<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">GO7007_FORMAT_MPEG2</span> <span class="o">||</span>
				<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">GO7007_FORMAT_MPEG4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">GO7007_FORMAT_MPEG1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">pali</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">GO7007_RATIO_1_1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_size</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">ipb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">closed_gop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">repeat_seqhead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">seq_header_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_header_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">dvd_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Backwards compatibility only! */</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_MPEG4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">GO7007_FORMAT_MPEG4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">GO7007_FORMAT_MPEG4</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">pali</span> <span class="o">=</span> <span class="mh">0xf5</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">GO7007_RATIO_1_1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_size</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">ipb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">closed_gop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">repeat_seqhead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">seq_header_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_header_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">dvd_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_MJPEG</span>:
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">GO7007_FORMAT_MJPEG</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">pali</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">GO7007_RATIO_1_1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">ipb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">closed_gop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">repeat_seqhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">seq_header_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_header_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">dvd_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int clip_to_modet_map(struct go7007 *go, int region,</span>
<span class="c">		struct v4l2_clip *clip_list)</span>
<span class="c">{</span>
<span class="c">	struct v4l2_clip clip, *clip_ptr;</span>
<span class="c">	int x, y, mbnum;</span>

<span class="c">	/* Check if coordinates are OK and if any macroblocks are already</span>
<span class="c">	 * used by other regions (besides 0) */</span>
<span class="c">	clip_ptr = clip_list;</span>
<span class="c">	while (clip_ptr) {</span>
<span class="c">		if (copy_from_user(&amp;clip, clip_ptr, sizeof(clip)))</span>
<span class="c">			return -EFAULT;</span>
<span class="c">		if (clip.c.left &lt; 0 || (clip.c.left &amp; 0xF) ||</span>
<span class="c">				clip.c.width &lt;= 0 || (clip.c.width &amp; 0xF))</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		if (clip.c.left + clip.c.width &gt; go-&gt;width)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		if (clip.c.top &lt; 0 || (clip.c.top &amp; 0xF) ||</span>
<span class="c">				clip.c.height &lt;= 0 || (clip.c.height &amp; 0xF))</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		if (clip.c.top + clip.c.height &gt; go-&gt;height)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		for (y = 0; y &lt; clip.c.height; y += 16)</span>
<span class="c">			for (x = 0; x &lt; clip.c.width; x += 16) {</span>
<span class="c">				mbnum = (go-&gt;width &gt;&gt; 4) *</span>
<span class="c">						((clip.c.top + y) &gt;&gt; 4) +</span>
<span class="c">					((clip.c.left + x) &gt;&gt; 4);</span>
<span class="c">				if (go-&gt;modet_map[mbnum] != 0 &amp;&amp;</span>
<span class="c">						go-&gt;modet_map[mbnum] != region)</span>
<span class="c">					return -EBUSY;</span>
<span class="c">			}</span>
<span class="c">		clip_ptr = clip.next;</span>
<span class="c">	}</span>

<span class="c">	/* Clear old region macroblocks */</span>
<span class="c">	for (mbnum = 0; mbnum &lt; 1624; ++mbnum)</span>
<span class="c">		if (go-&gt;modet_map[mbnum] == region)</span>
<span class="c">			go-&gt;modet_map[mbnum] = 0;</span>

<span class="c">	/* Claim macroblocks in this list */</span>
<span class="c">	clip_ptr = clip_list;</span>
<span class="c">	while (clip_ptr) {</span>
<span class="c">		if (copy_from_user(&amp;clip, clip_ptr, sizeof(clip)))</span>
<span class="c">			return -EFAULT;</span>
<span class="c">		for (y = 0; y &lt; clip.c.height; y += 16)</span>
<span class="c">			for (x = 0; x &lt; clip.c.width; x += 16) {</span>
<span class="c">				mbnum = (go-&gt;width &gt;&gt; 4) *</span>
<span class="c">						((clip.c.top + y) &gt;&gt; 4) +</span>
<span class="c">					((clip.c.left + x) &gt;&gt; 4);</span>
<span class="c">				go-&gt;modet_map[mbnum] = region;</span>
<span class="c">			}</span>
<span class="c">		clip_ptr = clip.next;</span>
<span class="c">	}</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpeg_query_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">mpeg_ctrls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">V4L2_CID_MPEG_CLASS</span><span class="p">,</span>
		<span class="n">V4L2_CID_MPEG_STREAM_TYPE</span><span class="p">,</span>
		<span class="n">V4L2_CID_MPEG_VIDEO_ENCODING</span><span class="p">,</span>
		<span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span><span class="p">,</span>
		<span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span><span class="p">,</span>
		<span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span><span class="p">,</span>
		<span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ctrl_classes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">mpeg_ctrls</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">v4l2_ctrl_next</span><span class="p">(</span><span class="n">ctrl_classes</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_CLASS</span>:
		<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span>:
		<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_STREAM_TYPE_MPEG2_DVD</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_STREAM_TYPE_MPEG_ELEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_STREAM_TYPE_MPEG_ELEM</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ENCODING</span>:
		<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_1</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_2</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span>:
		<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_VIDEO_ASPECT_1x1</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_VIDEO_ASPECT_16x9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">V4L2_MPEG_VIDEO_ASPECT_1x1</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span>:
		<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span>:
		<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span>:
		<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span>
				<span class="mi">64000</span><span class="p">,</span>
				<span class="mi">10000000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="mi">1500000</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpeg_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pretty sure we can&#39;t change any of these while streaming */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_STREAM_TYPE_MPEG2_DVD</span>:
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">GO7007_FORMAT_MPEG2</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">9800000</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_size</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">pali</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">closed_gop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">repeat_seqhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">seq_header_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_header_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">dvd_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_STREAM_TYPE_MPEG_ELEM</span>:
			<span class="cm">/* todo: */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ENCODING</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_1</span>:
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">GO7007_FORMAT_MPEG1</span><span class="p">;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">pali</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_2</span>:
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">GO7007_FORMAT_MPEG2</span><span class="p">;</span>
			<span class="cm">/*if (mpeg-&gt;pali &gt;&gt; 24 == 2)</span>
<span class="cm">				go-&gt;pali = mpeg-&gt;pali &amp; 0xff;</span>
<span class="cm">			else*/</span>
				<span class="n">go</span><span class="o">-&gt;</span><span class="n">pali</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_4</span>:
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">GO7007_FORMAT_MPEG4</span><span class="p">;</span>
			<span class="cm">/*if (mpeg-&gt;pali &gt;&gt; 24 == 4)</span>
<span class="cm">				go-&gt;pali = mpeg-&gt;pali &amp; 0xff;</span>
<span class="cm">			else*/</span>
				<span class="n">go</span><span class="o">-&gt;</span><span class="n">pali</span> <span class="o">=</span> <span class="mh">0xf5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_header_enable</span> <span class="o">=</span>
			<span class="cm">/*mpeg-&gt;flags &amp; GO7007_MPEG_OMIT_GOP_HEADER</span>
<span class="cm">			? 0 :*/</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*if (mpeg-&gt;flags &amp; GO7007_MPEG_REPEAT_SEQHEADER)</span>
<span class="cm">			go-&gt;repeat_seqhead = 1;</span>
<span class="cm">		else*/</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">repeat_seqhead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">dvd_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">GO7007_FORMAT_MJPEG</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_1x1</span>:
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">GO7007_RATIO_1_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_4x3</span>:
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">GO7007_RATIO_4_3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_16x9</span>:
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">GO7007_RATIO_16_9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_221x100</span>:
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">34</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">closed_gop</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span>:
		<span class="cm">/* Upper bound is kind of arbitrary here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">64000</span> <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpeg_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">dvd_mode</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_STREAM_TYPE_MPEG2_DVD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_STREAM_TYPE_MPEG_ELEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ENCODING</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GO7007_FORMAT_MPEG1</span>:
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GO7007_FORMAT_MPEG2</span>:
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GO7007_FORMAT_MPEG4</span>:
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GO7007_RATIO_1_1</span>:
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_1x1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GO7007_RATIO_4_3</span>:
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_4x3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GO7007_RATIO_16_9</span>:
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_16x9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">gop_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">closed_gop</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;go7007&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	strlcpy(cap-&gt;bus_info, dev_name(&amp;dev-&gt;udev-&gt;dev), sizeof(cap-&gt;bus_info));</span>
<span class="cp">#endif</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">KERNEL_VERSION</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span>
			    <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span> <span class="cm">/* | V4L2_CAP_AUDIO; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">)</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">V4L2_CAP_TUNER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Motion-JPEG&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MPEG</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;MPEG1/MPEG2/MPEG4&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_FMT_FLAG_COMPRESSED</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">GO7007_FORMAT_MJPEG</span><span class="p">)</span> <span class="o">?</span>
				   <span class="n">V4L2_PIX_FMT_MJPEG</span> <span class="o">:</span> <span class="n">V4L2_PIX_FMT_MPEG</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">GO7007_BUF_SIZE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_capture_size</span><span class="p">(</span><span class="n">go</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_capture_size</span><span class="p">(</span><span class="n">go</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">||</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007_buffer</span><span class="p">),</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">go</span> <span class="o">=</span> <span class="n">go</span><span class="p">;</span>
			<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_IDLE</span><span class="p">;</span>
			<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">go</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BUF_STATE_QUEUED</span>:
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUF_STATE_DONE</span>:
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">mapped</span><span class="p">)</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="n">GO7007_BUF_SIZE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">GO7007_BUF_SIZE</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">||</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="n">gobuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUF_STATE_IDLE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="cm">/* offset will be 0 until we really support USERPTR streaming */</span>
	<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">user_addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">frame_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">modet_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">GO7007_BUF_PAGES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">GO7007_BUF_PAGES</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span>
			<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">user_addr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">,</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ret</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_QUEUED</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frame_type_flag</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
	<span class="n">gobuf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">go7007_buffer</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUF_STATE_DONE</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">frame_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
					<span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUF_STATE_DONE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">frame_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BUF_STATE_DONE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">deactivate_buffer</span><span class="p">(</span><span class="n">gobuf</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">frame_type_flag</span> <span class="o">=</span> <span class="n">get_frame_type_flag</span><span class="p">(</span><span class="n">gobuf</span><span class="p">,</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
	<span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BUF_STATE_IDLE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span> <span class="o">|</span> <span class="n">frame_type_flag</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">GO7007_BUF_SIZE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">GO7007_BUF_SIZE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">modet_active</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">next_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">active_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">go7007_start_encoder</span><span class="p">(</span><span class="n">go</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">go7007_streamoff</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">query</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">query</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">queryctrl</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">query</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mpeg_query_ctrl</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mpeg_g_ctrl</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">go</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mpeg_s_ctrl</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">go</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_fract</span> <span class="n">timeperframe</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="mi">1001</span> <span class="o">*</span>  <span class="n">go</span><span class="o">-&gt;</span><span class="n">fps_scale</span><span class="p">,</span>
		<span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">V4L2_CAP_TIMEPERFRAME</span><span class="p">;</span>
	<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span> <span class="o">=</span> <span class="n">timeperframe</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capturemode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span> <span class="o">*</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="mi">1001</span> <span class="o">*</span> <span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">)</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">fps_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">fps_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VIDIOC_ENUMSTD on go7007 were used for enumerating the supported fps and</span>
<span class="cm">   its resolution, when the device is not connected to TV.</span>
<span class="cm">   This is were an API abuse, probably used by the lack of specific IOCTL&#39;s to</span>
<span class="cm">   enumerate it, by the time the driver was written.</span>

<span class="cm">   However, since kernel 2.6.19, two new ioctls (VIDIOC_ENUM_FRAMEINTERVALS</span>
<span class="cm">   and VIDIOC_ENUM_FRAMESIZES) were added for this purpose.</span>

<span class="cm">   The two functions below implement the newer ioctls</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_framesizes</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_frmsizeenum</span> <span class="o">*</span><span class="n">fsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="cm">/* Return -EINVAL, if it is a TV board */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_flags</span> <span class="o">&amp;</span> <span class="n">GO7007_SENSOR_TV</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMSIZE_TYPE_DISCRETE</span><span class="p">;</span>
	<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_width</span><span class="p">;</span>
	<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_frameintervals</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_frmivalenum</span> <span class="o">*</span><span class="n">fival</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="cm">/* Return -EINVAL, if it is a TV board */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_flags</span> <span class="o">&amp;</span> <span class="n">GO7007_SENSOR_TV</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fival</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMIVAL_TYPE_DISCRETE</span><span class="p">;</span>
	<span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="mi">1001</span><span class="p">;</span>
	<span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">standard</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GO7007_STD_NTSC</span>:
		<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_STD_PAL</span>:
		<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_flags</span> <span class="o">&amp;</span> <span class="n">GO7007_SENSOR_TV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">std</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">i2c_adapter_online</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">standard</span> <span class="o">=</span> <span class="n">GO7007_STD_NTSC</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">standard</span> <span class="o">=</span> <span class="n">GO7007_STD_PAL</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span> <span class="o">=</span> <span class="mi">25025</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">standard</span> <span class="o">=</span> <span class="n">GO7007_STD_PAL</span><span class="p">;</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">sensor_framerate</span> <span class="o">=</span> <span class="mi">25025</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="o">*</span><span class="n">std</span><span class="p">);</span>
	<span class="n">set_capture_size</span><span class="p">(</span><span class="n">go</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querystd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">go</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">i2c_adapter_online</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_flags</span> <span class="o">&amp;</span> <span class="n">GO7007_SENSOR_TV</span><span class="p">)</span>
		<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">[</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* If this board has a tuner, it will be the last input */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">num_inputs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">inp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_TUNER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>

	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">audioset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_flags</span> <span class="o">&amp;</span> <span class="n">GO7007_SENSOR_TV</span><span class="p">)</span>
		<span class="n">inp</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL</span> <span class="o">|</span>
						<span class="n">V4L2_STD_SECAM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">inp</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">num_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">go</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">i2c_adapter_online</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">i2c_adapter_online</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GO7007_BOARDID_PX_TV402U_NA</span>:
	<span class="k">case</span> <span class="n">GO7007_BOARDID_PX_TV402U_JP</span>:
		<span class="cm">/* No selectable options currently */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">i2c_adapter_online</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_frequency</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GO7007_BOARD_HAS_TUNER</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">i2c_adapter_online</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_frequency</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cropcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* These specify the raw input of the sensor */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">standard</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GO7007_STD_NTSC</span>:
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_STD_PAL</span>:
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_STD_OTHER</span>:
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_width</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_height</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_width</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_height</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="cm">/* These specify the raw input of the sensor */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">standard</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GO7007_STD_NTSC</span>:
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_STD_PAL</span>:
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GO7007_STD_OTHER</span>:
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_width</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">sensor_height</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: vidioc_s_crop is not really implemented!!!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">));</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ?? */</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">jpeg_markers</span> <span class="o">=</span> <span class="n">V4L2_JPEG_MARKER_DHT</span> <span class="o">|</span>
				<span class="n">V4L2_JPEG_MARKER_DQT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_jpegcomp</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_jpegcompression</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">!=</span> <span class="mi">50</span> <span class="o">||</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">jpeg_markers</span> <span class="o">!=</span> <span class="p">(</span><span class="n">V4L2_JPEG_MARKER_DHT</span> <span class="o">|</span>
						<span class="n">V4L2_JPEG_MARKER_DQT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME:</span>
<span class="cm">	Those ioctls are private, and not needed, since several standard</span>
<span class="cm">	extended controls already provide streaming control.</span>
<span class="cm">	So, those ioctls should be converted into vidioc_g_ext_ctrls()</span>
<span class="cm">	and vidioc_s_ext_ctrls()</span>
<span class="cm"> */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Temporary ioctls for controlling compression characteristics */</span>
<span class="c">	case GO7007IOC_S_BITRATE:</span>
<span class="c">	{</span>
<span class="c">		int *bitrate = arg;</span>

<span class="c">		if (go-&gt;streaming)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		/* Upper bound is kind of arbitrary here */</span>
<span class="c">		if (*bitrate &lt; 64000 || *bitrate &gt; 10000000)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		go-&gt;bitrate = *bitrate;</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_G_BITRATE:</span>
<span class="c">	{</span>
<span class="c">		int *bitrate = arg;</span>

<span class="c">		*bitrate = go-&gt;bitrate;</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_S_COMP_PARAMS:</span>
<span class="c">	{</span>
<span class="c">		struct go7007_comp_params *comp = arg;</span>

<span class="c">		if (go-&gt;format == GO7007_FORMAT_MJPEG)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		if (comp-&gt;gop_size &gt; 0)</span>
<span class="c">			go-&gt;gop_size = comp-&gt;gop_size;</span>
<span class="c">		else</span>
<span class="c">			go-&gt;gop_size = go-&gt;sensor_framerate / 1000;</span>
<span class="c">		if (go-&gt;gop_size != 15)</span>
<span class="c">			go-&gt;dvd_mode = 0;</span>
<span class="c">		/*go-&gt;ipb = comp-&gt;max_b_frames &gt; 0;*/ /* completely untested */</span>
<span class="c">		if (go-&gt;board_info-&gt;sensor_flags &amp; GO7007_SENSOR_TV) {</span>
<span class="c">			switch (comp-&gt;aspect_ratio) {</span>
<span class="c">			case GO7007_ASPECT_RATIO_4_3_NTSC:</span>
<span class="c">			case GO7007_ASPECT_RATIO_4_3_PAL:</span>
<span class="c">				go-&gt;aspect_ratio = GO7007_RATIO_4_3;</span>
<span class="c">				break;</span>
<span class="c">			case GO7007_ASPECT_RATIO_16_9_NTSC:</span>
<span class="c">			case GO7007_ASPECT_RATIO_16_9_PAL:</span>
<span class="c">				go-&gt;aspect_ratio = GO7007_RATIO_16_9;</span>
<span class="c">				break;</span>
<span class="c">			default:</span>
<span class="c">				go-&gt;aspect_ratio = GO7007_RATIO_1_1;</span>
<span class="c">				break;</span>
<span class="c">			}</span>
<span class="c">		}</span>
<span class="c">		if (comp-&gt;flags &amp; GO7007_COMP_OMIT_SEQ_HEADER) {</span>
<span class="c">			go-&gt;dvd_mode = 0;</span>
<span class="c">			go-&gt;seq_header_enable = 0;</span>
<span class="c">		} else {</span>
<span class="c">			go-&gt;seq_header_enable = 1;</span>
<span class="c">		}</span>
<span class="c">		/* fall-through */</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_G_COMP_PARAMS:</span>
<span class="c">	{</span>
<span class="c">		struct go7007_comp_params *comp = arg;</span>

<span class="c">		if (go-&gt;format == GO7007_FORMAT_MJPEG)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		memset(comp, 0, sizeof(*comp));</span>
<span class="c">		comp-&gt;gop_size = go-&gt;gop_size;</span>
<span class="c">		comp-&gt;max_b_frames = go-&gt;ipb ? 2 : 0;</span>
<span class="c">		switch (go-&gt;aspect_ratio) {</span>
<span class="c">		case GO7007_RATIO_4_3:</span>
<span class="c">			if (go-&gt;standard == GO7007_STD_NTSC)</span>
<span class="c">				comp-&gt;aspect_ratio =</span>
<span class="c">					GO7007_ASPECT_RATIO_4_3_NTSC;</span>
<span class="c">			else</span>
<span class="c">				comp-&gt;aspect_ratio =</span>
<span class="c">					GO7007_ASPECT_RATIO_4_3_PAL;</span>
<span class="c">			break;</span>
<span class="c">		case GO7007_RATIO_16_9:</span>
<span class="c">			if (go-&gt;standard == GO7007_STD_NTSC)</span>
<span class="c">				comp-&gt;aspect_ratio =</span>
<span class="c">					GO7007_ASPECT_RATIO_16_9_NTSC;</span>
<span class="c">			else</span>
<span class="c">				comp-&gt;aspect_ratio =</span>
<span class="c">					GO7007_ASPECT_RATIO_16_9_PAL;</span>
<span class="c">			break;</span>
<span class="c">		default:</span>
<span class="c">			comp-&gt;aspect_ratio = GO7007_ASPECT_RATIO_1_1;</span>
<span class="c">			break;</span>
<span class="c">		}</span>
<span class="c">		if (go-&gt;closed_gop)</span>
<span class="c">			comp-&gt;flags |= GO7007_COMP_CLOSED_GOP;</span>
<span class="c">		if (!go-&gt;seq_header_enable)</span>
<span class="c">			comp-&gt;flags |= GO7007_COMP_OMIT_SEQ_HEADER;</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_S_MPEG_PARAMS:</span>
<span class="c">	{</span>
<span class="c">		struct go7007_mpeg_params *mpeg = arg;</span>

<span class="c">		if (go-&gt;format != GO7007_FORMAT_MPEG1 &amp;&amp;</span>
<span class="c">				go-&gt;format != GO7007_FORMAT_MPEG2 &amp;&amp;</span>
<span class="c">				go-&gt;format != GO7007_FORMAT_MPEG4)</span>
<span class="c">			return -EINVAL;</span>

<span class="c">		if (mpeg-&gt;flags &amp; GO7007_MPEG_FORCE_DVD_MODE) {</span>
<span class="c">			go-&gt;format = GO7007_FORMAT_MPEG2;</span>
<span class="c">			go-&gt;bitrate = 9800000;</span>
<span class="c">			go-&gt;gop_size = 15;</span>
<span class="c">			go-&gt;pali = 0x48;</span>
<span class="c">			go-&gt;closed_gop = 1;</span>
<span class="c">			go-&gt;repeat_seqhead = 0;</span>
<span class="c">			go-&gt;seq_header_enable = 1;</span>
<span class="c">			go-&gt;gop_header_enable = 1;</span>
<span class="c">			go-&gt;dvd_mode = 1;</span>
<span class="c">		} else {</span>
<span class="c">			switch (mpeg-&gt;mpeg_video_standard) {</span>
<span class="c">			case GO7007_MPEG_VIDEO_MPEG1:</span>
<span class="c">				go-&gt;format = GO7007_FORMAT_MPEG1;</span>
<span class="c">				go-&gt;pali = 0;</span>
<span class="c">				break;</span>
<span class="c">			case GO7007_MPEG_VIDEO_MPEG2:</span>
<span class="c">				go-&gt;format = GO7007_FORMAT_MPEG2;</span>
<span class="c">				if (mpeg-&gt;pali &gt;&gt; 24 == 2)</span>
<span class="c">					go-&gt;pali = mpeg-&gt;pali &amp; 0xff;</span>
<span class="c">				else</span>
<span class="c">					go-&gt;pali = 0x48;</span>
<span class="c">				break;</span>
<span class="c">			case GO7007_MPEG_VIDEO_MPEG4:</span>
<span class="c">				go-&gt;format = GO7007_FORMAT_MPEG4;</span>
<span class="c">				if (mpeg-&gt;pali &gt;&gt; 24 == 4)</span>
<span class="c">					go-&gt;pali = mpeg-&gt;pali &amp; 0xff;</span>
<span class="c">				else</span>
<span class="c">					go-&gt;pali = 0xf5;</span>
<span class="c">				break;</span>
<span class="c">			default:</span>
<span class="c">				return -EINVAL;</span>
<span class="c">			}</span>
<span class="c">			go-&gt;gop_header_enable =</span>
<span class="c">				mpeg-&gt;flags &amp; GO7007_MPEG_OMIT_GOP_HEADER</span>
<span class="c">				? 0 : 1;</span>
<span class="c">			if (mpeg-&gt;flags &amp; GO7007_MPEG_REPEAT_SEQHEADER)</span>
<span class="c">				go-&gt;repeat_seqhead = 1;</span>
<span class="c">			else</span>
<span class="c">				go-&gt;repeat_seqhead = 0;</span>
<span class="c">			go-&gt;dvd_mode = 0;</span>
<span class="c">		}</span>
<span class="c">		/* fall-through */</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_G_MPEG_PARAMS:</span>
<span class="c">	{</span>
<span class="c">		struct go7007_mpeg_params *mpeg = arg;</span>

<span class="c">		memset(mpeg, 0, sizeof(*mpeg));</span>
<span class="c">		switch (go-&gt;format) {</span>
<span class="c">		case GO7007_FORMAT_MPEG1:</span>
<span class="c">			mpeg-&gt;mpeg_video_standard = GO7007_MPEG_VIDEO_MPEG1;</span>
<span class="c">			mpeg-&gt;pali = 0;</span>
<span class="c">			break;</span>
<span class="c">		case GO7007_FORMAT_MPEG2:</span>
<span class="c">			mpeg-&gt;mpeg_video_standard = GO7007_MPEG_VIDEO_MPEG2;</span>
<span class="c">			mpeg-&gt;pali = GO7007_MPEG_PROFILE(2, go-&gt;pali);</span>
<span class="c">			break;</span>
<span class="c">		case GO7007_FORMAT_MPEG4:</span>
<span class="c">			mpeg-&gt;mpeg_video_standard = GO7007_MPEG_VIDEO_MPEG4;</span>
<span class="c">			mpeg-&gt;pali = GO7007_MPEG_PROFILE(4, go-&gt;pali);</span>
<span class="c">			break;</span>
<span class="c">		default:</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		}</span>
<span class="c">		if (!go-&gt;gop_header_enable)</span>
<span class="c">			mpeg-&gt;flags |= GO7007_MPEG_OMIT_GOP_HEADER;</span>
<span class="c">		if (go-&gt;repeat_seqhead)</span>
<span class="c">			mpeg-&gt;flags |= GO7007_MPEG_REPEAT_SEQHEADER;</span>
<span class="c">		if (go-&gt;dvd_mode)</span>
<span class="c">			mpeg-&gt;flags |= GO7007_MPEG_FORCE_DVD_MODE;</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_S_MD_PARAMS:</span>
<span class="c">	{</span>
<span class="c">		struct go7007_md_params *mdp = arg;</span>

<span class="c">		if (mdp-&gt;region &gt; 3)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		if (mdp-&gt;trigger &gt; 0) {</span>
<span class="c">			go-&gt;modet[mdp-&gt;region].pixel_threshold =</span>
<span class="c">					mdp-&gt;pixel_threshold &gt;&gt; 1;</span>
<span class="c">			go-&gt;modet[mdp-&gt;region].motion_threshold =</span>
<span class="c">					mdp-&gt;motion_threshold &gt;&gt; 1;</span>
<span class="c">			go-&gt;modet[mdp-&gt;region].mb_threshold =</span>
<span class="c">					mdp-&gt;trigger &gt;&gt; 1;</span>
<span class="c">			go-&gt;modet[mdp-&gt;region].enable = 1;</span>
<span class="c">		} else</span>
<span class="c">			go-&gt;modet[mdp-&gt;region].enable = 0;</span>
<span class="c">		/* fall-through */</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_G_MD_PARAMS:</span>
<span class="c">	{</span>
<span class="c">		struct go7007_md_params *mdp = arg;</span>
<span class="c">		int region = mdp-&gt;region;</span>

<span class="c">		if (mdp-&gt;region &gt; 3)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		memset(mdp, 0, sizeof(struct go7007_md_params));</span>
<span class="c">		mdp-&gt;region = region;</span>
<span class="c">		if (!go-&gt;modet[region].enable)</span>
<span class="c">			return 0;</span>
<span class="c">		mdp-&gt;pixel_threshold =</span>
<span class="c">			(go-&gt;modet[region].pixel_threshold &lt;&lt; 1) + 1;</span>
<span class="c">		mdp-&gt;motion_threshold =</span>
<span class="c">			(go-&gt;modet[region].motion_threshold &lt;&lt; 1) + 1;</span>
<span class="c">		mdp-&gt;trigger =</span>
<span class="c">			(go-&gt;modet[region].mb_threshold &lt;&lt; 1) + 1;</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="c">	case GO7007IOC_S_MD_REGION:</span>
<span class="c">	{</span>
<span class="c">		struct go7007_md_region *region = arg;</span>

<span class="c">		if (region-&gt;region &lt; 1 || region-&gt;region &gt; 3)</span>
<span class="c">			return -EINVAL;</span>
<span class="c">		return clip_to_modet_map(go, region-&gt;region, region-&gt;clips);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">go7007_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">go7007_vm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="o">++</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">go7007_vm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">deactivate_buffer</span><span class="p">(</span><span class="n">gobuf</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Copied from videobuf-dma-sg.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">go7007_vm_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_fault</span> <span class="o">*</span><span class="n">vmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_USER</span> <span class="o">|</span> <span class="n">__GFP_DMA32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VM_FAULT_OOM</span><span class="p">;</span>
	<span class="n">clear_user_highpage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vmf</span><span class="o">-&gt;</span><span class="n">virtual_address</span><span class="p">);</span>
	<span class="n">vmf</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">go7007_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>	<span class="o">=</span> <span class="n">go7007_vm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>	<span class="o">=</span> <span class="n">go7007_vm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fault</span>	<span class="o">=</span> <span class="n">go7007_vm_fault</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">go7007_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_ONLINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_SHARED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* only support VM_SHARED mapping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">!=</span> <span class="n">GO7007_BUF_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* must map exactly one full buffer */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">/</span> <span class="n">GO7007_BUF_PAGES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">gofh</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* trying to map beyond requested buffers */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">GO7007_BUF_PAGES</span> <span class="o">!=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* offset is not aligned on buffer boundary */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">mapped</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">user_addr</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">go7007_vm_ops</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_DONTEXPAND</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VM_IO</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">bufs</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">go7007_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007_file</span> <span class="o">*</span><span class="n">gofh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">go7007_buffer</span> <span class="o">*</span><span class="n">gobuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">POLLERR</span><span class="p">;</span>
	<span class="n">gobuf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">go7007_buffer</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gofh</span><span class="o">-&gt;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">frame_waitq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gobuf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BUF_STATE_DONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">go7007_vfl_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>

	<span class="n">video_device_release</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">go7007_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">go7007_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">go7007_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">go7007_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">go7007_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">go7007_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">video_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>          <span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span>  <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span>     <span class="o">=</span> <span class="n">vidioc_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>   <span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>     <span class="o">=</span> <span class="n">vidioc_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>           <span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>          <span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>              <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>             <span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span>             <span class="o">=</span> <span class="n">vidioc_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>             <span class="o">=</span> <span class="n">vidioc_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querystd</span>          <span class="o">=</span> <span class="n">vidioc_querystd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>        <span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>           <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>           <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>         <span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>            <span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>            <span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>          <span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>         <span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>           <span class="o">=</span> <span class="n">vidioc_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>           <span class="o">=</span> <span class="n">vidioc_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>       <span class="o">=</span> <span class="n">vidioc_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>       <span class="o">=</span> <span class="n">vidioc_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_parm</span>            <span class="o">=</span> <span class="n">vidioc_g_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_parm</span>            <span class="o">=</span> <span class="n">vidioc_s_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_framesizes</span>   <span class="o">=</span> <span class="n">vidioc_enum_framesizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_frameintervals</span> <span class="o">=</span> <span class="n">vidioc_enum_frameintervals</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>           <span class="o">=</span> <span class="n">vidioc_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>            <span class="o">=</span> <span class="n">vidioc_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>            <span class="o">=</span> <span class="n">vidioc_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_jpegcomp</span>        <span class="o">=</span> <span class="n">vidioc_g_jpegcomp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_jpegcomp</span>        <span class="o">=</span> <span class="n">vidioc_s_jpegcomp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">go7007_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;go7007&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">go7007_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">go7007_vfl_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">video_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span>	<span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">current_norm</span>	<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">go7007_v4l2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="o">*</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="n">go7007_template</span><span class="p">;</span>
	<span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">go</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">go</span><span class="p">);</span>
	<span class="o">++</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: registered device %s [v4l2]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">go7007_v4l2_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">go7007</span> <span class="o">*</span><span class="n">go</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">go</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">go7007_stream_stop</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">abort_queued</span><span class="p">(</span><span class="n">go</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">)</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">go</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
