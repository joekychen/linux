<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › media › easycap › easycap_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>easycap_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm">*                                                                             *</span>
<span class="cm">*  easycap_main.c                                                             *</span>
<span class="cm">*                                                                             *</span>
<span class="cm">*  Video driver for EasyCAP USB2.0 Video Capture Device DC60                  *</span>
<span class="cm">*                                                                             *</span>
<span class="cm">*                                                                             *</span>
<span class="cm">******************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2010 R.M. Thomas &lt;rmthomas@sciolus.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  The software is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this software; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm">*/</span>
<span class="cm">/*****************************************************************************/</span>

<span class="cp">#include &quot;easycap.h&quot;</span>
<span class="cp">#include &lt;linux/usb/audio.h&gt;</span>


<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;R.M. Thomas &lt;rmthomas@sciolus.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">EASYCAP_DRIVER_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">EASYCAP_DRIVER_VERSION</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_EASYCAP_DEBUG</span>
<span class="kt">int</span> <span class="n">easycap_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">easycap_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level: 0(default),1,2,...,9&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_EASYCAP_DEBUG */</span><span class="cp"></span>

<span class="n">bool</span> <span class="n">easycap_readback</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">readback</span><span class="p">,</span> <span class="n">easycap_readback</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">readback</span><span class="p">,</span> <span class="s">&quot;read back written registers: (default false)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">easycap_bars</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">easycap_bars</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span>
	<span class="s">&quot;Testcard bars on input signal failure: 0=&gt;no, 1=&gt;yes(default)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">easycap_gain</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="n">easycap_gain</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="s">&quot;Audio gain: 0,...,16(default),...31&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">easycap_ntsc</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">ntsc</span><span class="p">,</span> <span class="n">easycap_ntsc</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ntsc</span><span class="p">,</span> <span class="s">&quot;NTSC default encoding (default PAL)&quot;</span><span class="p">);</span>



<span class="k">struct</span> <span class="n">easycap_dongle</span> <span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">DONGLE_MANY</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex_dongle</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">easycap_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">field2frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">redaub</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">pad</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">much</span><span class="p">,</span> <span class="kt">int</span> <span class="n">more</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">margin</span><span class="p">,</span> <span class="n">bool</span> <span class="n">isuy</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">strerror</span><span class="p">(</span><span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ERRNOSTR(_e) case _e: return # _e</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="s">&quot;OK&quot;</span><span class="p">;</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENXIO</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EFBIG</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EPIPE</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EMSGSIZE</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EINPROGRESS</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENOSR</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EOVERFLOW</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EPROTO</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EILSEQ</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EOPNOTSUPP</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EPFNOSUPPORT</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EAFNOSUPPORT</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EADDRINUSE</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EADDRNOTAVAIL</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENOBUFS</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EISCONN</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENOTCONN</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ENOENT</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ECONNRESET</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ETIME</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">ECOMM</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EREMOTEIO</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EXDEV</span><span class="p">);</span>
	<span class="n">ERRNOSTR</span><span class="p">(</span><span class="n">EPERM</span><span class="p">);</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#undef ERRNOSTR</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  THIS ROUTINE DOES NOT DETECT DUPLICATE OCCURRENCES OF POINTER peasycap</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="kt">int</span> <span class="nf">easycap_isdongle</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">DONGLE_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">peasycap</span> <span class="o">==</span> <span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">isdongle</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">k</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">easycap_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">pvideo_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;==========OPEN=========</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pvideo_device</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvideo_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: pvideo_device is NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="p">)</span><span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">pvideo_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;pusb_device is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;peasycap-&gt;pusb_device=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">);</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">peasycap</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">easycap_wakeup_device</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: wakeup_device() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span> <span class="o">==</span> <span class="n">rc</span><span class="p">)</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: wakeup_device() returned -ENODEV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: wakeup_device() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;wakeup_device() OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">reset</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: reset() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  RESET THE HARDWARE TO ITS REFERENCE STATE.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS ROUTINE MAY BE CALLED REPEATEDLY IF easycap_complete() DETECTS</span>
<span class="cm"> *  A BAD VIDEO FRAME SIZE.</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap_standard</span> <span class="k">const</span> <span class="o">*</span><span class="n">peasycap_standard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fmtidx</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ntsc</span><span class="p">,</span> <span class="n">other</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">input</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  IF THE SAA7113H HAS ALREADY ACQUIRED SYNC, USE ITS HARDWARE-DETECTED</span>
<span class="cm"> *  FIELD FREQUENCY TO DISTINGUISH NTSC FROM PAL.  THIS IS ESSENTIAL FOR</span>
<span class="cm"> *  gstreamer AND OTHER USERSPACE PROGRAMS WHICH MAY NOT ATTEMPT TO INITIATE</span>
<span class="cm"> *  A SWITCH BETWEEN PAL AND NTSC.</span>
<span class="cm"> *</span>
<span class="cm"> *  FUNCTION ready_saa() MAY REQUIRE A SUBSTANTIAL FRACTION OF A SECOND TO</span>
<span class="cm"> *  COMPLETE, SO SHOULD NOT BE INVOKED WITHOUT GOOD REASON.</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">other</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;peasycap-&gt;ntsc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ntsc</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">ready_saa</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;not ready to capture after %i ms ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PATIENCE</span><span class="p">);</span>
		<span class="n">ntsc</span> <span class="o">=</span> <span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ntsc</span><span class="p">;</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;... trying  %s ..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntsc</span> <span class="o">?</span> <span class="s">&quot;NTSC&quot;</span> <span class="o">:</span> <span class="s">&quot;PAL&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_stk</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">ntsc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: setup_stk() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_saa</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">ntsc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: setup_saa() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="n">ready_saa</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;not ready to capture after %i ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PATIENCE</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;... saa register 0x1F has 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">read_saa</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">));</span>
			<span class="n">ntsc</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ntsc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;... success at second try:  %i=rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
			<span class="n">ntsc</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rate</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span> <span class="p">;</span>
			<span class="n">other</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;... success at first try:  %i=rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="n">ntsc</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rate</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ntsc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ntsc</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_stk</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">ntsc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: setup_stk() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_saa</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">ntsc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: setup_saa() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">merit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">merit</span><span class="p">));</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * RESTORE INPUT AND FORCE REFRESH OF STANDARD, FORMAT, ETC.</span>
<span class="cm"> *</span>
<span class="cm"> * WHILE THIS PROCEDURE IS IN PROGRESS, SOME IOCTL COMMANDS WILL RETURN -EBUSY.</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8192</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">standard_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8192</span><span class="p">;</span>
	<span class="n">fmtidx</span> <span class="o">=</span> <span class="n">ntsc</span> <span class="o">?</span> <span class="n">NTSC_M</span> <span class="o">:</span> <span class="n">PAL_BGHIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peasycap_standard</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">easycap_standard</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">!=</span> <span class="n">peasycap_standard</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmtidx</span> <span class="o">==</span> <span class="n">peasycap_standard</span><span class="o">-&gt;</span><span class="n">v4l2_standard</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">standard_offset</span> <span class="o">=</span>
					<span class="n">peasycap_standard</span> <span class="o">-</span> <span class="n">easycap_standard</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">peasycap_standard</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">==</span> <span class="n">peasycap_standard</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: standard not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;inputset[%i].standard_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">standard_offset</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">format_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8192</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8192</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8192</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8192</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">hue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8192</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">easycap_newinput</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: newinput(.,%i) rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;restored input, standard and format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;true=peasycap-&gt;ntsc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ntsc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  %i=peasycap-&gt;input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">standard_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  %i=peasycap-&gt;standard_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">standard_offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">format_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  %i=peasycap-&gt;format_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">format_offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  %i=peasycap-&gt;brightness</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  %i=peasycap-&gt;contrast</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  %i=peasycap-&gt;saturation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  %i=peasycap-&gt;hue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  IF THE REQUESTED INPUT IS THE SAME AS THE EXISTING INPUT, DO NOTHING.</span>
<span class="cm"> *  OTHERWISE:</span>
<span class="cm"> *      KILL URBS, CLEAR FIELD AND FRAME BUFFERS AND RESET THEIR</span>
<span class="cm"> *           _read AND _fill POINTERS.</span>
<span class="cm"> *      SELECT THE NEW INPUT.</span>
<span class="cm"> *      ADJUST THE STANDARD, FORMAT, BRIGHTNESS, CONTRAST, SATURATION AND HUE</span>
<span class="cm"> *          ON THE BASIS OF INFORMATION IN STRUCTURE easycap.inputset[input].</span>
<span class="cm"> *      RESUBMIT THE URBS IF STREAMING WAS ALREADY IN PROGRESS.</span>
<span class="cm"> *</span>
<span class="cm"> *  NOTE:</span>
<span class="cm"> *      THIS ROUTINE MAY BE CALLED FREQUENTLY BY ZONEMINDER VIA IOCTL,</span>
<span class="cm"> *      SO IT SHOULD WRITE ONLY SPARINGLY TO THE LOGFILE.</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="kt">int</span> <span class="nf">easycap_newinput</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mood</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inputnow</span><span class="p">,</span> <span class="n">video_idlenow</span><span class="p">,</span> <span class="n">audio_idlenow</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">resubmit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=input sought</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">input</span> <span class="o">&amp;&amp;</span> <span class="n">INPUT_MANY</span> <span class="o">&lt;=</span> <span class="n">input</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">inputnow</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">inputnow</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  IF STREAMING IS IN PROGRESS THE URBS ARE KILLED AT THIS</span>
<span class="cm"> *  STAGE AND WILL BE RESUBMITTED PRIOR TO EXIT FROM THE ROUTINE.</span>
<span class="cm"> *  IF NO STREAMING IS IN PROGRESS NO URBS WILL BE SUBMITTED BY THE</span>
<span class="cm"> *  ROUTINE.</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">video_idlenow</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">;</span>
	<span class="n">audio_idlenow</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_idle</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_idle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resubmit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">resubmit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;pusb_device is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: usb_set_interface() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">stop_100</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: stop_100() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">FRAME_BUFFER_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer_many</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="p">)</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">select_input</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">standard_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">standard_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">adjust_standard</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span>
				<span class="n">easycap_standard</span><span class="p">[</span><span class="n">off</span><span class="p">].</span><span class="n">v4l2_standard</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: adjust_standard() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;standard_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">standard_offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;standard_offset unchanged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">standard_offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">format_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">format_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">easycap_format</span><span class="p">[</span><span class="n">off</span><span class="p">].</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">adjust_format</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span>
				<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
				<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: adjust_format() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;format_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">format_offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;format_offset unchanged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">format_offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mood</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">brightness</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mood</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">adjust_brightness</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">mood</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: adjust_brightness rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;brightness</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mood</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">contrast</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mood</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">adjust_contrast</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">mood</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: adjust_contrast rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;contrast</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mood</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">saturation</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mood</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">adjust_saturation</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">mood</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: adjust_saturation rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;saturation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mood</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">hue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mood</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">adjust_hue</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">mood</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: adjust_hue rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;hue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: easycap.inputset[%i] unpopulated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;pusb_device is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_on</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: usb_set_interface() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">start_100</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: start_100() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resubmit</span><span class="p">)</span>
		<span class="n">easycap_video_submit_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_sequence</span> <span class="o">=</span> <span class="n">VIDEO_ISOC_BUFFER_MANY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span> <span class="o">=</span> <span class="n">video_idlenow</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_idle</span> <span class="o">=</span> <span class="n">audio_idlenow</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">easycap_video_submit_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">data_urb</span> <span class="o">*</span><span class="n">pdata_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">isbad</span><span class="p">,</span> <span class="n">nospc</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isbuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;urb_video_head uninitialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;pusb_device is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;submission of all video urbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">isbad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">nospc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">data_urb</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdata_urb</span> <span class="o">&amp;&amp;</span> <span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">purb</span> <span class="o">=</span> <span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">;</span>
				<span class="n">isbuf</span> <span class="o">=</span> <span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">isbuf</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span>
					<span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_endpointnumber</span><span class="p">);</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">isbuf</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">easycap_complete</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">peasycap</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">purb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">j</span> <span class="o">&lt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span> <span class="n">offset</span> <span class="o">=</span>
						<span class="n">j</span> <span class="o">*</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">;</span>
					<span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span> <span class="n">length</span> <span class="o">=</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">isbad</span><span class="o">++</span><span class="p">;</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: usb_submit_urb() failed &quot;</span>
						<span class="s">&quot;for urb with rc:-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">strerror</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
						<span class="n">nospc</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">m</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">isbad</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nospc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;-ENOSPC=usb_submit_urb() for %i urbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nospc</span><span class="p">);</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;.....  possibly inadequate USB bandwidth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isbad</span><span class="p">)</span>
			<span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;already streaming video urbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">easycap_audio_kill_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_urb</span> <span class="o">*</span><span class="n">pdata_urb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;purb_audio_head is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">data_urb</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata_urb</span> <span class="o">&amp;&amp;</span> <span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">);</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i audio urbs killed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">easycap_video_kill_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_urb</span> <span class="o">*</span><span class="n">pdata_urb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;purb_video_head is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;killing video urbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">data_urb</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata_urb</span> <span class="o">&amp;&amp;</span> <span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">);</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i video urbs killed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/*^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^*/</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">easycap_open_noinode</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">easycap_open</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">videodev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">pvideo_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>

	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">pvideo_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ending unsuccessfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: easycap_video_kill_urbs() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ending successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">easycap_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">kd</span><span class="p">;</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">((</span><span class="n">poll_table</span> <span class="o">*</span><span class="p">)</span><span class="n">wait</span><span class="p">))</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;WARNING:  poll table pointer is NULL ... continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  file pointer is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  peasycap-&gt;pusb_device is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">kd</span> <span class="o">=</span> <span class="n">easycap_isdongle</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: cannot down dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;locked dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *  MEANWHILE, easycap_usb_disconnect() MAY HAVE FREED POINTER</span>
<span class="cm">	 *  peasycap, IN WHICH CASE A REPEAT CALL TO isdongle() WILL FAIL.</span>
<span class="cm">	 *  IF NECESSARY, BAIL OUT.</span>
<span class="cm">	 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kd</span> <span class="o">!=</span> <span class="n">easycap_isdongle</span><span class="p">(</span><span class="n">peasycap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  file is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;pusb_device is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="cm">/*</span>
<span class="cm">	 *  IF easycap_usb_disconnect() HAS ALREADY FREED POINTER peasycap</span>
<span class="cm">	 *  BEFORE THE ATTEMPT TO ACQUIRE THE SEMAPHORE, isdongle() WILL</span>
<span class="cm">	 *  HAVE FAILED.  BAIL OUT.</span>
<span class="cm">	*/</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">easycap_video_dqbuf</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POLLERR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  IF mode IS NONZERO THIS ROUTINE RETURNS -EAGAIN RATHER THAN BLOCKING.</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="kt">int</span> <span class="nf">easycap_video_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="n">ifield</span><span class="p">,</span> <span class="n">miss</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  peasycap-&gt;pusb_device is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ifield</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=ifield</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifield</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  CHECK FOR LOST INPUT SIGNAL.</span>
<span class="cm"> *</span>
<span class="cm"> *  FOR THE FOUR-CVBS EasyCAP, THIS DOES NOT WORK AS EXPECTED.</span>
<span class="cm"> *  IF INPUT 0 IS PRESENT AND SYNC ACQUIRED, UNPLUGGING INPUT 4 DOES NOT</span>
<span class="cm"> *  RESULT IN SETTING BIT 0x40 ON REGISTER 0x1F, PRESUMABLY BECAUSE THERE</span>
<span class="cm"> *  IS FLYWHEELING ON INPUT 0.  THE UPSHOT IS:</span>
<span class="cm"> *</span>
<span class="cm"> *    INPUT 0   PLUGGED, INPUT 4   PLUGGED =&gt; SCREEN 0 OK,   SCREEN 4 OK</span>
<span class="cm"> *    INPUT 0   PLUGGED, INPUT 4 UNPLUGGED =&gt; SCREEN 0 OK,   SCREEN 4 BLACK</span>
<span class="cm"> *    INPUT 0 UNPLUGGED, INPUT 4   PLUGGED =&gt; SCREEN 0 BARS, SCREEN 4 OK</span>
<span class="cm"> *    INPUT 0 UNPLUGGED, INPUT 4 UNPLUGGED =&gt; SCREEN 0 BARS, SCREEN 4 BARS</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">input</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">input</span> <span class="o">&amp;&amp;</span> <span class="n">INPUT_MANY</span> <span class="o">&gt;</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">read_saa</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">[</span><span class="n">input</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">[</span><span class="n">input</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">[</span><span class="n">input</span><span class="p">])</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">[</span><span class="n">input</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">VIDEO_LOST_TOLERATE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">[</span><span class="n">input</span><span class="p">])</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">[</span><span class="n">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">VIDEO_LOST_TOLERATE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  WAIT FOR FIELD ifield  (0 =&gt; TOP, 1 =&gt; BOTTOM)</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">miss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
					<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">))</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">ifield</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
					<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;first wait  on wq_video, %i=field_read %i=field_fill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_video</span><span class="p">,</span>
				<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span> <span class="o">||</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span>  <span class="o">||</span>
				<span class="p">((</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ifield</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)))))))</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;aborted by signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;video_idle returning -EAGAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;video_eof</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span><span class="p">);</span>
			<span class="cp">#if defined(PERSEVERE)</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;persevering ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">reset</span><span class="p">(</span><span class="n">peasycap</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot; ... failed  returning -EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot; ... OK  returning -EAGAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cp">#endif </span><span class="cm">/*PERSEVERE*/</span><span class="cp"></span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;returning -EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">miss</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;first awakening on wq_video after %i waits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">miss</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">field2frame</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: field2frame() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  WAIT FOR THE OTHER FIELD</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifield</span><span class="p">)</span>
		<span class="n">ifield</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ifield</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">miss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">ifield</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;second wait on wq_video %i=field_read  %i=field_fill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_video</span><span class="p">,</span>
			<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span> <span class="o">||</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span>  <span class="o">||</span>
			<span class="p">((</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">ifield</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)))))))</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;aborted by signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;video_idle returning -EAGAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;video_eof</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span><span class="p">);</span>
<span class="cp">#if defined(PERSEVERE)</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;persevering ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">reset</span><span class="p">(</span><span class="n">peasycap</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot; ... failed returning -EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot; ... OK ... returning -EAGAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/*PERSEVERE*/</span><span class="cp"></span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;returning -EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">miss</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;second awakening on wq_video after %i waits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">miss</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">field2frame</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: field2frame() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  WASTE THIS FRAME</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">skip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">skipped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">skip</span> <span class="o">!=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">skipped</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">skip</span> <span class="o">-</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">skipped</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">queued</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span><span class="p">]</span>   <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer_many</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="p">)</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&amp;</span> <span class="n">easycap_standard</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">standard_offset</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span> <span class="o">=</span>
							<span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span> <span class="o">=</span>
							<span class="n">V4L2_FIELD_BOTTOM</span><span class="p">;</span>


	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;setting:    %i=peasycap-&gt;frame_read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;bumped to:  %i=peasycap-&gt;frame_fill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  BY DEFINITION, odd IS true  FOR THE FIELD OCCUPYING LINES 1,3,5,...,479</span>
<span class="cm"> *                 odd IS false FOR THE FIELD OCCUPYING LINES 0,2,4,...,478</span>
<span class="cm"> *</span>
<span class="cm"> *  WHEN BOOLEAN PARAMETER decimatepixel IS true, ONLY THE FIELD FOR WHICH</span>
<span class="cm"> *  odd==false IS TRANSFERRED TO THE FRAME BUFFER.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">field2frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">pex</span><span class="p">,</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kex</span><span class="p">,</span> <span class="n">kad</span><span class="p">,</span> <span class="n">mex</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">rex</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">rad2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">cz</span><span class="p">,</span> <span class="n">wz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">bytesperpixel</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">much</span><span class="p">,</span> <span class="n">more</span><span class="p">,</span> <span class="n">over</span><span class="p">,</span> <span class="n">rump</span><span class="p">,</span> <span class="n">caches</span><span class="p">,</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">margin</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">odd</span><span class="p">,</span> <span class="n">isuy</span><span class="p">,</span> <span class="n">decimatepixel</span><span class="p">,</span> <span class="n">badinput</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">badinput</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">input</span> <span class="o">=</span> <span class="mh">0x07</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">input</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;=====  parity %i, input 0x%02X, field buffer %i --&gt; &quot;</span>
							<span class="s">&quot;frame buffer %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">input</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;=====  %i=bytesperpixel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">bytesperpixel</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  REJECT OR CLEAN BAD FIELDS</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: on entry, still filling field buffer %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef EASYCAP_TESTCARD</span>
	<span class="n">easycap_testcard</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">input</span> <span class="o">&amp;&amp;</span> <span class="n">INPUT_MANY</span> <span class="o">&gt;</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">easycap_bars</span> <span class="o">&amp;&amp;</span> <span class="n">VIDEO_LOST_TOLERATE</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">lost</span><span class="p">[</span><span class="n">input</span><span class="p">])</span>
			<span class="n">easycap_testcard</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/*EASYCAP_TESTCARD*/</span><span class="cp"></span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>

	<span class="n">bytesperpixel</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">bytesperpixel</span><span class="p">;</span>
	<span class="n">decimatepixel</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">decimatepixel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">bytesperpixel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="mi">3</span> <span class="o">!=</span> <span class="n">bytesperpixel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">bytesperpixel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=bytesperpixel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bytesperpixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decimatepixel</span><span class="p">)</span>
		<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">w2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="n">w3</span> <span class="o">=</span> <span class="n">bytesperpixel</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="n">wz</span> <span class="o">=</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">multiplier</span> <span class="o">*</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>

	<span class="n">kex</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">;</span>  <span class="n">mex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kad</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span><span class="p">;</span>  <span class="n">mad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pex</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>  <span class="n">rex</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">pad</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">kad</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>  <span class="n">rad</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">odd</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">odd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">decimatepixel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;initial skipping %4i bytes p.%4i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">w3</span><span class="o">/</span><span class="n">multiplier</span><span class="p">,</span> <span class="n">mad</span><span class="p">);</span>
		<span class="n">pad</span> <span class="o">+=</span> <span class="p">(</span><span class="n">w3</span> <span class="o">/</span> <span class="n">multiplier</span><span class="p">);</span> <span class="n">rad</span> <span class="o">-=</span> <span class="p">(</span><span class="n">w3</span> <span class="o">/</span> <span class="n">multiplier</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">rump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">caches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cz</span> <span class="o">&lt;</span> <span class="n">wz</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  PROCESS ONE LINE OF FRAME AT FULL RESOLUTION:</span>
<span class="cm">		 *  READ   w2   BYTES FROM FIELD BUFFER,</span>
<span class="cm">		 *  WRITE  w3   BYTES TO FRAME BUFFER</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">decimatepixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">over</span> <span class="o">=</span> <span class="n">w2</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">much</span> <span class="o">=</span> <span class="n">over</span><span class="p">;</span>  <span class="n">more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rex</span> <span class="o">&lt;</span> <span class="n">much</span><span class="p">)</span>
					<span class="n">much</span> <span class="o">=</span> <span class="n">rex</span><span class="p">;</span>
				<span class="n">rump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">much</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: much is odd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">more</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">*</span>
						<span class="n">much</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">bytesperpixel</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rad</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">much</span> <span class="o">*</span> <span class="n">bytesperpixel</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * INJUDICIOUS ALTERATION OF</span>
<span class="cm">						 * THIS STATEMENT BLOCK WILL</span>
<span class="cm">						 * CAUSE BREAKAGE.  BEWARE.</span>
<span class="cm">						 */</span>
						<span class="n">rad2</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">+</span> <span class="n">bytesperpixel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">much</span> <span class="o">=</span> <span class="p">((((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rad2</span><span class="p">)</span><span class="o">/</span><span class="n">bytesperpixel</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
						<span class="n">rump</span> <span class="o">=</span> <span class="p">((</span><span class="n">bytesperpixel</span> <span class="o">*</span> <span class="n">much</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">rad</span><span class="p">;</span>
						<span class="n">more</span> <span class="o">=</span> <span class="n">rad</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rump</span><span class="p">;</span>
					<span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">much</span> <span class="o">==</span> <span class="n">rex</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">mex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_SIZE</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
							<span class="n">margin</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">pgo</span><span class="p">));</span>
						<span class="k">else</span>
							<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=bytesperpixel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">bytesperpixel</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rump</span><span class="p">)</span>
					<span class="n">caches</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">badinput</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ERROR: 0x%02X=-&gt;field_buffer&quot;</span>
							<span class="s">&quot;[%i][%i].input, &quot;</span>
							<span class="s">&quot;0x%02X=(0x08|-&gt;input)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">input</span><span class="p">,</span> <span class="n">kex</span><span class="p">,</span> <span class="n">mex</span><span class="p">,</span>
							<span class="p">(</span><span class="mh">0x08</span><span class="o">|</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">redaub</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pex</span><span class="p">,</span> <span class="n">much</span><span class="p">,</span> <span class="n">more</span><span class="p">,</span>
								<span class="n">mask</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">isuy</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: redaub() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">much</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
					<span class="n">isuy</span> <span class="o">=</span> <span class="o">!</span><span class="n">isuy</span><span class="p">;</span>

				<span class="n">over</span> <span class="o">-=</span> <span class="n">much</span><span class="p">;</span>   <span class="n">cz</span> <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>
				<span class="n">pex</span>  <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>  <span class="n">rex</span> <span class="o">-=</span> <span class="n">much</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rex</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mex</span><span class="o">++</span><span class="p">;</span>
					<span class="n">pex</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
					<span class="n">rex</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">input</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0x08</span><span class="o">|</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">))</span>
						<span class="n">badinput</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pad</span>  <span class="o">+=</span> <span class="n">more</span><span class="p">;</span>
				<span class="n">rad</span> <span class="o">-=</span> <span class="n">more</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rad</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mad</span><span class="o">++</span><span class="p">;</span>
					<span class="n">pad</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">kad</span><span class="p">][</span><span class="n">mad</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
					<span class="n">rad</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pad</span> <span class="o">+=</span> <span class="n">rump</span><span class="p">;</span>
						<span class="n">rad</span> <span class="o">-=</span> <span class="n">rump</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">over</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  SKIP  w3 BYTES IN TARGET FRAME BUFFER,</span>
<span class="cm"> *  UNLESS IT IS THE LAST LINE OF AN ODD FRAME</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odd</span> <span class="o">||</span> <span class="p">(</span><span class="n">cz</span> <span class="o">!=</span> <span class="n">wz</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">over</span> <span class="o">=</span> <span class="n">w3</span><span class="p">;</span>
				<span class="k">do</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rad</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mad</span><span class="o">++</span><span class="p">;</span>
						<span class="n">pad</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span>
							<span class="p">[</span><span class="n">kad</span><span class="p">][</span><span class="n">mad</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
						<span class="n">rad</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">more</span> <span class="o">=</span> <span class="n">over</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="n">more</span><span class="p">)</span>
						<span class="n">more</span> <span class="o">=</span> <span class="n">rad</span><span class="p">;</span>
					<span class="n">over</span> <span class="o">-=</span> <span class="n">more</span><span class="p">;</span>
					<span class="n">pad</span>  <span class="o">+=</span> <span class="n">more</span><span class="p">;</span>
					<span class="n">rad</span>  <span class="o">-=</span> <span class="n">more</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">over</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  PROCESS ONE LINE OF FRAME AT REDUCED RESOLUTION:</span>
<span class="cm"> *  ONLY IF false==odd,</span>
<span class="cm"> *  READ   w2   BYTES FROM FIELD BUFFER,</span>
<span class="cm"> *  WRITE  w3 / 2  BYTES TO FRAME BUFFER</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">over</span> <span class="o">=</span> <span class="n">w2</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">much</span> <span class="o">=</span> <span class="n">over</span><span class="p">;</span>  <span class="n">more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rex</span> <span class="o">&lt;</span> <span class="n">much</span><span class="p">)</span>
					<span class="n">much</span> <span class="o">=</span> <span class="n">rex</span><span class="p">;</span>
				<span class="n">rump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">much</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: much is odd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">more</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">*</span> <span class="n">much</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">bytesperpixel</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rad</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">much</span> <span class="o">*</span> <span class="n">bytesperpixel</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * INJUDICIOUS ALTERATION OF</span>
<span class="cm">						 * THIS STATEMENT BLOCK</span>
<span class="cm">						 * WILL CAUSE BREAKAGE.</span>
<span class="cm">						 * BEWARE.</span>
<span class="cm">						 */</span>
						<span class="n">rad2</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">+</span> <span class="n">bytesperpixel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">much</span> <span class="o">=</span> <span class="p">((((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rad2</span><span class="p">)</span> <span class="o">/</span> <span class="n">bytesperpixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
						<span class="n">rump</span> <span class="o">=</span> <span class="p">((</span><span class="n">bytesperpixel</span> <span class="o">*</span> <span class="n">much</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">rad</span><span class="p">;</span>
						<span class="n">more</span> <span class="o">=</span> <span class="n">rad</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">rump</span><span class="p">;</span>
					<span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">much</span> <span class="o">==</span> <span class="n">rex</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">mex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_SIZE</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
							<span class="n">margin</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">pgo</span><span class="p">));</span>
						<span class="k">else</span>
							<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
					<span class="p">}</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=bytesperpixel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bytesperpixel</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rump</span><span class="p">)</span>
					<span class="n">caches</span><span class="o">++</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">badinput</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ERROR: 0x%02X=-&gt;field_buffer&quot;</span>
							<span class="s">&quot;[%i][%i].input, &quot;</span>
							<span class="s">&quot;0x%02X=(0x08|-&gt;input)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">input</span><span class="p">,</span> <span class="n">kex</span><span class="p">,</span> <span class="n">mex</span><span class="p">,</span>
							<span class="p">(</span><span class="mh">0x08</span><span class="o">|</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">redaub</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pex</span><span class="p">,</span> <span class="n">much</span><span class="p">,</span> <span class="n">more</span><span class="p">,</span>
							<span class="n">mask</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">isuy</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: redaub() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">over</span> <span class="o">-=</span> <span class="n">much</span><span class="p">;</span>   <span class="n">cz</span> <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>
				<span class="n">pex</span>  <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>  <span class="n">rex</span> <span class="o">-=</span> <span class="n">much</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rex</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mex</span><span class="o">++</span><span class="p">;</span>
					<span class="n">pex</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
					<span class="n">rex</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">input</span> <span class="o">!=</span>
							<span class="p">(</span><span class="mh">0x08</span><span class="o">|</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">))</span>
						<span class="n">badinput</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pad</span>  <span class="o">+=</span> <span class="n">more</span><span class="p">;</span>
				<span class="n">rad</span> <span class="o">-=</span> <span class="n">more</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rad</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mad</span><span class="o">++</span><span class="p">;</span>
					<span class="n">pad</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">kad</span><span class="p">][</span><span class="n">mad</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
					<span class="n">rad</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pad</span> <span class="o">+=</span> <span class="n">rump</span><span class="p">;</span>
						<span class="n">rad</span> <span class="o">-=</span> <span class="n">rump</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">over</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  OTHERWISE JUST</span>
<span class="cm"> *  READ   w2   BYTES FROM FIELD BUFFER AND DISCARD THEM</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">over</span> <span class="o">=</span> <span class="n">w2</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rex</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mex</span><span class="o">++</span><span class="p">;</span>
					<span class="n">pex</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
					<span class="n">rex</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">input</span> <span class="o">!=</span>
							<span class="p">(</span><span class="mh">0x08</span><span class="o">|</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ERROR: 0x%02X=-&gt;field_buffer&quot;</span>
							<span class="s">&quot;[%i][%i].input, &quot;</span>
							<span class="s">&quot;0x%02X=(0x08|-&gt;input)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">kex</span><span class="p">][</span><span class="n">mex</span><span class="p">].</span><span class="n">input</span><span class="p">,</span> <span class="n">kex</span><span class="p">,</span> <span class="n">mex</span><span class="p">,</span>
							<span class="p">(</span><span class="mh">0x08</span><span class="o">|</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">));</span>
						<span class="n">badinput</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">much</span> <span class="o">=</span> <span class="n">over</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rex</span> <span class="o">&lt;</span> <span class="n">much</span><span class="p">)</span>
					<span class="n">much</span> <span class="o">=</span> <span class="n">rex</span><span class="p">;</span>
				<span class="n">over</span> <span class="o">-=</span> <span class="n">much</span><span class="p">;</span>
				<span class="n">cz</span> <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>
				<span class="n">pex</span>  <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>
				<span class="n">rex</span> <span class="o">-=</span> <span class="n">much</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">over</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  SANITY CHECKS</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">mex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">rex</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cz</span> <span class="o">!=</span> <span class="n">c2</span><span class="p">)</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: discrepancy %i in bytes read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">cz</span><span class="p">);</span>
	<span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="n">mad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">rad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">decimatepixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">!=</span> <span class="n">c3</span><span class="p">)</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: discrepancy %i in bytes written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">c3</span> <span class="o">-</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">*</span> <span class="n">cz</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">*</span>
				<span class="n">cz</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">c3</span><span class="p">))</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: discrepancy %i in bytes written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">c3</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">*</span> <span class="n">cz</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">c3</span><span class="p">)</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: discrepancy %i &quot;</span>
					    <span class="s">&quot;in bytes written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c3</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rump</span><span class="p">)</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;WORRY: undischarged cache at end of line in frame buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;===== field2frame(): %i bytes --&gt; %i bytes (incl skip)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;===== field2frame(): %i=mad  %i=rad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">rad</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">odd</span><span class="p">)</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;+++++ field2frame():  frame buffer %i is full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kad</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;WARNING: on exit, filling field buffer %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caches</span><span class="p">)</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=caches</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">caches</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  DECIMATION AND COLOURSPACE CONVERSION.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS ROUTINE REQUIRES THAT ALL THE DATA TO BE READ RESIDES ON ONE PAGE</span>
<span class="cm"> *  AND THAT ALL THE DATA TO BE WRITTEN RESIDES ON ONE (DIFFERENT) PAGE.</span>
<span class="cm"> *  THE CALLING ROUTINE MUST ENSURE THAT THIS REQUIREMENT IS MET, AND MUST</span>
<span class="cm"> *  ALSO ENSURE THAT much IS EVEN.</span>
<span class="cm"> *</span>
<span class="cm"> *  much BYTES ARE READ, AT LEAST (bytesperpixel * much)/2 BYTES ARE WRITTEN</span>
<span class="cm"> *  IF THERE IS NO DECIMATION, HALF THIS AMOUNT IF THERE IS DECIMATION.</span>
<span class="cm"> *</span>
<span class="cm"> *  mask IS ZERO WHEN NO SPECIAL BEHAVIOUR REQUIRED. OTHERWISE IT IS SET THUS:</span>
<span class="cm"> *     0x03 &amp; mask =  number of bytes to be written to cache instead of to</span>
<span class="cm"> *                    frame buffer</span>
<span class="cm"> *     0x04 &amp; mask =&gt; use argument margin to set the chrominance for last pixel</span>
<span class="cm"> *     0x08 &amp; mask =&gt; do not set the chrominance for last pixel</span>
<span class="cm"> *</span>
<span class="cm"> *  YUV to RGB CONVERSION IS (OR SHOULD BE) ITU-R BT 601.</span>
<span class="cm"> *</span>
<span class="cm"> *  THERE IS A LOT OF CODE REPETITION IN THIS ROUTINE IN ORDER TO AVOID</span>
<span class="cm"> *  INEFFICIENT SWITCHING INSIDE INNER LOOPS.  REARRANGING THE LOGIC TO</span>
<span class="cm"> *  REDUCE CODE LENGTH WILL GENERALLY IMPAIR RUNTIME PERFORMANCE.  BEWARE.</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">redaub</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">pad</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">much</span><span class="p">,</span> <span class="kt">int</span> <span class="n">more</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">margin</span><span class="p">,</span> <span class="n">bool</span> <span class="n">isuy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">s32</span> <span class="n">ay</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">bu</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">rv</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">gu</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">gv</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pcache</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">p2</span><span class="p">,</span> <span class="o">*</span><span class="n">p3</span><span class="p">,</span> <span class="o">*</span><span class="n">pz</span><span class="p">,</span> <span class="o">*</span><span class="n">pr</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">bytesperpixel</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">byteswaporder</span><span class="p">,</span> <span class="n">decimatepixel</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">rump</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">much</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: much is odd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bytesperpixel</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">bytesperpixel</span><span class="p">;</span>
	<span class="n">byteswaporder</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">byteswaporder</span><span class="p">;</span>
	<span class="n">decimatepixel</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">decimatepixel</span><span class="p">;</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bu</span><span class="p">[</span><span class="mi">255</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">112</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">453</span> <span class="o">*</span> <span class="n">j</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">bu</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">128</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tmp</span><span class="p">;</span> <span class="n">bu</span><span class="p">[</span><span class="mi">127</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">359</span> <span class="o">*</span> <span class="n">j</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">rv</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">128</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tmp</span><span class="p">;</span> <span class="n">rv</span><span class="p">[</span><span class="mi">127</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">88</span> <span class="o">*</span> <span class="n">j</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">gu</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">128</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tmp</span><span class="p">;</span> <span class="n">gu</span><span class="p">[</span><span class="mi">127</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">183</span> <span class="o">*</span> <span class="n">j</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">gv</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">128</span><span class="p">]</span> <span class="o">=</span>  <span class="n">tmp</span><span class="p">;</span> <span class="n">gv</span><span class="p">[</span><span class="mi">127</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bu</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="n">rv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
			<span class="n">gu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gu</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="n">gv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bu</span><span class="p">[</span><span class="mi">239</span><span class="p">];</span> <span class="n">rv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="mi">239</span><span class="p">];</span>
			<span class="n">gu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gu</span><span class="p">[</span><span class="mi">239</span><span class="p">];</span> <span class="n">gv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="p">[</span><span class="mi">239</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span>  <span class="mi">16</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">236</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ay</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span>  <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ay</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">236</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ay</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[</span><span class="mi">235</span><span class="p">];</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;lookup tables are prepared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pcache</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcache</span><span class="p">)</span>
		<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  TRANSFER CONTENTS OF CACHE TO THE FRAME BUFFER</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: pcache is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcache</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;cache has %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">pcache</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">p2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">p3</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pad</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">pcache</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p2</span> <span class="o">&lt;</span> <span class="n">pcache</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p3</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>  <span class="n">p2</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p3</span> <span class="o">!=</span> <span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: pointer misalignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">rump</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pex</span><span class="p">;</span>  <span class="n">pz</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">much</span><span class="p">;</span>  <span class="n">pr</span> <span class="o">=</span> <span class="n">p3</span> <span class="o">+</span> <span class="n">more</span><span class="p">;</span>  <span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">p2</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
		<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rump</span><span class="p">)</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%4i=much  %4i=more  %i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">much</span><span class="p">,</span> <span class="n">more</span><span class="p">,</span> <span class="n">rump</span><span class="p">);</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">decimatepixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pex</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">much</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byteswaporder</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* UYVY */</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* YUYV */</span>
				<span class="n">p3</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pad</span><span class="p">;</span>  <span class="n">pz</span> <span class="o">=</span> <span class="n">p3</span> <span class="o">+</span> <span class="n">much</span><span class="p">;</span>
				<span class="k">while</span>  <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">p3</span><span class="p">;</span>
					<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
					<span class="n">p3</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byteswaporder</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*  UYVY DECIMATED */</span>
				<span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pex</span><span class="p">;</span>  <span class="n">p3</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pad</span><span class="p">;</span>  <span class="n">pz</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">much</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
					<span class="n">p3</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>  <span class="n">p2</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* YUYV DECIMATED */</span>
				<span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pex</span><span class="p">;</span>  <span class="n">p3</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pad</span><span class="p">;</span>  <span class="n">pz</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">much</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
					<span class="n">p3</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>  <span class="n">p2</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">decimatepixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byteswaporder</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RGB */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
								<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
								<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
								<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
					<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
								<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="nl">default:</span> <span class="p">{</span>
							<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">);</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* BGR */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="k">else</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
							<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
					<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="nl">default:</span> <span class="p">{</span>
							<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">);</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byteswaporder</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*  RGB DECIMATED */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
								<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span>
									<span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
						<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
							<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="nl">default:</span> <span class="p">{</span>
								<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: &quot;</span>
								<span class="s">&quot;%i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* BGR DECIMATED */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
								<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span>
									<span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
						<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
							<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="nl">default:</span> <span class="p">{</span>
								<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: &quot;</span>
								<span class="s">&quot;%i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">decimatepixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byteswaporder</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RGBA */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							 <span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
								<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
					<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="mi">3</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="nl">default:</span> <span class="p">{</span>
							<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">);</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *  BGRA</span>
<span class="cm">				 */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							 <span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
								<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
					<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
					<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="mi">3</span>: <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="nl">default:</span>
							<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">);</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byteswaporder</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *  RGBA DECIMATED</span>
<span class="cm">				 */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
								<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span>
									<span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
						<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
							<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">case</span> <span class="mi">3</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="nl">default:</span> <span class="p">{</span>
								<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: &quot;</span>
								<span class="s">&quot;%i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span>
								<span class="n">rump</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *  BGRA DECIMATED</span>
<span class="cm">				 */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pz</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="n">bytesperpixel</span><span class="p">))</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">last</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x0C</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
								<span class="n">v</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">u</span> <span class="o">=</span> <span class="n">margin</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="k">if</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
								<span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span>
							<span class="n">v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">u</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">isuy</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">gu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">]</span> <span class="o">-</span>
									<span class="n">gv</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">v</span><span class="p">];</span>
						<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
						<span class="n">tmp</span> <span class="o">=</span> <span class="n">ay</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="n">bu</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">u</span><span class="p">];</span>
						<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">?</span>
									<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&amp;&amp;</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">pcache</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
							<span class="k">switch</span> <span class="p">(</span><span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">case</span> <span class="mi">3</span>: <span class="p">{</span>
								<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
								<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
								<span class="o">*</span><span class="n">pcache</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="nl">default:</span> <span class="p">{</span>
								<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: &quot;</span>
								<span class="s">&quot;%i=rump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">bytesperpixel</span> <span class="o">-</span> <span class="n">rump</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="n">p3</span> <span class="o">+=</span> <span class="n">bytesperpixel</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">isuy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">p2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: %i=bytesperpixel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bytesperpixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *  SEE CORBET ET AL. &quot;LINUX DEVICE DRIVERS&quot;, 3rd EDITION, PAGES 430-434</span>
<span class="cm"> */</span>
<span class="cm">/*****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">easycap_vma_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">pvma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>

	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">pvma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">vma_many</span><span class="o">++</span><span class="p">;</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;vma_many</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">vma_many</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">easycap_vma_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">pvma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>

	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">pvma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">vma_many</span><span class="o">--</span><span class="p">;</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%i=peasycap-&gt;vma_many</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">vma_many</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">easycap_vma_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">pvma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_fault</span> <span class="o">*</span><span class="n">pvmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>

	<span class="n">retcode</span> <span class="o">=</span> <span class="n">VM_FAULT_NOPAGE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;pvma is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvmf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;pvmf is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvmf</span><span class="o">-&gt;</span><span class="n">pgoff</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvmf</span><span class="o">-&gt;</span><span class="n">pgoff</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%4i=k, %4i=m</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%4i=k, %4i=m</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">FRAME_BUFFER_MANY</span> <span class="o">&lt;=</span> <span class="n">k</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: buffer index %i out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: page number  %i out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">pvma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  pbuf is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  page is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  page is NULL after get_page(page)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pvmf</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">VM_FAULT_MINOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">easycap_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>  <span class="o">=</span> <span class="n">easycap_vma_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">easycap_vma_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fault</span> <span class="o">=</span> <span class="n">easycap_vma_fault</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">easycap_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">pvma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pvma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">easycap_vm_ops</span><span class="p">;</span>
	<span class="n">pvma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_RESERVED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span>
		<span class="n">pvma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">easycap_vma_open</span><span class="p">(</span><span class="n">pvma</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  ON COMPLETION OF A VIDEO URB ITS DATA IS COPIED TO THE FIELD BUFFERS</span>
<span class="cm"> *  PROVIDED peasycap-&gt;video_idle IS ZERO.  REGARDLESS OF THIS BEING TRUE,</span>
<span class="cm"> *  IT IS RESUBMITTED PROVIDED peasycap-&gt;video_isoc_streaming IS NOT ZERO.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS FUNCTION IS AN INTERRUPT SERVICE ROUTINE AND MUST NOT SLEEP.</span>
<span class="cm"> *</span>
<span class="cm"> *  INFORMATION ABOUT THE VALIDITY OF THE CONTENTS OF THE FIELD BUFFER ARE</span>
<span class="cm"> *  STORED IN THE TWO-BYTE STATUS PARAMETER</span>
<span class="cm"> *        peasycap-&gt;field_buffer[peasycap-&gt;field_fill][0].kount</span>
<span class="cm"> *  NOTICE THAT THE INFORMATION IS STORED ONLY WITH PAGE 0 OF THE FIELD BUFFER.</span>
<span class="cm"> *</span>
<span class="cm"> *  THE LOWER BYTE CONTAINS THE FIELD PARITY BYTE FURNISHED BY THE SAA7113H</span>
<span class="cm"> *  CHIP.</span>
<span class="cm"> *</span>
<span class="cm"> *  THE UPPER BYTE IS ZERO IF NO PROBLEMS, OTHERWISE:</span>
<span class="cm"> *      0 != (kount &amp; 0x8000)   =&gt; AT LEAST ONE URB COMPLETED WITH ERRORS</span>
<span class="cm"> *      0 != (kount &amp; 0x4000)   =&gt; BUFFER HAS TOO MUCH DATA</span>
<span class="cm"> *      0 != (kount &amp; 0x2000)   =&gt; BUFFER HAS NOT ENOUGH DATA</span>
<span class="cm"> *      0 != (kount &amp; 0x1000)   =&gt; BUFFER HAS DATA FROM DISPARATE INPUTS</span>
<span class="cm"> *      0 != (kount &amp; 0x0400)   =&gt; RESERVED</span>
<span class="cm"> *      0 != (kount &amp; 0x0200)   =&gt; FIELD BUFFER NOT YET CHECKED</span>
<span class="cm"> *      0 != (kount &amp; 0x0100)   =&gt; BUFFER HAS TWO EXTRA BYTES - WHY?</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">easycap_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_buffer</span> <span class="o">*</span><span class="n">pfield_buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">errbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">more</span><span class="p">,</span> <span class="n">much</span><span class="p">,</span> <span class="n">leap</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">videofieldamount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">override</span><span class="p">,</span> <span class="n">bad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">framestatus</span><span class="p">,</span> <span class="n">framelength</span><span class="p">,</span> <span class="n">frameactual</span><span class="p">,</span> <span class="n">frameoffset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: easycap_complete(): purb is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: easycap_complete(): peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VIDEO_ISOC_BUFFER_MANY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pgo</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%2i=urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_sequence</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((((</span><span class="n">VIDEO_ISOC_BUFFER_MANY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">i</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(((</span><span class="n">VIDEO_ISOC_BUFFER_MANY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;ERROR: out-of-order urbs %i,%i ... continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">last</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_sequence</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%i=video_idle  %i=video_isoc_streaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;%s:%d ENOMEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">rc</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: while %i=video_idle, &quot;</span>
								<span class="s">&quot;usb_submit_urb() &quot;</span>
								<span class="s">&quot;failed with rc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_MANY</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: bad peasycap-&gt;field_fill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">-</span><span class="n">ESHUTDOWN</span> <span class="o">==</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span> <span class="o">==</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;urb status -ESHUTDOWN or -ENOENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x8000</span> <span class="p">;</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: bad urb status -%s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
					<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x8000</span> <span class="p">;</span>
				<span class="cm">/* FIXME: 1. missing &#39;-&#39; check boundaries */</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">errbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">strerror</span><span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">framestatus</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
			<span class="n">framelength</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
			<span class="n">frameactual</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>
			<span class="n">frameoffset</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>

			<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;frame[%2i]:&quot;</span>
					<span class="s">&quot;%4i=status &quot;</span>
					<span class="s">&quot;%4i=actual &quot;</span>
					<span class="s">&quot;%4i=length &quot;</span>
					<span class="s">&quot;%5i=offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">framestatus</span><span class="p">,</span> <span class="n">frameactual</span><span class="p">,</span> <span class="n">framelength</span><span class="p">,</span> <span class="n">frameoffset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">more</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>
				<span class="n">pfield_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
					  <span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">][</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">];</span>
				<span class="n">videofieldamount</span> <span class="o">=</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span> <span class="o">*</span>
					<span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span> <span class="o">-</span> <span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pgo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">==</span> <span class="n">more</span><span class="p">)</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_mt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;</span> <span class="n">more</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_mt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%4i empty video urb frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_mt</span><span class="p">);</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_mt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_MANY</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: bad peasycap-&gt;field_fill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;=</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: bad peasycap-&gt;field_page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pfield_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
					<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">][</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">];</span>
				<span class="n">pu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span>
						<span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">pu</span><span class="p">)</span>
					<span class="n">leap</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">leap</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  EIGHT-BYTE END-OF-VIDEOFIELD MARKER.</span>
<span class="cm"> *  NOTE:  A SUCCESSION OF URB FRAMES FOLLOWING THIS ARE EMPTY,</span>
<span class="cm"> *         CORRESPONDING TO THE FIELD FLYBACK (VERTICAL BLANKING) PERIOD.</span>
<span class="cm"> *</span>
<span class="cm"> *  PROVIDED THE FIELD BUFFER CONTAINS GOOD DATA AS INDICATED BY A ZERO UPPER</span>
<span class="cm"> *  BYTE OF</span>
<span class="cm"> *        peasycap-&gt;field_buffer[peasycap-&gt;field_fill][0].kount</span>
<span class="cm"> *  THE CONTENTS OF THE FIELD BUFFER ARE OFFERED TO dqbuf(), field_read IS</span>
<span class="cm"> *  UPDATED AND field_fill IS BUMPED.  IF THE FIELD BUFFER CONTAINS BAD DATA</span>
<span class="cm"> *  NOTHING IS OFFERED TO dqbuf().</span>
<span class="cm"> *</span>
<span class="cm"> *  THE DECISION ON WHETHER THE PARITY OF THE OFFERED FIELD BUFFER IS RIGHT</span>
<span class="cm"> *  RESTS WITH dqbuf().</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
				<span class="k">if</span> <span class="p">((</span><span class="mi">8</span> <span class="o">==</span> <span class="n">more</span><span class="p">)</span> <span class="o">||</span> <span class="n">override</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">videofieldamount</span> <span class="o">&gt;</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">videofieldamount</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">videofieldamount</span> <span class="o">-</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">videofieldamount</span><span class="p">)</span> <span class="p">{</span>
							<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
								<span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span>
								<span class="n">VIDEO_JUNK_TOLERATE</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
								<span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">videofieldamount</span> <span class="o">&lt;</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">videofieldamount</span><span class="p">)</span> <span class="p">{</span>
							<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
								<span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">bad</span> <span class="o">=</span> <span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
							<span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bad</span><span class="p">)</span> <span class="p">{</span>
							<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">VIDEO_JUNK_TOLERATE</span> <span class="o">&gt;</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span><span class="p">)</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span> <span class="o">=</span>
								<span class="o">-</span><span class="n">VIDEO_JUNK_TOLERATE</span><span class="p">;</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">=</span>
								<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span>
									<span class="n">field_fill</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_MANY</span> <span class="o">&lt;=</span>
									<span class="n">peasycap</span><span class="o">-&gt;</span>
									<span class="n">field_fill</span><span class="p">)</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span>
									<span class="n">field_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">pfield_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">field_buffer</span>
								<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">field_fill</span><span class="p">]</span>
								<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">field_page</span><span class="p">];</span>
							<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span> <span class="o">=</span>
								<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pgo</span><span class="p">;</span>
							<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;bumped to: %i=&quot;</span>
								<span class="s">&quot;peasycap-&gt;&quot;</span>
								<span class="s">&quot;field_fill  %i=&quot;</span>
								<span class="s">&quot;parity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">,</span>
								<span class="mh">0x00FF</span> <span class="o">&amp;</span>
								<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">kount</span><span class="p">);</span>
							<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;field buffer %i has &quot;</span>
								<span class="s">&quot;%i bytes fit to be &quot;</span>
								<span class="s">&quot;read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">,</span>
								<span class="n">videofieldamount</span><span class="p">);</span>
							<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;wakeup call to &quot;</span>
								<span class="s">&quot;wq_video, &quot;</span>
								<span class="s">&quot;%i=field_read &quot;</span>
								<span class="s">&quot;%i=field_fill &quot;</span>
								<span class="s">&quot;%i=parity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span><span class="p">,</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">,</span>
								<span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">field_buffer</span>
								<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">field_read</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span><span class="p">);</span>
							<span class="n">wake_up_interruptible</span>
								<span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span>
									 <span class="n">wq_video</span><span class="p">));</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bad</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span> <span class="o">+=</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">VIDEO_JUNK_TOLERATE</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;field buffer %i had %i &quot;</span>
							<span class="s">&quot;bytes, now discarded: &quot;</span>
							<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">,</span>
							<span class="n">videofieldamount</span><span class="p">,</span>
							<span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span>
							<span class="n">kount</span><span class="p">));</span>
						<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_MANY</span> <span class="o">&lt;=</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">pfield_buffer</span> <span class="o">=</span>
							<span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">];</span>
						<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span> <span class="o">=</span>
								<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pgo</span><span class="p">;</span>

						<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;bumped to: %i=peasycap-&gt;&quot;</span>
							<span class="s">&quot;field_fill  %i=parity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">,</span>
							<span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">kount</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="mi">8</span> <span class="o">==</span> <span class="n">more</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;end-of-field: received &quot;</span>
							<span class="s">&quot;parity byte 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="p">(</span><span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">pu</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">pu</span><span class="p">)</span>
							<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">kount</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
						<span class="k">else</span>
							<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">kount</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
						<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="mh">0x08</span> <span class="o">|</span>
							<span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;end-of-field: 0x%02X=kount</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">kount</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  COPY more BYTES FROM ISOC BUFFER TO FIELD BUFFER</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
				<span class="n">pu</span> <span class="o">+=</span> <span class="n">leap</span><span class="p">;</span>
				<span class="n">more</span> <span class="o">-=</span> <span class="n">leap</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_MANY</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: bad peasycap-&gt;field_fill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: bad peasycap-&gt;field_page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pfield_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
					<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">][</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">];</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">more</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pfield_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
							<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span> <span class="o">-</span>
								<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pgo</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: bad pfield_buffer-&gt;pto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">==</span> <span class="p">(</span><span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span> <span class="o">-</span>
								<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pgo</span><span class="p">))</span> <span class="p">{</span>
						<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">FIELD_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;=</span>
								<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">JOM</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;wrapping peasycap-&gt;&quot;</span>
								<span class="s">&quot;field_page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
							<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">pfield_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">field_buffer</span>
								<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
								<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span><span class="p">];</span>
						<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span> <span class="o">=</span> <span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pgo</span><span class="p">;</span>
						<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="mh">0x08</span> <span class="o">|</span>
							<span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span>
								<span class="n">field_fill</span><span class="p">][</span><span class="mi">0</span><span class="p">]).</span>
									<span class="n">input</span> <span class="o">!=</span>
								<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span>
							<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span>
								<span class="p">[</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span><span class="p">]</span>
								<span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">kount</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">much</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span>
						<span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span> <span class="o">-</span>
							<span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pgo</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">much</span> <span class="o">&gt;</span> <span class="n">more</span><span class="p">)</span>
						<span class="n">much</span> <span class="o">=</span> <span class="n">more</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span><span class="p">,</span> <span class="n">pu</span><span class="p">,</span> <span class="n">much</span><span class="p">);</span>
					<span class="n">pu</span> <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>
					<span class="p">(</span><span class="n">pfield_buffer</span><span class="o">-&gt;</span><span class="n">pto</span><span class="p">)</span> <span class="o">+=</span> <span class="n">much</span><span class="p">;</span>
					<span class="n">more</span> <span class="o">-=</span> <span class="n">much</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  RESUBMIT THIS URB, UNLESS A SEVERE PERSISTENT ERROR CONDITION EXISTS.</span>
<span class="cm"> *</span>
<span class="cm"> *  IF THE WAIT QUEUES ARE NOT CLEARED IN RESPONSE TO AN ERROR CONDITION</span>
<span class="cm"> *  THE USERSPACE PROGRAM, E.G. mplayer, MAY HANG ON EXIT.   BEWARE.</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEO_ISOC_BUFFER_MANY</span> <span class="o">&lt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;easycap driver shutting down on condition green</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_junk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_video</span><span class="p">);</span>
<span class="cp">#if !defined(PERSEVERE)</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_audio</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/*PERSEVERE*/</span><span class="cp"></span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;%s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">rc</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: while %i=video_idle, &quot;</span>
					<span class="s">&quot;usb_submit_urb() &quot;</span>
					<span class="s">&quot;failed with rc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_idle</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="nf">alloc_easycap</span><span class="p">(</span><span class="n">u8</span> <span class="n">bInterfaceNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: Could not allocate peasycap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_dongle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: cannot lock mutex_dongle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find a free dongle in easycapdc60_dongle array */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DONGLE_MANY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">peasycap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex_audio</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">peasycap</span> <span class="o">=</span> <span class="n">peasycap</span><span class="p">;</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">isdongle</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;intf[%i]: peasycap--&gt;easycap&quot;</span>
				<span class="s">&quot;_dongle[%i].peasycap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_dongle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">DONGLE_MANY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: too many dongles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">peasycap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_easycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">allocation_video_urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">allocation_video_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">allocation_video_struct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">allocation_audio_urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">allocation_audio_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">allocation_audio_struct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">registered_video</span><span class="p">,</span> <span class="n">registered_audio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kd</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing easycap structure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">allocation_video_urb</span>    <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_urb</span><span class="p">;</span>
	<span class="n">allocation_video_page</span>   <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_page</span><span class="p">;</span>
	<span class="n">allocation_video_struct</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_struct</span><span class="p">;</span>
	<span class="n">registered_video</span>        <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">registered_video</span><span class="p">;</span>
	<span class="n">allocation_audio_urb</span>    <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_urb</span><span class="p">;</span>
	<span class="n">allocation_audio_page</span>   <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_page</span><span class="p">;</span>
	<span class="n">allocation_audio_struct</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_struct</span><span class="p">;</span>
	<span class="n">registered_audio</span>        <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">registered_audio</span><span class="p">;</span>

	<span class="n">kd</span> <span class="o">=</span> <span class="n">easycap_isdongle</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_dongle</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: cannot down mutex_dongle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;locked mutex_dongle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">peasycap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_dongle</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;unlocked mutex_dongle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;   null--&gt;dongle[%i].peasycap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
			<span class="n">allocation_video_struct</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: cannot purge dongle[].peasycap&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free device structure */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=video urbs    after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">allocation_video_urb</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=video pages   after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">allocation_video_page</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=video structs after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">allocation_video_struct</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=video devices after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">registered_video</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=audio urbs    after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">allocation_audio_urb</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=audio pages   after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">allocation_audio_page</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=audio structs after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">allocation_audio_struct</span><span class="p">);</span>
	<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;%8i=audio devices after all deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">registered_audio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: Identify the appropriate pointer peasycap for interfaces</span>
<span class="cm"> * 1 and 2. The address of peasycap-&gt;pusb_device is reluctantly used</span>
<span class="cm"> * for this purpose.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="nf">get_easycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">bInterfaceNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DONGLE_MANY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span> <span class="o">==</span> <span class="n">usbdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peasycap</span> <span class="o">=</span> <span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">peasycap</span><span class="p">;</span>
			<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;intf[%i]: dongle[%i].peasycap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">DONGLE_MANY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is unknown when probing interface %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL when probing interface %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">peasycap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_easycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">bInterfaceNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Save usb_device and usb_interface */</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span> <span class="o">=</span> <span class="n">usbdev</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_interface</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;intf[%i]: after kref_init(..._video) &quot;</span>
		<span class="s">&quot;%i=peasycap-&gt;kref.refcount.counter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">.</span><span class="n">refcount</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>

	<span class="cm">/* module params */</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">clamp</span><span class="p">(</span><span class="n">easycap_gain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_video</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_audio</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_trigger</span><span class="p">);</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_struct</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span><span class="p">);</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">microphone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_on</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_off</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_endpointnumber</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_interface</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_altsetting_on</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_altsetting_off</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_endpointnumber</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer_many</span> <span class="o">=</span> <span class="n">FRAME_BUFFER_MANY</span><span class="p">;</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ntsc</span> <span class="o">=</span> <span class="n">easycap_ntsc</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;defaulting initially to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">easycap_ntsc</span> <span class="o">?</span> <span class="s">&quot;NTSC&quot;</span> <span class="o">:</span> <span class="s">&quot;PAL&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">populate_inputset</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inputset</span> <span class="o">*</span><span class="n">inputset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">easycap_format</span> <span class="o">*</span><span class="n">peasycap_format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">fmtidx</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">inputset</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">inputset</span><span class="p">;</span>

	<span class="n">fmtidx</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ntsc</span> <span class="o">?</span> <span class="n">NTSC_M</span> <span class="o">:</span> <span class="n">PAL_BGHIN</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">easycap_standard</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmtidx</span> <span class="o">==</span> <span class="n">easycap_standard</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l2_standard</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">INPUT_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">inputset</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">standard_offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">easycap_standard</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: inputset-&gt;standard_offset unpopulated, %i=m</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">peasycap_format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">easycap_format</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">peasycap_format</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peasycap_format</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">peasycap_format</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_NONE</span>
			<span class="o">&amp;&amp;</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_UYVY</span>
			<span class="o">&amp;&amp;</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>  <span class="o">==</span> <span class="mi">640</span> <span class="o">&amp;&amp;</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">INPUT_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">inputset</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">format_offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap_format</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: inputset[]-&gt;format_offset unpopulated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">easycap_control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">easycap_control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_CID_BRIGHTNESS</span> <span class="o">==</span> <span class="n">easycap_control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">INPUT_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">inputset</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_CID_CONTRAST</span> <span class="o">==</span> <span class="n">easycap_control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">INPUT_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">inputset</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_CID_SATURATION</span> <span class="o">==</span> <span class="n">easycap_control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">INPUT_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">inputset</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">V4L2_CID_HUE</span> <span class="o">==</span> <span class="n">easycap_control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">INPUT_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">inputset</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">hue</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: inputset[]-&gt;brightness underpopulated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">INPUT_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="n">inputset</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;populated inputset[]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_framebuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocating %i frame buffers of size %li</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FRAME_BUFFER_MANY</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">FRAME_BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;.... each scattered over %li pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FRAME_BUFFER_MANY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pgo</span><span class="p">)</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;attempting to reallocate framebuffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: Could not allocate &quot;</span>
					<span class="s">&quot;framebuffer %i page %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_page</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pto</span> <span class="o">=</span>
			    <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocation of frame buffers done: %i pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_framebuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">gone</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing video frame buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">k</span> <span class="o">&lt;</span> <span class="n">FRAME_BUFFER_MANY</span><span class="p">;</span>  <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">m</span> <span class="o">&lt;</span> <span class="n">FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span>  <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span><span class="p">);</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">frame_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_page</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">gone</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;video frame buffers freed: %i pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gone</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_fieldbuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocating %i field buffers of size %li</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FIELD_BUFFER_MANY</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">FIELD_BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;.... each scattered over %li pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">FIELD_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_MANY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pgo</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: attempting to reallocate &quot;</span>
					<span class="s">&quot;fieldbuffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: Could not allocate &quot;</span>
					<span class="s">&quot;fieldbuffer %i page %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_page</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pto</span> <span class="o">=</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* TODO: Hardcoded 0x0200 meaning? */</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">kount</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocation of field buffers done:  %i pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_fieldbuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">gone</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing video field buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">k</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_MANY</span><span class="p">;</span>  <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">m</span> <span class="o">&lt;</span> <span class="n">FIELD_BUFFER_SIZE</span><span class="o">/</span><span class="n">PAGE_SIZE</span><span class="p">;</span>  <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					  <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span><span class="p">);</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">field_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_page</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">gone</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;video field buffers freed: %i pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gone</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_isocbuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocating %i isoc video buffers of size %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">VIDEO_ISOC_BUFFER_MANY</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;.... each occupying contiguous memory pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VIDEO_ISOC_BUFFER_MANY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span>
				<span class="n">VIDEO_ISOC_ORDER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: Could not allocate isoc &quot;</span>
				<span class="s">&quot;video buffer %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_page</span> <span class="o">+=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">VIDEO_ISOC_ORDER</span><span class="p">);</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pto</span> <span class="o">=</span>
			<span class="n">pbuf</span> <span class="o">+</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">;</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kount</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocation of isoc video buffers done: %i pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">VIDEO_ISOC_ORDER</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_isocbuffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing video isoc buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">k</span> <span class="o">&lt;</span> <span class="n">VIDEO_ISOC_BUFFER_MANY</span><span class="p">;</span>  <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
				   <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span><span class="p">,</span>
					<span class="n">VIDEO_ISOC_ORDER</span><span class="p">);</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_page</span> <span class="o">-=</span>
						<span class="n">BIT</span><span class="p">(</span><span class="n">VIDEO_ISOC_ORDER</span><span class="p">);</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;isoc video buffers freed: %i pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">VIDEO_ISOC_ORDER</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_video_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_urb</span> <span class="o">*</span><span class="n">pdata_urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocating %i struct urb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">VIDEO_ISOC_BUFFER_MANY</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;using %i=peasycap-&gt;video_isoc_framesperdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;using %i=peasycap-&gt;video_isoc_maxframesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;using %i=peasycap-&gt;video_isoc_buffer_sizen&quot;</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VIDEO_ISOC_BUFFER_MANY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">purb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: usb_alloc_urb returned NULL for buffer &quot;</span>
				<span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_urb</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">data_urb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata_urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: Could not allocate struct data_urb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_struct</span> <span class="o">+=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">data_urb</span><span class="p">);</span>

		<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span> <span class="o">=</span> <span class="n">purb</span><span class="p">;</span>
		<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">isbuf</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">),</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;initializing video urbs thus:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;interval = 1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;dev = peasycap-&gt;pusb_device;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;pipe = usb_rcvisocpipe&quot;</span>
					<span class="s">&quot;(peasycap-&gt;pusb_device,%i);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_endpointnumber</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;transfer_flags = URB_ISO_ASAP;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;transfer_buffer = peasycap-&gt;&quot;</span>
					<span class="s">&quot;video_isoc_buffer[.].pgo;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;transfer_buffer_length = %i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;complete = easycap_complete;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;context = peasycap;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;start_frame = 0;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;number_of_packets = %i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  for (j = 0; j &lt; %i; j++)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    purb-&gt;iso_frame_desc[j].offset = j*%i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    purb-&gt;iso_frame_desc[j].length = %i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_endpointnumber</span><span class="p">);</span>

		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">;</span>

		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">easycap_complete</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">peasycap</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span>
				<span class="n">j</span> <span class="o">*</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">;</span>
			<span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocation of %i struct urb done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_video_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist_head</span><span class="p">,</span> <span class="o">*</span><span class="n">plist_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_urb</span> <span class="o">*</span><span class="n">pdata_urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">data_urb</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdata_urb</span> <span class="o">&amp;&amp;</span> <span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">);</span>
				<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_urb</span><span class="o">--</span><span class="p">;</span>
				<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i video urbs freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing video data_urb structures.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="n">plist_next</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">data_urb</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdata_urb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_video_struct</span> <span class="o">-=</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">data_urb</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pdata_urb</span><span class="p">);</span>
				<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i video data_urb structures freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setting peasycap-&gt;purb_video_head=NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_audio_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocating %i isoc audio buffers of size %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">AUDIO_ISOC_BUFFER_MANY</span><span class="p">,</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;.... each occupying contiguous memory pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">k</span> <span class="o">&lt;</span> <span class="n">AUDIO_ISOC_BUFFER_MANY</span><span class="p">;</span>  <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIO_ISOC_ORDER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: Could not allocate isoc audio buffer %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">k</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_page</span> <span class="o">+=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">AUDIO_ISOC_ORDER</span><span class="p">);</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pto</span> <span class="o">=</span>
			<span class="n">pbuf</span> <span class="o">+</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">;</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">kount</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocation of isoc audio buffers done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_audio_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing audio isoc buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">k</span> <span class="o">&lt;</span> <span class="n">AUDIO_ISOC_BUFFER_MANY</span><span class="p">;</span>  <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span><span class="p">),</span>
					<span class="n">AUDIO_ISOC_ORDER</span><span class="p">);</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_page</span> <span class="o">-=</span>
					<span class="n">BIT</span><span class="p">(</span><span class="n">AUDIO_ISOC_ORDER</span><span class="p">);</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;easyoss_delete(): isoc audio buffers freed: %i pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">AUDIO_ISOC_ORDER</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_audio_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_urb</span> <span class="o">*</span><span class="n">pdata_urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocating %i struct urb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">AUDIO_ISOC_BUFFER_MANY</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;using %i=peasycap-&gt;audio_isoc_framesperdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;using %i=peasycap-&gt;audio_isoc_maxframesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">);</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;using %i=peasycap-&gt;audio_isoc_buffer_size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">k</span> <span class="o">&lt;</span> <span class="n">AUDIO_ISOC_BUFFER_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">purb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">,</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: usb_alloc_urb returned NULL for buffer &quot;</span>
			     <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_urb</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">data_urb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata_urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">);</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: Could not allocate struct data_urb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_struct</span> <span class="o">+=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">data_urb</span><span class="p">);</span>

		<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span> <span class="o">=</span> <span class="n">purb</span><span class="p">;</span>
		<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">isbuf</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">list_head</span><span class="p">),</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;initializing audio urbs thus:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;interval = 1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;dev = peasycap-&gt;pusb_device;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;pipe = usb_rcvisocpipe(peasycap-&gt;&quot;</span>
				<span class="s">&quot;pusb_device,%i);</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_endpointnumber</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;transfer_flags = URB_ISO_ASAP;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;transfer_buffer = &quot;</span>
				<span class="s">&quot;peasycap-&gt;audio_isoc_buffer[.].pgo;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;transfer_buffer_length = %i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;complete = easycap_alsa_complete;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;context = peasycap;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;start_frame = 0;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  purb-&gt;number_of_packets = %i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;  for (j = 0; j &lt; %i; j++)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    purb-&gt;iso_frame_desc[j].offset = j*%i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    purb-&gt;iso_frame_desc[j].length = %i;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;    }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">,</span>
					     <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_endpointnumber</span><span class="p">);</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">pgo</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">easycap_alsa_complete</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">peasycap</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">purb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">j</span> <span class="o">&lt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span>
				<span class="n">j</span> <span class="o">*</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">;</span>
			<span class="n">purb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;allocation of %i struct urb done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_audio_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">plist_head</span><span class="p">,</span> <span class="o">*</span><span class="n">plist_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_urb</span> <span class="o">*</span><span class="n">pdata_urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing audio urbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">data_urb</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdata_urb</span> <span class="o">&amp;&amp;</span> <span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span><span class="p">);</span>
				<span class="n">pdata_urb</span><span class="o">-&gt;</span><span class="n">purb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_urb</span><span class="o">--</span><span class="p">;</span>
				<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i audio urbs freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;freeing audio data_urb structures.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span> <span class="n">plist_next</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdata_urb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">plist_head</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">data_urb</span><span class="p">,</span> <span class="n">list_head</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdata_urb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">allocation_audio_struct</span> <span class="o">-=</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">data_urb</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pdata_urb</span><span class="p">);</span>
				<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i audio data_urb structures freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setting peasycap-&gt;purb_audio_head=NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">config_easycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">bInterfaceNumber</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">bInterfaceClass</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">bInterfaceSubClass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">USB_CLASS_VIDEO</span> <span class="o">==</span> <span class="n">bInterfaceClass</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">USB_CLASS_VENDOR_SPEC</span> <span class="o">==</span> <span class="n">bInterfaceClass</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span> <span class="o">=</span> <span class="n">bInterfaceNumber</span><span class="p">;</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setting peasycap-&gt;video_interface=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span> <span class="o">!=</span> <span class="n">bInterfaceNumber</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: attempting to reset &quot;</span>
				    <span class="s">&quot;peasycap-&gt;video_interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;...... continuing with &quot;</span>
				    <span class="s">&quot;%i=peasycap-&gt;video_interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">USB_CLASS_AUDIO</span> <span class="o">==</span> <span class="n">bInterfaceClass</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">USB_SUBCLASS_AUDIOSTREAMING</span> <span class="o">==</span> <span class="n">bInterfaceSubClass</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_interface</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_interface</span> <span class="o">=</span> <span class="n">bInterfaceNumber</span><span class="p">;</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;setting peasycap-&gt;audio_interface=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_interface</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_interface</span> <span class="o">!=</span> <span class="n">bInterfaceNumber</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: attempting to reset &quot;</span>
				    <span class="s">&quot;peasycap-&gt;audio_interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;...... continuing with &quot;</span>
				    <span class="s">&quot;%i=peasycap-&gt;audio_interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_interface</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called from within easycap_usb_disconnect() and is</span>
<span class="cm"> * protected by semaphores set and cleared by easycap_usb_disconnect().</span>
<span class="cm"> * By this stage the device has already been physically unplugged,</span>
<span class="cm"> * so peasycap-&gt;pusb_device is no longer valid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">easycap_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">pkref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>

	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pkref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">easycap</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL: cannot perform deletions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free video urbs */</span>
	<span class="n">free_video_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="cm">/* Free video isoc buffers */</span>
	<span class="n">free_isocbuffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="cm">/* Free video field buffers */</span>
	<span class="n">free_fieldbuffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="cm">/* Free video frame buffers */</span>
	<span class="n">free_framebuffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="cm">/* Free audio urbs */</span>
	<span class="n">free_audio_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="cm">/* Free audio isoc buffers */</span>
	<span class="n">free_audio_buffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="n">free_easycap</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">v4l2_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">easycap_open_noinode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">easycap_unlocked_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">easycap_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">easycap_mmap</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">easycap_register_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: This is believed to be harmless,</span>
<span class="cm">	 * but may well be unnecessary or wrong.</span>
<span class="cm">	 */</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;easycapdc60&quot;</span><span class="p">);</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v4l2_fops</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">videodev_release</span><span class="p">);</span>

	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">peasycap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">),</span>
					<span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">videodev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">registered_video</span><span class="o">++</span><span class="p">;</span>

	<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;registered with videodev: %i=minor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
	    <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">.</span><span class="n">minor</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When the device is plugged, this function is called three times,</span>
<span class="cm"> * one for each interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">easycap_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bInterfaceClass</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bInterfaceSubClass</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">okalt</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">isokalt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">okepn</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">okmps</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">maxpacketsize</span><span class="p">;</span>

	<span class="n">usbdev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">alt</span> <span class="o">=</span> <span class="n">usb_altnum_to_altsetting</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: usb_host_interface not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alt</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: intf_descriptor is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get properties of probed interface */</span>
	<span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">bInterfaceClass</span><span class="p">;</span>
	<span class="n">bInterfaceSubClass</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">bInterfaceSubClass</span><span class="p">;</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]: num_altsetting=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">num_altsetting</span><span class="p">);</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]: cur_altsetting - altsetting=%li</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bInterfaceNumber</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span> <span class="o">-</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">));</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]: bInterfaceClass=0x%02X bInterfaceSubClass=0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">bInterfaceClass</span><span class="p">,</span> <span class="n">bInterfaceSubClass</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * A new struct easycap is always allocated when interface 0 is probed.</span>
<span class="cm">	 * It is not possible here to free any existing struct easycap.</span>
<span class="cm">	 * This should have been done by easycap_delete() when the device was</span>
<span class="cm">	 * physically unplugged.</span>
<span class="cm">	 * The allocated struct easycap is saved for later usage when</span>
<span class="cm">	 * interfaces 1 and 2 are probed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">bInterfaceNumber</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Alloc structure and save it in a free slot in</span>
<span class="cm">		 * easycapdc60_dongle array</span>
<span class="cm">		 */</span>
		<span class="n">peasycap</span> <span class="o">=</span> <span class="n">alloc_easycap</span><span class="p">(</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* Perform basic struct initialization */</span>
		<span class="n">init_easycap</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">usbdev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">);</span>

		<span class="cm">/* Dynamically fill in the available formats */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">easycap_video_fillin_formats</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: fillin_formats() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i formats available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

		<span class="cm">/* Populate easycap.inputset[] */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">populate_inputset</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;finished initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">peasycap</span> <span class="o">=</span> <span class="n">get_easycap</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config_easycap</span><span class="p">(</span><span class="n">peasycap</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">,</span>
				 <span class="n">bInterfaceClass</span><span class="p">,</span>
				 <span class="n">bInterfaceSubClass</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Investigate all altsettings. This is done in detail</span>
<span class="cm">	 * because USB device 05e1:0408 has disparate incarnations.</span>
<span class="cm">	 */</span>
	<span class="n">isokalt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">num_altsetting</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alt</span> <span class="o">=</span> <span class="n">usb_altnum_to_altsetting</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: alt is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alt</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: intf_descriptor is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">bNumEndpoints</span><span class="p">)</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]alt[%i] has no endpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  ep is NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;...... skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_is_isoc_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]alt[%i]end[%i] is a %d endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bInterfaceNumber</span><span class="p">,</span>
						<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_out</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: OUT endpoint unexpected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;...... continuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bInterfaceClass</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_CLASS_VIDEO</span>:
			<span class="k">case</span> <span class="n">USB_CLASS_VENDOR_SPEC</span>: <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">isokalt</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">okalt</span><span class="p">[</span><span class="n">isokalt</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;%i=okalt[%i]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">okalt</span><span class="p">[</span><span class="n">isokalt</span><span class="p">],</span>
						<span class="n">isokalt</span><span class="p">);</span>
						<span class="n">okepn</span><span class="p">[</span><span class="n">isokalt</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ep</span><span class="o">-&gt;</span>
						<span class="n">bEndpointAddress</span> <span class="o">&amp;</span>
						<span class="mh">0x0F</span><span class="p">;</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;%i=okepn[%i]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">okepn</span><span class="p">[</span><span class="n">isokalt</span><span class="p">],</span>
						<span class="n">isokalt</span><span class="p">);</span>
						<span class="n">okmps</span><span class="p">[</span><span class="n">isokalt</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span>
						<span class="n">wMaxPacketSize</span><span class="p">);</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;%i=okmps[%i]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">okmps</span><span class="p">[</span><span class="n">isokalt</span><span class="p">],</span>
						<span class="n">isokalt</span><span class="p">);</span>
						<span class="n">isokalt</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">video_altsetting_off</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">video_altsetting_off</span> <span class="o">=</span>
								 <span class="n">i</span><span class="p">;</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=video_&quot;</span>
						<span class="s">&quot;altsetting_off &quot;</span>
							<span class="s">&quot;&lt;====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">video_altsetting_off</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap&quot;</span>
						<span class="s">&quot;-&gt;video_altsetting_&quot;</span>
						<span class="s">&quot;off already set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;...... &quot;</span>
						<span class="s">&quot;continuing with &quot;</span>
						<span class="s">&quot;%i=peasycap-&gt;video_&quot;</span>
						<span class="s">&quot;altsetting_off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">video_altsetting_off</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">USB_CLASS_AUDIO</span>: <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bInterfaceSubClass</span> <span class="o">!=</span>
				    <span class="n">USB_SUBCLASS_AUDIOSTREAMING</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: &quot;</span>
					<span class="s">&quot;peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">isokalt</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">okalt</span><span class="p">[</span><span class="n">isokalt</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;%i=okalt[%i]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">okalt</span><span class="p">[</span><span class="n">isokalt</span><span class="p">],</span>
						<span class="n">isokalt</span><span class="p">);</span>
						<span class="n">okepn</span><span class="p">[</span><span class="n">isokalt</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">ep</span><span class="o">-&gt;</span>
						<span class="n">bEndpointAddress</span> <span class="o">&amp;</span>
						<span class="mh">0x0F</span><span class="p">;</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;%i=okepn[%i]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">okepn</span><span class="p">[</span><span class="n">isokalt</span><span class="p">],</span>
						<span class="n">isokalt</span><span class="p">);</span>
						<span class="n">okmps</span><span class="p">[</span><span class="n">isokalt</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span>
						<span class="n">wMaxPacketSize</span><span class="p">);</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
						<span class="s">&quot;%i=okmps[%i]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">okmps</span><span class="p">[</span><span class="n">isokalt</span><span class="p">],</span>
						<span class="n">isokalt</span><span class="p">);</span>
						<span class="n">isokalt</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">audio_altsetting_off</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">audio_altsetting_off</span> <span class="o">=</span>
								 <span class="n">i</span><span class="p">;</span>
						<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=audio_&quot;</span>
						<span class="s">&quot;altsetting_off &quot;</span>
						<span class="s">&quot;&lt;====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">audio_altsetting_off</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap&quot;</span>
						<span class="s">&quot;-&gt;audio_altsetting_&quot;</span>
						<span class="s">&quot;off already set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;...... &quot;</span>
						<span class="s">&quot;continuing with &quot;</span>
						<span class="s">&quot;%i=peasycap-&gt;&quot;</span>
						<span class="s">&quot;audio_altsetting_&quot;</span>
						<span class="s">&quot;off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span>
						<span class="n">audio_altsetting_off</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]alt[%i]end[%i] &quot;</span>
							<span class="s">&quot;has zero packet size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Perform initialization of the probed interface */</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;initialization begins for interface %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bInterfaceNumber</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* 0: Video interface */</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isokalt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  no viable video_altsetting_on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_on</span> <span class="o">=</span> <span class="n">okalt</span><span class="p">[</span><span class="n">isokalt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=video_altsetting_on &lt;====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_on</span><span class="p">);</span>

		<span class="cm">/* Decide video streaming parameters */</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_endpointnumber</span> <span class="o">=</span> <span class="n">okepn</span><span class="p">[</span><span class="n">isokalt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=video_endpointnumber</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_endpointnumber</span><span class="p">);</span>
		<span class="n">maxpacketsize</span> <span class="o">=</span> <span class="n">okmps</span><span class="p">[</span><span class="n">isokalt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span> <span class="o">=</span>
				<span class="n">min</span><span class="p">(</span><span class="n">maxpacketsize</span><span class="p">,</span> <span class="n">USB_2_0_MAXPACKETSIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  bad video_isoc_maxframesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;        possibly because port is USB 1.1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=video_isoc_maxframesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">);</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span> <span class="o">=</span> <span class="n">VIDEO_ISOC_FRAMESPERDESC</span><span class="p">;</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=video_isoc_framesperdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  bad video_isoc_framesperdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span> <span class="o">=</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span> <span class="o">*</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_framesperdesc</span><span class="p">;</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=video_isoc_buffer_size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">VIDEO_ISOC_ORDER</span><span class="p">)</span> <span class="o">&lt;</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: peasycap-&gt;video_isoc_buffer_size too big</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_interface</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  video_interface is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  video_altsetting_on is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_altsetting_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  video_interface_off is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_endpointnumber</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  video_endpointnumber is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_maxframesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  video_isoc_maxframesize is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_isoc_buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  video_isoc_buffer_size is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Allocate memory for video buffers.</span>
<span class="cm">		 * Lists must be initialized first.</span>
<span class="cm">		 */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">urb_video_head</span><span class="p">));</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_video_head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">urb_video_head</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_framebuffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_fieldbuffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_isocbuffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* Allocate and initialize video urbs */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">create_video_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* Save pointer peasycap in this interface */</span>
		<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">peasycap</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * It is essential to initialize the hardware before,</span>
<span class="cm">		 * rather than after, the device is registered,</span>
<span class="cm">		 * because some udev rules triggers easycap_open()</span>
<span class="cm">		 * immediately after registration, causing a clash.</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">reset</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: reset() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The video device can now be registered */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">v4l2_device</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;v4l2_device_register() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;registered device instance: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">v4l2_device</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">easycap_register_video</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Not able to register with videodev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 1: Audio control */</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Save pointer peasycap in this interface */</span>
		<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">peasycap</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;no initialization required for interface %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">interface</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 2: Audio streaming */</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isokalt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  no viable audio_altsetting_on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_altsetting_on</span> <span class="o">=</span> <span class="n">okalt</span><span class="p">[</span><span class="n">isokalt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=audio_altsetting_on &lt;====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_altsetting_on</span><span class="p">);</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_endpointnumber</span> <span class="o">=</span> <span class="n">okepn</span><span class="p">[</span><span class="n">isokalt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=audio_endpointnumber</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_endpointnumber</span><span class="p">);</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span> <span class="o">=</span> <span class="n">okmps</span><span class="p">[</span><span class="n">isokalt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=audio_isoc_maxframesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  bad audio_isoc_maxframesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">9</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ilk</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;audio hardware is microphone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">microphone</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_pages_per_fragment</span> <span class="o">=</span>
					<span class="n">PAGES_PER_AUDIO_FRAGMENT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">256</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">ilk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;audio hardware is AC&#39;97</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">microphone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_pages_per_fragment</span> <span class="o">=</span>
					<span class="n">PAGES_PER_AUDIO_FRAGMENT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;hardware is unidentified:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;%i=audio_isoc_maxframesize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_bytes_per_fragment</span> <span class="o">=</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_pages_per_fragment</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_buffer_page_many</span> <span class="o">=</span> <span class="p">(</span><span class="n">AUDIO_FRAGMENT_MANY</span> <span class="o">*</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_pages_per_fragment</span><span class="p">);</span>

		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%6i=AUDIO_FRAGMENT_MANY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">AUDIO_FRAGMENT_MANY</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%6i=audio_pages_per_fragment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_pages_per_fragment</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%6i=audio_bytes_per_fragment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_bytes_per_fragment</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%6i=audio_buffer_page_many</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_buffer_page_many</span><span class="p">);</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span> <span class="o">=</span> <span class="n">AUDIO_ISOC_FRAMESPERDESC</span><span class="p">;</span>

		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=audio_isoc_framesperdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR:  bad audio_isoc_framesperdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span> <span class="o">=</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span> <span class="o">*</span>
					<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_framesperdesc</span><span class="p">;</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%i=audio_isoc_buffer_size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AUDIO_ISOC_BUFFER_SIZE</span> <span class="o">&lt;</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  audio_isoc_buffer_size bigger &quot;</span>
				<span class="s">&quot;than %li=AUDIO_ISOC_BUFFER_SIZE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">AUDIO_ISOC_BUFFER_SIZE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_interface</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  audio_interface is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_altsetting_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  audio_altsetting_on is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_altsetting_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  audio_interface_off is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_endpointnumber</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  audio_endpointnumber is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_maxframesize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  audio_isoc_maxframesize is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_isoc_buffer_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;MISTAKE:  audio_isoc_buffer_size is unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Allocate memory for audio buffers.</span>
<span class="cm">		 * Lists must be initialized first.</span>
<span class="cm">		 */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">urb_audio_head</span><span class="p">));</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">purb_audio_head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">urb_audio_head</span><span class="p">);</span>

		<span class="n">alloc_audio_buffers</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* Allocate and initialize urbs */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">create_audio_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* Save pointer peasycap in this interface */</span>
		<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">peasycap</span><span class="p">);</span>

		<span class="cm">/* The audio device can now be registered */</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;initializing ALSA card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">easycap_alsa_probe</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;easycap_alsa_probe() rc = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;kref_get() with %i=kref.refcount.counter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">.</span><span class="n">refcount</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">registered_audio</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Interfaces other than 0,1,2 are unexpected */</span>
	<span class="nl">default:</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ERROR: unexpected interface %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ends successfully for interface %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When this function is called the device has already been</span>
<span class="cm"> * physically unplugged.</span>
<span class="cm"> * Hence, peasycap-&gt;pusb_device is no longer valid.</span>
<span class="cm"> * This function affects alsa.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">easycap_usb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">pusb_interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">pusb_host_interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="o">*</span><span class="n">pusb_interface_descriptor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">,</span> <span class="n">kd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pusb_host_interface</span> <span class="o">=</span> <span class="n">pusb_interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_host_interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ERROR: pusb_host_interface is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pusb_interface_descriptor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pusb_host_interface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_interface_descriptor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ERROR: pusb_interface_descriptor is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">pusb_interface_descriptor</span><span class="o">-&gt;</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">pusb_interface</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]: minor=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>

	<span class="cm">/* There is nothing to do for Interface Number 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">bInterfaceNumber</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">peasycap</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">pusb_interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the waitqueues are not cleared a deadlock is possible */</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">audio_eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_video</span><span class="p">));</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_audio</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bInterfaceNumber</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">easycap_video_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">easycap_audio_kill_urbs</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Deregister</span>
<span class="cm">	 * This procedure will block until easycap_poll(),</span>
<span class="cm">	 * video and audio ioctl are all unlocked.</span>
<span class="cm">	 * If this is not done an oops can occur when an easycap</span>
<span class="cm">	 * is unplugged while the urbs are running.</span>
<span class="cm">	 */</span>
	<span class="n">kd</span> <span class="o">=</span> <span class="n">easycap_isdongle</span><span class="p">(</span><span class="n">peasycap</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bInterfaceNumber</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_video</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;about to lock dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span>
								<span class="n">mutex_video</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: &quot;</span>
				    <span class="s">&quot;cannot lock dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;locked dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: %i=kd is bad: cannot lock dongle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">v4l2_device</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;v4l2_device.name is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">v4l2_device_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">v4l2_device</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;v4l2_device_disconnect() OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">v4l2_device</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;v4l2_device_unregister() OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">video_device</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]: video_unregister_device() minor=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
		<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">registered_video</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;unlocked dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">wq_audio</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;about to lock dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span>
								<span class="n">mutex_audio</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: &quot;</span>
				    <span class="s">&quot;cannot lock dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;locked dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: %i=kd is bad: cannot lock dongle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">snd_card_free</span><span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">psnd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: snd_card_free() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">psnd_card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">(</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">registered_audio</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_audio</span><span class="p">);</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;unlocked dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no remaining references to peasycap,</span>
<span class="cm">	 * call easycap_delete.</span>
<span class="cm">	 * (Also when alsa has been in use)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">.</span><span class="n">refcount</span><span class="p">.</span><span class="n">counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ERROR: peasycap-&gt;kref.refcount.counter is zero &quot;</span>
							<span class="s">&quot;so cannot call kref_put()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ending unsuccessfully: may cause memory leak</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;about to lock dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: cannot lock dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ending unsuccessfully: may cause memory leak</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;locked dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;about to lock dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_audio</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: cannot lock dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">));</span>
			<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;unlocked dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
			<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;ending unsuccessfully: may cause memory leak</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;locked dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]: %i=peasycap-&gt;kref.refcount.counter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">.</span><span class="n">refcount</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">easycap_delete</span><span class="p">);</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;intf[%i]: kref_put() done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">kd</span> <span class="o">&amp;&amp;</span> <span class="n">DONGLE_MANY</span> <span class="o">&gt;</span> <span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_audio</span><span class="p">));</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;unlocked dongle[%i].mutex_audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">kd</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;unlocked dongle[%i].mutex_video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">JOM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ends</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Devices supported by this driver */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">easycap_usb_device_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_EASYCAP_VENDOR_ID</span><span class="p">,</span> <span class="n">USB_EASYCAP_PRODUCT_ID</span><span class="p">)},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">easycap_usb_device_id_table</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">easycap_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;easycap&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">easycap_usb_device_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">easycap_usb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">easycap_usb_disconnect</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">easycap_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Easycap version: &quot;</span><span class="n">EASYCAP_DRIVER_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;begins.  %i=debug %i=bars %i=gain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">easycap_debug</span><span class="p">,</span> <span class="n">easycap_bars</span><span class="p">,</span> <span class="n">easycap_gain</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_dongle</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">DONGLE_MANY</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">peasycap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">mutex_video</span><span class="p">);</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycapdc60_dongle</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">mutex_audio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycap_usb_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Easycap: usb_register failed rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">easycap_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">easycap_usb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">easycap_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">easycap_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
