<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › media › easycap › easycap_low.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>easycap_low.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm">*                                                                            *</span>
<span class="cm">*                                                                            *</span>
<span class="cm">*  easycap_low.c                                                             *</span>
<span class="cm">*                                                                            *</span>
<span class="cm">*                                                                            *</span>
<span class="cm">*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2010 R.M. Thomas  &lt;rmthomas@sciolus.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  The software is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this software; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm">*/</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *  ACKNOWLEGEMENTS AND REFERENCES</span>
<span class="cm"> *  ------------------------------</span>
<span class="cm"> *  This driver makes use of register information contained in the Syntek</span>
<span class="cm"> *  Semicon DC-1125 driver hosted at</span>
<span class="cm"> *               http://sourceforge.net/projects/syntekdriver/.</span>
<span class="cm"> *  Particularly useful has been a patch to the latter driver provided by</span>
<span class="cm"> *  Ivor Hewitt in January 2009.  The NTSC implementation is taken from the</span>
<span class="cm"> *  work of Ben Trask.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="cp">#include &quot;easycap.h&quot;</span>


<span class="cp">#define GET(X, Y, Z) do { \</span>
<span class="cp">	int __rc; \</span>
<span class="cp">	*(Z) = (u16)0; \</span>
<span class="cp">	__rc = regget(X, Y, Z, sizeof(u8)); \</span>
<span class="cp">	if (0 &gt; __rc) { \</span>
<span class="cp">		JOT(8, &quot;:-(%i\n&quot;, __LINE__);  return __rc; \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define SET(X, Y, Z) do { \</span>
<span class="cp">	int __rc; \</span>
<span class="cp">	__rc = regset(X, Y, Z); \</span>
<span class="cp">	if (0 &gt; __rc) { \</span>
<span class="cp">		JOT(8, &quot;:-(%i\n&quot;, __LINE__);  return __rc; \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0)</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stk1160config</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stk1160configPAL</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x000</span><span class="p">,</span> <span class="mh">0x0098</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x002</span><span class="p">,</span> <span class="mh">0x0093</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0x001</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x003</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00D</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00F</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x018</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x019</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x01A</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x01B</span><span class="p">,</span> <span class="mh">0x000E</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x01C</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x103</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x104</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x105</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x106</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>

<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
<span class="cm">/*</span>
<span class="cm"> *  RESOLUTION 640x480</span>
<span class="cm">*/</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
		<span class="p">{</span><span class="mh">0x110</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x111</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x112</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x113</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x114</span><span class="p">,</span> <span class="mh">0x0508</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x115</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x116</span><span class="p">,</span> <span class="mh">0x0110</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x117</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>

		<span class="p">{</span><span class="mh">0x202</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x203</span><span class="p">,</span> <span class="mh">0x004A</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2FF</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0xFFF</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">}</span>
<span class="p">};</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stk1160config</span> <span class="n">stk1160configNTSC</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x000</span><span class="p">,</span> <span class="mh">0x0098</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x002</span><span class="p">,</span> <span class="mh">0x0093</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0x001</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x003</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00D</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x00F</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x018</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x019</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x01A</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x01B</span><span class="p">,</span> <span class="mh">0x000E</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x01C</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x103</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x104</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x105</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x106</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>

<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
<span class="cm">/*</span>
<span class="cm"> *  RESOLUTION 640x480</span>
<span class="cm">*/</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>
		<span class="p">{</span><span class="mh">0x110</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x111</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x112</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x113</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x114</span><span class="p">,</span> <span class="mh">0x0508</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x115</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x116</span><span class="p">,</span> <span class="mh">0x00F3</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x117</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>
<span class="cm">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - */</span>

		<span class="p">{</span><span class="mh">0x202</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x203</span><span class="p">,</span> <span class="mh">0x004A</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x2FF</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0xFFF</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">}</span>
<span class="p">};</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">saa7113config</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">set</span><span class="p">;</span>
<span class="p">}</span> <span class="n">saa7113configPAL</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0A</span><span class="p">,</span> <span class="n">SAA_0A_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">SAA_0B_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span> <span class="n">SAA_0C_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0D</span><span class="p">,</span> <span class="n">SAA_0D_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">}</span>
<span class="p">};</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">saa7113config</span> <span class="n">saa7113configNTSC</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0A</span><span class="p">,</span> <span class="n">SAA_0A_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">SAA_0B_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0C</span><span class="p">,</span> <span class="n">SAA_0C_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0D</span><span class="p">,</span> <span class="n">SAA_0D_DEFAULT</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">},</span>
		<span class="p">{</span><span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">},</span>

		<span class="p">{</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">regget</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">pusb_device</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="mh">0x00</span><span class="p">,</span>
			<span class="p">(</span><span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">),</span>
			<span class="mh">0x00</span><span class="p">,</span>
			<span class="n">index</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">reg_size</span><span class="p">,</span> <span class="mi">50000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">regset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="mh">0x01</span><span class="p">,</span>
			<span class="p">(</span><span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">),</span>
			<span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">easycap_readback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">igot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">regget</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">igot</span><span class="p">));</span>
		<span class="n">igot</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x000</span>:
		<span class="k">case</span> <span class="mh">0x500</span>:
		<span class="k">case</span> <span class="mh">0x502</span>:
		<span class="k">case</span> <span class="mh">0x503</span>:
		<span class="k">case</span> <span class="mh">0x504</span>:
		<span class="k">case</span> <span class="mh">0x506</span>:
		<span class="k">case</span> <span class="mh">0x507</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x204</span>:
		<span class="k">case</span> <span class="mh">0x205</span>:
		<span class="k">case</span> <span class="mh">0x350</span>:
		<span class="k">case</span> <span class="mh">0x351</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">igot</span><span class="p">)</span>
				<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;unexpected 0x%02X &quot;</span>
					<span class="s">&quot;for STK register 0x%03X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">igot</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">((</span><span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="n">igot</span><span class="p">)</span>
				<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;unexpected 0x%02X != 0x%02X &quot;</span>
					<span class="s">&quot;for STK register 0x%03X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">igot</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  FUNCTION wait_i2c() RETURNS 0 ON SUCCESS</span>
<span class="cm">*/</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">get0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">igot</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">k</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span>  <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>  <span class="n">get0</span> <span class="o">=</span> <span class="n">igot</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">get0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">get0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">write_saa</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">set0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x204</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x205</span><span class="p">,</span> <span class="n">set0</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wait_i2c</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  REGISTER 500:  SETTING VALUE TO 0x008B READS FROM VT1612A (?)</span>
<span class="cm"> *  REGISTER 500:  SETTING VALUE TO 0x008C WRITES TO  VT1612A</span>
<span class="cm"> *  REGISTER 502:  LEAST SIGNIFICANT BYTE OF VALUE TO SET</span>
<span class="cm"> *  REGISTER 503:  MOST SIGNIFICANT BYTE OF VALUE TO SET</span>
<span class="cm"> *  REGISTER 504:  TARGET ADDRESS ON VT1612A</span>
<span class="cm"> */</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_vt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">set0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">igot</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">got502</span><span class="p">,</span> <span class="n">got503</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set502</span><span class="p">,</span> <span class="n">set503</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x008B</span><span class="p">);</span>

	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0502</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>  <span class="n">got502</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">);</span>
	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0503</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>  <span class="n">got503</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">);</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;write_vt(., 0x%04X, 0x%04X): was 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">reg0</span><span class="p">,</span> <span class="n">set0</span><span class="p">,</span> <span class="p">((</span><span class="n">got503</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">got502</span><span class="p">));</span>

	<span class="n">set502</span> <span class="o">=</span>  <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">set0</span><span class="p">);</span>
	<span class="n">set503</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">set0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0502</span><span class="p">,</span> <span class="n">set502</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0503</span><span class="p">,</span> <span class="n">set503</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x008C</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  REGISTER 500:  SETTING VALUE TO 0x008B READS FROM VT1612A (?)</span>
<span class="cm"> *  REGISTER 500:  SETTING VALUE TO 0x008C WRITES TO  VT1612A</span>
<span class="cm"> *  REGISTER 502:  LEAST SIGNIFICANT BYTE OF VALUE TO GET</span>
<span class="cm"> *  REGISTER 503:  MOST SIGNIFICANT BYTE OF VALUE TO GET</span>
<span class="cm"> *  REGISTER 504:  TARGET ADDRESS ON VT1612A</span>
<span class="cm"> */</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_vt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">igot</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">got502</span><span class="p">,</span> <span class="n">got503</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0504</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x008B</span><span class="p">);</span>

	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0502</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>  <span class="n">got502</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">);</span>
	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0503</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>  <span class="n">got503</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFF</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">);</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s">&quot;read_vt(., 0x%04X): has 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reg0</span><span class="p">,</span> <span class="p">((</span><span class="n">got503</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">got502</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">got503</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">got502</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  THESE APPEAR TO HAVE NO EFFECT ON EITHER VIDEO OR AUDIO.</span>
<span class="cm"> */</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_300</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x350</span><span class="p">,</span> <span class="mh">0x002D</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x351</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x352</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x353</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">setup_stk</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ntsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">stk1160config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntsc</span><span class="p">)</span> <span class="o">?</span> <span class="n">stk1160configNTSC</span> <span class="o">:</span> <span class="n">stk1160configPAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xFFF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set</span><span class="p">);</span>

	<span class="n">write_300</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">setup_saa</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ntsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">saa7113config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntsc</span><span class="p">)</span> <span class="o">?</span>  <span class="n">saa7113configNTSC</span> <span class="o">:</span> <span class="n">saa7113configPAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to set SAA register %d&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">merit_saa</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">read_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">rc</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x02</span> <span class="o">&amp;</span> <span class="n">rc</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ready_saa</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">marktime</span> <span class="o">=</span> <span class="n">PATIENCE</span><span class="o">/</span><span class="mi">5</span><span class="p">;</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *   RETURNS    0     FOR INTERLACED       50 Hz</span>
<span class="cm"> *              1     FOR NON-INTERLACED   50 Hz</span>
<span class="cm"> *              2     FOR INTERLACED       60 Hz</span>
<span class="cm"> *              3     FOR NON-INTERLACED   60 Hz</span>
<span class="cm">*/</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">read_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">&amp;</span> <span class="n">rc</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&amp;</span> <span class="n">rc</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">marktime</span><span class="p">);</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">&amp;</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;hardware detects 60 Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;hardware detects 50 Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">&amp;</span> <span class="n">rc</span><span class="p">)</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;hardware detects interlacing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rate</span><span class="o">++</span><span class="p">;</span>
		<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;hardware detects no interlacing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">read_saa</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">igot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x208</span><span class="p">,</span> <span class="n">reg0</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">wait_i2c</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">igot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0209</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">igot</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_stk</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">igot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">igot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">igot</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">select_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">stop_100</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x02 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0098</span><span class="p">);</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x02 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0090</span><span class="p">);</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x02 &quot;</span>
					<span class="s">&quot; for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0088</span><span class="p">);</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x02 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">9</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">7</span>: <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">))</span>
				<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x02 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">))</span>
				<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x05 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="mi">9</span>: <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">))</span>
				<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x02 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>
				<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x05 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;MISTAKE:  bad mode: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x04 &quot;</span>
					<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">write_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to set SAA register 0x09 &quot;</span>
						<span class="s">&quot;for input %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

		<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0093</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR:  bad input: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">read_stk</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;STK register 0x00 has 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ir</span><span class="p">);</span>
	<span class="n">ir</span> <span class="o">=</span> <span class="n">read_saa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;SAA register 0x02 has 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ir</span><span class="p">);</span>

	<span class="n">start_100</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">set_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
		   <span class="n">u16</span> <span class="n">set0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">set1</span><span class="p">,</span> <span class="n">u16</span> <span class="n">set2</span><span class="p">,</span> <span class="n">u16</span> <span class="n">set3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">u0x0111</span><span class="p">,</span> <span class="n">u0x0113</span><span class="p">,</span> <span class="n">u0x0115</span><span class="p">,</span> <span class="n">u0x0117</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">u0x0111</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">set0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u0x0113</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">set1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u0x0115</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">set2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u0x0117</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">set3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0110</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">set0</span><span class="p">));</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0111</span><span class="p">,</span> <span class="n">u0x0111</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0112</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">set1</span><span class="p">));</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0113</span><span class="p">,</span> <span class="n">u0x0113</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0114</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">set2</span><span class="p">));</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0115</span><span class="p">,</span> <span class="n">u0x0115</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0116</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">set3</span><span class="p">));</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0117</span><span class="p">,</span> <span class="n">u0x0117</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">start_100</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">get116</span><span class="p">,</span> <span class="n">get117</span><span class="p">,</span> <span class="n">get0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">igot116</span><span class="p">,</span> <span class="n">igot117</span><span class="p">,</span> <span class="n">igot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0116</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot116</span><span class="p">);</span>
	<span class="n">get116</span> <span class="o">=</span> <span class="n">igot116</span><span class="p">;</span>
	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0117</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot117</span><span class="p">);</span>
	<span class="n">get117</span> <span class="o">=</span> <span class="n">igot117</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0116</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0117</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>
	<span class="n">get0</span> <span class="o">=</span> <span class="n">igot</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">get0</span><span class="p">));</span>

	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0116</span><span class="p">,</span> <span class="n">get116</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0117</span><span class="p">,</span> <span class="n">get117</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">stop_100</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">get0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">igot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">GET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">igot</span><span class="p">);</span>
	<span class="n">get0</span> <span class="o">=</span> <span class="n">igot</span><span class="p">;</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x7F</span> <span class="o">&amp;</span> <span class="n">get0</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/*****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">easycap_wakeup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">pusb_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">USB_REQ_SET_FEATURE</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_STANDARD</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			<span class="n">USB_DEVICE_REMOTE_WAKEUP</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50000</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">easycap_audio_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">easycap</span> <span class="o">*</span><span class="n">peasycap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">pusb_device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *                                IMPORTANT:</span>
<span class="cm"> *  THE MESSAGE OF TYPE (USB_DIR_OUT | USB_TYPE_CLASS | USB_RECIP_INTERFACE)</span>
<span class="cm"> *  CAUSES MUTING IF THE VALUE 0x0100 IS SENT.</span>
<span class="cm"> *  TO ENABLE AUDIO  THE VALUE 0x0200 MUST BE SENT.</span>
<span class="cm"> */</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">request</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">requesttype</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span>
			       <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span>
			       <span class="n">USB_RECIP_INTERFACE</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">value_unmute</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="mh">0x0301</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peasycap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">pusb_device</span> <span class="o">=</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">pusb_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">JOM</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;%02X %02X %02X %02X %02X %02X %02X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">requesttype</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
				<span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">value_unmute</span><span class="p">),</span>
				<span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">value_unmute</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				<span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">index</span><span class="p">),</span>
				<span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">index</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
				<span class="p">(</span><span class="mh">0x00FF</span> <span class="o">&amp;</span> <span class="n">length</span><span class="p">),</span>
				<span class="p">(</span><span class="mh">0xFF00</span> <span class="o">&amp;</span> <span class="n">length</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">request</span><span class="p">,</span> <span class="n">requesttype</span><span class="p">,</span> <span class="n">value_unmute</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">length</span><span class="p">,</span> <span class="mi">50000</span><span class="p">);</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;0x%02X=buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;usb_control_msg returned -EPIPE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: usb_control_msg returned %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  REGISTER 500:  SETTING VALUE TO 0x0094 RESETS AUDIO CONFIGURATION ???</span>
<span class="cm"> *  REGISTER 506:  ANALOGUE AUDIO ATTENTUATOR ???</span>
<span class="cm"> *                 FOR THE CVBS+S-VIDEO HARDWARE:</span>
<span class="cm"> *                    SETTING VALUE TO 0x0000 GIVES QUIET SOUND.</span>
<span class="cm"> *                    THE UPPER BYTE SEEMS TO HAVE NO EFFECT.</span>
<span class="cm"> *                 FOR THE FOUR-CVBS HARDWARE:</span>
<span class="cm"> *                    SETTING VALUE TO 0x0000 SEEMS TO HAVE NO EFFECT.</span>
<span class="cm"> *  REGISTER 507:  ANALOGUE AUDIO PREAMPLIFIER ON/OFF ???</span>
<span class="cm"> *                 FOR THE CVBS-S-VIDEO HARDWARE:</span>
<span class="cm"> *                    SETTING VALUE TO 0x0001 GIVES VERY LOUD, DISTORTED SOUND.</span>
<span class="cm"> *                    THE UPPER BYTE SEEMS TO HAVE NO EFFECT.</span>
<span class="cm"> */</span>
<span class="cm">/*--------------------------------------------------------------------------*/</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x0094</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x008C</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0506</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">SET</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0507</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">id1</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x007C</span><span class="p">);</span>
	<span class="n">id2</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x007E</span><span class="p">);</span>
	<span class="n">SAM</span><span class="p">(</span><span class="s">&quot;0x%04X:0x%04X is audio vendor id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> *  SELECT AUDIO SOURCE &quot;LINE IN&quot; AND SET THE AUDIO GAIN.</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">easycap_audio_gainset</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">peasycap</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">))</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: audio_gainset() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">check_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">check_vt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">pusb_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">igot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x02</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x000E</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x0E</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">);</span>

	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x12</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>

	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x14</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>

	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x16</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>

	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x18</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>

	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x001C</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x1C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">igot</span><span class="p">)</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;register 0x%02X muted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="cm">/*  NOTE:  THIS DOES INCREASE THE VOLUME DRAMATICALLY:</span>
<span class="cm"> *                      audio_gainset(pusb_device, 0x000F);</span>
<span class="cm"> *</span>
<span class="cm"> *       loud        dB  register 0x10      dB register 0x1C    dB total</span>
<span class="cm"> *         0               -34.5                   0             -34.5</span>
<span class="cm"> *        ..                ....                   .              ....</span>
<span class="cm"> *        15                10.5                   0              10.5</span>
<span class="cm"> *        16                12.0                   0              12.0</span>
<span class="cm"> *        17                12.0                   1.5            13.5</span>
<span class="cm"> *        ..                ....                  ....            ....</span>
<span class="cm"> *        31                12.0                  22.5            34.5</span>
<span class="cm">*/</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
<span class="kt">int</span> <span class="nf">easycap_audio_gainset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">pusb_device</span><span class="p">,</span> <span class="n">s8</span> <span class="n">loud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">igot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mute</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pusb_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">loud</span><span class="p">)</span>
		<span class="n">loud</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">31</span> <span class="o">&lt;</span> <span class="n">loud</span><span class="p">)</span>
		<span class="n">loud</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>

	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x000E</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x0E</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">igot</span><span class="p">);</span>
	<span class="n">mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&gt;</span> <span class="n">loud</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x001F</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">u8</span><span class="p">)(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">loud</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;0x%04X=(mute|tmp) for VT1612A register 0x0E</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x000E</span><span class="p">,</span> <span class="p">(</span><span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">));</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">igot</span><span class="p">);</span>
	<span class="n">mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;0x%04X=(mute|tmp|(tmp&lt;&lt;8)) for VT1612A register 0x10,...0x18</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="p">(</span><span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="p">(</span><span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="p">(</span><span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="p">(</span><span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="p">(</span><span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>
	<span class="n">igot</span> <span class="o">=</span> <span class="n">read_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x001C</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">igot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SAY</span><span class="p">(</span><span class="s">&quot;ERROR: failed to read VT1612A register 0x1C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">igot</span><span class="p">);</span>
	<span class="n">mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;=</span> <span class="n">loud</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x000F</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">loud</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">JOT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;0x%04X=(mute|tmp|(tmp&lt;&lt;8)) for VT1612A register 0x1C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x001C</span><span class="p">,</span> <span class="p">(</span><span class="n">mute</span> <span class="o">|</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x001A</span><span class="p">,</span> <span class="mh">0x0404</span><span class="p">);</span>
	<span class="n">write_vt</span><span class="p">(</span><span class="n">pusb_device</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*****************************************************************************/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
